!function(t){function e(e){for(var i,r,n=e[0],o=e[1],a=0,l=[];a<n.length;a++)r=n[a],Object.prototype.hasOwnProperty.call(s,r)&&s[r]&&l.push(s[r][0]),s[r]=0;for(i in o)Object.prototype.hasOwnProperty.call(o,i)&&(t[i]=o[i]);for(h&&h(e);l.length;)l.shift()()}var i={},s={0:0};function r(e){if(i[e])return i[e].exports;var s=i[e]={i:e,l:!1,exports:{}};return t[e].call(s.exports,s,s.exports,r),s.l=!0,s.exports}r.e=function(t){var e=[],i=s[t];if(0!==i)if(i)e.push(i[2]);else{var n=new Promise((function(e,r){i=s[t]=[e,r]}));e.push(i[2]=n);var o,a=document.createElement("script");a.charset="utf-8",a.timeout=120,r.nc&&a.setAttribute("nonce",r.nc),a.src=function(t){return r.p+""+t+".index.js"}(t);var h=new Error;o=function(e){a.onerror=a.onload=null,clearTimeout(l);var i=s[t];if(0!==i){if(i){var r=e&&("load"===e.type?"missing":e.type),n=e&&e.target&&e.target.src;h.message="Loading chunk "+t+" failed.\n("+r+": "+n+")",h.name="ChunkLoadError",h.type=r,h.request=n,i[1](h)}s[t]=void 0}};var l=setTimeout((function(){o({type:"timeout",target:a})}),12e4);a.onerror=a.onload=o,document.head.appendChild(a)}return Promise.all(e)},r.m=t,r.c=i,r.d=function(t,e,i){r.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:i})},r.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},r.t=function(t,e){if(1&e&&(t=r(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var i=Object.create(null);if(r.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var s in t)r.d(i,s,function(e){return t[e]}.bind(null,s));return i},r.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return r.d(e,"a",e),e},r.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},r.p="",r.oe=function(t){throw console.error(t),t};var n=window.webpackJsonp=window.webpackJsonp||[],o=n.push.bind(n);n.push=e,n=n.slice();for(var a=0;a<n.length;a++)e(n[a]);var h=o;r(r.s=14)}([function(t){t.exports=JSON.parse('{"APPEARANCE":235,"BANK_CLOSE":212,"BANK_DEPOSIT":23,"BANK_WITHDRAW":22,"CAST_GROUND":158,"CAST_GROUNDITEM":249,"CAST_INVITEM":4,"CAST_NPC":50,"CAST_OBJECT":99,"CAST_PLAYER":229,"CAST_SELF":137,"CAST_WALLOBJECT":180,"CHAT":216,"CHOOSE_OPTION":116,"CLOSE_CONNECTION":31,"COMBAT_STYLE":29,"COMMAND":38,"DUEL_ACCEPT":176,"DUEL_CONFIRM_ACCEPT":77,"DUEL_DECLINE":197,"DUEL_ITEM_UPDATE":33,"DUEL_SETTINGS":8,"FRIEND_ADD":195,"FRIEND_REMOVE":167,"GROUNDITEM_TAKE":247,"IGNORE_ADD":132,"IGNORE_REMOVE":241,"INV_CMD":90,"INV_DROP":246,"INV_UNEQUIP":170,"INV_WEAR":169,"KNOWN_PLAYERS":163,"LOGIN":0,"LOGOUT":102,"NPC_ATTACK":190,"NPC_CMD":202,"NPC_TALK":153,"OBJECT_CMD1":136,"OBJECT_CMD2":79,"PACKET_EXCEPTION":3,"PING":67,"PLAYER_ATTACK":171,"PLAYER_DUEL":103,"PLAYER_FOLLOW":165,"PLAYER_TRADE":142,"PM":218,"PRAYER_OFF":254,"PRAYER_ON":60,"REPORT_ABUSE":206,"SESSION":32,"SETTINGS_GAME":111,"SETTINGS_PRIVACY":64,"SHOP_BUY":236,"SHOP_CLOSE":166,"SHOP_SELL":221,"SLEEP_WORD":45,"TRADE_ACCEPT":55,"TRADE_CONFIRM_ACCEPT":104,"TRADE_DECLINE":230,"TRADE_ITEM_UPDATE":46,"USEWITH_GROUNDITEM":53,"USEWITH_INVITEM":91,"USEWITH_NPC":135,"USEWITH_OBJECT":115,"USEWITH_PLAYER":113,"USEWITH_WALLOBJECT":161,"WALK":187,"WALK_ACTION":16,"WALL_OBJECT_COMMAND1":14,"WALL_OBJECT_COMMAND2":127,"CHANGE_PASSWORD":25,"RECOVER_CANCEL":196,"RECOVER_GET_QUESTIONS":233,"RECOVER_REQUEST":220,"RECOVER_SET":208,"RECOVER_SET_REQUEST":203,"REGISTER":2,"RECOVER_OPEN":224}')},function(t){t.exports=JSON.parse('{"APPEARANCE":59,"BANK_CLOSE":203,"BANK_OPEN":42,"BANK_UPDATE":249,"CLOSE_CONNECTION":4,"DUEL_ACCEPTED":210,"DUEL_CLOSE":225,"DUEL_CONFIRM_OPEN":172,"DUEL_OPEN":176,"DUEL_OPPONENT_ACCEPTED":253,"DUEL_SETTINGS":30,"DUEL_UPDATE":6,"FRIEND_LIST":71,"FRIEND_MESSAGE":120,"FRIEND_STATUS_CHANGE":149,"GAME_SETTINGS":240,"IGNORE_LIST":109,"INVENTORY_ITEMS":53,"INVENTORY_ITEM_REMOVE":123,"INVENTORY_ITEM_UPDATE":90,"LOGOUT_DENY":183,"MESSAGE":131,"OPTION_LIST":245,"OPTION_LIST_CLOSE":252,"PLAYER_DIED":83,"PLAYER_QUEST_LIST":5,"PLAYER_STAT_EQUIPMENT_BONUS":153,"PLAYER_STAT_EXPERIENCE_UPDATE":33,"PLAYER_STAT_FATIGUE":114,"PLAYER_STAT_FATIGUE_ASLEEP":244,"PLAYER_STAT_LIST":156,"PLAYER_STAT_UPDATE":159,"PRAYER_STATUS":206,"PRIVACY_SETTINGS":51,"REGION_ENTITY_UPDATE":211,"REGION_GROUND_ITEMS":99,"REGION_NPCS":79,"REGION_NPC_UPDATE":104,"REGION_OBJECTS":48,"REGION_PLAYERS":191,"REGION_PLAYER_UPDATE":234,"REGION_WALL_OBJECTS":91,"SERVER_MESSAGE":89,"SERVER_MESSAGE_ONTOP":222,"SHOP_CLOSE":137,"SHOP_OPEN":101,"SLEEP_CLOSE":84,"SLEEP_INCORRECT":194,"SLEEP_OPEN":117,"SOUND":204,"SYSTEM_UPDATE":52,"TELEPORT_BUBBLE":36,"TRADE_CLOSE":128,"TRADE_CONFIRM_OPEN":20,"TRADE_ITEMS":97,"TRADE_OPEN":92,"TRADE_RECIPIENT_STATUS":162,"TRADE_STATUS":15,"WELCOME":182,"WORLD_INFO":25,"COMBAT_POINTS":242}')},function(t){t.exports=JSON.parse('{"CLIENT":204,"CONFIG":85,"ENTITY":24,"FILTER":2,"FONTS":1,"MAPS":63,"MEDIA":58,"MODELS":36,"SOUNDS":1,"TEXTURES":17}')},function(t,e,i){var s=i(12),r=i(13),n="undefined"!=typeof Float64Array;function o(t,e){return t[0]-e[0]}function a(){var t,e=this.stride,i=new Array(e.length);for(t=0;t<i.length;++t)i[t]=[Math.abs(e[t]),t];i.sort(o);var s=new Array(i.length);for(t=0;t<s.length;++t)s[t]=i[t][1];return s}function h(t,e){var i=["View",e,"d",t].join("");e<0&&(i="View_Nil"+t);var r="generic"===t;if(-1===e){var n="function "+i+"(a){this.data=a;};var proto="+i+".prototype;proto.dtype='"+t+"';proto.index=function(){return -1};proto.size=0;proto.dimension=-1;proto.shape=proto.stride=proto.order=[];proto.lo=proto.hi=proto.transpose=proto.step=function(){return new "+i+"(this.data);};proto.get=proto.set=function(){};proto.pick=function(){return null};return function construct_"+i+"(a){return new "+i+"(a);}";return new Function(n)()}if(0===e){n="function "+i+"(a,d) {this.data = a;this.offset = d};var proto="+i+".prototype;proto.dtype='"+t+"';proto.index=function(){return this.offset};proto.dimension=0;proto.size=1;proto.shape=proto.stride=proto.order=[];proto.lo=proto.hi=proto.transpose=proto.step=function "+i+"_copy() {return new "+i+"(this.data,this.offset)};proto.pick=function "+i+"_pick(){return TrivialArray(this.data);};proto.valueOf=proto.get=function "+i+"_get(){return "+(r?"this.data.get(this.offset)":"this.data[this.offset]")+"};proto.set=function "+i+"_set(v){return "+(r?"this.data.set(this.offset,v)":"this.data[this.offset]=v")+"};return function construct_"+i+"(a,b,c,d){return new "+i+"(a,d)}";return new Function("TrivialArray",n)(l[t][0])}n=["'use strict'"];var o=s(e),h=o.map((function(t){return"i"+t})),u="this.offset+"+o.map((function(t){return"this.stride["+t+"]*i"+t})).join("+"),c=o.map((function(t){return"b"+t})).join(","),d=o.map((function(t){return"c"+t})).join(",");n.push("function "+i+"(a,"+c+","+d+",d){this.data=a","this.shape=["+c+"]","this.stride=["+d+"]","this.offset=d|0}","var proto="+i+".prototype","proto.dtype='"+t+"'","proto.dimension="+e),n.push("Object.defineProperty(proto,'size',{get:function "+i+"_size(){return "+o.map((function(t){return"this.shape["+t+"]"})).join("*"),"}})"),1===e?n.push("proto.order=[0]"):(n.push("Object.defineProperty(proto,'order',{get:"),e<4?(n.push("function "+i+"_order(){"),2===e?n.push("return (Math.abs(this.stride[0])>Math.abs(this.stride[1]))?[1,0]:[0,1]}})"):3===e&&n.push("var s0=Math.abs(this.stride[0]),s1=Math.abs(this.stride[1]),s2=Math.abs(this.stride[2]);if(s0>s1){if(s1>s2){return [2,1,0];}else if(s0>s2){return [1,2,0];}else{return [1,0,2];}}else if(s0>s2){return [2,0,1];}else if(s2>s1){return [0,1,2];}else{return [0,2,1];}}})")):n.push("ORDER})")),n.push("proto.set=function "+i+"_set("+h.join(",")+",v){"),r?n.push("return this.data.set("+u+",v)}"):n.push("return this.data["+u+"]=v}"),n.push("proto.get=function "+i+"_get("+h.join(",")+"){"),r?n.push("return this.data.get("+u+")}"):n.push("return this.data["+u+"]}"),n.push("proto.index=function "+i+"_index(",h.join(),"){return "+u+"}"),n.push("proto.hi=function "+i+"_hi("+h.join(",")+"){return new "+i+"(this.data,"+o.map((function(t){return["(typeof i",t,"!=='number'||i",t,"<0)?this.shape[",t,"]:i",t,"|0"].join("")})).join(",")+","+o.map((function(t){return"this.stride["+t+"]"})).join(",")+",this.offset)}");var m=o.map((function(t){return"a"+t+"=this.shape["+t+"]"})),p=o.map((function(t){return"c"+t+"=this.stride["+t+"]"}));n.push("proto.lo=function "+i+"_lo("+h.join(",")+"){var b=this.offset,d=0,"+m.join(",")+","+p.join(","));for(var f=0;f<e;++f)n.push("if(typeof i"+f+"==='number'&&i"+f+">=0){d=i"+f+"|0;b+=c"+f+"*d;a"+f+"-=d}");n.push("return new "+i+"(this.data,"+o.map((function(t){return"a"+t})).join(",")+","+o.map((function(t){return"c"+t})).join(",")+",b)}"),n.push("proto.step=function "+i+"_step("+h.join(",")+"){var "+o.map((function(t){return"a"+t+"=this.shape["+t+"]"})).join(",")+","+o.map((function(t){return"b"+t+"=this.stride["+t+"]"})).join(",")+",c=this.offset,d=0,ceil=Math.ceil");for(f=0;f<e;++f)n.push("if(typeof i"+f+"==='number'){d=i"+f+"|0;if(d<0){c+=b"+f+"*(a"+f+"-1);a"+f+"=ceil(-a"+f+"/d)}else{a"+f+"=ceil(a"+f+"/d)}b"+f+"*=d}");n.push("return new "+i+"(this.data,"+o.map((function(t){return"a"+t})).join(",")+","+o.map((function(t){return"b"+t})).join(",")+",c)}");var g=new Array(e),S=new Array(e);for(f=0;f<e;++f)g[f]="a[i"+f+"]",S[f]="b[i"+f+"]";n.push("proto.transpose=function "+i+"_transpose("+h+"){"+h.map((function(t,e){return t+"=("+t+"===undefined?"+e+":"+t+"|0)"})).join(";"),"var a=this.shape,b=this.stride;return new "+i+"(this.data,"+g.join(",")+","+S.join(",")+",this.offset)}"),n.push("proto.pick=function "+i+"_pick("+h+"){var a=[],b=[],c=this.offset");for(f=0;f<e;++f)n.push("if(typeof i"+f+"==='number'&&i"+f+">=0){c=(c+this.stride["+f+"]*i"+f+")|0}else{a.push(this.shape["+f+"]);b.push(this.stride["+f+"])}");return n.push("var ctor=CTOR_LIST[a.length+1];return ctor(this.data,a,b,c)}"),n.push("return function construct_"+i+"(data,shape,stride,offset){return new "+i+"(data,"+o.map((function(t){return"shape["+t+"]"})).join(",")+","+o.map((function(t){return"stride["+t+"]"})).join(",")+",offset)}"),new Function("CTOR_LIST","ORDER",n.join("\n"))(l[t],a)}var l={float32:[],float64:[],int8:[],int16:[],int32:[],uint8:[],uint16:[],uint32:[],array:[],uint8_clamped:[],bigint64:[],biguint64:[],buffer:[],generic:[]};t.exports=function(t,e,i,s){if(void 0===t)return(0,l.array[0])([]);"number"==typeof t&&(t=[t]),void 0===e&&(e=[t.length]);var o=e.length;if(void 0===i){i=new Array(o);for(var a=o-1,u=1;a>=0;--a)i[a]=u,u*=e[a]}if(void 0===s){s=0;for(a=0;a<o;++a)i[a]<0&&(s-=(e[a]-1)*i[a])}for(var c=function(t){if(r(t))return"buffer";if(n)switch(Object.prototype.toString.call(t)){case"[object Float64Array]":return"float64";case"[object Float32Array]":return"float32";case"[object Int8Array]":return"int8";case"[object Int16Array]":return"int16";case"[object Int32Array]":return"int32";case"[object Uint8Array]":return"uint8";case"[object Uint16Array]":return"uint16";case"[object Uint32Array]":return"uint32";case"[object Uint8ClampedArray]":return"uint8_clamped";case"[object BigInt64Array]":return"bigint64";case"[object BigUint64Array]":return"biguint64"}return Array.isArray(t)?"array":"generic"}(t),d=l[c];d.length<=o+1;)d.push(h(c,d.length-1));return(0,d[o+1])(t,e,i,s)}},function(t,e){function i(t,e){const i=[];for(let s=0;s<t;s+=1)i.push(new Int32Array(e));return i}class s{constructor(){this.tt=null,this.input=null,this.nextIn=0,this.availIn=0,this.totalInLo32=0,this.totalInHi32=0,this.output=null,this.availOut=0,this.decompressedSize=0,this.totalOutLo32=0,this.totalOutHi32=0,this.stateOutCh=0,this.stateOutLen=0,this.blockRandomised=!1,this.bsBuff=0,this.bsLive=0,this.blocksize100k=0,this.blockNo=0,this.origPtr=0,this.tpos=0,this.k0=0,this.nblockUsed=0,this.nInUse=0,this.saveNblock=0,this.unzftab=new Int32Array(256),this.cftab=new Int32Array(257),this.inUse=new Int8Array(256),this.inUse_16=new Int8Array(16),this.setToUnseq=new Int8Array(256),this.mtfa=new Int8Array(4096),this.mtfbase=new Int32Array(16),this.selector=new Int8Array(18002),this.selectorMtf=new Int8Array(18002),this.len=function(t,e){const i=[];for(let s=0;s<t;s+=1)i.push(new Int8Array(e));return i}(6,258),this.limit=i(6,258),this.base=i(6,258),this.perm=i(6,258),this.minLens=new Int32Array(6)}}class r{static decompress(t,e,i,n,o){let a=new s;return a.input=i,a.nextIn=o,a.output=t,a.availOut=0,a.availIn=n,a.decompressedSize=e,a.bsLive=0,a.bsBuff=0,a.totalInLo32=0,a.totalInHi32=0,a.totalOutLo32=0,a.totalOutHi32=0,a.blockNo=0,r.decompressState(a),e-=a.decompressedSize}static nextHeader(t){let e=t.stateOutCh,i=t.stateOutLen,s=t.nblockUsed,r=t.k0,n=t.tt,o=t.tpos,a=t.output,h=t.availOut,l=t.decompressedSize,u=l,c=t.saveNblock+1;t:for(;;){if(i>0){for(;;){if(0===l)break t;if(1===i)break;a[h]=e,i--,h++,l--}if(0===l){i=1;break}a[h]=e,h++,l--}let t=!0;for(;t;){if(t=!1,s===c){i=0;break t}e=255&r,o=n[o];let u=255&o;if(o>>=8,s++,u!==r){if(r=u,0!==l){a[h]=e,h++,l--,t=!0;continue}i=1;break t}if(s===c){if(0===l){i=1;break t}a[h]=e,h++,l--,t=!0}}i=2,o=n[o];let u=255&o;if(o>>=8,++s!==c)if(u!==r)r=u;else{i=3,o=n[o];let t=255&o;if(o>>=8,++s!==c)if(t!==r)r=t;else{o=n[o];let t=255&o;o>>=8,s++,i=4+(255&t),o=n[o],r=255&o,o>>=8,s++}}}let d=t.totalOutLo32;t.totalOutLo32+=u-l,t.totalOutLo32<d&&t.totalOutHi32++,t.stateOutCh=e,t.stateOutLen=i,t.nblockUsed=s,t.k0=r,t.tt=n,t.tpos=o,t.output=a,t.availOut=h,t.decompressedSize=l}static decompressState(t){let e=0,i=null,s=null,n=null;t.blocksize100k=1,null===t.tt&&(t.tt=new Int32Array(1e5*t.blocksize100k));let o=!0;for(;o;){let a=r.getUChar(t);if(23===a)return;a=r.getUChar(t),a=r.getUChar(t),a=r.getUChar(t),a=r.getUChar(t),a=r.getUChar(t),t.blockNo++,a=r.getUChar(t),a=r.getUChar(t),a=r.getUChar(t),a=r.getUChar(t),a=r.getBit(t),t.blockRandomised=0!==a,t.blockRandomised&&console.log("PANIC! RANDOMISED BLOCK!"),t.origPtr=0,a=r.getUChar(t),t.origPtr=t.origPtr<<8|255&a,a=r.getUChar(t),t.origPtr=t.origPtr<<8|255&a,a=r.getUChar(t),t.origPtr=t.origPtr<<8|255&a;for(let e=0;e<16;e++)a=r.getBit(t),t.inUse_16[e]=1===a;for(let e=0;e<256;e++)t.inUse[e]=!1;for(let e=0;e<16;e++)if(t.inUse_16[e])for(let i=0;i<16;i++)a=r.getBit(t),1===a&&(t.inUse[16*e+i]=!0);r.makeMaps(t);let h=t.nInUse+2,l=r.getBits(3,t),u=r.getBits(15,t);for(let e=0;e<u;e++){let i=0;for(;;){if(a=r.getBit(t),0===a)break;i++}t.selectorMtf[e]=255&i}let c=new Int8Array(6);for(let t=0;t<l;t++)c[t]=t;for(let e=0;e<u;e++){let i=t.selectorMtf[e],s=c[i];for(;i>0;i--)c[i]=c[i-1];c[0]=s,t.selector[e]=s}for(let e=0;e<l;e++){let i=r.getBits(5,t);for(let s=0;s<h;s++){for(;;){if(a=r.getBit(t),0===a)break;a=r.getBit(t),0===a?i++:i--}t.len[e][s]=255&i}}for(let e=0;e<l;e++){let i=32,s=0;for(let r=0;r<h;r++)t.len[e][r]>s&&(s=t.len[e][r]),t.len[e][r]<i&&(i=t.len[e][r]);r.createDecodeTables(t.limit[e],t.base[e],t.perm[e],t.len[e],i,s,h),t.minLens[e]=i}let d=t.nInUse+1,m=(t.blocksize100k,-1),p=0;for(let e=0;e<=255;e++)t.unzftab[e]=0;let f=4095;for(let e=15;e>=0;e--){for(let i=15;i>=0;i--)t.mtfa[f]=16*e+i&255,f--;t.mtfbase[e]=f+1}let g=0;if(0===p){m++,p=50;let r=t.selector[m];e=t.minLens[r],i=t.limit[r],n=t.perm[r],s=t.base[r]}p--;let S=e,w=0,y=0;for(w=r.getBits(S,t);w>i[S];w=w<<1|y)S++,y=r.getBit(t);for(let o=n[w-s[S]];o!==d;)if(0===o||1===o){let h=-1,l=1;do{if(0===o?h+=l:1===o&&(h+=2*l),l*=2,0===p){m++,p=50;let r=t.selector[m];e=t.minLens[r],i=t.limit[r],n=t.perm[r],s=t.base[r]}p--;let a=e,u=0,c=0;for(u=r.getBits(a,t);u>i[a];u=u<<1|c)a++,c=r.getBit(t);o=n[u-s[a]]}while(0===o||1===o);for(h++,a=t.setToUnseq[255&t.mtfa[t.mtfbase[0]]],t.unzftab[255&a]+=h;h>0;h--)t.tt[g]=255&a,g++}else{let h=o-1;if(h<16){let e=t.mtfbase[0];for(a=t.mtfa[e+h];h>3;h-=4){let i=e+h;t.mtfa[i]=t.mtfa[i-1],t.mtfa[i-1]=t.mtfa[i-2],t.mtfa[i-2]=t.mtfa[i-3],t.mtfa[i-3]=t.mtfa[i-4]}for(;h>0;h--)t.mtfa[e+h]=t.mtfa[e+h-1];t.mtfa[e]=a}else{let e=h/16|0,i=h%16,s=t.mtfbase[e]+i;for(a=t.mtfa[s];s>t.mtfbase[e];s--)t.mtfa[s]=t.mtfa[s-1];for(t.mtfbase[e]++;e>0;e--)t.mtfbase[e]--,t.mtfa[t.mtfbase[e]]=t.mtfa[t.mtfbase[e-1]+16-1];if(t.mtfbase[0]--,t.mtfa[t.mtfbase[0]]=a,0===t.mtfbase[0]){f=4095;for(let e=15;e>=0;e--){for(let i=15;i>=0;i--)t.mtfa[f]=t.mtfa[t.mtfbase[e]+i],f--;t.mtfbase[e]=f+1}}}if(t.unzftab[255&t.setToUnseq[255&a]]++,t.tt[g]=255&t.setToUnseq[255&a],g++,0===p){m++,p=50;let r=t.selector[m];e=t.minLens[r],i=t.limit[r],n=t.perm[r],s=t.base[r]}p--;let l=e,u=0,c=0;for(u=r.getBits(l,t);u>i[l];u=u<<1|c)l++,c=r.getBit(t);o=n[u-s[l]]}t.stateOutLen=0,t.stateOutCh=0,t.cftab[0]=0;for(let e=1;e<=256;e++)t.cftab[e]=t.unzftab[e-1];for(let e=1;e<=256;e++)t.cftab[e]+=t.cftab[e-1];for(let e=0;e<g;e++)a=255&t.tt[e],t.tt[t.cftab[255&a]]|=e<<8,t.cftab[255&a]++;t.tpos=t.tt[t.origPtr]>>8,t.nblockUsed=0,t.tpos=t.tt[t.tpos],t.k0=255&t.tpos,t.tpos>>=8,t.nblockUsed++,t.saveNblock=g,r.nextHeader(t),o=t.nblockUsed===t.saveNblock+1&&0===t.stateOutLen}}static getUChar(t){return 255&r.getBits(8,t)}static getBit(t){return 255&r.getBits(1,t)}static getBits(t,e){let i=0;for(;;){if(e.bsLive>=t){let s=e.bsBuff>>e.bsLive-t&(1<<t)-1;e.bsLive-=t,i=s;break}e.bsBuff=e.bsBuff<<8|255&e.input[e.nextIn],e.bsLive+=8,e.nextIn++,e.availIn--,e.totalInLo32++,0===e.totalInLo32&&e.totalInHi32++}return i}static makeMaps(t){t.nInUse=0;for(let e=0;e<256;e++)t.inUse[e]&&(t.setToUnseq[t.nInUse]=255&e,t.nInUse++)}static createDecodeTables(t,e,i,s,r,n,o){let a=0;for(let t=r;t<=n;t++)for(let e=0;e<o;e++)s[e]===t&&(i[a]=e,a++);for(let t=0;t<23;t++)e[t]=0;for(let t=0;t<o;t++)e[s[t]+1]++;for(let t=1;t<23;t++)e[t]+=e[t-1];for(let e=0;e<23;e++)t[e]=0;let h=0;for(let i=r;i<=n;i++)h+=e[i+1]-e[i],t[i]=h-1,h<<=1;for(let i=r+1;i<=n;i++)e[i]=(t[i-1]+1<<1)-e[i]}}t.exports=r},function(t,e,i){(function(t){var s,r=function(t){"use strict";var e=1e7,i=9007199254740992,s=c(i),n="function"==typeof BigInt;function o(t,e,i,s){return void 0===t?o[0]:void 0!==e&&(10!=+e||i)?N(t,e,i,s):V(t)}function a(t,e){this.value=t,this.sign=e,this.isSmall=!1}function h(t){this.value=t,this.sign=t<0,this.isSmall=!0}function l(t){this.value=t}function u(t){return-i<t&&t<i}function c(t){return t<1e7?[t]:t<1e14?[t%1e7,Math.floor(t/1e7)]:[t%1e7,Math.floor(t/1e7)%1e7,Math.floor(t/1e14)]}function d(t){m(t);var i=t.length;if(i<4&&M(t,s)<0)switch(i){case 0:return 0;case 1:return t[0];case 2:return t[0]+t[1]*e;default:return t[0]+(t[1]+t[2]*e)*e}return t}function m(t){for(var e=t.length;0===t[--e];);t.length=e+1}function p(t){for(var e=new Array(t),i=-1;++i<t;)e[i]=0;return e}function f(t){return t>0?Math.floor(t):Math.ceil(t)}function g(t,i){var s,r,n=t.length,o=i.length,a=new Array(n),h=0,l=e;for(r=0;r<o;r++)h=(s=t[r]+i[r]+h)>=l?1:0,a[r]=s-h*l;for(;r<n;)h=(s=t[r]+h)===l?1:0,a[r++]=s-h*l;return h>0&&a.push(h),a}function S(t,e){return t.length>=e.length?g(t,e):g(e,t)}function w(t,i){var s,r,n=t.length,o=new Array(n),a=e;for(r=0;r<n;r++)s=t[r]-a+i,i=Math.floor(s/a),o[r]=s-i*a,i+=1;for(;i>0;)o[r++]=i%a,i=Math.floor(i/a);return o}function y(t,e){var i,s,r=t.length,n=e.length,o=new Array(r),a=0;for(i=0;i<n;i++)(s=t[i]-a-e[i])<0?(s+=1e7,a=1):a=0,o[i]=s;for(i=n;i<r;i++){if(!((s=t[i]-a)<0)){o[i++]=s;break}s+=1e7,o[i]=s}for(;i<r;i++)o[i]=t[i];return m(o),o}function I(t,e,i){var s,r,n=t.length,o=new Array(n),l=-e;for(s=0;s<n;s++)r=t[s]+l,l=Math.floor(r/1e7),r%=1e7,o[s]=r<0?r+1e7:r;return"number"==typeof(o=d(o))?(i&&(o=-o),new h(o)):new a(o,i)}function C(t,e){var i,s,r,n,o=t.length,a=e.length,h=p(o+a);for(r=0;r<o;++r){n=t[r];for(var l=0;l<a;++l)i=n*e[l]+h[r+l],s=Math.floor(i/1e7),h[r+l]=i-1e7*s,h[r+l+1]+=s}return m(h),h}function b(t,i){var s,r,n=t.length,o=new Array(n),a=e,h=0;for(r=0;r<n;r++)s=t[r]*i+h,h=Math.floor(s/a),o[r]=s-h*a;for(;h>0;)o[r++]=h%a,h=Math.floor(h/a);return o}function T(t,e){for(var i=[];e-- >0;)i.push(0);return i.concat(t)}function x(t,i,s){return new a(t<e?b(i,t):C(i,c(t)),s)}function v(t){var e,i,s,r,n=t.length,o=p(n+n);for(s=0;s<n;s++){i=0-(r=t[s])*r;for(var a=s;a<n;a++)e=r*t[a]*2+o[s+a]+i,i=Math.floor(e/1e7),o[s+a]=e-1e7*i;o[s+n]=i}return m(o),o}function A(t,e){var i,s,r,n,o=t.length,a=p(o);for(r=0,i=o-1;i>=0;--i)r=(n=1e7*r+t[i])-(s=f(n/e))*e,a[i]=0|s;return[a,0|r]}function L(t,i){var s,r=V(i);if(n)return[new l(t.value/r.value),new l(t.value%r.value)];var u,g=t.value,S=r.value;if(0===S)throw new Error("Cannot divide by zero");if(t.isSmall)return r.isSmall?[new h(f(g/S)),new h(g%S)]:[o[0],t];if(r.isSmall){if(1===S)return[t,o[0]];if(-1==S)return[t.negate(),o[0]];var w=Math.abs(S);if(w<e){u=d((s=A(g,w))[0]);var I=s[1];return t.sign&&(I=-I),"number"==typeof u?(t.sign!==r.sign&&(u=-u),[new h(u),new h(I)]):[new a(u,t.sign!==r.sign),new h(I)]}S=c(w)}var C=M(g,S);if(-1===C)return[o[0],t];if(0===C)return[o[t.sign===r.sign?1:-1],o[0]];u=(s=g.length+S.length<=200?function(t,i){var s,r,n,o,a,h,l,u=t.length,c=i.length,m=e,f=p(i.length),g=i[c-1],S=Math.ceil(m/(2*g)),w=b(t,S),y=b(i,S);for(w.length<=u&&w.push(0),y.push(0),g=y[c-1],r=u-c;r>=0;r--){for(s=m-1,w[r+c]!==g&&(s=Math.floor((w[r+c]*m+w[r+c-1])/g)),n=0,o=0,h=y.length,a=0;a<h;a++)n+=s*y[a],l=Math.floor(n/m),o+=w[r+a]-(n-l*m),n=l,o<0?(w[r+a]=o+m,o=-1):(w[r+a]=o,o=0);for(;0!==o;){for(s-=1,n=0,a=0;a<h;a++)(n+=w[r+a]-m+y[a])<0?(w[r+a]=n+m,n=0):(w[r+a]=n,n=1);o+=n}f[r]=s}return w=A(w,S)[0],[d(f),d(w)]}(g,S):function(t,e){for(var i,s,r,n,o,a=t.length,h=e.length,l=[],u=[];a;)if(u.unshift(t[--a]),m(u),M(u,e)<0)l.push(0);else{r=1e7*u[(s=u.length)-1]+u[s-2],n=1e7*e[h-1]+e[h-2],s>h&&(r=1e7*(r+1)),i=Math.ceil(r/n);do{if(M(o=b(e,i),u)<=0)break;i--}while(i);l.push(i),u=y(u,o)}return l.reverse(),[d(l),d(u)]}(g,S))[0];var T=t.sign!==r.sign,x=s[1],v=t.sign;return"number"==typeof u?(T&&(u=-u),u=new h(u)):u=new a(u,T),"number"==typeof x?(v&&(x=-x),x=new h(x)):x=new a(x,v),[u,x]}function M(t,e){if(t.length!==e.length)return t.length>e.length?1:-1;for(var i=t.length-1;i>=0;i--)if(t[i]!==e[i])return t[i]>e[i]?1:-1;return 0}function k(t){var e=t.abs();return!e.isUnit()&&(!!(e.equals(2)||e.equals(3)||e.equals(5))||!(e.isEven()||e.isDivisibleBy(3)||e.isDivisibleBy(5))&&(!!e.lesser(49)||void 0))}function E(t,e){for(var i,s,n,o=t.prev(),a=o,h=0;a.isEven();)a=a.divide(2),h++;t:for(s=0;s<e.length;s++)if(!t.lesser(e[s])&&!(n=r(e[s]).modPow(a,t)).isUnit()&&!n.equals(o)){for(i=h-1;0!=i;i--){if((n=n.square().mod(t)).isUnit())return!1;if(n.equals(o))continue t}return!1}return!0}a.prototype=Object.create(o.prototype),h.prototype=Object.create(o.prototype),l.prototype=Object.create(o.prototype),a.prototype.add=function(t){var e=V(t);if(this.sign!==e.sign)return this.subtract(e.negate());var i=this.value,s=e.value;return e.isSmall?new a(w(i,Math.abs(s)),this.sign):new a(S(i,s),this.sign)},a.prototype.plus=a.prototype.add,h.prototype.add=function(t){var e=V(t),i=this.value;if(i<0!==e.sign)return this.subtract(e.negate());var s=e.value;if(e.isSmall){if(u(i+s))return new h(i+s);s=c(Math.abs(s))}return new a(w(s,Math.abs(i)),i<0)},h.prototype.plus=h.prototype.add,l.prototype.add=function(t){return new l(this.value+V(t).value)},l.prototype.plus=l.prototype.add,a.prototype.subtract=function(t){var e=V(t);if(this.sign!==e.sign)return this.add(e.negate());var i=this.value,s=e.value;return e.isSmall?I(i,Math.abs(s),this.sign):function(t,e,i){var s;return M(t,e)>=0?s=y(t,e):(s=y(e,t),i=!i),"number"==typeof(s=d(s))?(i&&(s=-s),new h(s)):new a(s,i)}(i,s,this.sign)},a.prototype.minus=a.prototype.subtract,h.prototype.subtract=function(t){var e=V(t),i=this.value;if(i<0!==e.sign)return this.add(e.negate());var s=e.value;return e.isSmall?new h(i-s):I(s,Math.abs(i),i>=0)},h.prototype.minus=h.prototype.subtract,l.prototype.subtract=function(t){return new l(this.value-V(t).value)},l.prototype.minus=l.prototype.subtract,a.prototype.negate=function(){return new a(this.value,!this.sign)},h.prototype.negate=function(){var t=this.sign,e=new h(-this.value);return e.sign=!t,e},l.prototype.negate=function(){return new l(-this.value)},a.prototype.abs=function(){return new a(this.value,!1)},h.prototype.abs=function(){return new h(Math.abs(this.value))},l.prototype.abs=function(){return new l(this.value>=0?this.value:-this.value)},a.prototype.multiply=function(t){var i,s,r,n=V(t),h=this.value,l=n.value,u=this.sign!==n.sign;if(n.isSmall){if(0===l)return o[0];if(1===l)return this;if(-1===l)return this.negate();if((i=Math.abs(l))<e)return new a(b(h,i),u);l=c(i)}return s=h.length,r=l.length,new a(-.012*s-.012*r+15e-6*s*r>0?function t(e,i){var s=Math.max(e.length,i.length);if(s<=30)return C(e,i);s=Math.ceil(s/2);var r=e.slice(s),n=e.slice(0,s),o=i.slice(s),a=i.slice(0,s),h=t(n,a),l=t(r,o),u=t(S(n,r),S(a,o)),c=S(S(h,T(y(y(u,h),l),s)),T(l,2*s));return m(c),c}(h,l):C(h,l),u)},a.prototype.times=a.prototype.multiply,h.prototype._multiplyBySmall=function(t){return u(t.value*this.value)?new h(t.value*this.value):x(Math.abs(t.value),c(Math.abs(this.value)),this.sign!==t.sign)},a.prototype._multiplyBySmall=function(t){return 0===t.value?o[0]:1===t.value?this:-1===t.value?this.negate():x(Math.abs(t.value),this.value,this.sign!==t.sign)},h.prototype.multiply=function(t){return V(t)._multiplyBySmall(this)},h.prototype.times=h.prototype.multiply,l.prototype.multiply=function(t){return new l(this.value*V(t).value)},l.prototype.times=l.prototype.multiply,a.prototype.square=function(){return new a(v(this.value),!1)},h.prototype.square=function(){var t=this.value*this.value;return u(t)?new h(t):new a(v(c(Math.abs(this.value))),!1)},l.prototype.square=function(t){return new l(this.value*this.value)},a.prototype.divmod=function(t){var e=L(this,t);return{quotient:e[0],remainder:e[1]}},l.prototype.divmod=h.prototype.divmod=a.prototype.divmod,a.prototype.divide=function(t){return L(this,t)[0]},l.prototype.over=l.prototype.divide=function(t){return new l(this.value/V(t).value)},h.prototype.over=h.prototype.divide=a.prototype.over=a.prototype.divide,a.prototype.mod=function(t){return L(this,t)[1]},l.prototype.mod=l.prototype.remainder=function(t){return new l(this.value%V(t).value)},h.prototype.remainder=h.prototype.mod=a.prototype.remainder=a.prototype.mod,a.prototype.pow=function(t){var e,i,s,r=V(t),n=this.value,a=r.value;if(0===a)return o[1];if(0===n)return o[0];if(1===n)return o[1];if(-1===n)return r.isEven()?o[1]:o[-1];if(r.sign)return o[0];if(!r.isSmall)throw new Error("The exponent "+r.toString()+" is too large.");if(this.isSmall&&u(e=Math.pow(n,a)))return new h(f(e));for(i=this,s=o[1];!0&a&&(s=s.times(i),--a),0!==a;)a/=2,i=i.square();return s},h.prototype.pow=a.prototype.pow,l.prototype.pow=function(t){var e=V(t),i=this.value,s=e.value,r=BigInt(0),n=BigInt(1),a=BigInt(2);if(s===r)return o[1];if(i===r)return o[0];if(i===n)return o[1];if(i===BigInt(-1))return e.isEven()?o[1]:o[-1];if(e.isNegative())return new l(r);for(var h=this,u=o[1];(s&n)===n&&(u=u.times(h),--s),s!==r;)s/=a,h=h.square();return u},a.prototype.modPow=function(t,e){if(t=V(t),(e=V(e)).isZero())throw new Error("Cannot take modPow with modulus 0");var i=o[1],s=this.mod(e);for(t.isNegative()&&(t=t.multiply(o[-1]),s=s.modInv(e));t.isPositive();){if(s.isZero())return o[0];t.isOdd()&&(i=i.multiply(s).mod(e)),t=t.divide(2),s=s.square().mod(e)}return i},l.prototype.modPow=h.prototype.modPow=a.prototype.modPow,a.prototype.compareAbs=function(t){var e=V(t),i=this.value,s=e.value;return e.isSmall?1:M(i,s)},h.prototype.compareAbs=function(t){var e=V(t),i=Math.abs(this.value),s=e.value;return e.isSmall?i===(s=Math.abs(s))?0:i>s?1:-1:-1},l.prototype.compareAbs=function(t){var e=this.value,i=V(t).value;return(e=e>=0?e:-e)===(i=i>=0?i:-i)?0:e>i?1:-1},a.prototype.compare=function(t){if(t===1/0)return-1;if(t===-1/0)return 1;var e=V(t),i=this.value,s=e.value;return this.sign!==e.sign?e.sign?1:-1:e.isSmall?this.sign?-1:1:M(i,s)*(this.sign?-1:1)},a.prototype.compareTo=a.prototype.compare,h.prototype.compare=function(t){if(t===1/0)return-1;if(t===-1/0)return 1;var e=V(t),i=this.value,s=e.value;return e.isSmall?i==s?0:i>s?1:-1:i<0!==e.sign?i<0?-1:1:i<0?1:-1},h.prototype.compareTo=h.prototype.compare,l.prototype.compare=function(t){if(t===1/0)return-1;if(t===-1/0)return 1;var e=this.value,i=V(t).value;return e===i?0:e>i?1:-1},l.prototype.compareTo=l.prototype.compare,a.prototype.equals=function(t){return 0===this.compare(t)},l.prototype.eq=l.prototype.equals=h.prototype.eq=h.prototype.equals=a.prototype.eq=a.prototype.equals,a.prototype.notEquals=function(t){return 0!==this.compare(t)},l.prototype.neq=l.prototype.notEquals=h.prototype.neq=h.prototype.notEquals=a.prototype.neq=a.prototype.notEquals,a.prototype.greater=function(t){return this.compare(t)>0},l.prototype.gt=l.prototype.greater=h.prototype.gt=h.prototype.greater=a.prototype.gt=a.prototype.greater,a.prototype.lesser=function(t){return this.compare(t)<0},l.prototype.lt=l.prototype.lesser=h.prototype.lt=h.prototype.lesser=a.prototype.lt=a.prototype.lesser,a.prototype.greaterOrEquals=function(t){return this.compare(t)>=0},l.prototype.geq=l.prototype.greaterOrEquals=h.prototype.geq=h.prototype.greaterOrEquals=a.prototype.geq=a.prototype.greaterOrEquals,a.prototype.lesserOrEquals=function(t){return this.compare(t)<=0},l.prototype.leq=l.prototype.lesserOrEquals=h.prototype.leq=h.prototype.lesserOrEquals=a.prototype.leq=a.prototype.lesserOrEquals,a.prototype.isEven=function(){return 0==(1&this.value[0])},h.prototype.isEven=function(){return 0==(1&this.value)},l.prototype.isEven=function(){return(this.value&BigInt(1))===BigInt(0)},a.prototype.isOdd=function(){return 1==(1&this.value[0])},h.prototype.isOdd=function(){return 1==(1&this.value)},l.prototype.isOdd=function(){return(this.value&BigInt(1))===BigInt(1)},a.prototype.isPositive=function(){return!this.sign},h.prototype.isPositive=function(){return this.value>0},l.prototype.isPositive=h.prototype.isPositive,a.prototype.isNegative=function(){return this.sign},h.prototype.isNegative=function(){return this.value<0},l.prototype.isNegative=h.prototype.isNegative,a.prototype.isUnit=function(){return!1},h.prototype.isUnit=function(){return 1===Math.abs(this.value)},l.prototype.isUnit=function(){return this.abs().value===BigInt(1)},a.prototype.isZero=function(){return!1},h.prototype.isZero=function(){return 0===this.value},l.prototype.isZero=function(){return this.value===BigInt(0)},a.prototype.isDivisibleBy=function(t){var e=V(t);return!e.isZero()&&(!!e.isUnit()||(0===e.compareAbs(2)?this.isEven():this.mod(e).isZero()))},l.prototype.isDivisibleBy=h.prototype.isDivisibleBy=a.prototype.isDivisibleBy,a.prototype.isPrime=function(t){var e=k(this);if(void 0!==e)return e;var i=this.abs(),s=i.bitLength();if(s<=64)return E(i,[2,3,5,7,11,13,17,19,23,29,31,37]);for(var n=Math.log(2)*s.toJSNumber(),o=Math.ceil(!0===t?2*Math.pow(n,2):n),a=[],h=0;h<o;h++)a.push(r(h+2));return E(i,a)},l.prototype.isPrime=h.prototype.isPrime=a.prototype.isPrime,a.prototype.isProbablePrime=function(t,e){var i=k(this);if(void 0!==i)return i;for(var s=this.abs(),n=void 0===t?5:t,o=[],a=0;a<n;a++)o.push(r.randBetween(2,s.minus(2),e));return E(s,o)},l.prototype.isProbablePrime=h.prototype.isProbablePrime=a.prototype.isProbablePrime,a.prototype.modInv=function(t){for(var e,i,s,n=r.zero,o=r.one,a=V(t),h=this.abs();!h.isZero();)e=a.divide(h),i=n,s=a,n=o,a=h,o=i.subtract(e.multiply(o)),h=s.subtract(e.multiply(h));if(!a.isUnit())throw new Error(this.toString()+" and "+t.toString()+" are not co-prime");return-1===n.compare(0)&&(n=n.add(t)),this.isNegative()?n.negate():n},l.prototype.modInv=h.prototype.modInv=a.prototype.modInv,a.prototype.next=function(){var t=this.value;return this.sign?I(t,1,this.sign):new a(w(t,1),this.sign)},h.prototype.next=function(){var t=this.value;return t+1<i?new h(t+1):new a(s,!1)},l.prototype.next=function(){return new l(this.value+BigInt(1))},a.prototype.prev=function(){var t=this.value;return this.sign?new a(w(t,1),!0):I(t,1,this.sign)},h.prototype.prev=function(){var t=this.value;return t-1>-i?new h(t-1):new a(s,!0)},l.prototype.prev=function(){return new l(this.value-BigInt(1))};for(var B=[1];2*B[B.length-1]<=e;)B.push(2*B[B.length-1]);var P=B.length,O=B[P-1];function Y(t){return Math.abs(t)<=e}function D(t,e,i){e=V(e);for(var s=t.isNegative(),n=e.isNegative(),o=s?t.not():t,a=n?e.not():e,h=0,l=0,u=null,c=null,d=[];!o.isZero()||!a.isZero();)h=(u=L(o,O))[1].toJSNumber(),s&&(h=O-1-h),l=(c=L(a,O))[1].toJSNumber(),n&&(l=O-1-l),o=u[0],a=c[0],d.push(i(h,l));for(var m=0!==i(s?1:0,n?1:0)?r(-1):r(0),p=d.length-1;p>=0;p-=1)m=m.multiply(O).add(r(d[p]));return m}a.prototype.shiftLeft=function(t){var e=V(t).toJSNumber();if(!Y(e))throw new Error(String(e)+" is too large for shifting.");if(e<0)return this.shiftRight(-e);var i=this;if(i.isZero())return i;for(;e>=P;)i=i.multiply(O),e-=P-1;return i.multiply(B[e])},l.prototype.shiftLeft=h.prototype.shiftLeft=a.prototype.shiftLeft,a.prototype.shiftRight=function(t){var e,i=V(t).toJSNumber();if(!Y(i))throw new Error(String(i)+" is too large for shifting.");if(i<0)return this.shiftLeft(-i);for(var s=this;i>=P;){if(s.isZero()||s.isNegative()&&s.isUnit())return s;s=(e=L(s,O))[1].isNegative()?e[0].prev():e[0],i-=P-1}return(e=L(s,B[i]))[1].isNegative()?e[0].prev():e[0]},l.prototype.shiftRight=h.prototype.shiftRight=a.prototype.shiftRight,a.prototype.not=function(){return this.negate().prev()},l.prototype.not=h.prototype.not=a.prototype.not,a.prototype.and=function(t){return D(this,t,(function(t,e){return t&e}))},l.prototype.and=h.prototype.and=a.prototype.and,a.prototype.or=function(t){return D(this,t,(function(t,e){return t|e}))},l.prototype.or=h.prototype.or=a.prototype.or,a.prototype.xor=function(t){return D(this,t,(function(t,e){return t^e}))},l.prototype.xor=h.prototype.xor=a.prototype.xor;function X(t){var i=t.value,s="number"==typeof i?i|1<<30:"bigint"==typeof i?i|BigInt(1<<30):i[0]+i[1]*e|1073758208;return s&-s}function j(t,e){return t=V(t),e=V(e),t.greater(e)?t:e}function R(t,e){return t=V(t),e=V(e),t.lesser(e)?t:e}function _(t,e){if(t=V(t).abs(),e=V(e).abs(),t.equals(e))return t;if(t.isZero())return e;if(e.isZero())return t;for(var i,s,r=o[1];t.isEven()&&e.isEven();)i=R(X(t),X(e)),t=t.divide(i),e=e.divide(i),r=r.multiply(i);for(;t.isEven();)t=t.divide(X(t));do{for(;e.isEven();)e=e.divide(X(e));t.greater(e)&&(s=e,e=t,t=s),e=e.subtract(t)}while(!e.isZero());return r.isUnit()?t:t.multiply(r)}a.prototype.bitLength=function(){var t=this;return t.compareTo(r(0))<0&&(t=t.negate().subtract(r(1))),0===t.compareTo(r(0))?r(0):r(function t(e,i){if(i.compareTo(e)<=0){var s=t(e,i.square(i)),n=s.p,o=s.e,a=n.multiply(i);return a.compareTo(e)<=0?{p:a,e:2*o+1}:{p:n,e:2*o}}return{p:r(1),e:0}}(t,r(2)).e).add(r(1))},l.prototype.bitLength=h.prototype.bitLength=a.prototype.bitLength;var N=function(t,e,i,s){i=i||"0123456789abcdefghijklmnopqrstuvwxyz",t=String(t),s||(t=t.toLowerCase(),i=i.toLowerCase());var r,n=t.length,o=Math.abs(e),a={};for(r=0;r<i.length;r++)a[i[r]]=r;for(r=0;r<n;r++){if("-"!==(u=t[r])&&(u in a&&a[u]>=o)){if("1"===u&&1===o)continue;throw new Error(u+" is not a valid digit in base "+e+".")}}e=V(e);var h=[],l="-"===t[0];for(r=l?1:0;r<t.length;r++){var u;if((u=t[r])in a)h.push(V(a[u]));else{if("<"!==u)throw new Error(u+" is not a valid character");var c=r;do{r++}while(">"!==t[r]&&r<t.length);h.push(V(t.slice(c+1,r)))}}return U(h,e,l)};function U(t,e,i){var s,r=o[0],n=o[1];for(s=t.length-1;s>=0;s--)r=r.add(t[s].times(n)),n=n.times(e);return i?r.negate():r}function H(t,e){if((e=r(e)).isZero()){if(t.isZero())return{value:[0],isNegative:!1};throw new Error("Cannot convert nonzero numbers to base 0.")}if(e.equals(-1)){if(t.isZero())return{value:[0],isNegative:!1};if(t.isNegative())return{value:[].concat.apply([],Array.apply(null,Array(-t.toJSNumber())).map(Array.prototype.valueOf,[1,0])),isNegative:!1};var i=Array.apply(null,Array(t.toJSNumber()-1)).map(Array.prototype.valueOf,[0,1]);return i.unshift([1]),{value:[].concat.apply([],i),isNegative:!1}}var s=!1;if(t.isNegative()&&e.isPositive()&&(s=!0,t=t.abs()),e.isUnit())return t.isZero()?{value:[0],isNegative:!1}:{value:Array.apply(null,Array(t.toJSNumber())).map(Number.prototype.valueOf,1),isNegative:s};for(var n,o=[],a=t;a.isNegative()||a.compareAbs(e)>=0;){n=a.divmod(e),a=n.quotient;var h=n.remainder;h.isNegative()&&(h=e.minus(h).abs(),a=a.next()),o.push(h.toJSNumber())}return o.push(a.toJSNumber()),{value:o.reverse(),isNegative:s}}function F(t,e,i){var s=H(t,e);return(s.isNegative?"-":"")+s.value.map((function(t){return function(t,e){return t<(e=e||"0123456789abcdefghijklmnopqrstuvwxyz").length?e[t]:"<"+t+">"}(t,i)})).join("")}function W(t){if(u(+t)){var e=+t;if(e===f(e))return n?new l(BigInt(e)):new h(e);throw new Error("Invalid integer: "+t)}var i="-"===t[0];i&&(t=t.slice(1));var s=t.split(/e/i);if(s.length>2)throw new Error("Invalid integer: "+s.join("e"));if(2===s.length){var r=s[1];if("+"===r[0]&&(r=r.slice(1)),(r=+r)!==f(r)||!u(r))throw new Error("Invalid integer: "+r+" is not a valid exponent.");var o=s[0],c=o.indexOf(".");if(c>=0&&(r-=o.length-c-1,o=o.slice(0,c)+o.slice(c+1)),r<0)throw new Error("Cannot include negative exponent part for integers");t=o+=new Array(r+1).join("0")}if(!/^([0-9][0-9]*)$/.test(t))throw new Error("Invalid integer: "+t);if(n)return new l(BigInt(i?"-"+t:t));for(var d=[],p=t.length,g=p-7;p>0;)d.push(+t.slice(g,p)),(g-=7)<0&&(g=0),p-=7;return m(d),new a(d,i)}function V(t){return"number"==typeof t?function(t){if(n)return new l(BigInt(t));if(u(t)){if(t!==f(t))throw new Error(t+" is not an integer.");return new h(t)}return W(t.toString())}(t):"string"==typeof t?W(t):"bigint"==typeof t?new l(t):t}a.prototype.toArray=function(t){return H(this,t)},h.prototype.toArray=function(t){return H(this,t)},l.prototype.toArray=function(t){return H(this,t)},a.prototype.toString=function(t,e){if(void 0===t&&(t=10),10!==t)return F(this,t,e);for(var i,s=this.value,r=s.length,n=String(s[--r]);--r>=0;)i=String(s[r]),n+="0000000".slice(i.length)+i;return(this.sign?"-":"")+n},h.prototype.toString=function(t,e){return void 0===t&&(t=10),10!=t?F(this,t,e):String(this.value)},l.prototype.toString=h.prototype.toString,l.prototype.toJSON=a.prototype.toJSON=h.prototype.toJSON=function(){return this.toString()},a.prototype.valueOf=function(){return parseInt(this.toString(),10)},a.prototype.toJSNumber=a.prototype.valueOf,h.prototype.valueOf=function(){return this.value},h.prototype.toJSNumber=h.prototype.valueOf,l.prototype.valueOf=l.prototype.toJSNumber=function(){return parseInt(this.toString(),10)};for(var G=0;G<1e3;G++)o[G]=V(G),G>0&&(o[-G]=V(-G));return o.one=o[1],o.zero=o[0],o.minusOne=o[-1],o.max=j,o.min=R,o.gcd=_,o.lcm=function(t,e){return t=V(t).abs(),e=V(e).abs(),t.divide(_(t,e)).multiply(e)},o.isInstance=function(t){return t instanceof a||t instanceof h||t instanceof l},o.randBetween=function(t,i,s){t=V(t),i=V(i);var r=s||Math.random,n=R(t,i),a=j(t,i).subtract(n).add(1);if(a.isSmall)return n.add(Math.floor(r()*a));for(var h=H(a,e).value,l=[],u=!0,c=0;c<h.length;c++){var d=u?h[c]:e,m=f(r()*d);l.push(m),m<d&&(u=!1)}return n.add(o.fromArray(l,e,!1))},o.fromArray=function(t,e,i){return U(t.map(V),V(e||10),i)},o}();t.hasOwnProperty("exports")&&(t.exports=r),void 0===(s=function(){return r}.call(e,i,e,t))||(t.exports=s)}).call(this,i(11)(t))},function(t,e){t.exports=class{constructor(t){this.url=t,this.xhr=new XMLHttpRequest,this.xhr.responseType="arraybuffer",this.xhr.open("GET",t,!0),this.buffer=null,this.pos=0}async _loadResBytes(){return new Promise((t,e)=>{this.xhr.onerror=t=>e(t),this.xhr.onload=()=>{2===this.xhr.status?e(new Error(`unable to download ${this.url}. status code = ${this.xhr.status}`)):t(new Int8Array(this.xhr.response))},this.xhr.send()})}async readFully(t,e=0,i){void 0===i&&(i=t.length),this.buffer||(this.buffer=await this._loadResBytes()),t.set(this.buffer.slice(this.pos,this.pos+i),e),this.pos+=i}}},function(t,e){t.exports=class{constructor(t,e){this.host=t,this.port=e,this.client=null,this.connected=!1,this.bytesAvailable=0,this.bufferList=[],this.buffer=null,this.bufferOffset=0,this.bufferRemains=0}connect(){return new Promise((t,e)=>{this.client=new WebSocket(`${this.host}:${this.port}`,"binary"),this.client.binaryType="arraybuffer";let i=()=>{this.client.removeEventListener("error",r),this.client.removeEventListener("open",n),this.client.removeEventListener("close",i),this.client.removeEventListener("message",s),this.connected=!1,this.clear()},s=t=>{this.bufferList.push(new Int8Array(t.data)),this.bytesAvailable+=t.data.byteLength,this.refreshCurrentBuffer()},r=t=>{this.client.removeEventListener("error",r),this.client.removeEventListener("open",n),this.client.removeEventListener("close",i),this.client.removeEventListener("message",s),this.connected=!1,this.clear(),e(t)},n=()=>{this.client.removeEventListener("open",n),this.connected=!0,this.client.addEventListener("close",i),this.client.addEventListener("message",s),t()};this.client.addEventListener("error",r),this.client.addEventListener("open",n)})}write(t,e=0,i=t.length){this.connected?this.client.send(t.slice(e,e+i)):this.close()}refreshCurrentBuffer(){if(!(this.bufferList.length<=0)&&(!this.buffer||0===this.bufferRemains&&this.available()>0)){if(this.buffer=this.bufferList.shift(),this.bufferOffset=0,this.buffer&&this.buffer.length)return void(this.bufferRemains=this.buffer.length);this.bufferRemains=0}}async readByte(){return this.connected&&this.client?this.available()>0&&this.bufferRemains>0&&this.buffer?(this.bufferRemains--,this.bytesAvailable--,255&this.buffer[this.bufferOffset++]):new Promise((t,e)=>{let i=()=>{this.client.removeEventListener("error",s),this.client.removeEventListener("message",r),this.client.removeEventListener("close",i),t(-1)},s=t=>{this.client.removeEventListener("error",s),this.client.removeEventListener("message",r),this.client.removeEventListener("close",i),e(t)},r=async()=>{this.client.removeEventListener("error",s),this.client.removeEventListener("message",r),this.client.removeEventListener("close",i),t(await this.readByte())};this.client.addEventListener("error",s),this.client.addEventListener("close",i),this.client.addEventListener("message",r)}):-1}async readBytes(t,e=0,i=t.length){if(!this.connected)return-1;if(this.available()>=i&&this.bufferRemains>=i&&this.buffer){for(let s=e;s<e+i;s++)t[s]=255&this.buffer[this.bufferOffset++],this.bytesAvailable--,--this.bufferRemains<=0&&this.refreshCurrentBuffer();return i}return new Promise((s,r)=>{let n,o,a;n=()=>{this.client.removeEventListener("error",o),this.client.removeEventListener("close",n),this.client.removeEventListener("message",a),s(-1)},o=t=>{this.client.removeEventListener("error",o),this.client.removeEventListener("close",n),this.client.removeEventListener("message",a),r(t)},a=async()=>{this.client.removeEventListener("error",o),this.client.removeEventListener("close",n),this.client.removeEventListener("message",a),s(await this.readBytes(t,e,i))},this.client.addEventListener("error",o),this.client.addEventListener("close",n),this.client.addEventListener("message",a)})}close(){this.connected&&this.client.close()}available(){return this.bytesAvailable}clear(){this.close(),this.buffer=null,this.bufferList=[],this.bufferOffset=0,this.bufferRemains=0,this.bytesAvailable=0}}},function(t,e,i){!function(t){"use strict";function i(){this.load(arguments[0])}function s(t,e,i,s,r,n,o,a,h,l){var u,c,d,m,p,f,g=this.header.colorMapDepth>>3;for(m=0,f=r;f!==o;f+=n)for(p=a;p!==l;p+=h,m++)d=4*(p+s*f),c=e[m]*g,4===g?(t[d]=i[c+2],t[d+1]=i[c+1],t[d+2]=i[c],t[d+3]=i[c+3]):3===g?(t[d]=i[c+2],t[d+1]=i[c+1],t[d+2]=i[c],t[d+3]=255):2===g&&(u=i[c]|i[c+1]<<8,t[d]=(31744&u)>>7,t[d+1]=(992&u)>>2,t[d+2]=(31&u)<<3,t[d+3]=32768&u?0:255);return t}function r(t,e,i,s,r,n,o,a,h,l){var u,c,d,m,p;for(d=0,p=r;p!==o;p+=n)for(m=a;m!==l;m+=h,d+=2)u=e[d]|e[d+1]<<8,t[c=4*(m+s*p)]=(31744&u)>>7,t[c+1]=(992&u)>>2,t[c+2]=(31&u)<<3,t[c+3]=32768&u?0:255;return t}function n(t,e,i,s,r,n,o,a,h,l){var u,c,d,m,p=this.header.pixelDepth>>3;for(c=0,m=r;m!==o;m+=n)for(d=a;d!==l;d+=h,c+=p)t[(u=4*(d+s*m))+3]=255,t[u+2]=e[c],t[u+1]=e[c+1],t[u]=e[c+2];return t}function o(t,e,i,s,r,n,o,a,h,l){var u,c,d,m;for(u=0,d=r;d!==o;d+=n)for(c=a;c!==l;c+=h,u+=4)t[(m=4*(c+s*d))+2]=e[u],t[m+1]=e[u+1],t[m]=e[u+2],t[m+3]=e[u+3];return t}function a(t,e,i,s,r,n,o,a,h,l){var u,c,d,m,p;for(u=0,d=r;d!==o;d+=n)for(c=a;c!==l;c+=h,u+=4)m=4*(c+s*d),p=255*e[u+3],t[m+2]=e[u]/p,t[m+1]=e[u+1]/p,t[m]=e[u+2]/p,t[m+3]=e[u+3];return t}function h(t,e,i,s,r,n,o,a,h,l){var u,c,d,m,p;for(d=0,p=r;p!==o;p+=n)for(m=a;m!==l;m+=h,d++)u=e[d],t[c=4*(m+s*p)]=u,t[c+1]=u,t[c+2]=u,t[c+3]=255;return t}function l(t,e,i,s,r,n,o,a,h,l){var u,c,d,m,p;for(d=0,p=r;p!==o;p+=n)for(m=a;m!==l;m+=h,d+=2)u=e[d],t[c=4*(m+s*p)]=u,t[c+1]=u,t[c+2]=u,t[c+3]=e[d+1];return t}function u(t){var e=t.byteLength-i.FOOTER_SIZE,s=i.SIGNATURE,r={},n=new Uint8Array(t.buffer,e+8,s.length);return function(t){for(var e=i.SIGNATURE,s=0;s<e.length;s++)if(t.charCodeAt(s)!==e.charCodeAt(s))return!1;return!0}(String.fromCharCode.apply(null,n))?(r.hasFooter=!0,r.extensionOffset=t.getUint32(e,i.LITTLE_ENDIAN),r.developerOffset=t.getUint32(e+4,i.LITTLE_ENDIAN),r.hasExtensionArea=0!==r.extensionOffset,r.hasDeveloperArea=0!==r.developerOffset,r.extensionOffset&&(r.attributeType=t.getUint8(r.extensionOffset+494)),r):(r.hasFooter=!1,r)}i.Type={NO_DATA:0,INDEXED:1,RGB:2,GREY:3,RLE_INDEXED:9,RLE_RGB:10,RLE_GREY:11},i.Origin={BOTTOM_LEFT:0,BOTTOM_RIGHT:1,TOP_LEFT:2,TOP_RIGHT:3,SHIFT:4,MASK:48,ALPHA:8},i.HEADER_SIZE=18,i.FOOTER_SIZE=26,i.LITTLE_ENDIAN=!0,i.RLE_BIT=128,i.RLE_MASK=127,i.RLE_PACKET=1,i.RAW_PACKET=2,i.SIGNATURE="TRUEVISION-XFILE.\0",i.prototype.open=function(t,e){var i,s=this;(i=new XMLHttpRequest).open("GET",t,!0),i.responseType="arraybuffer",i.onload=function(){200===this.status&&(s.arrayBuffer=i.response,s.load(s.arrayBuffer),e&&e.call(s))},i.send(null)},i.prototype.load=function(t){var e,s=new DataView(t);this.headerData=new Uint8Array(t,0,i.HEADER_SIZE),this.header=function(t){var e=i.LITTLE_ENDIAN;if(t.byteLength<18)throw new Error("Targa::load() - Not enough data to contain header");var s={};return s.idLength=t.getUint8(0),s.colorMapType=t.getUint8(1),s.imageType=t.getUint8(2),s.colorMapIndex=t.getUint16(3,e),s.colorMapLength=t.getUint16(5,e),s.colorMapDepth=t.getUint8(7),s.offsetX=t.getUint16(8,e),s.offsetY=t.getUint16(10,e),s.width=t.getUint16(12,e),s.height=t.getUint16(14,e),s.pixelDepth=t.getUint8(16),s.flags=t.getUint8(17),s}(s),(e=this.header).hasEncoding=e.imageType===i.Type.RLE_INDEXED||e.imageType===i.Type.RLE_RGB||e.imageType===i.Type.RLE_GREY,e.hasColorMap=e.imageType===i.Type.RLE_INDEXED||e.imageType===i.Type.INDEXED,e.isGreyColor=e.imageType===i.Type.RLE_GREY||e.imageType===i.Type.GREY,e.bytePerPixel=e.pixelDepth>>3,e.origin=(e.flags&i.Origin.MASK)>>i.Origin.SHIFT,e.alphaBits=e.flags&i.Origin.ALPHA,function(t){if(t.imageType===i.Type.NO_DATA)throw new Error("Targa::checkHeader() - No data");if(t.hasColorMap){if(t.colorMapLength>256||1!==t.colorMapType)throw new Error("Targa::checkHeader() - Unsupported colormap for indexed type");if(16!==t.colorMapDepth&&24!==t.colorMapDepth&&32!==t.colorMapDepth)throw new Error("Targa::checkHeader() - Unsupported colormap depth")}else if(t.colorMapType)throw new Error("Targa::checkHeader() - Why does the image contain a palette ?");if(t.width<=0||t.height<=0)throw new Error("Targa::checkHeader() - Invalid image size");if(8!==t.pixelDepth&&16!==t.pixelDepth&&24!==t.pixelDepth&&32!==t.pixelDepth)throw new Error('Targa::checkHeader() - Invalid pixel size "'+t.pixelDepth+'"');if(0!==t.alphaBits&&1!==t.alphaBits&&8!==t.alphaBits)throw new Error("Targa::checkHeader() - Unsuppported alpha size")}(this.header);var r=i.HEADER_SIZE;if((r+=this.header.idLength)>=t.byteLength)throw new Error("Targa::load() - No data");if(this.header.hasColorMap){var n=this.header.colorMapLength*(this.header.colorMapDepth>>3);this.palette=new Uint8Array(t,r,n),r+=n}var o=this.header.pixelDepth>>3,a=this.header.width*this.header.height,h=a*o;if(this.header.hasEncoding){var l=t.byteLength-r-i.FOOTER_SIZE,c=new Uint8Array(t,r,l);this.imageData=function(t,e,s){var r,n,o,a,h,l,u;for(u=new Uint8Array(s),l=new Uint8Array(e),h=0,r=0;r<s;)if(o=1+((n=t[h++])&i.RLE_MASK),n&i.RLE_BIT){for(a=0;a<e;++a)l[a]=t[h++];for(a=0;a<o;++a)u.set(l,r),r+=e}else for(o*=e,a=0;a<o;++a)u[r++]=t[h++];if(r>s)throw new Error("Targa::decodeRLE() - Read bytes: "+r+" Expected bytes: "+s);return u}(c,o,h)}else this.imageData=new Uint8Array(t,r,this.header.hasColorMap?a:h);this.footer=u(s),(0!==this.header.alphaBits||this.footer.hasExtensionArea&&(3===this.footer.attributeType||4===this.footer.attributeType))&&(this.footer.usesAlpha=!0)},i.prototype.getImageData=function(t){var e,u,c,d,m,p,f,g=this.header.width,S=this.header.height,w=(this.header.flags&i.Origin.MASK)>>i.Origin.SHIFT;switch(t||(t=document?document.createElement("canvas").getContext("2d",{alpha:!0,desynchronized:!0,depth:!0,antialias:!0}).createImageData(g,S):{width:g,height:S,data:new Uint8ClampedArray(g*S*4)}),w===i.Origin.TOP_LEFT||w===i.Origin.TOP_RIGHT?(d=0,m=1,p=S):(d=S-1,m=-1,p=-1),w===i.Origin.TOP_LEFT||w===i.Origin.BOTTOM_LEFT?(e=0,u=1,c=g):(e=g-1,u=-1,c=-1),this.header.pixelDepth){case 8:f=this.header.isGreyColor?h:s;break;case 16:f=this.header.isGreyColor?l:r;break;case 24:f=n;break;case 32:f=this.footer.hasExtensionArea?3===this.footer.attributeType?o:4===this.footer.attributeType?a:n:0!==this.header.alphaBits?o:n}return f.call(this,t.data,this.imageData,this.palette,g,d,m,p,e,u,c),t},i.prototype.setImageData=function(t){if(!t)throw new Error("Targa::setImageData() - imageData argument missing");var e,s,r,n,a,h,l=this.header.width,u=this.header.height,c=l*u*(this.header.pixelDepth>>3),d=(this.header.flags&i.Origin.MASK)>>i.Origin.SHIFT;d===i.Origin.TOP_LEFT||d===i.Origin.TOP_RIGHT?(n=0,a=1,h=u):(n=u-1,a=-1,h=-1),d===i.Origin.TOP_LEFT||d===i.Origin.BOTTOM_LEFT?(e=0,s=1,r=l):(e=l-1,s=-1,r=-1),this.imageData||(this.imageData=new Uint8Array(c)),o(this.imageData,t.data,this.palette,l,n,a,h,e,s,r);var m=this.imageData;this.header.hasEncoding&&(m=function(t,e){for(var s,r,n,o,a=e,h=[],l=0,u=t.pixelDepth>>3,c=0,d=t.width*t.height*u,m=function(t,e){for(var i=0;i<u;i++)if(a[t*u+i]!==a[e*u+i])return!1;return!0},p=function(t){return m(t,t+1)?i.RLE_PACKET:i.RAW_PACKET};l*u<a.length&&l*u<d;){if(n=0,(r=p(l))===i.RLE_PACKET)for(;l+n<a.length&&n<128&&m(l,l+n);)n++;else for(;l+n<a.length&&n<128&&p(l+n)===i.RAW_PACKET;)n++;if(o=n-1,r===i.RLE_PACKET&&(o|=i.RLE_BIT),h[c++]=o,r===i.RLE_PACKET){for(s=0;s<u;s++)h[s+c]=a[s+l*u];c+=u}else{for(s=0;s<u*n;s++)h[s+c]=a[s+l*u];c+=u*n}l+=n}return new Uint8Array(h)}(this.header,m));var p=i.HEADER_SIZE+m.length+i.FOOTER_SIZE,f=new ArrayBuffer(p);this.arrayBuffer=f,this.headerData=new Uint8Array(f,0,i.HEADER_SIZE),this.RLEData=new Uint8Array(f,i.HEADER_SIZE,m.length),this.footerData=new Uint8Array(f,i.HEADER_SIZE+m.length,i.FOOTER_SIZE);var g,S,w,y=new DataView(this.headerData.buffer);g=this.header,S=y,w=i.LITTLE_ENDIAN,S.setUint8(0,g.idLength),S.setUint8(1,g.colorMapType),S.setUint8(2,g.imageType),S.setUint16(3,g.colorMapIndex,w),S.setUint16(5,g.colorMapLength,w),S.setUint8(7,g.colorMapDepth),S.setUint16(8,g.offsetX,w),S.setUint16(10,g.offsetY,w),S.setUint16(12,g.width,w),S.setUint16(14,g.height,w),S.setUint8(16,g.pixelDepth),S.setUint8(17,g.flags),this.RLEData.set(m),function(t){for(var e=i.SIGNATURE,s=t.byteLength-e.length,r=0;r<e.length;r++)t[s+r]=e.charCodeAt(r)}(this.footerData)},i.prototype.getCanvas=function(){var t,e,i;return i=(e=(t=document.createElement("canvas")).getContext("2d")).createImageData(this.header.width,this.header.height),t.width=this.header.width,t.height=this.header.height,e.putImageData(this.getImageData(i),0,0),t},i.prototype.getDataURL=function(t){return this.getCanvas().toDataURL(t||"image/png")},i.prototype.getBlobURL=function(){if(!this.arrayBuffer)throw new Error("Targa::getBlobURL() - No data available for blob");var t=new Blob([this.arrayBuffer],{type:"image/x-tga"});return URL.createObjectURL(t)};var c={};c.exports=e,c.exports&&(c.exports.TGA=i)}()},function(t,e){function i(t){this.init(t)}i.prototype.init=function(t){this.option=Object.assign({},{encoding:"16bitInt",channels:1,sampleRate:8e3,flushingTime:1e3},t),this.samples=new Float32Array,this.flush=this.flush.bind(this),this.interval=setInterval(this.flush,this.option.flushingTime),this.maxValue=this.getMaxValue(),this.typedArray=this.getTypedArray(),this.createContext()},i.prototype.getMaxValue=function(){var t={"8bitInt":128,"16bitInt":32768,"32bitInt":2147483648,"32bitFloat":1};return t[this.option.encoding]?t[this.option.encoding]:t["16bitInt"]},i.prototype.getTypedArray=function(){var t={"8bitInt":Int8Array,"16bitInt":Int16Array,"32bitInt":Int32Array,"32bitFloat":Float32Array};return t[this.option.encoding]?t[this.option.encoding]:t["16bitInt"]},i.prototype.createContext=function(){this.audioCtx=new(window.AudioContext||window.webkitAudioContext),this.gainNode=this.audioCtx.createGain(),this.gainNode.gain.value=1,this.gainNode.connect(this.audioCtx.destination),this.startTime=this.audioCtx.currentTime},i.prototype.isTypedArray=function(t){return t.byteLength&&t.buffer&&t.buffer.constructor==ArrayBuffer},i.prototype.feed=function(t){if(this.isTypedArray(t)){t=this.getFormatedValue(t);var e=new Float32Array(this.samples.length+t.length);e.set(this.samples,0),e.set(t,this.samples.length),this.samples=e}},i.prototype.getFormatedValue=function(t){t=new this.typedArray(t.buffer);var e,i=new Float32Array(t.length);for(e=0;e<t.length;e++)i[e]=t[e]/this.maxValue;return i},i.prototype.volume=function(t){this.gainNode.gain.value=t},i.prototype.destroy=function(){this.interval&&clearInterval(this.interval),this.samples=null,this.audioCtx.close(),this.audioCtx=null},i.prototype.flush=function(){if(this.samples.length){var t,e,i,s,r,n=this.audioCtx.createBufferSource(),o=this.samples.length/this.option.channels,a=this.audioCtx.createBuffer(this.option.channels,o,this.option.sampleRate);for(e=0;e<this.option.channels;e++)for(t=a.getChannelData(e),i=e,r=50,s=0;s<o;s++)t[s]=this.samples[i],s<50&&(t[s]=t[s]*s/50),o-51<=s&&(t[s]=t[s]*r--/50),i+=this.option.channels;this.startTime<this.audioCtx.currentTime&&(this.startTime=this.audioCtx.currentTime),console.log("start vs current "+this.startTime+" vs "+this.audioCtx.currentTime+" duration: "+a.duration),n.buffer=a,n.connect(this.gainNode),n.start(this.startTime),this.startTime+=a.duration,this.samples=new Float32Array}},t.exports=i},function(t,e,i){!function(t){Object.defineProperty(t,"__esModule",{value:!0});var e=function(t){var e=[1,1,2,2,3,3,3,3,4,4,4,4,4,4,4,4,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7];function i(t){var i,s=~(t=-32768==t?-32767:t)>>8&128;if(s||(t*=-1),t>32635&&(t=32635),t>=256){var r=e[t>>8&127];i=r<<4|t>>r+3&15}else i=t>>4;return 85^i^s}function s(t){var e=0;128&(t^=85)&&(t&=-129,e=-1);var i=4+((240&t)>>4),s=0;return s=4!=i?1<<i|(15&t)<<i-4|1<<i-5:t<<1|1,8*(s=0===e?s:-s)*-1}var r=Object.freeze({encodeSample:i,decodeSample:s,encode:function(t){for(var e=new Uint8Array(t.length),s=0;s<t.length;s++)e[s]=i(t[s]);return e},decode:function(t){for(var e=new Int16Array(t.length),i=0;i<t.length;i++)e[i]=s(t[i]);return e}}),n=[0,0,1,1,2,2,2,2,3,3,3,3,3,3,3,3,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7],o=[0,132,396,924,1980,4092,8316,16764];function a(t){var e,i;return 0!=(e=t>>8&128)&&(t=-t),t>32635&&(t=32635),~(e|(i=n[(t+=132)>>7&255])<<4|t>>i+3&15)}function h(t){var e,i;return i=o[e=(t=~t)>>4&7]+((15&t)<<e+3),0!=(128&t)&&(i=-i),i}var l=Object.freeze({encodeSample:a,decodeSample:h,encode:function(t){for(var e=new Uint8Array(t.length),i=0;i<t.length;i++)e[i]=a(t[i]);return e},decode:function(t){for(var e=new Int16Array(t.length),i=0;i<t.length;i++)e[i]=h(t[i]);return e}});return t.alaw=r,t.mulaw=l,t}({});t.alaw=e.alaw,t.mulaw=e.mulaw}(e)},function(t,e){t.exports=function(t){return t.webpackPolyfill||(t.deprecate=function(){},t.paths=[],t.children||(t.children=[]),Object.defineProperty(t,"loaded",{enumerable:!0,get:function(){return t.l}}),Object.defineProperty(t,"id",{enumerable:!0,get:function(){return t.i}}),t.webpackPolyfill=1),t}},function(t,e,i){"use strict";t.exports=function(t){for(var e=new Array(t),i=0;i<t;++i)e[i]=i;return e}},function(t,e){function i(t){return!!t.constructor&&"function"==typeof t.constructor.isBuffer&&t.constructor.isBuffer(t)}
/*!
 * Determine if an object is a Buffer
 *
 * @author   Feross Aboukhadijeh <https://feross.org>
 * @license  MIT
 */
t.exports=function(t){return null!=t&&(i(t)||function(t){return"function"==typeof t.readFloatLE&&"function"==typeof t.slice&&i(t.slice(0,0))}(t)||!!t._isBuffer)}},function(t,r,n){"use strict";n.r(r);var o=n(4),a=n.n(o),h=n(6),l=n.n(h);class u{constructor(t){this.name=t,this.ordinal=u.id++}toNumber(){return this.ordinal}toString(){return this.name}}Object.defineProperty(u,"id",{get:()=>u._id,set:t=>{u._id=t}});const c="0".charCodeAt(0),d="9".charCodeAt(0),m="a".charCodeAt(0),p="A".charCodeAt(0),f="Z".charCodeAt(0),g="z".charCodeAt(0);class S{static openFile(t){return new l.a(t)}static getBoolean(t){return 0!==S.getUnsignedByte(t)}static getBytes(t,e=0,i=t.length){return t.length<e?t.slice():t.length<e+i?t.slice(e):t.slice(e,e+i)}static getUnsignedByte(t){return 255&t}static getUnsignedShort(t,e){return S.getUnsignedByte(t[e])<<8|S.getUnsignedByte(t[e+1])}static getUnsignedInt(t,e){return S.getUnsignedShort(t,e)<<16|S.getUnsignedShort(t,e+2)}static getUnsignedLong(t,e){return BigInt(S.getUnsignedByte(t[e]))<<56n|BigInt(S.getUnsignedByte(t[e+1]))<<48n|BigInt(S.getUnsignedByte(t[e+2]))<<40n|BigInt(S.getUnsignedByte(t[e+3]))<<32n|BigInt(S.getUnsignedByte(t[e+4]))<<24n|BigInt(S.getUnsignedByte(t[e+5]))<<16n|BigInt(S.getUnsignedByte(t[e+6]))<<8n|BigInt(S.getUnsignedByte(t[e+7]))}static getSignedShort(t,e){let i=S.getUnsignedShort(t,e);return i>=32768?i-65536:i}static getSmart08_32(t,e){let i=S.getUnsignedByte(t[e]);return i>=128?i-128<<24|S.getUnsignedByte(t[e+1])<<16|S.getUnsignedByte(t[e+2])<<8|S.getUnsignedByte(t[e+3]):-129&i}static getBitMask(t,e,i){let s=e>>3,r=8-(7&e),n=0;for(;i>r;r=8)n+=(t[s++]&w[r])<<i-r,i-=r;return n+=i===r?t[s]&w[r]:t[s]>>r-i&w[i],n}static recoveryToHash(t){if(!S.wasmMod){t=t.toLowerCase().trim();let e=0n,i=0n;for(let s=0;s<t.length;s++){let r=t.charCodeAt(s);(r>=m&&r<=g||r>=c&&r<=d)&&(e=47n*e*(e-BigInt(6*r)-BigInt(7*i)),e+=BigInt(r-32)+BigInt(i*r),i++)}return e}return S.wasmMod.hashRecoveryAnswer(t)}static formatAndTruncate(t,e){let i="";for(let s=0;s<e&&s<t.length;s++){let e=t.charCodeAt(s);i+=e>=m&&e<=g||e>=p&&e<=f||e>=c&&e<=d?String.fromCharCode(e):"_"}return i}static getIntegerAsString(t){return(t>>24&255)+"."+(t>>16&255)+"."+(t>>8&255)+"."+(255&t)}static usernameToHash(t){if(!S.wasmMod){let e="";for(let i=0;i<t.length&&i<=20;i++){let s=t.charCodeAt(i);s>=p&&s<=f&&(s=s+97-65),e+=s>=m&&s<=g||s>=c&&s<=d?String.fromCharCode(s):" "}e=e.trim();let i=0n;for(let t=0;t<e.length;t++){let s=e.charCodeAt(t);i*=37n,s>=m&&s<=g?i+=BigInt(1+s-97):s>=c&&s<=d&&(i+=BigInt(27+s-48))}return i}return S.wasmMod.usernameToHash(t)}static hashToUsername(t){if(!S.wasmMod){if(t<=0n)return"invalid_name";let e="";for(;t>0n;){let i=t%37n,s=(t/=37n)%37n===0n,r=" ";i>0n&&(r=i<27n?String.fromCharCode(Number(i+BigInt(s?p:m)-1n)):String.fromCharCode(Number(i+BigInt(c)-27n))),e=r+e}return e}return S.wasmMod.hashToUsername(t)}static getDataFileOffset(t,e){let i=S.getUnsignedShort(e,0),s=0;t=t.toUpperCase();for(let e=0;e<t.length;e++)s=(61*s|0)+t.charCodeAt(e)-32;let r=2+10*i;for(let t=0;t<i;t++){let i=(255&e[10*t+2])<<24|(255&e[10*t+3])<<16|(255&e[10*t+4])<<8|255&e[10*t+5],n=(255&e[10*t+9])<<16|(255&e[10*t+10])<<8|255&e[10*t+11];if(i===s)return r;r+=n}return 0}static getDataFileLength(t,e){let i=S.getUnsignedShort(e,0);t=t.toUpperCase();let s=0;for(let e=0;e<t.length;e++)s=(61*s|0)+t.charCodeAt(e)-32;let r=2+10*i;for(let t=0;t<i;t++){let i=(255&e[10*t+2])<<24|(255&e[10*t+3])<<16|(255&e[10*t+4])<<8|255&e[10*t+5],n=(255&e[10*t+6])<<16|(255&e[10*t+7])<<8|255&e[10*t+8],o=(255&e[10*t+9])<<16|(255&e[10*t+10])<<8|255&e[10*t+11];if(i===s)return n;r+=o}return 0}static loadData(t,e,i){return S.unpackData(t,e,i,null)}static unpackData(t,e,i,s){let r=(255&i[0])<<8|255&i[1],n=0;t=t.toUpperCase();for(let e=0;e<t.length;e++)n=(61*n|0)+t.charCodeAt(e)-32;let o=2+10*r;for(let t=0;t<r;t++){let r=((255&i[10*t+2])<<24)+((255&i[10*t+3])<<16)+((255&i[10*t+4])<<8)+(255&i[10*t+5])|0,h=((255&i[10*t+6])<<16)+((255&i[10*t+7])<<8)+(255&i[10*t+8])|0,l=((255&i[10*t+9])<<16)+((255&i[10*t+10])<<8)+(255&i[10*t+11])|0;if(r===n){if(null===s&&(s=new Int8Array(h+e)),h!==l)return a.a.decompress(s,h,i,l,o),s;for(let t=0;t<h;t++)s[t]=i[o+t];return s}o+=l}return null}static initializeWasm(t){S.wasmMod=t}}let w=new Int32Array(66);for(let t in w)w[t]=(1<<t)-1;class y extends u{constructor(t){super(t)}}class I extends y{constructor(t){super(t),super.ordinal=I.state++}}Object.defineProperty(I,"state",{get:()=>I._state,set:t=>{I._state=t}});class b extends u{constructor(t){super(t),super.ordinal=b.state++}}Object.defineProperty(b,"state",{get:()=>b._state,set:t=>{b._state=t}});class T extends y{constructor(t){super(t),super.ordinal=T.state++}}Object.defineProperty(T,"state",{get:()=>T._state,set:t=>{T._state=t}});class x extends y{constructor(t){super(t),super.ordinal=x.state++}}Object.defineProperty(x,"state",{get:()=>x._state,set:t=>{x._state=t}});let v={LAUNCH:new x("Launching game engine"),INITIALIZE_DATA:new x("Downloading and setting up all the game assets"),RUNNING:new x("Engine clock is ticking"),SHUTDOWN:new x("Engine is shutting down")},A={LOGIN:new T("Welcome or Login screen view"),WORLD:new T("World/Player sky-down view")},L=new b("Avatar Creation View"),M=new b("Game Chat View"),k={WELCOME:new I("Welcome view"),NEW_USER:new I("New User view"),EXISTING_USER:new I("Existing User view")};class E{static fromLong(t=255<<24){return new E(t>>16&255,t>>8&255,255&t,255)}constructor(t,e,i,s=255){this.r=t,this.g=e,this.b=i,this.a=s}toCanvasStyle(){return`rgba(${this.r},${this.g}, ${this.b}, ${this.a})`}toString(){return this.toCanvasStyle()}toRGB(){return this.r<<16|this.g<<8|255&this.b}toRGBA(){return this.toRGB()<<8|255&this.a}toABGR(){return this.a<<24|this.toBGR()}toBGR(){return this.b<<16|this.g<<8|255&this.r}}Object.defineProperty(E,"blue",{get:()=>E.fromLong(255),set:void 0}),Object.defineProperty(E,"BLUE",{get:()=>E.fromLong(255),set:void 0}),Object.defineProperty(E,"green",{get:()=>E.fromLong(65280),set:void 0}),Object.defineProperty(E,"GREEN",{get:()=>E.fromLong(65280),set:void 0}),Object.defineProperty(E,"red",{get:()=>E.fromLong(16711680),set:void 0}),Object.defineProperty(E,"RED",{get:()=>E.fromLong(16711680),set:void 0}),Object.defineProperty(E,"pink",{get:()=>E.fromLong(16756655),set:void 0}),Object.defineProperty(E,"PINK",{get:()=>E.fromLong(16756655),set:void 0}),Object.defineProperty(E,"LIGHT_GRAY",{get:()=>E.fromLong(12632256),set:void 0}),Object.defineProperty(E,"lightGray",{get:()=>E.fromLong(12632256),set:void 0}),Object.defineProperty(E,"SILVER",{get:()=>E.fromLong(13027014),set:void 0}),Object.defineProperty(E,"silver",{get:()=>E.fromLong(13027014),set:void 0}),Object.defineProperty(E,"SHADOW_GRAY",{get:()=>E.fromLong(8684676),set:void 0}),Object.defineProperty(E,"shadowGray",{get:()=>E.fromLong(8684676),set:void 0}),Object.defineProperty(E,"GRAY",{get:()=>E.fromLong(8421504),set:void 0}),Object.defineProperty(E,"gray",{get:()=>E.fromLong(8421504),set:void 0}),Object.defineProperty(E,"DARK_GRAY",{get:()=>E.fromLong(4210752),set:void 0}),Object.defineProperty(E,"darkGray",{get:()=>E.fromLong(4210752),set:void 0}),Object.defineProperty(E,"CYAN",{get:()=>E.fromLong(65535),set:void 0}),Object.defineProperty(E,"cyan",{get:()=>E.fromLong(65535),set:void 0}),Object.defineProperty(E,"magenta",{get:()=>E.fromLong(16711935),set:void 0}),Object.defineProperty(E,"MAGENTA",{get:()=>E.fromLong(16711935),set:void 0}),Object.defineProperty(E,"YELLOW",{get:()=>E.fromLong(16776960),set:void 0}),Object.defineProperty(E,"yellow",{get:()=>E.fromLong(16776960),set:void 0}),Object.defineProperty(E,"orange",{get:()=>E.fromLong(16762880),set:void 0}),Object.defineProperty(E,"ORANGE",{get:()=>E.fromLong(16762880),set:void 0}),Object.defineProperty(E,"black",{get:()=>E.fromLong(0),set:void 0}),Object.defineProperty(E,"BLACK",{get:()=>E.fromLong(0),set:void 0}),Object.defineProperty(E,"white",{get:()=>E.fromLong(16777215),set:void 0}),Object.defineProperty(E,"WHITE",{get:()=>E.fromLong(16777215),set:void 0});class B extends u{constructor(t){super(t)}}Object.defineProperty(B,"NORMAL",{get:()=>new B("normal"),set:void 0}),Object.defineProperty(B,"BOLD",{get:()=>new B("bold"),set:void 0}),Object.defineProperty(B,"ITALIC",{get:()=>new B("italic"),set:void 0});class P{constructor(t,e=B.NORMAL,i=15){this.name=t,this.type=e,this.size=i}getType(){return String(this.type)}withStyle(t){return new P(this.name,t,this.size)}bold(t=this.size){return new P(this.name,B.BOLD,t)}italic(t=this.size){return new P(this.name,B.ITALIC,t)}regular(t=this.size){return new P(this.name,B.NORMAL,t)}withSize(t){return new P(this.name,t,this.size)}withConfig(t,e=this.size){return new P(this.name,t,e)}toString(){return`${this.getType()} ${this.size}px ${this.name}`}}Object.defineProperty(P,"TIMES",{get:()=>new P("Times"),set:void 0}),Object.defineProperty(P,"TIMES_ROMAN",{get:()=>new P("TimesRoman"),set:void 0}),Object.defineProperty(P,"HELVETICA",{get:()=>new P("Helvetica"),set:void 0}),Object.defineProperty(P,"ARIAL",{get:()=>new P("Arial"),set:void 0}),Object.defineProperty(P,"SANS",{get:()=>new P("Sans"),set:void 0}),Object.defineProperty(P,"SERIF",{get:()=>new P("Serif"),set:void 0}),Object.defineProperty(P,"SANSERIF",{get:()=>new P("Sans-Serif"),set:void 0});let O=new TextDecoder("utf-8"),Y=new TextEncoder("utf-8");class D{constructor(t=new Uint8Array(100)){this.buffer=t,this.offset=0}putByte(t){this.buffer[this.offset++]=t}putInt(t){this.buffer[this.offset++]=t>>24&255,this.buffer[this.offset++]=t>>16&255,this.buffer[this.offset++]=t>>8&255,this.buffer[this.offset++]=255&t}putLong(t){this.buffer[this.offset++]=Number(t>>56n&0xFFn),this.buffer[this.offset++]=Number(t>>48n&0xFFn),this.buffer[this.offset++]=Number(t>>40n&0xFFn),this.buffer[this.offset++]=Number(t>>32n&0xFFn),this.buffer[this.offset++]=Number(t>>24n&0xFFn),this.buffer[this.offset++]=Number(t>>16n&0xFFn),this.buffer[this.offset++]=Number(t>>8n&0xFFn),this.buffer[this.offset++]=Number(0xFFn&t)}putString(t){this.putBytes(Y.encode(t)),this.putByte(0)}putBytes(t,e=0,i=t.length){for(let s=e;s<i;s++)this.putByte(t[s])}getUnsignedByte(){return 255&this.buffer[this.offset++]}getUnsignedShort(){return this.getUnsignedByte()<<8|this.getUnsignedByte()}getUnsignedInt(){return this.getUnsignedShort()<<16|this.getUnsignedShort()}getUnsignedLong(){this.getUnsignedInt(),this.getUnsignedInt();return BigInt(this.getUnsignedInt())<<32n&0xFFFFFFn|0xFFFFFFn&BigInt(this.getUnsignedInt())}availableBytes(){return this.buffer?this.buffer.length:0}getString(t=0){if(this.buffer.length-this.offset>t)t=this.buffer.length-this.offset;else if(t<0)return"";let e=O.decode(this.buffer.slice(this.offset,this.offset+t));return this.offset+=t,this.offset>this.buffer.length&&(this.offset=this.buffer.length),e}}let X="0".charCodeAt(0),j="9".charCodeAt(0),R="*".charCodeAt(0),_="\\".charCodeAt(0),N="A".charCodeAt(0),U="Z".charCodeAt(0),H=",".charCodeAt(0),F=".".charCodeAt(0),W="j".charCodeAt(0),V="q".charCodeAt(0),G="'".charCodeAt(0),z="/".charCodeAt(0),Z=" ".charCodeAt(0),q="v".charCodeAt(0),K="x".charCodeAt(0),$="z".charCodeAt(0),J="a".charCodeAt(0),Q=["cook","cook's","cooks","seeks","sheet"],tt=new TextEncoder("utf-8"),et=new TextDecoder("utf-8");class it{constructor(t){st.readFilteredWords(new D(S.loadData("badenc.txt",0,t))),st.readFilteredHosts(new D(S.loadData("hostenc.txt",0,t))),st.readFilteredHashFragments(new D(S.loadData("fragmentsenc.txt",0,t))),st.readFilteredTLDs(new D(S.loadData("tldlist.txt",0,t)))}decode(t){return it.DECODER.decode(t)}encode(t){return it.ENCODER.encode(t)}filter(t){let e=this.encode(t.toLowerCase());st.applyDotSlashFilter(e),st.applyBadwordFilter(e),st.applyHostFilter(e),st.heywhathteufck(e);for(let i=0;i<Q.length;i++)for(let s=-1;-1!==(s=t.indexOf(Q[i],s+1));){let t=Q[i];for(let i=0;i<t.length;i++)e[i+s]=t[i]}return e=this.encode(st.stripLowerCase(t.toLowerCase())),this.decode(e)}normalize(t){let e=new String,i=32;t:for(let s=0;s<t.length;s++){let r=t.charCodeAt(s);if(126===r){if(s<=t.length-5&&t[s+4]===r){console.debug("Processing absoluteX text input position block");let e="";for(let r=s;r<t.length;r++){if(126===t[s+r]){i=32;let t=Number(e)%512;console.debug("new abs pos for text input:"+t),s+=r+1;continue t}e=e.concat(t[r])}r=Z}}else if(64===r)if(s<=t.length-5&&t[s+4]===r){for(let e=s;e<t.length;e++)if(64===t[s+e]){s+=e+1,i=32;continue t}i=32}else r=Z;else 37!==r&&r!==F&&33!==r||(37===r?r=Z:i=32);0!==i&&r>=J&&r<=$&&(r^=i,i=0),e=e.concat(String.fromCharCode(r))}return e}}let st=class{static stripLowerCase(t,e){let i=[];for(let e=0;e<t.length;e++)i[e]!==R&&st.isUpperCase(t[e])&&(i[e]=t[e]);return i}static applyBadwordFilter(t){if(st.badList&&st.badCharIds)for(let e=st.badList.length-1;e>-1;e--)st.badList[e]&&st.badCharIds[e]&&st.apply(t,st.badList[e],st.badCharIds[e])}static applyHostFilter(t){if(st.hostList&&st.hostCharIds)for(let e=st.badList.length-1;e>-1;e--)st.hostList[e]&&st.hostCharIds[e]&&st.apply(t,st.hostList[e],st.hostCharIds[e])}static applyDotSlashFilter(t){let e=t.slice(0);st.apply(e,it.ENCODER.encode("dot"),null);let i=t.slice(0);st.apply(i,it.ENCODER.encode("slash"),null);for(let s of st.tldList)st.applyTldFilter(t,e,i,s.value,s.score)}static applyTldFilter(t,e,i,s,r){if(!(s.length>t.length))for(let n=0;n<=t.length-s.length;n++){let o=n,a=0;for(;o<t.length;){let e=0,i=t[o],r=0;if(o+1<t.length&&(r=t[o+1]),a<s.length&&(e=st.compareLettersNumbers(s[a],i,r))>0)o+=e,a++;else{if(0===a)break;if((e=st.compareLettersNumbers(s[a-1],i,r))>0)o+=e;else{if(a>=s.length||!st.isSpecial(i))break;o++}}}if(a>=s.length){let a=!1,h=st.getAsteriskCount(t,e,n),l=st.getAsteriskCount2(t,i,o-1);if(console.debug(`Potential tld: ${s} at char ${n} (type="${r}, startmatch="${h}, endmatch=${l})`),1===r&&h>0&&l>0&&(a=!0),2===r&&(h>2&&l>0||h>0&&l>2)&&(a=!0),3===r&&h>0&&l>2&&(a=!0),a){console.log(`Filtered tld: ${s} at char ${n}`);let r=n,a=o-1;if(h>2){if(4===h){let t=!1;for(let i=r-1;i>=0;i--)if(t){if(e[i]!==R)break;r=i}else e[i]===R&&(r=i,t=!0)}let i=!1;for(let e=r-1;e>=0;e--)if(i){if(st.isSpecial(t[e]))break;r=e}else st.isSpecial(t[e])||(i=!0,r=e)}if(l>2){if(4===l){let e=!1;for(let s=a+1;s<t.length;s++)if(e){if(i[s]!==R)break;a=s}else i[s]===R&&(a=s,e=!0)}let e=!1;for(let i=a+1;i<t.length;i++)if(e){if(st.isSpecial(t[i]))break;a=i}else st.isSpecial(t[i])||(e=!0,a=i)}for(let e=r;e<=a;e++)t[e]=R}}}}static compareLettersSymbols(t,e,i){if(t=String.fromCharCode(t),e=String.fromCharCode(e),i=String.fromCharCode(i),"*"===t)return 0;if(t===e)return 1;if(t>="a"&&t<="z"){if("e"===t)return"3"===e?1:0;if("t"===t)return"7"===e?1:0;if("a"===t)return"4"===e||"@"===e?1:0;if("o"===t)return"0"===e||"*"===e?1:"("===e&&")"===i?2:0;if("i"===t)return"y"===e||"l"===e||"j"===e||"l"===e||"!"===e||":"===e||";"===e?1:0;if("n"===t)return 0;if("s"===t)return"5"===e||"z"===e||"$"===e?1:0;if("r"===t)return 0;if("h"===t)return 0;if("l"===t)return"1"===e?1:0;if("d"===t)return 0;if("c"===t)return"("===e?1:0;if("u"===t)return"v"===e?1:0;if("m"===t)return 0;if("f"===t)return"p"===e&&"h"===i?2:0;if("p"===t)return 0;if("g"===t)return"9"===e||"6"===e?1:0;if("w"===t)return"v"===e&&"v"===i?2:0;if("y"===t)return 0;if("b"===t)return"1"===e&&"3"===i?2:0;if("v"===t)return 0;if("k"===t)return 0;if("x"===t)return")"===e&&"("===i?2:0;if("j"===t)return 0;if("q"===t)return 0;if("z"===t)return 0}if(t>="0"&&t<="9"){if("0"===t)return"o"===e||"O"===e?1:"("===e&&")"===i?2:0;if("1"===t)return"l"!==e?0:1;if("2"===t)return 0;if("3"===t)return 0;if("4"===t)return 0;if("5"===t)return 0;if("6"===t)return 0;if("7"===t)return 0;if("8"===t)return 0;if("9"===t)return 0}return"-"===t?0:","===t?"."===e?1:0:"."===t?","===e?1:0:"("===t||")"===t?0:"!"===t?"i"===e?1:0:("'"===t||console.log(`Letter=${t} not matched`),0)}static getAsteriskCount(t,e,i){if(0===i)return 2;for(let e=i-1;e>=0&&st.isSpecial(t[e]);e--)if(t[e]===H||t[e]===F)return 3;let s=0;for(let t=i-1;t>=0&&st.isSpecial(e[t]);t--)e[t]===R&&s++;return s>=3?4:st.isSpecial(t[i-1])?1:0}static getAsteriskCount2(t,e,i){if(i+1===t.length)return 2;for(let e=i+1;e<t.length&&st.isSpecial(t[e]);e++)if(t[e]===_||t[e]===z)return 3;let s=0;for(let r=i+1;r<t.length&&st.isSpecial(e[r]);r++)e[r]===R&&s++;return s>=5?4:st.isSpecial(t[i+1])?1:0}static apply(t,e,i){if(!(e.length>t.length))for(let s=0;s<=t.length-e.length;s++){let r=s,n=0,o=!1;for(;r<t.length;){let i=0,s=t[r],a=0;if(r+1<t.length&&(a=t[r+1]),n<e.length&&(i=st.compareLettersSymbols(e[n],s,a))>0)r+=i,n++;else{if(0===n)break;if((i=st.compareLettersSymbols(e[n-1],s,a))>0)r+=i;else{if(n>=e.length||!st.isNotLowerCase(s))break;st.isSpecial(s)&&s!==G&&(o=!0),r++}}}if(n>=e.length){let n=!0;if(console.log(`Potential word: ${e} at char ${s}`),o){let e=!1,i=!1;if((s-1<0||st.isSpecial(t[s-1])&&t[s-1]!==G)&&(e=!0),(r>=t.length||st.isSpecial(t[r])&&t[r]!==G)&&(i=!0),!e||!i){let i=!1,o=s-2;for(e&&(o=s);!i&&o<r;o++)if(o>=0&&(!st.isSpecial(t[o])||t[o]===G)){let e,s=new Uint16Array(3);for(e=0;e<3&&!(o+e>=t.length||st.isSpecial(t[o+e])&&t[o+e]!==G);e++)s[e]=t[o+e];let r=!0;0===e&&(r=!1),e<3&&o-1>=0&&(!st.isSpecial(t[o-1])||t[o-1]===G)&&(r=!1),r&&!st.containsFragmentHashes(s)&&(i=!0)}i||(n=!1)}}else{let e=Z;s-1>=0&&(e=t[s-1]);let o=Z;r<t.length&&(o=t[r]);let a=getCharId(e),h=getCharId(o);i&&st.compareCharIds(i,a,h)&&(n=!1)}if(n){console.log(`Filtered word: ${e} at char ${s}`);for(let e=s;e<r;e++)t[e]=R}}}}static getCharId(t){return t>=J&&t<=$?t-J+1:t===G?28:t>=X&&t<=j?t-X+29:27}static heywhathteufck(t){let e=0,i=0,s=0,r=0;for(;-1!=(e=st.indexOfDigit(t,i));){let n=!1;for(let s=i;s>=0&&s<e&&!n;s++)st.isSpecial(t[s])||st.isNotLowerCase(t[s])||(n=!0);n&&(s=0),0===s&&(r=e),i=st.indexOfNonDigit(t,e);let o=0;for(let s=e;s<i;s++)o=10*o+t[s]-48;if(o>255||i-e>8?s=0:s++,4===s){for(let e=r;e<i;e++)t[e]=R;s=0}}}static indexOfDigit(t,e){for(let i=e;i<t.length&&i>=0;i++)if(t[i]>=X&&t[i]<=j)return i;return-1}static indexOfNonDigit(t,e){for(let i=e;i<t.length&&i>=0;i++)if(t[i]<X&&t[i]>j)return i;return-1}static containsFragmentHashes(t){let e=!0;for(let i=0;i<t.length;i++)isDigit(t[i])||0===t[i]||(e=!1);if(e)return!0;let i=wordToHash(t),s=0,r=hashFragments.length-1;if(i===hashFragments[s]||i===hashFragments[r])return!0;for(;s!==r&&s+1!=r;){let t=(s+r)/2|0;if(i===hashFragments[t])return!0;i<hashFragments[t]?r=t:s=t}return!1}static isSpecial(t){return!isLetter(t)&&!isDigit(t)}static wordToHash(t){if(t.length>6)return 0;let e=0;for(let i=0;i<t.length;i++){let s=t[t.length-i-1];if(s>=J&&s<=$)e=38*e+s-97+1|0;else if(s===G)e=38*e+27|0;else if(s>=X&&s<=j)e=38*e+s-48+28|0;else if(0!==s)return console.debug("wordToHash failed on "+it.DECODER.decode(t)),0}return e}static readFilteredTLDs(t){if(!(t.availableBytes()<5))for(let e=0;e<t.getUnsignedInt();e++){const e=t.getUnsignedByte();if(t.availableBytes()<1)return;let i=t.getString(t.getUnsignedByte());i&&st.tldList.push({score:e,value:i})}}static readFilteredWords(t){let e=t.getUnsignedInt();st.unmarshal(t,e,st.badList,st.badCharIds)}static readFilteredHashFragments(t){for(let e=0;e<t.getUnsignedInt();e++)st.hashFragments[e]=t.getUnsignedShort()}static readFilteredHosts(t){let e=t.getUnsignedInt();st.unmarshal(t,e,st.hostList,st.hostCharIds)}static compareCharIds(t,e,i){let s=0;if(t[s][0]===e&&t[s][1]===i)return!0;let r=t.length-1;if(t[r][0]===e&&t[r][1]===i)return!0;for(;s!==r&&s+1!==r;){let n=(s+r)/2|0;if(t[n][0]===e&&t[n][1]===i)return!0;e<t[n][0]||e===t[n][0]&&i<t[n][1]?r=n:s=n}return!1}static unmarshal(t,e,i,s){for(let r=0;r<e;r++){let e=t.getUnsignedByte();if(t.availableBytes()<e)break;i.push(t.getString(e));let r=t.getUnsignedInt();if(t.availableBytes()<2*r)break;for(let e=0;e<r;e++)s.push([t.getUnsignedByte(),t.getUnsignedByte()])}}static readBuffer(t,e,i){let s=new Array(e);for(let e=0;e<s.length;e++){let r=t.getUnsignedByte();if(t.availableBytes()<r)return null;if(s[e]=t.getString(r),i=new Array(t.getUnsignedInt()),t.availableBytes()<2*i.length)return null;for(let e=0;e<i.length;e++)i[e]=[t.getUnsignedByte(),t.getUnsignedByte()]}}static isNumeral(t){return t>=X&&t<=j}static isLatin(t){return t>=J&&C<=$||t>=N&&t<=U}static isNotLowerCase(t){return t<J||t>$||(t===q||t===K||t===W||t===V||t===$)}static isLetter(t){return t>=J&&t<=$||t>=N&&t<=U}static isDigit(t){return t>=X&&t<=j}static isLowerCase(t){return t>=J&&t<=$}static isUpperCase(t){return t>=N&&t<=U}};Object.defineProperty(it,"ENCODER",{get:()=>tt,set:void 0}),Object.defineProperty(it,"DECODER",{get:()=>et,set:void 0}),Object.defineProperty(st,"tldList",{get:()=>st._tldList||[],set:t=>{st._tldList=t}}),Object.defineProperty(st,"badList",{get:()=>st._badList||[],set:t=>{st._badList=t}}),Object.defineProperty(st,"hostList",{get:()=>st._hostList||[],set:t=>{st._hostList=t}}),Object.defineProperty(st,"hostCharIds",{get:()=>st._hostCharIds||[],set:t=>{st._hostCharIds=t}}),Object.defineProperty(st,"badCharIds",{get:()=>st._badCharIds||[],set:t=>{st._badCharIds=t}}),Object.defineProperty(st,"hashFragments",{get:()=>st._hashFragments||[],set:t=>{st._hashFragments=t}});class rt extends Error{constructor(t=Error("Problem occurred:N/A"),e=!1){if(super(),t&&t.message){if(console.error(t.message,t.stack),e)throw console.error("Fatal error encountered!"),this}else console.error("A problem was encountered during game loop:",t.toString())}}Object.setPrototypeOf?Object.setPrototypeOf(rt.prototype,Error):rt.__prototype=Error.prototype;class nt{constructor(t=50){this.tickCount=0,this.tickThreshold=t}async tick(t){if(-1!==this.tickThreshold&&++this.tickCount>=this.tickThreshold){this.tickCount=0;try{return await t()}catch(t){return void console.error(t)}}}disable(){this.tickThreshold=-1}}Object.defineProperty(nt,"fromSeconds",{value:t=>new nt(50*t)});class ot{constructor(){this.serverIndex=0,this.appearanceTicket=0,this.waypointsX=new Uint32Array(10),this.waypointsY=new Uint32Array(10),this.equippedItem=new Uint32Array(12),this.currentX=0,this.currentY=0,this.level=-1,this.typeID=0,this.stepCount=0,this.animationCurrent=0,this.animationNext=0,this.waypointCurrent=0,this.targetWaypoint=0,this.message=void 0,this.bubble=void 0,this.messageTimeout=0,this.damageTaken=0,this.healthCurrent=0,this.healthMax=0,this.healthTimer=new nt(-1),this.level=0,this.colourHair=0,this.colourTop=0,this.colourBottom=0,this.colourSkin=0,this.incomingProjectileSprite=0,this.attackingPlayerServerIndex=0,this.attackingNpcServerIndex=0,this.projectileRange=0,this.skullVisible=0}isFighting(){return 9===this.animationCurrent||8===this.animationCurrent}isRecentlyHurt(){return this.healthTimer.tickThreshold>0}waypoint(t){return[this.waypointsX[t],this.waypointsY[t]]}longestDelta(t,e){return Math.max(Math.abs(this.currentX-t),Math.abs(this.currentY-e))}at(t){return this.currentX===t[0]&&this.currentY===t[1]}traversePath(){let t=(this.waypointCurrent+1)%10,e=this.targetWaypoint;if(e===t)return void(this.animationCurrent=this.animationNext);let i=t-e;i<1&&(i+=10);let s=4*Math.max(1,i-1),r=this.currentX-this.waypointsX[e],n=this.currentY-this.waypointsY[e];if(Math.abs(r)>1152||Math.abs(n)>1152||i>8)return this.currentX=this.waypointsX[e],this.currentY=this.waypointsY[e],void(this.targetWaypoint=(e+1)%10);let o=-1;0!==r&&(this.stepCount++,r>0?(this.currentX-=s,o=6):r<0&&(this.currentX+=s,o=2),Math.abs(this.currentX-this.waypointsX[e])<s&&(this.currentX=this.waypointsX[e])),0!==n&&(this.stepCount++,n>0?(this.currentY-=s,o=r>0?7:r<0?1:0):n<0&&(this.currentY+=s,o=r>0?5:r<0?3:4),Math.abs(this.currentY-this.waypointsY[e])<s&&(this.currentY=this.waypointsY[e])),-1!==o&&(this.animationCurrent=o),this.currentX===this.waypointsX[e]&&this.currentY===this.waypointsY[e]&&(this.targetWaypoint=(e+1)%10)}get name(){return this._name?this._name:this.hash>0?S.hashToUsername(this._hash):"null"}set name(t){t?t.length>12?this._name=t.slice(0,12):this._name=t:this._name=void 0}get hash(){return!this._hash&&this._name?S.usernameToHash(this._name):0n}set hash(t){this._hash=t,this._name=S.hashToUsername(t)}}class at{constructor(t){this.canvas=t,this.ctx=t.getContext("2d")}setColor(t){this.ctx.fillStyle=t.toCanvasStyle(),this.ctx.strokeStyle=t.toCanvasStyle()}fillRect(t,e,i,s){this.ctx.fillRect(t,e,i,s)}drawRect(t,e,i,s){this.ctx.strokeRect(t,e,i,s)}setFont(t){this.ctx.font=String(t)}drawString(t,e,i){this.ctx.fillText(t,e,i)}measureTextWidth(t){return this.ctx.measureText(t).width}drawImage(t,e,i){this.ctx.putImageData(t,e,i)}getImage(t,e){return this.ctx.getImageData(0,0,t,e)}}var ht=n(7),lt=n.n(ht);const ut="0".charCodeAt(0),ct="9".charCodeAt(0);class dt{constructor(t,e,i,s){this.image=void 0,this.landscapeColours=void 0,this.anIntArray340=void 0,this.anIntArray341=void 0,this.anIntArray342=void 0,this.anIntArray343=void 0,this.anIntArray344=void 0,this.anIntArray345=void 0,this.boundsTopY=0,this.boundsTopX=0,this.interlace=!1,this.worldVisible=!1,this.boundsBottomY=e,this.boundsBottomX=t,this.width1=this.width2=t,this.height1=this.height2=e,this.area=t*e,this.pixels=new Int32Array(t*e),this.surfacePixels=new Array(i),this.spriteColoursUsed=new Array(i),this.spritePalettes=new Array(i),this.spriteTranslate=new Int8Array(i),this.spriteWidth=new Int32Array(i),this.spriteHeight=new Int32Array(i),this.spriteWidthFull=new Int32Array(i),this.spriteHeightFull=new Int32Array(i),this.spriteTranslateX=new Int32Array(i),this.spriteTranslateY=new Int32Array(i),this.imageData=s._graphics.ctx.getImageData(0,0,t,e),this.bufferedPixels=new Int32Array(t*e),this.pixelBytes=new Uint8ClampedArray(this.bufferedPixels.buffer),this.setComplete()}static rgbToLong(t,e,i){return new E(t,e,i,0).toRGB()}static createFont(t,e){dt.gameFonts[e]=t}setComplete(){for(let e=0;e<this.area;e+=1)this.bufferedPixels[e]=255<<24|(255&(t=this.pixels[e]))<<16|(t>>8&255)<<8|t>>16&255;var t;this.imageData.data.set(this.pixelBytes,0)}setBounds(t,e,i,s){t<0&&(t=0),e<0&&(e=0),i>this.width2&&(i=this.width2),s>this.height2&&(s=this.height2),this.boundsTopX=t,this.boundsTopY=e,this.boundsBottomX=i,this.boundsBottomY=s}resetBounds(){this.boundsTopX=0,this.boundsTopY=0,this.boundsBottomX=this.width2,this.boundsBottomY=this.height2}draw(t,e,i){this.setComplete(),t.drawImage(this.imageData,e,i)}blackScreen(){let t=0;if(!this.interlace)for(let t=0;t<this.height2*this.width2;t++)this.pixels[t]=0;for(let e=0;e<this.height2;e+=2){for(let e=0;e<this.width2;e++)this.pixels[t++]=0;t+=this.width2}}drawCircle(t,e,i,s,r){let n=256-r,o=(s>>16&255)*r,a=(s>>8&255)*r,h=(255&s)*r,l=e-i;l<0&&(l=0);let u=e+i;u>=this.height2&&(u=this.height2-1);let c=1;this.interlace&&(c=2,0!=(1&l)&&l++);for(let s=l;s<=u;s+=c){let r=s-e,l=0|Math.sqrt(i*i-r*r),u=t-l;u<0&&(u=0);let c=t+l;c>=this.width2&&(c=this.width2-1);let d=u+s*this.width2;for(let t=u;t<=c;t++){let t=(this.pixels[d]>>16&255)*n,e=(this.pixels[d]>>8&255)*n,i=(255&this.pixels[d])*n;this.pixels[d++]=o+t>>8<<16|a+e>>8<<8|h+i>>8}}}drawBoxAlpha(t,e,i,s,r,n){t<this.boundsTopX&&(i-=this.boundsTopX-t,t=this.boundsTopX),e<this.boundsTopY&&(s-=this.boundsTopY-e,e=this.boundsTopY),t+i>this.boundsBottomX&&(i=this.boundsBottomX-t),e+s>this.boundsBottomY&&(s=this.boundsBottomY-e);let o=256-n,a=(r>>16&255)*n,h=(r>>8&255)*n,l=(255&r)*n,u=this.width2-i,c=1;this.interlace&&(c=2,u+=this.width2,0!=(1&e)&&(e++,s--));for(let r=t;r<t+i;r++)for(let t=e;t<e+s;t+=c){let e=t*this.width2+r,i=(this.pixels[e]>>16&255)*o,s=(this.pixels[e]>>8&255)*o,n=(255&this.pixels[e])*o;this.pixels[e]=a+i>>8<<16|h+s>>8<<8|l+n>>8}}drawGradient(t,e,i,s,r,n){t<this.boundsTopX&&(i-=this.boundsTopX-t,t=this.boundsTopX),t+i>this.boundsBottomX&&(i=this.boundsBottomX-t);let o=n>>16&255,a=n>>8&255,h=255&n,l=r>>16&255,u=r>>8&255,c=255&r,d=this.width2-i,m=1;this.interlace&&(m=2,d+=this.width2,0!=(1&e)&&(e++,s--));let p=t+e*this.width2;for(let t=0;t<s;t+=m)if(t+e>=this.boundsTopY&&t+e<this.boundsBottomY){let e=(o*t+l*(s-t))/s<<16|(a*t+u*(s-t))/s<<8|(h*t+c*(s-t))/s|0;for(let t=-i;t<0;t++)this.pixels[p++]=e;p+=d}else p+=this.width2}drawBox(t,e,i,s,r){t<this.boundsTopX&&(i-=this.boundsTopX-t,t=this.boundsTopX),e<this.boundsTopY&&(s-=this.boundsTopY-e,e=this.boundsTopY),t+i>this.boundsBottomX&&(i=this.boundsBottomX-t),e+s>this.boundsBottomY&&(s=this.boundsBottomY-e);let n=this.width2-i,o=1;this.interlace&&(o=2,n+=this.width2,0!=(1&e)&&(e++,s--));let a=t+e*this.width2;for(let t=-s;t<0;t+=o){for(let t=-i;t<0;t++)this.pixels[a++]=r;a+=n}}drawBoxEdge(t,e,i,s,r){this.drawLineHoriz(t,e,i,r),this.drawLineHoriz(t,e+s-1,i,r),this.drawLineVert(t,e,s,r),this.drawLineVert(t+i-1,e,s,r)}drawLineHoriz(t,e,i,s){if(e<this.boundsTopY||e>=this.boundsBottomY)return;t<this.boundsTopX&&(i-=this.boundsTopX-t,t=this.boundsTopX),t+i>this.boundsBottomX&&(i=this.boundsBottomX-t);let r=t+e*this.width2;for(let t=0;t<i;t++)this.pixels[r+t]=s}drawLineVert(t,e,i,s){if(t<this.boundsTopX||t>=this.boundsBottomX)return;e<this.boundsTopY&&(i-=this.boundsTopY-e,e=this.boundsTopY),e+i>this.boundsBottomX&&(i=this.boundsBottomY-e);let r=t+e*this.width2;for(let t=0;t<i;t++)this.pixels[r+t*this.width2]=s}setPixel(t,e,i){t<this.boundsTopX||e<this.boundsTopY||t>=this.boundsBottomX||e>=this.boundsBottomY||(this.pixels[t+e*this.width2]=i)}fadeToBlack(){let t=this.width2*this.height2;for(let e=0;e<t;e++){let t=16777215&this.pixels[e];this.pixels[e]=(t>>>1&8355711)+(t>>>2&4144959)+(t>>>3&2039583)+(t>>>4&986895)}}drawLineAlpha(t,e,i,s,r,n){for(let o=i;o<i+r;o++)for(let i=s;i<s+n;i++){let s=0,r=0,n=0,a=0;for(let h=o-t;h<=o+t;h++)if(h>=0&&h<this.width2)for(let t=i-e;t<=i+e;t++)if(t>=0&&t<this.height2){let e=this.pixels[h+this.width2*t];s+=e>>16&255,r+=e>>8&255,n+=255&e,a++}this.pixels[o+this.width2*i]=(s/a<<16)+(r/a<<8)+(n/a|0)}}clear(){for(let t=0;t<this.surfacePixels.length;t++)this.surfacePixels[t]=void 0,this.spriteWidth[t]=0,this.spriteHeight[t]=0,this.spriteColoursUsed[t]=void 0,this.spritePalettes[t]=void 0}parseSprite(t,e,i,s){let r=S.getUnsignedShort(e,0),n=S.getUnsignedShort(i,r);r+=2;let o=S.getUnsignedShort(i,r);r+=2;let a=255&i[r++],h=new Int32Array(a);h[0]=16711935;for(let t=0;t<a-1;t++)h[t+1]=(255&i[r])<<16|(255&i[r+1])<<8|255&i[r+2],r+=3;let l=2;for(let a=t;a<t+s;a++){this.spriteTranslateX[a]=255&i[r++],this.spriteTranslateY[a]=255&i[r++],this.spriteWidth[a]=S.getUnsignedShort(i,r),r+=2,this.spriteHeight[a]=S.getUnsignedShort(i,r),r+=2;let t=255&i[r++],s=this.spriteWidth[a]*this.spriteHeight[a];if(this.spriteColoursUsed[a]=new Int8Array(s),this.spritePalettes[a]=h,this.spriteWidthFull[a]=n,this.spriteHeightFull[a]=o,this.surfacePixels[a]=void 0,this.spriteTranslate[a]=!1,0===this.spriteTranslateX[a]&&0===this.spriteTranslateY[a]||(this.spriteTranslate[a]=!0),0===t)for(let t=0;t<s;t++)this.spriteColoursUsed[a][t]=e[l++],0===this.spriteColoursUsed[a][t]&&(this.spriteTranslate[a]=!0);else if(1===t)for(let t=0;t<this.spriteWidth[a];t++)for(let i=0;i<this.spriteHeight[a];i++)this.spriteColoursUsed[a][t+i*this.spriteWidth[a]]=e[l++],0===this.spriteColoursUsed[a][t+i*this.spriteWidth[a]]&&(this.spriteTranslate[a]=!0)}}readSleepWord(t,e){let i=this.surfacePixels[t]=new Int32Array(10200);this.spriteWidth[t]=255,this.spriteHeight[t]=40,this.spriteTranslateX[t]=0,this.spriteTranslateY[t]=0,this.spriteWidthFull[t]=255,this.spriteHeightFull[t]=40,this.spriteTranslate[t]=!1;let s=0,r=1,n=0;for(n=0;n<255;){let t=255&e[r++];for(let e=0;e<t;e++)i[n++]=s;s=16777215-s}for(let t=1;t<40;t++)for(let t=0;t<255;){let s=255&e[r++];for(let e=0;e<s;e++)i[n]=i[n-255],n++,t++;t<255&&(i[n]=16777215-i[n-255],n++,t++)}}drawWorld(t){let e=this.spriteWidth[t]*this.spriteHeight[t],i=this.surfacePixels[t],s=new Int32Array(32768);for(let t=0;t<e;t++){let e=i[t];s[((16252928&e)>>9)+((63488&e)>>6)+((248&e)>>3)]++}let r=new Int32Array(256);r[0]=16711935;let n=new Int32Array(256);for(let t=0;t<32768;t++){let e=s[t];if(e>n[255])for(let i=1;i<256;i++)if(!(e<=n[i])){for(let t=255;t>i;t--)r[t]=r[t-1],n[t]=n[t-1];r[i]=((31744&t)<<9)+((992&t)<<6)+((31&t)<<3)+263172,n[i]=e;break}s[t]=-1}let o=new Int8Array(e);for(let t=0;t<e;t++){let e=i[t],n=((16252928&e)>>9)+((63488&e)>>6)+((248&e)>>3),a=s[n];if(-1===a){let t=999999999,i=e>>16&255,o=e>>8&255,h=255&e;for(let e=0;e<256;e++){let s=r[e],n=s>>16&255,l=s>>8&255,u=255&s,c=(i-n)*(i-n)+(o-l)*(o-l)+(h-u)*(h-u);c<t&&(t=c,a=e)}s[n]=a}o[t]=255&a}this.spriteColoursUsed[t]=o,this.spritePalettes[t]=r,this.surfacePixels[t]=void 0}loadSprite(t){if(!this.spriteColoursUsed[t])return;let e=this.spriteWidth[t]*this.spriteHeight[t],i=this.spriteColoursUsed[t],s=this.spritePalettes[t],r=new Int32Array(e);for(let t=0;t<e;t++){let e=s[255&i[t]];0===e?e=1:16711935===e&&(e=0),r[t]=e}this.surfacePixels[t]=r,this.spriteColoursUsed[t]=void 0,this.spritePalettes[t]=void 0}drawSpriteMinimap(t,e,i,s,r){this.spriteWidth[t]=s,this.spriteHeight[t]=r,this.spriteTranslate[t]=!1,this.spriteTranslateX[t]=0,this.spriteTranslateY[t]=0,this.spriteWidthFull[t]=s,this.spriteHeightFull[t]=r;let n=s*r,o=0;this.surfacePixels[t]=new Int32Array(n);for(let n=e;n<e+s;n++)for(let e=i;e<i+r;e++)this.surfacePixels[t][o++]=this.pixels[n+e*this.width2]}_drawSprite_from5(t,e,i,s,r){this.spriteWidth[t]=s,this.spriteHeight[t]=r,this.spriteTranslate[t]=!1,this.spriteTranslateX[t]=0,this.spriteTranslateY[t]=0,this.spriteWidthFull[t]=s,this.spriteHeightFull[t]=r;let n=s*r,o=0;this.surfacePixels[t]=new Int32Array(n);for(let n=i;n<i+r;n++)for(let i=e;i<e+s;i++)this.surfacePixels[t][o++]=this.pixels[i+n*this.width2]}drawSpriteID(t,e,i){this.spriteTranslate[i]&&(t+=this.spriteTranslateX[i],e+=this.spriteTranslateY[i]);let s=t+e*this.width2,r=0,n=this.spriteHeight[i],o=this.spriteWidth[i],a=this.width2-o,h=0;if(e<this.boundsTopY){let t=this.boundsTopY-e;n-=t,e=this.boundsTopY,r+=t*o,s+=t*this.width2}if(e+n>=this.boundsBottomY&&(n-=e+n-this.boundsBottomY+1),t<this.boundsTopX){let e=this.boundsTopX-t;o-=e,t=this.boundsTopX,r+=e,s+=e,h+=e,a+=e}if(t+o>=this.boundsBottomX){let e=t+o-this.boundsBottomX+1;o-=e,h+=e,a+=e}if(o<=0||n<=0)return;let l=1;return this.interlace&&(l=2,a+=this.width2,h+=this.spriteWidth[i],0!=(1&e)&&(s+=this.width2,n--)),this.surfacePixels[i]?void this._drawSprite_from10(this.pixels,this.surfacePixels[i],0,r,s,o,n,a,h,l):void this._drawSprite_from10A(this.pixels,this.spriteColoursUsed[i],this.spritePalettes[i],r,s,o,n,a,h,l)}_spriteClipping_from5(t,e,i,s,r){try{let n=this.spriteWidth[r],o=this.spriteHeight[r],a=0,h=0,l=(n<<16)/i|0,u=(o<<16)/s|0;if(this.spriteTranslate[r]){let n=this.spriteWidthFull[r],o=this.spriteHeightFull[r];l=(n<<16)/i|0,u=(o<<16)/s|0,t+=(this.spriteTranslateX[r]*i+n-1)/n|0,e+=(this.spriteTranslateY[r]*s+o-1)/o|0,this.spriteTranslateX[r]*i%n!=0&&(a=(n-this.spriteTranslateX[r]*i%n<<16)/i|0),this.spriteTranslateY[r]*s%o!=0&&(h=(o-this.spriteTranslateY[r]*s%o<<16)/s|0),i=i*(this.spriteWidth[r]-(a>>16))/n|0,s=s*(this.spriteHeight[r]-(h>>16))/o|0}let c=t+e*this.width2,d=this.width2-i;if(e<this.boundsTopY){let t=this.boundsTopY-e;s-=t,e=0,c+=t*this.width2,h+=u*t}if(e+s>=this.boundsBottomY&&(s-=e+s-this.boundsBottomY+1),t<this.boundsTopX){let e=this.boundsTopX-t;i-=e,t=0,c+=e,a+=l*e,d+=e}if(t+i>=this.boundsBottomX){let e=t+i-this.boundsBottomX+1;i-=e,d+=e}let m=1;this.interlace&&(m=2,d+=this.width2,u+=u,0!=(1&e)&&(c+=this.width2,s--)),this._plotScale_from13(this.pixels,this.surfacePixels[r],0,a,h,c,d,i,s,l,u,n,m)}catch(t){console.log("error in sprite clipping routine")}}fadeThenDrawSpriteID(t,e,i,s){this.spriteTranslate[i]&&(t+=this.spriteTranslateX[i],e+=this.spriteTranslateY[i]);let r=t+e*this.width2,n=0,o=this.spriteHeight[i],a=this.spriteWidth[i],h=this.width2-a,l=0;if(e<this.boundsTopY){let t=this.boundsTopY-e;o-=t,e=this.boundsTopY,n+=t*a,r+=t*this.width2}if(e+o>=this.boundsBottomY&&(o-=e+o-this.boundsBottomY+1),t<this.boundsTopX){let e=this.boundsTopX-t;a-=e,t=this.boundsTopX,n+=e,r+=e,l+=e,h+=e}if(t+a>=this.boundsBottomX){let e=t+a-this.boundsBottomX+1;a-=e,l+=e,h+=e}if(a<=0||o<=0)return;let u=1;return this.interlace&&(u=2,h+=this.width2,l+=this.spriteWidth[i],0!=(1&e)&&(r+=this.width2,o--)),this.surfacePixels[i]?void this._drawSpriteAlpha_from11(this.pixels,this.surfacePixels[i],0,n,r,a,o,h,l,u,s):void this._drawSpriteAlpha_from11A(this.pixels,this.spriteColoursUsed[i],this.spritePalettes[i],n,r,a,o,h,l,u,s)}drawActionBubble(t,e,i,s,r,n){try{let o=this.spriteWidth[r],a=this.spriteHeight[r],h=0,l=0,u=(o<<16)/i|0,c=(a<<16)/s|0;if(this.spriteTranslate[r]){let n=this.spriteWidthFull[r],o=this.spriteHeightFull[r];u=(n<<16)/i|0,c=(o<<16)/s|0,t+=(this.spriteTranslateX[r]*i+n-1)/n|0,e+=(this.spriteTranslateY[r]*s+o-1)/o|0,this.spriteTranslateX[r]*i%n!=0&&(h=(n-this.spriteTranslateX[r]*i%n<<16)/i|0),this.spriteTranslateY[r]*s%o!=0&&(l=(o-this.spriteTranslateY[r]*s%o<<16)/s|0),i=i*(this.spriteWidth[r]-(h>>16))/n|0,s=s*(this.spriteHeight[r]-(l>>16))/o|0}let d=t+e*this.width2,m=this.width2-i;if(e<this.boundsTopY){let t=this.boundsTopY-e;s-=t,e=0,d+=t*this.width2,l+=c*t}if(e+s>=this.boundsBottomY&&(s-=e+s-this.boundsBottomY+1),t<this.boundsTopX){let e=this.boundsTopX-t;i-=e,t=0,d+=e,h+=u*e,m+=e}if(t+i>=this.boundsBottomX){let e=t+i-this.boundsBottomX+1;i-=e,m+=e}let p=1;return this.interlace&&(p=2,m+=this.width2,c+=c,0!=(1&e)&&(d+=this.width2,s--)),void this.transparentScale(this.pixels,this.surfacePixels[r],0,h,l,d,m,i,s,u,c,o,p,n)}catch(t){console.log("error in sprite clipping routine")}}_spriteClipping_from6(t,e,i,s,r,n){try{let o=this.spriteWidth[r],a=this.spriteHeight[r],h=0,l=0,u=(o<<16)/i|0,c=(a<<16)/s|0;if(this.spriteTranslate[r]){let n=this.spriteWidthFull[r],o=this.spriteHeightFull[r];u=(n<<16)/i|0,c=(o<<16)/s|0,t+=(this.spriteTranslateX[r]*i+n-1)/n|0,e+=(this.spriteTranslateY[r]*s+o-1)/o|0,this.spriteTranslateX[r]*i%n!=0&&(h=(n-this.spriteTranslateX[r]*i%n<<16)/i|0),this.spriteTranslateY[r]*s%o!=0&&(l=(o-this.spriteTranslateY[r]*s%o<<16)/s|0),i=i*(this.spriteWidth[r]-(h>>16))/n|0,s=s*(this.spriteHeight[r]-(l>>16))/o|0}let d=t+e*this.width2,m=this.width2-i;if(e<this.boundsTopY){let t=this.boundsTopY-e;s-=t,e=0,d+=t*this.width2,l+=c*t}if(e+s>=this.boundsBottomY&&(s-=e+s-this.boundsBottomY+1),t<this.boundsTopX){let e=this.boundsTopX-t;i-=e,t=0,d+=e,h+=u*e,m+=e}if(t+i>=this.boundsBottomX){let e=t+i-this.boundsBottomX+1;i-=e,m+=e}let p=1;return this.interlace&&(p=2,m+=this.width2,c+=c,0!=(1&e)&&(d+=this.width2,s--)),void this._plotScale_from14(this.pixels,this.surfacePixels[r],0,h,l,d,m,i,s,u,c,o,p,n)}catch(t){console.log("error in sprite clipping routine"),console.error(t)}}_drawSprite_from10(t,e,i,s,r,n,o,a,h,l){let u=-(n>>2);n=-(3&n);for(let c=-o;c<0;c+=l){for(let n=u;n<0;n++)0!==(i=e[s++])?t[r++]=i:r++,0!==(i=e[s++])?t[r++]=i:r++,0!==(i=e[s++])?t[r++]=i:r++,0!==(i=e[s++])?t[r++]=i:r++;for(let o=n;o<0;o++)0!==(i=e[s++])?t[r++]=i:r++;r+=a,s+=h}}_drawSprite_from10A(t,e,i,s,r,n,o,a,h,l){let u=-(n>>2);n=-(3&n);for(let c=-o;c<0;c+=l){for(let n=u;n<0;n++){let n=e[s++];0!==n?t[r++]=i[255&n]:r++,n=e[s++],0!==n?t[r++]=i[255&n]:r++,n=e[s++],0!==n?t[r++]=i[255&n]:r++,n=e[s++],0!==n?t[r++]=i[255&n]:r++}for(let o=n;o<0;o++){let n=e[s++];0!==n?t[r++]=i[255&n]:r++}r+=a,s+=h}}_plotScale_from13(t,e,i,s,r,n,o,a,h,l,u,c,d){try{let m=s;for(let p=-h;p<0;p+=d){let h=(r>>16)*c;for(let r=-a;r<0;r++)0!==(i=e[(s>>16)+h])?t[n++]=i:n++,s+=l;r+=u,s=m,n+=o}return}catch(t){console.log("error in plotScale")}}_drawSpriteAlpha_from11(t,e,i,s,r,n,o,a,h,l,u){let c=256-u;for(let d=-o;d<0;d+=l){for(let o=-n;o<0;o++)if(0!==(i=e[s++])){let e=t[r];t[r++]=((16711935&i)*u+(16711935&e)*c&-16711936)+((65280&i)*u+(65280&e)*c&16711680)>>8}else r++;r+=a,s+=h}}_drawSpriteAlpha_from11A(t,e,i,s,r,n,o,a,h,l,u){let c=256-u;for(let d=-o;d<0;d+=l){for(let o=-n;o<0;o++){let n=e[s++];if(0!==n){n=i[255&n];let e=t[r];t[r++]=((16711935&n)*u+(16711935&e)*c&-16711936)+((65280&n)*u+(65280&e)*c&16711680)>>8}else r++}r+=a,s+=h}}transparentScale(t,e,i,s,r,n,o,a,h,l,u,c,d,m){let p=256-m;try{let f=s;for(let g=-h;g<0;g+=d){let h=(r>>16)*c;for(let r=-a;r<0;r++){if(0!==(i=e[(s>>16)+h])){let e=t[n];t[n++]=((16711935&i)*m+(16711935&e)*p&-16711936)+((65280&i)*m+(65280&e)*p&16711680)>>8}else n++;s+=l}r+=u,s=f,n+=o}return}catch(t){console.log("error in tranScale")}}_plotScale_from14(t,e,i,s,r,n,o,a,h,l,u,c,d,m){let p=m>>16&255,f=m>>8&255,g=255&m;try{let m=s;for(let S=-h;S<0;S+=d){let h=(r>>16)*c;for(let r=-a;r<0;r++){if(0!==(i=e[(s>>16)+h])){let e=i>>16&255,s=i>>8&255,r=255&i;t[n++]=e===s&&s===r?(e*p>>8<<16)+(s*f>>8<<8)+(r*g>>8):i}else n++;s+=l}r+=u,s=m,n+=o}return}catch(t){console.log("error in plotScale")}}drawMinimapSprite(t,e,i,s,r){let n=this.width2,o=this.height2;if(!this.landscapeColours){this.landscapeColours=new Int32Array(512);for(let t=0;t<256;t++)this.landscapeColours[t]=32768*Math.sin(.02454369*t)|0,this.landscapeColours[t+256]=32768*Math.cos(.02454369*t)|0}let a=-(this.spriteWidthFull[i]/2|0),h=-(this.spriteHeightFull[i]/2|0);this.spriteTranslate[i]&&(a+=this.spriteTranslateX[i],h+=this.spriteTranslateY[i]);let l=a+this.spriteWidth[i],u=h+this.spriteHeight[i],c=l,d=h,m=a,p=u;s&=255;let f=this.landscapeColours[s]*r,g=this.landscapeColours[s+256]*r,S=t+(h*f+a*g>>22),w=e+(h*g-a*f>>22),y=t+(d*f+c*g>>22),I=e+(d*g-c*f>>22),C=t+(u*f+l*g>>22),b=e+(u*g-l*f>>22),T=t+(p*f+m*g>>22),x=e+(p*g-m*f>>22);192===r&&(63&s)==(63&dt.lastRotation)?dt.anInt346++:128===r?dt.lastRotation=s:dt.anInt347++;let v=w,A=w;I<v?v=I:I>A&&(A=I),b<v?v=b:b>A&&(A=b),x<v?v=x:x>A&&(A=x),v<this.boundsTopY&&(v=this.boundsTopY),A>this.boundsBottomY&&(A=this.boundsBottomY),this.anIntArray340&&this.anIntArray340.length===o+1||(this.anIntArray340=new Int32Array(o+1),this.anIntArray341=new Int32Array(o+1),this.anIntArray342=new Int32Array(o+1),this.anIntArray343=new Int32Array(o+1),this.anIntArray344=new Int32Array(o+1),this.anIntArray345=new Int32Array(o+1));for(let t=v;t<=A;t++)this.anIntArray340[t]=99999999,this.anIntArray341[t]=-99999999;let L=0,M=0,k=0,E=this.spriteWidth[i],B=this.spriteHeight[i];a=0,h=0,c=E-1,d=0,l=E-1,u=B-1,m=0,p=B-1,x!==w&&(L=(T-S<<8)/(x-w)|0,k=(p-h<<8)/(x-w)|0);let P=0,O=0,Y=0,D=0;w>x?(Y=T<<8,D=p<<8,P=x,O=w):(Y=S<<8,D=h<<8,P=w,O=x),P<0&&(Y-=L*P,D-=k*P,P=0),O>o-1&&(O=o-1);for(let t=P;t<=O;t++)this.anIntArray340[t]=this.anIntArray341[t]=Y,Y+=L,this.anIntArray342[t]=this.anIntArray343[t]=0,this.anIntArray344[t]=this.anIntArray345[t]=D,D+=k;I!==w&&(L=(y-S<<8)/(I-w)|0,M=(c-a<<8)/(I-w)|0);let X=0;w>I?(Y=y<<8,X=c<<8,P=I,O=w):(Y=S<<8,X=a<<8,P=w,O=I),P<0&&(Y-=L*P,X-=M*P,P=0),O>o-1&&(O=o-1);for(let t=P;t<=O;t++)Y<this.anIntArray340[t]&&(this.anIntArray340[t]=Y,this.anIntArray342[t]=X,this.anIntArray344[t]=0),Y>this.anIntArray341[t]&&(this.anIntArray341[t]=Y,this.anIntArray343[t]=X,this.anIntArray345[t]=0),Y+=L,X+=M;b!==I&&(L=(C-y<<8)/(b-I)|0,k=(u-d<<8)/(b-I)|0),I>b?(Y=C<<8,X=l<<8,D=u<<8,P=b,O=I):(Y=y<<8,X=c<<8,D=d<<8,P=I,O=b),P<0&&(Y-=L*P,D-=k*P,P=0),O>o-1&&(O=o-1);for(let t=P;t<=O;t++)Y<this.anIntArray340[t]&&(this.anIntArray340[t]=Y,this.anIntArray342[t]=X,this.anIntArray344[t]=D),Y>this.anIntArray341[t]&&(this.anIntArray341[t]=Y,this.anIntArray343[t]=X,this.anIntArray345[t]=D),Y+=L,D+=k;x!==b&&(L=(T-C<<8)/(x-b)|0,M=(m-l<<8)/(x-b)|0),b>x?(Y=T<<8,X=m<<8,D=p<<8,P=x,O=b):(Y=C<<8,X=l<<8,D=u<<8,P=b,O=x),P<0&&(Y-=L*P,X-=M*P,P=0),O>o-1&&(O=o-1);for(let t=P;t<=O;t++)Y<this.anIntArray340[t]&&(this.anIntArray340[t]=Y,this.anIntArray342[t]=X,this.anIntArray344[t]=D),Y>this.anIntArray341[t]&&(this.anIntArray341[t]=Y,this.anIntArray343[t]=X,this.anIntArray345[t]=D),Y+=L,X+=M;let j=v*n,R=this.surfacePixels[i];for(let t=v;t<A;t++){let e=this.anIntArray340[t]>>8,s=this.anIntArray341[t]>>8;if(s-e<=0)j+=n;else{let r=this.anIntArray342[t]<<9,o=((this.anIntArray343[t]<<9)-r)/(s-e)|0,a=this.anIntArray344[t]<<9,h=((this.anIntArray345[t]<<9)-a)/(s-e)|0;e<this.boundsTopX&&(r+=(this.boundsTopX-e)*o,a+=(this.boundsTopX-e)*h,e=this.boundsTopX),s>this.boundsBottomX&&(s=this.boundsBottomX),this.interlace&&0!=(1&t)||(this.spriteTranslate[i]?this.drawMinimapTranslate(this.pixels,R,0,j+e,r,a,o,h,e-s,E):this.drawMinimap(this.pixels,R,0,j+e,r,a,o,h,e-s,E)),j+=n}}}drawMinimap(t,e,i,s,r,n,o,a,h,l){for(i=h;i<0;i++)this.pixels[s++]=e[(r>>17)+(n>>17)*l],r+=o,n+=a}drawMinimapTranslate(t,e,i,s,r,n,o,a,h,l){for(let t=h;t<0;t++)0!==(i=e[(r>>17)+(n>>17)*l])?this.pixels[s++]=i:s++,r+=o,n+=a}_spriteClipping_from7(t,e,i,s,r,n,o){this._spriteClipping_from5(t,e,i,s,r)}_spriteClipping_from9(t,e,i,s,r,n,o,a,h){try{0===n&&(n=16777215),0===o&&(o=16777215);let l=this.spriteWidth[r],u=this.spriteHeight[r],c=0,d=0,m=a<<16,p=(l<<16)/i|0,f=(u<<16)/s|0,g=-((a<<16)/s|0);if(this.spriteTranslate[r]){let n=this.spriteWidthFull[r],o=this.spriteHeightFull[r];p=(n<<16)/i|0,f=(o<<16)/s|0;let a=this.spriteTranslateX[r],l=this.spriteTranslateY[r];h&&(a=n-this.spriteWidth[r]-a),t+=(a*i+n-1)/n|0;let u=(l*s+o-1)/o|0;e+=u,m+=u*g,a*i%n!=0&&(c=(n-a*i%n<<16)/i|0),l*s%o!=0&&(d=(o-l*s%o<<16)/s|0),i=((this.spriteWidth[r]<<16)-c+p-1)/p|0,s=((this.spriteHeight[r]<<16)-d+f-1)/f|0}let S=e*this.width2;if(m+=t<<16,e<this.boundsTopY){let t=this.boundsTopY-e;s-=t,e=this.boundsTopY,S+=t*this.width2,d+=f*t,m+=g*t}e+s>=this.boundsBottomY&&(s-=e+s-this.boundsBottomY+1);let w=S/this.width2&1;return this.interlace||(w=2),16777215===o?this.surfacePixels[r]?h?void this._transparentSpritePlot_from15(this.pixels,this.surfacePixels[r],0,(this.spriteWidth[r]<<16)-c-1,d,S,i,s,-p,f,l,n,m,g,w):void this._transparentSpritePlot_from15(this.pixels,this.surfacePixels[r],0,c,d,S,i,s,p,f,l,n,m,g,w):h?void this._transparentSpritePlot_from16A(this.pixels,this.spriteColoursUsed[r],this.spritePalettes[r],0,(this.spriteWidth[r]<<16)-c-1,d,S,i,s,-p,f,l,n,m,g,w):void this._transparentSpritePlot_from16A(this.pixels,this.spriteColoursUsed[r],this.spritePalettes[r],0,c,d,S,i,s,p,f,l,n,m,g,w):this.surfacePixels[r]?h?void this._transparentSpritePlot_from16(this.pixels,this.surfacePixels[r],0,(this.spriteWidth[r]<<16)-c-1,d,S,i,s,-p,f,l,n,o,m,g,w):void this._transparentSpritePlot_from16(this.pixels,this.surfacePixels[r],0,c,d,S,i,s,p,f,l,n,o,m,g,w):h?void this._transparentSpritePlot_from17(this.pixels,this.spriteColoursUsed[r],this.spritePalettes[r],0,(this.spriteWidth[r]<<16)-c-1,d,S,i,s,-p,f,l,n,o,m,g,w):void this._transparentSpritePlot_from17(this.pixels,this.spriteColoursUsed[r],this.spritePalettes[r],0,c,d,S,i,s,p,f,l,n,o,m,g,w)}catch(t){console.log("error in sprite clipping routine"),console.error(t)}}_transparentSpritePlot_from15(t,e,i,s,r,n,o,a,h,l,u,c,d,m,p){let f=c>>16&255,g=c>>8&255,S=255&c;try{let c=s;for(let w=-a;w<0;w++){let a=(r>>16)*u,w=d>>16,y=o;if(w<this.boundsTopX){let t=this.boundsTopX-w;y-=t,w=this.boundsTopX,s+=h*t}if(w+y>=this.boundsBottomX){y-=w+y-this.boundsBottomX}if(0!==(p=1-p))for(let r=w;r<w+y;r++){if(0!==(i=e[(s>>16)+a])){let e=i>>16&255,s=i>>8&255,o=255&i;t[r+n]=e===s&&s===o?(e*f>>8<<16)+(s*g>>8<<8)+(o*S>>8):i}s+=h}r+=l,s=c,n+=this.width2,d+=m}return}catch(t){console.log("error in transparent sprite plot routine")}}_transparentSpritePlot_from16(t,e,i,s,r,n,o,a,h,l,u,c,d,m,p,f){let g=c>>16&255,S=c>>8&255,w=255&c,y=d>>16&255,I=d>>8&255,C=255&d;try{let c=s;for(let d=-a;d<0;d++){let a=(r>>16)*u,d=m>>16,b=o;if(d<this.boundsTopX){let t=this.boundsTopX-d;b-=t,d=this.boundsTopX,s+=h*t}if(d+b>=this.boundsBottomX){b-=d+b-this.boundsBottomX}if(0!==(f=1-f))for(let r=d;r<d+b;r++){if(0!==(i=e[(s>>16)+a])){let e=i>>16&255,s=i>>8&255,o=255&i;t[r+n]=e===s&&s===o?(e*g>>8<<16)+(s*S>>8<<8)+(o*w>>8):255===e&&s===o?(e*y>>8<<16)+(s*I>>8<<8)+(o*C>>8):i}s+=h}r+=l,s=c,n+=this.width2,m+=p}return}catch(t){console.log("error in transparent sprite plot routine")}}_transparentSpritePlot_from16A(t,e,i,s,r,n,o,a,h,l,u,c,d,m,p,f){let g=d>>16&255,S=d>>8&255,w=255&d;try{let d=r;for(let y=-h;y<0;y++){let h=(n>>16)*c,y=m>>16,I=a;if(y<this.boundsTopX){let t=this.boundsTopX-y;I-=t,y=this.boundsTopX,r+=l*t}if(y+I>=this.boundsBottomX){I-=y+I-this.boundsBottomX}if(0!==(f=1-f))for(let n=y;n<y+I;n++){if(0!==(s=255&e[(r>>16)+h])){let e=(s=i[s])>>16&255,r=s>>8&255,a=255&s;t[n+o]=e===r&&r===a?(e*g>>8<<16)+(r*S>>8<<8)+(a*w>>8):s}r+=l}n+=u,r=d,o+=this.width2,m+=p}return}catch(t){console.log("error in transparent sprite plot routine")}}_transparentSpritePlot_from17(t,e,i,s,r,n,o,a,h,l,u,c,d,m,p,f,g){let S=d>>16&255,w=d>>8&255,y=255&d,I=m>>16&255,C=m>>8&255,b=255&m;try{let d=r;for(let m=-h;m<0;m++){let h=(n>>16)*c,m=p>>16,T=a;if(m<this.boundsTopX){let t=this.boundsTopX-m;T-=t,m=this.boundsTopX,r+=l*t}if(m+T>=this.boundsBottomX){T-=m+T-this.boundsBottomX}if(0!==(g=1-g))for(let n=m;n<m+T;n++){if(0!==(s=255&e[(r>>16)+h])){let e=(s=i[s])>>16&255,r=s>>8&255,a=255&s;t[n+o]=e===r&&r===a?(e*S>>8<<16)+(r*w>>8<<8)+(a*y>>8):255===e&&r===a?(e*I>>8<<16)+(r*C>>8<<8)+(a*b>>8):s}r+=l}n+=u,r=d,o+=this.width2,p+=f}return}catch(t){console.log("error in transparent sprite plot routine")}}drawStringRight(t,e,i,s,r){this.drawString(t,e-this.textWidth(t,s),i,s,r)}drawStringCenter(t,e,i,s,r){this.drawString(t,e-(this.textWidth(t,s)/2|0),i,s,r)}centrepara(t,e,i,s,r,n){try{let o=0,a=dt.gameFonts[s],h=0,l=0;for(let u=0;u<t.length;u++)"@"===t[u]&&u+4<t.length&&"@"===t[u+4]||"~"===t[u]&&u+4<t.length&&"~"===t[u+4]?u+=4:o+=a[dt.characterWidth[t.charCodeAt(u)]+7]," "===t[u]&&(l=u),"%"===t[u]&&(l=u,o=1e3),o>n&&(l<=h&&(l=u),this.drawStringCenter(t.slice(h,l),e,i,s,r),o=0,h=u=l+1,i+=this.textHeight(s));if(o>0)return void this.drawStringCenter(t.slice(h),e,i,s,r)}catch(t){console.error(t)}}drawString(t,e,i,s,r){try{let n=dt.gameFonts[s];for(let s=0;s<t.length;s++)if("@"===t[s]&&s+4<t.length&&"@"===t[s+4])"red"===t.slice(s+1,s+4).toLowerCase()?r=16711680:"lre"===t.slice(s+1,s+4).toLowerCase()?r=16748608:"yel"===t.slice(s+1,s+4).toLowerCase()?r=16776960:"gre"===t.slice(s+1,s+4).toLowerCase()?r=65280:"blu"===t.slice(s+1,s+4).toLowerCase()?r=255:"cya"===t.slice(s+1,s+4).toLowerCase()?r=65535:"mag"===t.slice(s+1,s+4).toLowerCase()?r=16711935:"whi"===t.slice(s+1,s+4).toLowerCase()?r=16777215:"bla"===t.slice(s+1,s+4).toLowerCase()?r=0:"dre"===t.slice(s+1,s+4).toLowerCase()?r=12582912:"ora"===t.slice(s+1,s+4).toLowerCase()?r=16748608:"ran"===t.slice(s+1,s+4).toLowerCase()?r=16777215*Math.random()|0:"or1"===t.slice(s+1,s+4).toLowerCase()?r=16756736:"or2"===t.slice(s+1,s+4).toLowerCase()?r=16740352:"or3"===t.slice(s+1,s+4).toLowerCase()?r=16723968:"gr1"===t.slice(s+1,s+4).toLowerCase()?r=12648192:"gr2"===t.slice(s+1,s+4).toLowerCase()?r=8453888:"gr3"===t.slice(s+1,s+4).toLowerCase()&&(r=4259584),s+=4;else if("~"===t[s]&&s+4<t.length&&"~"===t[s+4]){let i=t.charCodeAt(s+1),r=t.charCodeAt(s+2),n=t.charCodeAt(s+3);i>=ut&&i<=ct&&r>=ut&&r<=ct&&n>=ut&&n<=ct&&(e=0|Number(t.substring(s+1,s+4))),s+=4}else{let o=dt.characterWidth[t.charCodeAt(s)];this.worldVisible&&0!==r&&(this.drawCharacter(o,e+1,i,0,n),this.drawCharacter(o,e,i+1,0,n)),this.drawCharacter(o,e,i,r,n),e+=n[o+7]}return}catch(t){return void console.error(t)}}drawCharacter(t,e,i,s,r){let n=e+r[t+5],o=i-r[t+6],a=r[t+3],h=r[t+4],l=16384*r[t]+128*r[t+1]+r[t+2],u=n+o*this.width2,c=this.width2-a,d=0;if(o<this.boundsTopY){let t=this.boundsTopY-o;h-=t,o=this.boundsTopY,l+=t*a,u+=t*this.width2}if(o+h>=this.boundsBottomY&&(h-=o+h-this.boundsBottomY+1),n<this.boundsTopX){let t=this.boundsTopX-n;a-=t,n=this.boundsTopX,l+=t,u+=t,d+=t,c+=t}if(n+a>=this.boundsBottomX){let t=n+a-this.boundsBottomX+1;a-=t,d+=t,c+=t}a>0&&h>0&&this.plotLetter(this.pixels,r,s,l,u,a,h,c,d)}plotLetter(t,e,i,s,r,n,o,a,h){try{let l=-(n>>2);n=-(3&n);for(let u=-o;u<0;u++){for(let n=l;n<0;n++)0!==e[s++]?t[r++]=i:r++,0!==e[s++]?t[r++]=i:r++,0!==e[s++]?t[r++]=i:r++,0!==e[s++]?t[r++]=i:r++;for(let o=n;o<0;o++)0!==e[s++]?t[r++]=i:r++;r+=a,s+=h}return}catch(t){return void console.error(t)}}method259(t,e,i,s,r,n,o,a,h){for(let l=-o;l<0;l++){for(let o=-n;o<0;o++){let n=255&e[s++];if(n>30)if(n>=230)t[r++]=i;else{let e=t[r];t[r++]=((16711935&i)*n+(16711935&e)*(256-n)&4278255360)+((65280&i)*n+(65280&e)*(256-n)&16711680)>>8}else r++}r+=a,s+=h}}textHeight(t){return 0===t?12:1===t||2===t?14:3===t||4===t?15:5===t?19:6===t?24:7===t?29:this.textHeightFont(t)}textHeightFont(t){return 0===t?dt.gameFonts[t][8]-2:dt.gameFonts[t][8]-1}textWidth(t,e){if(!t||t.length<=0)return;let i=dt.gameFonts[e],s=0;for(let e=0;e<t.length;e++)e<t.length-4&&t[e+4]===t[e]&&("@"===t[e]||"~"===t[e])?e+=5:s+=i[dt.characterWidth[t.charCodeAt(e)]+7];return s}}dt.anInt346=0,dt.anInt347=0,dt.lastRotation=0,dt.gameFonts=new Array(50),dt.characterWidth=new Int32Array(256);for(let t=0;t<256;t++){let e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!\"£$%^&*()-_=+[{]};:'@#~,<.>/?\\| ".indexOf(String.fromCharCode(t));-1!==e?dt.characterWidth[t]=9*e:dt.characterWidth[t]=666}var mt=n(2),pt=n(8);const ft=["Control","Shift","Alt","CapsLock","OS","Delete","Insert","Tab","Unidentified","AudioVolumeMute","AudioVolumeUp","AudioVolumeDown","MediaTrackPrevious","MediaPlay","MediaTrackNext","BrowserSearch","F1","F2","F3","F4","F5","F6","F7","F8","F9","F10","F11","F12"];class gt{constructor(t){this.engineState=v.IDLE,this.welcomeState=k.WELCOME,this.gameState=A.LOGIN,this._canvas=t,this._graphics=new at(this._canvas),this.options={middleClickCamera:!1,mouseWheel:!1,resetCompass:!1,zoomCamera:!1,showRoofs:!1},this.loopData={frameIndex:0,updateFactor:256,lastUpdateFactor:256,sleepDuration:1,lastSleepDuration:1,updateCounter:0,intex:0},this.middleButtonDown=!1,this.mouseScrollDelta=0,this.mouseActionTimeout=0,this.panelLogin={},this.panelGame={},this.controlTextListAll=0,this.mouseX=0,this.mouseY=0,this.mouseButtonDown=0,this._shutdownCounter=0,this.lastMouseButtonDown=0,this.timings=[],this.loadingProgressPercent=0,this.imageLogo=void 0,this.appletWidth=512,this.appletHeight=346,this.targetFrameTime=20,this.hasRefererLogoNotUsed=!1,this.loadingProgessText="Loading",this.showFps=!1,this.debug=!1,this.keyLeft=!1,this.keyRight=!1,this.keyUp=!1,this.keyDown=!1,this.keySpace=!1,this.keyHome=!1,this.keyPgUp=!1,this.keyPgDown=!1,this.maxTickTimeout=1,this.interlace=!1,this.inputTextCurrent="",this.inputTextFinal="",this.inputPmCurrent="",this.inputPmFinal="",this.lastLog=[],this.lastLogIdx=0,this.threadSleep=1}async startApplication(t,e){this.engineState=v.IDLE,this._canvas.width=t,this._canvas.height=e,this.appletWidth=t,this.appletHeight=e,gt.gameFrame=this._canvas.getContext("2d",{alpha:!1,desynchronized:!0,antialias:!0,depth:!0,premultipliedAlpha:!0,powerPreference:"high-performance"}),console.log("Starting engine..."),this._canvas.addEventListener("mouseout",this.mouseOut.bind(this)),this._canvas.addEventListener("mousedown",this.mousePressed.bind(this)),this._canvas.addEventListener("mouseup",this.mouseReleased.bind(this)),this._canvas.addEventListener("mousemove",this.mouseMoved.bind(this)),this._canvas.addEventListener("mousewheel",this.mouseWheel.bind(this)),this._canvas.addEventListener("wheel",this.mouseWheel.bind(this)),this._canvas.addEventListener("contextmenu",this.eventBlocker.bind(this)),window.addEventListener("keydown",this.keyPressed.bind(this)),window.addEventListener("keyup",this.keyReleased.bind(this)),this.graphics=this.getGraphics(),this.engineState=v.INITIALIZE_DATA,this.drawLoadingScreen(0,"Loading..."),await this.loadFonts(),this.imageLogo=await this.fetchLogo(),await this.run()}eventBlocker(t){t.preventDefault()}setTargetFps(t){this.targetFrameTime=1e3/t}unsetFrameTimes(){for(let t=0;t<10;t++)this.timings[t]=0}setFrameTimes(){for(let t=0;t<10;t++)this.timings[t]=Date.now()}keyPressed(t){switch(t.which){case 27:this.drawWelcomeNotification=!1,this.bankVisible=!1,this.shopVisible=!1,this.tradeConfigVisible=!1,this.duelConfigVisible=!1,this.dialogItemInput=0,this.abuseReportWindow=0,this.contactsInputFormIndex=0,t.preventDefault();break;case 37:this.keyLeft=!0,t.preventDefault();break;case 38:return t.preventDefault(),++this.lastLogIdx>this.lastLog.length-1?(this.showMessage("Reached the top of chat history",3),void(this.lastLogIdx=this.lastLog.length-1)):void this.panelGame[M].setTextHandle(this.controlTextListAll,this.lastLog[this.lastLog.length-1-this.lastLogIdx]);case 39:this.keyRight=!0,t.preventDefault();break;case 40:return t.preventDefault(),--this.lastLogIdx<=-1?(this.showMessage("Reached the bottom of chat history",3),this.panelGame[M].setTextHandle(this.controlTextListAll,""),void(this.lastLogIdx=-1)):void this.panelGame[M].setTextHandle(this.controlTextListAll,this.lastLog[this.lastLog.length-1-this.lastLogIdx]);case 32:this.keySpace=!0,t.preventDefault();break;case 36:this.keyHome=!0,t.preventDefault();break;case 33:this.keyUp=!0,t.preventDefault();break;case 34:this.keyDown=!0,t.preventDefault();break;case 112:this.interlace=!this.interlace,t.preventDefault();break;case 113:this.options.showRoofs=!this.options.showRoofs,t.preventDefault();break;case 114:case 115:case 116:this.showFps=!this.showFps,this.debug=!this.debug,this.dumpRequested=!0;break;case 13:this.inputTextCurrent.length>0&&(this.inputTextFinal=this.inputTextCurrent),this.inputPmCurrent.length>0&&(this.inputPmFinal=this.inputPmCurrent),t.preventDefault();break;case 8:this.inputTextCurrent.length>0&&(this.inputTextCurrent=this.inputTextCurrent.substring(0,this.inputTextCurrent.length-1)),this.inputPmCurrent.length>0&&(this.inputPmCurrent=this.inputPmCurrent.substring(0,this.inputPmCurrent.length-1)),t.preventDefault();break;default:for(let e of ft)if(t.key===e)return!0;this.inputTextCurrent.length<20&&(this.inputTextCurrent+=t.key),this.inputPmCurrent.length<80&&(this.inputPmCurrent+=t.key),t.preventDefault()}if(this.gameState===A.LOGIN&&this.panelLogin&&this.panelLogin[this.welcomeState]){for(let e of ft)if(t.key===e)return!0;return this.panelLogin[this.welcomeState].keyPress(t.which,t.key),void t.preventDefault()}if(this.gameState===A.WORLD){if(this.showAppearanceChange&&this.panelGame[L])return this.panelGame[L].keyPress(t.which,t.key),void t.preventDefault();if(0===this.dialogItemInput&&0===this.contactsInputCtx&&0===this.reportAbuseState&&!this.isSleeping&&this.panelGame[M])return t.preventDefault(),void this.panelGame[M].keyPress(t.which,t.key)}return!1}keyReleased(t){switch(t.preventDefault(),t.which){case 37:this.keyLeft=!1;break;case 39:this.keyRight=!1;break;case 32:this.keySpace=!1;break;case 36:this.keyHome=!1;break;case 33:this.keyUp=!1;break;case 34:this.keyDown=!1}return!1}mouseMoved(t){t.preventDefault(),this.mouseX=t.offsetX,this.mouseY=t.offsetY,this.mouseActionTimeout=0}mouseReleased(t){return t.preventDefault(),1===t.button&&(this.middleButtonDown=!1),this.mouseButtonDown=0,!1}mouseOut(t){return t.preventDefault(),!1}mousePressed(t){if(t.preventDefault(),0===t.button)this.mouseButtonDown=1;else if(2===t.button)this.mouseButtonDown=2;else{if(1!==t.button)return!1;this.mouseButtonDown=3,this.options.middleClickCamera&&(this.middleButtonDown=!0,this.originRotation=this.cameraRotation,this.originMouseX=this.mouseX)}return this.lastMouseButtonDown=this.mouseButtonDown,this.mouseActionTimeout=0,this.handleMouseDown(this.mouseButtonDown,this.mouseX,this.mouseY),!1}handleMouseDown(t,e,i){}mouseWheel(t){if(this.options.mouseWheel)return 0===t.deltaMode?this.mouseScrollDelta=Math.floor(t.deltaY/14):1===t.deltaMode&&(this.mouseScrollDelta=Math.floor(t.deltaY)),!1}start(){this.shutdownCounter=0}get shutdownCounter(){return this._shutdownCounter?this._shutdownCounter:0}set shutdownCounter(t){this._shutdownCounter?this._shutdownCounter=t:this._shutdownCounter=0}stop(){this.shutdownCounter=4e3/this.targetFrameTime}async handleInputs(){}async draw(){}async sleep(t){return new Promise(e=>setInterval(e,t))}async run(){await this.startGame(),this.engineState=v.RUNNING;let t=0,e=256,i=1,s=0;for(let t=0;t<10;t++)this.timings[t]=Date.now();for(;this._shutdownCounter>=0;){if(this._shutdownCounter>0&&--this._shutdownCounter<=0)return void this.clearResources();let r=e,n=i;e=300,i=1;let o=Date.now();if(0===this.timings[t]?(e=r,i=n):o>this.timings[t]&&(e=Math.floor(2560*this.targetFrameTime/(o-this.timings[t]))),e<25&&(e=25),e>256&&(e=256,i=this.targetFrameTime-Math.floor((o-this.timings[t])/10)),i<this.threadSleep&&(i=this.threadSleep),await this.sleep(i),this.timings[t]=o,t=(t+1)%10,i>1)for(let t=0;t<10;t++)0!==this.timings[t]&&(this.timings[t]+=i);for(;s<256;)this.handleInputs(),s+=e;if(this.interlaceTimer--,(this.dumpRequested||this.showFps&&this.targetFrameTime>0)&&(this.fps=1e3*e/(this.targetFrameTime<<8)|0),s&=255,this.draw(),this.mouseScrollDelta=0,this.dumpRequested){console.info("ntime:"+o);for(let e=0;e<10;e++){let i=(t-e-1+20)%10;console.info("otim"+i+":"+this.timings[i])}console.info("fps:"+this.fps+" ratio:"+e+" count:"+s),console.info("del:"+i+" targetFrameTime:"+this.targetFrameTime+" mindel:"+this.threadSleep),console.info("opos:"+t),this.dumpRequested=!1}}}update(t){this.paint(t)}paint(t){this.engineState.toNumber()<v.RUNNING.toNumber()&&this.imageLogo&&this.drawLoadingScreen(this.loadingProgressPercent,this.loadingProgessText)}async fetchLogo(){let t=await this.readDataFile("jagex.jag","ZlackCode library",0);if(t)return this.createImage(S.loadData("logo.tga",0,t))}async loadFonts(){let t=await this.readDataFile("fonts"+mt.FONTS+".jag","Game fonts",5);t&&(dt.createFont(S.loadData("h11p.jf",0,t),0),dt.createFont(S.loadData("h12b.jf",0,t),1),dt.createFont(S.loadData("h12p.jf",0,t),2),dt.createFont(S.loadData("h13b.jf",0,t),3),dt.createFont(S.loadData("h14b.jf",0,t),4),dt.createFont(S.loadData("h16b.jf",0,t),5),dt.createFont(S.loadData("h20b.jf",0,t),6),dt.createFont(S.loadData("h24b.jf",0,t),7))}drawLoadingScreen(t,e){if(!this.graphics)return;let i=Math.floor((this.appletWidth-281)/2),s=Math.floor((this.appletHeight-148)/2);this.graphics.setColor(E.black),this.graphics.fillRect(0,0,this.appletWidth,this.appletHeight),this.hasRefererLogoNotUsed?this.graphics.setColor(new E(220,0,0)):(this.imageLogo&&this.graphics.drawImage(this.imageLogo,i,s),this.graphics.setColor(E.SHADOW_GRAY)),i+=2,s+=90,this.loadingProgessText=e,this.loadingProgressPercent=t,this.graphics.drawRect(i-2,s-2,280,23),this.graphics.fillRect(i,s,Math.floor(277*t/100),20),this.hasRefererLogoNotUsed?this.graphics.setColor(E.WHITE):this.graphics.setColor(E.SILVER),this.drawString(this.graphics,this.loadingProgessText,P.HELVETICA.withSize(12),i+138,s+12),this.hasRefererLogoNotUsed?(this.graphics.setColor(new E(132,132,152)),this.drawString(this.graphics,"©2019-2020 Zach Knight, and the 2003scape team",P.HELVETICA.bold(13),i+138,s-20)):(this.drawString(this.graphics,"Powered by RSCGo, a free and open source software project",P.HELVETICA.bold(13),i+138,s+35),this.drawString(this.graphics,"©2019-2020 Zach Knight, and the 2003scape team",P.HELVETICA.bold(13),i+138,s+49))}updateLoadingStatus(t,e){if(!this.graphics)return;this.loadingProgressPercent=t,this.loadingProgessText=e;let i=Math.floor((this.appletWidth-281)/2),s=Math.floor((this.appletHeight-148)/2);i+=2,s+=90,this.graphics.setColor(new E(132,132,132)),this.hasRefererLogoNotUsed&&this.graphics.setColor(new E(220,0,0));let r=277*t/100|0;this.graphics.fillRect(i,s,r,20),this.graphics.setColor(E.black),this.graphics.fillRect(i+r,s,277-r,20),this.graphics.setColor(new E(198,198,198)),this.hasRefererLogoNotUsed&&this.graphics.setColor(new E(255,255,255)),this.drawString(this.graphics,e,P.TIMES.bold(15),i+138,s+12)}drawString(t,e,i,s,r){t.setFont(i);const{width:n,height:o}=t.ctx.measureText(e);t.drawString(e,s-(n/2|0),r+(o/4|0))}createImage(t){return new pt.TGA(t.buffer).getCanvas().getContext("2d").getImageData(0,0,this._canvas.width,this._canvas.height)}async readDataFile(t,e,i){t="./static/cache/"+t,this.updateLoadingStatus(i,"Loading "+e+" - 0%");let s=S.openFile(t),r=new Int8Array(6);await s.readFully(r,0,6);let n=((255&r[0])<<16)+((255&r[1])<<8)+(255&r[2]),o=((255&r[3])<<16)+((255&r[4])<<8)+(255&r[5]);this.updateLoadingStatus(i,"Loading "+e+" - 5%");let h=0,l=new Int8Array(o);for(;h<o;){let t=Math.min(o-h,8192);await s.readFully(l,h,t),h+=t,this.updateLoadingStatus(i,"Loading "+e+" - "+(5+95*h/o|0)+"%")}if(this.updateLoadingStatus(i,"Unpacking "+e),o!==n){let t=new Int8Array(n);return a.a.decompress(t,n,l,o,0),t}return l}getGraphics(){return this._graphics}async createSocket(t,e){let i=new lt.a(t,e);return await i.connect(),i}}const St=new TextEncoder("utf-8");class wt{get opcode(){return this._opcode||(this._opcode=0),this._opcode}set opcode(t){this._opcode=t}constructor(t=-1){this.data=new Int8Array(24578),this.buff=new Int8Array(24578),this.readLength=0,this.writeMarker=0,this.endMarker=3,this.didError=!1,this.exceptionMessage="",this.writer=new nt(20),this.reader=new nt(5),this.readTries=0,this.opcode=t,this.pqueue=[]}static bare(t){let e=new wt(t);return e.startAccess(),e.stopAccess(),e}async readBytes(t,e){await this.readStreamBytes(t,0,e)}async nextPacket(){try{return await this.reader.tick(async()=>{try{if(++this.readTries>1e3)throw this.reader.tickCount=0,this.exceptionMessage="time-out",this.didError=!0,new Error(this.exceptionMessage);if(0===this.readLength&&this.availableStream()>=2&&(this.readTries=0,this.readLength=await this.getByte(),this.readLength>=160&&(this.readLength=this.readLength-160<<8|await this.getByte())),this.readLength>0&&this.availableStream()>=this.readLength){this.readTries=0;let t=this.readLength,e=new Int8Array(t);return t<160&&(e[--t]=await this.getByte()),t>0&&await this.readBytes(t,e),this.readLength=0,this.reader.tickCount=0,this.readTries=0,e}this.reader.tickCount=this.reader.tickThreshold-1}catch(t){throw console.error(t),t}})}catch(t){throw t}}hasPacket(){return this.writeMarker>0||this.pqueue.length>0}tick(){this.writer.tick(()=>{if(this.didError)return this.reset(),this.writeMarker=3,this.socketException=new rt(this.exceptionMessage),void(this.pqueue=[]);this.hasPacket()?(this.writer.tickCount=0,this.flush()):this.writer.tickCount=this.writer.tickThreshold-1})}flush(){if(this.writeMarker>0&&(this.pqueue.push(this),this.reset()),this.pqueue.length>0)for(let t=this.pqueue.shift();t;t=this.pqueue.shift())this.send(t)}add(t){this.pqueue.push(t)}queue(t){this.pqueue.push(t)}send(t){this.writeStreamBytes(t.data,0,t.writeMarker)}stopAccess(){let t=this.endMarker-this.writeMarker-2;t>=160?(this.data[this.writeMarker]=160+(t>>8)&255,this.data[this.writeMarker+1]=255&t):(this.data[this.writeMarker]=255&t,this.endMarker--,this.data[this.writeMarker+1]=this.data[this.endMarker]),this.writeMarker=this.endMarker}newPacket(t){this.startAccess(t)}sendPacket(){this.stopAccess()}startAccess(t=this.opcode){if(this.writeMarker>=Math.floor(19660))try{this.tick()}catch(t){this.exceptionMessage=t.message,this.didError=!0,console.log("tick()")}this.data||(this.data=new Int8Array(24575)),this.data[this.writeMarker+2]=255&t,this.endMarker=this.writeMarker+3,this.data[this.endMarker]=0}reset(){this.endMarker-=this.writeMarker,this.writeMarker=0}async getByte(){return 255&await this.readStream()}async getUByte(){return await this.getByte()}async getShort(){return await this.getUByte()<<8|await this.getUByte()}async getInt(){return await this.getShort()<<16|await this.getShort()}async getSmart08_32(){let t=await this.getByte();return t>=128?t-128<<24|await this.getByte()<<16|await this.getByte()<<8|await this.getByte():t}async getLong(){return BigInt(await this.getInt()<<32)|BigInt(await this.getInt())}putString(t){this.putBytes(St.encode(t)),this.putByte("\0")}putBigBuffer(t){this.putShort(t.length),this.putBytes(t)}putBuffer(t){this.putByte(t.length),this.putBytes(t)}putByte(t){this.data[this.endMarker++]=t}putUByte(t){this.putByte(255&t)}putBoolean(t){this.putByte(t?1:0)}putBool(t){this.putByte(t?1:0)}putShort(t){this.putUByte(t>>8),this.putUByte(t)}putInt(t){this.putShort(t>>16),this.putShort(t)}putSmart08_64(t){if(t>=128)return this.data[this.endMarker++]=Number((t>>56n)+128n&0xFFn),this.data[this.endMarker++]=Number(t>>48n&0xFFn),this.data[this.endMarker++]=Number(t>>40n&0xFFn),this.data[this.endMarker++]=Number(t>>32n&0xFFn),this.data[this.endMarker++]=Number(t>>24n&0xFFn),this.data[this.endMarker++]=Number(t>>16n&0xFFn),this.data[this.endMarker++]=Number(t>>8n&0xFFn),void(this.data[this.endMarker++]=Number(0xFFn&t));this.putUByte(t)}putSmart08_32(t){if(t>=128)return this.putUByte(128+(t>>24)),this.putUByte(t>>16),this.putUByte(t>>8),void this.putUByte(t);this.putUByte(t)}putSmart08_16(t){if(t>=160)return this.putUByte(160+(t>>8)),void this.putUByte(t);this.putUByte(t)}putSmart16_64(t){if(t>=128)return this.data[this.endMarker++]=Number((t>>56n)+128n&0xFFn),this.data[this.endMarker++]=Number(t>>48n&0xFFn),this.data[this.endMarker++]=Number(t>>40n&0xFFn),this.data[this.endMarker++]=Number(t>>32n&0xFFn),this.data[this.endMarker++]=Number(t>>24n&0xFFn),this.data[this.endMarker++]=Number(t>>16n&0xFFn),this.data[this.endMarker++]=Number(t>>8n&0xFFn),void(this.data[this.endMarker++]=Number(0xFFn&t));this.putShort(t)}putSmart16_32(t){if(t>=128)return this.putUByte(128+(t>>24)),this.putUByte(t>>16),this.putUByte(t>>8),void this.putUByte(t);this.putShort(t)}putSmart32_64(t){if(t>=128)return this.putUByte(128+(t>>56)),this.putUByte(t>>48),this.putUByte(t>>40),this.putUByte(t>>32),this.putUByte(t>>24),this.putUByte(t>>16),this.putUByte(t>>8),void this.putUByte(t);this.putInt(t)}putLong(t){this.data[this.endMarker++]=Number(t>>56n&0xFFn),this.data[this.endMarker++]=Number(t>>48n&0xFFn),this.data[this.endMarker++]=Number(t>>40n&0xFFn),this.data[this.endMarker++]=Number(t>>32n&0xFFn),this.data[this.endMarker++]=Number(t>>24n&0xFFn),this.data[this.endMarker++]=Number(t>>16n&0xFFn),this.data[this.endMarker++]=Number(t>>8n&0xFFn),this.data[this.endMarker++]=Number(0xFFn&t)}putBytes(t,e=0,i=t.length){for(let s=e;s<e+i&&s<t.length;s++)this.putByte(t[s])}}class yt extends wt{constructor(t){super(),this.closing=!1,this.closed=!1,this.socket=t}closeStream(){this.closing=!0,this.socket.close(),this.closed=!0}async readStream(){return this.closed?0:await this.socket.readByte()}availableStream(){return this.closed?0:this.socket.available()}async readStreamBytes(t,e,i){this.closed||await this.socket.readBytes(i,e,t)}writeStreamBytes(t,e,i){this.closing||this.closed||this.socket.write(t,e,i)}}var It=n(0),Ct=n(5),bt=n.n(Ct);let Tt=bt()("12256971504525176577999115521306614075749098639988274452692554670619288210288814203087336665303501555493198422881032409199392946347224070978354126295353401",10),xt=bt()("121727957757863576101561860005285292626079113266451124223351027655156011238254177877652729098983576274837395085392103662934978533548660507677480253506715648449246069310428873797293036242698272731265802720055413141023411018398284944110799347717001885969188133010830020603318079626459849229187149790609728348667",10);class vt{static COMMAND(t){let e=new wt(It.COMMAND);return e.startAccess(),e.putString(t),e.stopAccess(),e}static CHANGE_PASSWORD(t,e){let i=new wt(It.CHANGE_PASSWORD);return i.startAccess(),i.putString(t),i.putString(e),i.stopAccess(),i}static CHAT(t,e=t.length){let i=new wt(It.CHAT);return i.startAccess(),i.putBytes(t,0,e),i.stopAccess(),i}static PM(t,e,i=e.length){let s=new wt(It.PM);return s.startAccess(),s.putLong(t),s.putBytes(e,0,i),s.stopAccess(),s}static REMOVE_FRIEND(t){let e=new wt(It.FRIEND_REMOVE);return e.startAccess(),e.putLong(t),e.stopAccess(),e}static REMOVE_IGNORE(t){let e=new wt(It.IGNORE_REMOVE);return e.startAccess(),e.putLong(t),e.stopAccess(),e}static ADD_FRIEND(t){let e=new wt(It.FRIEND_ADD);return e.startAccess(),e.putLong(t),e.stopAccess(),e}static ADD_IGNORE(t){let e=new wt(It.IGNORE_ADD);return e.startAccess(),e.putLong(t),e.stopAccess(),e}static PRIVACY_SETTINGS(t,e,i,s){let r=new wt(It.SETTINGS_PRIVACY);return r.startAccess(),r.putBoolean(t),r.putBoolean(e),r.putBoolean(i),r.putBoolean(s),r.stopAccess(),r}static LOGIN(t,e,i=!1){let s=new D(new Uint8Array(128)),r=new Uint32Array(4);crypto.getRandomValues(r);for(let t=0;t<r.length;t++)s.putInt(r[t]);s.putLong(S.usernameToHash(t)),s.putString(e);let n=new wt(It.LOGIN);var o;return n.startAccess(),n.putBool(i),n.putShort(mt.CLIENT),n.putBigBuffer((o=s.buffer.slice(0,s.offset),bt.a.fromArray(Array.from(o),256).modPow(Tt,xt).toArray(256).value)),n.stopAccess(),n}static REGISTER(t,e){let i=new wt(It.REGISTER);return i.startAccess(),i.putShort(mt.CLIENT),i.putLong(S.usernameToHash(t)),i.putString(e),i.stopAccess(),i}static REPORT_ABUSE(t,e,i){let s=new wt(It.REPORT_ABUSE);return s.startAccess(),s.putLong(S.usernameToHash(t)),s.putByte(e),s.putByte(i),s.stopAccess(),s}static CHANGE_APPEARANCE(t,e,i,s,r,n,o,a){let h=new wt(It.APPEARANCE);return h.startAccess(),h.putByte(t),h.putByte(e),h.putByte(i),h.putByte(s),h.putByte(r),h.putByte(n),h.putByte(o),h.putByte(a),h.stopAccess(),h}}vt.DISCONNECT=wt.bare(It.CLOSE_CONNECTION),vt.PING=wt.bare(It.PING),vt.CLOSE_BANK=wt.bare(It.BANK_CLOSE),vt.DECLINE_DUEL=wt.bare(It.DUEL_DECLINE),vt.ACCEPT_DUEL_ONE=wt.bare(It.DUEL_ACCEPT),vt.ACCEPT_DUEL_TWO=wt.bare(It.DUEL_CONFIRM_ACCEPT),vt.DECLINE_TRADE=wt.bare(It.TRADE_DECLINE),vt.ACCEPT_TRADE_ONE=wt.bare(It.TRADE_ACCEPT),vt.ACCEPT_TRADE_TWO=wt.bare(It.TRADE_CONFIRM_ACCEPT);var At=n(1);class Lt extends gt{constructor(t){super(t),this.settingsBlockChat=!1,this.settingsBlockPrivate=!1,this.settingsBlockTrade=!1,this.settingsBlockDuel=!1,this.server="127.0.0.1",this.port=43595,this.username=se("username"),this.password="",this.friendListCount=0,this.friendListHashes=new BigUint64Array(Lt.socialListSize),this.friendListOnline=new Array(Lt.socialListSize),this.ignoreListCount=0,this.ignoreList=new BigUint64Array(Lt.socialListSize),this.privateMessageIds=new Uint32Array(Lt.socialListSize),this.timeoutCheck=nt.fromSeconds(5)}async registerAccount(t,e){try{let i=S.formatAndTruncate(t,12),s=S.formatAndTruncate(e,20);this.clientStream&&this.clientStream.closeStream(),this.updateWelcomeStatuses("Please wait...","creating new account..."),this.clientStream=new yt(await this.createSocket(window.location.protocol.replace("http","ws")+"//"+window.location.hostname,this.port),this),this.clientStream.send(vt.REGISTER(i,s));let r=await this.clientStream.readStream();switch(console.log("newplayer response: "+r),this.clientStream.closeStream(),r){case 2:return this.resetLoginVars(),void await this.login(i,s,!1);case 13:case 3:return void this.updateWelcomeStatuses("Username already taken.","Please choose another username");case 4:return void this.updateWelcomeStatuses("That username is already in use.","Wait 60 seconds then retry");case 5:return void this.updateWelcomeStatuses("The client has been updated.","Please reload this page");case 6:return void this.updateWelcomeStatuses("You may only use 1 character at once.","Your ip-address is already in use");case 7:return void this.updateWelcomeStatuses("Login attempts exceeded!","Please try again in 5 minutes");case 11:return void this.updateWelcomeStatuses("Account has been temporarily disabled","for cheating or abuse");case 12:return void this.updateWelcomeStatuses("Account has been permanently disabled","for cheating or abuse");case 14:return this.updateWelcomeStatuses("Sorry! The server is currently full.","Please try again later"),void(this.worldFullTimeout=secondsToFrames(30));case 15:return void this.updateWelcomeStatuses("You need a members account","to login to this server");case 16:return void this.updateWelcomeStatuses("Please login to a members server","to access member-only features");case 19:return void this.updateWelcomeStatuses("Bad username/password","Please check your input and try again")}this.updateWelcomeStatuses("Error unable to create user.","Unrecognised response code")}catch(t){console.error(t),this.updateWelcomeStatuses("Error unable to create user.","Unrecognised response code")}}changePassword(t,e){this.clientStream.queue(vt.CHANGE_PASSWORD(S.formatAndTruncate(t,20),S.formatAndTruncate(e,20)))}async login(t,e,i,s){if(this.worldFullTimeout>0)return this.updateWelcomeStatuses("Please wait...","Connecting to server"),await this.sleep(2e3),void this.updateWelcomeStatuses("Sorry! The server is currently full.","Please try again later");try{if(this.username=t,t=S.formatAndTruncate(t,20),this.password=e,e=S.formatAndTruncate(e,20),0===t.trim().length)return void this.updateWelcomeStatuses("You must enter both a username","and a password - Please try again");i?this.drawTextBox("Connection lost! Please wait...","Attempting to re-establish"):this.updateWelcomeStatuses("Please wait...","Connecting to server"),this.clientStream&&this.clientStream.closeStream(),this.clientStream=new yt(await this.createSocket(window.location.protocol.replace("http","ws")+"//"+window.location.hostname,this.port),this),this.clientStream.send(vt.LOGIN(t,e,i));let s=await this.clientStream.readStream();switch(console.debug("login response:"+s),-65&s){case 25:case 24:return this.autoLoginTimeout=0,this.moderatorLevel=(-65&s)-23,void this.resetWorldState();case 0:return this.autoLoginTimeout=0,this.moderatorLevel=0,void this.resetWorldState();case 1:return i&&this.resetLoginVars(),void(this.autoLoginTimeout=0);case-1:this.updateWelcomeStatuses("Error unable to login.","Server timed out");break;case 3:this.updateWelcomeStatuses("Invalid username or password.","Try again, or create a new account");break;case 4:this.updateWelcomeStatuses("That username is already logged in.","Wait 60 seconds then retry");break;case 5:this.updateWelcomeStatuses("The client has been updated.","Please reload this page");break;case 6:this.updateWelcomeStatuses("You may only use 1 character at once.","Your ip-address is already in use");break;case 7:this.updateWelcomeStatuses("Login attempts exceeded!","Please try again in 5 minutes");break;case 8:this.updateWelcomeStatuses("Error unable to login.","Server rejected session");break;case 9:this.updateWelcomeStatuses("Error unable to login.","Loginserver rejected session");break;case 10:this.updateWelcomeStatuses("That username is already in use.","Wait 60 seconds then retry");break;case 11:this.updateWelcomeStatuses("Account temporarily disabled.","Check your message inbox for details");break;case 12:this.updateWelcomeStatuses("Account permanently disabled.","Check your message inbox for details");break;case 14:this.updateWelcomeStatuses("Sorry! This world is currently full.","Please try a different world"),this.worldFullTimeout=secondsToFrames(30);break;case 15:this.updateWelcomeStatuses("You need a members account","to login to this world");break;case 16:this.updateWelcomeStatuses("Error - no reply from loginserver.","Please try again");break;case 17:this.updateWelcomeStatuses("Error - failed to decode profile.","Contact customer support");break;case 18:this.updateWelcomeStatuses("Account suspected stolen.","Press 'recover a locked account' on front page.");break;case 20:this.updateWelcomeStatuses("Error - loginserver mismatch","Please try a different world");break;case 21:this.updateWelcomeStatuses("Unable to login.","That is not an RS-Classic account");break;case 22:this.updateWelcomeStatuses("Password suspected stolen.","Press 'change your password' on front page.");break;default:this.updateWelcomeStatuses("Error unable to login.","Unrecognised response code")}return void(!1&s&&this.clientStream.closeStream())}catch(t){this.networkException=new rt(t),console.log(this.networkException)}this.updateWelcomeStatuses("Sorry! Unable to connect.","Check internet settings or try another world")}closeConnection(){if(this.clientStream)try{this.clientStream.add(vt.DISCONNECT),this.clientStream.flush(),this.clientStream.closeStream()}catch(t){console.error(t)}this.resetLoginVars()}async lostConnection(){try{throw this.socketException=new rt(Error("Lost connection - attempting to re-establish..."),!1),this.socketException}catch(t){console.info("Network connection lost; re-establishing..."),console.error(t)}this.drawTextBox("Lost connection","attempting to re-establish..."),this.autoLoginTimeout=10,await this.login(this.username,this.password,!0)}drawTextBox(t,e){this.graphics.setColor(E.WHITE),this.graphics.drawRect(Math.floor(this.surface.width2/2)-140,Math.floor(this.surface.height2/2)-25,280,50),this.graphics.setColor(E.BLACK),this.graphics.fillRect(Math.floor(this.surface.width2/2)-140,Math.floor(this.surface.height2/2)-25,280,50);let i=P.HELVETICA.bold(15);this.drawString(this.graphics,t,i,Math.floor(this.surface.width2/2),Math.floor(this.surface.height2/2)-10),this.drawString(this.graphics,e,i,Math.floor(this.surface.width2/2),Math.floor(this.surface.height2/2)+10)}async checkConnection(){this.timeoutCheck.tick(()=>{this.clientStream.queue(vt.PING)}),this.clientStream.hasPacket()&&(this.timeoutCheck.tickCount=0);try{this.clientStream.tick()}catch(t){return console.error(t.message),console.warn("Error in socket write subroutine:",t),this.closeConnection(),void(this.clientStream=null)}try{let t=await this.clientStream.nextPacket();if(this.clientStream.didError)return void await this.closeConnection();if(!t||t.length<=0)return;this.handlePacket(t)}catch(t){return console.warn("Error in socket read subroutine:",t),this.closeConnection(),void(this.clientStream=null)}}handlePacket(t){let e=0,i=t.length,s=S.getUnsignedByte(t[e++]);if(s!==At.MESSAGE)if(s!==At.CLOSE_CONNECTION)if(s!==At.LOGOUT_DENY)if(s!==At.FRIEND_LIST){if(s===At.FRIEND_STATUS_CHANGE){let i=S.getUnsignedLong(t,e);e+=8;let s=S.getUnsignedByte(t[e++]);for(let t=0;t<this.friendListCount;t++)if(this.friendListHashes[t]===i)return this.friendListOnline[t]!==s&&this.showServerMessage("@pri@"+S.hashToUsername(i)+" has logged "+(0!==s?"in":"out")),this.friendListOnline[t]=s,void this.sortFriendsList();return this.friendListHashes[this.friendListCount]=i,this.friendListOnline[this.friendListCount++]=s,void this.sortFriendsList()}if(s!==At.IGNORE_LIST){if(s===At.PRIVACY_SETTINGS)return this.settingsBlockChat=S.getBoolean(t[e++]),this.settingsBlockPrivate=S.getBoolean(t[e++]),this.settingsBlockTrade=S.getBoolean(t[e++]),void(this.settingsBlockDuel=S.getBoolean(t[e++]));if(s===At.FRIEND_MESSAGE){let i=S.getUnsignedLong(t,e);e+=8;let s=S.getUnsignedInt(t,e);e+=4;for(let t of this.privateMessageIds)if(t===s)return;return this.privateMessageIds[Lt.privateMessageUuid]=s,void this.showServerMessage("@pri@"+S.hashToUsername(i)+": tells you "+this.chatSystem.decode(t.slice(e)))}this.handleIncomingPacket(s,i,t)}else{this.ignoreListCount=S.getUnsignedByte(t[e++]);for(let i=0;i<this.ignoreListCount;i++)this.ignoreList[i]=S.getUnsignedLong(t,e),e+=8}}else{this.friendListCount=S.getUnsignedByte(t[e++]);for(let i=0;i<this.friendListCount;i++)this.friendListHashes[i]=S.getUnsignedLong(t,e),e+=8,this.friendListOnline[i]=S.getUnsignedByte(t[e++]);this.sortFriendsList()}else this.cantLogout();else this.closeConnection();else this.showServerMessage(this.chatSystem.decode(t.slice(e)))}sortFriendsList(){for(let t=!0;t;){t=!1;for(let e=0;e<this.friendListCount-1;e++)(!1&this.friendListOnline[e]&&!0&this.friendListOnline[e+1]||!1&this.friendListOnline[e]&&!0&this.friendListOnline[e+1])&&(this.friendListOnline[e],this.friendListOnline[e+1]=this.friendListOnline[e+1],this.friendListOnline[e],this.friendListHashes[e],this.friendListHashes[e+1]=this.friendListHashes[e+1],this.friendListHashes[e],t=!0)}}sendPrivacySettings(t,e,i,s){this.clientStream.queue(vt.PRIVACY_SETTINGS(t,e,i,s))}ignoreAdd(t){let e=S.usernameToHash(t);for(let t=0;t<this.ignoreListCount;t++)if(this.ignoreList[t]===e)return;this.clientStream.queue(vt.ADD_IGNORE(e)),this.ignoreListCount<Lt.socialListSize&&(this.ignoreList[this.ignoreListCount++]=e)}ignoreRemove(t){this.clientStream.add(vt.REMOVE_IGNORE(t));for(let e=0;e<this.ignoreListCount;e++)if(this.ignoreList[e]===t){this.ignoreListCount--;for(let t=e;t<this.ignoreListCount;t++)this.ignoreList[t]=this.ignoreList[t+1];return}}friendAdd(t){let e=S.usernameToHash(t);for(let t=0;t<this.friendListCount;t++)if(this.friendListHashes[t]===e)return void displayMessage("You're already friends with that person!",6);this.clientStream.add(vt.ADD_FRIEND(e)),this.friendListCount<Lt.maxSocialListSize&&(this.friendListHashes[this.friendListCount]=e,this.friendListOnline[this.friendListCount++]=0)}friendRemove(t){this.clientStream.queue(vt.REMOVE_FRIEND(t));for(let e=0;e<this.friendListCount;e++){if(this.friendListHashes[e]===t){this.friendListCount--;for(let t=e;t<this.friendListCount;t++)this.friendListHashes[t],this.friendListOnline[t]=this.friendListHashes[t+1],this.friendListOnline[t+1];return void this.showServerMessage("@pri@"+S.hashToUsername(t)+" has been removed from your friends list")}}displayMessage("Problem removing contact from friends.  You're not even a friend of that person!",6)}sendPrivateMessage(t,e,i=e.length){this.clientStream.queue(vt.PM(t,e,i))}sendChatMessage(t,e=t.length){this.clientStream.queue(vt.CHAT(t,e))}sendCommandString(t){this.clientStream.queue(vt.COMMAND(t))}stop(){super.stop()}}Object.defineProperty(Lt,"socialListSize",{get:()=>200,set:void 0}),Object.defineProperty(Lt,"privateMessageUuid",{get:()=>(Lt._privateMessageUuid||(Lt._privateMessageUuid=0),Lt._privateMessageUuid=++Lt._privateMessageUuid%Lt.socialListSize,Lt._privateMessageUuid),set:void 0});var Mt=n(3),kt=n.n(Mt);class Et{static getModelIndex(t){if("na"===(t=t.toLowerCase()))return 0;for(let e=0;e<Et.modelCount;e++)if(Et.modelName[e].toLowerCase()===t)return e;return Et.modelName[Et.modelCount++]=t,Et.modelCount-1}static getUnsignedByte(){return 255&Et.dataInteger[Et.offset++]}static getUnsignedShort(){let t=S.getUnsignedShort(Et.dataInteger,Et.offset);return Et.offset+=2,t}static getUnsignedInt(){let t=S.getUnsignedInt(Et.dataInteger,Et.offset);return Et.offset+=4,t>99999999&&(t=99999999-t),t}static getString(){let t="";for(;0!==Et.dataString[Et.stringOffset];)t+=String.fromCharCode(Et.dataString[Et.stringOffset++]);return Et.stringOffset++,t}static loadDefinitions(t,e){Et.dataString=S.loadData("string.dat",0,t),Et.stringOffset=0,Et.dataInteger=S.loadData("integer.dat",0,t),Et.offset=0;let i=0;for(Et.itemCount=Et.getUnsignedShort(),Et.itemName=[],Et.itemDescription=[],Et.itemCommand=[],Et.itemPicture=new Int32Array(Et.itemCount),Et.itemBasePrice=new Int32Array(Et.itemCount),Et.itemStackable=new Int32Array(Et.itemCount),Et.itemUnused=new Int32Array(Et.itemCount),Et.itemWearable=new Int32Array(Et.itemCount),Et.itemMask=new Int32Array(Et.itemCount),Et.itemSpecial=new Int32Array(Et.itemCount),Et.itemMembers=new Int32Array(Et.itemCount),i=0;i<Et.itemCount;i++)Et.itemName.push(Et.getString());for(i=0;i<Et.itemCount;i++)Et.itemDescription.push(Et.getString());for(i=0;i<Et.itemCount;i++)Et.itemCommand.push(Et.getString());for(i=0;i<Et.itemCount;i++)Et.itemPicture[i]=Et.getUnsignedShort(),Et.itemPicture[i]+1>Et.itemSpriteCount&&(Et.itemSpriteCount=Et.itemPicture[i]+1);for(i=0;i<Et.itemCount;i++)Et.itemBasePrice[i]=Et.getUnsignedInt();for(i=0;i<Et.itemCount;i++)Et.itemStackable[i]=Et.getUnsignedByte();for(i=0;i<Et.itemCount;i++)Et.itemUnused[i]=Et.getUnsignedByte();for(i=0;i<Et.itemCount;i++)Et.itemWearable[i]=Et.getUnsignedShort();for(i=0;i<Et.itemCount;i++)Et.itemMask[i]=Et.getUnsignedInt();for(i=0;i<Et.itemCount;i++)Et.itemSpecial[i]=Et.getUnsignedByte();for(i=0;i<Et.itemCount;i++)Et.itemMembers[i]=Et.getUnsignedByte();for(i=0;i<Et.itemCount;i++)e||1!==Et.itemMembers[i]||(Et.itemName[i]="Members object",Et.itemDescription[i]="You need to be a member to use this object",Et.itemBasePrice[i]=0,Et.itemCommand[i]="",Et.itemUnused[0]=0,Et.itemWearable[i]=0,Et.itemSpecial[i]=1);for(Et.npcCount=Et.getUnsignedShort(),Et.npcName=[],Et.npcDescription=[],Et.npcCommand=[],Et.npcAttack=new Int32Array(Et.npcCount),Et.npcStrength=new Int32Array(Et.npcCount),Et.npcHits=new Int32Array(Et.npcCount),Et.npcDefense=new Int32Array(Et.npcCount),Et.npcAttackable=new Int32Array(Et.npcCount),Et.npcSprite=kt()(new Int32Array(12*Et.npcCount),[Et.npcCount,12]),Et.npcColourHair=new Int32Array(Et.npcCount),Et.npcColourTop=new Int32Array(Et.npcCount),Et.npcColorBottom=new Int32Array(Et.npcCount),Et.npcColourSkin=new Int32Array(Et.npcCount),Et.npcWidth=new Int32Array(Et.npcCount),Et.npcHeight=new Int32Array(Et.npcCount),Et.npcWalkModel=new Int32Array(Et.npcCount),Et.npcCombatModel=new Int32Array(Et.npcCount),Et.npcCombatAnimation=new Int32Array(Et.npcCount),i=0;i<Et.npcCount;i++)Et.npcName.push(Et.getString());for(i=0;i<Et.npcCount;i++)Et.npcDescription.push(Et.getString());for(i=0;i<Et.npcCount;i++)Et.npcAttack[i]=Et.getUnsignedByte();for(i=0;i<Et.npcCount;i++)Et.npcStrength[i]=Et.getUnsignedByte();for(i=0;i<Et.npcCount;i++)Et.npcHits[i]=Et.getUnsignedByte();for(i=0;i<Et.npcCount;i++)Et.npcDefense[i]=Et.getUnsignedByte();for(i=0;i<Et.npcCount;i++)Et.npcAttackable[i]=Et.getUnsignedByte();for(i=0;i<Et.npcCount;i++)for(let t=0;t<12;t++){let e=Et.getUnsignedByte();Et.npcSprite.set(i,t,255===e?-1:e)}for(i=0;i<Et.npcCount;i++)Et.npcColourHair[i]=Et.getUnsignedInt();for(i=0;i<Et.npcCount;i++)Et.npcColourTop[i]=Et.getUnsignedInt();for(i=0;i<Et.npcCount;i++)Et.npcColorBottom[i]=Et.getUnsignedInt();for(i=0;i<Et.npcCount;i++)Et.npcColourSkin[i]=Et.getUnsignedInt();for(i=0;i<Et.npcCount;i++)Et.npcWidth[i]=Et.getUnsignedShort();for(i=0;i<Et.npcCount;i++)Et.npcHeight[i]=Et.getUnsignedShort();for(i=0;i<Et.npcCount;i++)Et.npcWalkModel[i]=Et.getUnsignedByte();for(i=0;i<Et.npcCount;i++)Et.npcCombatModel[i]=Et.getUnsignedByte();for(i=0;i<Et.npcCount;i++)Et.npcCombatAnimation[i]=Et.getUnsignedByte();for(i=0;i<Et.npcCount;i++)Et.npcCommand[i]=Et.getString();for(Et.textureCount=Et.getUnsignedShort(),Et.textureName=[],Et.textureSubtypeName=[],i=0;i<Et.textureCount;i++)Et.textureName.push(Et.getString());for(i=0;i<Et.textureCount;i++)Et.textureSubtypeName.push(Et.getString());for(Et.animationCount=Et.getUnsignedShort(),Et.animationName=[],Et.animationCharacterColour=new Int32Array(Et.animationCount),Et.animationSomething=new Int32Array(Et.animationCount),Et.animationHasA=new Int32Array(Et.animationCount),Et.animationHasF=new Int32Array(Et.animationCount),Et.animationNumber=new Int32Array(Et.animationCount),i=0;i<Et.animationCount;i++)Et.animationName.push(Et.getString());for(i=0;i<Et.animationCount;i++)Et.animationCharacterColour[i]=Et.getUnsignedInt();for(i=0;i<Et.animationCount;i++)Et.animationSomething[i]=Et.getUnsignedByte();for(i=0;i<Et.animationCount;i++)Et.animationHasA[i]=Et.getUnsignedByte();for(i=0;i<Et.animationCount;i++)Et.animationHasF[i]=Et.getUnsignedByte();for(i=0;i<Et.animationCount;i++)Et.animationNumber[i]=Et.getUnsignedByte();for(Et.objectCount=Et.getUnsignedShort(),Et.objectName=[],Et.objectDescription=[],Et.objectCommand1=[],Et.objectCommand2=[],Et.objectModelIndex=new Int32Array(Et.objectCount),Et.objectWidth=new Int32Array(Et.objectCount),Et.objectHeight=new Int32Array(Et.objectCount),Et.objectType=new Int32Array(Et.objectCount),Et.objectElevation=new Int32Array(Et.objectCount),i=0;i<Et.objectCount;i++)Et.objectName.push(Et.getString());for(i=0;i<Et.objectCount;i++)Et.objectDescription.push(Et.getString());for(i=0;i<Et.objectCount;i++)Et.objectCommand1.push(Et.getString());for(i=0;i<Et.objectCount;i++)Et.objectCommand2.push(Et.getString());for(i=0;i<Et.objectCount;i++)Et.objectModelIndex[i]=Et.getModelIndex(Et.getString());for(i=0;i<Et.objectCount;i++)Et.objectWidth[i]=Et.getUnsignedByte();for(i=0;i<Et.objectCount;i++)Et.objectHeight[i]=Et.getUnsignedByte();for(i=0;i<Et.objectCount;i++)Et.objectType[i]=Et.getUnsignedByte();for(i=0;i<Et.objectCount;i++)Et.objectElevation[i]=Et.getUnsignedByte();for(Et.wallObjectCount=Et.getUnsignedShort(),Et.wallObjectName=[],Et.wallObjectDescription=[],Et.wallObjectCommand1=[],Et.wallObjectCommand2=[],Et.wallObjectHeight=new Int32Array(Et.wallObjectCount),Et.wallObjectTextureFront=new Int32Array(Et.wallObjectCount),Et.wallObjectTextureBack=new Int32Array(Et.wallObjectCount),Et.wallObjectAdjacent=new Int32Array(Et.wallObjectCount),Et.wallObjectInvisible=new Int32Array(Et.wallObjectCount),i=0;i<Et.wallObjectCount;i++)Et.wallObjectName.push(Et.getString());for(i=0;i<Et.wallObjectCount;i++)Et.wallObjectDescription.push(Et.getString());for(i=0;i<Et.wallObjectCount;i++)Et.wallObjectCommand1.push(Et.getString());for(i=0;i<Et.wallObjectCount;i++)Et.wallObjectCommand2.push(Et.getString());for(i=0;i<Et.wallObjectCount;i++)Et.wallObjectHeight[i]=Et.getUnsignedShort();for(i=0;i<Et.wallObjectCount;i++)Et.wallObjectTextureFront[i]=Et.getUnsignedInt();for(i=0;i<Et.wallObjectCount;i++)Et.wallObjectTextureBack[i]=Et.getUnsignedInt();for(i=0;i<Et.wallObjectCount;i++)Et.wallObjectAdjacent[i]=Et.getUnsignedByte();for(i=0;i<Et.wallObjectCount;i++)Et.wallObjectInvisible[i]=Et.getUnsignedByte();for(Et.roofCount=Et.getUnsignedShort(),Et.roofHeight=new Int32Array(Et.roofCount),Et.roofNumVertices=new Int32Array(Et.roofCount),i=0;i<Et.roofCount;i++)Et.roofHeight[i]=Et.getUnsignedByte();for(i=0;i<Et.roofCount;i++)Et.roofNumVertices[i]=Et.getUnsignedByte();for(Et.tileCount=Et.getUnsignedShort(),Et.tileDecoration=new Int32Array(Et.tileCount),Et.overlays=new Int32Array(Et.tileCount),Et.tileAdjacent=new Int32Array(Et.tileCount),i=0;i<Et.tileCount;i++)Et.tileDecoration[i]=Et.getUnsignedInt();for(i=0;i<Et.tileCount;i++)Et.overlays[i]=Et.getUnsignedByte();for(i=0;i<Et.tileCount;i++)Et.tileAdjacent[i]=Et.getUnsignedByte();for(Et.projectileSprite=Et.getUnsignedShort(),Et.spellCount=Et.getUnsignedShort(),Et.spellName=[],Et.spellDescription=[],Et.spellLevel=new Int32Array(Et.spellCount),Et.spellRunesRequired=new Int32Array(Et.spellCount),Et.spellType=new Int32Array(Et.spellCount),Et.spellRunesId=[],Et.spellRunesCount=[],i=0;i<Et.spellCount;i++)Et.spellName.push(Et.getString());for(i=0;i<Et.spellCount;i++)Et.spellDescription.push(Et.getString());for(i=0;i<Et.spellCount;i++)Et.spellLevel[i]=Et.getUnsignedByte();for(i=0;i<Et.spellCount;i++)Et.spellRunesRequired[i]=Et.getUnsignedByte();for(i=0;i<Et.spellCount;i++)Et.spellType[i]=Et.getUnsignedByte();for(i=0;i<Et.spellCount;i++){let t=Et.getUnsignedByte();Et.spellRunesId.push(new Int32Array(t));for(let e=0;e<t;e++)Et.spellRunesId[i][e]=Et.getUnsignedShort()}for(i=0;i<Et.spellCount;i++){let t=Et.getUnsignedByte();Et.spellRunesCount.push(new Int32Array(t));for(let e=0;e<t;e++)Et.spellRunesCount[i][e]=Et.getUnsignedByte()}for(Et.prayerCount=Et.getUnsignedShort(),Et.prayerName=[],Et.prayerDescription=[],Et.prayerLevel=new Int32Array(Et.prayerCount),Et.prayerDrain=new Int32Array(Et.prayerCount),i=0;i<Et.prayerCount;i++)Et.prayerName.push(Et.getString());for(i=0;i<Et.prayerCount;i++)Et.prayerDescription.push(Et.getString());for(i=0;i<Et.prayerCount;i++)Et.prayerLevel[i]=Et.getUnsignedByte();for(i=0;i<Et.prayerCount;i++)Et.prayerDrain[i]=Et.getUnsignedByte();Et.dataString=null,Et.dataInteger=null}}Et.modelName=[],Et.modelName.length=5e3,Et.modelName.fill(null),Et.textureName=null,Et.textureSubtypeName=null,Et.objectModelIndex=null,Et.objectWidth=null,Et.objectHeight=null,Et.objectType=null,Et.objectElevation=null,Et.spellCount=0,Et.npcWidth=null,Et.npcHeight=null,Et.npcSprite=null,Et.npcAttack=null,Et.npcStrength=null,Et.npcHits=null,Et.npcDefense=null,Et.npcAttackable=null,Et.spellLevel=null,Et.spellRunesRequired=null,Et.spellType=null,Et.spellRunesId=null,Et.spellRunesCount=null,Et.itemCount=0,Et.itemSpriteCount=0,Et.npcColourHair=null,Et.npcColourTop=null,Et.npcColorBottom=null,Et.npcColourSkin=null,Et.wallObjectHeight=null,Et.wallObjectTextureFront=null,Et.wallObjectTextureBack=null,Et.wallObjectAdjacent=null,Et.wallObjectInvisible=null,Et.tileCount=0,Et.animationCharacterColour=null,Et.animationSomething=null,Et.animationHasA=null,Et.animationHasF=null,Et.animationNumber=null,Et.wallObjectCount=0,Et.prayerLevel=null,Et.prayerDrain=null,Et.tileDecoration=null,Et.overlays=null,Et.tileAdjacent=null,Et.modelCount=0,Et.roofHeight=null,Et.roofNumVertices=null,Et.prayerCount=0,Et.itemName=null,Et.itemDescription=null,Et.itemCommand=null,Et.projectileSprite=0,Et.npcCount=0,Et.spellName=null,Et.spellDescription=null,Et.textureCount=0,Et.wallObjectName=null,Et.wallObjectDescription=null,Et.wallObjectCommand1=null,Et.wallObjectCommand2=null,Et.roofCount=0,Et.objectCount=0,Et.npcName=null,Et.npcDescription=null,Et.npcCommand=null,Et.animationName=null,Et.itemPicture=null,Et.itemBasePrice=null,Et.itemUnused=null,Et.itemWearable=null,Et.itemMask=null,Et.itemSpecial=null,Et.itemMembers=null,Et.animationCount=0,Et.prayerName=null,Et.prayerDescription=null,Et.objectName=null,Et.objectDescription=null,Et.objectCommand1=null,Et.objectCommand2=null,Et.npcWalkModel=null,Et.npcCombatModel=null,Et.npcCombatAnimation=null,Et.dataString=null,Et.dataInteger=null,Et.stringOffset=0,Et.offset=0;class Bt{constructor(){this.minPlaneX=0,this.minPlaneY=0,this.maxPlaneX=0,this.maxPlaneY=0,this.minZ=0,this.maxZ=0,this.model=null,this.face=0,this.depth=0,this.normalX=0,this.normalY=0,this.normalZ=0,this.visibility=0,this.facefill=0,this.skipSomething=!1,this.index=0,this.index2=0}}class Pt{constructor(){this.startX=0,this.endX=0,this.startS=0,this.endS=0}}class Ot{constructor(t,e,i,s){this.lastVisiblePolygonsCount=0,this.anIntArray377=null,this.textureCount=0,this.textureColoursUsed=null,this.textureColourList=null,this.textureDimension=null,this.textureCacheIndices=null,this.texturePixels=null,this.textureBackTransparent=null,this.textureColours64=null,this.textureColours128=null,this.scanlines=null,this.minY=0,this.maxY=0,this.interlace=!1,this.mouseX=0,this.mouseY=0,this.mousePickedCount=0,this.newStart=0,this.newEnd=0,this.cameraX=0,this.cameraY=0,this.cameraZ=0,this.cameraYaw=0,this.cameraPitch=0,this.cameraRoll=0,this.rampCount=50,this.gradientBase=new Int32Array(this.rampCount),this.gradientRamps=[];for(let t=0;t<this.rampCount;t+=1)this.gradientRamps.push(new Int32Array(256));this.clipNear=5,this.clipFar3d=1e3,this.clipFar2d=1e3,this.fogZFalloff=20,this.fogZDistance=10,this.wideBand=!1,this.mousePickingActive=!1,this.mousePickedMax=100,this.mousePickedModels=new Array(this.mousePickedMax),this.mousePickedFaces=new Uint32Array(this.mousePickedMax),this.width=512,this.clipX=256,this.clipY=192,this.baseX=256,this.baseY=256,this.viewDistance=8,this.normalMagnitude=4,this.planeX=new Int32Array(40),this.planeY=new Int32Array(40),this.vertexShade=new Int32Array(40),this.vertexX=new Int32Array(40),this.vertexY=new Int32Array(40),this.vertexZ=new Int32Array(40),this.interlace=!1,this.surface=t,this.clipX=t.width2/2|0,this.clipY=t.height2/2|0,this.raster=t.pixels,this.modelCount=0,this.maxModelCount=e,this.models=[],this.models.length=this.maxModelCount,this.models.fill(null),this.visiblePolygonsCount=0,this.visiblePolygons=[];for(let t=0;t<i;t++)this.visiblePolygons.push(new Bt);this.spriteCount=0,this.view={},this.spriteId=new Int32Array(s),this.spriteWidth=new Int32Array(s),this.spriteHeight=new Int32Array(s),this.spriteX=new Int32Array(s),this.spriteZ=new Int32Array(s),this.spriteY=new Int32Array(s),this.spriteTranslateX=new Int32Array(s),this.cameraX=0,this.cameraY=0,this.cameraZ=0,this.cameraYaw=0,this.cameraPitch=0,this.cameraRoll=0;for(let t=0;t<256;t++)Ot.sin512Cache[t]=32768*Math.sin(.02454369*t)|0,Ot.sin512Cache[t+256]=32768*Math.cos(.02454369*t)|0;for(let t=0;t<1024;t++)Ot.sin2048Cache[t]=32768*Math.sin(.00613592315*t)|0,Ot.sin2048Cache[t+1024]=32768*Math.cos(.00613592315*t)|0}static textureScanline(t,e,i,s,r,n,o,a,h,l,u,c,d,m){if(u<=0)return;let p=0,f=0,g=0;0!==o&&(i=r/o<<7,s=n/o<<7),i<0?i=0:i>16256&&(i=16256),r+=a,n+=h,0!==(o+=l)&&(p=r/o<<7,f=n/o<<7),p<0?p=0:p>16256&&(p=16256);let S=p-i>>4,w=f-s>>4;for(let y=u>>4;y>0;y--)i+=6291456&d,g=d>>23,d+=m,t[c++]=e[(16256&s)+(i>>7)]>>>g,i+=S,s+=w,t[c++]=e[(16256&s)+(i>>7)]>>>g,i+=S,s+=w,t[c++]=e[(16256&s)+(i>>7)]>>>g,i+=S,s+=w,t[c++]=e[(16256&s)+(i>>7)]>>>g,s+=w,i=(16383&(i+=S))+(6291456&d),g=d>>23,d+=m,t[c++]=e[(16256&s)+(i>>7)]>>>g,i+=S,s+=w,t[c++]=e[(16256&s)+(i>>7)]>>>g,i+=S,s+=w,t[c++]=e[(16256&s)+(i>>7)]>>>g,i+=S,s+=w,t[c++]=e[(16256&s)+(i>>7)]>>>g,s+=w,i=(16383&(i+=S))+(6291456&d),g=d>>23,d+=m,t[c++]=e[(16256&s)+(i>>7)]>>>g,i+=S,s+=w,t[c++]=e[(16256&s)+(i>>7)]>>>g,i+=S,s+=w,t[c++]=e[(16256&s)+(i>>7)]>>>g,i+=S,s+=w,t[c++]=e[(16256&s)+(i>>7)]>>>g,s+=w,i=(16383&(i+=S))+(6291456&d),g=d>>23,d+=m,t[c++]=e[(16256&s)+(i>>7)]>>>g,i+=S,s+=w,t[c++]=e[(16256&s)+(i>>7)]>>>g,i+=S,s+=w,t[c++]=e[(16256&s)+(i>>7)]>>>g,i+=S,s+=w,t[c++]=e[(16256&s)+(i>>7)]>>>g,i=p,s=f,r+=a,n+=h,0!==(o+=l)&&(p=r/o<<7,f=n/o<<7),p<0?p=0:p>16256&&(p=16256),S=p-i>>4,w=f-s>>4;for(let r=0;r<(15&u);r++)0==(3&r)&&(i=(16383&i)+(6291456&d),g=d>>23,d+=m),t[c++]=e[(16256&s)+(i>>7)]>>>g,i+=S,s+=w}static textureTranslucentScanline(t,e,i,s,r,n,o,a,h,l,u,c,d,m){if(u<=0)return;let p=0,f=0,g=0;0!==o&&(i=r/o<<7,s=n/o<<7),i<0?i=0:i>16256&&(i=16256),r+=a,n+=h,0!==(o+=l)&&(p=r/o<<7,f=n/o<<7),p<0?p=0:p>16256&&(p=16256);let S=p-i>>4,w=f-s>>4;for(let y=u>>4;y>0;y--)i+=6291456&d,g=d>>23,d+=m,t[c++]=(e[(16256&s)+(i>>7)]>>>g)+(t[c]>>1&8355711),i+=S,s+=w,t[c++]=(e[(16256&s)+(i>>7)]>>>g)+(t[c]>>1&8355711),i+=S,s+=w,t[c++]=(e[(16256&s)+(i>>7)]>>>g)+(t[c]>>1&8355711),i+=S,s+=w,t[c++]=(e[(16256&s)+(i>>7)]>>>g)+(t[c]>>1&8355711),s+=w,i=(16383&(i+=S))+(6291456&d),g=d>>23,d+=m,t[c++]=(e[(16256&s)+(i>>7)]>>>g)+(t[c]>>1&8355711),i+=S,s+=w,t[c++]=(e[(16256&s)+(i>>7)]>>>g)+(t[c]>>1&8355711),i+=S,s+=w,t[c++]=(e[(16256&s)+(i>>7)]>>>g)+(t[c]>>1&8355711),i+=S,s+=w,t[c++]=(e[(16256&s)+(i>>7)]>>>g)+(t[c]>>1&8355711),s+=w,i=(16383&(i+=S))+(6291456&d),g=d>>23,d+=m,t[c++]=(e[(16256&s)+(i>>7)]>>>g)+(t[c]>>1&8355711),i+=S,s+=w,t[c++]=(e[(16256&s)+(i>>7)]>>>g)+(t[c]>>1&8355711),i+=S,s+=w,t[c++]=(e[(16256&s)+(i>>7)]>>>g)+(t[c]>>1&8355711),i+=S,s+=w,t[c++]=(e[(16256&s)+(i>>7)]>>>g)+(t[c]>>1&8355711),s+=w,i=(16383&(i+=S))+(6291456&d),g=d>>23,d+=m,t[c++]=(e[(16256&s)+(i>>7)]>>>g)+(t[c]>>1&8355711),i+=S,s+=w,t[c++]=(e[(16256&s)+(i>>7)]>>>g)+(t[c]>>1&8355711),i+=S,s+=w,t[c++]=(e[(16256&s)+(i>>7)]>>>g)+(t[c]>>1&8355711),i+=S,s+=w,t[c++]=(e[(16256&s)+(i>>7)]>>>g)+(t[c]>>1&8355711),i=p,s=f,r+=a,n+=h,0!==(o+=l)&&(p=r/o<<7,f=n/o<<7),p<0?p=0:p>16256&&(p=16256),S=p-i>>4,w=f-s>>4;for(let r=0;r<(15&u);r++)0==(3&r)&&(i=(16383&i)+(6291456&d),g=d>>23,d+=m),t[c++]=(e[(16256&s)+(i>>7)]>>>g)+(t[c]>>1&8355711),i+=S,s+=w}static textureBackTranslucentScanline(t,e,i,s,r,n,o,a,h,l,u,c,d,m,p){if(c<=0)return;let f=0,g=0;p<<=2,0!==a&&(f=n/a<<7,g=o/a<<7),f<0?f=0:f>16256&&(f=16256);for(let S=c;S>0;S-=16){n+=h,o+=l,i=f,s=g,0!==(a+=u)&&(f=n/a<<7,g=o/a<<7),f<0?f=0:f>16256&&(f=16256);let c=f-i>>4,w=g-s>>4,y=m>>23;if(i+=6291456&m,m+=p,S<16)for(let n=0;n<S;n++)0!=(e=r[(16256&s)+(i>>7)]>>>y)&&(t[d]=e),d++,i+=c,s+=w,3==(3&n)&&(i=(16383&i)+(6291456&m),y=m>>23,m+=p);else 0!=(e=r[(16256&s)+(i>>7)]>>>y)&&(t[d]=e),d++,0!=(e=r[(16256&(s+=w))+((i+=c)>>7)]>>>y)&&(t[d]=e),d++,0!=(e=r[(16256&(s+=w))+((i+=c)>>7)]>>>y)&&(t[d]=e),d++,0!=(e=r[(16256&(s+=w))+((i+=c)>>7)]>>>y)&&(t[d]=e),d++,i=(16383&(i+=c))+(6291456&m),y=m>>23,m+=p,0!=(e=r[(16256&(s+=w))+(i>>7)]>>>y)&&(t[d]=e),d++,0!=(e=r[(16256&(s+=w))+((i+=c)>>7)]>>>y)&&(t[d]=e),d++,0!=(e=r[(16256&(s+=w))+((i+=c)>>7)]>>>y)&&(t[d]=e),d++,0!=(e=r[(16256&(s+=w))+((i+=c)>>7)]>>>y)&&(t[d]=e),d++,i=(16383&(i+=c))+(6291456&m),y=m>>23,m+=p,0!=(e=r[(16256&(s+=w))+(i>>7)]>>>y)&&(t[d]=e),d++,0!=(e=r[(16256&(s+=w))+((i+=c)>>7)]>>>y)&&(t[d]=e),d++,0!=(e=r[(16256&(s+=w))+((i+=c)>>7)]>>>y)&&(t[d]=e),d++,0!=(e=r[(16256&(s+=w))+((i+=c)>>7)]>>>y)&&(t[d]=e),d++,i=(16383&(i+=c))+(6291456&m),y=m>>23,m+=p,0!=(e=r[(16256&(s+=w))+(i>>7)]>>>y)&&(t[d]=e),d++,0!=(e=r[(16256&(s+=w))+((i+=c)>>7)]>>>y)&&(t[d]=e),d++,0!=(e=r[(16256&(s+=w))+((i+=c)>>7)]>>>y)&&(t[d]=e),d++,0!=(e=r[(16256&(s+=w))+((i+=c)>>7)]>>>y)&&(t[d]=e),d++}}static textureScanline2(t,e,i,s,r,n,o,a,h,l,u,c,d,m){if(u<=0)return;let p=0,f=0;m<<=2,0!==o&&(p=r/o<<6,f=n/o<<6),p<0?p=0:p>4032&&(p=4032);for(let g=u;g>0;g-=16){r+=a,n+=h,i=p,s=f,0!==(o+=l)&&(p=r/o<<6,f=n/o<<6),p<0?p=0:p>4032&&(p=4032);let u=p-i>>4,S=f-s>>4,w=d>>20;if(i+=786432&d,d+=m,g<16)for(let r=0;r<g;r++)t[c++]=e[(4032&s)+(i>>6)]>>>w,i+=u,s+=S,3==(3&r)&&(i=(4095&i)+(786432&d),w=d>>20,d+=m);else t[c++]=e[(4032&s)+(i>>6)]>>>w,i+=u,s+=S,t[c++]=e[(4032&s)+(i>>6)]>>>w,i+=u,s+=S,t[c++]=e[(4032&s)+(i>>6)]>>>w,i+=u,s+=S,t[c++]=e[(4032&s)+(i>>6)]>>>w,s+=S,i=(4095&(i+=u))+(786432&d),w=d>>20,d+=m,t[c++]=e[(4032&s)+(i>>6)]>>>w,i+=u,s+=S,t[c++]=e[(4032&s)+(i>>6)]>>>w,i+=u,s+=S,t[c++]=e[(4032&s)+(i>>6)]>>>w,i+=u,s+=S,t[c++]=e[(4032&s)+(i>>6)]>>>w,s+=S,i=(4095&(i+=u))+(786432&d),w=d>>20,d+=m,t[c++]=e[(4032&s)+(i>>6)]>>>w,i+=u,s+=S,t[c++]=e[(4032&s)+(i>>6)]>>>w,i+=u,s+=S,t[c++]=e[(4032&s)+(i>>6)]>>>w,i+=u,s+=S,t[c++]=e[(4032&s)+(i>>6)]>>>w,s+=S,i=(4095&(i+=u))+(786432&d),w=d>>20,d+=m,t[c++]=e[(4032&s)+(i>>6)]>>>w,i+=u,s+=S,t[c++]=e[(4032&s)+(i>>6)]>>>w,i+=u,s+=S,t[c++]=e[(4032&s)+(i>>6)]>>>w,i+=u,s+=S,t[c++]=e[(4032&s)+(i>>6)]>>>w}}static textureTranslucentScanline2(t,e,i,s,r,n,o,a,h,l,u,c,d,m){if(u<=0)return;let p=0,f=0;m<<=2,0!==o&&(p=r/o<<6,f=n/o<<6),p<0?p=0:p>4032&&(p=4032);for(let g=u;g>0;g-=16){r+=a,n+=h,i=p,s=f,0!==(o+=l)&&(p=r/o<<6,f=n/o<<6),p<0?p=0:p>4032&&(p=4032);let u=p-i>>4,S=f-s>>4,w=d>>20;if(i+=786432&d,d+=m,g<16)for(let r=0;r<g;r++)t[c++]=(e[(4032&s)+(i>>6)]>>>w)+(t[c]>>1&8355711),i+=u,s+=S,3==(3&r)&&(i=(4095&i)+(786432&d),w=d>>20,d+=m);else t[c++]=(e[(4032&s)+(i>>6)]>>>w)+(t[c]>>1&8355711),i+=u,s+=S,t[c++]=(e[(4032&s)+(i>>6)]>>>w)+(t[c]>>1&8355711),i+=u,s+=S,t[c++]=(e[(4032&s)+(i>>6)]>>>w)+(t[c]>>1&8355711),i+=u,s+=S,t[c++]=(e[(4032&s)+(i>>6)]>>>w)+(t[c]>>1&8355711),s+=S,i=(4095&(i+=u))+(786432&d),w=d>>20,d+=m,t[c++]=(e[(4032&s)+(i>>6)]>>>w)+(t[c]>>1&8355711),i+=u,s+=S,t[c++]=(e[(4032&s)+(i>>6)]>>>w)+(t[c]>>1&8355711),i+=u,s+=S,t[c++]=(e[(4032&s)+(i>>6)]>>>w)+(t[c]>>1&8355711),i+=u,s+=S,t[c++]=(e[(4032&s)+(i>>6)]>>>w)+(t[c]>>1&8355711),s+=S,i=(4095&(i+=u))+(786432&d),w=d>>20,d+=m,t[c++]=(e[(4032&s)+(i>>6)]>>>w)+(t[c]>>1&8355711),i+=u,s+=S,t[c++]=(e[(4032&s)+(i>>6)]>>>w)+(t[c]>>1&8355711),i+=u,s+=S,t[c++]=(e[(4032&s)+(i>>6)]>>>w)+(t[c]>>1&8355711),i+=u,s+=S,t[c++]=(e[(4032&s)+(i>>6)]>>>w)+(t[c]>>1&8355711),s+=S,i=(4095&(i+=u))+(786432&d),w=d>>20,d+=m,t[c++]=(e[(4032&s)+(i>>6)]>>>w)+(t[c]>>1&8355711),i+=u,s+=S,t[c++]=(e[(4032&s)+(i>>6)]>>>w)+(t[c]>>1&8355711),i+=u,s+=S,t[c++]=(e[(4032&s)+(i>>6)]>>>w)+(t[c]>>1&8355711),i+=u,s+=S,t[c++]=(e[(4032&s)+(i>>6)]>>>w)+(t[c]>>1&8355711)}}static textureBackTranslucentScanline2(t,e,i,s,r,n,o,a,h,l,u,c,d,m,p){if(c<=0)return;let f=0,g=0;p<<=2,0!==a&&(f=n/a<<6,g=o/a<<6),f<0?f=0:f>4032&&(f=4032);for(let S=c;S>0;S-=16){n+=h,o+=l,i=f,s=g,0!==(a+=u)&&(f=n/a<<6,g=o/a<<6),f<0?f=0:f>4032&&(f=4032);let c=f-i>>4,w=g-s>>4,y=m>>20;if(i+=786432&m,m+=p,S<16)for(let n=0;n<S;n++)0!=(e=r[(4032&s)+(i>>6)]>>>y)&&(t[d]=e),d++,i+=c,s+=w,3==(3&n)&&(i=(4095&i)+(786432&m),y=m>>20,m+=p);else 0!=(e=r[(4032&s)+(i>>6)]>>>y)&&(t[d]=e),d++,0!=(e=r[(4032&(s+=w))+((i+=c)>>6)]>>>y)&&(t[d]=e),d++,0!=(e=r[(4032&(s+=w))+((i+=c)>>6)]>>>y)&&(t[d]=e),d++,0!=(e=r[(4032&(s+=w))+((i+=c)>>6)]>>>y)&&(t[d]=e),d++,i=(4095&(i+=c))+(786432&m),y=m>>20,m+=p,0!=(e=r[(4032&(s+=w))+(i>>6)]>>>y)&&(t[d]=e),d++,0!=(e=r[(4032&(s+=w))+((i+=c)>>6)]>>>y)&&(t[d]=e),d++,0!=(e=r[(4032&(s+=w))+((i+=c)>>6)]>>>y)&&(t[d]=e),d++,0!=(e=r[(4032&(s+=w))+((i+=c)>>6)]>>>y)&&(t[d]=e),d++,i=(4095&(i+=c))+(786432&m),y=m>>20,m+=p,0!=(e=r[(4032&(s+=w))+(i>>6)]>>>y)&&(t[d]=e),d++,0!=(e=r[(4032&(s+=w))+((i+=c)>>6)]>>>y)&&(t[d]=e),d++,0!=(e=r[(4032&(s+=w))+((i+=c)>>6)]>>>y)&&(t[d]=e),d++,0!=(e=r[(4032&(s+=w))+((i+=c)>>6)]>>>y)&&(t[d]=e),d++,i=(4095&(i+=c))+(786432&m),y=m>>20,m+=p,0!=(e=r[(4032&(s+=w))+(i>>6)]>>>y)&&(t[d]=e),d++,0!=(e=r[(4032&(s+=w))+((i+=c)>>6)]>>>y)&&(t[d]=e),d++,0!=(e=r[(4032&(s+=w))+((i+=c)>>6)]>>>y)&&(t[d]=e),d++,0!=(e=r[(4032&(s+=w))+((i+=c)>>6)]>>>y)&&(t[d]=e),d++}}static gradientScanline(t,e,i,s,r,n,o){if(e>=0)return;o<<=1,s=r[n>>8&255],n+=o;let a=e/8|0;for(let e=a;e<0;e++)t[i++]=s,t[i++]=s,s=r[n>>8&255],n+=o,t[i++]=s,t[i++]=s,s=r[n>>8&255],n+=o,t[i++]=s,t[i++]=s,s=r[n>>8&255],n+=o,t[i++]=s,t[i++]=s,s=r[n>>8&255],n+=o;a=-e%8;for(let e=0;e<a;e++)t[i++]=s,1==(1&e)&&(s=r[n>>8&255],n+=o)}static textureGradientScanline(t,e,i,s,r,n,o){if(e>=0)return;o<<=2,s=r[n>>8&255],n+=o;let a=e/16|0;for(let e=a;e<0;e++)t[i++]=s+(t[i]>>1&8355711),t[i++]=s+(t[i]>>1&8355711),t[i++]=s+(t[i]>>1&8355711),t[i++]=s+(t[i]>>1&8355711),s=r[n>>8&255],n+=o,t[i++]=s+(t[i]>>1&8355711),t[i++]=s+(t[i]>>1&8355711),t[i++]=s+(t[i]>>1&8355711),t[i++]=s+(t[i]>>1&8355711),s=r[n>>8&255],n+=o,t[i++]=s+(t[i]>>1&8355711),t[i++]=s+(t[i]>>1&8355711),t[i++]=s+(t[i]>>1&8355711),t[i++]=s+(t[i]>>1&8355711),s=r[n>>8&255],n+=o,t[i++]=s+(t[i]>>1&8355711),t[i++]=s+(t[i]>>1&8355711),t[i++]=s+(t[i]>>1&8355711),t[i++]=s+(t[i]>>1&8355711),s=r[n>>8&255],n+=o;a=-e%16;for(let e=0;e<a;e++)t[i++]=s+(t[i]>>1&8355711),3==(3&e)&&(s=r[n>>8&255],n+=o,n+=o)}static gradientScanline2(t,e,i,s,r,n,o){if(e>=0)return;o<<=2,s=r[n>>8&255],n+=o;let a=e/16|0;for(let e=a;e<0;e++)t[i++]=s,t[i++]=s,t[i++]=s,t[i++]=s,s=r[n>>8&255],n+=o,t[i++]=s,t[i++]=s,t[i++]=s,t[i++]=s,s=r[n>>8&255],n+=o,t[i++]=s,t[i++]=s,t[i++]=s,t[i++]=s,s=r[n>>8&255],n+=o,t[i++]=s,t[i++]=s,t[i++]=s,t[i++]=s,s=r[n>>8&255],n+=o;a=-e%16;for(let e=0;e<a;e++)t[i++]=s,3==(3&e)&&(s=r[n>>8&255],n+=o)}static rgb(t,e,i){return-1-1024*(t/8|0)-32*(e/8|0)-(i/8|0)}addModel(t){null===t&&console.log("Warning tried to add null object!"),this.modelCount<this.maxModelCount&&(this.models[this.modelCount++]=t)}removeModel(t){for(let e=0;e<this.modelCount;e++)if(this.models[e]===t){this.modelCount--;for(let t=e;t<this.modelCount;t++)this.models[t]=this.models[t+1]}}dispose(){this.clear();for(let t=0;t<this.modelCount;t++)this.models[t]=null;this.modelCount=0}clear(){this.spriteCount=0,this.view.clear()}reduceSprites(t){this.spriteCount-=t,this.view.reduce(t,2*t),this.spriteCount<0&&(this.spriteCount=0)}addSprite(t,e,i,s,r,n,o){this.spriteId[this.spriteCount]=t,this.spriteX[this.spriteCount]=e,this.spriteZ[this.spriteCount]=i,this.spriteY[this.spriteCount]=s,this.spriteWidth[this.spriteCount]=r,this.spriteHeight[this.spriteCount]=n,this.spriteTranslateX[this.spriteCount]=0;let a=this.view.createVertex(e,i,s),h=this.view.createVertex(e,i-n,s),l=new Int32Array([a,h]);return this.view.createFace(2,l,0,0),this.view.faceTag[this.spriteCount]=o,this.view.isLocalPlayer[this.spriteCount++]=0,this.spriteCount-1}setLocalPlayer(t){this.view.isLocalPlayer[t]=1}setSpriteTranslateX(t,e){this.spriteTranslateX[t]=e}setMouseLoc(t,e){this.mouseX=t-this.baseX,this.mouseY=e,this.mousePickedCount=0,this.mousePickingActive=!0}getMousePickedCount(){return this.mousePickedCount}getMousePickedFaces(){return this.mousePickedFaces}getMousePickedModels(){return this.mousePickedModels}setBounds(t,e,i,s,r,n){this.clipX=i,this.clipY=s,this.baseX=t,this.baseY=e,this.width=r,this.viewDistance=n,this.scanlines=[];for(let t=0;t<s+e;t++)this.scanlines.push(new Pt)}polygonsQSort(t,e,i){if(e<i){let s=e-1,r=i+1,n=(e+i)/2|0,o=t[n];t[n]=t[e],t[e]=o;let a=o.depth;for(;s<r;){do{r--}while(t[r].depth<a);do{s++}while(t[s].depth>a);if(s<r){let e=t[s];t[s]=t[r],t[r]=e}}this.polygonsQSort(t,e,r),this.polygonsQSort(t,r+1,i)}}polygonsIntersectSort(t,e,i){for(let t=0;t<=i;t++)e[t].skipSomething=!1,e[t].index=t,e[t].index2=-1;let s=0;for(;;){for(;e[s].skipSomething;)s++;if(s===i)return;let r=e[s];r.skipSomething=!0;let n=s,o=s+t;o>=i&&(o=i-1);for(let t=o;t>=n+1;t--){let i=e[t];r.minPlaneX<i.maxPlaneX&&i.minPlaneX<r.maxPlaneX&&r.minPlaneY<i.maxPlaneY&&i.minPlaneY<r.maxPlaneY&&r.index!==i.index2&&!this.separatePolygon(r,i)&&this.heuristicPolygon(i,r)&&(this.polygonsOrder(e,n,t),e[t]!==i&&t++,n=this.newStart,i.index2=r.index)}}}polygonsOrder(t,e,i){for(;;){let s=t[e];for(let r=e+1;r<=i;r++){let n=t[r];if(!this.separatePolygon(n,s))break;if(t[e]=n,t[r]=s,(e=r)===i)return this.newStart=e,this.newEnd=e-1,!0}let r=t[i];for(let s=i-1;s>=e;s--){let n=t[s];if(!this.separatePolygon(r,n))break;if(t[i]=n,t[s]=r,e===(i=s))return this.newStart=i+1,this.newEnd=i,!0}if(e+1>=i)return this.newStart=e,this.newEnd=i,!1;if(!this.polygonsOrder(t,e+1,i))return this.newStart=e,!1;i=this.newEnd}}setFrustum(t,e,i){let s=1024-this.cameraYaw&1023,r=1024-this.cameraPitch&1023,n=1024-this.cameraRoll&1023;if(0!==n){let i=Ot.sin2048Cache[n],s=Ot.sin2048Cache[n+1024],r=e*i+t*s>>15;e=e*s-t*i>>15,t=r}if(0!==s){let t=Ot.sin2048Cache[s],r=Ot.sin2048Cache[s+1024],n=e*r-i*t>>15;i=e*t+i*r>>15,e=n}if(0!==r){let e=Ot.sin2048Cache[r],s=Ot.sin2048Cache[r+1024],n=i*e+t*s>>15;i=i*s-t*e>>15,t=n}t<Ot.frustumMaxX&&(Ot.frustumMaxX=t),t>Ot.frustumMinX&&(Ot.frustumMinX=t),e<Ot.frustumMaxY&&(Ot.frustumMaxY=e),e>Ot.frustumMinY&&(Ot.frustumMinY=e),i<Ot.frustumFarZ&&(Ot.frustumFarZ=i),i>Ot.frustumNearZ&&(Ot.frustumNearZ=i)}render(){this.interlace=this.surface.interlace;let t=this.clipX*this.clipFar3d>>this.viewDistance,e=this.clipY*this.clipFar3d>>this.viewDistance;Ot.frustumMaxX=0,Ot.frustumMinX=0,Ot.frustumMaxY=0,Ot.frustumMinY=0,Ot.frustumFarZ=0,Ot.frustumNearZ=0,this.setFrustum(-t,-e,this.clipFar3d),this.setFrustum(-t,e,this.clipFar3d),this.setFrustum(t,-e,this.clipFar3d),this.setFrustum(t,e,this.clipFar3d),this.setFrustum(-this.clipX,-this.clipY,0),this.setFrustum(-this.clipX,this.clipY,0),this.setFrustum(this.clipX,-this.clipY,0),this.setFrustum(this.clipX,this.clipY,0),Ot.frustumMaxX+=this.cameraX,Ot.frustumMinX+=this.cameraX,Ot.frustumMaxY+=this.cameraY,Ot.frustumMinY+=this.cameraY,Ot.frustumFarZ+=this.cameraZ,Ot.frustumNearZ+=this.cameraZ,this.models[this.modelCount]=this.view,this.view.transformState=2;for(let t=0;t<this.modelCount;t++)this.models[t].project(this.cameraX,this.cameraY,this.cameraZ,this.cameraYaw,this.cameraPitch,this.cameraRoll,this.viewDistance,this.clipNear);this.models[this.modelCount].project(this.cameraX,this.cameraY,this.cameraZ,this.cameraYaw,this.cameraPitch,this.cameraRoll,this.viewDistance,this.clipNear),this.visiblePolygonsCount=0;for(let t=0;t<this.modelCount;t++){let e=this.models[t];if(e.visible)for(let t=0;t<e.numFaces;t++){let i=e.faceNumVertices[t],s=e.faceVertices[t],r=!1;for(let t=0;t<i;t++){let i=e.projectVertexZ[s[t]];if(!(i<=this.clipNear||i>=this.clipFar3d)){r=!0;break}}if(r){let r=0;for(let t=0;t<i;t++){let i=e.vertexViewX[s[t]];if(i>-this.clipX&&(r|=1),i<this.clipX&&(r|=2),3===r)break}if(3===r){let r=0;for(let t=0;t<i;t++){let i=e.vertexViewY[s[t]];if(i>-this.clipY&&(r|=1),i<this.clipY&&(r|=2),3===r)break}if(3===r){let r=this.visiblePolygons[this.visiblePolygonsCount];r.model=e,r.face=t,this.initialisePolygon3D(this.visiblePolygonsCount);let n=0;if(n=r.visibility<0?e.faceFillFront[t]:e.faceFillBack[t],12345678!==n){let t=0;for(let r=0;r<i;r++)t+=e.projectVertexZ[s[r]];r.depth=(t/i|0)+e.depth,r.facefill=n,this.visiblePolygonsCount++}}}}}}let i=this.view;if(i.visible)for(let t=0;t<i.numFaces;t++){let e=i.faceVertices[t],s=e[0],r=i.vertexViewX[s],n=i.vertexViewY[s],o=i.projectVertexZ[s];if(o>this.clipNear&&o<this.clipFar2d){let s=(this.spriteWidth[t]<<this.viewDistance)/o|0,a=(this.spriteHeight[t]<<this.viewDistance)/o|0;if(r-(s/2|0)<=this.clipX&&r+(s/2|0)>=-this.clipX&&n-a<=this.clipY&&n>=-this.clipY){let s=this.visiblePolygons[this.visiblePolygonsCount];s.model=i,s.face=t,this.initialisePolygon2D(this.visiblePolygonsCount),s.depth=(o+i.projectVertexZ[e[1]])/2|0,this.visiblePolygonsCount++}}}if(0!==this.visiblePolygonsCount){this.lastVisiblePolygonsCount=this.visiblePolygonsCount,this.polygonsQSort(this.visiblePolygons,0,this.visiblePolygonsCount-1),this.polygonsIntersectSort(100,this.visiblePolygons,this.visiblePolygonsCount);for(let t=0;t<this.visiblePolygonsCount;t++){let e=this.visiblePolygons[t],i=e.model,s=e.face;if(i===this.view){let t=i.faceVertices[s],e=t[0],r=i.vertexViewX[e],n=i.vertexViewY[e],o=i.projectVertexZ[e],a=(this.spriteWidth[s]<<this.viewDistance)/o|0,h=(this.spriteHeight[s]<<this.viewDistance)/o|0,l=i.vertexViewX[t[1]]-r,u=r-(a/2|0),c=this.baseY+n-h;this.surface._spriteClipping_from7(u+this.baseX,c,a,h,this.spriteId[s],l,(256<<this.viewDistance)/o|0),this.mousePickingActive&&this.mousePickedCount<this.mousePickedMax&&(u+=(this.spriteTranslateX[s]<<this.viewDistance)/o|0,this.mouseY>=c&&this.mouseY<=c+h&&this.mouseX>=u&&this.mouseX<=u+a&&!i.unpickable&&0===i.isLocalPlayer[s]&&(this.mousePickedModels[this.mousePickedCount]=i,this.mousePickedFaces[this.mousePickedCount]=s,this.mousePickedCount++))}else{let t=0,r=0,n=i.faceNumVertices[s],o=i.faceVertices[s];12345678!==i.faceIntensity[s]&&(r=e.visibility<0?i.lightAmbience-i.faceIntensity[s]:i.lightAmbience+i.faceIntensity[s]);for(let a=0;a<n;a++){let h=o[a];if(this.vertexX[a]=i.projectVertexX[h],this.vertexY[a]=i.projectVertexY[h],this.vertexZ[a]=i.projectVertexZ[h],12345678===i.faceIntensity[s]&&(r=e.visibility<0?i.lightAmbience-i.vertexIntensity[h]+i.vertexAmbience[h]:i.lightAmbience+i.vertexIntensity[h]+i.vertexAmbience[h]),i.projectVertexZ[h]>=this.clipNear)this.planeX[t]=i.vertexViewX[h],this.planeY[t]=i.vertexViewY[h],this.vertexShade[t]=r,i.projectVertexZ[h]>this.fogZDistance&&(this.vertexShade[t]+=(i.projectVertexZ[h]-this.fogZDistance)/this.fogZFalloff|0),t++;else{let e=0;if(e=0===a?o[n-1]:o[a-1],i.projectVertexZ[e]>=this.clipNear){let s=i.projectVertexZ[h]-i.projectVertexZ[e],n=i.projectVertexX[h]-((i.projectVertexX[h]-i.projectVertexX[e])*(i.projectVertexZ[h]-this.clipNear)/s|0),o=i.projectVertexY[h]-((i.projectVertexY[h]-i.projectVertexY[e])*(i.projectVertexZ[h]-this.clipNear)/s|0);this.planeX[t]=(n<<this.viewDistance)/this.clipNear|0,this.planeY[t]=(o<<this.viewDistance)/this.clipNear|0,this.vertexShade[t]=r,t++}if(e=a===n-1?o[0]:o[a+1],i.projectVertexZ[e]>=this.clipNear){let s=i.projectVertexZ[h]-i.projectVertexZ[e],n=i.projectVertexX[h]-((i.projectVertexX[h]-i.projectVertexX[e])*(i.projectVertexZ[h]-this.clipNear)/s|0),o=i.projectVertexY[h]-((i.projectVertexY[h]-i.projectVertexY[e])*(i.projectVertexZ[h]-this.clipNear)/s|0);this.planeX[t]=(n<<this.viewDistance)/this.clipNear|0,this.planeY[t]=(o<<this.viewDistance)/this.clipNear|0,this.vertexShade[t]=r,t++}}}for(let t=0;t<n;t++)this.vertexShade[t]<0?this.vertexShade[t]=0:this.vertexShade[t]>255&&(this.vertexShade[t]=255),e.facefill>=0&&(1===this.textureDimension[e.facefill]?this.vertexShade[t]<<=9:this.vertexShade[t]<<=6);this.generateScanlines(0,0,0,0,t,this.planeX,this.planeY,this.vertexShade,i,s),this.maxY>this.minY&&this.rasterize(0,0,n,this.vertexX,this.vertexY,this.vertexZ,e.facefill,i)}}this.mousePickingActive=!1}}generateScanlines(t,e,i,s,r,n,o,a,h,l){if(3===r){let r=o[0]+this.baseY,h=o[1]+this.baseY,l=o[2]+this.baseY,u=n[0],c=n[1],d=n[2],m=a[0],p=a[1],f=a[2],g=this.baseY+this.clipY-1,S=0,w=0,y=0,I=0,C=12345678,b=-12345678;l!==r&&(w=(d-u<<8)/(l-r)|0,I=(f-m<<8)/(l-r)|0,r<l?(S=u<<8,y=m<<8,C=r,b=l):(S=d<<8,y=f<<8,C=l,b=r),C<0&&(S-=w*C,y-=I*C,C=0),b>g&&(b=g));let T=0,x=0,v=0,A=0,L=12345678,M=-12345678;h!==r&&(x=(c-u<<8)/(h-r)|0,A=(p-m<<8)/(h-r)|0,r<h?(T=u<<8,v=m<<8,L=r,M=h):(T=c<<8,v=p<<8,L=h,M=r),L<0&&(T-=x*L|0,v-=A*L|0,L=0),M>g&&(M=g));let k=0,E=0,B=0,P=0,O=12345678,Y=-12345678;l!==h&&(E=(d-c<<8)/(l-h)|0,P=(f-p<<8)/(l-h)|0,h<l?(k=c<<8,B=p<<8,O=h,Y=l):(k=d<<8,B=f<<8,O=l,Y=h),O<0&&(k-=E*O|0,B-=P*O|0,O=0),Y>g&&(Y=g)),this.minY=C,L<this.minY&&(this.minY=L),O<this.minY&&(this.minY=O),this.maxY=b,M>this.maxY&&(this.maxY=M),Y>this.maxY&&(this.maxY=Y);let D=0;for(i=this.minY;i<this.maxY;i++){i>=C&&i<b?(t=e=S,s=D=y,S+=w,y+=I):(t=655360,e=-655360),i>=L&&i<M&&(T<t&&(t=T,s=v),T>e&&(e=T,D=v),T+=x,v+=A),i>=O&&i<Y&&(k<t&&(t=k,s=B),k>e&&(e=k,D=B),k+=E,B+=P);let r=this.scanlines[i];r.startX=t,r.endX=e,r.startS=s,r.endS=D}this.minY<this.baseY-this.clipY&&(this.minY=this.baseY-this.clipY)}else if(4===r){let r=o[0]+this.baseY,h=o[1]+this.baseY,l=o[2]+this.baseY,u=o[3]+this.baseY,c=n[0],d=n[1],m=n[2],p=n[3],f=a[0],g=a[1],S=a[2],w=a[3],y=this.baseY+this.clipY-1,I=0,C=0,b=0,T=0,x=12345678,v=-12345678;u!==r&&(C=(p-c<<8)/(u-r)|0,T=(w-f<<8)/(u-r)|0,r<u?(I=c<<8,b=f<<8,x=r,v=u):(I=p<<8,b=w<<8,x=u,v=r),x<0&&(I-=C*x,b-=T*x,x=0),v>y&&(v=y));let A=0,L=0,M=0,k=0,E=12345678,B=-12345678;h!==r&&(L=(d-c<<8)/(h-r)|0,k=(g-f<<8)/(h-r)|0,r<h?(A=c<<8,M=f<<8,E=r,B=h):(A=d<<8,M=g<<8,E=h,B=r),E<0&&(A-=L*E,M-=k*E,E=0),B>y&&(B=y));let P=0,O=0,Y=0,D=0,X=12345678,j=-12345678;l!==h&&(O=(m-d<<8)/(l-h)|0,D=(S-g<<8)/(l-h)|0,h<l?(P=d<<8,Y=g<<8,X=h,j=l):(P=m<<8,Y=S<<8,X=l,j=h),X<0&&(P-=O*X,Y-=D*X,X=0),j>y&&(j=y));let R=0,_=0,N=0,U=0,H=12345678,F=-12345678;u!==l&&(_=(p-m<<8)/(u-l)|0,U=(w-S<<8)/(u-l)|0,l<u?(R=m<<8,N=S<<8,H=l,F=u):(R=p<<8,N=w<<8,H=u,F=l),H<0&&(R-=_*H,N-=U*H,H=0),F>y&&(F=y)),this.minY=x,E<this.minY&&(this.minY=E),X<this.minY&&(this.minY=X),H<this.minY&&(this.minY=H),this.maxY=v,B>this.maxY&&(this.maxY=B),j>this.maxY&&(this.maxY=j),F>this.maxY&&(this.maxY=F);let W=0;for(i=this.minY;i<this.maxY;i++){i>=x&&i<v?(t=e=I,s=W=b,I+=C,b+=T):(t=655360,e=-655360),i>=E&&i<B&&(A<t&&(t=A,s=M),A>e&&(e=A,W=M),A+=L,M+=k),i>=X&&i<j&&(P<t&&(t=P,s=Y),P>e&&(e=P,W=Y),P+=O,Y+=D),i>=H&&i<F&&(R<t&&(t=R,s=N),R>e&&(e=R,W=N),R+=_,N+=U);let r=this.scanlines[i];r.startX=t,r.endX=e,r.startS=s,r.endS=W}this.minY<this.baseY-this.clipY&&(this.minY=this.baseY-this.clipY)}else{for(this.maxY=this.minY=o[0]+=this.baseY,i=1;i<r;i++){let t=0;(t=o[i]+=this.baseY)<this.minY?this.minY=t:t>this.maxY&&(this.maxY=t)}if(this.minY<this.baseY-this.clipY&&(this.minY=this.baseY-this.clipY),this.maxY>=this.baseY+this.clipY&&(this.maxY=this.baseY+this.clipY-1),this.minY>=this.maxY)return;for(i=this.minY;i<this.maxY;i++){let t=this.scanlines[i];t.startX=655360,t.endX=-655360}let t=r-1,e=o[0],s=o[t];if(e<s){let r=n[0]<<8,o=(n[t]-n[0]<<8)/(s-e)|0,h=a[0]<<8,l=(a[t]-a[0]<<8)/(s-e)|0;for(e<0&&(r-=o*e,h-=l*e,e=0),s>this.maxY&&(s=this.maxY),i=e;i<=s;i++){let t=this.scanlines[i];t.startX=t.endX=r,t.startS=t.endS=h,r+=o,h+=l}}else if(e>s){let r=n[t]<<8,o=(n[0]-n[t]<<8)/(e-s)|0,h=a[t]<<8,l=(a[0]-a[t]<<8)/(e-s)|0;for(s<0&&(r-=o*s,h-=l*s,s=0),e>this.maxY&&(e=this.maxY),i=s;i<=e;i++){let t=this.scanlines[i];t.startX=t.endX=r,t.startS=t.endS=h,r+=o,h+=l}}for(i=0;i<t;i++){let t=i+1,e=o[i],s=o[t];if(e<s){let r=n[i]<<8,o=(n[t]-n[i]<<8)/(s-e)|0,h=a[i]<<8,l=(a[t]-a[i]<<8)/(s-e)|0;e<0&&(r-=o*e,h-=l*e,e=0),s>this.maxY&&(s=this.maxY);for(let t=e;t<=s;t++){let e=this.scanlines[t];r<e.startX&&(e.startX=r,e.startS=h),r>e.endX&&(e.endX=r,e.endS=h),r+=o,h+=l}}else if(e>s){let r=n[t]<<8,o=(n[i]-n[t]<<8)/(e-s)|0,h=a[t]<<8,l=(a[i]-a[t]<<8)/(e-s)|0;s<0&&(r-=o*s,h-=l*s,s=0),e>this.maxY&&(e=this.maxY);for(let t=s;t<=e;t++){let e=this.scanlines[t];r<e.startX&&(e.startX=r,e.startS=h),r>e.endX&&(e.endX=r,e.endS=h),r+=o,h+=l}}}this.minY<this.baseY-this.clipY&&(this.minY=this.baseY-this.clipY)}if(this.mousePickingActive&&this.mousePickedCount<this.mousePickedMax&&this.mouseY>=this.minY&&this.mouseY<this.maxY){let t=this.scanlines[this.mouseY];this.mouseX>=t.startX>>8&&this.mouseX<=t.endX>>8&&t.startX<=t.endX&&!h.unpickable&&0===h.isLocalPlayer[l]&&(this.mousePickedModels[this.mousePickedCount]=h,this.mousePickedFaces[this.mousePickedCount]=l,this.mousePickedCount++)}}rasterize(t,e,i,s,r,n,o,a){if(-2===o)return;if(o>=0){o>=this.textureCount&&(o=0),this.prepareTexture(o);let h=s[0],l=r[0],u=n[0],c=h-s[1],d=l-r[1],m=u-n[1],p=s[--i]-h,f=r[i]-l,g=n[i]-u;if(1===this.textureDimension[o]){let i=p*l-f*h<<12,s=f*u-g*l<<5-this.viewDistance+7+4,r=g*h-p*u<<5-this.viewDistance+7,n=c*l-d*h<<12,S=d*u-m*l<<5-this.viewDistance+7+4,w=m*h-c*u<<5-this.viewDistance+7,y=d*p-c*f<<5,I=m*f-d*g<<5-this.viewDistance+4,C=c*g-m*p>>this.viewDistance-5,b=s>>4,T=S>>4,x=I>>4,v=this.minY-this.baseY,A=this.width,L=this.baseX+this.minY*A,M=1;if(i+=r*v,n+=w*v,y+=C*v,this.interlace&&(1==(1&this.minY)&&(this.minY++,i+=r,n+=w,y+=C,L+=A),r<<=1,w<<=1,C<<=1,A<<=1,M=2),a.textureTranslucent){for(t=this.minY;t<this.maxY;t+=M){let a=this.scanlines[t];e=a.startX>>8;let h=a.endX>>8,l=h-e;if(l<=0)i+=r,n+=w,y+=C,L+=A;else{let t=a.startS,u=(a.endS-t)/l|0;if(e<-this.clipX&&(t+=(-this.clipX-e)*u,l=h-(e=-this.clipX)),h>this.clipX){l=this.clipX-e}Ot.textureTranslucentScanline(this.raster,this.texturePixels[o],0,0,i+b*e,n+T*e,y+x*e,s,S,I,l,L+e,t,u<<2),i+=r,n+=w,y+=C,L+=A}}return}if(!this.textureBackTransparent[o]){for(t=this.minY;t<this.maxY;t+=M){let a=this.scanlines[t];e=a.startX>>8;let h=a.endX>>8,l=h-e;if(l<=0)i+=r,n+=w,y+=C,L+=A;else{let t=a.startS,u=(a.endS-t)/l|0;if(e<-this.clipX&&(t+=(-this.clipX-e)*u,l=h-(e=-this.clipX)),h>this.clipX){l=this.clipX-e}Ot.textureScanline(this.raster,this.texturePixels[o],0,0,i+b*e,n+T*e,y+x*e,s,S,I,l,L+e,t,u<<2),i+=r,n+=w,y+=C,L+=A}}return}for(t=this.minY;t<this.maxY;t+=M){let a=this.scanlines[t];e=a.startX>>8;let h=a.endX>>8,l=h-e;if(l<=0)i+=r,n+=w,y+=C,L+=A;else{let t=a.startS,u=(a.endS-t)/l|0;if(e<-this.clipX&&(t+=(-this.clipX-e)*u,l=h-(e=-this.clipX)),h>this.clipX){l=this.clipX-e}Ot.textureBackTranslucentScanline(this.raster,0,0,0,this.texturePixels[o],i+b*e,n+T*e,y+x*e,s,S,I,l,L+e,t,u),i+=r,n+=w,y+=C,L+=A}}return}let S=p*l-f*h<<11,w=f*u-g*l<<5-this.viewDistance+6+4,y=g*h-p*u<<5-this.viewDistance+6,I=c*l-d*h<<11,C=d*u-m*l<<5-this.viewDistance+6+4,b=m*h-c*u<<5-this.viewDistance+6,T=d*p-c*f<<5,x=m*f-d*g<<5-this.viewDistance+4,v=c*g-m*p>>this.viewDistance-5,A=w>>4,L=C>>4,M=x>>4,k=this.minY-this.baseY,E=this.width,B=this.baseX+this.minY*E,P=1;if(S+=y*k,I+=b*k,T+=v*k,this.interlace&&(1==(1&this.minY)&&(this.minY++,S+=y,I+=b,T+=v,B+=E),y<<=1,b<<=1,v<<=1,E<<=1,P=2),a.textureTranslucent){for(t=this.minY;t<this.maxY;t+=P){let i=this.scanlines[t];e=i.startX>>8;let s=i.endX>>8,r=s-e;if(r<=0)S+=y,I+=b,T+=v,B+=E;else{let t=i.startS,n=(i.endS-t)/r|0;if(e<-this.clipX&&(t+=(-this.clipX-e)*n,r=s-(e=-this.clipX)),s>this.clipX){r=this.clipX-e}Ot.textureTranslucentScanline2(this.raster,this.texturePixels[o],0,0,S+A*e,I+L*e,T+M*e,w,C,x,r,B+e,t,n),S+=y,I+=b,T+=v,B+=E}}return}if(!this.textureBackTransparent[o]){for(t=this.minY;t<this.maxY;t+=P){let i=this.scanlines[t];e=i.startX>>8;let s=i.endX>>8,r=s-e;if(r<=0)S+=y,I+=b,T+=v,B+=E;else{let t=i.startS,n=(i.endS-t)/r|0;if(e<-this.clipX&&(t+=(-this.clipX-e)*n,r=s-(e=-this.clipX)),s>this.clipX){r=this.clipX-e}Ot.textureScanline2(this.raster,this.texturePixels[o],0,0,S+A*e,I+L*e,T+M*e,w,C,x,r,B+e,t,n),S+=y,I+=b,T+=v,B+=E}}return}for(t=this.minY;t<this.maxY;t+=P){let i=this.scanlines[t];e=i.startX>>8;let s=i.endX>>8,r=s-e;if(r<=0)S+=y,I+=b,T+=v,B+=E;else{let t=i.startS,n=(i.endS-t)/r|0;if(e<-this.clipX&&(t+=(-this.clipX-e)*n,r=s-(e=-this.clipX)),s>this.clipX){r=this.clipX-e}Ot.textureBackTranslucentScanline2(this.raster,0,0,0,this.texturePixels[o],S+A*e,I+L*e,T+M*e,w,C,x,r,B+e,t,n),S+=y,I+=b,T+=v,B+=E}}return}for(let t=0;t<this.rampCount;t++){if(this.gradientBase[t]===o){this.anIntArray377=this.gradientRamps[t];break}if(t===this.rampCount-1){let t=Math.random()*this.rampCount|0;this.gradientBase[t]=o;let e=8*((o=-1-o)>>10&31),i=8*(o>>5&31),s=8*(31&o);for(let r=0;r<256;r++){let n=r*r,o=e*n>>16,a=i*n>>16,h=s*n>>16;this.gradientRamps[t][255-r]=(o<<16)+(a<<8)+h}this.anIntArray377=this.gradientRamps[t]}}let h=this.width,l=this.baseX+this.minY*h,u=1;if(this.interlace&&(1==(1&this.minY)&&(this.minY++,l+=h),h<<=1,u=2),a.transparent)for(t=this.minY;t<this.maxY;t+=u){let i=this.scanlines[t];e=i.startX>>8;let s=i.endX>>8,r=s-e;if(r<=0)l+=h;else{let t=i.startS,n=(i.endS-t)/r|0;if(e<-this.clipX&&(t+=(-this.clipX-e)*n,r=s-(e=-this.clipX)),s>this.clipX){r=this.clipX-e}Ot.textureGradientScanline(this.raster,-r,l+e,0,this.anIntArray377,t,n),l+=h}}else if(this.wideBand)for(t=this.minY;t<this.maxY;t+=u){let i=this.scanlines[t];e=i.startX>>8;let s=i.endX>>8,r=s-e;if(r<=0)l+=h;else{let t=i.startS,n=(i.endS-t)/r|0;if(e<-this.clipX&&(t+=(-this.clipX-e)*n,r=s-(e=-this.clipX)),s>this.clipX){r=this.clipX-e}Ot.gradientScanline(this.raster,-r,l+e,0,this.anIntArray377,t,n),l+=h}}else for(t=this.minY;t<this.maxY;t+=u){let i=this.scanlines[t];e=i.startX>>8;let s=i.endX>>8,r=s-e;if(r<=0)l+=h;else{let t=i.startS,n=(i.endS-t)/r|0;if(e<-this.clipX&&(t+=(-this.clipX-e)*n,r=s-(e=-this.clipX)),s>this.clipX){r=this.clipX-e}Ot.gradientScanline2(this.raster,-r,l+e,0,this.anIntArray377,t,n),l+=h}}}setCamera(t,e,i,s,r,n,o){s&=1023,r&=1023,n&=1023,this.cameraYaw=1024-s&1023,this.cameraPitch=1024-r&1023,this.cameraRoll=1024-n&1023;let a=0,h=0,l=o;if(0!==s){let t=Ot.sin2048Cache[s],e=Ot.sin2048Cache[s+1024],i=h*e-l*t>>15;l=h*t+l*e>>15,h=i}if(0!==r){let t=Ot.sin2048Cache[r],e=Ot.sin2048Cache[r+1024],i=l*t+a*e>>15;l=l*e-a*t>>15,a=i}if(0!==n){let t=Ot.sin2048Cache[n],e=Ot.sin2048Cache[n+1024],i=h*t+a*e>>15;h=h*e-a*t>>15,a=i}this.cameraX=t-a,this.cameraY=e-h,this.cameraZ=i-l}initialisePolygon3D(t){let e=this.visiblePolygons[t],i=e.model,s=e.face,r=i.faceVertices[s],n=i.faceNumVertices[s],o=i.normalScale[s],a=i.projectVertexX[r[0]],h=i.projectVertexY[r[0]],l=i.projectVertexZ[r[0]],u=i.projectVertexX[r[1]]-a,c=i.projectVertexY[r[1]]-h,d=i.projectVertexZ[r[1]]-l,m=i.projectVertexX[r[2]]-a,p=i.projectVertexY[r[2]]-h,f=i.projectVertexZ[r[2]]-l,g=c*f-p*d,S=d*m-f*u,w=u*p-m*c;if(-1===o){for(o=0;g>25e3||S>25e3||w>25e3||g<-25e3||S<-25e3||w<-25e3;w>>=1)o++,g>>=1,S>>=1;i.normalScale[s]=o,i.normalMagnitude[s]=this.normalMagnitude*Math.sqrt(g*g+S*S+w*w)|0}else g>>=o,S>>=o,w>>=o;e.visibility=a*g+h*S+l*w,e.normalX=g,e.normalY=S,e.normalZ=w;let y=i.projectVertexZ[r[0]],I=y,C=i.vertexViewX[r[0]],b=C,T=i.vertexViewY[r[0]],x=T;for(let t=1;t<n;t++){let e=i.projectVertexZ[r[t]];e>I?I=e:e<y&&(y=e),e=i.vertexViewX[r[t]],e>b?b=e:e<C&&(C=e),e=i.vertexViewY[r[t]],e>x?x=e:e<T&&(T=e)}e.minZ=y,e.maxZ=I,e.minPlaneX=C,e.maxPlaneX=b,e.minPlaneY=T,e.maxPlaneY=x}initialisePolygon2D(t){let e=this.visiblePolygons[t],i=e.model,s=e.face,r=i.faceVertices[s],n=i.projectVertexX[r[0]],o=i.projectVertexY[r[0]],a=i.projectVertexZ[r[0]];i.normalMagnitude[s]=1,i.normalScale[s]=0,e.visibility=0*n+0*o+1*a,e.normalX=0,e.normalY=0,e.normalZ=1;let h=i.projectVertexZ[r[0]],l=h,u=i.vertexViewX[r[0]],c=u;i.vertexViewX[r[1]]<u?u=i.vertexViewX[r[1]]:c=i.vertexViewX[r[1]];let d=i.vertexViewY[r[1]],m=i.vertexViewY[r[0]],p=i.projectVertexZ[r[1]];p>l?l=p:p<h&&(h=p),p=i.vertexViewX[r[1]],p>c?c=p:p<u&&(u=p),p=i.vertexViewY[r[1]],p>m?m=p:p<d&&(d=p),e.minZ=h,e.maxZ=l,e.minPlaneX=u-20,e.maxPlaneX=c+20,e.minPlaneY=d,e.maxPlaneY=m}separatePolygon(t,e){if(t.minPlaneX>=e.maxPlaneX)return!0;if(e.minPlaneX>=t.maxPlaneX)return!0;if(t.minPlaneY>=e.maxPlaneY)return!0;if(e.minPlaneY>=t.maxPlaneY)return!0;if(t.minZ>=e.maxZ)return!0;if(e.minZ>t.maxZ)return!1;let i,s,r,n,o=t.model,a=e.model,h=t.face,l=e.face,u=o.faceVertices[h],c=a.faceVertices[l],d=o.faceNumVertices[h],m=a.faceNumVertices[l],p=a.projectVertexX[c[0]],f=a.projectVertexY[c[0]],g=a.projectVertexZ[c[0]],S=e.normalX,w=e.normalY,y=e.normalZ,I=a.normalMagnitude[l],C=e.visibility,b=!1;for(let t=0;t<d;t++){let e=u[t],i=(p-o.projectVertexX[e])*S+(f-o.projectVertexY[e])*w+(g-o.projectVertexZ[e])*y;if(!(i>=-I||C>=0)||!(i<=I||C<=0)){b=!0;break}}if(!b)return!0;p=o.projectVertexX[u[0]],f=o.projectVertexY[u[0]],g=o.projectVertexZ[u[0]],S=t.normalX,w=t.normalY,y=t.normalZ,I=o.normalMagnitude[h],C=t.visibility,b=!1;for(let t=0;t<m;t++){let e=c[t],i=(p-a.projectVertexX[e])*S+(f-a.projectVertexY[e])*w+(g-a.projectVertexZ[e])*y;if(!(i>=-I||C<=0)||!(i<=I||C>=0)){b=!0;break}}if(!b)return!0;if(2===d){i=new Int32Array(4),s=new Int32Array(4);let t=u[0],e=u[1];i[0]=o.vertexViewX[t]-20,i[1]=o.vertexViewX[e]-20,i[2]=o.vertexViewX[e]+20,i[3]=o.vertexViewX[t]+20,s[0]=s[3]=o.vertexViewY[t],s[1]=s[2]=o.vertexViewY[e]}else{i=new Int32Array(d),s=new Int32Array(d);for(let t=0;t<d;t++){let e=u[t];i[t]=o.vertexViewX[e],s[t]=o.vertexViewY[e]}}if(2===m){r=new Int32Array(4),n=new Int32Array(4);let t=c[0],e=c[1];r[0]=a.vertexViewX[t]-20,r[1]=a.vertexViewX[e]-20,r[2]=a.vertexViewX[e]+20,r[3]=a.vertexViewX[t]+20,n[0]=n[3]=a.vertexViewY[t],n[1]=n[2]=a.vertexViewY[e]}else{r=new Int32Array(m),n=new Int32Array(m);for(let t=0;t<m;t++){let e=c[t];r[t]=a.vertexViewX[e],n[t]=a.vertexViewY[e]}}return!this.intersect(i,s,r,n)}heuristicPolygon(t,e){let i=t.model,s=e.model,r=t.face,n=e.face,o=i.faceVertices[r],a=s.faceVertices[n],h=i.faceNumVertices[r],l=s.faceNumVertices[n],u=s.projectVertexX[a[0]],c=s.projectVertexY[a[0]],d=s.projectVertexZ[a[0]],m=e.normalX,p=e.normalY,f=e.normalZ,g=s.normalMagnitude[n],S=e.visibility,w=!1;for(let t=0;t<h;t++){let e=o[t],s=(u-i.projectVertexX[e])*m+(c-i.projectVertexY[e])*p+(d-i.projectVertexZ[e])*f;if(!(s>=-g||S>=0)||!(s<=g||S<=0)){w=!0;break}}if(!w)return!0;u=i.projectVertexX[o[0]],c=i.projectVertexY[o[0]],d=i.projectVertexZ[o[0]],m=t.normalX,p=t.normalY,f=t.normalZ,g=i.normalMagnitude[r],S=t.visibility,w=!1;for(let t=0;t<l;t++){let e=a[t],i=(u-s.projectVertexX[e])*m+(c-s.projectVertexY[e])*p+(d-s.projectVertexZ[e])*f;if(!(i>=-g||S<=0)||!(i<=g||S>=0)){w=!0;break}}return!w}allocateTextures(t,e,i){this.textureCount=t,this.textureColoursUsed=[],this.textureColoursUsed.length=t,this.textureColoursUsed.fill(null),this.textureColourList=[],this.textureColourList.length=t,this.textureColourList.fill(null),this.textureDimension=new Int32Array(t),this.textureCacheIndices=new Uint32Array(t),this.textureBackTransparent=new Array(t),this.texturePixels=[],this.texturePixels.length=t,this.texturePixels.fill(null),this.textureCount=0,this.textureColours64=[],this.textureColours64.length=e,this.textureColours64.fill(null),this.textureColours128=[],this.textureColours128.length=i,this.textureColours128.fill(null)}defineTexture(t,e,i,s){this.textureColoursUsed[t]=e,this.textureColourList[t]=i,this.textureDimension[t]=s,this.textureCacheIndices[t]=0,this.textureBackTransparent[t]=!1,this.texturePixels[t]=null,this.prepareTexture(t)}prepareTexture(t){if(t<0)return;if(this.textureCount=this.textureCount+1,this.textureCacheIndices[t]=this.textureCount,null!==this.texturePixels[t])return;if(0===this.textureDimension[t]){for(let e=0;e<this.textureColours64.length;e++)if(null===this.textureColours64[e])return this.textureColours64[e]=new Int32Array(16384),this.texturePixels[t]=this.textureColours64[e],void this.setTexturePixels(t);let e=1<<30,i=0;for(let s=0;s<this.textureCount;s++)s!==t&&0===this.textureDimension[s]&&null!==this.texturePixels[s]&&this.textureCacheIndices[s]<e&&(e=this.textureCacheIndices[s],i=s);return this.texturePixels[t]=this.texturePixels[i],this.texturePixels[i]=null,void this.setTexturePixels(t)}for(let e=0;e<this.textureColours128.length;e++)if(null===this.textureColours128[e])return this.textureColours128[e]=new Int32Array(65536),this.texturePixels[t]=this.textureColours128[e],void this.setTexturePixels(t);let e=1<<30,i=0;for(let s=0;s<this.textureCount;s++)s!==t&&1===this.textureDimension[s]&&null!==this.texturePixels[s]&&this.textureCacheIndices[s]<e&&(e=this.textureCacheIndices[s],i=s);this.texturePixels[t]=this.texturePixels[i],this.texturePixels[i]=null,this.setTexturePixels(t)}setTexturePixels(t){let e;e=0===this.textureDimension[t]?64:128;let i=this.texturePixels[t],s=0;for(let r=0;r<e;r++)for(let n=0;n<e;n++){let o=this.textureColourList[t][255&this.textureColoursUsed[t][n+r*e]];o&=16316671,0===o?o=1:16253183===o&&(o=0,this.textureBackTransparent[t]=!0),i[s++]=o}for(let t=0;t<s;t++){let e=i[t];i[s+t]=e-(e>>>3)&16316671,i[2*s+t]=e-(e>>>2)&16316671,i[3*s+t]=e-(e>>>2)-(e>>>3)&16316671}}doSOemthingWithTheFuckinFountainFuck(t){if(!this.texturePixels[t])return;let e=this.texturePixels[t];for(let i=0;i<64;i++){let s=i+4032,r=e[s];for(let t=0;t<63;t++)e[s]=e[s-64],s-=64;this.texturePixels[t][s]=r}let i=4096;for(let t=0;t<i;t++){let s=e[t];e[i+t]=s-(s>>>3)&16316671,e[8192+t]=s-(s>>>2)&16316671,e[3*i+t]=s-(s>>>2)-(s>>>3)&16316671}}method302(t){if(12345678===t)return 0;if(this.prepareTexture(t),t>=0)return this.texturePixels[t][0];if(t<0){return(((t=-(t+1))>>10&31)<<19)+((t>>5&31)<<11)+((31&t)<<3)}return 0}setLightSourceCoords(t,e,i){0===t&&0===e&&0===i&&(t=32);for(let s=0;s<this.modelCount;s++)this.models[s].setLightCoords(t,e,i)}createLightSource(t,e,i,s,r){0===i&&0===s&&0===r&&(i=32);for(let n=0;n<this.modelCount;n++)this.models[n].offsetLightSourceCoords(t,e,i,s,r)}setLight(...t){switch(t.length){case 3:return this.setLightSourceCoords(...t);case 5:return this.createLightSource(...t)}}method306(t,e,i,s,r){return s===e?t:t+((i-t)*(r-e)/(s-e)|0)}method307(t,e,i,s,r){return r&&t<=i||t<i?t>s||(e>i||(e>s||!r)):t<s||(e<i||(e<s||r))}method308(t,e,i,s){return s&&t<=i||t<i?e>i||!s:e<i||s}intersect(t,e,i,s){let r,n,o=t.length,a=i.length,h=0,l=r=e[0],u=0,c=n=s[0],d=0;for(let t=1;t<o;t++)e[t]<r?(r=e[t],u=t):e[t]>l&&(l=e[t]);for(let t=1;t<a;t++)s[t]<n?(n=s[t],d=t):s[t]>c&&(c=s[t]);if(n>=l)return!1;if(r>=c)return!1;let m,p=0,f=0;if(e[u]<s[d]){for(p=u;e[p]<s[d];)p=(p+1)%o;for(;e[u]<s[d];)u=(u-1+o)%o;let r=this.method306(t[(u+1)%o],e[(u+1)%o],t[u],e[u],s[d]),n=this.method306(t[(p-1+o)%o],e[(p-1+o)%o],t[p],e[p],s[d]),l=i[d];if(m=r<l|n<l,this.method308(r,n,l,m))return!0;f=(d+1)%a,d=(d-1+a)%a,u===p&&(h=1)}else{for(f=d;s[f]<e[u];)f=(f+1)%a;for(;s[d]<e[u];)d=(d-1+a)%a;let r=t[u],n=this.method306(i[(d+1)%a],s[(d+1)%a],i[d],s[d],e[u]),l=this.method306(i[(f-1+a)%a],s[(f-1+a)%a],i[f],s[f],e[u]);if(m=r<n|r<l,this.method308(n,l,r,!m))return!0;p=(u+1)%o,u=(u-1+o)%o,d===f&&(h=2)}for(;0===h;)if(e[u]<e[p])if(e[u]<s[d])if(e[u]<s[f]){let r=t[u],n=this.method306(t[(p-1+o)%o],e[(p-1+o)%o],t[p],e[p],e[u]),l=this.method306(i[(d+1)%a],s[(d+1)%a],i[d],s[d],e[u]),c=this.method306(i[(f-1+a)%a],s[(f-1+a)%a],i[f],s[f],e[u]);if(this.method307(r,n,l,c,m))return!0;u=(u-1+o)%o,u===p&&(h=1)}else{let r=this.method306(t[(u+1)%o],e[(u+1)%o],t[u],e[u],s[f]),n=this.method306(t[(p-1+o)%o],e[(p-1+o)%o],t[p],e[p],s[f]),l=this.method306(i[(d+1)%a],s[(d+1)%a],i[d],s[d],s[f]),c=i[f];if(this.method307(r,n,l,c,m))return!0;f=(f+1)%a,d===f&&(h=2)}else if(s[d]<s[f]){let r=this.method306(t[(u+1)%o],e[(u+1)%o],t[u],e[u],s[d]),n=this.method306(t[(p-1+o)%o],e[(p-1+o)%o],t[p],e[p],s[d]),l=i[d],c=this.method306(i[(f-1+a)%a],s[(f-1+a)%a],i[f],s[f],s[d]);if(this.method307(r,n,l,c,m))return!0;d=(d-1+a)%a,d===f&&(h=2)}else{let r=this.method306(t[(u+1)%o],e[(u+1)%o],t[u],e[u],s[f]),n=this.method306(t[(p-1+o)%o],e[(p-1+o)%o],t[p],e[p],s[f]),l=this.method306(i[(d+1)%a],s[(d+1)%a],i[d],s[d],s[f]),c=i[f];if(this.method307(r,n,l,c,m))return!0;f=(f+1)%a,d===f&&(h=2)}else if(e[p]<s[d])if(e[p]<s[f]){let r=this.method306(t[(u+1)%o],e[(u+1)%o],t[u],e[u],e[p]),n=t[p],l=this.method306(i[(d+1)%a],s[(d+1)%a],i[d],s[d],e[p]),c=this.method306(i[(f-1+a)%a],s[(f-1+a)%a],i[f],s[f],e[p]);if(this.method307(r,n,l,c,m))return!0;p=(p+1)%o,u===p&&(h=1)}else{let r=this.method306(t[(u+1)%o],e[(u+1)%o],t[u],e[u],s[f]),n=this.method306(t[(p-1+o)%o],e[(p-1+o)%o],t[p],e[p],s[f]),l=this.method306(i[(d+1)%a],s[(d+1)%a],i[d],s[d],s[f]),c=i[f];if(this.method307(r,n,l,c,m))return!0;f=(f+1)%a,d===f&&(h=2)}else if(s[d]<s[f]){let r=this.method306(t[(u+1)%o],e[(u+1)%o],t[u],e[u],s[d]),n=this.method306(t[(p-1+o)%o],e[(p-1+o)%o],t[p],e[p],s[d]),l=i[d],c=this.method306(i[(f-1+a)%a],s[(f-1+a)%a],i[f],s[f],s[d]);if(this.method307(r,n,l,c,m))return!0;d=(d-1+a)%a,d===f&&(h=2)}else{let r=this.method306(t[(u+1)%o],e[(u+1)%o],t[u],e[u],s[f]),n=this.method306(t[(p-1+o)%o],e[(p-1+o)%o],t[p],e[p],s[f]),l=this.method306(i[(d+1)%a],s[(d+1)%a],i[d],s[d],s[f]),c=i[f];if(this.method307(r,n,l,c,m))return!0;f=(f+1)%a,d===f&&(h=2)}for(;1===h;)if(e[u]<s[d]){if(e[u]<s[f]){let r=t[u],n=this.method306(i[(d+1)%a],s[(d+1)%a],i[d],s[d],e[u]),o=this.method306(i[(f-1+a)%a],s[(f-1+a)%a],i[f],s[f],e[u]);return this.method308(n,o,r,!m)}let r=this.method306(t[(u+1)%o],e[(u+1)%o],t[u],e[u],s[f]),n=this.method306(t[(p-1+o)%o],e[(p-1+o)%o],t[p],e[p],s[f]),l=this.method306(i[(d+1)%a],s[(d+1)%a],i[d],s[d],s[f]),c=i[f];if(this.method307(r,n,l,c,m))return!0;f=(f+1)%a,d===f&&(h=0)}else if(s[d]<s[f]){let r=this.method306(t[(u+1)%o],e[(u+1)%o],t[u],e[u],s[d]),n=this.method306(t[(p-1+o)%o],e[(p-1+o)%o],t[p],e[p],s[d]),l=i[d],c=this.method306(i[(f-1+a)%a],s[(f-1+a)%a],i[f],s[f],s[d]);if(this.method307(r,n,l,c,m))return!0;d=(d-1+a)%a,d===f&&(h=0)}else{let r=this.method306(t[(u+1)%o],e[(u+1)%o],t[u],e[u],s[f]),n=this.method306(t[(p-1+o)%o],e[(p-1+o)%o],t[p],e[p],s[f]),l=this.method306(i[(d+1)%a],s[(d+1)%a],i[d],s[d],s[f]),c=i[f];if(this.method307(r,n,l,c,m))return!0;f=(f+1)%a,d===f&&(h=0)}for(;2===h;)if(s[d]<e[u]){if(s[d]<e[p]){let r=this.method306(t[(u+1)%o],e[(u+1)%o],t[u],e[u],s[d]),n=this.method306(t[(p-1+o)%o],e[(p-1+o)%o],t[p],e[p],s[d]),a=i[d];return this.method308(r,n,a,m)}let r=this.method306(t[(u+1)%o],e[(u+1)%o],t[u],e[u],e[p]),n=t[p],l=this.method306(i[(d+1)%a],s[(d+1)%a],i[d],s[d],e[p]),c=this.method306(i[(f-1+a)%a],s[(f-1+a)%a],i[f],s[f],e[p]);if(this.method307(r,n,l,c,m))return!0;p=(p+1)%o,u===p&&(h=0)}else if(e[u]<e[p]){let r=t[u],n=this.method306(t[(p-1+o)%o],e[(p-1+o)%o],t[p],e[p],e[u]),l=this.method306(i[(d+1)%a],s[(d+1)%a],i[d],s[d],e[u]),c=this.method306(i[(f-1+a)%a],s[(f-1+a)%a],i[f],s[f],e[u]);if(this.method307(r,n,l,c,m))return!0;u=(u-1+o)%o,u===p&&(h=0)}else{let r=this.method306(t[(u+1)%o],e[(u+1)%o],t[u],e[u],e[p]),n=t[p],l=this.method306(i[(d+1)%a],s[(d+1)%a],i[d],s[d],e[p]),c=this.method306(i[(f-1+a)%a],s[(f-1+a)%a],i[f],s[f],e[p]);if(this.method307(r,n,l,c,m))return!0;p=(p+1)%o,u===p&&(h=0)}if(e[u]<s[d]){let r=t[u],n=this.method306(i[(d+1)%a],s[(d+1)%a],i[d],s[d],e[u]),o=this.method306(i[(f-1+a)%a],s[(f-1+a)%a],i[f],s[f],e[u]);return this.method308(n,o,r,!m)}let g=this.method306(t[(u+1)%o],e[(u+1)%o],t[u],e[u],s[d]),S=this.method306(t[(p-1+o)%o],e[(p-1+o)%o],t[p],e[p],s[d]),w=i[d];return this.method308(g,S,w,m)}}Ot.sin2048Cache=new Int32Array(2048),Ot.sin512Cache=new Int32Array(512),Ot.frustumMaxX=0,Ot.frustumMinX=0,Ot.frustumMaxY=0,Ot.frustumMinY=0,Ot.frustumFarZ=0,Ot.frustumNearZ=0;class Yt{constructor(){this.numVertices=0,this.numFaces=0,this.transformState=0,this.visible=!1,this.textureTranslucent=!1,this.transparent=!1,this.isolated=!1,this.unlit=!1,this.unpickable=!1,this.projected=!1,this.autocommit=!1,this.depth=0,this.x1=0,this.x2=0,this.y1=0,this.y2=0,this.z1=0,this.z2=0,this.key=0,this.maxVerts=0,this.lightDiffuse=0,this.lightAmbience=0,this.magic=0,this.maxFaces=0,this.baseX=0,this.baseY=0,this.baseZ=0,this.scaleFx=0,this.scaleFy=0,this.scaleFz=0,this.shearXy=0,this.shearXz=0,this.shearYx=0,this.shearYz=0,this.shearZx=0,this.shearZy=0,this.transformKind=0,this.diameter=0,this.lightDirectionX=0,this.lightDirectionY=0,this.lightDirectionZ=0,this.lightDirectionMagnitude=0,this.dataPtr=0,this.orientationYaw=0,this.orientationPitch=0,this.orientationRoll=0,this.projectVertexX=null,this.projectVertexY=null,this.projectVertexZ=null,this.vertexViewX=null,this.vertexViewY=null,this.vertexIntensity=null,this.vertexAmbience=null,this.faceNumVertices=null,this.faceVertices=null,this.faceFillFront=null,this.faceFillBack=null,this.normalMagnitude=null,this.normalScale=null,this.faceIntensity=null,this.faceNormalX=null,this.faceNormalY=null,this.faceNormalZ=null,this.faceTag=null,this.isLocalPlayer=null,this.vertexX=null,this.vertexY=null,this.vertexZ=null,this.vertexTransformedX=null,this.vertexTransformedY=null,this.vertexTransformedZ=null,this.faceTransStateThing=null,this.faceBoundLeft=null,this.faceBoundRight=null,this.faceBoundBottom=null,this.faceBoundTop=null,this.faceBoundNear=null,this.faceBoundFar=null}static _from2(t,e){let i=new Yt;i.transformState=1,i.visible=!0,i.textureTranslucent=!1,i.transparent=!1,i.key=-1,i.autocommit=!1,i.isolated=!1,i.unlit=!1,i.unpickable=!1,i.projected=!1,i.magic=12345678,i.diameter=12345678,i.lightDirectionX=180,i.lightDirectionY=155,i.lightDirectionZ=95,i.lightDirectionMagnitude=256,i.lightDiffuse=32,i.lightAmbience=8,i.allocate(t,e),i.faceTransStateThing=[];for(let t=0;t<i.numFaces;t++)i.faceTransStateThing.push(new Int32Array([0]));return i}static _from2A(t,e){let i=new Yt;return i.transformState=1,i.visible=!0,i.textureTranslucent=!1,i.transparent=!1,i.key=-1,i.autocommit=!1,i.isolated=!1,i.unlit=!1,i.unpickable=!1,i.projected=!1,i.magic=12345678,i.diameter=12345678,i.lightDirectionX=180,i.lightDirectionY=155,i.lightDirectionZ=95,i.lightDirectionMagnitude=256,i.lightDiffuse=32,i.lightAmbience=32,i.merge(t,e,!0),i}static _from3(t,e,i){let s=new Yt;s.transformState=1,s.visible=!0,s.textureTranslucent=!1,s.transparent=!1,s.key=-1,s.autocommit=!1,s.isolated=!1,s.unlit=!1,s.unpickable=!1,s.projected=!1,s.magic=12345678,s.diameter=12345678,s.lightDirectionX=180,s.lightDirectionY=155,s.lightDirectionZ=95,s.lightDirectionMagnitude=256,s.lightDiffuse=32,s.lightAmbience=32;let r=S.getUnsignedShort(t,e);e+=2;let n=S.getUnsignedShort(t,e);e+=2,s.allocate(r,n),s.faceTransStateThing=[],s.faceTransStateThing.length=n;for(let t=0;t<n;t+=1)s.faceTransStateThing[t]=[0];for(let i=0;i<r;i++)s.vertexX[i]=S.getSignedShort(t,e),e+=2;for(let i=0;i<r;i++)s.vertexY[i]=S.getSignedShort(t,e),e+=2;for(let i=0;i<r;i++)s.vertexZ[i]=S.getSignedShort(t,e),e+=2;s.numVertices=r;for(let i=0;i<n;i++)s.faceNumVertices[i]=255&t[e++];for(let i=0;i<n;i++)s.faceFillFront[i]=S.getSignedShort(t,e),e+=2,32767===s.faceFillFront[i]&&(s.faceFillFront[i]=s.magic);for(let i=0;i<n;i++)s.faceFillBack[i]=S.getSignedShort(t,e),e+=2,32767===s.faceFillBack[i]&&(s.faceFillBack[i]=s.magic);for(let i=0;i<n;i++){let r=255&t[e++];s.faceIntensity[i]=0===r?0:s.magic}for(let i=0;i<n;i++){s.faceVertices[i]=new Int32Array(s.faceNumVertices[i]);for(let n=0;n<s.faceNumVertices[i];n++)r<256?s.faceVertices[i][n]=255&t[e++]:(s.faceVertices[i][n]=S.getUnsignedShort(t,e),e+=2)}return s.numFaces=n,s.transformState=1,s}static _from6(t,e,i,s,r,n){let o=new Yt;return o.transformState=1,o.visible=!0,o.textureTranslucent=!1,o.transparent=!1,o.key=-1,o.projected=!1,o.magic=12345678,o.diameter=12345678,o.lightDirectionX=180,o.lightDirectionY=155,o.lightDirectionZ=95,o.lightDirectionMagnitude=256,o.lightDiffuse=32,o.lightAmbience=32,o.autocommit=i,o.isolated=s,o.unlit=r,o.unpickable=n,o.merge(t,e,!1),o}static _from7(t,e,i,s,r,n,o){let a=new Yt;return a.transformState=1,a.visible=!0,a.textureTranslucent=!1,a.transparent=!1,a.key=-1,a.magic=12345678,a.diameter=12345678,a.lightDirectionX=180,a.lightDirectionY=155,a.lightDirectionZ=95,a.lightDirectionMagnitude=256,a.lightDiffuse=32,a.lightAmbience=32,a.autocommit=i,a.isolated=s,a.unlit=r,a.unpickable=n,a.projected=o,a.allocate(t,e),a}allocate(t,e){this.vertexX=new Int32Array(t),this.vertexY=new Int32Array(t),this.vertexZ=new Int32Array(t),this.vertexIntensity=new Int32Array(t),this.vertexAmbience=new Int8Array(t),this.faceNumVertices=new Int32Array(e),this.faceVertices=[],this.faceVertices.length=e,this.faceVertices.fill(null),this.faceFillFront=new Int32Array(e),this.faceFillBack=new Int32Array(e),this.faceIntensity=new Int32Array(e),this.normalScale=new Int32Array(e),this.normalMagnitude=new Int32Array(e),this.projected||(this.projectVertexX=new Int32Array(t),this.projectVertexY=new Int32Array(t),this.projectVertexZ=new Int32Array(t),this.vertexViewX=new Int32Array(t),this.vertexViewY=new Int32Array(t)),this.unpickable||(this.isLocalPlayer=new Int8Array(e),this.faceTag=new Int32Array(e)),this.autocommit?(this.vertexTransformedX=this.vertexX,this.vertexTransformedY=this.vertexY,this.vertexTransformedZ=this.vertexZ):(this.vertexTransformedX=new Int32Array(t),this.vertexTransformedY=new Int32Array(t),this.vertexTransformedZ=new Int32Array(t)),this.unlit&&this.isolated||(this.faceNormalX=new Int32Array(e),this.faceNormalY=new Int32Array(e),this.faceNormalZ=new Int32Array(e)),this.isolated||(this.faceBoundLeft=new Int32Array(e),this.faceBoundRight=new Int32Array(e),this.faceBoundBottom=new Int32Array(e),this.faceBoundTop=new Int32Array(e),this.faceBoundNear=new Int32Array(e),this.faceBoundFar=new Int32Array(e)),this.numFaces=0,this.numVertices=0,this.maxVerts=t,this.maxFaces=e,this.baseX=this.baseY=this.baseZ=0,this.orientationYaw=this.orientationPitch=this.orientationRoll=0,this.scaleFx=this.scaleFy=this.scaleFz=256,this.shearXy=this.shearXz=this.shearYx=this.shearYz=this.shearZx=this.shearZy=256,this.transformKind=0}projectionPrepare(){this.projectVertexX=new Int32Array(this.numVertices),this.projectVertexY=new Int32Array(this.numVertices),this.projectVertexZ=new Int32Array(this.numVertices),this.vertexViewX=new Int32Array(this.numVertices),this.vertexViewY=new Int32Array(this.numVertices)}clear(){this.numFaces=0,this.numVertices=0}reduce(t,e){this.numFaces-=t,this.numFaces<0&&(this.numFaces=0),this.numVertices-=e,this.numVertices<0&&(this.numVertices=0)}merge(t,e,i){let s=0,r=0;for(let i=0;i<e;i++)s+=t[i].numFaces,r+=t[i].numVertices;this.allocate(r,s),i&&(this.faceTransStateThing=[],this.faceTransStateThing.length=s);for(let s=0;s<e;s++){let r=t[s];r.commit(),this.lightAmbience=r.lightAmbience,this.lightDiffuse=r.lightDiffuse,this.lightDirectionX=r.lightDirectionX,this.lightDirectionY=r.lightDirectionY,this.lightDirectionZ=r.lightDirectionZ,this.lightDirectionMagnitude=r.lightDirectionMagnitude;for(let t=0;t<r.numFaces;t++){let n=new Int32Array(r.faceNumVertices[t]),o=r.faceVertices[t];for(let e=0;e<r.faceNumVertices[t];e++)n[e]=this.vertexAt(r.vertexX[o[e]],r.vertexY[o[e]],r.vertexZ[o[e]]);let a=this.createFace(r.faceNumVertices[t],n,r.faceFillFront[t],r.faceFillBack[t]);if(this.faceIntensity[a]=r.faceIntensity[t],this.normalScale[a]=r.normalScale[t],this.normalMagnitude[a]=r.normalMagnitude[t],i)if(e>1){this.faceTransStateThing[a]=new Int32Array(r.faceTransStateThing[t].length+1),this.faceTransStateThing[a][0]=s;for(let e=0;e<r.faceTransStateThing[t].length;e++)this.faceTransStateThing[a][e+1]=r.faceTransStateThing[t][e]}else{this.faceTransStateThing[a]=new Int32Array(r.faceTransStateThing[t].length);for(let e=0;e<r.faceTransStateThing[t].length;e++)this.faceTransStateThing[a][e]=r.faceTransStateThing[t][e]}}}this.transformState=1}vertexAt(t,e,i){for(let s=0;s<this.numVertices;s++)if(this.vertexX[s]===t&&this.vertexY[s]===e&&this.vertexZ[s]===i)return s;return this.numVertices>=this.maxVerts?-1:(this.vertexX[this.numVertices]=t,this.vertexY[this.numVertices]=e,this.vertexZ[this.numVertices]=i,this.numVertices++)}createVertex(t,e,i){return this.numVertices>=this.maxVerts?-1:(this.vertexX[this.numVertices]=t,this.vertexY[this.numVertices]=e,this.vertexZ[this.numVertices]=i,this.numVertices++)}createFace(t,e,i,s){return this.numFaces>=this.maxFaces?-1:(this.faceNumVertices[this.numFaces]=t,this.faceVertices[this.numFaces]=e,this.faceFillFront[this.numFaces]=i,this.faceFillBack[this.numFaces]=s,this.transformState=1,this.numFaces++)}split(t,e,i,s,r,n,o,a){this.commit();let h=new Int32Array(n),l=new Int32Array(n);for(let t=0;t<n;t++)h[t]=0,l[t]=0;for(let t=0;t<this.numFaces;t++){let e=0,n=0,o=this.faceNumVertices[t],a=this.faceVertices[t];for(let t=0;t<o;t++)e+=this.vertexX[a[t]],n+=this.vertexZ[a[t]];let u=(e/(o*i)|0)+(n/(o*s)|0)*r;h[u]+=o,l[u]++}let u=[];for(let t=0;t<n;t++)h[t]>o&&(h[t]=o),u.push(Yt._from7(h[t],l[t],!0,!0,!0,a,!0)),u[t].lightDiffuse=this.lightDiffuse,u[t].lightAmbience=this.lightAmbience;for(let t=0;t<this.numFaces;t++){let e=0,n=0,o=this.faceNumVertices[t],a=this.faceVertices[t];for(let t=0;t<o;t++)e+=this.vertexX[a[t]],n+=this.vertexZ[a[t]];let h=(e/(o*i)|0)+(n/(o*s)|0)*r;this.copyLighting(u[h],a,o,t)}for(let t=0;t<n;t++)u[t].projectionPrepare();return u}copyLighting(t,e,i,s){let r=new Int32Array(i);for(let s=0;s<i;s++){let i=r[s]=t.vertexAt(this.vertexX[e[s]],this.vertexY[e[s]],this.vertexZ[e[s]]);t.vertexIntensity[i]=this.vertexIntensity[e[s]],t.vertexAmbience[i]=this.vertexAmbience[e[s]]}let n=t.createFace(i,r,this.faceFillFront[s],this.faceFillBack[s]);t.unpickable||this.unpickable||(t.faceTag[n]=this.faceTag[s]),t.faceIntensity[n]=this.faceIntensity[s],t.normalScale[n]=this.normalScale[s],t.normalMagnitude[n]=this.normalMagnitude[s]}offsetLightSourceCoords(t,e,i,s,r){this.lightAmbience=256-4*t,this.lightDiffuse=16*(64-e)+128,this.unlit||(this.lightDirectionX=i,this.lightDirectionY=s,this.lightDirectionZ=r,this.lightDirectionMagnitude=0|Math.sqrt(i*i+s*s+r*r),this.light())}createGouraudLightSource(t,e,i,s,r,n){if(this.lightAmbience=256-4*e,this.lightDiffuse=16*(64-i)+128,!this.unlit){for(let e=0;e<this.numFaces;e++)this.faceIntensity[e]=t?this.magic:0;this.lightDirectionX=s,this.lightDirectionY=r,this.lightDirectionZ=n,this.lightDirectionMagnitude=0|Math.sqrt(s*s+r*r+n*n),this.light()}}setLightCoords(t,e,i){this.unlit||(this.lightDirectionX=t,this.lightDirectionY=e,this.lightDirectionZ=i,this.lightDirectionMagnitude=0|Math.sqrt(t*t+e*e+i*i),this.light())}setLight(...t){switch(t.length){case 6:return this.createGouraudLightSource(...t);case 5:return this.offsetLightSourceCoords(...t);case 3:return this.setLightCoords(...t)}}setVertexAmbience(t,e){this.vertexAmbience[t]=255&e}rotate(t,e,i){this.orientationYaw=this.orientationYaw+t&255,this.orientationPitch=this.orientationPitch+e&255,this.orientationRoll=this.orientationRoll+i&255,this.determineTransformKind(),this.transformState=1}orient(t,e,i){this.orientationYaw=255&t,this.orientationPitch=255&e,this.orientationRoll=255&i,this.determineTransformKind(),this.transformState=1}translate(t,e,i){this.baseX+=t,this.baseY+=e,this.baseZ+=i,this.determineTransformKind(),this.transformState=1}place(t,e,i){this.baseX=t,this.baseY=e,this.baseZ=i,this.determineTransformKind(),this.transformState=1}determineTransformKind(){256!==this.shearXy||256!==this.shearXz||256!==this.shearYx||256!==this.shearYz||256!==this.shearZx||256!==this.shearZy?this.transformKind=4:256!==this.scaleFx||256!==this.scaleFy||256!==this.scaleFz?this.transformKind=3:0!==this.orientationYaw||0!==this.orientationPitch||0!==this.orientationRoll?this.transformKind=2:0!==this.baseX||0!==this.baseY||0!==this.baseZ?this.transformKind=1:this.transformKind=0}applyTranslate(t,e,i){for(let s=0;s<this.numVertices;s++)this.vertexTransformedX[s]+=t,this.vertexTransformedY[s]+=e,this.vertexTransformedZ[s]+=i}applyRotation(t,e,i){for(let s=0;s<this.numVertices;s++){if(0!==i){let t=Yt.sine9[i],e=Yt.sine9[i+256],r=this.vertexTransformedY[s]*t+this.vertexTransformedX[s]*e>>15;this.vertexTransformedY[s]=this.vertexTransformedY[s]*e-this.vertexTransformedX[s]*t>>15,this.vertexTransformedX[s]=r}if(0!==t){let e=Yt.sine9[t],i=Yt.sine9[t+256],r=this.vertexTransformedY[s]*i-this.vertexTransformedZ[s]*e>>15;this.vertexTransformedZ[s]=this.vertexTransformedY[s]*e+this.vertexTransformedZ[s]*i>>15,this.vertexTransformedY[s]=r}if(0!==e){let t=Yt.sine9[e],i=Yt.sine9[e+256],r=this.vertexTransformedZ[s]*t+this.vertexTransformedX[s]*i>>15;this.vertexTransformedZ[s]=this.vertexTransformedZ[s]*i-this.vertexTransformedX[s]*t>>15,this.vertexTransformedX[s]=r}}}applyShear(t,e,i,s,r,n){for(let o=0;o<this.numVertices;o++)0!==t&&(this.vertexTransformedX[o]+=this.vertexTransformedY[o]*t>>8),0!==e&&(this.vertexTransformedZ[o]+=this.vertexTransformedY[o]*e>>8),0!==i&&(this.vertexTransformedX[o]+=this.vertexTransformedZ[o]*i>>8),0!==s&&(this.vertexTransformedY[o]+=this.vertexTransformedZ[o]*s>>8),0!==r&&(this.vertexTransformedZ[o]+=this.vertexTransformedX[o]*r>>8),0!==n&&(this.vertexTransformedY[o]+=this.vertexTransformedX[o]*n>>8)}applyScale(t,e,i){for(let s=0;s<this.numVertices;s++)this.vertexTransformedX[s]=this.vertexTransformedX[s]*t>>8,this.vertexTransformedY[s]=this.vertexTransformedY[s]*e>>8,this.vertexTransformedZ[s]=this.vertexTransformedZ[s]*i>>8}computeBounds(){this.x1=this.y1=this.z1=999999,this.diameter=this.x2=this.y2=this.z2=-999999;for(let t=0;t<this.numFaces;t++){let e=this.faceVertices[t],i=e[0],s=this.faceNumVertices[t],r=0,n=r=this.vertexTransformedX[i],o=0,a=o=this.vertexTransformedY[i],h=0,l=h=this.vertexTransformedZ[i];for(let t=0;t<s;t++)i=e[t],this.vertexTransformedX[i]<r?r=this.vertexTransformedX[i]:this.vertexTransformedX[i]>n&&(n=this.vertexTransformedX[i]),this.vertexTransformedY[i]<o?o=this.vertexTransformedY[i]:this.vertexTransformedY[i]>a&&(a=this.vertexTransformedY[i]),this.vertexTransformedZ[i]<h?h=this.vertexTransformedZ[i]:this.vertexTransformedZ[i]>l&&(l=this.vertexTransformedZ[i]);this.isolated||(this.faceBoundLeft[t]=r,this.faceBoundRight[t]=n,this.faceBoundBottom[t]=o,this.faceBoundTop[t]=a,this.faceBoundNear[t]=h,this.faceBoundFar[t]=l),n-r>this.diameter&&(this.diameter=n-r),a-o>this.diameter&&(this.diameter=a-o),l-h>this.diameter&&(this.diameter=l-h),r<this.x1&&(this.x1=r),n>this.x2&&(this.x2=n),o<this.y1&&(this.y1=o),a>this.y2&&(this.y2=a),h<this.z1&&(this.z1=h),l>this.z2&&(this.z2=l)}}light(){if(this.unlit)return;let t=this.lightDiffuse*this.lightDirectionMagnitude>>8;for(let e=0;e<this.numFaces;e++)this.faceIntensity[this.face]!==this.magic&&(this.faceIntensity[this.face]=(this.faceNormalX[e]*this.lightDirectionX+this.faceNormalY[e]*this.lightDirectionY+this.faceNormalZ[e]*this.lightDirectionZ)/t|0);let e=new Int32Array(this.numVertices),i=new Int32Array(this.numVertices),s=new Int32Array(this.numVertices),r=new Int32Array(this.numVertices);for(let t=0;t<this.numVertices;t++)e[t]=0,i[t]=0,s[t]=0,r[t]=0;for(let t=0;t<this.numFaces;t++)if(this.faceIntensity[t]===this.magic)for(let n=0;n<this.faceNumVertices[t];n++){let o=this.faceVertices[t][n];e[o]+=this.faceNormalX[t],i[o]+=this.faceNormalY[t],s[o]+=this.faceNormalZ[t],r[o]++}for(let n=0;n<this.numVertices;n++)r[n]>0&&(this.vertexIntensity[n]=(e[n]*this.lightDirectionX+i[n]*this.lightDirectionY+s[n]*this.lightDirectionZ)/(t*r[n])|0)}relight(){if(!this.unlit||!this.isolated){for(let t=0;t<this.numFaces;t++){let e,i=this.faceVertices[t],s=this.vertexTransformedX[i[0]],r=this.vertexTransformedY[i[0]],n=this.vertexTransformedZ[i[0]],o=this.vertexTransformedX[i[1]]-s,a=this.vertexTransformedY[i[1]]-r,h=this.vertexTransformedZ[i[1]]-n,l=this.vertexTransformedX[i[2]]-s,u=this.vertexTransformedY[i[2]]-r,c=this.vertexTransformedZ[i[2]]-n,d=a*c-u*h,m=h*l-c*o;for(e=o*u-l*a;d>8192||m>8192||e>8192||d<-8192||m<-8192||e<-8192;e>>=1)d>>=1,m>>=1;let p=256*Math.sqrt(d*d+m*m+e*e)|0;p<=0&&(p=1),this.faceNormalX[t]=65536*d/p|0,this.faceNormalY[t]=65536*m/p|0,this.faceNormalZ[t]=65535*e/p|0,this.normalScale[t]=-1}this.light()}}apply(){if(2===this.transformState){this.transformState=0;for(let t=0;t<this.numVertices;t++)this.vertexTransformedX[t]=this.vertexX[t],this.vertexTransformedY[t]=this.vertexY[t],this.vertexTransformedZ[t]=this.vertexZ[t];return this.x1=this.y1=this.z1=-9999999,void(this.diameter=this.x2=this.y2=this.z2=9999999)}if(1===this.transformState){this.transformState=0;for(let t=0;t<this.numVertices;t++)this.vertexTransformedX[t]=this.vertexX[t],this.vertexTransformedY[t]=this.vertexY[t],this.vertexTransformedZ[t]=this.vertexZ[t];this.transformKind>=2&&this.applyRotation(this.orientationYaw,this.orientationPitch,this.orientationRoll),this.transformKind>=3&&this.applyScale(this.scaleFx,this.scaleFy,this.scaleFz),this.transformKind>=4&&this.applyShear(this.shearXy,this.shearXz,this.shearYx,this.shearYz,this.shearZx,this.shearZy),this.transformKind>=1&&this.applyTranslate(this.baseX,this.baseY,this.baseZ),this.computeBounds(),this.relight()}}project(t,e,i,s,r,n,o,a){if(this.apply(),this.z1>Ot.frustumNearZ||this.z2<Ot.frustumFarZ||this.x1>Ot.frustumMinX||this.x2<Ot.frustumMaxX||this.y1>Ot.frustumMinY||this.y2<Ot.frustumMaxY)return void(this.visible=!1);this.visible=!0;let h=0,l=0,u=0,c=0,d=0,m=0;0!==n&&(h=Yt.sine11[n],l=Yt.sine11[n+1024]),0!==r&&(d=Yt.sine11[r],m=Yt.sine11[r+1024]),0!==s&&(u=Yt.sine11[s],c=Yt.sine11[s+1024]);for(let p=0;p<this.numVertices;p++){let f=this.vertexTransformedX[p]-t,g=this.vertexTransformedY[p]-e,S=this.vertexTransformedZ[p]-i;if(0!==n){let t=g*h+f*l>>15;g=g*l-f*h>>15,f=t}if(0!==r){let t=S*d+f*m>>15;S=S*m-f*d>>15,f=t}if(0!==s){let t=g*c-S*u>>15;S=g*u+S*c>>15,g=t}this.vertexViewX[p]=S>=a?(f<<o)/S|0:f<<o,this.vertexViewY[p]=S>=a?(g<<o)/S|0:g<<o,this.projectVertexX[p]=f,this.projectVertexY[p]=g,this.projectVertexZ[p]=S}}commit(){this.apply();for(let t=0;t<this.numVertices;t++)this.vertexX[t]=this.vertexTransformedX[t],this.vertexY[t]=this.vertexTransformedY[t],this.vertexZ[t]=this.vertexTransformedZ[t];this.baseX=this.baseY=this.baseZ=0,this.orientationYaw=this.orientationPitch=this.orientationRoll=0,this.scaleFx=this.scaleFy=this.scaleFz=256,this.shearXy=this.shearXz=this.shearYx=this.shearYz=this.shearZx=this.shearZy=256,this.transformKind=0}copy(...t){if(!t||!t.length){let t=[this],e=Yt._from2A(t,1);return e.depth=this.depth,e.transparent=this.transparent,e}const[e,i,s,r]=t;let n=[this],o=Yt._from6(n,1,e,i,s,r);return o.depth=this.depth,o}copyPosition(t){this.orientationYaw=t.orientationYaw,this.orientationPitch=t.orientationPitch,this.orientationRoll=t.orientationRoll,this.baseX=t.baseX,this.baseY=t.baseY,this.baseZ=t.baseZ,this.determineTransformKind(),this.transformState=1}readBase64(t){for(;10===t[this.dataPtr]||13===t[this.dataPtr];this.dataPtr++);let e=4096*Yt.base64Alphabet[255&t[this.dataPtr++]]+64*Yt.base64Alphabet[255&t[this.dataPtr++]]+Yt.base64Alphabet[255&t[this.dataPtr++]]-131072|0;return 123456===e&&(e=this.magic),e}}Yt.sine9=new Int32Array(512),Yt.sine11=new Int32Array(2048),Yt.base64Alphabet=new Int32Array(256);for(let t=0;t<256;t++)Yt.sine9[t]=32768*Math.sin(.02454369*t)|0,Yt.sine9[t+256]=32768*Math.cos(.02454369*t)|0;for(let t=0;t<1024;t++)Yt.sine11[t]=32768*Math.sin(.00613592315*t)|0,Yt.sine11[t+1024]=32768*Math.cos(.00613592315*t)|0;for(let t=0;t<10;t++)Yt.base64Alphabet[48+t]=t;for(let t=0;t<26;t++)Yt.base64Alphabet[65+t]=t+10;for(let t=0;t<26;t++)Yt.base64Alphabet[97+t]=t+36;Yt.base64Alphabet[163]=62,Yt.base64Alphabet[36]=63;const Dt=0,Xt=1,jt=2,Rt=3,_t=4,Nt=5,Ut=6,Ht=7,Ft=8,Wt=9,Vt=10,Gt=11,zt=12,Zt=14;class qt{constructor(t,e){this.controlCount=0,this.controlText=new Array(e),this.controlListTextEntries=new Array(e),this.mouseX=0,this.mouseY=0,this.mouseLastButtonDown=0,this.mouseButtonDown=0,this.mouseMetaButtonHeld=0,this.mouseScrollDelta=0,this.focusControlIndex=-1,this.aBoolean219=!0,this.surface=t,this.maxControls=e,this.controlShown=new Int8Array(e),this.controlListScrollbarHandleDragged=new Int8Array(e),this.controlMaskText=new Int8Array(e),this.controlClicked=[],this.controlClicked.length=e,this.controlUseAlternativeColour=new Int8Array(e),this.controlFlashText=new Int32Array(e),this.controlListEntryCount=new Int32Array(e),this.controlListEntryMouseButtonDown=new Int32Array(e),this.controlListEntryMouseOver=new Int32Array(e),this.controlX=new Int32Array(e),this.controlY=new Int32Array(e),this.controlType=new Int32Array(e),this.controlWidth=new Int32Array(e),this.controlHeight=new Int32Array(e),this.controlInputMaxLen=new Int32Array(e),this.controlTextSize=new Int32Array(e),this.controlListEntries=new Array(e),this.colourScrollbarTop=this.rgbToLongMod(114,114,176),this.colourScrollbarBottom=this.rgbToLongMod(14,14,62),this.colourScrollbarHandleLeft=this.rgbToLongMod(200,208,232),this.colourScrollbarHandleMid=this.rgbToLongMod(96,129,184),this.colourScrollbarHandleRight=this.rgbToLongMod(53,95,115),this.colourRoundedBoxOut=this.rgbToLongMod(117,142,171),this.colourRoundedBoxMid=this.rgbToLongMod(98,122,158),this.colourRoundedBoxIn=this.rgbToLongMod(86,100,136),this.colourBoxTopNBottom=this.rgbToLongMod(135,146,179),this.colourBoxTopNBottom2=this.rgbToLongMod(97,112,151),this.colourBoxLeftNRight2=this.rgbToLongMod(88,102,136),this.colourBoxLeftNRight=this.rgbToLongMod(84,93,120)}rgbToLongMod(t,e,i){return dt.rgbToLong(qt.redMod*t/114|0,qt.greenMod*e/114|0,qt.blueMod*i/176|0)}handleMouse(t,e,i,s,r=0){if(this.mouseX=t,this.mouseY=e,this.mouseButtonDown=s,this.mouseScrollDelta=r,0!==i&&(this.mouseLastButtonDown=i),1===i)for(let t=0;t<this.controlCount;t++)this.controlShown[t]&&this.controlType[t]===Vt&&this.mouseX>=this.controlX[t]&&this.mouseY>=this.controlY[t]&&this.mouseX<=this.controlX[t]+this.controlWidth[t]&&this.mouseY<=this.controlY[t]+this.controlHeight[t]&&(this.controlClicked[t]=!0),this.controlShown[t]&&this.controlType[t]===Zt&&this.mouseX>=this.controlX[t]&&this.mouseY>=this.controlY[t]&&this.mouseX<=this.controlX[t]+this.controlWidth[t]&&this.mouseY<=this.controlY[t]+this.controlHeight[t]&&(this.controlListEntryMouseButtonDown[t]=1-this.controlListEntryMouseButtonDown[t]);if(1===s?this.mouseMetaButtonHeld++:this.mouseMetaButtonHeld=0,1===i||this.mouseMetaButtonHeld>20){for(let t=0;t<this.controlCount;t++)this.controlShown[t]&&15===this.controlType[t]&&this.mouseX>=this.controlX[t]&&this.mouseY>=this.controlY[t]&&this.mouseX<=this.controlX[t]+this.controlWidth[t]&&this.mouseY<=this.controlY[t]+this.controlHeight[t]&&(this.controlClicked[t]=!0);this.mouseMetaButtonHeld-=5}}isClicked(t){return!(!this.controlShown[t]||!this.controlClicked[t])&&(this.controlClicked[t]=!1,!0)}keyPress(t,e){if(-1!==this.focusControlIndex&&null!==this.controlText[this.focusControlIndex]&&this.controlShown[this.focusControlIndex]){let i=this.controlText[this.focusControlIndex].length;if(8===t||/^Backspace$/.test(e))return void(this.controlText[this.focusControlIndex]=this.controlText[this.focusControlIndex].slice(0,i-1));if(13===t||10===t||/(Enter|Return)/.test(e))return void(this.controlClicked[this.focusControlIndex]=!0);if(9===t||/^Tab$/.test(e)){do{this.focusControlIndex=(this.focusControlIndex+1)%this.controlCount}while(5!==this.controlType[this.focusControlIndex]&&6!==this.controlType[this.focusControlIndex]);return}if(i<this.controlInputMaxLen[this.focusControlIndex]){if(e.length>1)return void console.log(e+" ignored in panel!");this.controlText[this.focusControlIndex]+=e}}}render(){for(let t=0;t<this.controlCount;t++)this.controlShown[t]&&(this.controlType[t]===Dt?this.drawText(t,this.controlX[t],this.controlY[t],this.controlText[t],this.controlTextSize[t]):this.controlType[t]===Xt?this.drawText(t,this.controlX[t]-(this.surface.textWidth(this.controlText[t],this.controlTextSize[t])/2|0),this.controlY[t],this.controlText[t],this.controlTextSize[t]):this.controlType[t]===jt?this.drawBox(this.controlX[t],this.controlY[t],this.controlWidth[t],this.controlHeight[t]):this.controlType[t]===Rt?this.drawLineHoriz(this.controlX[t],this.controlY[t],this.controlWidth[t]):this.controlType[t]===_t?this.drawTextList(t,this.controlX[t],this.controlY[t],this.controlWidth[t],this.controlHeight[t],this.controlTextSize[t],this.controlListEntries[t],this.controlListEntryCount[t],this.controlFlashText[t]):this.controlType[t]===Nt||this.controlType[t]===Ut?this.drawTextInput(t,this.controlX[t],this.controlY[t],this.controlWidth[t],this.controlHeight[t],this.controlText[t],this.controlTextSize[t]):this.controlType[t]===Ht?this.drawOptionListHoriz(t,this.controlX[t],this.controlY[t],this.controlTextSize[t],this.controlListEntries[t]):this.controlType[t]===Ft?this.drawOptionListVert(t,this.controlX[t],this.controlY[t],this.controlTextSize[t],this.controlListEntries[t]):this.controlType[t]===Wt?this.drawTextListInteractive(t,this.controlX[t],this.controlY[t],this.controlWidth[t],this.controlHeight[t],this.controlTextSize[t],this.controlListEntries[t],this.controlListEntryCount[t],this.controlFlashText[t]):this.controlType[t]===Gt?this.drawRoundedBox(this.controlX[t],this.controlY[t],this.controlWidth[t],this.controlHeight[t]):this.controlType[t]===zt?this.drawPicture(this.controlX[t],this.controlY[t],this.controlTextSize[t]):this.controlType[t]===Zt&&this.drawCheckbox(t,this.controlX[t],this.controlY[t],this.controlWidth[t],this.controlHeight[t]));this.mouseLastButtonDown=0}drawCheckbox(t,e,i,s,r){if(this.surface.drawBox(e,i,s,r,16777215),this.surface.drawLineHoriz(e,i,s,this.colourBoxTopNBottom),this.surface.drawLineVert(e,i,r,this.colourBoxTopNBottom),this.surface.drawLineHoriz(e,i+r-1,s,this.colourBoxLeftNRight),this.surface.drawLineVert(e+s-1,i,r,this.colourBoxLeftNRight),1===this.controlListEntryMouseButtonDown[t])for(let t=0;t<r;t++)this.surface.drawLineHoriz(e+t,i+t,1,0),this.surface.drawLineHoriz(e+s-1-t,i+t,1,0)}drawText(t,e,i,s,r){this.drawString(t,e,i+Math.floor(this.surface.textHeight(r)/3),s,r)}drawString(t,e,i,s,r){let n;n=this.controlUseAlternativeColour[t]?16777215:0,this.surface.drawString(s,e,i,r,n)}drawTextInput(t,e,i,s,r,n,o){if(this.controlMaskText[t]){let t=n.length;n="";for(let e=0;e<t;e++)n+="X"}this.controlType[t]===Nt?1===this.mouseLastButtonDown&&this.mouseX>=e&&this.mouseY>=i-Math.floor(r/2)&&this.mouseX<=e+s&&this.mouseY<=i+Math.floor(r/2)&&(this.focusControlIndex=t):this.controlType[t]===Ut&&(1===this.mouseLastButtonDown&&this.mouseX>=e-Math.floor(s/2)&&this.mouseY>=i-Math.floor(r/2)&&this.mouseX<=e+Math.floor(s/2)&&this.mouseY<=i+Math.floor(r/2)&&(this.focusControlIndex=t),e-=Math.floor(this.surface.textWidth(n,o)/2)),this.focusControlIndex===t&&(n+="*"),this.drawString(t,e,i+Math.floor(this.surface.textHeight(o)/3),n,o)}drawBox(t,e,i,s){if(this.surface.setBounds(t,e,t+i,e+s),this.surface.drawGradient(t,e,i,s,this.colourBoxLeftNRight,this.colourBoxTopNBottom),qt.drawBackgroundArrow)for(let r=t-(63&e);r<t+i;r+=128)for(let t=e-(63&e);t<e+s;t+=128)this.surface.f(r,t,6+qt.spriteStart,128);this.surface.drawLineHoriz(t,e,i,this.colourBoxTopNBottom),this.surface.drawLineHoriz(t+1,e+1,i-2,this.colourBoxTopNBottom),this.surface.drawLineHoriz(t+2,e+2,i-4,this.colourBoxTopNBottom2),this.surface.drawLineVert(t,e,s,this.colourBoxTopNBottom),this.surface.drawLineVert(t+1,e+1,s-2,this.colourBoxTopNBottom),this.surface.drawLineVert(t+2,e+2,s-4,this.colourBoxTopNBottom2),this.surface.drawLineHoriz(t,e+s-1,i,this.colourBoxLeftNRight),this.surface.drawLineHoriz(t+1,e+s-2,i-2,this.colourBoxLeftNRight),this.surface.drawLineHoriz(t+2,e+s-3,i-4,this.colourBoxLeftNRight2),this.surface.drawLineVert(t+i-1,e,s,this.colourBoxLeftNRight),this.surface.drawLineVert(t+i-2,e+1,s-2,this.colourBoxLeftNRight),this.surface.drawLineVert(t+i-3,e+2,s-4,this.colourBoxLeftNRight2),this.surface.resetBounds()}drawRoundedBox(t,e,i,s){this.surface.drawBox(t,e,i,s,0),this.surface.drawBoxEdge(t,e,i,s,this.colourRoundedBoxOut),this.surface.drawBoxEdge(t+1,e+1,i-2,s-2,this.colourRoundedBoxMid),this.surface.drawBoxEdge(t+2,e+2,i-4,s-4,this.colourRoundedBoxIn),this.surface.drawSpriteID(t,e,2+qt.spriteStart),this.surface.drawSpriteID(t+i-7,e,3+qt.spriteStart),this.surface.drawSpriteID(t,e+s-7,4+qt.spriteStart),this.surface.drawSpriteID(t+i-7,e+s-7,5+qt.spriteStart)}drawPicture(t,e,i){this.surface.drawSpriteID(t,e,i)}drawLineHoriz(t,e,i){this.surface.drawLineHoriz(t,e,i,16777215)}drawTextList(t,e,i,s,r,n,o,a,h){let l=r/this.surface.textHeight(n)|0,u=a-l;if(h=Math.max(0,Math.min(h,u)),this.controlFlashText[t]=h,l<a){let n=e+s-12,o=Math.max(6,(r-27)*l/a|0),c=(r-27-o)*h/u|0;0!==this.mouseScrollDelta&&this.mouseX>e&&this.mouseX<e+s&&this.mouseY>i&&this.mouseY<i+r&&(h=Math.max(0,Math.min(h+this.mouseScrollDelta,u)),this.controlFlashText[t]=h),1===this.mouseButtonDown&&this.mouseX>=n&&this.mouseX<=n+12&&(this.mouseY>i&&this.mouseY<i+12&&h>0?h--:this.mouseY>i+r-12&&this.mouseY<i+r&&h<a-l&&h++,this.controlFlashText[t]=Math.max(0,Math.min(h,u))),1===this.mouseButtonDown&&(this.mouseX>=n&&this.mouseX<=n+12||this.mouseX>=n-12&&this.mouseX<=n+24&&this.controlListScrollbarHandleDragged[t])?this.mouseY>i+12&&this.mouseY<i+r-12&&(this.controlListScrollbarHandleDragged[t]=!0,h=Math.max(0,Math.min((this.mouseY-i-12-(o/2|0))*a/(r-24)|0,u)),this.controlFlashText[t]=h):this.controlListScrollbarHandleDragged[t]=!1,c=(r-27-o)*h/(a-l)|0,this.drawListContainer(e,i,s,r,c,o)}let c=r-l*this.surface.textHeight(n),d=i+(5*this.surface.textHeight(n)/6+c/2)|0;for(let s=h;s<a;s++)if(this.drawString(t,e+2,d,o[s],n),d+=this.surface.textHeight(n)-qt.textListEntryHeightMod,d>=i+r)return}drawListContainer(t,e,i,s,r,n){this.surface.drawBoxEdge(t+i-12,e,12,s,0),this.surface.drawSpriteID(t+i-12+1,e+1,qt.spriteStart),this.surface.drawSpriteID(t+i-12+1,e+s-12,qt.spriteStart+1),this.surface.drawLineHoriz(t+i-12,e+13,12,0),this.surface.drawLineHoriz(t+i-12,e+s-13,12,0),this.surface.drawGradient(t+i-12+1,e+14,11,s-27,this.colourScrollbarTop,this.colourScrollbarBottom),this.surface.drawBox(t+i-12+3,r+e+14,7,n,this.colourScrollbarHandleMid),this.surface.drawLineVert(t+i-12+2,r+e+14,n,this.colourScrollbarHandleLeft),this.surface.drawLineVert(t+i-12+2+8,r+e+14,n,this.colourScrollbarHandleRight)}drawOptionListHoriz(t,e,i,s,r){let n=0,o=r.length;for(let t=0;t<o;t++)n+=this.surface.textWidth(r[t],s),t<o-1&&(n+=this.surface.textWidth("  ",s));let a=e-(n/2|0),h=i+(this.surface.textHeight(s)/3|0);for(let e=0;e<o;e++){let i;i=this.controlUseAlternativeColour[t]?16777215:0,this.mouseX>=a&&this.mouseX<=a+this.surface.textWidth(r[e],s)&&this.mouseY<=h&&this.mouseY>h-this.surface.textHeight(s)&&(i=this.controlUseAlternativeColour[t]?8421504:16777215,1===this.mouseLastButtonDown&&(this.controlListEntryMouseButtonDown[t]=e,this.controlClicked[t]=!0)),this.controlListEntryMouseButtonDown[t]===e&&(i=this.controlUseAlternativeColour[t]?16711680:12582912),this.surface.drawString(r[e],a,h,s,i),a+=this.surface.textWidth(r[e]+"  ",s)}}drawOptionListVert(t,e,i,s,r){let n=r.length,o=i-(this.surface.textHeight(s)*(n-1)/2|0);for(let i=0;i<n;i++){let n;n=this.controlUseAlternativeColour[t]?16777215:0;let a=this.surface.textWidth(r[i],s);this.mouseX>=e-(a/2|0)&&this.mouseX<=e+(a/2|0)&&this.mouseY-2<=o&&this.mouseY-2>o-this.surface.textHeight(s)&&(n=this.controlUseAlternativeColour[t]?8421504:16777215,1===this.mouseLastButtonDown&&(this.controlListEntryMouseButtonDown[t]=i,this.controlClicked[t]=!0)),this.controlListEntryMouseButtonDown[t]===i&&(n=this.controlUseAlternativeColour[t]?16711680:12582912),this.surface.drawString(r[i],e-(a/2|0),o,s,n),o+=this.surface.textHeight(s)}}drawTextListInteractive(t,e,i,s,r,n,o,a,h){let l=r/this.surface.textHeight(n)|0,u=a-l;if(l<a){let n=e+s-12,o=Math.max(6,(r-27)*l/a|0),c=(r-27-o)*h/u|0;if(0!==this.mouseScrollDelta&&this.mouseX>e&&this.mouseX<e+s&&this.mouseY>i&&this.mouseY<i+r&&(h+=this.mouseScrollDelta,this.controlFlashText[t]=Math.max(0,Math.min(h,u))),1===this.mouseButtonDown&&this.mouseX>=n&&this.mouseX<=n+12&&(this.mouseY>i&&this.mouseY<i+12&&h>0&&h--,this.mouseY>i+r-12&&this.mouseY<i+r&&h<u&&h++,this.controlFlashText[t]=Math.max(0,Math.min(h,u))),1===this.mouseButtonDown&&(this.mouseX>=n&&this.mouseX<=n+12||this.mouseX>=n-12&&this.mouseX<=n+24&&this.controlListScrollbarHandleDragged[t])){if(this.mouseY>i+12&&this.mouseY<i+r-12){this.controlListScrollbarHandleDragged[t]=!0,h=(this.mouseY-i-12-(o/2|0))*a/(r-24)|0,this.controlFlashText[t]=Math.max(0,Math.min(h,u))}}else this.controlListScrollbarHandleDragged[t]=!1;c=(r-27-o)*h/u|0,this.drawListContainer(e,i,s,r,c,o)}else h=0,this.controlFlashText[t]=0;this.controlListEntryMouseOver[t]=-1;let c=r-l*this.surface.textHeight(n),d=i+((5*this.surface.textHeight(n)/6|0)+c/2|0);for(let s=h;s<a;s++){let a;if(a=this.controlUseAlternativeColour[t]?16777215:0,this.mouseX>=e+2&&this.mouseX<=e+2+this.surface.textWidth(o[s],n)&&this.mouseY-2<=d&&this.mouseY-2>d-this.surface.textHeight(n)&&(a=this.controlUseAlternativeColour[t]?8421504:16777215,this.controlListEntryMouseOver[t]=s,1===this.mouseLastButtonDown&&(this.controlListEntryMouseButtonDown[t]=s,this.controlClicked[t]=!0)),this.controlListEntryMouseButtonDown[t]===s&&this.aBoolean219&&(a=16711680),this.surface.drawString(o[s],e+2,d,n,a),d+=this.surface.textHeight(n),d>=i+r)return}}toggleCheckbox(t,e){this.controlListEntryMouseButtonDown[t]=e?1:0}isActivated(t){return 1===this.controlListEntryMouseButtonDown[t]}addTextAbsolute(t,e,i,s,r){return this.controlType[this.controlCount]=Dt,this.controlShown[this.controlCount]=!0,this.controlClicked[this.controlCount]=!1,this.controlTextSize[this.controlCount]=s,this.controlUseAlternativeColour[this.controlCount]=r,this.controlX[this.controlCount]=t,this.controlY[this.controlCount]=e,this.controlText[this.controlCount]=i,this.controlCount++}addText(t,e,i,s,r){return this.controlType[this.controlCount]=1,this.controlShown[this.controlCount]=!0,this.controlClicked[this.controlCount]=!1,this.controlTextSize[this.controlCount]=s,this.controlUseAlternativeColour[this.controlCount]=r,this.controlX[this.controlCount]=t,this.controlY[this.controlCount]=e,this.controlText[this.controlCount]=i,this.controlCount++}addButtonBackground(t,e,i,s){return this.controlType[this.controlCount]=2,this.controlShown[this.controlCount]=!0,this.controlClicked[this.controlCount]=!1,this.controlX[this.controlCount]=t-Math.floor(i/2),this.controlY[this.controlCount]=e-Math.floor(s/2),this.controlWidth[this.controlCount]=i,this.controlHeight[this.controlCount]=s,this.controlCount++}addBoxRounded(t,e,i,s){return this.controlType[this.controlCount]=11,this.controlShown[this.controlCount]=!0,this.controlClicked[this.controlCount]=!1,this.controlX[this.controlCount]=t-Math.floor(i/2),this.controlY[this.controlCount]=e-Math.floor(s/2),this.controlWidth[this.controlCount]=i,this.controlHeight[this.controlCount]=s,this.controlCount++}addSprite(t,e,i){let s=this.surface.spriteWidth[i],r=this.surface.spriteHeight[i];return this.controlType[this.controlCount]=zt,this.controlShown[this.controlCount]=!0,this.controlClicked[this.controlCount]=!1,this.controlX[this.controlCount]=t-Math.floor(s/2),this.controlY[this.controlCount]=e-Math.floor(r/2),this.controlWidth[this.controlCount]=s,this.controlHeight[this.controlCount]=r,this.controlTextSize[this.controlCount]=i,this.controlCount++}addTextList(t,e,i,s,r,n,o){return this.controlType[this.controlCount]=_t,this.controlShown[this.controlCount]=!0,this.controlClicked[this.controlCount]=!1,this.controlX[this.controlCount]=t,this.controlY[this.controlCount]=e,this.controlWidth[this.controlCount]=i,this.controlHeight[this.controlCount]=s,this.controlUseAlternativeColour[this.controlCount]=o,this.controlTextSize[this.controlCount]=r,this.controlInputMaxLen[this.controlCount]=n,this.controlListEntryCount[this.controlCount]=0,this.controlFlashText[this.controlCount]=0,this.controlListEntries[this.controlCount]=new Array(n),this.controlCount++}addTextListInput(t,e,i,s,r,n,o,a){return this.controlType[this.controlCount]=Nt,this.controlShown[this.controlCount]=!0,this.controlMaskText[this.controlCount]=o,this.controlClicked[this.controlCount]=!1,this.controlTextSize[this.controlCount]=r,this.controlUseAlternativeColour[this.controlCount]=a,this.controlX[this.controlCount]=t,this.controlY[this.controlCount]=e,this.controlWidth[this.controlCount]=i,this.controlHeight[this.controlCount]=s,this.controlInputMaxLen[this.controlCount]=n,this.controlText[this.controlCount]="",this.controlCount++}addTextInput(t,e,i,s,r,n,o,a){return this.controlType[this.controlCount]=Ut,this.controlShown[this.controlCount]=!0,this.controlMaskText[this.controlCount]=o,this.controlClicked[this.controlCount]=!1,this.controlTextSize[this.controlCount]=r,this.controlUseAlternativeColour[this.controlCount]=a,this.controlX[this.controlCount]=t,this.controlY[this.controlCount]=e,this.controlWidth[this.controlCount]=i,this.controlHeight[this.controlCount]=s,this.controlInputMaxLen[this.controlCount]=n,this.controlText[this.controlCount]="",this.controlCount++}addTextListInteractive(t,e,i,s,r,n,o){return this.controlType[this.controlCount]=Wt,this.controlShown[this.controlCount]=!0,this.controlClicked[this.controlCount]=!1,this.controlTextSize[this.controlCount]=r,this.controlUseAlternativeColour[this.controlCount]=o,this.controlX[this.controlCount]=t,this.controlY[this.controlCount]=e,this.controlWidth[this.controlCount]=i,this.controlHeight[this.controlCount]=s,this.controlInputMaxLen[this.controlCount]=n,this.controlListEntries[this.controlCount]=new Array(n),this.controlListEntryCount[this.controlCount]=0,this.controlFlashText[this.controlCount]=0,this.controlListEntryMouseButtonDown[this.controlCount]=-1,this.controlListEntryMouseOver[this.controlCount]=-1,this.controlCount++}addButton(t,e,i,s){return this.controlType[this.controlCount]=Vt,this.controlShown[this.controlCount]=!0,this.controlClicked[this.controlCount]=!1,this.controlX[this.controlCount]=t-Math.floor(i/2),this.controlY[this.controlCount]=e-Math.floor(s/2),this.controlWidth[this.controlCount]=i,this.controlHeight[this.controlCount]=s,this.controlCount++}addLineHoriz(t,e,i){return this.controlType[this.controlCount]=Rt,this.controlShown[this.controlCount]=!0,this.controlX[this.controlCount]=t,this.controlY[this.controlCount]=e,this.controlWidth[this.controlCount]=i,this.controlCount++}addOptionListHoriz(t,e,i,s,r){return this.controlType[this.controlCount]=Ht,this.controlShown[this.controlCount]=!0,this.controlX[this.controlCount]=t,this.controlY[this.controlCount]=e,this.controlTextSize[this.controlCount]=i,this.controlListEntries[this.controlCount]=new Array(s),this.controlListEntryCount[this.controlCount]=0,this.controlUseAlternativeColour[this.controlCount]=r,this.controlClicked[this.controlCount]=!1,this.controlCount++}addOptionListVert(t,e,i,s,r){return this.controlType[this.controlCount]=Ft,this.controlShown[this.controlCount]=!0,this.controlX[this.controlCount]=t,this.controlY[this.controlCount]=e,this.controlTextSize[this.controlCount]=i,this.controlListEntries[this.controlCount]=new Array(s),this.controlListEntryCount[this.controlCount]=0,this.controlUseAlternativeColour[this.controlCount]=r,this.controlClicked[this.controlCount]=!1,this.controlCount++}addCheckbox(t,e,i,s){return this.controlType[this.controlCount]=Zt,this.controlShown[this.controlCount]=!0,this.controlX[this.controlCount]=t,this.controlY[this.controlCount]=e,this.controlWidth[this.controlCount]=i,this.controlHeight[this.controlCount]=s,this.controlListEntryMouseButtonDown[this.controlCount]=0,this.controlCount++}clearList(t){this.controlListEntryCount[t]=0}resetListProps(t){this.controlFlashText[t]=0,this.controlListEntryMouseOver[t]=-1}addListEntry(t,e,i){this.controlListEntries[t][e]=i,e+1>this.controlListEntryCount[t]&&(this.controlListEntryCount[t]=e+1,this.controlListEntryCount[t])}removeListEntry(t,e,i){let s=this.controlListEntryCount[t]++;if(s>=this.controlInputMaxLen[t]){s--,this.controlListEntryCount[t]--;for(let e=0;e<s;e++)this.controlListEntries[t][e]=this.controlListEntries[t][e+1]}this.controlListEntries[t][s]=e,i&&(this.controlFlashText[t]=999999)}setTextHandle(t,e){this.controlText[t]=e}getText(t){return this.controlText[t]?this.controlText[t]:"null"}setVisible(t,e=!0){this.controlShown[t]=e}setFocus(t){this.focusControlIndex=t}getListEntryIndex(t){return this.controlListEntryMouseOver[t]}}Object.defineProperty(qt,"spriteStart",{get:()=>qt._spriteStart||2100,set:t=>{qt._spriteStart=t}}),Object.defineProperty(qt,"drawBackgroundArrow",{get:()=>qt._drawBackgroundArrow||!1,set:t=>{qt._drawBackgroundArrow=t}}),Object.defineProperty(qt,"redMod",{get:()=>qt._redMod||114,set:t=>{qt._redMod=t}}),Object.defineProperty(qt,"greenMod",{get:()=>qt._greenMod||114,set:t=>{qt._greenMod=t}}),Object.defineProperty(qt,"blueMod",{get:()=>qt._blueMod||176,set:t=>{qt._greenMod=t}}),Object.defineProperty(qt,"textListEntryHeightMod",{get:()=>qt._textListEntryHeightMod||0,set:t=>{qt._textListEntryHeightMod=t}});class Kt extends nt{constructor(t=0){super(200),this.id=t}get x(){return this._x}set x(t){this._x=t}get y(){return this._y}set y(t){this._y=t}set scale(t){this._scale=t}get scale(){return this._scale}}var $t=n(9),Jt=n.n($t),Qt=n(10);class te{constructor(){this.player=new Jt.a({encoding:"16bitInt",channels:1,sampleRate:8e3})}stopPlayer(){this.player.destroy()}writeStream(t,e,i){const s=Qt.mulaw.decode(new Uint8Array(t.slice(e,e+i)));this.player.feed(s)}}class ee extends dt{constructor(t,e,i,s){super(t,e,i,s),this.mudclientref=null}_spriteClipping_from7(t,e,i,s,r,n,o){if(r>=5e4)this.mudclientref.drawTeleportBubble(t,e,i,s,r-5e4,n,o);else if(r>=4e4)this.mudclientref.drawItem(t,e,i,s,r-4e4,n,o);else{if(!(r>=2e4))return r>=5e3?void this.mudclientref.drawPlayer(t,e,i,s,r-5e3,n,o):void super._spriteClipping_from5(t,e,i,s,r);this.mudclientref.drawNpc(t,e,i,s,r-2e4,n,o)}}}class ie{constructor(t,e){this.regionWidth=96,this.regionHeight=96,this.tileSize=128,this.parentModel=null,this.landscapePack=null,this.mapPack=null,this.memberLandscapePack=null,this.memberMapPack=null,this.worldInitialised=!0,this.objectAdjacency=kt()(new Int32Array(this.regionWidth*this.regionHeight),[this.regionWidth,this.regionHeight]),this.tileDirection=kt()(new Int8Array(9216),[4,2304]),this.wallModels=[],this.roofModels=[];for(let t=0;t<4;t+=1){this.wallModels.push([]),this.roofModels.push([]);for(let e=0;e<64;e+=1)this.wallModels[t].push(null),this.roofModels[t].push(null)}this.terrainColours=new Int32Array(256),this.wallsNorthSouth=kt()(new Int8Array(9216),[4,2304]),this.wallsRoof=kt()(new Int8Array(9216),[4,2304]),this.terrainHeight=kt()(new Int8Array(9216),[4,2304]),this.terrainColour=kt()(new Int8Array(9216),[4,2304]),this.localY=new Int32Array(18432),this.tileDecoration=kt()(new Int8Array(9216),[4,2304]),this.routeVia=kt()(new Int32Array(this.regionWidth*this.regionHeight),[this.regionWidth,this.regionHeight]),this.wallsDiagonal=kt()(new Int32Array(9216),[4,2304]),this.wallsEastWest=kt()(new Int8Array(9216),[4,2304]),this.aBoolean592=!1,this.playerAlive=!1,this.terrainHeightLocal=kt()(new Int32Array(this.regionWidth*this.regionHeight),[this.regionWidth,this.regionHeight]),this.terrainModels=[],this.terrainModels.length=64,this.terrainModels.fill(null),this.localX=new Int32Array(18432),this.baseMediaSprite=750,this.scene=t,this.surface=e;for(let t=0;t<64;t++)this.terrainColours[t]=Ot.rgb(255-4*t,255-(1.75*t|0),255-4*t);for(let t=0;t<64;t++)this.terrainColours[t+64]=Ot.rgb(3*t,144,0);for(let t=0;t<64;t++)this.terrainColours[t+128]=Ot.rgb(192-(1.5*t|0),144-(1.5*t|0),0);for(let t=0;t<64;t++)this.terrainColours[t+192]=Ot.rgb(96-(1.5*t|0),48+(1.5*t|0),0)}getWallEastWest(t,e){if(t<0||t>=this.regionWidth||e<0||e>=this.regionHeight)return 0;let i=0;return t>=48&&e<48?(i=1,t-=48):t<48&&e>=48?(i=2,e-=48):t>=48&&e>=48&&(i=3,t-=48,e-=48),255&this.wallsEastWest.get(i,48*t+e)}setTerrainAmbience(t,e,i,s,r){let n=this.terrainModels[t+8*e];for(let t=0;t<n.numVertices;t++)if(n.vertexX[t]===i*this.tileSize&&n.vertexZ[t]===s*this.tileSize)return void n.setVertexAmbience(t,r)}getWallRoof(t,e){if(t<0||t>=this.regionWidth||e<0||e>=this.regionHeight)return 0;let i=0;return t>=48&&e<48?(i=1,t-=48):t<48&&e>=48?(i=2,e-=48):t>=48&&e>=48&&(i=3,t-=48,e-=48),this.wallsRoof.get(i,48*t+e)}getElevation(t,e){let i=t>>7,s=e>>7,r=127&t,n=127&e;if(i<0||s<0||i>=95||s>=95)return 0;let o=0,a=0,h=0;return r<=this.tileSize-n?(o=this.getTerrainHeight(i,s),a=this.getTerrainHeight(i+1,s)-o,h=this.getTerrainHeight(i,s+1)-o):(o=this.getTerrainHeight(i+1,s+1),a=this.getTerrainHeight(i,s+1)-o,h=this.getTerrainHeight(i+1,s)-o,r=this.tileSize-r,n=this.tileSize-n),o+(a*r/this.tileSize|0)+(h*n/this.tileSize|0)}getWallDiagonal(t,e){if(t<0||t>=this.regionWidth||e<0||e>=this.regionHeight)return 0;let i=0;return t>=48&&e<48?(i=1,t-=48):t<48&&e>=48?(i=2,e-=48):t>=48&&e>=48&&(i=3,t-=48,e-=48),this.wallsDiagonal.get(i,48*t+e)}removeObject2(t,e,i){if(!(t<0||e<0||t>=95||e>=95||1!==Et.objectType[i]&&2!==Et.objectType[i])){let s=this.getTileDirection(t,e),r=0,n=0;0===s||4===s?(r=Et.objectWidth[i],n=Et.objectHeight[i]):(n=Et.objectWidth[i],r=Et.objectHeight[i]);for(let o=t;o<t+r;o++)for(let t=e;t<e+n;t++){const e=this.objectAdjacency.get(o,t);1===Et.objectType[i]?this.objectAdjacency.set(o,t,64|e):0===s?(this.objectAdjacency.set(o,t,2|e),o>0&&this._setObjectAdjacency_from3(o-1,t,8)):2===s?(this.objectAdjacency.set(o,t,4|e),t<95&&this._setObjectAdjacency_from3(o,t+1,1)):4===s?(this.objectAdjacency.set(o,t,8|e),o<95&&this._setObjectAdjacency_from3(o+1,t,2)):6===s&&(this.objectAdjacency.set(o,t,1|e),t>0&&this._setObjectAdjacency_from3(o,t-1,4))}this.method404(t,e,r,n)}}removeWallObject(t,e,i,s){if(!(t<0||e<0||t>=95||e>=95)&&1===Et.wallObjectAdjacent[s]){const s=this.objectAdjacency.get(t,e);0===i?(this.objectAdjacency.set(t,e,65534&s),e>0&&this.method407(t,e-1,4)):1===i?(this.objectAdjacency.set(t,e,65533&s),t>0&&this.method407(t-1,e,8)):2===i?this.objectAdjacency.set(t,e,65519&s):3===i&&this.objectAdjacency.set(t,e,65503&s),this.method404(t,e,1,1)}}method402(t,e,i,s,r){let n=3*t,o=3*e,a=this.scene.method302(s),h=this.scene.method302(r);if(a=a>>1&8355711,h=h>>1&8355711,0===i)return this.surface.drawLineHoriz(n,o,3,a),this.surface.drawLineHoriz(n,o+1,2,a),this.surface.drawLineHoriz(n,o+2,1,a),this.surface.drawLineHoriz(n+2,o+1,1,h),void this.surface.drawLineHoriz(n+1,o+2,2,h);1===i&&(this.surface.drawLineHoriz(n,o,3,h),this.surface.drawLineHoriz(n+1,o+1,2,h),this.surface.drawLineHoriz(n+2,o+2,1,h),this.surface.drawLineHoriz(n,o+1,1,a),this.surface.drawLineHoriz(n,o+2,2,a))}decodeSector(t,e,i,s){let r="m"+i+(t/10|0)+t%10+(e/10|0)+e%10;if(null!==this.landscapePack){let t=S.loadData(r+".hei",0,this.landscapePack);if(null===t&&null!==this.memberLandscapePack&&(t=S.loadData(r+".hei",0,this.memberLandscapePack)),null!==t&&t.length>0){let e=0,i=0;for(let r=0;r<2304;){let n=255&t[e++];if(n<128&&(this.terrainHeight.set(s,r++,255&n),i=n),n>=128)for(let t=0;t<n-128;t++)this.terrainHeight.set(s,r++,255&i)}i=64;for(let t=0;t<48;t++)for(let e=0;e<48;e++)i=this.terrainHeight.get(s,48*e+t)+i&127,this.terrainHeight.set(s,48*e+t,2*i&255);i=0;for(let r=0;r<2304;){let n=255&t[e++];if(n<128&&(this.terrainColour.set(s,r++,255&n),i=n),n>=128)for(let t=0;t<n-128;t++)this.terrainColour.set(s,r++,255&i)}i=35;for(let t=0;t<48;t++)for(let e=0;e<48;e++)i=this.terrainColour.get(s,48*e+t)+i&127,this.terrainColour.set(s,48*e+t,2*i&255)}else for(let t=0;t<2304;t++)this.terrainHeight.set(s,t,0),this.terrainColour.set(s,t,0);if(t=S.loadData(r+".dat",0,this.mapPack),null===t&&null!==this.memberMapPack&&(t=S.loadData(r+".dat",0,this.memberMapPack)),null===t||0===t.length){for(let t=0;t<2304;t++)this.terrainHeight.set(s,t,0),this.terrainColour.set(s,t,0),this.wallsNorthSouth.set(s,t,0),this.wallsEastWest.set(s,t,0),this.wallsDiagonal.set(s,t,0),this.wallsRoof.set(s,t,0),this.tileDecoration.set(s,t,0),0===i&&this.tileDecoration.set(s,t,-6),3===i&&this.tileDecoration.set(s,t,8),this.tileDirection.set(s,t,0);return}let e=0;for(let i=0;i<2304;i++)this.wallsNorthSouth.set(s,i,t[e++]);for(let i=0;i<2304;i++)this.wallsEastWest.set(s,i,t[e++]);for(let i=0;i<2304;i++)this.wallsDiagonal.set(s,i,255&t[e++]);for(let i=0;i<2304;i++){let r=255&t[e++];r>0&&this.wallsDiagonal.set(s,i,r+12e3)}for(let i=0;i<2304;){let r=255&t[e++];if(r<128)this.wallsRoof.set(s,i++,255&r);else for(let t=0;t<r-128;t++)this.wallsRoof.set(s,i++,0)}let n=0;for(let i=0;i<2304;){let r=255&t[e++];if(r<128)this.tileDecoration.set(s,i++,255&r),n=r;else for(let t=0;t<r-128;t++)this.tileDecoration.set(s,i++,n)}for(let i=0;i<2304;){let r=255&t[e++];if(r<128)this.tileDirection.set(s,i++,255&r);else for(let t=0;t<r-128;t++)this.tileDirection.set(s,i++,0)}if(t=S.loadData(r+".loc",0,this.mapPack),null!==t&&t.length>0){e=0;for(let i=0;i<2304;){let r=255&t[e++];r<128?this.wallsDiagonal.set(s,i++,r+48e3):i+=r-128}}}}loadSection(...t){switch(t.length){case 3:return this._loadSection_from3(...t);case 4:return"number"==typeof t[3]?this.decodeSector(...t):this.loadRegionThenMakeModel(...t)}}method404(t,e,i,s){if(!(t<1||e<1||t+i>=this.regionWidth||e+s>=this.regionHeight))for(let r=t;r<=t+i;r++)for(let t=e;t<=e+s;t++)0!=(99&this.getObjectAdjacency(r,t))||0!=(89&this.getObjectAdjacency(r-1,t))||0!=(86&this.getObjectAdjacency(r,t-1))||0!=(108&this.getObjectAdjacency(r-1,t-1))?this.method425(r,t,35):this.method425(r,t,0)}getObjectAdjacency(t,e){return t<0||e<0||t>=this.regionWidth||e>=this.regionHeight?0:this.objectAdjacency.get(t,e)}hasRoof(t,e){return this.getWallRoof(t,e)>0&&this.getWallRoof(t-1,e)>0&&this.getWallRoof(t-1,e-1)>0&&this.getWallRoof(t,e-1)>0}method407(t,e,i){const s=this.objectAdjacency.get(t,e);this.objectAdjacency.set(t,e,s&65535-i)}getTerrainColour(t,e){if(t<0||t>=this.regionWidth||e<0||e>=this.regionHeight)return 0;let i=0;return t>=48&&e<48?(i=1,t-=48):t<48&&e>=48?(i=2,e-=48):t>=48&&e>=48&&(i=3,t-=48,e-=48),255&this.terrainColour.get(i,48*t+e)}reset(){this.worldInitialised&&this.scene.dispose();for(let t=0;t<64;t++){this.terrainModels[t]=null;for(let e=0;e<4;e++)this.wallModels[e][t]=null;for(let e=0;e<4;e++)this.roofModels[e][t]=null}}fillEmptySectorsAndBorder(){for(let t=0;t<this.regionWidth;t++)for(let e=0;e<this.regionHeight;e++)250===this.getOverlayID(t,e,0)&&(47===t&&250!==this.getOverlayID(t+1,e,0)&&2!==this.getOverlayID(t+1,e,0)||47===e&&250!==this.getOverlayID(t,e+1,0)&&2!==this.getOverlayID(t,e+1,0)?this.setTileDecoration(t,e,9):this.setTileDecoration(t,e,2))}getWallNorthSouth(t,e){if(t<0||t>=this.regionWidth||e<0||e>=this.regionHeight)return 0;let i=0;return t>=48&&e<48?(i=1,t-=48):t<48&&e>=48?(i=2,e-=48):t>=48&&e>=48&&(i=3,t-=48,e-=48),255&this.wallsNorthSouth.get(i,48*t+e)}getTileDirection(t,e){if(t<0||t>=this.regionWidth||e<0||e>=this.regionHeight)return 0;let i=0;return t>=48&&e<48?(i=1,t-=48):t<48&&e>=48?(i=2,e-=48):t>=48&&e>=48&&(i=3,t-=48,e-=48),this.tileDirection.get(i,48*t+e)}_getTileDecoration_from4(t,e,i,s){let r=this._getTileDecoration_from3(t,e,i);return 0===r?s:Et.tileDecoration[r-1]}_getTileDecoration_from3(t,e,i){if(t<0||t>=this.regionWidth||e<0||e>=this.regionHeight)return 0;let s=0;return t>=48&&e<48?(s=1,t-=48):t<48&&e>=48?(s=2,e-=48):t>=48&&e>=48&&(s=3,t-=48,e-=48),255&this.tileDecoration.get(s,48*t+e)}getOverlayID(...t){switch(t.length){case 3:return this._getTileDecoration_from3(...t);case 4:return this._getTileDecoration_from4(...t)}}setTileDecoration(t,e,i){if(t<0||t>=this.regionWidth||e<0||e>=this.regionHeight)return;let s=0;t>=48&&e<48?(s=1,t-=48):t<48&&e>=48?(s=2,e-=48):t>=48&&e>=48&&(s=3,t-=48,e-=48),this.tileDecoration.set(s,48*t+e,255&i)}route(t,e,i,s,r,n,o,a,h){for(let t=0;t<this.regionWidth;t++)for(let e=0;e<this.regionHeight;e++)this.routeVia.set(t,e,0);let l=0,u=0,c=t,d=e;this.routeVia.set(t,e,99),o[l]=t,a[l++]=e;let m,p=o.length,f=!1;for(;u!==l;){if(c=o[u],d=a[u],u=(u+1)%p,c>=i&&c<=r&&d>=s&&d<=n){f=!0;break}if(h){if(c>0&&c-1>=i&&c-1<=r&&d>=s&&d<=n&&0==(8&this.objectAdjacency.get(c-1,d))){f=!0;break}if(c<95&&c+1>=i&&c+1<=r&&d>=s&&d<=n&&0==(2&this.objectAdjacency.get(c+1,d))){f=!0;break}if(d>0&&c>=i&&c<=r&&d-1>=s&&d-1<=n&&0==(4&this.objectAdjacency.get(c,d-1))){f=!0;break}if(d<95&&c>=i&&c<=r&&d+1>=s&&d+1<=n&&0==(1&this.objectAdjacency.get(c,d+1))){f=!0;break}}c>0&&0===this.routeVia.get(c-1,d)&&0==(120&this.objectAdjacency.get(c-1,d))&&(o[l]=c-1,a[l]=d,l=(l+1)%p,this.routeVia.set(c-1,d,2)),c<95&&0===this.routeVia.get(c+1,d)&&0==(114&this.objectAdjacency.get(c+1,d))&&(o[l]=c+1,a[l]=d,l=(l+1)%p,this.routeVia.set(c+1,d,8)),d>0&&0===this.routeVia.get(c,d-1)&&0==(116&this.objectAdjacency.get(c,d-1))&&(o[l]=c,a[l]=d-1,l=(l+1)%p,this.routeVia.set(c,d-1,1)),d<95&&0===this.routeVia.get(c,d+1)&&0==(113&this.objectAdjacency.get(c,d+1))&&(o[l]=c,a[l]=d+1,l=(l+1)%p,this.routeVia.set(c,d+1,4)),c>0&&d>0&&0==(116&this.objectAdjacency.get(c,d-1))&&0==(120&this.objectAdjacency.get(c-1,d))&&0==(124&this.objectAdjacency.get(c-1,d-1))&&0===this.routeVia.get(c-1,d-1)&&(o[l]=c-1,a[l]=d-1,l=(l+1)%p,this.routeVia.set(c-1,d-1,3)),c<95&&d>0&&0==(116&this.objectAdjacency.get(c,d-1))&&0==(114&this.objectAdjacency.get(c+1,d))&&0==(118&this.objectAdjacency.get(c+1,d-1))&&0===this.routeVia.get(c+1,d-1)&&(o[l]=c+1,a[l]=d-1,l=(l+1)%p,this.routeVia.set(c+1,d-1,9)),c>0&&d<95&&0==(113&this.objectAdjacency.get(c,d+1))&&0==(120&this.objectAdjacency.get(c-1,d))&&0==(121&this.objectAdjacency.get(c-1,d+1))&&0===this.routeVia.get(c-1,d+1)&&(o[l]=c-1,a[l]=d+1,l=(l+1)%p,this.routeVia.set(c-1,d+1,6)),c<95&&d<95&&0==(113&this.objectAdjacency.get(c,d+1))&&0==(114&this.objectAdjacency.get(c+1,d))&&0==(115&this.objectAdjacency.get(c+1,d+1))&&0===this.routeVia.get(c+1,d+1)&&(o[l]=c+1,a[l]=d+1,l=(l+1)%p,this.routeVia.set(c+1,d+1,12))}if(!f)return-1;u=0,o[u]=c,a[u++]=d;for(let i=m=this.routeVia.get(c,d);c!==t||d!==e;i=this.routeVia.get(c,d))i!==m&&(m=i,o[u]=c,a[u++]=d),0!=(2&i)?c++:0!=(8&i)&&c--,0!=(1&i)?d++:0!=(4&i)&&d--;return u}_setObjectAdjacency_from4(t,e,i,s){if(!(t<0||e<0||t>=95||e>=95)&&1===Et.wallObjectAdjacent[s]){const s=this.objectAdjacency.get(t,e);0===i?(this.objectAdjacency.set(t,e,1|s),e>0&&this._setObjectAdjacency_from3(t,e-1,4)):1===i?(this.objectAdjacency.set(t,e,2|s),t>0&&this._setObjectAdjacency_from3(t-1,e,8)):2===i?this.objectAdjacency.set(t,e,16|s):3===i&&this.objectAdjacency.set(t,e,32|s),this.method404(t,e,1,1)}}setObjectAdjacency(...t){switch(t.length){case 4:return this._setObjectAdjacency_from4(...t);case 3:return this._setObjectAdjacency_from3(...t)}}loadRegionThenMakeModel(t,e,i,s){let r=(t+24)/48|0,n=(e+24)/48|0;if(this.decodeSector(r-1,n-1,i,0),this.decodeSector(r,n-1,i,1),this.decodeSector(r-1,n,i,2),this.decodeSector(r,n,i,3),this.fillEmptySectorsAndBorder(),null===this.parentModel&&(this.parentModel=Yt._from7(18688,18688,!0,!0,!1,!1,!0)),s){this.surface.blackScreen();for(let t=0;t<this.regionWidth;t++)for(let e=0;e<this.regionHeight;e++)this.objectAdjacency.set(t,e,0);let t=this.parentModel;t.clear();for(let e=0;e<this.regionWidth;e++)for(let s=0;s<this.regionHeight;s++){let r=-this.getTerrainHeight(e,s);for(let t=-1;t<1;t++)for(let n=-1;n<1;n++){let o=this.getOverlayID(e+t,s+n,i);if(o>0&&4===Et.overlays[o-1]){r=0;break}}let n=t.vertexAt(e*this.tileSize,r,s*this.tileSize),o=(10*Math.random()|0)-5;t.setVertexAmbience(n,o)}for(let e=0;e<95;e++)for(let s=0;s<95;s++){let r=this.getTerrainColour(e,s),n=this.terrainColours[r],o=n,a=n,h=0;1!==i&&2!==i||(n=ie.colourTransparent,o=ie.colourTransparent,a=ie.colourTransparent);let l=this.getOverlayID(e,s,i);if(l>0){let t=Et.overlays[l-1],r=this.getTileType(e,s,i);if(n=o=Et.tileDecoration[l-1],4===t&&(n=1,o=1,12===l&&(n=31,o=31)),5===t?this.getWallDiagonal(e,s)>0&&this.getWallDiagonal(e,s)<24e3&&(this.getOverlayID(e-1,s,i,a)!==ie.colourTransparent&&this.getOverlayID(e,s-1,i,a)!==ie.colourTransparent?(n=this.getOverlayID(e-1,s,i,a),h=0):this.getOverlayID(e+1,s,i,a)!==ie.colourTransparent&&this.getOverlayID(e,s+1,i,a)!==ie.colourTransparent?(o=this.getOverlayID(e+1,s,i,a),h=0):this.getOverlayID(e+1,s,i,a)!==ie.colourTransparent&&this.getOverlayID(e,s-1,i,a)!==ie.colourTransparent?(o=this.getOverlayID(e+1,s,i,a),h=1):this.getOverlayID(e-1,s,i,a)!==ie.colourTransparent&&this.getOverlayID(e,s+1,i,a)!==ie.colourTransparent&&(n=this.getOverlayID(e-1,s,i,a),h=1)):(2!==t||this.getWallDiagonal(e,s)>0&&this.getWallDiagonal(e,s)<24e3)&&(this.getTileType(e-1,s,i)!==r&&this.getTileType(e,s-1,i)!==r?(n=a,h=0):this.getTileType(e+1,s,i)!==r&&this.getTileType(e,s+1,i)!==r?(o=a,h=0):this.getTileType(e+1,s,i)!==r&&this.getTileType(e,s-1,i)!==r?(o=a,h=1):this.getTileType(e-1,s,i)!==r&&this.getTileType(e,s+1,i)!==r&&(n=a,h=1)),0!==Et.tileAdjacent[l-1]){const t=this.objectAdjacency.get(e,s);this.objectAdjacency.set(e,s,64|t)}if(2===Et.overlays[l-1]){const t=this.objectAdjacency.get(e,s);this.objectAdjacency.set(e,s,128|t)}}this.method402(e,s,h,n,o);let u=this.getTerrainHeight(e+1,s+1)-this.getTerrainHeight(e+1,s)+this.getTerrainHeight(e,s+1)-this.getTerrainHeight(e,s);if(n!==o||0!==u){let i=new Int32Array(3),r=new Int32Array(3);if(0===h){if(n!==ie.colourTransparent){i[0]=s+96*e+96,i[1]=s+96*e,i[2]=s+96*e+1;let r=t.createFace(3,i,ie.colourTransparent,n);this.localX[r]=e,this.localY[r]=s,t.faceTag[r]=2e5+r}if(o!==ie.colourTransparent){r[0]=s+96*e+1,r[1]=s+96*e+96+1,r[2]=s+96*e+96;let i=t.createFace(3,r,ie.colourTransparent,o);this.localX[i]=e,this.localY[i]=s,t.faceTag[i]=2e5+i}}else{if(n!==ie.colourTransparent){i[0]=s+96*e+1,i[1]=s+96*e+96+1,i[2]=s+96*e;let r=t.createFace(3,i,ie.colourTransparent,n);this.localX[r]=e,this.localY[r]=s,t.faceTag[r]=2e5+r}if(o!==ie.colourTransparent){r[0]=s+96*e+96,r[1]=s+96*e,r[2]=s+96*e+96+1;let i=t.createFace(3,r,ie.colourTransparent,o);this.localX[i]=e,this.localY[i]=s,t.faceTag[i]=2e5+i}}}else if(n!==ie.colourTransparent){let i=new Int32Array(4);i[0]=s+96*e+96,i[1]=s+96*e,i[2]=s+96*e+1,i[3]=s+96*e+96+1;let r=t.createFace(4,i,ie.colourTransparent,n);this.localX[r]=e,this.localY[r]=s,t.faceTag[r]=2e5+r}}for(let e=1;e<95;e++)for(let s=1;s<95;s++)if(this.getOverlayID(e,s,i)>0&&4===Et.overlays[this.getOverlayID(e,s,i)-1]){let r=Et.tileDecoration[this.getOverlayID(e,s,i)-1],n=t.vertexAt(e*this.tileSize,-this.getTerrainHeight(e,s),s*this.tileSize),o=t.vertexAt((e+1)*this.tileSize,-this.getTerrainHeight(e+1,s),s*this.tileSize),a=t.vertexAt((e+1)*this.tileSize,-this.getTerrainHeight(e+1,s+1),(s+1)*this.tileSize),h=t.vertexAt(e*this.tileSize,-this.getTerrainHeight(e,s+1),(s+1)*this.tileSize),l=new Int32Array([n,o,a,h]),u=t.createFace(4,l,r,ie.colourTransparent);this.localX[u]=e,this.localY[u]=s,t.faceTag[u]=2e5+u,this.method402(e,s,0,r,r)}else if(0===this.getOverlayID(e,s,i)||3!==Et.overlays[this.getOverlayID(e,s,i)-1]){if(this.getOverlayID(e,s+1,i)>0&&4===Et.overlays[this.getOverlayID(e,s+1,i)-1]){let r=Et.tileDecoration[this.getOverlayID(e,s+1,i)-1],n=t.vertexAt(e*this.tileSize,-this.getTerrainHeight(e,s),s*this.tileSize),o=t.vertexAt((e+1)*this.tileSize,-this.getTerrainHeight(e+1,s),s*this.tileSize),a=t.vertexAt((e+1)*this.tileSize,-this.getTerrainHeight(e+1,s+1),(s+1)*this.tileSize),h=t.vertexAt(e*this.tileSize,-this.getTerrainHeight(e,s+1),(s+1)*this.tileSize),l=new Int32Array([n,o,a,h]),u=t.createFace(4,l,r,ie.colourTransparent);this.localX[u]=e,this.localY[u]=s,t.faceTag[u]=2e5+u,this.method402(e,s,0,r,r)}if(this.getOverlayID(e,s-1,i)>0&&4===Et.overlays[this.getOverlayID(e,s-1,i)-1]){let r=Et.tileDecoration[this.getOverlayID(e,s-1,i)-1],n=t.vertexAt(e*this.tileSize,-this.getTerrainHeight(e,s),s*this.tileSize),o=t.vertexAt((e+1)*this.tileSize,-this.getTerrainHeight(e+1,s),s*this.tileSize),a=t.vertexAt((e+1)*this.tileSize,-this.getTerrainHeight(e+1,s+1),(s+1)*this.tileSize),h=t.vertexAt(e*this.tileSize,-this.getTerrainHeight(e,s+1),(s+1)*this.tileSize),l=new Int32Array([n,o,a,h]),u=t.createFace(4,l,r,ie.colourTransparent);this.localX[u]=e,this.localY[u]=s,t.faceTag[u]=2e5+u,this.method402(e,s,0,r,r)}if(this.getOverlayID(e+1,s,i)>0&&4===Et.overlays[this.getOverlayID(e+1,s,i)-1]){let r=Et.tileDecoration[this.getOverlayID(e+1,s,i)-1],n=t.vertexAt(e*this.tileSize,-this.getTerrainHeight(e,s),s*this.tileSize),o=t.vertexAt((e+1)*this.tileSize,-this.getTerrainHeight(e+1,s),s*this.tileSize),a=t.vertexAt((e+1)*this.tileSize,-this.getTerrainHeight(e+1,s+1),(s+1)*this.tileSize),h=t.vertexAt(e*this.tileSize,-this.getTerrainHeight(e,s+1),(s+1)*this.tileSize),l=new Int32Array([n,o,a,h]),u=t.createFace(4,l,r,ie.colourTransparent);this.localX[u]=e,this.localY[u]=s,t.faceTag[u]=2e5+u,this.method402(e,s,0,r,r)}if(this.getOverlayID(e-1,s,i)>0&&4===Et.overlays[this.getOverlayID(e-1,s,i)-1]){let r=Et.tileDecoration[this.getOverlayID(e-1,s,i)-1],n=t.vertexAt(e*this.tileSize,-this.getTerrainHeight(e,s),s*this.tileSize),o=t.vertexAt((e+1)*this.tileSize,-this.getTerrainHeight(e+1,s),s*this.tileSize),a=t.vertexAt((e+1)*this.tileSize,-this.getTerrainHeight(e+1,s+1),(s+1)*this.tileSize),h=t.vertexAt(e*this.tileSize,-this.getTerrainHeight(e,s+1),(s+1)*this.tileSize),l=new Int32Array([n,o,a,h]),u=t.createFace(4,l,r,ie.colourTransparent);this.localX[u]=e,this.localY[u]=s,t.faceTag[u]=2e5+u,this.method402(e,s,0,r,r)}}t.createGouraudLightSource(!0,40,48,-50,-10,-50),this.terrainModels=this.parentModel.split(0,0,1536,1536,8,64,233,!1);for(let t=0;t<64;t++)this.scene.addModel(this.terrainModels[t]);for(let t=0;t<this.regionWidth;t++)for(let e=0;e<this.regionHeight;e++)this.terrainHeightLocal.set(t,e,this.getTerrainHeight(t,e))}this.parentModel.clear();let o=6316128;for(let t=0;t<95;t++)for(let e=0;e<95;e++){let i=this.getWallEastWest(t,e);if(i>0&&(0===Et.wallObjectInvisible[i-1]||this.aBoolean592)){if(this.method422(this.parentModel,i-1,t,e,t+1,e),s&&0!==Et.wallObjectAdjacent[i-1]){const i=this.objectAdjacency.get(t,e);this.objectAdjacency.set(t,e,1|i),e>0&&this._setObjectAdjacency_from3(t,e-1,4)}s&&this.surface.drawLineHoriz(3*t,3*e,3,o)}if(i=this.getWallNorthSouth(t,e),i>0&&(0===Et.wallObjectInvisible[i-1]||this.aBoolean592)){if(this.method422(this.parentModel,i-1,t,e,t,e+1),s&&0!==Et.wallObjectAdjacent[i-1]){const i=this.objectAdjacency.get(t,e);this.objectAdjacency.set(t,e,2|i),t>0&&this._setObjectAdjacency_from3(t-1,e,8)}s&&this.surface.drawLineVert(3*t,3*e,3,o)}if(i=this.getWallDiagonal(t,e),i>0&&i<12e3&&(0===Et.wallObjectInvisible[i-1]||this.aBoolean592)){if(this.method422(this.parentModel,i-1,t,e,t+1,e+1),s&&0!==Et.wallObjectAdjacent[i-1]){const i=this.objectAdjacency.get(t,e);this.objectAdjacency.set(t,e,32|i)}s&&(this.surface.setPixel(3*t,3*e,o),this.surface.setPixel(3*t+1,3*e+1,o),this.surface.setPixel(3*t+2,3*e+2,o))}if(i>12e3&&i<24e3&&(0===Et.wallObjectInvisible[i-12001]||this.aBoolean592)){if(this.method422(this.parentModel,i-12001,t+1,e,t,e+1),s&&0!==Et.wallObjectAdjacent[i-12001]){const i=this.objectAdjacency.get(t,e);this.objectAdjacency.set(t,e,16|i)}s&&(this.surface.setPixel(3*t+2,3*e,o),this.surface.setPixel(3*t+1,3*e+1,o),this.surface.setPixel(3*t,3*e+2,o))}}s&&this.surface.drawSpriteMinimap(this.baseMediaSprite-1,0,0,285,285),this.parentModel.createGouraudLightSource(!1,60,24,-50,-10,-50),this.wallModels[i]=this.parentModel.split(0,0,1536,1536,8,64,338,!0);for(let t=0;t<64;t++)this.scene.addModel(this.wallModels[i][t]);for(let t=0;t<95;t++)for(let e=0;e<95;e++){let i=this.getWallEastWest(t,e);i>0&&this.method428(i-1,t,e,t+1,e),i=this.getWallNorthSouth(t,e),i>0&&this.method428(i-1,t,e,t,e+1),i=this.getWallDiagonal(t,e),i>0&&i<12e3&&this.method428(i-1,t,e,t+1,e+1),i>12e3&&i<24e3&&this.method428(i-12001,t+1,e,t,e+1)}for(let t=1;t<95;t++)for(let e=1;e<95;e++){if(this.getWallRoof(t,e)>0){let i=t,s=e,r=t+1,n=e,o=t+1,a=e+1,h=t,l=e+1,u=0,c=this.terrainHeightLocal.get(i,s),d=this.terrainHeightLocal.get(r,n),m=this.terrainHeightLocal.get(o,a),p=this.terrainHeightLocal.get(h,l);if(c>8e4&&(c-=8e4),d>8e4&&(d-=8e4),m>8e4&&(m-=8e4),p>8e4&&(p-=8e4),c>u&&(u=c),d>u&&(u=d),m>u&&(u=m),p>u&&(u=p),u>=8e4&&(u-=8e4),c<8e4)this.terrainHeightLocal.set(i,s,u);else{const t=this.terrainHeightLocal.get(i,s);this.terrainHeightLocal.set(i,s,t-8e4)}if(d<8e4)this.terrainHeightLocal.set(r,n,u);else{const t=this.terrainHeightLocal.get(r,n);this.terrainHeightLocal.set(r,n,t-8e4)}if(m<8e4)this.terrainHeightLocal.set(o,a,u);else{const t=this.terrainHeightLocal.get(o,a);this.terrainHeightLocal.set(o,a,t-8e4)}if(p<8e4)this.terrainHeightLocal.set(h,l,u);else{const t=this.terrainHeightLocal.get(h,l);this.terrainHeightLocal.set(h,l,t-8e4)}}}this.parentModel.clear();for(let t=1;t<95;t++)for(let e=1;e<95;e++){let i=this.getWallRoof(t,e);if(i>0){let s=t,r=e,n=t+1,o=e,a=t+1,h=e+1,l=t,u=e+1,c=t*this.tileSize,d=e*this.tileSize,m=c+this.tileSize,p=d+this.tileSize,f=c,g=d,S=m,w=p,y=this.terrainHeightLocal.get(s,r),I=this.terrainHeightLocal.get(n,o),C=this.terrainHeightLocal.get(a,h),b=this.terrainHeightLocal.get(l,u),T=Et.roofHeight[i-1];this.hasRoof(s,r)&&y<8e4&&(y+=T+8e4,this.terrainHeightLocal.set(s,r,y)),this.hasRoof(n,o)&&I<8e4&&(I+=T+8e4,this.terrainHeightLocal.set(n,o,I)),this.hasRoof(a,h)&&C<8e4&&(C+=T+8e4,this.terrainHeightLocal.set(a,h,C)),this.hasRoof(l,u)&&b<8e4&&(b+=T+8e4,this.terrainHeightLocal.set(l,u,b)),y>=8e4&&(y-=8e4),I>=8e4&&(I-=8e4),C>=8e4&&(C-=8e4),b>=8e4&&(b-=8e4);let x=16;if(this.roofsLeadTo(s-1,r)||(c-=x),this.roofsLeadTo(s+1,r)||(c+=x),this.roofsLeadTo(s,r-1)||(d-=x),this.roofsLeadTo(s,r+1)||(d+=x),this.roofsLeadTo(n-1,o)||(m-=x),this.roofsLeadTo(n+1,o)||(m+=x),this.roofsLeadTo(n,o-1)||(g-=x),this.roofsLeadTo(n,o+1)||(g+=x),this.roofsLeadTo(a-1,h)||(S-=x),this.roofsLeadTo(a+1,h)||(S+=x),this.roofsLeadTo(a,h-1)||(p-=x),this.roofsLeadTo(a,h+1)||(p+=x),this.roofsLeadTo(l-1,u)||(f-=x),this.roofsLeadTo(l+1,u)||(f+=x),this.roofsLeadTo(l,u-1)||(w-=x),this.roofsLeadTo(l,u+1)||(w+=x),i=Et.roofNumVertices[i-1],y=-y,I=-I,C=-C,b=-b,this.getWallDiagonal(t,e)>12e3&&this.getWallDiagonal(t,e)<24e3&&0===this.getWallRoof(t-1,e-1)){let t=new Int32Array(3);t[0]=this.parentModel.vertexAt(S,C,p),t[1]=this.parentModel.vertexAt(f,b,w),t[2]=this.parentModel.vertexAt(m,I,g),this.parentModel.createFace(3,t,i,ie.colourTransparent)}else if(this.getWallDiagonal(t,e)>12e3&&this.getWallDiagonal(t,e)<24e3&&0===this.getWallRoof(t+1,e+1)){let t=new Int32Array(3);t[0]=this.parentModel.vertexAt(c,y,d),t[1]=this.parentModel.vertexAt(m,I,g),t[2]=this.parentModel.vertexAt(f,b,w),this.parentModel.createFace(3,t,i,ie.colourTransparent)}else if(this.getWallDiagonal(t,e)>0&&this.getWallDiagonal(t,e)<12e3&&0===this.getWallRoof(t+1,e-1)){let t=new Int32Array(3);t[0]=this.parentModel.vertexAt(f,b,w),t[1]=this.parentModel.vertexAt(c,y,d),t[2]=this.parentModel.vertexAt(S,C,p),this.parentModel.createFace(3,t,i,ie.colourTransparent)}else if(this.getWallDiagonal(t,e)>0&&this.getWallDiagonal(t,e)<12e3&&0===this.getWallRoof(t-1,e+1)){let t=new Int32Array(3);t[0]=this.parentModel.vertexAt(m,I,g),t[1]=this.parentModel.vertexAt(S,C,p),t[2]=this.parentModel.vertexAt(c,y,d),this.parentModel.createFace(3,t,i,ie.colourTransparent)}else if(y===I&&C===b){let t=new Int32Array(4);t[0]=this.parentModel.vertexAt(c,y,d),t[1]=this.parentModel.vertexAt(m,I,g),t[2]=this.parentModel.vertexAt(S,C,p),t[3]=this.parentModel.vertexAt(f,b,w),this.parentModel.createFace(4,t,i,ie.colourTransparent)}else if(y===b&&I===C){let t=new Int32Array(4);t[0]=this.parentModel.vertexAt(f,b,w),t[1]=this.parentModel.vertexAt(c,y,d),t[2]=this.parentModel.vertexAt(m,I,g),t[3]=this.parentModel.vertexAt(S,C,p),this.parentModel.createFace(4,t,i,ie.colourTransparent)}else{let s=!0;if(this.getWallRoof(t-1,e-1)>0&&(s=!1),this.getWallRoof(t+1,e+1)>0&&(s=!1),s){let t=new Int32Array(3);t[0]=this.parentModel.vertexAt(c,y,d),t[1]=this.parentModel.vertexAt(m,I,g),t[2]=this.parentModel.vertexAt(f,b,w),this.parentModel.createFace(3,t,i,ie.colourTransparent);let e=new Int32Array(3);e[0]=this.parentModel.vertexAt(S,C,p),e[1]=this.parentModel.vertexAt(f,b,w),e[2]=this.parentModel.vertexAt(m,I,g),this.parentModel.createFace(3,e,i,ie.colourTransparent)}else{let t=new Int32Array(3);t[0]=this.parentModel.vertexAt(m,I,g),t[1]=this.parentModel.vertexAt(S,C,p),t[2]=this.parentModel.vertexAt(c,y,d),this.parentModel.createFace(3,t,i,ie.colourTransparent);let e=new Int32Array(3);e[0]=this.parentModel.vertexAt(f,b,w),e[1]=this.parentModel.vertexAt(c,y,d),e[2]=this.parentModel.vertexAt(S,C,p),this.parentModel.createFace(3,e,i,ie.colourTransparent)}}}}this.parentModel.createGouraudLightSource(!0,50,50,-50,-10,-50),this.roofModels[i]=this.parentModel.split(0,0,1536,1536,8,64,169,!0);for(let t=0;t<64;t++)this.scene.addModel(this.roofModels[i][t]);if(null===this.roofModels[i][0])throw new EvalError("null roof!");for(let t=0;t<this.regionWidth;t++)for(let e=0;e<this.regionHeight;e++)if(this.terrainHeightLocal.get(t,e)>=8e4){const i=this.terrainHeightLocal.get(t,e);this.terrainHeightLocal.set(t,e,i-8e4)}}_setObjectAdjacency_from3(t,e,i){const s=this.objectAdjacency.get(t,e);this.objectAdjacency.set(t,e,s|i)}getTileType(t,e,i){let s=this.getOverlayID(t,e,i);return 0===s?-1:2!==Et.overlays[s-1]?0:1}addModels(t){for(let e=0;e<94;e++)for(let i=0;i<94;i++){let s=this.getWallDiagonal(e,i);if(s>48e3&&s<6e4){let r=s-48e3-1,n=Et.objectWidth[r],o=Et.objectHeight[r],a=this.getTileDirection(e,i);0!==a&&4!==a||(n=Et.objectWidth[r],o=Et.objectHeight[r]),this.removeObject2(e,i,r);let h=t[Et.objectModelIndex[r]].copy(!1,!0,!1,!1),l=(e+e+n)*this.tileSize/2|0,u=(i+i+o)*this.tileSize/2|0;if(h.translate(l,-this.getElevation(l,u),u),h.orient(0,32*this.getTileDirection(e,i),0),this.scene.addModel(h),h.offsetLightSourceCoords(48,48,-50,-10,-50),n>1||o>1)for(let t=e;t<e+n;t++)for(let s=i;s<i+o;s++)if((t>e||s>i)&&this.getWallDiagonal(t,s)-48001===r){let e=t,i=s,r=0;e>=48&&i<48?(r=1,e-=48):e<48&&i>=48?(r=2,i-=48):e>=48&&i>=48&&(r=3,e-=48,i-=48),this.wallsDiagonal.set(r,48*e+i,0)}}}}method422(t,e,i,s,r,n){this.method425(i,s,40),this.method425(r,n,40);let o=Et.wallObjectHeight[e],a=Et.wallObjectTextureFront[e],h=Et.wallObjectTextureBack[e],l=i*this.tileSize,u=s*this.tileSize,c=r*this.tileSize,d=n*this.tileSize,m=t.vertexAt(l,-this.terrainHeightLocal.get(i,s),u),p=t.vertexAt(l,-this.terrainHeightLocal.get(i,s)-o,u),f=t.vertexAt(c,-this.terrainHeightLocal.get(r,n)-o,d),g=t.vertexAt(c,-this.terrainHeightLocal.get(r,n),d),S=new Int32Array([m,p,f,g]),w=t.createFace(4,S,a,h);5!==Et.wallObjectInvisible[e]?t.faceTag[w]=0:t.faceTag[w]=3e4+e}getTerrainHeight(t,e){if(t<0||t>=this.regionWidth||e<0||e>=this.regionHeight)return 0;let i=0;return t>=48&&e<48?(i=1,t-=48):t<48&&e>=48?(i=2,e-=48):t>=48&&e>=48&&(i=3,t-=48,e-=48),3*(255&this.terrainHeight.get(i,48*t+e))}_loadSection_from3(t,e,i){this.reset();let s=(t+24)/48|0,r=(e+24)/48|0;this.loadRegionThenMakeModel(t,e,i,!0),0===i&&(this.loadRegionThenMakeModel(t,e,1,!1),this.loadRegionThenMakeModel(t,e,2,!1),this.decodeSector(s-1,r-1,i,0),this.decodeSector(s,r-1,i,1),this.decodeSector(s-1,r,i,2),this.decodeSector(s,r,i,3),this.fillEmptySectorsAndBorder())}method425(t,e,i){let s=t/12|0,r=e/12|0,n=(t-1)/12|0,o=(e-1)/12|0;this.setTerrainAmbience(s,r,t,e,i),s!==n&&this.setTerrainAmbience(n,r,t,e,i),r!==o&&this.setTerrainAmbience(s,o,t,e,i),s!==n&&r!==o&&this.setTerrainAmbience(n,o,t,e,i)}removeObject(t,e,i){if(!(t<0||e<0||t>=95||e>=95||1!==Et.objectType[i]&&2!==Et.objectType[i])){let s=this.getTileDirection(t,e),r=Et.objectHeight[i],n=Et.objectWidth[i];0!==s&&4!==s||(r=Et.objectWidth[i],n=Et.objectHeight[i]);for(let o=t;o<t+r;o++)for(let t=e;t<e+n;t++){const e=this.objectAdjacency.get(o,t);1===Et.objectType[i]?this.objectAdjacency.set(o,t,65471&e):0===s?(this.objectAdjacency.set(o,t,65533&e),o>0&&this.method407(o-1,t,8)):2===s?(this.objectAdjacency.set(o,t,65531&e),t<95&&this.method407(o,t+1,1)):4===s?(this.objectAdjacency.set(o,t,65527&e),o<95&&this.method407(o+1,t,2)):6===s&&(this.objectAdjacency.set(o,t,65534&e),t>0&&this.method407(o,t-1,4))}this.method404(t,e,r,n)}}roofsLeadTo(t,e){return this.getWallRoof(t,e)>0||this.getWallRoof(t-1,e)>0||this.getWallRoof(t-1,e-1)>0||this.getWallRoof(t,e-1)>0}method428(t,e,i,s,r){let n=Et.wallObjectHeight[t];const o=this.terrainHeightLocal.get(e,i);o<8e4&&this.terrainHeightLocal.set(e,i,o+8e4+n);const a=this.terrainHeightLocal.get(s,r);a<8e4&&this.terrainHeightLocal.set(s,r,a+8e4+n)}}ie.colourTransparent=12345678;function se(t){const e=t+"=",i=decodeURIComponent(document.cookie).split(";");for(let t=0;t<i.length;t++){let s=i[t];for(;" "===s.charAt(0);)s=s.substring(1);if(0===s.indexOf(e))return s.substring(e.length,s.length)}return""}function re(t,e){document.cookie=`${t}=${e}; Max-Age=2600000; SameSite=Lax; Secure;`}function ne(t){return 50*t}function oe(t){let e=i.toString();for(let t=e.length-3;t>0;t-=3)e=e.substring(0,t)+","+e.substring(t);return e.length>8?e="@gre@"+e.substring(0,e.length-8)+" million @whi@("+e+")":e.length>4&&(e="@cya@"+e.substring(0,e.length-4)+"K @whi@("+e+")"),e}function ae(t,e){for(let i in t)if(t[i]===e)return(t=t.slice(0,i).concat(t.slice(i+1))).slice(0,i).concat(t.slice(i+1))}class he extends Lt{constructor(t){super(t),this.welcomed=!1,this.prayers=[!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1],this.lastLog=[],this.lastLogIdx=-1,this.tickables=[],this.tickablesCaret=0,this.pathStepsMax=8e3,this.entitysMax=500,this.playersMax=500,this.npcsMax=500,this.wallObjectsMax=500,this.playersServerMax=4e3,this.groundItemsMax=5e3,this.npcsServerMax=5e3,this.objectsMax=1500,this.playerStatCount=18,this.playerStatEquipmentCount=5,this.questCount=50,this.savePass="true"===se("savePass"),this.localRegionX=0,this.localRegionY=0,this.controlTextListChat=0,this.controlTextListAll=0,this.controlTextListQuest=0,this.controlTextListPrivate=0,this.messageTabSelected=0,this.mouseClickXX=0,this.mouseClickXY=0,this.controlListSocialPlayers=0,this.uiTabSocialSubTab=0,this.privateMessageTarget=0,this.controlListQuest=0,this.uiTabPlayerInfoSubTab=0,this.controlListMagic=0,this.tabMagicPrayer=0,this.packetErrorCount=0,this.mouseButtonDownTime=0,this.mouseItemTickDelta=0,this.anInt659=0,this.anInt660=0,this.cameraRotationX=0,this.scene=void 0,this.reportAbuseState=0,this.tradeConfirmAccepted=!1,this.audioPlayer=void 0,this.appearanceHeadType=0,this.appearanceSkinColour=0,this.contactsInputCtx=0,this.dialogItemInput=0,this.anInt707=0,this.deathScreenTimeout=0,this.cameraRotationY=0,this.combatStyle=0,this.unreadMessageCount=0,this.controlButtonAppearanceHead1=0,this.controlButtonAppearanceHead2=0,this.controlButtonAppearanceHair1=0,this.controlButtonAppearanceHair2=0,this.controlButtonAppearanceGender1=0,this.controlButtonAppearanceGender2=0,this.controlButtonAppearanceTop1=0,this.controlButtonAppearanceTop2=0,this.controlButtonAppearanceSkin1=0,this.controlButtonAppearanceSkin2=0,this.controlButtonAppearanceBottom1=0,this.controlButtonAppearanceBottom2=0,this.controlButtonAppearanceAccept=0,this.logoutBoxFrames=0,this.tradeRecipientConfirmHash=0,this.frameCounter=0,this.npcCombatModelArray2=Int32Array.from([0,0,0,0,0,1,2,1]),this.systemUpdate=0,this.regionX=0,this.regionY=0,this.mouseButtonClick=0,this.questName=["Black knight's fortress","Cook's assistant","Demon slayer","Doric's quest","The restless ghost","Goblin diplomacy","Ernest the chicken","Imp catcher","Pirate's treasure","Prince Ali rescue","Romeo & Juliet","Sheep shearer","Shield of Arrav","The knight's sword","Vampire slayer","Witch's potion","Dragon slayer","Witch's house (members)","Lost city (members)","Hero's quest (members)","Druidic ritual (members)","Merlin's crystal (members)","Scorpion catcher (members)","Family crest (members)","Tribal totem (members)","Fishing contest (members)","Monk's friend (members)","Temple of Ikov (members)","Clock tower (members)","The Holy Grail (members)","Fight Arena (members)","Tree Gnome Village (members)","The Hazeel Cult (members)","Sheep Herder (members)","Plague City (members)","Sea Slug (members)","Waterfall quest (members)","Biohazard (members)","Jungle potion (members)","Grand tree (members)","Shilo village (members)","Underground pass (members)","Observatory quest (members)","Tourist trap (members)","Watchtower (members)","Dwarf Cannon (members)","Murder Mystery (members)","Digsite (members)","Gertrude's Cat (members)","Legend's Quest (members)"],this.healthBarCount=0,this.spriteMedia=0,this.spriteUtil=0,this.spriteItem=0,this.spriteProjectile=0,this.spriteTexture=0,this.spriteTextureWorld=0,this.spriteLogo=0,this.controlLoginStatus=0,this.controlLoginUser=0,this.controlLoginPass=0,this.controlLoginOk=0,this.controlLoginCancel=0,this.teleportBubbleCount=0,this.mouseClickCount=0,this.shopSellPriceMod=0,this.shopBuyPriceMod=0,this.duelOptionRetreat=0,this.duelOptionMagic=0,this.duelOptionPrayer=0,this.duelOptionWeapons=0,this.groundItemCount=0,this.receivedMessagesCount=0,this.messageTabFlashAll=0,this.messageTabFlashHistory=0,this.messageTabFlashQuest=0,this.messageTabFlashPrivate=0,this.bankItemCount=0,this.objectAnimationNumberFireLightningSpell=0,this.objectAnimationNumberTorch=0,this.objectAnimationNumberClaw=0,this.npcCount=0,this.npcCacheCount=0,this.objectAnimationCount=0,this.tradeConfirmItemsCount=0,this.mouseClickXStep=0,this.newBankItemCount=0,this.npcAnimationArray=[Int32Array.from([11,2,9,7,1,6,10,0,5,8,3,4]),Int32Array.from([11,2,9,7,1,6,10,0,5,8,3,4]),Int32Array.from([11,3,2,9,7,1,6,10,0,5,8,4]),Int32Array.from([3,4,2,9,7,1,6,10,8,11,0,5]),Int32Array.from([3,4,2,9,7,1,6,10,8,11,0,5]),Int32Array.from([4,3,2,9,7,1,6,10,8,11,0,5]),Int32Array.from([11,4,2,9,7,1,6,10,0,5,8,3]),Int32Array.from([11,2,9,7,1,6,10,0,5,8,4,3])],this.controlWelcomeNewuser=0,this.controlWelcomeExistinguser=0,this.npcWalkModel=Int32Array.from([0,1,2,1]),this.referid=0,this.controlRegisterUser=0,this.controlRegisterPassword=0,this.controlRegisterConfirmPassword=0,this.controlRegisterSubmit=0,this.controlRegisterCancel=0,this.controlRegisterCheckbox=0,this.controlLoginSavePass=0,this.controlRegisterStatus=0,this.combatTimeout=0,this.optionMenuCount=0,this.reportAbuseOffence=0,this.cameraRotationTime=0,this.duelOpponentItemsCount=0,this.duelItemsCount=0,this.characterSkinColours=Int32Array.from([15523536,13415270,11766848,10056486,9461792]),this.duelOfferOpponentItemCount=0,this.characterTopBottomColours=Int32Array.from([16711680,16744448,16769024,10543104,57344,32768,41088,45311,33023,12528,14680288,3158064,6307840,8409088,16777215]),this.itemsAboveHeadCount=0,this.wildAwarenessLvl=0,this.selectedItemInventoryIndex=0,this.soundData=void 0,this.statFatigue=0,this.fatigueSleeping=0,this.tradeRecipientConfirmItemsCount=0,this.tradeRecipientItemsCount=0,this.showDialogServermessage=!1,this.menuX=0,this.menuY=0,this.menuWidth=0,this.menuHeight=0,this.menuItemsCount=0,this.menuMaxSize=256,this.menuItemID=new Uint32Array(this.menuMaxSize),this.menuItemText1=new Array(this.menuMaxSize),this.menuItemText2=new Array(this.menuMaxSize),this.menuIndices=new Uint32Array(this.menuMaxSize),this.menuItemX=new Uint32Array(this.menuMaxSize),this.menuItemY=new Uint32Array(this.menuMaxSize),this.menuSourceType=new Uint32Array(this.menuMaxSize),this.menuSourceIndex=new Uint32Array(this.menuMaxSize),this.menuTargetIndex=new Uint32Array(this.menuMaxSize),this.showUiTab=0,this.tradeItemsCount=0,this.planeWidth=0,this.planeHeight=0,this.planeMultiplier=0,this.playerQuestPoints=0,this.characterHairColours=Int32Array.from([16760880,16752704,8409136,6307872,3158064,16736288,16728064,16777215,65280,65535]),this.bankActivePage=0,this.daysSinceLogin=0,this.equipmentStatNames=["Armour","WeaponAim","WeaponPower","Magic","Prayer"],this.inventoryItemsCount=0,this.skillNameShort=["Attack","Defense","Strength","Hits","Ranged","Prayer","Magic","Cooking","Woodcut","Fletching","Fishing","Firemaking","Crafting","Smithing","Mining","Herblaw","Agility","Thieving"],this.duelOpponentNameHash=0,this.objectCount=0,this.skillNamesLong=["Attack","Defense","Strength","Hits","Ranged","Prayer","Magic","Cooking","Woodcutting","Fletching","Fishing","Firemaking","Crafting","Smithing","Mining","Herblaw","Agility","Thieving"],this.duelOfferItemCount=0,this.cameraAutoRotatePlayerX=0,this.cameraAutoRotatePlayerY=0,this.npcCombatModelArray1=Int32Array.from([0,1,2,1,0,0,0,0]),this.playerCount=0,this.knownPlayerCount=0,this.spriteCount=0,this.wallObjectCount=0,this.welcomeRecoverySetDays=0,this.localLowerX=0,this.localLowerY=0,this.localUpperX=0,this.localUpperY=0,this.world=void 0,this.lastRemoteIP=0,this.sleepWordDelayTimer=0,this.cameraAutoAngleDebug=!1,this.wallObjectDirection=new Int32Array(this.wallObjectsMax),this.wallObjectId=new Int32Array(this.wallObjectsMax),this.cameraRotationXIncrement=2,this.inventoryMaxItemCount=30,this.bankItemsMax=192,this.optionMenuEntry=new Array(5),this.newBankItems=new Int32Array(256),this.newBankItemsCount=new Int32Array(256),this.teleportBubbleTime=new Int32Array(50),this.tradeConfirmVisible=!1,this.tradeConfirmAccepted=!1,this.receivedMessageX=new Int32Array(50),this.receivedMessageY=new Int32Array(50),this.receivedMessageMidPoint=new Int32Array(50),this.receivedMessageHeight=new Int32Array(50),this.localPlayer=new ot,this.localPlayerServerIndex=-1,this.tradeConfigVisible=!1,this.bankItems=new Int32Array(256),this.bankItemsCount=new Int32Array(256),this.appearanceBodyGender=1,this.appearance2Colour=2,this.appearanceHairColour=2,this.appearanceTopColour=8,this.appearanceBottomColour=14,this.appearanceHeadGender=1,this.loginUser=se("username"),this.loginPass="",this.registerUser="",this.registerPassword="",this.cameraAngle=1,this.members=!1,this.optionSoundDisabled=!1,this.visibleContextMenu=!1,this.cameraRotationYIncrement=2,this.objectAlreadyInMenu=new Uint8Array(this.objectsMax),this.duelOpponentName="",this.lastObjectAnimationNumberFireLightningSpell=-1,this.lastObjectAnimationNumberTorch=-1,this.lastObjectAnimationNumberClaw=-1,this.planeIndex=-1,this.isSleeping=!1,this.cameraRotation=128,this.playerExperience=new Int32Array(this.playerStatCount),this.tradeRecipientAccepted=!1,this.tradeAccepted=!1,this.mouseClickXHistory=new Int32Array(8192),this.mouseClickYHistory=new Int32Array(8192),this.teleportBubbleX=new Int32Array(50),this.teleportBubbleY=new Int32Array(50),this.receivedMessages=new Array(50),this.duelConfirmVisible=!1,this.duelAccepted=!1,this.playerServerIndexes=new Int32Array(this.playersMax),this.players=new Array(this.playersMax),this.wallObjectAlreadyInMenu=new Int8Array(this.wallObjectsMax),this.tileSize=128,this.fogOfWar=!1,this.gameWidth=512,this.gameHeight=334,this.tradeConfirmItems=new Int32Array(14),this.tradeConfirmItemCount=new Int32Array(14),this.tradeRecipientName="",this.selectedSpell=-1,this.showOptionMenu=!1,this.playerStatCurrent=new Int32Array(this.playerStatCount),this.teleportBubbleType=new Int32Array(50),this.shopVisible=!1,this.shopItem=new Int32Array(256),this.shopItemCount=new Int32Array(256),this.shopItemPrice=new Int32Array(256),this.duelOfferOpponentAccepted=!1,this.duelOfferAccepted=!1,this.gameModels=new Array(1e3),this.duelConfigVisible=!1,this.serverMessage="",this.serverMessageBoxTop=!1,this.duelOpponentItemList=[],this.duelItemList=[],this.playerStatBase=new Int32Array(this.playerStatCount),this.npcsCache=new Array(this.npcsMax),this.groundItemX=new Int32Array(this.groundItemsMax),this.groundItemY=new Int32Array(this.groundItemsMax),this.groundItemId=new Int32Array(this.groundItemsMax),this.groundItemZ=new Int32Array(this.groundItemsMax),this.bankSelectedItemSlot=-1,this.bankSelectedItem=-2,this.duelOfferItemList=[],this.duelOfferOpponentItemList=[],this.duelOfferOpponentItemId=new Int32Array(8),this.duelOfferOpponentItemStack=new Int32Array(8),this.optionCameraModeAuto=!0,this.objectX=new Int32Array(this.objectsMax),this.objectY=new Int32Array(this.objectsMax),this.objectId=new Int32Array(this.objectsMax),this.objectDirection=new Int32Array(this.objectsMax),this.selectedItemInventoryIndex=-1,this.selectedItemName="",this.loadingArea=!1,this.tradeRecipientConfirmItems=new Int32Array(14),this.tradeRecipientConfirmItemCount=new Int32Array(14),this.tradeRecipientItems=new Int32Array(14),this.tradeRecipientItemCount=new Int32Array(14),this.showDialogServermessage=!1,this.questComplete=new Array(this.questCount),this.wallObjectModel=new Array(this.wallObjectsMax),this.actionBubbleX=new Int32Array(50),this.actionBubbleY=new Int32Array(50),this.cameraZoom=550,this.tradeItems=new Int32Array(14),this.tradeItemCount=new Int32Array(14),this.lastHeightOffset=-1,this.duelSettingsRetreat=!1,this.duelSettingsMagic=!1,this.duelSettingsPrayer=!1,this.duelSettingsWeapons=!1,this.bankVisible=!1,this.optionMouseButtonOne=!1,this.inventoryItemId=new Int32Array(35),this.inventoryItemStackCount=new Uint32Array(35),this.inventoryEquipped=new Array(35),this.knownPlayers=new Array(this.playersMax),this.messageHistory=[],this.reportAbuseMute=!1,this.actionBubbleScale=new Int32Array(50),this.actionBubbleItem=new Int32Array(50),this.sleepWordDelay=!0,this.showAppearanceChange=!1,this.shopSelectedItemIndex=-1,this.shopSelectedItemType=-2,this.projectileFactor=40,this.npcs=new Array(this.npcsMax),this.healthBarX=new Int32Array(50),this.healthBarY=new Int32Array(50),this.healthBarMissing=new Int32Array(50),this.playerServer=new Array(this.playersServerMax),this.walkPathX=new Int32Array(this.pathStepsMax),this.walkPathY=new Int32Array(this.pathStepsMax),this.wallObjectX=new Int32Array(this.wallObjectsMax),this.wallObjectY=new Int32Array(this.wallObjectsMax),this.npcsServer=new Array(this.npcsServerMax),this.playerStatEquipment=new Uint32Array(this.playerStatEquipmentCount),this.objectModel=new Array(this.objectsMax)}addTimer(t){this.tickables=this.tickables.concat(t)}removeTimer(){this.tickables=ae(this.tickables,timer)}playSoundFile(t){this.audioPlayer&&(this.optionSoundDisabled||this.audioPlayer.writeStream(this.soundData,S.getDataFileOffset(t+".pcm",this.soundData),S.getDataFileLength(t+".pcm",this.soundData)))}renderReportAbuse(){this.reportAbuseOffence=0;let t=135;for(let e=0;e<12;e++)this.mouseX>66&&this.mouseX<446&&this.mouseY>=t-12&&this.mouseY<t+3&&(this.reportAbuseOffence=e+1),t+=14;if(0!==this.mouseButtonClick&&0!==this.reportAbuseOffence)return this.mouseButtonClick=0,this.reportAbuseState=2,this.inputTextCurrent="",void(this.inputTextFinal="");if(t+=15,0!==this.mouseButtonClick){if(this.mouseButtonClick=0,this.mouseX<56||this.mouseY<35||this.mouseX>456||this.mouseY>325)return void(this.reportAbuseState=0);if(this.mouseX>66&&this.mouseX<446&&this.mouseY>=t-15&&this.mouseY<t+5)return void(this.reportAbuseState=0)}this.surface.drawBox(56,35,400,290,0),this.surface.drawBoxEdge(56,35,400,290,16777215),t=50,this.surface.drawStringCenter("This form is for reporting players who are breaking our rules",256,t,1,16777215),t+=15,this.surface.drawStringCenter("Using it sends a snapshot of the last 60 secs of activity to us",256,t,1,16777215),t+=15,this.surface.drawStringCenter("If you misuse this form, you will be banned.",256,t,1,16744448),t+=15,t+=10,this.surface.drawStringCenter("First indicate which of our 12 rules is being broken. For a detailed",256,t,1,16776960),t+=15,this.surface.drawStringCenter("explanation of each rule please read the manual on our website.",256,t,1,16776960),t+=15;let e=0;1===this.reportAbuseOffence?(this.surface.drawBoxEdge(66,t-12,380,15,16777215),e=16744448):e=16777215,this.surface.drawStringCenter("1: Offensive language",256,t,1,e),t+=14,2===this.reportAbuseOffence?(this.surface.drawBoxEdge(66,t-12,380,15,16777215),e=16744448):e=16777215,this.surface.drawStringCenter("2: Item scamming",256,t,1,e),t+=14,3===this.reportAbuseOffence?(this.surface.drawBoxEdge(66,t-12,380,15,16777215),e=16744448):e=16777215,this.surface.drawStringCenter("3: Password scamming",256,t,1,e),t+=14,4===this.reportAbuseOffence?(this.surface.drawBoxEdge(66,t-12,380,15,16777215),e=16744448):e=16777215,this.surface.drawStringCenter("4: Bug abuse",256,t,1,e),t+=14,5===this.reportAbuseOffence?(this.surface.drawBoxEdge(66,t-12,380,15,16777215),e=16744448):e=16777215,this.surface.drawStringCenter("5: Jagex Staff impersonation",256,t,1,e),t+=14,6===this.reportAbuseOffence?(this.surface.drawBoxEdge(66,t-12,380,15,16777215),e=16744448):e=16777215,this.surface.drawStringCenter("6: Account sharing/trading",256,t,1,e),t+=14,7===this.reportAbuseOffence?(this.surface.drawBoxEdge(66,t-12,380,15,16777215),e=16744448):e=16777215,this.surface.drawStringCenter("7: Macroing",256,t,1,e),t+=14,8===this.reportAbuseOffence?(this.surface.drawBoxEdge(66,t-12,380,15,16777215),e=16744448):e=16777215,this.surface.drawStringCenter("8: Mutiple logging in",256,t,1,e),t+=14,9===this.reportAbuseOffence?(this.surface.drawBoxEdge(66,t-12,380,15,16777215),e=16744448):e=16777215,this.surface.drawStringCenter("9: Encouraging others to break rules",256,t,1,e),t+=14,10===this.reportAbuseOffence?(this.surface.drawBoxEdge(66,t-12,380,15,16777215),e=16744448):e=16777215,this.surface.drawStringCenter("10: Misuse of customer support",256,t,1,e),t+=14,11===this.reportAbuseOffence?(this.surface.drawBoxEdge(66,t-12,380,15,16777215),e=16744448):e=16777215,this.surface.drawStringCenter("11: Advertising / website",256,t,1,e),t+=14,12===this.reportAbuseOffence?(this.surface.drawBoxEdge(66,t-12,380,15,16777215),e=16744448):e=16777215,this.surface.drawStringCenter("12: Real world item trading",256,t,1,e),t+=14,t+=15,e=16777215,this.mouseX>196&&this.mouseX<316&&this.mouseY>t-15&&this.mouseY<t+5&&(e=16776960),this.surface.drawStringCenter("Click here to cancel",256,t,1,e)}_walkToActionSource_from8(t,e,i,s,r,n,o,a){let h=this.world.route(t,e,i,s,r,n,this.walkPathX,this.walkPathY,o);if(-1===h){if(!a)return!1;h=1,this.walkPathX[0]=i,this.walkPathY[0]=s}h--,t=this.walkPathX[h],e=this.walkPathY[h],h--,a?this.clientStream.newPacket(It.WALK_ACTION):this.clientStream.newPacket(It.WALK),this.clientStream.putShort(t+this.regionX),this.clientStream.putShort(e+this.regionY),a&&-1===h&&(t+this.regionX)%5==0&&(h=0);for(let i=h;i>=0&&i>h-25;i--)this.clientStream.putByte(this.walkPathX[i]-t),this.clientStream.putByte(this.walkPathY[i]-e);return this.clientStream.sendPacket(),this.mouseClickXStep=-24,this.mouseClickXX=this.mouseX,this.mouseClickXY=this.mouseY,!0}walkTo(t,e,i,s,r,n,o,a){let h=this.world.route(t,e,i,s,r,n,this.walkPathX,this.walkPathY,o);if(-1===h)return!1;h--,t=this.walkPathX[h],e=this.walkPathY[h],h--,a?this.clientStream.newPacket(It.WALK_ACTION):this.clientStream.newPacket(It.WALK),this.clientStream.putShort(t+this.regionX),this.clientStream.putShort(e+this.regionY),a&&-1===h&&(t+this.regionX)%5==0&&(h=0);for(let i=h;i>=0&&i>h-25;i--)this.clientStream.putByte(this.walkPathX[i]-t),this.clientStream.putByte(this.walkPathY[i]-e);return this.clientStream.sendPacket(),this.mouseClickXStep=-24,this.mouseClickXX=this.mouseX,this.mouseClickXY=this.mouseY,!0}drawMinimapEntity(t,e,i){this.surface.setPixel(t,e,i),this.surface.setPixel(t-1,e,i),this.surface.setPixel(t+1,e,i),this.surface.setPixel(t,e-1,i),this.surface.setPixel(t,e+1,i)}updateBankItems(){this.bankItemCount=this.newBankItemCount;for(let t=0;t<this.newBankItemCount;t++)this.bankItems[t]=this.newBankItems[t],this.bankItemsCount[t]=this.newBankItemsCount[t];for(let t=0;t<this.inventoryItemsCount&&!(this.bankItemCount>=this.bankItemsMax);t++){let e=this.inventoryItemId[t],i=!1;for(let t=0;t<this.bankItemCount;t++)if(this.bankItems[t]===e){i=!0;break}i||(this.bankItems[this.bankItemCount]=e,this.bankItemsCount[this.bankItemCount]=this.inventoryItemStackCount[t],this.bankItemCount++)}}renderWildernessWarning(){let t=97;this.surface.drawBox(86,77,340,180,0),this.surface.drawBoxEdge(86,77,340,180,16777215),this.surface.drawStringCenter("Warning! Proceed with caution",256,t,4,16711680),t+=26,this.surface.drawStringCenter("If you go much further north you will enter the",256,t,1,16777215),t+=13,this.surface.drawStringCenter("wilderness. This a very dangerous area where",256,t,1,16777215),t+=13,this.surface.drawStringCenter("other players can attack you!",256,t,1,16777215),t+=22,this.surface.drawStringCenter("The further north you go the more dangerous it",256,t,1,16777215),t+=13,this.surface.drawStringCenter("becomes, but the more treasure you will find.",256,t,1,16777215),t+=22,this.surface.drawStringCenter("In the wilderness an indicator at the bottom-right",256,t,1,16777215),t+=13,this.surface.drawStringCenter("of the screen will show the current level of danger",256,t,1,16777215),t+=22;let e=this.mouseY>t-12&&this.mouseY<=t&&this.mouseX>181&&this.mouseX<331?16711680:16777215;this.surface.drawStringCenter("Click here to close window",256,t,1,e),0!==this.mouseButtonClick&&(this.mouseY>t-12&&this.mouseY<=t&&this.mouseX>181&&this.mouseX<331&&(this.wildAwarenessLvl=2),(this.mouseX<86||this.mouseX>426||this.mouseY<77||this.mouseY>257)&&(this.wildAwarenessLvl=2),this.mouseButtonClick=0)}renderLocalMobEffects(){for(let t=0;t<this.receivedMessagesCount;t++){let e=this.surface.textHeight(1),i=this.receivedMessageX[t],s=this.receivedMessageY[t],r=this.receivedMessageMidPoint[t],n=this.receivedMessageHeight[t],o=!0;for(;o;){o=!1;for(let a=0;a<t;a++)s+n>this.receivedMessageY[a]-e&&s-e<this.receivedMessageY[a]+this.receivedMessageHeight[a]&&i-r<this.receivedMessageX[a]+this.receivedMessageMidPoint[a]&&i+r>this.receivedMessageX[a]-this.receivedMessageMidPoint[a]&&this.receivedMessageY[a]-e-n<s&&(s=this.receivedMessageY[a]-e-n,o=!0)}this.receivedMessageY[t]=s,this.surface.centrepara(this.receivedMessages[t],i,s,1,16776960,300)}for(let t=0;t<this.itemsAboveHeadCount;t++){let e=this.actionBubbleX[t],i=this.actionBubbleY[t],s=this.actionBubbleScale[t],r=this.actionBubbleItem[t],n=39*s/100|0,o=27*s/100|0;this.surface.drawActionBubble(e-(n/2|0),i-o,n,o,this.spriteMedia+9,85);let a=Math.floor(36*s/100),h=Math.floor(24*s/100);this.surface._spriteClipping_from9(e-Math.floor(a/2),i-o+Math.floor(o/2)-(h/2|0),a,h,Et.itemPicture[r]+this.spriteItem,Et.itemMask[r],0,0,!1)}for(let t=0;t<this.healthBarCount;t++){let e=this.healthBarX[t],i=this.healthBarY[t],s=this.healthBarMissing[t];this.surface.drawBoxAlpha(e-15,i-3,s,5,65280,192),this.surface.drawBoxAlpha(e-15+s,i-3,30-s,5,16711680,192)}}_walkToActionSource_from5(t,e,i,s,r){this._walkToActionSource_from8(t,e,i,s,i,s,!1,r)}createMessageTabPanel(){this.panelGame[M]=new qt(this.surface,10),this.controlTextListAll=this.panelGame[M].addTextListInput(7,324,498,14,1,80,!1,!0),this.controlTextListChat=this.panelGame[M].addTextList(5,269,502,56,1,20,!0),this.controlTextListQuest=this.panelGame[M].addTextList(5,269,502,56,1,20,!0),this.controlTextListPrivate=this.panelGame[M].addTextList(5,269,502,56,1,20,!0),this.panelGame[M].setFocus(this.controlTextListAll)}freeCacheMemory(){this.surface&&(this.surface.clear(),this.surface.pixels=void 0,this.surface=void 0),this.scene&&(this.scene.dispose(),this.scene=void 0),this.gameModels=void 0,this.objectModel=void 0,this.wallObjectModel=void 0,this.playerServer=void 0,this.players=void 0,this.npcsServer=void 0,this.npcs=void 0,this.localPlayer=new ot,this.world&&(this.world.terrainModels=void 0,this.world.wallModels=void 0,this.world.roofModels=void 0,this.world.parentModel=void 0,this.world=void 0)}drawUi(){if(0!==this.logoutBoxFrames)return this.renderLogoutNotification(),void(this.mouseButtonClick=0);if(this.welcomeBoxVisible)return this.renderWelcomeNotification(),void(this.mouseButtonClick=0);if(this.serverMessageVisible)return this.renderServerMessageBox(),void(this.mouseButtonClick=0);if(1===this.wildAwarenessLvl)return this.renderWildernessWarning(),void(this.mouseButtonClick=0);if(this.bankVisible&&0===this.combatTimeout)return this.renderBank(),void(this.mouseButtonClick=0);if(this.shopVisible&&0===this.combatTimeout)return this.renderShop(),void(this.mouseButtonClick=0);if(this.tradeConfirmVisible)return this.renderConfirmTrade(),void(this.mouseButtonClick=0);if(this.tradeConfigVisible)return this.renderTradeScreen(),void(this.mouseButtonClick=0);if(this.duelConfirmVisible)return this.renderConfirmDuel(),void(this.mouseButtonClick=0);if(this.duelConfigVisible)return this.renderDuelScreen(),void(this.mouseButtonClick=0);if(1===this.reportAbuseState)return this.renderReportAbuse(),void(this.mouseButtonClick=0);if(2===this.reportAbuseState)return this.renderReportAbuseInputs(),void(this.mouseButtonClick=0);if(0!==this.contactsInputCtx)return this.renderSocialInputBox(),void(this.mouseButtonClick=0);this.showOptionMenu&&this.renderOptionsMenu(),this.localPlayer.isFighting()&&this.renderFightModeSelect(),this.openHoveredTab();let t=!this.showOptionMenu&&!this.visibleContextMenu;t&&(this.menuItemsCount=0,0===this.showUiTab&&this.populateContextMenu()),1===this.showUiTab&&this.renderInventoryTab(t),2===this.showUiTab&&this.renderMinimapTab(t),3===this.showUiTab&&this.renderStatsTab(t),4===this.showUiTab&&this.renderMagicTab(t),5===this.showUiTab&&this.renderContactsTab(t),6===this.showUiTab&&this.renderConfigurationTab(t),this.showOptionMenu||(this.visibleContextMenu?this.handleContextClick():this.handleDefaultClick()),this.mouseButtonClick=0}renderTradeScreen(){if(0!==this.mouseButtonClick&&0===this.mouseItemTickDelta&&(this.mouseItemTickDelta=1),this.mouseItemTickDelta>0){let t=this.mouseX-22,e=this.mouseY-36;if(t>=0&&e>=0&&t<468&&e<262){if(t>216&&e>30&&t<462&&e<235){let i=Math.floor((t-217)/49)+5*Math.floor((e-31)/34);if(i>=0&&i<this.inventoryItemsCount){let t=!1,e=0,s=this.inventoryItemId[i];for(let r=0;r<this.tradeItemsCount;r++)if(this.tradeItems[r]===s)if(0===Et.itemStackable[s])for(let e=0;e<this.mouseItemTickDelta;e++)this.tradeItemCount[r]<this.inventoryItemStackCount[i]&&this.tradeItemCount[r]++,t=!0;else e++;if(this.getInventoryCount(s)<=e&&(t=!0),1===Et.itemSpecial[s]&&(this.showMessage("This object cannot be traded with other players",3),t=!0),!t&&this.tradeItemsCount<12&&(this.tradeItems[this.tradeItemsCount]=s,this.tradeItemCount[this.tradeItemsCount]=1,this.tradeItemsCount++,t=!0),t){this.clientStream.newPacket(It.TRADE_ITEM_UPDATE),this.clientStream.putByte(this.tradeItemsCount);for(let t=0;t<this.tradeItemsCount;t++)this.clientStream.putShort(this.tradeItems[t]),this.clientStream.putInt(this.tradeItemCount[t]);this.clientStream.sendPacket(),this.tradeRecipientAccepted=!1,this.tradeAccepted=!1}}}if(t>8&&e>30&&t<205&&e<133){let i=((t-9)/49|0)+4*((e-31)/34|0);if(i>=0&&i<this.tradeItemsCount){let t=this.tradeItems[i];for(let e=0;e<this.mouseItemTickDelta;e++){if(!(0===Et.itemStackable[t]&&this.tradeItemCount[i]>1)){this.tradeItemsCount--,this.mouseButtonDownTime=0;for(let t=i;t<this.tradeItemsCount;t++)this.tradeItems[t]=this.tradeItems[t+1],this.tradeItemCount[t]=this.tradeItemCount[t+1];break}this.tradeItemCount[i]--}this.clientStream.newPacket(It.TRADE_ITEM_UPDATE),this.clientStream.putByte(this.tradeItemsCount);for(let t=0;t<this.tradeItemsCount;t++)this.clientStream.putShort(this.tradeItems[t]),this.clientStream.putInt(this.tradeItemCount[t]);this.clientStream.sendPacket(),this.tradeRecipientAccepted=!1,this.tradeAccepted=!1}}t>=217&&e>=238&&t<=286&&e<=259&&(this.tradeAccepted=!0,this.clientStream.queue(vt.ACCEPT_TRADE_ONE)),t>=394&&e>=238&&t<463&&e<259&&(this.tradeConfigVisible=!1,this.clientStream.queue(vt.DECLINE_TRADE))}else 0!==this.mouseButtonClick&&(this.tradeConfigVisible=!1,this.clientStream.queue(vt.DECLINE_TRADE));this.mouseButtonClick=0,this.mouseItemTickDelta=0}if(!this.tradeConfigVisible)return;this.surface.drawBox(22,36,468,12,192),this.surface.drawBoxAlpha(22,48,468,18,10000536,160),this.surface.drawBoxAlpha(22,66,8,248,10000536,160),this.surface.drawBoxAlpha(227,66,11,248,10000536,160),this.surface.drawBoxAlpha(484,66,6,248,10000536,160),this.surface.drawBoxAlpha(30,169,197,22,10000536,160),this.surface.drawBoxAlpha(30,294,197,20,10000536,160),this.surface.drawBoxAlpha(238,271,246,43,10000536,160),this.surface.drawBoxAlpha(30,66,197,103,13684944,160),this.surface.drawBoxAlpha(30,191,197,103,13684944,160),this.surface.drawBoxAlpha(238,66,246,205,13684944,160);for(let t=0;t<4;t++)this.surface.drawLineHoriz(30,66+34*t,197,0);for(let t=0;t<4;t++)this.surface.drawLineHoriz(30,191+34*t,197,0);for(let t=0;t<7;t++)this.surface.drawLineHoriz(238,66+34*t,246,0);for(let t=0;t<6;t++)t<5&&this.surface.drawLineVert(30+49*t,66,103,0),t<5&&this.surface.drawLineVert(30+49*t,191,103,0),this.surface.drawLineVert(238+49*t,66,205,0);this.surface.drawString("Trading with: "+this.tradeRecipientName,23,46,1,16777215),this.surface.drawString("Your Offer",31,63,4,16777215),this.surface.drawString("Opponent's Offer",31,188,4,16777215),this.surface.drawString("Your Inventory",238,63,4,16777215),this.tradeAccepted||this.surface.drawSpriteID(239,274,this.spriteMedia+25),this.surface.drawSpriteID(416,274,this.spriteMedia+26),this.tradeRecipientAccepted&&(this.surface.drawStringCenter("Other player",363,282,1,16777215),this.surface.drawStringCenter("has accepted",363,292,1,16777215)),this.tradeAccepted&&(this.surface.drawStringCenter("Waiting for",274,282,1,16777215),this.surface.drawStringCenter("other player",274,292,1,16777215));for(let t=0;t<this.inventoryItemsCount;t++){let e=239+t%5*49,i=67+34*(t/5|0);this.surface._spriteClipping_from9(e,i,48,32,this.spriteItem+Et.itemPicture[this.inventoryItemId[t]],Et.itemMask[this.inventoryItemId[t]],0,0,!1),0===Et.itemStackable[this.inventoryItemId[t]]&&this.surface.drawString(this.inventoryItemStackCount[t].toString(),e+1,i+10,1,16776960)}for(let t=0;t<this.tradeItemsCount;t++){let e=31+t%4*49,i=67+34*(t/4|0);this.surface._spriteClipping_from9(e,i,48,32,this.spriteItem+Et.itemPicture[this.tradeItems[t]],Et.itemMask[this.tradeItems[t]],0,0,!1),0===Et.itemStackable[this.tradeItems[t]]&&this.surface.drawString(this.tradeItemCount[t].toString(),e+1,i+10,1,16776960),this.mouseX>e&&this.mouseX<e+48&&this.mouseY>i&&this.mouseY<i+32&&this.surface.drawString(Et.itemName[this.tradeItems[t]]+": @whi@"+Et.itemDescription[this.tradeItems[t]],30,309,1,16776960)}for(let t=0;t<this.tradeRecipientItemsCount;t++){let e=31+t%4*49,i=192+34*(t/4|0);this.surface._spriteClipping_from9(e,i,48,32,this.spriteItem+Et.itemPicture[this.tradeRecipientItems[t]],Et.itemMask[this.tradeRecipientItems[t]],0,0,!1),0===Et.itemStackable[this.tradeRecipientItems[t]]&&this.surface.drawString(this.tradeRecipientItemCount[t].toString(),e+1,i+10,1,16776960),this.mouseX>e&&this.mouseX<e+48&&this.mouseY>i&&this.mouseY<i+32&&this.surface.drawString(Et.itemName[this.tradeRecipientItems[t]]+": @whi@"+Et.itemDescription[this.tradeRecipientItems[t]],30,309,1,16776960)}}resetWorldState(){this.welcomeState=k.WELCOME,this.gameState=A.WORLD,this.systemUpdate=0,this.combatStyle=0,this.resetPMText(),this.surface.blackScreen(),this.surface.draw(this.graphics,0,0);for(let t=0;t<this.objectCount;t++)this.scene.removeModel(this.objectModel[t]),this.world.removeObject(this.objectX[t],this.objectY[t],this.objectId[t]);this.objectCount=0;for(let t=0;t<this.wallObjectCount;t++)this.scene.removeModel(this.wallObjectModel[t]),this.world.removeWallObject(this.wallObjectX[t],this.wallObjectY[t],this.wallObjectDirection[t],this.wallObjectId[t]);this.wallObjectCount=0,this.groundItemCount=0,this.playerCount=0,this.players=new Array(this.playersMax),this.playerServer=new Array(this.playersMax),this.npcCount=0,this.npcs=new Array(this.npcsMax),this.npcsServer=new Array(this.npcsMax),this.prayers=[!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1],this.mouseButtonClick=0,this.lastMouseButtonDown=0,this.mouseButtonDown=0,this.shopVisible=!1,this.bankVisible=!1,this.isSleeping=!1,this.friendListOnline=new Array(Lt.socialListSize),this.friendListHashes=new BigUint64Array(Lt.socialListSize),this.ignoreList=new BigUint64Array(Lt.socialListSize),this.ignoreListCount=0}renderContactsTab(t){let e=this.surface.width2-199,i=36;this.surface.drawSpriteID(e-49,3,this.spriteMedia+5);let s=0,r=s=dt.rgbToLong(160,160,160);if(0===this.uiTabSocialSubTab?r=dt.rgbToLong(220,220,220):s=dt.rgbToLong(220,220,220),this.surface.drawBoxAlpha(e,i,98,24,r,128),this.surface.drawBoxAlpha(e+98,i,98,24,s,128),this.surface.drawBoxAlpha(e,i+24,196,158,dt.rgbToLong(220,220,220),128),this.surface.drawLineHoriz(e,i+24,196,0),this.surface.drawLineVert(e+98,i,24,0),this.surface.drawLineHoriz(e,i+182-16,196,0),this.surface.drawStringCenter("Friends",e+49,i+16,4,0),this.surface.drawStringCenter("Ignore",e+49+98,i+16,4,0),this.panelSocialList.clearList(this.controlListSocialPlayers),0===this.uiTabSocialSubTab)for(let t=0;t<this.friendListCount;t++){let e="";e=0!==(255&this.friendListOnline[t])?!0&this.friendListOnline[t]?"@gre@":"@yel@":"@red@",this.panelSocialList.addListEntry(this.controlListSocialPlayers,t,e+S.hashToUsername(this.friendListHashes[t])+"~"+(this.width2-73)+"~@whi@Remove         WWWWWWWWWW")}if(1===this.uiTabSocialSubTab)for(let t=0;t<this.ignoreListCount;t++)this.panelSocialList.addListEntry(this.controlListSocialPlayers,t,"@yel@"+S.hashToUsername(this.ignoreList[t])+"~439~@whi@Remove         WWWWWWWWWW");if(this.panelSocialList.render(),0===this.uiTabSocialSubTab){let t=this.panelSocialList.getListEntryIndex(this.controlListSocialPlayers);t>=0&&this.mouseX<489?this.mouseX>429?this.surface.drawStringCenter("Click to remove "+S.hashToUsername(this.friendListHashes[t]),e+98,i+35,1,16777215):255===this.friendListOnline[t]?this.surface.drawStringCenter("Click to message "+S.hashToUsername(this.friendListHashes[t]),e+98,i+35,1,16777215):this.friendListOnline[t]>0?this.friendListOnline[t]<200?this.surface.drawStringCenter(S.hashToUsername(this.friendListHashes[t])+" is on world "+(this.friendListOnline[t]-9),e+98,i+35,1,16777215):this.surface.drawStringCenter(S.hashToUsername(this.friendListHashes[t])+" is on classic "+(this.friendListOnline[t]-219),e+98,i+35,1,16777215):this.surface.drawStringCenter(S.hashToUsername(this.friendListHashes[t])+" is offline",e+98,i+35,1,16777215):this.surface.drawStringCenter("Click a name to send a message",e+98,i+35,1,16777215);let s=0;s=this.mouseX>e&&this.mouseX<e+196&&this.mouseY>i+182-16&&this.mouseY<i+182?16776960:16777215,this.surface.drawStringCenter("Click here to add a friend",e+98,i+182-3,1,s)}if(1===this.uiTabSocialSubTab){let t=this.panelSocialList.getListEntryIndex(this.controlListSocialPlayers);t>=0&&this.mouseX<489&&this.mouseX>429?this.mouseX>429&&this.surface.drawStringCenter("Click to remove "+S.hashToUsername(this.ignoreList[t]),e+98,i+35,1,16777215):this.surface.drawStringCenter("Blocking messages from:",e+98,i+35,1,16777215);let s=0;s=this.mouseX>e&&this.mouseX<e+196&&this.mouseY>i+182-16&&this.mouseY<i+182?16776960:16777215,this.surface.drawStringCenter("Click here to add a name",e+98,i+182-3,1,s)}if(t&&(e=this.mouseX-(this.surface.width2-199),i=this.mouseY-36,e>=0&&i>=0&&e<196&&i<182)){if(this.panelSocialList.handleMouse(e+(this.surface.width2-199),i+36,this.lastMouseButtonDown,this.mouseButtonDown,this.mouseScrollDelta),i<=24&&1===this.mouseButtonClick&&(e<98&&1===this.uiTabSocialSubTab?(this.uiTabSocialSubTab=0,this.panelSocialList.resetListProps(this.controlListSocialPlayers)):e>98&&0===this.uiTabSocialSubTab&&(this.uiTabSocialSubTab=1,this.panelSocialList.resetListProps(this.controlListSocialPlayers))),1===this.mouseButtonClick&&0===this.uiTabSocialSubTab){let t=this.panelSocialList.getListEntryIndex(this.controlListSocialPlayers);t>=0&&this.mouseX<489&&(this.mouseX>429?this.friendRemove(this.friendListHashes[t]):0!==this.friendListOnline[t]&&(this.contactsInputCtx=2,this.privateMessageTarget=this.friendListHashes[t],this.inputPmCurrent="",this.inputPmFinal=""))}if(1===this.mouseButtonClick&&1===this.uiTabSocialSubTab){let t=this.panelSocialList.getListEntryIndex(this.controlListSocialPlayers);t>=0&&this.mouseX<489&&this.mouseX>429&&this.ignoreRemove(this.ignoreList[t])}i>166&&1===this.mouseButtonClick&&0===this.uiTabSocialSubTab&&(this.contactsInputCtx=1,this.inputTextCurrent="",this.inputTextFinal=""),i>166&&1===this.mouseButtonClick&&1===this.uiTabSocialSubTab&&(this.contactsInputCtx=3,this.inputTextCurrent="",this.inputTextFinal=""),this.mouseButtonClick=0}}sendLogout(){if(this.gameState===A.WORLD){if(this.combatTimeout>0)return this.combatTimeout>ne(9)?void this.showMessage("@cya@You can't logout during combat!",3):void this.showMessage("@cya@You can't logout for 10 seconds after combat!",3);this.clientStream.newPacket(It.LOGOUT),this.clientStream.sendPacket(),this.logoutBoxFrames=ne(20)}}createPlayer(t,e,i,s){let r=this.playerServer[t];r||(r=this.playerServer[t]=new ot,this.playerServer[t].serverIndex=t,this.playerServer[t].appearanceTicket=0);let n=!1;for(let e=0;e<this.knownPlayerCount;e++)if(!this.knownPlayers[e]||this.knownPlayers[e].serverIndex===t){n=!0;break}if(n){r.animationNext=s;let t=r.waypointCurrent;e===r.waypointsX[t]&&i===r.waypointsY[t]||(r.waypointCurrent=t=(t+1)%10,r.waypointsX[t]=e,r.waypointsY[t]=i)}else r.serverIndex=t,r.targetWaypoint=0,r.waypointCurrent=0,r.waypointsX[0]=r.currentX=e,r.waypointsY[0]=r.currentY=i,r.animationNext=r.animationCurrent=s,r.stepCount=0;return this.players[this.playerCount++]=r,r}renderSocialInputBox(){if(0!==this.mouseButtonClick){if(this.mouseButtonClick=0,(3===this.contactsInputCtx||1===this.contactsInputCtx)&&(this.mouseX<106||this.mouseY<145||this.mouseX>406||this.mouseY>215))return void(this.contactsInputCtx=0);if(2===this.contactsInputCtx&&(this.mouseX<6||this.mouseY<145||this.mouseX>506||this.mouseY>215))return void(this.contactsInputCtx=0);if(this.mouseX>236&&this.mouseX<276&&this.mouseY>193&&this.mouseY<213)return void(this.contactsInputCtx=0)}let t=145;if(1===this.contactsInputCtx&&(this.surface.drawBox(106,t,300,70,0),this.surface.drawBoxEdge(106,t,300,70,16777215),t+=20,this.surface.drawStringCenter("Enter name to add to friends list",256,t,4,16777215),t+=20,this.surface.drawStringCenter(this.inputTextCurrent+"*",256,t,4,16777215),this.inputTextFinal.length>0)){let t=this.inputTextFinal.trim();this.inputTextCurrent="",this.inputTextFinal="",this.contactsInputCtx=0,this.privateMessageTarget=S.usernameToHash(t),this.privateMessageTarget>0&&this.localPlayer.hash!==this.privateMessageTarget?(this.friendAdd(S.hashToUsername(this.privateMessageTarget)),this.showMessage("@que@"+S.hashToUsername(this.privateMessageTarget)+" has been added to your friend-list.",3)):this.showMessage("@que@You can't add yourself!!",3)}if(2===this.contactsInputCtx&&(this.surface.drawBox(6,t,500,70,0),this.surface.drawBoxEdge(6,t,500,70,16777215),t+=20,this.surface.drawStringCenter("Enter message to send to "+S.hashToUsername(this.privateMessageTarget),256,t,4,16777215),t+=20,this.surface.drawStringCenter(this.inputPmCurrent+"*",256,t,4,16777215),this.inputPmFinal.length>0)){if(this.contactsInputCtx=0,this.privateMessageTarget>0)return;let t=this.chatSystem.encode(this.inputPmFinal.slice(0,80).toLowerCase());this.inputPmCurrent="",this.inputPmFinal="",t&&0!==this.privateMessageTarget&&this.privateMessageTarget!==this.localPlayer.hash?(this.sendPrivateMessage(this.privateMessageTarget,t,t.length),this.showServerMessage("@pri@You tell "+S.hashToUsername(this.privateMessageTarget)+": "+this.chatSystem.decode(this.chatSystem.normalize(t)))):this.showMessage("@que@Problem sending private message to target!",3)}if(3===this.contactsInputCtx&&(this.surface.drawBox(106,t,300,70,0),this.surface.drawBoxEdge(106,t,300,70,16777215),t+=20,this.surface.drawStringCenter("Enter name to add to ignore list",256,t,4,16777215),t+=20,this.surface.drawStringCenter(this.inputTextCurrent+"*",256,t,4,16777215),this.inputTextFinal.length>0)){let t=S.hashToUsername(S.usernameToHash(this.inputTextFinal.trim()));if(this.contactsInputCtx=0,this.inputTextCurrent="",this.inputTextFinal="",t.length>0){if(S.usernameToHash(this.localPlayer.name)===S.usernameToHash(t))return void this.showMessage("@que@You can't ignore yourself!",3);this.showMessage("@que@"+t+" has been added to your ignored-list.",3),super.ignoreAdd(t)}}let e=16777215;this.mouseX>236&&this.mouseX<276&&this.mouseY>193&&this.mouseY<213&&(e=16776960),this.surface.drawStringCenter("Cancel",256,208,1,e)}createAppearancePanel(){this.panelGame[L]=new qt(this.surface,100),this.panelGame[L].addText(256,10,"Please design Your Character",4,!0);let t=140,e=34;t+=116,e-=10,this.panelGame[L].addText(201,e+110,"Front",3,!0),this.panelGame[L].addText(t,e+110,"Side",3,!0),this.panelGame[L].addText(311,e+110,"Back",3,!0);e+=145,this.panelGame[L].addBoxRounded(202,e,53,41),this.panelGame[L].addText(202,e-8,"Head",1,!0),this.panelGame[L].addText(202,e+8,"Type",1,!0),this.panelGame[L].addSprite(162,e,qt.spriteStart+7),this.controlButtonAppearanceHead1=this.panelGame[L].addButton(162,e,20,20),this.panelGame[L].addSprite(242,e,qt.spriteStart+6),this.controlButtonAppearanceHead2=this.panelGame[L].addButton(242,e,20,20),this.panelGame[L].addBoxRounded(310,e,53,41),this.panelGame[L].addText(310,e-8,"Hair",1,!0),this.panelGame[L].addText(310,e+8,"Color",1,!0),this.panelGame[L].addSprite(270,e,qt.spriteStart+7),this.controlButtonAppearanceHair1=this.panelGame[L].addButton(270,e,20,20),this.panelGame[L].addSprite(350,e,qt.spriteStart+6),this.controlButtonAppearanceHair2=this.panelGame[L].addButton(350,e,20,20),e+=50,this.panelGame[L].addBoxRounded(202,e,53,41),this.panelGame[L].addText(202,e,"Gender",1,!0),this.panelGame[L].addSprite(162,e,qt.spriteStart+7),this.controlButtonAppearanceGender1=this.panelGame[L].addButton(162,e,20,20),this.panelGame[L].addSprite(242,e,qt.spriteStart+6),this.controlButtonAppearanceGender2=this.panelGame[L].addButton(242,e,20,20),this.panelGame[L].addBoxRounded(310,e,53,41),this.panelGame[L].addText(310,e-8,"Top",1,!0),this.panelGame[L].addText(310,e+8,"Color",1,!0),this.panelGame[L].addSprite(270,e,qt.spriteStart+7),this.controlButtonAppearanceTop1=this.panelGame[L].addButton(270,e,20,20),this.panelGame[L].addSprite(350,e,qt.spriteStart+6),this.controlButtonAppearanceTop2=this.panelGame[L].addButton(350,e,20,20),e+=50,this.panelGame[L].addBoxRounded(202,e,53,41),this.panelGame[L].addText(202,e-8,"Skin",1,!0),this.panelGame[L].addText(202,e+8,"Color",1,!0),this.panelGame[L].addSprite(162,e,qt.spriteStart+7),this.controlButtonAppearanceSkin1=this.panelGame[L].addButton(162,e,20,20),this.panelGame[L].addSprite(242,e,qt.spriteStart+6),this.controlButtonAppearanceSkin2=this.panelGame[L].addButton(242,e,20,20),this.panelGame[L].addBoxRounded(310,e,53,41),this.panelGame[L].addText(310,e-8,"Bottom",1,!0),this.panelGame[L].addText(310,e+8,"Color",1,!0),this.panelGame[L].addSprite(270,e,qt.spriteStart+7),this.controlButtonAppearanceBottom1=this.panelGame[L].addButton(270,e,20,20),this.panelGame[L].addSprite(350,e,qt.spriteStart+6),this.controlButtonAppearanceBottom2=this.panelGame[L].addButton(350,e,20,20),e+=82,e-=35,this.panelGame[L].addButtonBackground(t,e,200,30),this.panelGame[L].addText(t,e,"Accept",4,!1),this.controlButtonAppearanceAccept=this.panelGame[L].addButton(t,e,200,30)}resetPMText(){this.inputPmCurrent="",this.inputPmFinal=""}renderWelcomeNotification(){let t=65;201!==this.welcomeRecoverySetDays&&(t+=60),this.unreadMessageCount>0&&(t+=60),0!==this.lastRemoteIP&&(t+=45);let e=167-(t/2|0);this.surface.drawBox(56,167-(t/2|0),400,t,0),this.surface.drawBoxEdge(56,167-(t/2|0),400,t,16777215),e+=20,this.surface.drawStringCenter("Welcome to RuneScape "+this.loginUser,256,e,4,16776960),e+=30;let i="";if(i=0===this.daysSinceLogin?"earlier today":1===this.daysSinceLogin?"yesterday":this.daysSinceLogin+" days ago",0!==this.lastRemoteIP&&(this.surface.drawStringCenter("You last logged in "+i,256,e,1,16777215),e+=15,this.lastRemoteHost||(this.lastRemoteHost=this.getHostnameIP(this.lastRemoteIP)),this.surface.drawStringCenter("from: "+this.lastRemoteHost,256,e,1,16777215),e+=15,e+=15),this.unreadMessageCount>0){let t=16777215;this.surface.drawStringCenter("Jagex staff will NEVER email you. We use the",256,e,1,t),e+=15,this.surface.drawStringCenter("message-centre on this website instead.",256,e,1,t),e+=15,1===this.unreadMessageCount?this.surface.drawStringCenter("You have @yel@0@whi@ unread messages in your message-centre",256,e,1,16777215):this.surface.drawStringCenter("You have @gre@"+(this.unreadMessageCount-1)+" unread messages @whi@in your message-centre",256,e,1,16777215),e+=15,e+=15}if(0===this.welcomeRecoverySetDays)this.surface.drawStringCenter("You have not yet set any password recovery questions.",256,e,1,16744448),e+=15,this.surface.drawStringCenter("We strongly recommend you do so now to secure your account.",256,e,1,16744448),e+=15,this.surface.drawStringCenter("Do this from the 'account management' area on our front webpage",256,e,1,16744448),e+=15;else if(201!==this.welcomeRecoverySetDays){this.welcomeRecoverySetDays--;let t=this.welcomeRecoverySetDays+" days ago";0===this.welcomeRecoverySetDays?t="Earlier today":1===this.welcomeRecoverySetDays&&(t="Yesterday"),this.surface.drawStringCenter(t+" you changed your recovery questions",255,e,1,16744448),e+=15,this.surface.drawStringCenter("If you do not remember making this change then cancel it immediately",255,e,1,16744448),e+=15,this.surface.drawStringCenter("Do this from the 'account management' area on our front webpage",255,e,1,16744448),e+=15,e+=15}let s=16777215;this.mouseY>e-12&&this.mouseY<=e&&this.mouseX>106&&this.mouseX<406&&(s=16711680),this.surface.drawStringCenter("Click here to close window",256,e,1,s),1===this.mouseButtonClick&&(16711680===s&&(this.welcomeBoxVisible=!1),(this.mouseX<86||this.mouseX>426)&&(this.mouseY<167-(t/2|0)||this.mouseY>167+(t/2|0))&&(this.welcomeBoxVisible=!1)),this.mouseButtonClick=0}drawAppearancePanelCharacterSprites(){this.surface.interlace=!1,this.surface.blackScreen(),this.panelGame[L].render();let t=140,e=50;t+=116,e-=25,t-=32,this.surface._spriteClipping_from9(169,e,64,102,Et.animationNumber[this.appearanceHeadType],this.characterHairColours[this.appearanceHairColour],this.characterSkinColours[this.appearanceSkinColour],0,!1),this.surface._spriteClipping_from9(169,e,64,102,Et.animationNumber[this.appearanceBodyGender],this.characterTopBottomColours[this.appearanceTopColour],this.characterSkinColours[this.appearanceSkinColour],0,!1),this.surface._spriteClipping_from6(169,e,64,102,Et.animationNumber[this.appearance2Colour],this.characterTopBottomColours[this.appearanceBottomColour]),this.surface._spriteClipping_from9(t,e,64,102,Et.animationNumber[this.appearanceHeadType]+6,this.characterHairColours[this.appearanceHairColour],this.characterSkinColours[this.appearanceSkinColour],0,!1),this.surface._spriteClipping_from9(t,e,64,102,Et.animationNumber[this.appearanceBodyGender]+6,this.characterTopBottomColours[this.appearanceTopColour],this.characterSkinColours[this.appearanceSkinColour],0,!1),this.surface._spriteClipping_from6(t,e,64,102,Et.animationNumber[this.appearance2Colour]+6,this.characterTopBottomColours[this.appearanceBottomColour]),this.surface._spriteClipping_from9(279,e,64,102,Et.animationNumber[this.appearanceHeadType]+12,this.characterHairColours[this.appearanceHairColour],this.characterSkinColours[this.appearanceSkinColour],0,!1),this.surface._spriteClipping_from9(279,e,64,102,Et.animationNumber[this.appearanceBodyGender]+12,this.characterTopBottomColours[this.appearanceTopColour],this.characterSkinColours[this.appearanceSkinColour],0,!1),this.surface._spriteClipping_from6(279,e,64,102,Et.animationNumber[this.appearance2Colour]+12,this.characterTopBottomColours[this.appearanceBottomColour]),this.surface.drawSpriteID(0,this.gameHeight,this.spriteMedia+22),this.surface.draw(this.graphics,0,0)}drawItem(t,e,i,s,r,n,o){let a=Et.itemPicture[r]+this.spriteItem,h=Et.itemMask[r];this.surface._spriteClipping_from9(t,e,i,s,a,h,0,0,!1)}async handleGameInput(){if(await this.checkConnection(),0!==this.systemUpdate&&this.systemUpdate--,this.logoutBoxFrames>0&&this.logoutBoxFrames--,this.combatTimeout>0&&this.combatTimeout--,this.localPlayer.isFighting()&&(this.combatTimeout=ne(10)),this.deathScreenTimeout>0&&0==--this.deathScreenTimeout&&(this.showMessage("You have been granted another life. Be more careful this time!",3),this.showMessage("You retain your skills. Your objects land where you died",3)),this.showAppearanceChange)this.handleAppearancePanelControls();else{for(let t=0;t<this.playerCount;t++){let e=this.players[t];if(!e)return void console.log(`missing players[${t}]; max index:${this.playerCount}`);e.traversePath(),e.messageTimeout>0&&e.messageTimeout--,e.bubble&&e.bubble.tick(()=>{e.bubble=void 0}),e.projectileRange>0&&e.projectileRange--,e.healthTimer.tick(()=>{e.healthTimer.disable()})}for(let t=0;t<this.npcCount;t++){let e=this.npcs[t];if(!e)return void console.log(`missing npcs[${t}]; max index:${this.npcCount}`);e.traversePath(),43===e.typeID&&e.stepCount++,e.messageTimeout>0&&e.messageTimeout--,e.bubble&&e.bubble.tick(()=>{e.bubble=void 0}),e.healthTimer.tick(()=>{e.healthTimer.disable()})}if(2!==this.showUiTab&&(dt.anInt346>0&&this.sleepWordDelayTimer++,dt.anInt347>0&&(this.sleepWordDelayTimer=0),dt.anInt346=0,dt.anInt347=0),(Math.abs(this.cameraAutoRotatePlayerX-this.localPlayer.currentX)>500||Math.abs(this.cameraAutoRotatePlayerY-this.localPlayer.currentY)>500)&&(this.cameraAutoRotatePlayerX=this.localPlayer.currentX,this.cameraAutoRotatePlayerY=this.localPlayer.currentY),!this.cameraAutoAngleDebug&&(this.cameraAutoRotatePlayerX!==this.localPlayer.currentX&&(this.cameraAutoRotatePlayerX+=(this.localPlayer.currentX-this.cameraAutoRotatePlayerX)/(16+((this.cameraZoom-500)/15|0))|0),this.cameraAutoRotatePlayerY!==this.localPlayer.currentY&&(this.cameraAutoRotatePlayerY+=(this.localPlayer.currentY-this.cameraAutoRotatePlayerY)/(16+((this.cameraZoom-500)/15|0))|0),this.optionCameraModeAuto)){let t=32*this.cameraAngle;if(t===this.cameraRotation)this.autoAngleFrameStep=0;else{let e=Math.abs(t-this.cameraRotation);e>128&&(e=256-e);let i=++this.autoAngleFrameStep*e+255>>8;this.cameraRotation+=t<this.cameraRotation?-i:i,this.cameraRotation&=255}}if(this.sleepWordDelayTimer>20&&(this.sleepWordDelay=!1,this.sleepWordDelayTimer=0),this.isSleeping){if(this.inputTextFinal){if(/^::/.test(this.inputTextFinal)){let t=this.inputTextFinal.slice(2);return/^closecon$/i.test(t)?void this.clientStream.closeStream():/^logout$/i.test(t)?void this.closeConnection():/^lostcon$/i.test(t)?void await this.lostConnection():void 0}this.doGuessCaptcha(this.inputTextFinal)}return 1===this.lastMouseButtonDown&&this.mouseY>275&&this.mouseY<310&&this.mouseX>56&&this.mouseX<456&&this.doGuessCaptcha("-null-"),void(this.lastMouseButtonDown=0)}if(this.mouseY>this.gameHeight-4&&(this.mouseX>15&&this.mouseX<96&&1===this.lastMouseButtonDown&&(this.messageTabSelected=0),this.mouseX>110&&this.mouseX<194&&1===this.lastMouseButtonDown&&(this.messageTabSelected=1,this.panelGame[M].controlFlashText[this.controlTextListChat]=999999),this.mouseX>215&&this.mouseX<295&&1===this.lastMouseButtonDown&&(this.messageTabSelected=2,this.panelGame[M].controlFlashText[this.controlTextListQuest]=999999),this.mouseX>315&&this.mouseX<395&&1===this.lastMouseButtonDown&&(this.messageTabSelected=3,this.panelGame[M].controlFlashText[this.controlTextListPrivate]=999999),this.mouseX>417&&this.mouseX<497&&1===this.lastMouseButtonDown&&(this.reportAbuseState=1,this.reportAbuseOffence=0,this.inputTextCurrent="",this.inputTextFinal=""),this.lastMouseButtonDown=0,this.mouseButtonDown=0),this.panelGame[M].handleMouse(this.mouseX,this.mouseY,this.lastMouseButtonDown,this.mouseButtonDown,this.mouseScrollDelta),this.messageTabSelected>0&&this.mouseX>=this.gameWidth2-18&&this.mouseY>=this.gameHeight2-66&&(this.lastMouseButtonDown=0),this.panelGame[M].isClicked(this.controlTextListAll)){let t=this.panelGame[M].getText(this.controlTextListAll);if(t.length>0){if(this.panelGame[M].setTextHandle(this.controlTextListAll,""),this.lastLog.push(t),this.lastLogIdx=-1,/^::/.test(t)){let e=t.substring(2);return/^closecon$/i.test(e)?void this.clientStream.closeStream():/^logout$/i.test(e)?void this.closeConnection():/^(lostcon|dc)$/i.test(e)?void await this.lostConnection():void this.sendCommandString(e)}let e=this.chatSystem.encode(t);if(0===e.length)return;if(this.sendChatMessage(e,e.length),!this.localPlayer)return;t=this.chatSystem.decode(e),this.localPlayer.messageTimeout=ne(3),this.localPlayer.message=t,this.showMessage(this.localPlayer.name+": "+t,2)}}if(0===this.messageTabSelected)for(let t=0;t<this.messageHistory.length;t++)this.messageHistory[t].ticks>0?this.messageHistory[t].ticks-=1:this.messageHistory.pop();if(this.deathScreenTimeout>0&&(this.lastMouseButtonDown=0),this.tradeConfigVisible||this.duelConfigVisible?(1===this.mouseButtonDown?this.mouseButtonDownTime+=1:this.mouseButtonDownTime=0,this.mouseButtonDownTime>ne(12)?this.mouseItemTickDelta+=5e3:this.mouseButtonDownTime>ne(9)?this.mouseItemTickDelta+=500:this.mouseButtonDownTime>ne(6)?this.mouseItemTickDelta+=50:this.mouseButtonDownTime>ne(3)?this.mouseItemTickDelta+=5:(this.mouseButtonDownTime>ne(1)||this.mouseButtonDownTime>20&&0==(5&this.mouseButtonDownTime))&&this.mouseItemTickDelta++):(this.mouseButtonDownTime=0,this.mouseItemTickDelta=0),1===this.lastMouseButtonDown?this.mouseButtonClick=1:2===this.lastMouseButtonDown&&(this.mouseButtonClick=2),this.scene.setMouseLoc(this.mouseX,this.mouseY),this.lastMouseButtonDown=0,this.optionCameraModeAuto){if(0===this.anInt707||this.cameraAutoAngleDebug){if(this.keyLeft&&(this.cameraAngle=this.cameraAngle+1&7,this.keyLeft=!1,!this.fogOfWar)){0==(1&this.cameraAngle)&&(this.cameraAngle=this.cameraAngle+1&7);for(let t=0;t<8&&!this.isValidCameraAngle(this.cameraAngle);t++)this.cameraAngle=this.cameraAngle+1&7}if(this.keyRight&&(this.cameraAngle=this.cameraAngle+7&7,this.keyRight=!1,!this.fogOfWar)){0==(1&this.cameraAngle)&&(this.cameraAngle=this.cameraAngle+7&7);for(let t=0;t<8&&!this.isValidCameraAngle(this.cameraAngle);t++)this.cameraAngle=this.cameraAngle+7&7}}}else this.keyLeft?this.cameraRotation=this.cameraRotation+2&255:this.keyRight&&(this.cameraRotation=this.cameraRotation-2&255);!this.optionCameraModeAuto&&this.options.middleClickCamera&&this.middleButtonDown&&(this.cameraRotation=this.originRotation+(this.mouseX-this.originMouseX)/2&255),this.options.zoomCamera?this.handleCameraZoom():this.fogOfWar&&this.cameraZoom>550?this.cameraZoom-=4:!this.fogOfWar&&this.cameraZoom<750&&(this.cameraZoom+=4),0!==this.mouseClickXStep&&(this.mouseClickXStep+=-Math.sign(this.mouseClickXStep)),this.scene.doSOemthingWithTheFuckinFountainFuck(17),this.objectAnimationCount++,this.objectAnimationCount>5&&(this.objectAnimationCount=0,this.objectAnimationNumberFireLightningSpell=(this.objectAnimationNumberFireLightningSpell+1)%3,this.objectAnimationNumberTorch=(this.objectAnimationNumberTorch+1)%4,this.objectAnimationNumberClaw=(this.objectAnimationNumberClaw+1)%5);for(let t=0;t<this.objectCount;t++){this.objectX[t],this.objectY[t];this.objectX[t]>=0&&this.objectY[t]>=0&&this.objectX[t]<96&&this.objectY[t]<96&&74===this.objectId[t]&&this.objectModel[t].rotate(1,0,0)}for(let t=0;t<this.teleportBubbleCount;t++)if(this.teleportBubbleTime[t]++,this.teleportBubbleTime[t]>ne(1)){this.teleportBubbleCount--;for(let e=t;e<this.teleportBubbleCount;e++)this.teleportBubbleX[e]=this.teleportBubbleX[e+1],this.teleportBubbleY[e]=this.teleportBubbleY[e+1],this.teleportBubbleTime[e]=this.teleportBubbleTime[e+1],this.teleportBubbleType[e]=this.teleportBubbleType[e+1]}}}doGuessCaptcha(t){let e=new wt(It.SLEEP_WORD);e.startAccess(),e.putString(t),this.sleepWordDelay||(e.putByte(0),this.sleepWordDelay=!0),e.stopAccess(),this.clientStream.add(e),this.inputTextCurrent="",this.inputTextFinal="",this.sleepingStatusText="Please wait..."}handleCameraZoom(){if(this.keyUp?this.cameraZoom-=8:this.keyDown?this.cameraZoom+=8:this.keyHome?this.cameraZoom=750:this.keyPgUp?this.cameraZoom=450:this.keyPgDown&&(this.cameraZoom=1250),0!==this.mouseScrollDelta&&(2===this.showUiTab||0===this.showUiTab)){if(0!==this.messageTabSelected&&this.mouseY>this.gameHeight-64)return;this.cameraZoom+=24*this.mouseScrollDelta}this.cameraZoom>=1250?this.cameraZoom=1250:this.cameraZoom<=450&&(this.cameraZoom=450)}renderLoginScreenViewports(){this.world._loadSection_from3(2423,2423,0),this.world.addModels(this.gameModels);let t=9728,e=6400,i=1100,s=888;this.scene.clipFar3d=4100,this.scene.clipFar2d=4100,this.scene.fogZFalloff=1,this.scene.fogZDistance=4e3,this.surface.blackScreen(),this.scene.setCamera(t,-this.world.getElevation(t,e),e,912,s,0,2*i),this.scene.render(),this.surface.fadeToBlack(),this.surface.fadeToBlack(),this.surface.drawBox(0,0,this.gameWidth,6,0);for(let t=6;t>=1;t--)this.surface.drawLineAlpha(0,t,0,t,this.gameWidth,8);this.surface.drawBox(0,194,512,20,0);for(let t=6;t>=1;t--)this.surface.drawLineAlpha(0,t,0,194-t,this.gameWidth,8);this.surface.drawSpriteID((this.gameWidth/2|0)-(this.surface.spriteWidth[this.spriteMedia+10]/2|0),15,this.spriteMedia+10),this.surface._drawSprite_from5(this.spriteLogo,0,0,this.gameWidth,200),this.surface.drawWorld(this.spriteLogo),t=9216,e=9216,i=1100,s=888,this.scene.clipFar3d=4100,this.scene.clipFar2d=4100,this.scene.fogZFalloff=1,this.scene.fogZDistance=4e3,this.surface.blackScreen(),this.scene.setCamera(t,-this.world.getElevation(t,e),e,912,s,0,2*i),this.scene.render(),this.surface.fadeToBlack(),this.surface.fadeToBlack(),this.surface.drawBox(0,0,this.gameWidth,6,0);for(let t=6;t>=1;t--)this.surface.drawLineAlpha(0,t,0,t,this.gameWidth,8);this.surface.drawBox(0,194,this.gameWidth,20,0);for(let t=6;t>=1;t--)this.surface.drawLineAlpha(0,t,0,194-t,this.gameWidth,8);this.surface.drawSpriteID((this.gameWidth/2|0)-(this.surface.spriteWidth[this.spriteMedia+10]/2|0),15,this.spriteMedia+10),this.surface._drawSprite_from5(this.spriteLogo+1,0,0,this.gameWidth,200),this.surface.drawWorld(this.spriteLogo+1);for(let t=0;t<64;t++)this.scene.removeModel(this.world.roofModels[0][t]),this.scene.removeModel(this.world.wallModels[1][t]),this.scene.removeModel(this.world.roofModels[1][t]),this.scene.removeModel(this.world.wallModels[2][t]),this.scene.removeModel(this.world.roofModels[2][t]);t=11136,e=10368,i=500,s=376,this.scene.clipFar3d=4100,this.scene.clipFar2d=4100,this.scene.fogZFalloff=1,this.scene.fogZDistance=4e3,this.surface.blackScreen(),this.scene.setCamera(t,-this.world.getElevation(t,e),e,912,s,0,2*i),this.scene.render(),this.surface.fadeToBlack(),this.surface.fadeToBlack(),this.surface.drawBox(0,0,this.gameWidth,6,0);for(let t=6;t>=1;t--)this.surface.drawLineAlpha(0,t,0,t,this.gameWidth,8);this.surface.drawBox(0,194,this.gameWidth,20,0);for(let t=6;t>=1;t--)this.surface.drawLineAlpha(0,t,0,194,this.gameWidth,8);this.surface.drawSpriteID((this.gameWidth/2|0)-(this.surface.spriteWidth[this.spriteMedia+10]/2|0),15,this.spriteMedia+10),this.surface._drawSprite_from5(this.spriteMedia+10,0,0,this.gameWidth,200),this.surface.drawWorld(this.spriteMedia+10)}createLoginPanels(){this.panelLogin[k.WELCOME]=new qt(this.surface,50),this.panelLogin[k.NEW_USER]=new qt(this.surface,50),this.panelLogin[k.EXISTING_USER]=new qt(this.surface,50);let t=40,e=Math.floor(this.gameWidth/2);this.panelLogin[k.WELCOME].addText(e,200+t,"Click on an option",5,!0),this.panelLogin[k.WELCOME].addButtonBackground(e-100,240+t,120,35),this.panelLogin[k.WELCOME].addButtonBackground(e+100,240+t,120,35),this.panelLogin[k.WELCOME].addText(e-100,240+t,"New User",5,!1),this.panelLogin[k.WELCOME].addText(e+100,240+t,"Existing User",5,!1),this.controlWelcomeNewuser=this.panelLogin[k.WELCOME].addButton(e-100,240+t,120,35),this.controlWelcomeExistinguser=this.panelLogin[k.WELCOME].addButton(e+100,240+t,120,35),t=70,this.controlRegisterStatus=this.panelLogin[k.NEW_USER].addText(e,t+8,"To create an account please enter all the requested details",4,!0);let i=t+25;this.panelLogin[k.NEW_USER].addButtonBackground(e,i+17,250,34),this.panelLogin[k.NEW_USER].addText(e,i+8,"Choose a Username",4,!1),this.controlRegisterUser=this.panelLogin[k.NEW_USER].addTextInput(e,i+25,200,40,4,12,!1,!1),this.panelLogin[k.NEW_USER].setFocus(this.controlRegisterUser),i+=40,this.panelLogin[k.NEW_USER].addButtonBackground(e-115,i+17,220,34),this.panelLogin[k.NEW_USER].addText(e-115,i+8,"Choose a Password",4,!1),this.controlRegisterPassword=this.panelLogin[k.NEW_USER].addTextInput(e-115,i+25,220,40,4,20,!0,!1),this.panelLogin[k.NEW_USER].addButtonBackground(e+115,i+17,220,34),this.panelLogin[k.NEW_USER].addText(e+115,i+8,"Confirm Password",4,!1),this.controlRegisterConfirmPassword=this.panelLogin[k.NEW_USER].addTextInput(e+115,i+25,220,40,4,20,!0,!1),i+=60,this.controlRegisterCheckbox=this.panelLogin[k.NEW_USER].addCheckbox(e-196-7,i-7,14,14),this.panelLogin[k.NEW_USER].addTextAbsolute(e-181,i,"I have read and agree to the terms and conditions",4,!0),i+=15,this.panelLogin[k.NEW_USER].addText(e,i,"(to view these click the relevant link below this game window)",4,!0),i+=20,this.panelLogin[k.NEW_USER].addButtonBackground(e-100,i+17,150,34),this.panelLogin[k.NEW_USER].addText(e-100,i+17,"Submit",5,!1),this.controlRegisterSubmit=this.panelLogin[k.NEW_USER].addButton(e-100,i+17,150,34),this.panelLogin[k.NEW_USER].addButtonBackground(e+100,i+17,150,34),this.panelLogin[k.NEW_USER].addText(e+100,i+17,"Cancel",5,!1),this.controlRegisterCancel=this.panelLogin[k.NEW_USER].addButton(e+100,i+17,150,34),t=230,this.controlLoginStatus=this.panelLogin[k.EXISTING_USER].addText(e,t-10,"Please enter your username and password",4,!0),t+=28,this.panelLogin[k.EXISTING_USER].addButtonBackground(e-116,t,200,40),this.panelLogin[k.EXISTING_USER].addText(e-116,t-10,"Username:",4,!1),this.panelLogin[k.EXISTING_USER].addText(e-55,t-5,"Save?",2,!1),this.controlLoginSavePass=this.panelLogin[k.EXISTING_USER].addCheckbox(e-60,t+5,10,10),this.controlLoginUser=this.panelLogin[k.EXISTING_USER].addTextInput(e-116,t+10,200,40,4,12,!1,!1),t+=47,this.panelLogin[k.EXISTING_USER].addButtonBackground(e-66,t,200,40),this.panelLogin[k.EXISTING_USER].addText(e-66,t-10,"Password:",4,!1),this.controlLoginPass=this.panelLogin[k.EXISTING_USER].addTextInput(e-66,t+10,200,40,4,20,!0,!1),t-=55,this.panelLogin[k.EXISTING_USER].addButtonBackground(e+154,t,120,25),this.panelLogin[k.EXISTING_USER].addText(e+154,t,"Ok",4,!1),this.controlLoginOk=this.panelLogin[k.EXISTING_USER].addButton(e+154,t,120,25),t+=30,this.panelLogin[k.EXISTING_USER].addButtonBackground(e+154,t,120,25),this.panelLogin[k.EXISTING_USER].addText(e+154,t,"Cancel",4,!1),this.controlLoginCancel=this.panelLogin[k.EXISTING_USER].addButton(e+154,t,120,25),t+=30,this.panelLogin[k.EXISTING_USER].setFocus(this.controlLoginUser)}renderInventoryTab(t){let e=this.surface.width2-248;this.surface.drawSpriteID(e,3,this.spriteMedia+1);for(let t=0;t<this.inventoryMaxItemCount;t++){let i=e+t%5*49,s=36+34*Math.floor(t/5);t<this.inventoryItemsCount&&this.inventoryEquipped[t]?this.surface.drawBoxAlpha(i,s,49,34,16711680,128):this.surface.drawBoxAlpha(i,s,49,34,dt.rgbToLong(181,181,181),128),t<this.inventoryItemsCount&&(this.surface._spriteClipping_from9(i,s,48,32,this.spriteItem+Et.itemPicture[this.inventoryItemId[t]],Et.itemMask[this.inventoryItemId[t]],0,0,!1),0===Et.itemStackable[this.inventoryItemId[t]]&&this.surface.drawString(this.inventoryItemStackCount[t].toString(),i+1,s+10,1,16776960))}for(let t=1;t<=4;t++)this.surface.drawLineVert(e+49*t,36,34*(this.inventoryMaxItemCount/5|0),0);for(let t=1;t<=(this.inventoryMaxItemCount/5|0)-1;t++)this.surface.drawLineHoriz(e,36+34*t,245,0);if(!t)return;let i=this.mouseX-(this.surface.width2-248),s=this.mouseY-36;if(i>=0&&s>=0&&i<248&&s<34*Math.floor(this.inventoryMaxItemCount/5)){let t=Math.floor(i/49)+5*Math.floor(s/34);if(t<this.inventoryItemsCount){let e=this.inventoryItemId[t];if(this.selectedSpell>=0)3===Et.spellType[this.selectedSpell]&&(this.menuItemText1[this.menuItemsCount]="Cast "+Et.spellName[this.selectedSpell]+" on",this.menuItemText2[this.menuItemsCount]="@lre@"+Et.itemName[e],this.menuItemID[this.menuItemsCount]=600,this.menuSourceType[this.menuItemsCount]=t,this.menuSourceIndex[this.menuItemsCount]=this.selectedSpell,this.menuItemsCount++);else{if(this.selectedItemInventoryIndex>=0)return this.menuItemText1[this.menuItemsCount]="Use "+this.selectedItemName+" with",this.menuItemText2[this.menuItemsCount]="@lre@"+Et.itemName[e],this.menuItemID[this.menuItemsCount]=610,this.menuSourceType[this.menuItemsCount]=t,this.menuSourceIndex[this.menuItemsCount]=this.selectedItemInventoryIndex,void this.menuItemsCount++;this.inventoryEquipped[t]?(this.menuItemText1[this.menuItemsCount]="Remove",this.menuItemText2[this.menuItemsCount]="@lre@"+Et.itemName[e],this.menuItemID[this.menuItemsCount]=620,this.menuSourceType[this.menuItemsCount]=t,this.menuItemsCount++):0!==Et.itemWearable[e]&&(0!=(24&Et.itemWearable[e])?this.menuItemText1[this.menuItemsCount]="Wield":this.menuItemText1[this.menuItemsCount]="Wear",this.menuItemText2[this.menuItemsCount]="@lre@"+Et.itemName[e],this.menuItemID[this.menuItemsCount]=630,this.menuSourceType[this.menuItemsCount]=t,this.menuItemsCount++),""!==Et.itemCommand[e]&&(this.menuItemText1[this.menuItemsCount]=Et.itemCommand[e],this.menuItemText2[this.menuItemsCount]="@lre@"+Et.itemName[e],this.menuItemID[this.menuItemsCount]=640,this.menuSourceType[this.menuItemsCount]=t,this.menuItemsCount++),this.menuItemText1[this.menuItemsCount]="Use",this.menuItemText2[this.menuItemsCount]="@lre@"+Et.itemName[e],this.menuItemID[this.menuItemsCount]=650,this.menuSourceType[this.menuItemsCount]=t,this.menuItemsCount++,this.menuItemText1[this.menuItemsCount]="Drop",this.menuItemText2[this.menuItemsCount]="@lre@"+Et.itemName[e],this.menuItemID[this.menuItemsCount]=660,this.menuSourceType[this.menuItemsCount]=t,this.menuItemsCount++,this.menuItemText1[this.menuItemsCount]="Examine",this.menuItemText2[this.menuItemsCount]="@lre@"+Et.itemName[e],this.menuItemID[this.menuItemsCount]=3600,this.menuSourceType[this.menuItemsCount]=e,this.menuItemsCount++}}}}autorotateCamera(){if(1==(1&this.cameraAngle)&&this.isValidCameraAngle(this.cameraAngle))return;if(0==(1&this.cameraAngle)&&this.isValidCameraAngle(this.cameraAngle))return this.isValidCameraAngle(this.cameraAngle+1&7)?void(this.cameraAngle=this.cameraAngle+1&7):void(this.isValidCameraAngle(this.cameraAngle+7&7)&&(this.cameraAngle=this.cameraAngle+7&7));let t=Int32Array.from([1,-1,2,-2,3,-3,4]);for(let e=0;e<7;e++)if(this.isValidCameraAngle(this.cameraAngle+t[e]+8&7)){this.cameraAngle=this.cameraAngle+t[e]+8&7;break}if(0==(1&this.cameraAngle)&&this.isValidCameraAngle(this.cameraAngle)){if(this.isValidCameraAngle(this.cameraAngle+1&7))return void(this.cameraAngle=this.cameraAngle+1&7);this.isValidCameraAngle(this.cameraAngle+7&7)&&(this.cameraAngle=this.cameraAngle+7&7)}}handleContextClick(){if(this.mouseX<this.menuX-10||this.mouseY<this.menuY-10||this.mouseX>this.menuX+this.menuWidth+10||this.mouseY>this.menuY+this.menuHeight+10)this.visibleContextMenu=!1;else{this.surface.drawBoxAlpha(this.menuX,this.menuY,this.menuWidth,this.menuHeight,13684944,160),this.surface.drawString("Choose option",this.menuX+2,this.menuY+12,1,65535);for(let t=0;t<this.menuItemsCount;t++){let e=this.menuX+2,i=this.menuY+27+15*t,s=16777215;if(this.isClicking()&&this.mouseX>e+7&&this.mouseY>i-15&&this.mouseY<=i&&this.mouseX<=e+this.menuWidth+7)return this.visibleContextMenu=!1,this.menuItemClick(this.menuIndices[t]),void(this.mouseButtonClick=0);if(this.mouseX>e-2&&this.mouseY>i-15&&this.mouseY<i&&this.mouseX<e-2+this.menuWidth&&(s=16776960,this.isClicking()))return this.visibleContextMenu=!1,this.menuItemClick(this.menuIndices[t]),void(this.mouseButtonClick=0);this.surface.drawString(this.menuItemText1[this.menuIndices[t]]+" "+this.menuItemText2[this.menuIndices[t]],e,i,1,s)}}}renderMinimapTab(t){let e=this.surface.width2-199,i=3;this.surface.drawSpriteID(e-49,i,this.spriteMedia+2),e+=40,i+=33,this.surface.drawBox(e,i,156,152,0),this.surface.setBounds(e,i,e+156,i+152);let s=192,r=255&this.cameraRotation,n=3*(this.localPlayer.currentX-6040)*s/2048|0,o=3*(this.localPlayer.currentY-6040)*s/2048|0,a=Ot.sin2048Cache[1024-4*r&1023],h=Ot.sin2048Cache[1024+(1024-4*r&1023)],l=o*a+n*h>>18;o=o*h-n*a>>18,n=l,this.surface.drawMinimapSprite(e+Math.floor(78)-n,36+Math.floor(76)+o,this.spriteMedia-1,r+64&255,s);for(let t=0;t<this.objectCount;t++){let i=3*(this.objectX[t]*this.tileSize+64-this.localPlayer.currentX)*s/2048|0,r=3*(this.objectY[t]*this.tileSize+64-this.localPlayer.currentY)*s/2048|0,n=r*a+i*h>>18;r=r*h-i*a>>18,i=n,this.drawMinimapEntity(e+Math.floor(78)+i,36+Math.floor(76)-r,65535)}for(let t=0;t<this.groundItemCount;t++){let i=3*(this.groundItemX[t]*this.tileSize+64-this.localPlayer.currentX)*s/2048|0,r=3*(this.groundItemY[t]*this.tileSize+64-this.localPlayer.currentY)*s/2048|0,n=r*a+i*h>>18;r=r*h-i*a>>18,i=n,this.drawMinimapEntity(e+Math.floor(78)+i,36+Math.floor(76)-r,16711680)}for(let t=0;t<this.npcCount;t++){let i=this.npcs[t],r=3*(i.currentX-this.localPlayer.currentX)*s/2048|0,n=3*(i.currentY-this.localPlayer.currentY)*s/2048|0,o=n*a+r*h>>18;n=n*h-r*a>>18,r=o,this.drawMinimapEntity(e+Math.floor(78)+r,36+Math.floor(76)-n,16776960)}for(let t=0;t<this.playerCount;t++){let i=this.players[t],r=3*(i.currentX-this.localPlayer.currentX)*s/2048|0,n=3*(i.currentY-this.localPlayer.currentY)*s/2048|0,o=n*a+r*h>>18;n=n*h-r*a>>18,r=o;let l=16777215;for(let t=0;t<this.friendListCount;t++)i.hash===this.friendListHashes[t]&&255===this.friendListOnline[t]&&(l=65280);this.drawMinimapEntity(e+Math.floor(78)+r,36+Math.floor(76)-n,l)}if(this.surface.drawCircle(e+78,112,2,16777215,255),this.surface.drawMinimapSprite(e+19,55,this.spriteMedia+24,this.cameraRotation+128&255,128),this.surface.setBounds(0,0,this.gameWidth,this.gameHeight+12),!t)return;let u=this.mouseX-(this.surface.width2-199),c=this.mouseY-36;if(this.options.resetCompass&&1===this.mouseButtonClick&&u>42&&u<75&&c>3&&c<36)return this.cameraRotation=128,void(this.mouseButtonClick=0);if(u>=40&&c>=0&&u<196&&c<152){let t=156,e=152,i=192,s=255&this.cameraRotation,r=this.surface.width2-199;r+=40;let n=16384*(this.mouseX-(r+(t/2|0)))/(3*i)|0,o=16384*(this.mouseY-(36+(e/2|0)))/(3*i)|0,a=Ot.sin2048Cache[1024-4*s&1023],h=Ot.sin2048Cache[1024+(1024-4*s&1023)],l=o*a+n*h>>15;o=o*h-n*a>>15,n=l,n+=this.localPlayer.currentX,o=this.localPlayer.currentY-o,1===this.mouseButtonClick&&(this._walkToActionSource_from5(this.localRegionX,this.localRegionY,n/128|0,o/128|0,!1),this.mouseButtonClick=0)}}renderConfirmTrade(){this.surface.drawBox(22,36,468,16,192),this.surface.drawBoxAlpha(22,52,468,246,10000536,160),this.surface.drawStringCenter("Please confirm your trade with @yel@"+S.hashToUsername(this.tradeRecipientConfirmHash),256,48,1,16777215),this.surface.drawStringCenter("You are about to give:",139,66,1,16776960);for(let t=0;t<this.tradeConfirmItemsCount;t++){let e=Et.itemName[this.tradeConfirmItems[t]];0===Et.itemStackable[this.tradeConfirmItems[t]]&&(e=e+" x "+oe(this.tradeConfirmItemCount[t])),this.surface.drawStringCenter(e,139,78+12*t,1,16777215)}0===this.tradeConfirmItemsCount&&this.surface.drawStringCenter("Nothing!",139,78,1,16777215),this.surface.drawStringCenter("In return you will receive:",373,66,1,16776960);for(let t=0;t<this.tradeRecipientConfirmItemsCount;t++){let e=Et.itemName[this.tradeRecipientConfirmItems[t]];0===Et.itemStackable[this.tradeRecipientConfirmItems[t]]&&(e=e+" x "+oe(this.tradeRecipientConfirmItemCount[t])),this.surface.drawStringCenter(e,373,78+12*t,1,16777215)}0===this.tradeRecipientConfirmItemsCount&&this.surface.drawStringCenter("Nothing!",373,78,1,16777215),this.surface.drawStringCenter("Are you sure you want to do this?",256,236,4,65535),this.surface.drawStringCenter("There is NO WAY to reverse a trade if you change your mind.",256,251,1,16777215),this.surface.drawStringCenter("Remember that not all players are trustworthy",256,266,1,16777215),this.tradeConfirmAccepted?this.surface.drawStringCenter("Waiting for other player...",256,286,1,16776960):(this.surface.drawSpriteID(105,274,this.spriteMedia+25),this.surface.drawSpriteID(339,274,this.spriteMedia+26)),1===this.mouseButtonClick&&((this.mouseX<22||this.mouseY<36||this.mouseX>490||this.mouseY>298)&&(this.tradeConfirmVisible=!1,this.clientStream.queue(vt.DECLINE_TRADE)),this.mouseX>=105&&this.mouseX<=210&&this.mouseY>=274&&this.mouseY<=295&&(this.tradeConfirmAccepted=!0,this.clientStream.queue(vt.ACCEPT_TRADE_TWO)),this.mouseX>=339&&this.mouseX<=445&&this.mouseY>=274&&this.mouseY<=295&&(this.tradeConfirmVisible=!1,this.clientStream.queue(vt.DECLINE_TRADE)),this.mouseButtonClick=0)}mouseWithin(t,e,i,s){return this.mouseX>t&&this.mouseX<=t+i&&this.mouseY>e&&this.mouseY<=e+s}openHoveredTab(){let t=0===this.showUiTab?32:23,e=this.surface.width2-3;for(let i=1;i<=6;i++)if(e-=33,this.mouseWithin(e,3,32,t)){this.showUiTab=i;break}this.surface.width2,this.showUiTab;let i=this.inventoryMaxItemCount/5,s=4+t;if(0!==this.showUiTab)switch(this.showUiTab){case 1:(this.mouseY>34*i+s+10||this.mouseX<this.surface.width2-249)&&(this.showUiTab=0);break;case 3:case 6:(this.mouseY>316||this.mouseX<this.surface.width2-199)&&(this.showUiTab=0);break;case 2:case 4:case 5:(this.mouseY>240||this.mouseX<this.surface.width2-199)&&(this.showUiTab=0);break;default:return}}renderOptionsMenu(){if(0!==this.mouseButtonClick){for(let t=0;t<this.optionMenuCount;t++)if(!(this.mouseX>=this.surface.textWidth(this.optionMenuEntry[t],1)||this.mouseY<=12*t||this.mouseY>=12+12*t)){this.clientStream.newPacket(It.CHOOSE_OPTION),this.clientStream.putByte(t),this.clientStream.sendPacket();break}return this.mouseButtonClick=0,void(this.showOptionMenu=!1)}for(let t=0;t<this.optionMenuCount;t++){let e=65535;this.mouseX<this.surface.textWidth(this.optionMenuEntry[t],1)&&this.mouseY>12*t&&this.mouseY<12+12*t&&(e=16711680),this.surface.drawString(this.optionMenuEntry[t],6,12+12*t,1,e)}}drawNpc(t,e,i,s,r,n,o){let a=this.npcs[r],h=a.animationCurrent+(this.cameraRotation+16)/32&7,l=!1,u=h;5===u?(u=3,l=!0):6===u?(u=2,l=!0):7===u&&(u=1,l=!0);let c=3*u+this.npcWalkModel[Math.floor(a.stepCount/Et.npcWalkModel[a.typeID])%4];8===a.animationCurrent?(u=5,h=2,l=!1,t-=Et.npcCombatAnimation[a.typeID]*o/100|0,c=3*u+this.npcCombatModelArray1[((this.frameCounter/Et.npcCombatModel[a.typeID]|0)-1)%8]):9===a.animationCurrent&&(u=5,h=2,l=!0,t+=Et.npcCombatAnimation[a.typeID]*o/100|0,c=3*u+this.npcCombatModelArray2[(this.frameCounter/Et.npcCombatModel[a.typeID]|0)%8]);for(let r=0;r<12;r++){let o=this.npcAnimationArray[h][r],d=Et.npcSprite.get(a.typeID,o);if(d>=0){let r=0,o=0,h=c;if(l&&u>=1&&u<=3&&1===Et.animationHasF[d]&&(h+=15),5!==u||1===Et.animationHasA[d]){let u=h+Et.animationNumber[d];r=r*i/this.surface.spriteWidthFull[u]|0,o=o*s/this.surface.spriteHeightFull[u]|0;let c=i*this.surface.spriteWidthFull[u]/this.surface.spriteWidthFull[Et.animationNumber[d]]|0;r-=(c-i)/2|0;let m=Et.animationCharacterColour[d],p=0;1===m?(m=Et.npcColourHair[a.typeID],p=Et.npcColourSkin[a.typeID]):2===m?(m=Et.npcColourTop[a.typeID],p=Et.npcColourSkin[a.typeID]):3===m&&(m=Et.npcColorBottom[a.typeID],p=Et.npcColourSkin[a.typeID]),this.surface._spriteClipping_from9(t+r,e+o,c,s,u,m,p,n,l)}}}if(a.messageTimeout>0&&(this.receivedMessageMidPoint[this.receivedMessagesCount]=this.surface.textWidth(a.message,1)/2|0,this.receivedMessageMidPoint[this.receivedMessagesCount]>ne(3)&&(this.receivedMessageMidPoint[this.receivedMessagesCount]=ne(3)),this.receivedMessageHeight[this.receivedMessagesCount]=Math.floor(this.surface.textWidth(a.message,1)/300)*this.surface.textHeight(1),this.receivedMessageX[this.receivedMessagesCount]=t+Math.floor(i/2),this.receivedMessageY[this.receivedMessagesCount]=e,this.receivedMessages[this.receivedMessagesCount++]=a.message),(a.isFighting()||a.healthTimer.tickThreshold>0)&&a.healthTimer.tickThreshold>0){let r=t;if(8===a.animationCurrent?r-=20*o/100|0:9===a.animationCurrent&&(r+=20*o/100|0),this.healthBarX[this.healthBarCount]=r+(i/2|0),this.healthBarY[this.healthBarCount]=e,this.healthBarMissing[this.healthBarCount++]=Math.floor(30*a.healthCurrent/a.healthMax),a.healthTimer.tickCount<ne(3)){let r=t;8===a.animationCurrent?r-=10*o/100|0:9===a.animationCurrent&&(r+=10*o/100|0),this.surface.drawSpriteID(Math.floor(i/2)+r-12,Math.floor(s/2)+e-12,this.spriteMedia+12),this.surface.drawStringCenter(a.damageTaken.toString(),Math.floor(i/2)+r-1,Math.floor(s/2)+e+5,3,16777215)}}}walkToWallObject(t,e,i){0!==i?1!==i?this._walkToActionSource_from8(this.localRegionX,this.localRegionY,t,e,t,e,!0,!0):this._walkToActionSource_from8(this.localRegionX,this.localRegionY,t-1,e,t,e,!1,!0):this._walkToActionSource_from8(this.localRegionX,this.localRegionY,t,e-1,t,e,!1,!0)}async fetchDefinitions(){let t=await this.readDataFile("config"+mt.CONFIG+".jag","Entity Information",10);t?Et.loadDefinitions(t,this.members):this.exception=new rt(e,!0)}async fetchChatFilters(){let t=await this.readDataFile("filter"+mt.FILTER+".jag","Chat filters",15);t?this.chatSystem=new it(t):this.runtimeException=new rt("Error loading chat system!\n\n"+e.message,!0)}addNpc(t,e,i,s,r){this.npcsServer[t]||(this.npcsServer[t]=new ot,this.npcsServer[t].serverIndex=t);let n=this.npcsServer[t],o=!1;for(let e=0;e<this.npcCacheCount;e++)if(!this.npcsCache[e]||this.npcsCache[e].serverIndex===t){o=!0;break}if(o){n.typeID=r,n.animationNext=s;let t=n.waypointCurrent;e===n.waypointsX[t]&&i===n.waypointsY[t]||(n.waypointCurrent=t=(t+1)%10,n.waypointsX[t]=e,n.waypointsY[t]=i)}else n.serverIndex=t,n.targetWaypoint=0,n.waypointCurrent=0,n.waypointsX[0]=n.currentX=e,n.waypointsY[0]=n.currentY=i,n.typeID=r,n.animationNext=n.animationCurrent=s,n.stepCount=0;return this.npcs[this.npcCount++]=n,n}resetLoginVars(){this.welcomeState=k.WELCOME,this.gameState=A.LOGIN,this.logoutBoxFrames=0,this.systemUpdate=0}renderBank(){for(let t=0;t<3;t++)this.bankActivePage>t&&this.bankItemCount<=48*(t+1)&&(this.bankActivePage=t);(this.bankSelectedItemSlot>=this.bankItemCount||this.bankSelectedItemSlot<0)&&(this.bankSelectedItemSlot=-1),-1!==this.bankSelectedItemSlot&&this.bankItems[this.bankSelectedItemSlot]!==this.bankSelectedItem&&(this.bankSelectedItemSlot=-1,this.bankSelectedItem=-2);let t=Math.floor(this.gameWidth/2)-Math.floor(204),e=Math.floor(this.gameHeight/2)-Math.floor(167);this.surface.drawBox(t,e,408,12,192),this.surface.drawBoxAlpha(t,e+12,408,17,10000536,160),this.surface.drawBoxAlpha(t,e+29,8,204,10000536,160),this.surface.drawBoxAlpha(t+399,e+29,9,204,10000536,160),this.surface.drawBoxAlpha(t,e+233,408,47,10000536,160),this.surface.drawString("Bank",t+1,e+10,1,16777215);let i=50;if(this.bankItemCount>48){let s=16777215;0===this.bankActivePage?s=16711680:this.mouseX>t+i&&this.mouseY>=e&&this.mouseX<t+i+65&&this.mouseY<e+12&&(s=16776960,0!==this.mouseButtonClick&&(this.mouseButtonClick=0,this.bankActivePage=0)),this.surface.drawString("<page 1>",t+i,e+10,1,s),i+=65,s=16777215,1===this.bankActivePage?s=16711680:this.mouseX>t+i&&this.mouseY>=e&&this.mouseX<t+i+65&&this.mouseY<e+12&&(s=16776960,0!==this.mouseButtonClick&&(this.mouseButtonClick=0,this.bankActivePage=1)),this.surface.drawString("<page 2>",t+i,e+10,1,s),i+=65}if(this.bankItemCount>96){let s=16777215;2===this.bankActivePage?s=16711680:this.mouseX>t+i&&this.mouseY>=e&&this.mouseX<t+i+65&&this.mouseY<e+12&&(s=16776960,0!==this.mouseButtonClick&&(this.mouseButtonClick=0,this.bankActivePage=2)),this.surface.drawString("<page 3>",t+i,e+10,1,s),i+=65}if(this.bankItemCount>144){let s=16777215;3===this.bankActivePage?s=16711680:this.mouseX>t+i&&this.mouseY>=e&&this.mouseX<t+i+65&&this.mouseY<e+12&&(s=16776960,0!==this.mouseButtonClick&&(this.mouseButtonClick=0,this.bankActivePage=3)),this.surface.drawString("<page 4>",t+i,e+10,1,s),i+=65}let s=16777215;this.mouseX>t+320&&this.mouseY>=e&&this.mouseX<t+408&&this.mouseY<e+12&&(s=16711680);let r=48*this.bankActivePage;for(let i=0;i<6;i++)for(let s=0;s<8;s++){let n=t+7+49*s,o=e+28+34*i;if(this.surface.drawBoxAlpha(n,o,49,34,this.bankSelectedItemSlot===r?16711680:13684944,160),this.surface.drawBoxEdge(n,o,50,35,0),r<this.bankItemCount&&-1!==this.bankItems[r]){this.surface._spriteClipping_from9(n,o,48,32,this.spriteItem+Et.itemPicture[this.bankItems[r]],Et.itemMask[this.bankItems[r]],0,0,!1),this.surface.drawString(this.bankItemsCount[r].toString(),n+1,o+10,1,65280),this.surface.drawStringRight(this.getInventoryCount(this.bankItems[r]).toString(),n+47,o+29,1,65535);let t=this.mouseX-(Math.floor(this.gameWidth/2)-Math.floor(204)),e=this.mouseY-(Math.floor(this.gameHeight/2)-Math.floor(167));0!==this.mouseButtonClick&&0===this.dialogItemInput&&t<n&&t>n-49&&e<o+34&&e>o&&(this.mouseButtonClick=0,this.bankSelectedItem=this.bankItems[r],this.bankSelectedItemSlot=r)}r++}if(this.surface.drawStringRight("Close window",t+406,e+10,1,s),0!==this.mouseButtonClick&&(this.mouseY<12||this.mouseY>=280||this.mouseX>=475))return this.clientStream.queue(vt.CLOSE_BANK),this.bankVisible=!1,void(2!==this.dialogItemInput&&1!==this.dialogItemInput||(this.dialogItemInput=0));if(this.surface.drawString("Number in bank in green",t+7,e+24,1,65280),this.surface.drawString("Number held in blue",t+289,e+24,1,65535),this.surface.drawLineHoriz(t+5,e+256,398,0),-1===this.bankSelectedItemSlot)return void this.surface.drawStringCenter("Select an object to withdraw or deposit",t+204,e+248,3,16776960);let n=0;if(n=this.bankSelectedItemSlot<0?-1:this.bankItems[this.bankSelectedItemSlot],-1!==n){let i=this.bankItemsCount[this.bankSelectedItemSlot];if(i>0){this.surface.drawString("Withdraw "+Et.itemName[n],t+2,e+248,1,16777215),s=16777215;let r=30,o=e+238,a=o+11,h=t+230,l=h+r;if(0===this.dialogItemInput&&this.mouseX>=h&&this.mouseY>=o&&this.mouseX<l&&this.mouseY<=a&&(s=16711680,1===this.mouseButtonClick&&this.bankSelectedItemSlot>=0)){this.mouseButtonClick=0;let t=this.bankItems[this.bankSelectedItemSlot];this.clientStream.newPacket(It.BANK_WITHDRAW),this.clientStream.putShort(t),this.clientStream.putInt(1),this.clientStream.putInt(305419896),this.clientStream.sendPacket()}if(this.surface.drawString("One",h,a,1,s),h+=r,l+=r,i>=5){if(s=16777215,0===this.dialogItemInput&&this.mouseX>=h&&this.mouseY>=o&&this.mouseX<l&&this.mouseY<=a&&(s=16711680,1===this.mouseButtonClick&&this.bankSelectedItemSlot>=0)){this.mouseButtonClick=0;let t=this.bankItems[this.bankSelectedItemSlot];this.clientStream.newPacket(It.BANK_WITHDRAW),this.clientStream.putShort(t),this.clientStream.putInt(5),this.clientStream.putInt(305419896),this.clientStream.sendPacket()}this.surface.drawString("Five",h,a,1,s),h+=r,l+=r}if(i>=10){if(s=16777215,0===this.dialogItemInput&&this.mouseX>=h&&this.mouseY>=o&&this.mouseX<l&&this.mouseY<=a&&(s=16711680,1===this.mouseButtonClick&&this.bankSelectedItemSlot>=0)){this.mouseButtonClick=0;let t=this.bankItems[this.bankSelectedItemSlot];this.clientStream.newPacket(It.BANK_WITHDRAW),this.clientStream.putShort(t),this.clientStream.putInt(10),this.clientStream.putInt(305419896),this.clientStream.sendPacket()}this.surface.drawString("10",h,a,1,s),h+=r,l+=r}if(i>=50){if(s=16777215,0===this.dialogItemInput&&this.mouseX>=h&&this.mouseY>=o&&this.mouseX<l&&this.mouseY<=a&&(s=16711680,1===this.mouseButtonClick&&this.bankSelectedItemSlot>=0)){this.mouseButtonClick=0;let t=this.bankItems[this.bankSelectedItemSlot];this.clientStream.newPacket(It.BANK_WITHDRAW),this.clientStream.putShort(t),this.clientStream.putInt(50),this.clientStream.putInt(305419896),this.clientStream.sendPacket()}this.surface.drawString("50",h,a,1,s),h+=r,l+=r}if(s=16777215,0===this.dialogItemInput&&this.mouseX>=h&&this.mouseY>=o&&this.mouseX<l&&this.mouseY<=a&&(s=16711680,1===this.mouseButtonClick&&this.bankSelectedItemSlot>=0&&(this.mouseButtonClick=0,this.dialogItemInput=1)),this.surface.drawString("X",h+2,a,1,s),h+=r,l+=r,s=16777215,0===this.dialogItemInput&&this.mouseX>=h&&this.mouseY>=o&&this.mouseX<l&&this.mouseY<=a&&(s=16711680,1===this.mouseButtonClick&&this.bankSelectedItemSlot>=0)){this.mouseButtonClick=0;let t=this.bankItems[this.bankSelectedItemSlot];this.clientStream.newPacket(It.BANK_WITHDRAW),this.clientStream.putShort(t),this.clientStream.putInt(i),this.clientStream.putInt(305419896),this.clientStream.sendPacket()}this.surface.drawString("All",h,a,1,s),h+=r,l+=r}if(this.getInventoryCount(n)>0){this.surface.drawString("Deposit "+Et.itemName[n],t+2,e+273,1,16777215),s=16777215;let i=30,r=e+262,o=r+11,a=t+230,h=a+i;if(0===this.dialogItemInput&&this.mouseX>=a&&this.mouseY>=r&&this.mouseX<h&&this.mouseY<=o&&(s=16711680,1===this.mouseButtonClick&&this.bankSelectedItemSlot>=0)){this.mouseButtonClick=0;let t=this.bankItems[this.bankSelectedItemSlot];this.clientStream.newPacket(It.BANK_DEPOSIT),this.clientStream.putShort(t),this.clientStream.putInt(1),this.clientStream.putInt(2271560481),this.clientStream.sendPacket()}if(this.surface.drawString("One",a,o,1,s),a+=i,h+=i,this.getInventoryCount(n)>=5){if(s=16777215,0===this.dialogItemInput&&this.mouseX>=a&&this.mouseY>=r&&this.mouseX<h&&this.mouseY<=o&&(s=16711680,1===this.mouseButtonClick&&this.bankSelectedItemSlot>=0)){this.mouseButtonClick=0;let t=this.bankItems[this.bankSelectedItemSlot];this.clientStream.newPacket(It.BANK_DEPOSIT),this.clientStream.putShort(t),this.clientStream.putInt(5),this.clientStream.putInt(2271560481),this.clientStream.sendPacket()}this.surface.drawString("Five",a,o,1,s),a+=i,h+=i}if(this.getInventoryCount(n)>=10){if(s=16777215,0===this.dialogItemInput&&this.mouseX>=a&&this.mouseY>=r&&this.mouseX<h&&this.mouseY<=o&&(s=16711680,1===this.mouseButtonClick&&this.bankSelectedItemSlot>=0)){this.mouseButtonClick=0;let t=this.bankItems[this.bankSelectedItemSlot];this.clientStream.newPacket(It.BANK_DEPOSIT),this.clientStream.putShort(t),this.clientStream.putInt(10),this.clientStream.putInt(2271560481),this.clientStream.sendPacket()}this.surface.drawString("10",a,o,1,s),a+=i,h+=i}if(this.getInventoryCount(n)>=50){if(s=16777215,0===this.dialogItemInput&&this.mouseX>=a&&this.mouseY>=r&&this.mouseX<h&&this.mouseY<=o&&(s=16711680,1===this.mouseButtonClick&&this.bankSelectedItemSlot>=0)){this.mouseButtonClick=0;let t=this.bankItems[this.bankSelectedItemSlot];this.clientStream.newPacket(It.BANK_DEPOSIT),this.clientStream.putShort(t),this.clientStream.putInt(50),this.clientStream.putInt(2271560481),this.clientStream.sendPacket()}this.surface.drawString("50",a,o,1,s),a+=i,h+=i}if(s=16777215,0===this.dialogItemInput&&this.mouseX>=a&&this.mouseY>=r&&this.mouseX<h&&this.mouseY<=o&&(s=16711680,1===this.mouseButtonClick&&this.bankSelectedItemSlot>=0&&(this.mouseButtonClick=0,this.dialogItemInput=2)),this.surface.drawString("X",a+2,o,1,s),a+=i,h+=i,s=16777215,0===this.dialogItemInput&&this.mouseX>=a&&this.mouseY>=r&&this.mouseX<h&&this.mouseY<=o&&(s=16711680,1===this.mouseButtonClick&&this.bankSelectedItemSlot>=0)){this.mouseButtonClick=0;let t=this.bankItems[this.bankSelectedItemSlot];this.clientStream.newPacket(It.BANK_DEPOSIT),this.clientStream.putShort(t),this.clientStream.putInt(this.getInventoryCount(n)),this.clientStream.putInt(2271560481),this.clientStream.sendPacket()}this.surface.drawString("All",a,o,1,s),a+=i,h+=i}}if(2===this.dialogItemInput||1===this.dialogItemInput){let t=145;this.surface.drawBox(106,t,300,70,0),this.surface.drawBoxEdge(106,t,300,70,16777215),t+=20;let e=16777215;if(this.mouseX>236&&this.mouseX<276&&this.mouseY>193&&this.mouseY<213&&(e=16776960),this.surface.drawStringCenter("Cancel",256,208,1,e),0!==this.mouseButtonClick&&(16777215!==e||this.mouseX<106||this.mouseY<145||this.mouseX>406||this.mouseY>215||16777215!==e))return this.mouseButtonClick=0,void(this.dialogItemInput=0);if(1===this.dialogItemInput?this.surface.drawStringCenter("Enter amount to withdraw",256,t,4,16777215):2===this.dialogItemInput&&this.surface.drawStringCenter("Enter amount to deposit",256,t,4,16777215),t+=20,this.surface.drawStringCenter(this.inputTextCurrent+"*",256,t,4,16777215),this.inputTextFinal.length>0){let t=this.inputTextFinal.trim();if(this.inputTextCurrent="",this.inputTextFinal="",t.length<=0)return;let e=1===this.dialogItemInput?this.bankItemsCount[this.bankSelectedItemSlot]:this.getInventoryCount(this.bankItems[this.bankSelectedItemSlot]),i=Math.max(0,Math.min(e,Number(t)));if(1===this.dialogItemInput){let t=this.bankItems[this.bankSelectedItemSlot];this.clientStream.newPacket(It.BANK_WITHDRAW),this.clientStream.putShort(t),this.clientStream.putInt(i),this.clientStream.putInt(305419896),this.clientStream.sendPacket()}else if(2===this.dialogItemInput){let t=this.bankItems[this.bankSelectedItemSlot];this.clientStream.newPacket(It.BANK_DEPOSIT),this.clientStream.putShort(t),this.clientStream.putInt(i),this.clientStream.putInt(2271560481),this.clientStream.sendPacket()}this.dialogItemInput=0}}}renderDuelScreen(){if(0!==this.mouseButtonClick&&0===this.mouseItemTickDelta&&(this.mouseItemTickDelta=1),this.mouseItemTickDelta>0){let i=this.mouseX-22,s=this.mouseY-36;if(i>=0&&s>=0&&i<468&&s<262){if(i>216&&s>30&&i<462&&s<235){let r=((i-217|0)/49|0)+5*((s-31)/34|0);if(r>=0&&r<this.inventoryItemsCount){let i=!1,s=0,n=this.inventoryItemId[r];for(let t=0;t<this.duelOfferItemCount;t++)if(this.duelOfferItemList[t].id===n)if(0===Et.itemStackable[n])for(let e=0;e<this.mouseItemTickDelta;e++)this.duelOfferItemList[t].amount<this.inventoryItemStackCount[r]&&(this.duelOfferItemList[t].amount+=1),i=!0;else s++;if(this.getInventoryCount(n)<=s&&(i=!0),1===Et.itemSpecial[n]&&(this.showMessage("This object cannot be added to a duel offer",3),i=!0),!i&&this.duelOfferItemCount<8&&(this.duelOfferItemList=(t=this.duelOfferItemList,e={id:n,amount:1},t.concat(e)),this.duelOfferItemCount++,i=!0),i){this.clientStream.newPacket(It.DUEL_ITEM_UPDATE),this.clientStream.putByte(this.duelOfferItemCount);for(let t=0;t<this.duelOfferItemCount;t++)this.clientStream.putShort(this.duelOfferItemList[t].id),this.clientStream.putInt(this.duelOfferItemList[t].amount);this.clientStream.sendPacket(),this.duelOfferOpponentAccepted=!1,this.duelOfferAccepted=!1}}}if(i>8&&s>30&&i<205&&s<129){let t=((i-9)/49|0)+4*((s-31)/34|0);if(t>=0&&t<this.duelOfferItemCount){let e=this.duelOfferItemList[t].id;for(let i=0;i<this.mouseItemTickDelta;i++){if(!(0===Et.itemStackable[e]&&this.duelOfferItemList[t].amount>1)){this.duelOfferItemList=ae(this.duelOfferItemList,t),this.duelOfferItemCount-=1,this.mouseButtonDownTime=0;break}this.duelOfferItemList[t].amount-=1}this.clientStream.newPacket(It.DUEL_ITEM_UPDATE),this.clientStream.putByte(this.duelOfferItemCount);for(let t=0;t<this.duelOfferItemCount;t++)this.clientStream.putShort(this.duelOfferItemList[t].id),this.clientStream.putInt(this.duelOfferItemList[t].amount);this.clientStream.sendPacket(),this.duelOfferOpponentAccepted=!1,this.duelOfferAccepted=!1}}let r=!1;i>=93&&s>=221&&i<=104&&s<=232&&(this.duelSettingsRetreat=!this.duelSettingsRetreat,r=!0),i>=93&&s>=240&&i<=104&&s<=251&&(this.duelSettingsMagic=!this.duelSettingsMagic,r=!0),i>=191&&s>=221&&i<=202&&s<=232&&(this.duelSettingsPrayer=!this.duelSettingsPrayer,r=!0),i>=191&&s>=240&&i<=202&&s<=251&&(this.duelSettingsWeapons=!this.duelSettingsWeapons,r=!0),r&&(this.clientStream.newPacket(It.DUEL_SETTINGS),this.clientStream.putByte(this.duelSettingsRetreat?1:0),this.clientStream.putByte(this.duelSettingsMagic?1:0),this.clientStream.putByte(this.duelSettingsPrayer?1:0),this.clientStream.putByte(this.duelSettingsWeapons?1:0),this.clientStream.sendPacket(),this.duelOfferOpponentAccepted=!1,this.duelOfferAccepted=!1),i>=217&&s>=238&&i<=286&&s<=259&&(this.duelOfferAccepted=!0,this.clientStream.newPacket(It.DUEL_ACCEPT),this.clientStream.sendPacket()),i>=394&&s>=238&&i<463&&s<259&&(this.duelConfigVisible=!1,this.clientStream.queue(vt.DECLINE_DUEL))}else 0!==this.mouseButtonClick&&(this.duelConfigVisible=!1,this.clientStream.queue(vt.DECLINE_DUEL));this.mouseButtonClick=0,this.mouseItemTickDelta=0}var t,e;if(!this.duelConfigVisible)return;this.surface.drawBox(22,36,468,12,13175581),this.surface.drawBoxAlpha(22,48,468,18,10000536,160),this.surface.drawBoxAlpha(22,66,8,248,10000536,160),this.surface.drawBoxAlpha(227,66,11,248,10000536,160),this.surface.drawBoxAlpha(484,66,6,248,10000536,160),this.surface.drawBoxAlpha(30,135,197,24,10000536,160),this.surface.drawBoxAlpha(30,228,197,23,10000536,160),this.surface.drawBoxAlpha(30,294,197,20,10000536,160),this.surface.drawBoxAlpha(238,271,246,43,10000536,160),this.surface.drawBoxAlpha(30,66,197,69,13684944,160),this.surface.drawBoxAlpha(30,159,197,69,13684944,160),this.surface.drawBoxAlpha(30,251,197,43,13684944,160),this.surface.drawBoxAlpha(238,66,246,205,13684944,160);for(let t=0;t<3;t++)this.surface.drawLineHoriz(30,66+34*t,197,0);for(let t=0;t<3;t++)this.surface.drawLineHoriz(30,159+34*t,197,0);for(let t=0;t<7;t++)this.surface.drawLineHoriz(238,66+34*t,246,0);for(let t=0;t<6;t++)t<5&&this.surface.drawLineVert(30+49*t,66,69,0),t<5&&this.surface.drawLineVert(30+49*t,159,69,0),this.surface.drawLineVert(238+49*t,66,205,0);this.surface.drawLineHoriz(30,251,197,0),this.surface.drawLineHoriz(30,293,197,0),this.surface.drawLineVert(30,251,43,0),this.surface.drawLineVert(226,251,43,0),this.surface.drawString("Preparing to duel with: "+this.duelOpponentName,23,46,1,16777215),this.surface.drawString("Your Stake",31,63,4,16777215),this.surface.drawString("Opponent's Stake",31,156,4,16777215),this.surface.drawString("Duel Options",31,248,4,16777215),this.surface.drawString("Your Inventory",238,63,4,16777215),this.surface.drawString("No retreating",31,267,3,16776960),this.surface.drawString("No magic",31,286,3,16776960),this.surface.drawString("No prayer",132,267,3,16776960),this.surface.drawString("No weapons",132,286,3,16776960),this.surface.drawBoxEdge(115,257,11,11,16776960),this.duelSettingsRetreat&&this.surface.drawBox(117,259,7,7,16776960),this.surface.drawBoxEdge(115,276,11,11,16776960),this.duelSettingsMagic&&this.surface.drawBox(117,278,7,7,16776960),this.surface.drawBoxEdge(213,257,11,11,16776960),this.duelSettingsPrayer&&this.surface.drawBox(215,259,7,7,16776960),this.surface.drawBoxEdge(213,276,11,11,16776960),this.duelSettingsWeapons&&this.surface.drawBox(215,278,7,7,16776960),this.duelOfferAccepted||this.surface.drawSpriteID(239,274,this.spriteMedia+25),this.surface.drawSpriteID(416,274,this.spriteMedia+26),this.duelOfferOpponentAccepted&&(this.surface.drawStringCenter("Other player",363,282,1,16777215),this.surface.drawStringCenter("has accepted",363,292,1,16777215)),this.duelOfferAccepted&&(this.surface.drawStringCenter("Waiting for",274,282,1,16777215),this.surface.drawStringCenter("other player",274,292,1,16777215));for(let t=0;t<this.inventoryItemsCount;t++){let e=239+t%5*49,i=67+34*(t/5|0);this.surface._spriteClipping_from9(e,i,48,32,this.spriteItem+Et.itemPicture[this.inventoryItemId[t]],Et.itemMask[this.inventoryItemId[t]],0,0,!1),0===Et.itemStackable[this.inventoryItemId[t]]&&this.surface.drawString(this.inventoryItemStackCount[t].toString(),e+1,i+10,1,16776960)}for(let t=0;t<this.duelOfferItemCount;t++){let e=31+t%4*49,i=67+34*(t/4|0);this.surface._spriteClipping_from9(e,i,48,32,this.spriteItem+Et.itemPicture[this.duelOfferItemList[t].id],Et.itemMask[this.duelOfferItemList[t].id],0,0,!1),0===Et.itemStackable[this.duelOfferItemList[t].id]&&this.surface.drawString(this.duelOfferItemList[t].amount.toString(),e+1,i+10,1,16776960),this.mouseX>e&&this.mouseX<e+48&&this.mouseY>i&&this.mouseY<i+32&&this.surface.drawString(Et.itemName[this.duelOfferItemList[t].id]+": @whi@"+Et.itemDescription[this.duelOfferItemList[t].id],30,309,1,16776960)}for(let t=0;t<this.duelOfferOpponentItemCount;t++){let e=31+t%4*49,i=160+34*(t/4|0);this.surface._spriteClipping_from9(e,i,48,32,this.spriteItem+Et.itemPicture[this.duelOfferOpponentItemList[t].id],Et.itemMask[this.duelOfferOpponentItemList[t].id],0,0,!1),0===Et.itemStackable[this.duelOfferOpponentItemList[t].id]&&this.surface.drawString(this.duelOfferOpponentItemList[t].amount.toString(),e+1,i+10,1,16776960),this.mouseX>e&&this.mouseX<e+48&&this.mouseY>i&&this.mouseY<i+32&&this.surface.drawString(Et.itemName[this.duelOfferOpponentItemList[t].id]+": @whi@"+Et.itemDescription[this.duelOfferOpponentItemList[t].id],30,309,1,16776960)}}loadNextRegion(t,e){if(0!==this.deathScreenTimeout)return this.world.playerAlive=!1,!1;if(this.loadingArea=!1,t+=this.planeWidth,e+=this.planeHeight,this.lastHeightOffset===this.planeIndex&&t>this.localLowerX&&t<this.localUpperX&&e>this.localLowerY&&e<this.localUpperY)return this.world.playerAlive=!0,!1;this.surface.drawStringCenter("Loading... Please wait",256,192,1,16777215),this.drawChatMessageTabs(),this.surface.draw(this.graphics,0,0);let i=this.regionX,s=this.regionY,r=(t+24)/48|0,n=(e+24)/48|0;this.lastHeightOffset=this.planeIndex,this.regionX=48*r-48,this.regionY=48*n-48,this.localLowerX=48*r-32,this.localLowerY=48*n-32,this.localUpperX=48*r+32,this.localUpperY=48*n+32,this.world._loadSection_from3(t,e,this.lastHeightOffset),this.regionX-=this.planeWidth,this.regionY-=this.planeHeight;let o=this.regionX-i,a=this.regionY-s;for(let t=0;t<this.objectCount;t++)try{this.objectX[t]-=o,this.objectY[t]-=a;let e=this.objectX[t],i=this.objectY[t],s=this.objectId[t],r=this.objectDirection[t],n=0===r||4===r?Et.objectWidth[s]:Et.objectHeight[s],h=0===r||4===r?Et.objectHeight[s]:Et.objectWidth[s],l=Math.floor((e+e+n)*this.tileSize/2),u=Math.floor((i+i+h)*this.tileSize/2);if(e>=0&&i>=0&&e<96&&i<96){let r=this.objectModel[t];this.scene.addModel(r),r.place(l,-this.world.getElevation(l,u),u),this.world.removeObject2(e,i,s),74===s&&r.translate(0,-480,0)}}catch(t){console.log("Scenary Error: "+t.message),console.error(t)}for(let t=0;t<this.wallObjectCount;t++)try{this.wallObjectX[t]-=o,this.wallObjectY[t]-=a;let e=this.wallObjectX[t],i=this.wallObjectY[t],s=this.wallObjectId[t],r=this.wallObjectDirection[t];this.world._setObjectAdjacency_from4(e,i,r,s),this.wallObjectModel[t]=this.createBoundaryModel(e,i,r,s,t)}catch(t){console.log("Boundary Error: "+t.message),console.error(t)}for(let t=0;t<this.groundItemCount;t++)this.groundItemX[t]-=o,this.groundItemY[t]-=a;for(let t=0;t<this.playerCount;t++){let e=this.players[t];e.currentX-=o*this.tileSize,e.currentY-=a*this.tileSize;for(let t=0;t<=e.waypointCurrent;t++)e.waypointsX[t]-=o*this.tileSize,e.waypointsY[t]-=a*this.tileSize}for(let t=0;t<this.npcCount;t++){let e=this.npcs[t];e.currentX-=o*this.tileSize,e.currentY-=a*this.tileSize;for(let t=0;t<=e.waypointCurrent;t++)e.waypointsX[t]-=o*this.tileSize,e.waypointsY[t]-=a*this.tileSize}return this.world.playerAlive=!0,!0}drawPlayer(t,e,i,s,r,n,o){let a=this.players[r];if(255===a.colourBottom)return;let h=a.animationCurrent+(this.cameraRotation+16)/32&7,l=!1,u=h;5===u?(u=3,l=!0):6===u?(u=2,l=!0):7===u&&(u=1,l=!0);let c=3*u+this.npcWalkModel[Math.floor(a.stepCount/6)%4];8===a.animationCurrent?(u=5,h=2,l=!1,t-=Math.floor(5*o/100),c=3*u+this.npcCombatModelArray1[Math.floor(this.frameCounter/5)%8]):9===a.animationCurrent&&(u=5,h=2,l=!0,t+=Math.floor(5*o/100),c=3*u+this.npcCombatModelArray2[Math.floor(this.frameCounter/6)%8]);for(let r=0;r<12;r++){let o=this.npcAnimationArray[h][r],d=a.equippedItem[o]-1;if(d>=0){let r=0,h=0,m=c;if(l&&u>=1&&u<=3&&(1===Et.animationHasF[d]?m+=15:4===o&&1===u?(r=-22,h=-3,m=3*u+this.npcWalkModel[(2+Math.floor(a.stepCount/6))%4]):4===o&&2===u?(r=0,h=-8,m=3*u+this.npcWalkModel[(2+Math.floor(a.stepCount/6))%4]):4===o&&3===u?(r=26,h=-5,m=3*u+this.npcWalkModel[(2+Math.floor(a.stepCount/6))%4]):3===o&&1===u?(r=22,h=3,m=3*u+this.npcWalkModel[(2+Math.floor(a.stepCount/6))%4]):3===o&&2===u?(r=0,h=8,m=3*u+this.npcWalkModel[(2+Math.floor(a.stepCount/6))%4]):3===o&&3===u&&(r=-26,h=5,m=3*u+this.npcWalkModel[(2+Math.floor(a.stepCount/6))%4])),5!==u||1===Et.animationHasA[d]){let o=m+Et.animationNumber[d];r=Math.floor(r*i/this.surface.spriteWidthFull[o]),h=Math.floor(h*s/this.surface.spriteHeightFull[o]);let u=Math.floor(i*this.surface.spriteWidthFull[o]/this.surface.spriteWidthFull[Et.animationNumber[d]]);r-=Math.floor((u-i)/2);let c=Et.animationCharacterColour[d],p=this.characterSkinColours[a.colourSkin];1===c?c=this.characterHairColours[a.colourHair]:c>=2&&c<=3&&(c=this.characterTopBottomColours[2===c?a.colourTop:a.colourBottom]),this.surface._spriteClipping_from9(t+r,e+h,u,s,o,c,p,n,l)}}}if(a.messageTimeout>0&&(this.receivedMessageMidPoint[this.receivedMessagesCount]=Math.floor(this.surface.textWidth(a.message,1)/2),this.receivedMessageMidPoint[this.receivedMessagesCount]>ne(3)&&(this.receivedMessageMidPoint[this.receivedMessagesCount]=ne(3)),this.receivedMessageHeight[this.receivedMessagesCount]=Math.floor(this.surface.textWidth(a.message,1)/300)*this.surface.textHeight(1),this.receivedMessageX[this.receivedMessagesCount]=t+Math.floor(i/2),this.receivedMessageY[this.receivedMessagesCount]=e,this.receivedMessages[this.receivedMessagesCount++]=a.message),a.bubble){let s=Math.floor(39*o/100),r=Math.floor(27*o/100);this.surface.drawActionBubble(t+Math.floor(i/2)-Math.floor(s/2),e-r,s,r,this.spriteMedia+9,85);let n=Math.floor(36*o/100),h=Math.floor(24*o/100);this.surface._spriteClipping_from9(t+Math.floor(i/2)-Math.floor(n/2),e-r+Math.floor(r/2)-Math.floor(h/2),n,h,Et.itemPicture[a.bubble.id]+this.spriteItem,Et.itemMask[a.bubble.id],0,0,!1)}if((a.isFighting()||a.healthTimer.tickThreshold>0)&&a.healthTimer.tickThreshold>0){let r=t;if(8===a.animationCurrent?r-=Math.floor(20*o/100):9===a.animationCurrent&&(r+=Math.floor(20*o/100)),this.healthBarX[this.healthBarCount]=r+(i>>1),this.healthBarY[this.healthBarCount]=e,this.healthBarMissing[this.healthBarCount++]=Math.floor(30*a.healthCurrent/a.healthMax),a.healthTimer.tickCount<ne(3)){let r=t;8===a.animationCurrent?r-=Math.floor(10*o/100):9===a.animationCurrent&&(r+=Math.floor(10*o/100)),this.surface.drawSpriteID(r+(i>>1)-12,e+(s>>1)-12,this.spriteMedia+11),this.surface.drawStringCenter(a.damageTaken.toString(),r+(i>>1)-1,e+(s>>1)+5,3,16777215)}}if(1===a.skullVisible&&!a.bubble){let s=n+t+Math.floor(i/2);8===a.animationCurrent?s-=Math.floor(20*o/100):9===a.animationCurrent&&(s+=Math.floor(20*o/100));Math.floor(16*o/100);let r=Math.floor(16*o/100|0),h=r>>1;this.surface._spriteClipping_from5(s-h,e-h-Math.floor(r/2.5),r,r,this.spriteMedia+13)}}async loadMedia(){let t=await this.readDataFile("media"+mt.MEDIA+".jag","2d graphics",20);if(!t)return void(this.runtimeException=new rt("Error loading media sprites!\n\n"+e.message,!0));let i=S.loadData("index.dat",0,t);this.surface.parseSprite(this.spriteMedia,S.loadData("inv1.dat",0,t),i,1),this.surface.parseSprite(this.spriteMedia+1,S.loadData("inv2.dat",0,t),i,6),this.surface.parseSprite(this.spriteMedia+9,S.loadData("bubble.dat",0,t),i,1),this.surface.parseSprite(this.spriteMedia+10,S.loadData("runescape.dat",0,t),i,1),this.surface.parseSprite(this.spriteMedia+11,S.loadData("splat.dat",0,t),i,3),this.surface.parseSprite(this.spriteMedia+14,S.loadData("icon.dat",0,t),i,8),this.surface.parseSprite(this.spriteMedia+22,S.loadData("hbar.dat",0,t),i,1),this.surface.parseSprite(this.spriteMedia+23,S.loadData("hbar2.dat",0,t),i,1),this.surface.parseSprite(this.spriteMedia+24,S.loadData("compass.dat",0,t),i,1),this.surface.parseSprite(this.spriteMedia+25,S.loadData("buttons.dat",0,t),i,2),this.surface.parseSprite(this.spriteUtil,S.loadData("scrollbar.dat",0,t),i,2),this.surface.parseSprite(this.spriteUtil+2,S.loadData("corners.dat",0,t),i,4),this.surface.parseSprite(this.spriteUtil+6,S.loadData("arrows.dat",0,t),i,2),this.surface.parseSprite(this.spriteProjectile,S.loadData("projectile.dat",0,t),i,Et.projectileSprite);let s=Et.itemSpriteCount;for(let e=1;s>0;e++){let r=s;s-=30,r>30&&(r=30),this.surface.parseSprite(this.spriteItem+30*(e-1),S.loadData("objects"+e+".dat",0,t),i,r)}this.surface.loadSprite(this.spriteMedia),this.surface.loadSprite(this.spriteMedia+9);for(let t=11;t<=26;t++)this.surface.loadSprite(this.spriteMedia+t);for(let t=0;t<Et.projectileSprite;t++)this.surface.loadSprite(this.spriteProjectile+t);for(let t=0;t<Et.itemSpriteCount;t++)this.surface.loadSprite(this.spriteItem+t)}drawChatMessageTabs(){this.surface.drawSpriteID(0,this.gameHeight-4,this.spriteMedia+23),this.surface.drawStringCenter("All messages",54,this.gameHeight+6,0,this.messageTabFlashAll%30>15?16724530:0===this.messageTabSelected?16762930:13158655),this.surface.drawStringCenter("Chat history",155,this.gameHeight+6,0,this.messageTabFlashHistory%30>15?16724530:1===this.messageTabSelected?16762930:13158655),this.surface.drawStringCenter("Quest history",255,this.gameHeight+6,0,this.messageTabFlashQuest%30>15?16724530:2===this.messageTabSelected?16762930:13158655),this.surface.drawStringCenter("Private history",355,this.gameHeight+6,0,this.messageTabFlashPrivate%30>15?16724530:3===this.messageTabSelected?16762930:13158655),this.surface.drawStringCenter("Report abuse",457,this.gameHeight+6,0,16777215)}async startGame(){if(this.port=this.port||43595,await this.fetchDefinitions(),await this.fetchChatFilters(),this.runtimeException)return;this.spriteMedia=2e3,this.spriteUtil=this.spriteMedia+100,this.spriteItem=this.spriteUtil+50,this.spriteLogo=this.spriteItem+1e3,this.spriteProjectile=this.spriteLogo+10,this.spriteTexture=this.spriteProjectile+50,this.spriteTextureWorld=this.spriteTexture+10,this.surface=new ee(this.gameWidth,this.gameHeight+12,4e3,this),this.surface.mudclientref=this,this.surface.setBounds(0,0,this.gameWidth,this.gameHeight+12),qt.drawBackgroundArrow=!1,qt.spriteStart=this.spriteUtil,this.panelMagic=new qt(this.surface,5);let t=this.surface.width2-199;this.controlListMagic=this.panelMagic.addTextListInteractive(t,60,196,90,1,500,!0),this.panelSocialList=new qt(this.surface,5),this.controlListSocialPlayers=this.panelSocialList.addTextListInteractive(t,76,196,126,1,500,!0),this.panelQuestList=new qt(this.surface,5),this.controlListQuest=this.panelQuestList.addTextListInteractive(t,60,196,251,1,500,!0),await this.loadMedia(),this.runtimeException||(await this.loadEntities(),this.runtimeException||(this.scene=new Ot(this.surface,15e3,15e3,1e3),this.scene.view=Yt._from2(1e6,1e4),this.scene.setBounds(Math.floor(this.gameWidth/2),Math.floor(this.gameHeight/2),Math.floor(this.gameWidth/2),Math.floor(this.gameHeight/2),this.gameWidth,9),this.scene.clipFar3d=2400,this.scene.clipFar2d=2400,this.scene.fogZFalloff=1,this.scene.fogZDistance=2300,this.scene.setLightSourceCoords(-50,-10,-50),this.world=new ie(this.scene,this.surface),this.world.baseMediaSprite=this.spriteMedia,await this.loadTextures(),this.runtimeException||(await this.loadModels(),this.runtimeException||(await this.loadMaps(),this.runtimeException||(await this.loadSounds(),this.runtimeException||(this.updateLoadingStatus(95,"Creating interfaces..."),this.createMessageTabPanel(),this.createLoginPanels(),this.createAppearancePanel(),this.updateLoadingStatus(100,"Starting game..."),this.setTargetFps(50),this.resetGameState(),this.renderLoginScreenViewports()))))))}renderMagicTab(t){let e=this.surface.width2-199;this.surface.drawSpriteID(e-49,3,this.spriteMedia+4);let i=0,s=i=dt.rgbToLong(160,160,160);if(0===this.tabMagicPrayer?s=dt.rgbToLong(220,220,220):i=dt.rgbToLong(220,220,220),this.surface.drawBoxAlpha(e,36,98,24,s,128),this.surface.drawBoxAlpha(e+98,36,98,24,i,128),this.surface.drawBoxAlpha(e,60,196,90,dt.rgbToLong(220,220,220),128),this.surface.drawBoxAlpha(e,150,196,68,dt.rgbToLong(160,160,160),128),this.surface.drawLineHoriz(e,60,196,0),this.surface.drawLineVert(e+98,36,24,0),this.surface.drawLineHoriz(e,149,196,0),this.surface.drawStringCenter("Magic",e+49,52,4,0),this.surface.drawStringCenter("Prayers",e+49+98,52,4,0),0===this.tabMagicPrayer){this.panelMagic.clearList(this.controlListMagic);let t=0;for(let e=0;e<Et.spellCount;e++){let i="@yel@";for(let t=0;t<Et.spellRunesRequired[e];t++){let s=Et.spellRunesId[e][t];if(!this.hasInventoryItems(s,Et.spellRunesCount[e][t])){i="@whi@";break}}let s=this.playerStatCurrent[6];Et.spellLevel[e]>s&&(i="@bla@"),this.panelMagic.addListEntry(this.controlListMagic,t++,i+"Level "+Et.spellLevel[e]+": "+Et.spellName[e])}this.panelMagic.render();let i=this.panelMagic.getListEntryIndex(this.controlListMagic);if(-1!==i){this.surface.drawString("Level "+Et.spellLevel[i]+": "+Et.spellName[i],e+2,160,1,16776960),this.surface.drawString(Et.spellDescription[i],e+2,172,0,16777215);for(let t=0;t<Et.spellRunesRequired[i];t++){let s=Et.spellRunesId[i][t];this.surface.drawSpriteID(e+2+44*t,186,this.spriteItem+Et.itemPicture[s]);let r=this.getInventoryCount(s),n=Et.spellRunesCount[i][t],o="@red@";this.hasInventoryItems(s,n)&&(o="@gre@"),this.surface.drawString(o+r+"/"+n,e+2+44*t,186,1,16777215)}}else this.surface.drawString("Point at a spell for a description",e+2,160,1,0)}if(1===this.tabMagicPrayer){this.panelMagic.clearList(this.controlListMagic);let t=0;for(let e=0;e<Et.prayerCount;e++){let i="@whi@";Et.prayerLevel[e]>this.playerStatBase[5]&&(i="@bla@"),this.prayers[e]&&(i="@gre@"),this.panelMagic.addListEntry(this.controlListMagic,t++,i+"Level "+Et.prayerLevel[e]+": "+Et.prayerName[e])}this.panelMagic.render();let i=this.panelMagic.getListEntryIndex(this.controlListMagic);-1!==i?(this.surface.drawStringCenter("Level "+Et.prayerLevel[i]+": "+Et.prayerName[i],e+98,166,1,16776960),this.surface.drawStringCenter(Et.prayerDescription[i],e+98,181,0,16777215),this.surface.drawStringCenter("Drain rate: "+Et.prayerDrain[i],e+98,196,1,0)):this.surface.drawString("Point at a prayer for a description",e+2,160,1,0)}if(!t)return;let r=this.mouseX-(this.surface.width2-199),n=this.mouseY-36;if(r>=0&&n>=0&&r<196&&n<182){if(this.panelMagic.handleMouse(r+(this.surface.width2-199),n+36,this.lastMouseButtonDown,this.mouseButtonDown,this.mouseScrollDelta),n<=24&&1===this.mouseButtonClick&&(r<98&&1===this.tabMagicPrayer?(this.tabMagicPrayer=0,this.panelMagic.resetListProps(this.controlListMagic)):r>98&&0===this.tabMagicPrayer&&(this.tabMagicPrayer=1,this.panelMagic.resetListProps(this.controlListMagic))),1===this.mouseButtonClick&&0===this.tabMagicPrayer){let t=this.panelMagic.getListEntryIndex(this.controlListMagic);if(-1!==t){let e=this.playerStatCurrent[6];if(Et.spellLevel[t]>e)this.showMessage("Your magic ability is not high enough for this spell",3);else{let e=0;for(e=0;e<Et.spellRunesRequired[t];e++){let i=Et.spellRunesId[t][e];if(!this.hasInventoryItems(i,Et.spellRunesCount[t][e])){this.showMessage("You don't have all the reagents you need for this spell",3),e=-1;break}}e===Et.spellRunesRequired[t]&&(this.selectedSpell=t,this.selectedItemInventoryIndex=-1)}}}if(1===this.mouseButtonClick&&1===this.tabMagicPrayer){let t=this.panelMagic.getListEntryIndex(this.controlListMagic);if(-1!==t){let e=this.playerStatBase[5];Et.prayerLevel[t]>e?this.showMessage("Your prayer ability is not high enough for this prayer",3):0===this.playerStatCurrent[5]?this.showMessage("You have run out of prayer points. Return to a church to recharge",3):this.prayers[t]?(this.clientStream.newPacket(It.PRAYER_OFF),this.clientStream.putByte(t),this.clientStream.sendPacket(),this.prayers[t]=!1,this.playSoundFile("prayeroff")):(this.clientStream.newPacket(It.PRAYER_ON),this.clientStream.putByte(t),this.clientStream.sendPacket(),this.prayers[t]=!0,this.playSoundFile("prayeron"))}}this.mouseButtonClick=0}}renderShop(){if(0!==this.mouseButtonClick){this.mouseButtonClick=0;let t=this.mouseX-52,e=this.mouseY-44;if(!(t>=0&&e>=12&&t<408&&e<246))return this.clientStream.newPacket(It.SHOP_CLOSE),this.clientStream.sendPacket(),void(this.shopVisible=!1);{let i=0;for(let s=0;s<5;s++)for(let r=0;r<8;r++){let n=7+49*r,o=28+34*s;t>n&&t<n+49&&e>o&&e<o+34&&-1!==this.shopItem[i]&&(this.shopSelectedItemIndex=i,this.shopSelectedItemType=this.shopItem[i]),i++}if(this.shopSelectedItemIndex>=0){let i=this.shopItem[this.shopSelectedItemIndex];if(-1!==i){if(this.shopItemCount[this.shopSelectedItemIndex]>0&&t>298&&e>=204&&t<408&&e<=215){let t=this.shopBuyPriceMod+this.shopItemPrice[this.shopSelectedItemIndex];t<10&&(t=10);let e=t*Et.itemBasePrice[i]/100|0;this.clientStream.newPacket(It.SHOP_BUY),this.clientStream.putShort(this.shopItem[this.shopSelectedItemIndex]),this.clientStream.putInt(e),this.clientStream.sendPacket()}if(this.getInventoryCount(i)>0&&t>2&&e>=229&&t<112&&e<=240){let t=this.shopSellPriceMod+this.shopItemPrice[this.shopSelectedItemIndex];t<10&&(t=10);let e=t*Et.itemBasePrice[i]/100|0;this.clientStream.newPacket(It.SHOP_SELL),this.clientStream.putShort(this.shopItem[this.shopSelectedItemIndex]),this.clientStream.putInt(e),this.clientStream.sendPacket()}}}}}this.surface.drawBox(52,44,408,12,192),this.surface.drawBoxAlpha(52,56,408,17,10000536,160),this.surface.drawBoxAlpha(52,73,8,170,10000536,160),this.surface.drawBoxAlpha(451,73,9,170,10000536,160),this.surface.drawBoxAlpha(52,243,408,47,10000536,160),this.surface.drawString("Buying and selling items",53,54,1,16777215);let t=16777215;this.mouseX>372&&this.mouseY>=44&&this.mouseX<460&&this.mouseY<56&&(t=16711680),this.surface.drawStringRight("Close window",458,54,1,t),this.surface.drawString("Shops stock in green",54,68,1,65280),this.surface.drawString("Number you own in blue",187,68,1,65535),this.surface.drawString("Your money: "+this.getInventoryCount(10)+"gp",332,68,1,16776960);let e=0;for(let t=0;t<5;t++)for(let i=0;i<8;i++){let s=59+49*i,r=72+34*t;this.shopSelectedItemIndex===e?this.surface.drawBoxAlpha(s,r,49,34,16711680,160):this.surface.drawBoxAlpha(s,r,49,34,13684944,160),this.surface.drawBoxEdge(s,r,50,35,0),-1!==this.shopItem[e]&&(this.surface._spriteClipping_from9(s,r,48,32,this.spriteItem+Et.itemPicture[this.shopItem[e]],Et.itemMask[this.shopItem[e]],0,0,!1),this.surface.drawString(this.shopItemCount[e].toString(),s+1,r+10,1,65280),this.surface.drawStringRight(this.getInventoryCount(this.shopItem[e]).toString(),s+47,r+10,1,65535)),e++}if(this.surface.drawLineHoriz(57,266,398,0),-1===this.shopSelectedItemIndex)return void this.surface.drawStringCenter("Select an object to buy or sell",256,258,3,16776960);let i=this.shopItem[this.shopSelectedItemIndex];if(-1!==i){if(this.shopItemCount[this.shopSelectedItemIndex]>0){let e=this.shopBuyPriceMod+this.shopItemPrice[this.shopSelectedItemIndex];e<10&&(e=10);let s=e*Et.itemBasePrice[i]/100|0;this.surface.drawString("Buy a new "+Et.itemName[i]+" for "+s+"gp",54,258,1,16776960),t=16777215,this.mouseX>350&&this.mouseY>=248&&this.mouseX<460&&this.mouseY<=259&&(t=16711680),this.surface.drawStringRight("Click here to buy",457,258,3,t)}else this.surface.drawStringCenter("This item is not currently available to buy",256,258,3,16776960);if(this.getInventoryCount(i)>0){let e=this.shopSellPriceMod+this.shopItemPrice[this.shopSelectedItemIndex];e<10&&(e=10);let s=e*Et.itemBasePrice[i]/100|0;return this.surface.drawStringRight("Sell your "+Et.itemName[i]+" for "+s+"gp",457,283,1,16776960),t=16777215,this.mouseX>54&&this.mouseY>=273&&this.mouseX<164&&this.mouseY<=284&&(t=16711680),void this.surface.drawString("Click here to sell",54,283,3,t)}this.surface.drawStringCenter("You do not have any of this item to sell",256,283,3,16776960)}}hasInventoryItems(t,e){return!(31!==t||!(this.isItemEquipped(197)||this.isItemEquipped(615)||this.isItemEquipped(682)))||(!(32!==t||!(this.isItemEquipped(102)||this.isItemEquipped(616)||this.isItemEquipped(683)))||(!(33!==t||!(this.isItemEquipped(101)||this.isItemEquipped(617)||this.isItemEquipped(684)))||(!(34!==t||!(this.isItemEquipped(103)||this.isItemEquipped(618)||this.isItemEquipped(685)))||this.getInventoryCount(t)>=e)))}getHostnameIP(t){return S.getIntegerAsString(t)}cantLogout(){this.logoutBoxFrames=0,this.showMessage("@cya@Sorry, you can't logout at the moment",3)}drawGame(){if(0!==this.deathScreenTimeout)return this.surface.fadeToBlack(),this.surface.drawStringCenter("Oh dear! You are dead...",this.gameWidth/2|0,this.gameHeight/2|0,7,16711680),this.drawChatMessageTabs(),void this.surface.draw(this.graphics,0,0);if(this.showAppearanceChange)return void this.drawAppearancePanelCharacterSprites();if(this.isSleeping)return this.surface.fadeToBlack(),Math.random()<.15&&this.surface.drawStringCenter("ZZZ",80*Math.random()|0,334*Math.random()|0,5,16777215*Math.random()|0),Math.random()<.15&&this.surface.drawStringCenter("ZZZ",512-(80*Math.random()|0),334*Math.random()|0,5,16777215*Math.random()|0),this.surface.drawBox((this.gameWidth2/2|0)-100,160,200,40,0),this.surface.drawStringCenter("You are sleeping",this.gameWidth/2|0,50,7,16776960),this.surface.drawStringCenter("Fatigue: "+(100*this.fatigueSleeping/750|0)+"%",this.gameWidth/2|0,90,7,16776960),this.surface.drawStringCenter("When you want to wake up just use your",this.gameWidth/2|0,140,5,16777215),this.surface.drawStringCenter("keyboard to type the word in the box below",this.gameWidth/2|0,160,5,16777215),this.surface.drawStringCenter(this.inputTextCurrent+"*",this.gameWidth/2|0,180,5,65535),this.sleepingStatusText?this.surface.drawStringCenter(this.sleepingStatusText,this.gameWidth/2|0,260,5,16711680):this.surface.drawSpriteID((this.gameWidth/2|0)-127,230,this.spriteTexture+1),this.surface.drawBoxEdge((this.gameWidth/2|0)-128,229,257,42,16777215),this.drawChatMessageTabs(),this.surface.drawStringCenter("If you can't read the word",this.gameWidth/2|0,290,1,16777215),this.surface.drawStringCenter("@yel@click here@whi@ to get a different one",this.gameWidth/2|0,305,1,16777215),void this.surface.draw(this.graphics,0,0);if(!this.world.playerAlive)return;for(let t=0;t<64;t++)this.scene.removeModel(this.world.roofModels[this.lastHeightOffset][t]),0===this.lastHeightOffset&&(this.scene.removeModel(this.world.wallModels[1][t]),this.scene.removeModel(this.world.roofModels[1][t]),this.scene.removeModel(this.world.wallModels[2][t]),this.scene.removeModel(this.world.roofModels[2][t])),this.options.showRoofs&&(this.fogOfWar=!0,0===this.lastHeightOffset&&0==(128&this.world.objectAdjacency.get(Math.floor(this.localPlayer.currentX/128),Math.floor(this.localPlayer.currentY/128)))&&(this.scene.addModel(this.world.roofModels[this.lastHeightOffset][t]),0===this.lastHeightOffset&&(this.scene.addModel(this.world.wallModels[1][t]),this.scene.addModel(this.world.roofModels[1][t]),this.scene.addModel(this.world.wallModels[2][t]),this.scene.addModel(this.world.roofModels[2][t])),this.fogOfWar=!1));if(this.objectAnimationNumberFireLightningSpell!==this.lastObjectAnimationNumberFireLightningSpell){this.lastObjectAnimationNumberFireLightningSpell=this.objectAnimationNumberFireLightningSpell;for(let t=0;t<this.objectCount;t++)97===this.objectId[t]&&this.updateObjectAnimation(t,"firea"+(this.objectAnimationNumberFireLightningSpell+1)),274===this.objectId[t]&&this.updateObjectAnimation(t,"fireplacea"+(this.objectAnimationNumberFireLightningSpell+1)),1031===this.objectId[t]&&this.updateObjectAnimation(t,"lightning"+(this.objectAnimationNumberFireLightningSpell+1)),1036===this.objectId[t]&&this.updateObjectAnimation(t,"firespell"+(this.objectAnimationNumberFireLightningSpell+1)),1147===this.objectId[t]&&this.updateObjectAnimation(t,"spellcharge"+(this.objectAnimationNumberFireLightningSpell+1))}if(this.objectAnimationNumberTorch!==this.lastObjectAnimationNumberTorch){this.lastObjectAnimationNumberTorch=this.objectAnimationNumberTorch;for(let t=0;t<this.objectCount;t++)51===this.objectId[t]&&this.updateObjectAnimation(t,"torcha"+(this.objectAnimationNumberTorch+1)),143===this.objectId[t]&&this.updateObjectAnimation(t,"skulltorcha"+(this.objectAnimationNumberTorch+1))}if(this.objectAnimationNumberClaw!==this.lastObjectAnimationNumberClaw){this.lastObjectAnimationNumberClaw=this.objectAnimationNumberClaw;for(let t=0;t<this.objectCount;t++)1142===this.objectId[t]&&this.updateObjectAnimation(t,"clawspell"+(this.objectAnimationNumberClaw+1))}this.scene.reduceSprites(this.spriteCount),this.spriteCount=0;for(let t=0;t<this.playerCount;t++){let e=this.players[t];if(255!==e.colourBottom){let i=-this.world.getElevation(e.currentX,e.currentY),s=this.scene.addSprite(5e3+t,e.currentX,i,e.currentY,145,220,t+1e4);this.spriteCount++,e===this.localPlayer&&this.scene.setLocalPlayer(s),8===e.animationCurrent&&this.scene.setSpriteTranslateX(s,-30),9===e.animationCurrent&&this.scene.setSpriteTranslateX(s,30)}if(e.projectileRange>0){let t=void 0;if(-1!==e.attackingNpcServerIndex?t=this.npcsServer[e.attackingNpcServerIndex]:-1!==e.attackingPlayerServerIndex&&(t=this.playerServer[e.attackingPlayerServerIndex]),t){let i=e.currentX,s=e.currentY,r=-this.world.getElevation(i,s)-110,n=t.currentX,o=t.currentY,a=-this.world.getElevation(n,o)-Math.floor(Et.npcHeight[t.typeID]/2),h=Math.floor((i*e.projectileRange+n*(this.projectileFactor-e.projectileRange))/this.projectileFactor),l=Math.floor((r*e.projectileRange+a*(this.projectileFactor-e.projectileRange))/this.projectileFactor),u=Math.floor((s*e.projectileRange+o*(this.projectileFactor-e.projectileRange))/this.projectileFactor);this.scene.addSprite(this.spriteProjectile+e.incomingProjectileSprite,h,l,u,32,32,0),this.spriteCount++}}}for(let t=0;t<this.npcCount;t++){let e=this.npcs[t],i=e.currentX,s=e.currentY,r=-this.world.getElevation(i,s),n=this.scene.addSprite(2e4+t,i,r,s,Et.npcWidth[e.typeID],Et.npcHeight[e.typeID],t+3e4);this.spriteCount++,8===e.animationCurrent&&this.scene.setSpriteTranslateX(n,-30),9===e.animationCurrent&&this.scene.setSpriteTranslateX(n,30)}for(let t=0;t<this.groundItemCount;t++){let e=this.groundItemX[t]*this.tileSize+64,i=this.groundItemY[t]*this.tileSize+64;this.scene.addSprite(4e4+this.groundItemId[t],e,-this.world.getElevation(e,i)-this.groundItemZ[t],i,96,64,t+2e4),this.spriteCount++}for(let t=0;t<this.teleportBubbleCount;t++){let e=this.teleportBubbleX[t]*this.tileSize+64,i=this.teleportBubbleY[t]*this.tileSize+64,s=this.teleportBubbleType[t];0===s&&(this.scene.addSprite(5e4+t,e,-this.world.getElevation(e,i),i,128,256,t+5e4),this.spriteCount++),1===s&&(this.scene.addSprite(5e4+t,e,-this.world.getElevation(e,i),i,128,64,t+5e4),this.spriteCount++)}if(this.surface.interlace=!1,this.surface.blackScreen(),this.surface.interlace=this.interlace,3===this.lastHeightOffset){let t=40+Math.floor(3*Math.random()),e=40+Math.floor(7*Math.random());this.scene.createLightSource(t,e,-50,-10,-50)}if(this.itemsAboveHeadCount=0,this.receivedMessagesCount=0,this.healthBarCount=0,this.cameraAutoAngleDebug){if(this.optionCameraModeAuto&&!this.fogOfWar){let t=this.cameraAngle;this.autorotateCamera(),this.cameraAngle!==t&&(this.cameraAutoRotatePlayerX=this.localPlayer.currentX,this.cameraAutoRotatePlayerY=this.localPlayer.currentY)}this.scene.clipFar3d=3e3,this.scene.clipFar2d=3e3,this.scene.fogZFalloff=1,this.scene.fogZDistance=2800,this.cameraRotation=32*this.cameraAngle;let t=this.cameraAutoRotatePlayerX+this.cameraRotationX,e=this.cameraAutoRotatePlayerY+this.cameraRotationY;this.scene.setCamera(t,-this.world.getElevation(t,e),e,912,4*this.cameraRotation,0,2e3)}else{this.optionCameraModeAuto&&!this.fogOfWar&&this.autorotateCamera(),this.interlace?(this.scene.clipFar3d=2200,this.scene.clipFar2d=2200,this.scene.fogZFalloff=1,this.scene.fogZDistance=2100):(this.scene.clipFar3d=2400,this.scene.clipFar2d=2400,this.scene.fogZFalloff=1,this.scene.fogZDistance=2300),this.cameraZoom>750&&(this.scene.clipFar3d+=1400,this.scene.clipFar2d+=1400,this.scene.fogZDistance+=1400);let t=this.cameraAutoRotatePlayerX+this.cameraRotationX,e=this.cameraAutoRotatePlayerY+this.cameraRotationY;this.scene.setCamera(t,-this.world.getElevation(t,e),e,912,4*this.cameraRotation,0,2*this.cameraZoom)}if(this.scene.render(),this.renderLocalMobEffects(),this.mouseClickXStep>0?this.surface.drawSpriteID(this.mouseClickXX-8,this.mouseClickXY-8,this.spriteMedia+14+Math.floor((24-this.mouseClickXStep)/6)):this.mouseClickXStep<0&&this.surface.drawSpriteID(this.mouseClickXX-8,this.mouseClickXY-8,this.spriteMedia+18+Math.floor((24+this.mouseClickXStep)/6)),0!==this.systemUpdate){let t=Math.floor(this.systemUpdate/50),e=Math.floor(t/60);t%=60,this.surface.drawStringCenter("System update in: "+e+(t<10?":0"+t:":"+t),256,this.gameHeight-7,1,16776960)}let t=8;if(this.debug&&(this.surface.drawStringCenter(`Mouse:${this.mouseX},${this.mouseY}`,256,15,1,16776960),this.surface.drawStringCenter(`Player:${this.localPlayer.currentX+this.regionX},${this.localPlayer.currentY+this.regionY}`,256,30,1,16776960)),this.showFps&&this.fps>0&&(this.surface.drawStringCenter("FPS:"+this.fps,465,this.gameHeight-t,1,16776960),t+=20),!this.loadingArea){let e=2203-(this.localRegionY+this.planeHeight+this.regionY);if(this.localRegionX+this.planeWidth+this.regionX>=2640&&(e=-50),e>0){0===this.wildAwarenessLvl&&(this.wildAwarenessLvl=2);let i=Math.floor(e/6)+1;this.surface.drawSpriteID(453,this.gameHeight-(t+56),this.spriteMedia+13),this.surface.drawStringCenter("Wilderness",465,this.gameHeight-(t+20),1,16776960),this.surface.drawStringCenter("Level: "+i,465,this.gameHeight-(t+7),1,16776960)}else e>-10&&0===this.wildAwarenessLvl&&(this.wildAwarenessLvl=1)}if(0===this.messageTabSelected)for(let t=0;t<this.messageHistory.length;t++)this.messageHistory[t].ticks>0?this.surface.drawString(this.messageHistory[t].message,7,this.gameHeight-18-12*t,1,16776960):this.messageHistory.pop();this.panelGame[M].setVisible(this.controlTextListChat,1===this.messageTabSelected),this.panelGame[M].setVisible(this.controlTextListQuest,2===this.messageTabSelected),this.panelGame[M].setVisible(this.controlTextListPrivate,3===this.messageTabSelected),qt.textListEntryHeightMod=2,this.panelGame[M].render(),qt.textListEntryHeightMod=0,this.surface.fadeThenDrawSpriteID(this.surface.width2-3-197,3,this.spriteMedia,128),this.drawUi(),this.surface.worldVisible=!1,this.drawChatMessageTabs(),this.surface.draw(this.graphics,0,0)}async loadSounds(){try{this.soundData=await this.readDataFile("sounds"+mt.SOUNDS+".mem","Sound effects",90),this.audioPlayer=new te}catch(t){console.log("Unable to init sounds:"+t.message),console.error(t)}}isItemEquipped(t){for(let e=0;e<this.inventoryItemsCount;e++)if(this.inventoryItemId[e]===t&&this.inventoryEquipped[e])return!0;return!1}async loadEntities(){let t=void 0,i=void 0;if(t=await this.readDataFile("entity"+mt.ENTITY+".jag","people and monsters",30),!t)return void(this.runtimeException=new rt("Error loading people and monster sprites!\n\n"+e.message,!0));i=S.loadData("index.dat",0,t);let s=void 0,r=void 0;if(this.members){if(s=await this.readDataFile("entity"+mt.ENTITY+".mem","member graphics",45),!s)return void(this.runtimeException=new rt("Error loading member sprites!\n\n"+e.message,!0));r=S.loadData("index.dat",0,s)}let n=0;this.anInt659=0,this.anInt660=this.anInt659;t:for(let e=0;e<Et.animationCount;e++){let o=Et.animationName[e];for(let t=0;t<e;t++)if(Et.animationName[t].toLowerCase()===o.toLowerCase()){Et.animationNumber[e]=Et.animationNumber[t];continue t}let a=S.loadData(o+".dat",0,t),h=i;if(!a&&this.members&&(a=S.loadData(o+".dat",0,s),h=r),a){if(this.surface.parseSprite(this.anInt660,a,h,15),n+=15,1===Et.animationHasA[e]){let e=S.loadData(o+"a.dat",0,t),a=i;!e&&this.members&&(e=S.loadData(o+"a.dat",0,s),a=r),this.surface.parseSprite(this.anInt660+15,e,a,3),n+=3}if(1===Et.animationHasF[e]){let e=S.loadData(o+"f.dat",0,t),a=i;!e&&this.members&&(e=S.loadData(o+"f.dat",0,s),a=r),this.surface.parseSprite(this.anInt660+18,e,a,9),n+=9}if(0!==Et.animationSomething[e])for(let t=this.anInt660;t<this.anInt660+27;t++)this.surface.loadSprite(t)}Et.animationNumber[e]=this.anInt660,this.anInt660+=27}console.log("Loaded: "+n+" frames of animation")}handleAppearancePanelControls(){if(this.panelGame[L].handleMouse(this.mouseX,this.mouseY,this.lastMouseButtonDown,this.mouseButtonDown),this.panelGame[L].isClicked(this.controlButtonAppearanceHead1))do{this.appearanceHeadType=(this.appearanceHeadType-1+Et.animationCount)%Et.animationCount}while(1!=(3&Et.animationSomething[this.appearanceHeadType])||0==(Et.animationSomething[this.appearanceHeadType]&4*this.appearanceHeadGender));if(this.panelGame[L].isClicked(this.controlButtonAppearanceHead2))do{this.appearanceHeadType=(this.appearanceHeadType+1)%Et.animationCount}while(1!=(3&Et.animationSomething[this.appearanceHeadType])||0==(Et.animationSomething[this.appearanceHeadType]&4*this.appearanceHeadGender));if(this.panelGame[L].isClicked(this.controlButtonAppearanceHair1)&&(this.appearanceHairColour=(this.appearanceHairColour-1+this.characterHairColours.length)%this.characterHairColours.length),this.panelGame[L].isClicked(this.controlButtonAppearanceHair2)&&(this.appearanceHairColour=(this.appearanceHairColour+1)%this.characterHairColours.length),this.panelGame[L].isClicked(this.controlButtonAppearanceGender1)||this.panelGame[L].isClicked(this.controlButtonAppearanceGender2)){for(this.appearanceHeadGender=3-this.appearanceHeadGender;1!=(3&Et.animationSomething[this.appearanceHeadType])||0==(Et.animationSomething[this.appearanceHeadType]&4*this.appearanceHeadGender);this.appearanceHeadType=(this.appearanceHeadType+1)%Et.animationCount);for(;2!=(3&Et.animationSomething[this.appearanceBodyGender])||0==(Et.animationSomething[this.appearanceBodyGender]&4*this.appearanceHeadGender);this.appearanceBodyGender=(this.appearanceBodyGender+1)%Et.animationCount);}this.panelGame[L].isClicked(this.controlButtonAppearanceTop1)&&(this.appearanceTopColour=(this.appearanceTopColour-1+this.characterTopBottomColours.length)%this.characterTopBottomColours.length),this.panelGame[L].isClicked(this.controlButtonAppearanceTop2)&&(this.appearanceTopColour=(this.appearanceTopColour+1)%this.characterTopBottomColours.length),this.panelGame[L].isClicked(this.controlButtonAppearanceSkin1)&&(this.appearanceSkinColour=(this.appearanceSkinColour-1+this.characterSkinColours.length)%this.characterSkinColours.length),this.panelGame[L].isClicked(this.controlButtonAppearanceSkin2)&&(this.appearanceSkinColour=(this.appearanceSkinColour+1)%this.characterSkinColours.length),this.panelGame[L].isClicked(this.controlButtonAppearanceBottom1)&&(this.appearanceBottomColour=(this.appearanceBottomColour-1+this.characterTopBottomColours.length)%this.characterTopBottomColours.length),this.panelGame[L].isClicked(this.controlButtonAppearanceBottom2)&&(this.appearanceBottomColour=(this.appearanceBottomColour+1)%this.characterTopBottomColours.length),this.panelGame[L].isClicked(this.controlButtonAppearanceAccept)&&(this.clientStream.send(vt.CHANGE_APPEARANCE(this.appearanceHeadGender,this.appearanceHeadType,this.appearanceBodyGender,this.appearance2Colour,this.appearanceHairColour,this.appearanceTopColour,this.appearanceBottomColour,this.appearanceSkinColour)),this.surface.blackScreen(),this.showAppearanceChange=!1)}draw(){if(this.runtimeException){let t=this.getGraphics();return t.setColor(E.BLACK),t.fillRect(0,0,this.gameWidth,this.gameHeight),t.setFont(P.HELVETICA.bold(16)),t.setColor(E.YELLOW),t.drawString("Sorry, an error has occurred whilst loading RSCGo",30,35),t.setColor(E.WHITE),t.drawString("To fix this try the following (in order):",30,85),t.setFont(P.HELVETICA.bold(12)),t.drawString("1: Try closing ALL open web-browser windows, and reloading",30,135),t.drawString("2: Try clearing your web-browsers cache from tools->internet options",30,165),t.drawString("3: Try using a different game-world",30,195),t.drawString("4: Try rebooting your computer",30,225),t.drawString("5: Try selecting a different version of Java from the play-game menu",30,255),void this.setTargetFps(1)}if(this.initException){let t=this.getGraphics();return t.setColor(E.BLACK),t.fillRect(0,0,this.gameWidth,this.gameHeight),t.setFont(P.HELVETICA.bold(20)),t.setColor(E.WHITE),t.drawString("Error - unable to load game!",50,50),t.drawString("To play RuneScape make sure you play from",50,100),t.drawString("http://rscgo.com",50,150),void this.setTargetFps(1)}try{switch(this.gameState){case A.LOGIN:this.surface.worldVisible=!1,this.drawLoginScreens();break;case A.WORLD:this.surface.worldVisible=!0,this.drawGame();break;default:return}}catch(t){this.runtimeException=t,this.clearResources(),console.error(t)}}clearResources(){this.closeConnection(),this.freeCacheMemory(),this.audioPlayer&&this.audioPlayer.stopPlayer()}renderConfirmDuel(){if(this.surface.drawBox(22,36,468,16,192),this.surface.drawBoxAlpha(22,52,468,246,10000536,160),this.surface.drawStringCenter("Please confirm your duel with @yel@"+S.hashToUsername(this.duelOpponentNameHash),256,48,1,16777215),this.surface.drawStringCenter("Your stake:",139,66,1,16776960),this.duelItemsCount<=0)this.surface.drawStringCenter("Nothing!",139,78,1,16777215);else{let t=0;for(let e of this.duelItemList){let i=Et.itemName[e.id]+(0===Et.itemStackable[e.id]?" x "+oe(e.amount):"");e&&i&&this.surface.drawStringCenter(i,139,78+t,1,16777215),t+=12}}if(this.surface.drawStringCenter("Your opponent's stake:",373,66,1,16776960),this.duelOpponentItemsCount<=0)this.surface.drawStringCenter("Nothing!",373,78,1,16777215);else{let t=0;for(let e of this.duelOpponentItemList){let i=Et.itemName[e.id];0===Et.itemStackable[e.id]?i+=" x "+oe(e.amount):i+="",e&&i&&this.surface.drawStringCenter(i,373,78+t,1,16777215),t+=12}}this.surface.drawStringCenter(0===this.duelOptionRetreat?"You can retreat from this duel":"No retreat is possible",256,240,1,0===this.duelOptionRetreat?65280:16711680),this.surface.drawStringCenter("Magic "+this.duelOptionMagic===0?"may":"cannot be used",256,240,1,0===this.duelOptionMagic?65280:16711680),this.surface.drawStringCenter("Prayer "+this.duelOptionPrayer===0?"may":"cannot be used",256,240,1,0===this.duelOptionPrayer?65280:16711680),this.surface.drawStringCenter("Weapons "+this.duelOptionWeapons===0?"may":"cannot be used",256,240,1,0===this.duelOptionWeapons?65280:16711680),this.surface.drawStringCenter("If you are sure click 'Accept' to begin the duel",256,266,1,16777215),this.duelAccepted?this.surface.drawStringCenter("Waiting for other player...",256,286,1,16776960):(this.surface.drawSpriteID(105,274,this.spriteMedia+25),this.surface.drawSpriteID(339,274,this.spriteMedia+26)),this.isClicking()&&(this.mouseX>=105&&this.mouseX<=210&&this.mouseY>=274&&this.mouseY<=295&&(this.duelAccepted=!0,this.clientStream.queue(vt.ACCEPT_DUEL_TWO)),(this.mouseX>=339&&this.mouseX<=445&&this.mouseY>=274&&this.mouseY<=295||this.mouseX<22||this.mouseY<36||this.mouseX>490||this.mouseY>298)&&(this.duelConfirmVisible=!1,this.clientStream.queue(vt.DECLINE_DUEL)),this.mouseButtonClick=0)}walkToGroundItem(t,e,i,s,r){this.walkTo(t,e,i,s,i,s,!1,r)||this._walkToActionSource_from8(t,e,i,s,i,s,!0,r)}async loadModels(){Et.getModelIndex("torcha2"),Et.getModelIndex("torcha3"),Et.getModelIndex("torcha4"),Et.getModelIndex("skulltorcha2"),Et.getModelIndex("skulltorcha3"),Et.getModelIndex("skulltorcha4"),Et.getModelIndex("firea2"),Et.getModelIndex("firea3"),Et.getModelIndex("fireplacea2"),Et.getModelIndex("fireplacea3"),Et.getModelIndex("firespell2"),Et.getModelIndex("firespell3"),Et.getModelIndex("lightning2"),Et.getModelIndex("lightning3"),Et.getModelIndex("clawspell2"),Et.getModelIndex("clawspell3"),Et.getModelIndex("clawspell4"),Et.getModelIndex("clawspell5"),Et.getModelIndex("spellcharge2"),Et.getModelIndex("spellcharge3");let t=await this.readDataFile("models"+mt.MODELS+".jag","3d models",60);if(t)for(let e=0;e<Et.modelCount;e++){let i=S.getDataFileOffset(Et.modelName[e]+".ob3",t);this.gameModels[e]=0!==i?Yt._from3(t,i,!0):Yt._from2(1,1),"giantcrystal"===Et.modelName[e].toLowerCase()&&(this.gameModels[e].transparent=!0)}else this.initException=new rt("Error loading 3d models!\n\n"+e.message,!0)}renderServerMessageBox(){let t=100;this.serverMessageBoxTop&&(t=450,t=300),this.surface.drawBox(256-Math.floor(200),167-Math.floor(t/2),400,t,0),this.surface.drawBoxEdge(256-Math.floor(200),167-Math.floor(t/2),400,t,16777215),this.surface.centrepara(this.serverMessage,256,167-Math.floor(t/2)+20,1,16777215,360);let e=157+Math.floor(t/2),i=16777215;this.mouseY>e-12&&this.mouseY<=e&&this.mouseX>106&&this.mouseX<406&&(i=16711680),this.surface.drawStringCenter("Click here to close window",256,e,1,i),0!==this.mouseButtonClick&&(16777215!==i||(this.mouseX<56||this.mouseX>456)&&(this.mouseY<167-(t/2|0)||this.mouseY>167+(t/2|0)))&&(this.showDialogServermessage=!1),this.mouseButtonClick=0}renderReportAbuseInputs(){if(this.inputTextFinal.length>0){let t=this.inputTextFinal.trim().substring(0,12);return this.inputTextCurrent="",this.inputTextFinal="",t.length>0&&this.clientStream.queue(vt.REPORT_ABUSE(t,this.reportAbuseOffence,this.reportAbuseMute?1:0)),void(this.reportAbuseState=0)}this.surface.drawBox(56,130,400,100,0),this.surface.drawBoxEdge(56,130,400,100,16777215);let t=160;this.surface.drawStringCenter("Now type the name of the offending player, and press enter",256,t,1,16776960),t+=18,this.surface.drawStringCenter("Name: "+this.inputTextCurrent+"*",256,t,4,16777215),this.moderatorLevel>0&&this.surface.drawStringCenter(`Moderator option: Mute player for 48 hours: ${this.reportAbuseMute?"ON":"OFF"}>`,256,207,1,this.reportAbuseMute?16744448:E.WHITE.toRGB()),t=222;let e=E.WHITE.toRGB();if(this.mouseX>196&&this.mouseX<316&&this.mouseY>t-13&&this.mouseY<t+2&&(e=E.YELLOW.toRGB()),this.surface.drawStringCenter("Click here to cancel",256,t,1,e),1===this.mouseButtonClick){if(this.moderatorLevel>0&&this.mouseX>106&&this.mouseX<406&&this.mouseY>194&&this.mouseY<209)return this.reportAbuseMute=!this.reportAbuseMute,void(this.mouseButtonClick=0);if(e!==E.WHITE.toRGB()||this.mouseX<56||this.mouseX>456||this.mouseY<130||this.mouseY>230)return this.mouseButtonClick=0,void(this.reportAbuseState=0)}}showMessage(t,e){if(2===e||4===e||6===e){for(let e=0;e<t.length-5&&"@"===t[e]&&"@"===t[e+4];)t=t.substring(e+5);let e=t.indexOf(":");if(e>-1){let i=t.substring(0,e),s=S.usernameToHash(i);if(s>0)for(let t=0;t<this.ignoreListCount;t++)if(this.ignoreList[t]===s)return}}t=t.replace("[GLOBAL] ",""),2===e&&(t="@yel@"+t),3!==e&&4!==e||(t="@whi@"+t),6===e&&(t="@cya@"+t),0!==this.messageTabSelected&&(4!==e&&3!==e||(this.messageTabFlashAll=ne(4)),2===e&&1!==this.messageTabSelected&&(this.messageTabFlashHistory=ne(4)),5===e&&2!==this.messageTabSelected&&(this.messageTabFlashQuest=ne(4)),6===e&&3!==this.messageTabSelected&&(this.messageTabFlashPrivate=ne(4)),3===e&&0!==this.messageTabSelected&&(this.messageTabSelected=0),6===e&&3!==this.messageTabSelected&&0!==this.messageTabSelected&&(this.messageTabSelected=0)),this.messageHistory.unshift({ticks:ne(6),message:t}),2===e&&this.panelGame[M].removeListEntry(this.controlTextListChat,t,this.panelGame[M].controlFlashText[this.controlTextListChat]===this.panelGame[M].controlListEntryCount[this.controlTextListChat]-4),5===e&&this.panelGame[M].removeListEntry(this.controlTextListQuest,t,this.panelGame[M].controlFlashText[this.controlTextListQuest]===this.panelGame[M].controlListEntryCount[this.controlTextListQuest]-4),6===e&&this.panelGame[M].removeListEntry(this.controlTextListPrivate,t,this.panelGame[M].controlFlashText[this.controlTextListPrivate]===this.panelGame[M].controlListEntryCount[this.controlTextListPrivate]-4)}walkToObject(t,e,i,s){let r=0,n=0;0===i||4===i?(r=Et.objectWidth[s],n=Et.objectHeight[s]):(n=Et.objectWidth[s],r=Et.objectHeight[s]),2===Et.objectType[s]||3===Et.objectType[s]?(0===i&&(t--,r++),2===i&&n++,4===i&&r++,6===i&&(e--,n++),this._walkToActionSource_from8(this.localRegionX,this.localRegionY,t,e,t+r-1,e+n-1,!1,!0)):this._walkToActionSource_from8(this.localRegionX,this.localRegionY,t,e,t+r-1,e+n-1,!0,!0)}getInventoryCount(t){let e=0;for(let i=0;i<this.inventoryItemsCount;i++)this.inventoryItemId[i]===t&&(1===Et.itemStackable[t]?e++:e+=this.inventoryItemStackCount[i]);return e}drawLoginScreens(){if(this.welcomed=!1,this.surface.interlace=!1,this.surface.blackScreen(),this.welcomeState===k.NEW_USER)return this.panelLogin[k.NEW_USER].render(),this.surface.drawSpriteID(0,this.gameHeight-4,this.spriteMedia+22),void this.surface.draw(this.graphics,0,0);let t=2*this.frameCounter%3072;t<1024?(this.surface.drawSpriteID(0,10,this.spriteLogo),t>768&&this.surface.fadeThenDrawSpriteID(0,10,this.spriteLogo+1,t-768)):t<2048?(this.surface.drawSpriteID(0,10,this.spriteLogo+1),t>1792&&this.surface.fadeThenDrawSpriteID(0,10,this.spriteMedia+10,t-1792)):(this.surface.drawSpriteID(0,10,this.spriteMedia+10),t>2816&&this.surface.fadeThenDrawSpriteID(0,10,this.spriteLogo,t-2816)),this.welcomeState===k.WELCOME&&this.panelLogin[k.WELCOME].render(),this.welcomeState===k.EXISTING_USER&&this.panelLogin[k.EXISTING_USER].render(),this.surface.drawSpriteID(0,this.gameHeight-4,this.spriteMedia+22),this.surface.draw(this.graphics,0,0)}renderConfigurationTab(t){let e=this.surface.width2-199;this.surface.drawSpriteID(e-49,3,this.spriteMedia+6);this.surface.drawBoxAlpha(e,36,196,65,dt.rgbToLong(181,181,181),160),this.surface.drawBoxAlpha(e,101,196,65,dt.rgbToLong(201,201,201),160),this.surface.drawBoxAlpha(e,166,196,95,dt.rgbToLong(181,181,181),160),this.surface.drawBoxAlpha(e,261,196,40,dt.rgbToLong(201,201,201),160);let i=e+3,s=51;this.surface.drawString("Game options - click to toggle",i,s,1,0),s+=15,this.optionCameraModeAuto?this.surface.drawString("Camera angle mode - @gre@Auto",i,s,1,16777215):this.surface.drawString("Camera angle mode - @red@Manual",i,s,1,16777215),s+=15,this.optionMouseButtonOne?this.surface.drawString("Mouse buttons - @red@One",i,s,1,16777215):this.surface.drawString("Mouse buttons - @gre@Two",i,s,1,16777215),s+=15,this.optionSoundDisabled?this.surface.drawString("Sound effects - @red@off",i,s,1,16777215):this.surface.drawString("Sound effects - @gre@on",i,s,1,16777215),s+=15,s+=5,this.surface.drawString("Account Settings",i,s,1,0);let r=16777215;s+=15,this.mouseX>i&&this.mouseX<i+196&&this.mouseY>s-12&&this.mouseY<s+4&&(r=16776960),this.surface.drawString("Change password",i,s,1,r),r=16777215,s+=15,this.mouseX>i&&this.mouseX<i+196&&this.mouseY>s-12&&this.mouseY<s+4&&(r=16776960),this.surface.drawString("Set recovery questions",i,s,1,r),s+=15,s+=5,this.surface.drawString("Privacy settings. Will be applied to",e+3,s,1,0),s+=15,this.surface.drawString("all people not on your friends list",e+3,s,1,0),s+=15,this.settingsBlockChat?this.surface.drawString("Block chat messages: @gre@<on>",e+3,s,1,16777215):this.surface.drawString("Block chat messages: @red@<off>",e+3,s,1,16777215),s+=15,this.settingsBlockPrivate?this.surface.drawString("Block private messages: @gre@<on>",e+3,s,1,16777215):this.surface.drawString("Block private messages: @red@<off>",e+3,s,1,16777215),s+=15,this.settingsBlockTrade?this.surface.drawString("Block trade requests: @gre@<on>",e+3,s,1,16777215):this.surface.drawString("Block trade requests: @red@<off>",e+3,s,1,16777215),s+=15,this.settingsBlockDuel?this.surface.drawString("Block duel requests: @gre@<on>",e+3,s,1,16777215):this.surface.drawString("Block duel requests: @red@<off>",e+3,s,1,16777215),s+=15,s+=5,this.surface.drawString("Always logout when you finish",i,s,1,0),s+=15;let n=16777215;if(this.mouseX>i&&this.mouseX<i+196&&this.mouseY>s-12&&this.mouseY<s+4&&(n=16776960),this.surface.drawString("Click here to logout",e+3,s,1,n),!t)return;let o=this.mouseX-(this.surface.width2-199),a=this.mouseY-36;if(o>=0&&a>=0&&o<196&&a<265){let t=196,e=this.surface.width2-199+3,i=36+30;1===this.mouseButtonClick&&(this.mouseX>e&&this.mouseX<e+t&&this.mouseY>i-12&&this.mouseY<i+4&&(this.optionCameraModeAuto=!this.optionCameraModeAuto,this.clientStream.newPacket(It.SETTINGS_GAME),this.clientStream.putByte(0),this.clientStream.putByte(this.optionCameraModeAuto?1:0),this.clientStream.sendPacket()),this.mouseX>e&&this.mouseX<e+t&&this.mouseY>i+15-12&&this.mouseY<i+15+4&&(this.optionMouseButtonOne=!this.optionMouseButtonOne,this.clientStream.newPacket(It.SETTINGS_GAME),this.clientStream.putByte(2),this.clientStream.putByte(this.optionMouseButtonOne?1:0),this.clientStream.sendPacket()),this.mouseX>e&&this.mouseX<e+t&&this.mouseY>i+30-12&&this.mouseY<i+30+4&&(this.optionSoundDisabled=!this.optionSoundDisabled,this.clientStream.newPacket(It.SETTINGS_GAME),this.clientStream.putByte(3),this.clientStream.putByte(this.optionSoundDisabled?1:0),this.clientStream.sendPacket())),i+=45,i+=5,i+=15,i+=15,i+=15,i+=5,i+=15,i+=15,1===this.mouseButtonClick&&(this.mouseX>e&&this.mouseX<e+t&&this.mouseY>i-12&&this.mouseY<i+4&&(this.settingsBlockChat=1-this.settingsBlockChat,this.sendPrivacySettings(this.settingsBlockChat,this.settingsBlockPrivate,this.settingsBlockTrade,this.settingsBlockDuel)),this.mouseX>e&&this.mouseX<e+t&&this.mouseY>i+15-12&&this.mouseY<i+15+4&&(this.settingsBlockPrivate=1-this.settingsBlockPrivate,this.sendPrivacySettings(this.settingsBlockChat,this.settingsBlockPrivate,this.settingsBlockTrade,this.settingsBlockDuel)),this.mouseX>e&&this.mouseX<e+t&&this.mouseY>i+30-12&&this.mouseY<i+30+4&&(this.settingsBlockTrade=1-this.settingsBlockTrade,this.sendPrivacySettings(this.settingsBlockChat,this.settingsBlockPrivate,this.settingsBlockTrade,this.settingsBlockDuel)),this.mouseX>e&&this.mouseX<e+t&&this.mouseY>i+45-12&&this.mouseY<i+45+4&&(this.settingsBlockDuel=1-this.settingsBlockDuel,this.sendPrivacySettings(this.settingsBlockChat,this.settingsBlockPrivate,this.settingsBlockTrade,this.settingsBlockDuel))),i+=60,i+=15,i+=5,this.mouseX>e&&this.mouseX<e+t&&this.mouseY>i-12&&this.mouseY<i+4&&1===this.mouseButtonClick&&this.sendLogout(),this.mouseButtonClick=0}}async loadTextures(){let t=await this.readDataFile("textures"+mt.TEXTURES+".jag","Textures",50);if(!t)return void(this.runtimeException=new rt("Error loading textures!\n\n"+e.message,!0));let i=S.loadData("index.dat",0,t);this.scene.allocateTextures(Et.textureCount,7,11);for(let e=0;e<Et.textureCount;e++){let s=Et.textureName[e],r=S.loadData(s+".dat",0,t);this.surface.parseSprite(this.spriteTexture,r,i,1),this.surface.drawBox(0,0,128,128,16711935),this.surface.drawSpriteID(0,0,this.spriteTexture);let n=this.surface.spriteWidthFull[this.spriteTexture],o=Et.textureSubtypeName[e];if(o&&o.length>0){let e=S.loadData(o+".dat",0,t);this.surface.parseSprite(this.spriteTexture,e,i,1),this.surface.drawSpriteID(0,0,this.spriteTexture)}this.surface._drawSprite_from5(this.spriteTextureWorld+e,0,0,n,n);let a=n*n;for(let t=0;t<a;t++)65280===this.surface.surfacePixels[this.spriteTextureWorld+e][t]&&(this.surface.surfacePixels[this.spriteTextureWorld+e][t]=16711935);this.surface.drawWorld(this.spriteTextureWorld+e),this.scene.defineTexture(e,this.surface.spriteColoursUsed[this.spriteTextureWorld+e],this.surface.spritePalettes[this.spriteTextureWorld+e],(n>>6)-1)}}handleMouseDown(t,e,i){this.mouseClickXHistory[this.mouseClickCount]=e,this.mouseClickYHistory[this.mouseClickCount]=i,this.mouseClickCount=this.mouseClickCount+1&8191;for(let t=10;t<4e3;t++){let s=this.mouseClickCount-t&8191;if(this.mouseClickXHistory[s]===e&&this.mouseClickYHistory[s]===i){let r=!1;for(let n=1;n<t;n++){let o=this.mouseClickCount-n&8191,a=s-n&8191;if(this.mouseClickXHistory[a]===e&&this.mouseClickYHistory[a]===i||(r=!0),this.mouseClickXHistory[o]!==this.mouseClickXHistory[a]||this.mouseClickYHistory[o]!==this.mouseClickYHistory[a])break;if(a===t-1&&r&&0===this.combatTimeout&&0===this.logoutBoxFrames)return void this.sendLogout()}}}}drawTeleportBubble(t,e,i,s,r,n,o){let a=this.teleportBubbleType[r],h=this.teleportBubbleTime[r];0===a&&this.surface.drawCircle(t+(i>>1),e+(s>>1),20+2*h,65280+5*h*256,255-5*h),1===a&&this.surface.drawCircle(t+(i>>1),e+(s>>1),10+h,16711680+5*h*256,255-5*h),2===a&&this.surface.drawCircle(t+(i>>1),e+(s>>1),10+h,16711680+5*h*256,255-5*h)}showServerMessage(t){/^@bor@/.test(t)?this.showMessage(t,4):/^@que@/.test(t)?this.showMessage("@whi@"+t,5):/^@pri@/.test(t)?this.showMessage(t,6):this.showMessage(t,3)}updateObjectAnimation(t,e){let i=this.objectX[t],s=this.objectY[t],r=i-(this.localPlayer.currentX>>7),n=s-(this.localPlayer.currentY>>7);if(i>=0&&s>=0&&i<96&&s<96&&r>-7&&r<7&&n>-7&&n<7){this.scene.removeModel(this.objectModel[t]);let i=Et.getModelIndex(e),s=this.gameModels[i].copy();this.scene.addModel(s),s.createGouraudLightSource(!0,48,48,-50,-10,-50),s.copyPosition(this.objectModel[t]),s.key=t,this.objectModel[t]=s}}isClicking(){return 1===this.mouseButtonClick||this.isMiddleClicking()}isRightClicking(){return 2===this.mouseButtonClick||this.optionMouseButtonOne&&this.isClicking()}isMiddleClicking(){return 3===this.mouseButtonClick}handleDefaultClick(){(this.selectedSpell>=0||this.selectedItemInventoryIndex>=0)&&(this.menuItemText1[this.menuItemsCount]="Cancel",this.menuItemText2[this.menuItemsCount]="",this.menuItemID[this.menuItemsCount]=4e3,this.menuItemsCount++);for(let t=0;t<this.menuItemsCount;t++)this.menuIndices[t]=t;for(let t=!1;!t;){t=!0;for(let e=0;e<this.menuItemsCount-1;e++)if(this.menuItemID[this.menuIndices[e]]>this.menuItemID[this.menuIndices[e+1]]){let i=this.menuIndices[e];this.menuIndices[e]=this.menuIndices[e+1],this.menuIndices[e+1]=i,t=!1}}if(this.menuItemsCount>20&&(this.menuItemsCount=20),this.menuItemsCount>0){let t=-1;for(let e=0;e<this.menuItemsCount;e++){let i=this.menuIndices[e];if(this.menuItemText2[i]&&this.menuItemText2[i].length>0){t=e;break}}if(this.selectedItemInventoryIndex>=0||this.selectedSpell>=0?1===this.menuItemsCount?this.surface.drawString("Choose a target"+("@whi@"+this.menuItemsCount===2?" / 1 more option":this.menuItemsCount>2?" / "+(this.menuItemsCount-1)+" more options":""),6,14,1,16776960):this.menuItemsCount>1&&this.surface.drawString("@whi@"+this.menuItemText1[this.menuIndices[0]]+" "+this.menuItemText2[this.menuIndices[0]]+("@whi@"+this.menuItemsCount===2?" / 1 more option":this.menuItemsCount>2?" / "+(this.menuItemsCount-1)+" more options":""),6,14,1,16776960):t>=0&&this.surface.drawString(this.menuItemText2[this.menuIndices[t]]+": @whi@"+this.menuItemText1[this.menuIndices[0]]+("@whi@"+this.menuItemsCount===2?" / 1 more option":this.menuItemsCount>2?" / "+(this.menuItemsCount-1)+" more options":""),6,14,1,16776960),this.isClicking()&&this.menuItemsCount>=1)return this.menuItemClick(this.menuIndices[0]),void(this.mouseButtonClick=0);if(this.isRightClicking()){this.menuHeight=15*(this.menuItemsCount+1),this.menuWidth=this.surface.textWidth("Choose option",1)+5;for(let t=0;t<this.menuItemsCount;t++){let e=this.surface.textWidth(this.menuItemText2[t]+" "+this.menuItemText1[t],1)+5;e>this.menuWidth&&(this.menuWidth=e)}return this.menuX=Math.max(0,this.mouseX-Math.floor(this.menuWidth/2)),this.menuX+this.menuWidth>510&&(this.menuX=510-this.menuWidth),this.menuY=Math.max(0,this.mouseY-7),this.menuY+this.menuHeight>315&&(this.menuY=315-this.menuHeight),this.visibleContextMenu=!0,void(this.mouseButtonClick=0)}}}renderLogoutNotification(){this.surface.drawBox(126,137,260,60,0),this.surface.drawBoxEdge(126,137,260,60,16777215),this.surface.drawStringCenter("Logging out...",256,173,5,16777215)}renderFightModeSelect(){if(0!==this.mouseButtonClick)for(let t=0;t<5;t++)if(!(t<=0||this.mouseX<=7||this.mouseX>=182||this.mouseY<=15+20*t||this.mouseY>=15+20*t+20)){this.combatStyle=t-1,this.mouseButtonClick=0,this.clientStream.newPacket(It.COMBAT_STYLE),this.clientStream.putByte(this.combatStyle),this.clientStream.sendPacket();break}for(let t=0;t<5;t++)t===this.combatStyle+1?this.surface.drawBoxAlpha(7,15+20*t,175,20,dt.rgbToLong(255,0,0),128):this.surface.drawBoxAlpha(7,15+20*t,175,20,dt.rgbToLong(190,190,190),128),this.surface.drawLineHoriz(7,15+20*t,175,0),this.surface.drawLineHoriz(7,15+20*t+20,175,0);this.surface.drawStringCenter("Select combat style",94,31,3,16777215),this.surface.drawStringCenter("Controlled (+1 of each)",94,51,3,0),this.surface.drawStringCenter("Aggressive (+3 strength)",94,71,3,0),this.surface.drawStringCenter("Accurate   (+3 attack)",94,91,3,0),this.surface.drawStringCenter("Defensive  (+3 defense)",94,111,3,0)}menuItemClick(t){let e=this.menuItemX[t],i=this.menuItemY[t],s=this.menuSourceType[t],r=this.menuSourceIndex[t],n=this.menuTargetIndex[t],o=this.menuItemID[t];if(200===o&&(this.walkToGroundItem(this.localRegionX,this.localRegionY,e,i,!0),this.clientStream.newPacket(It.CAST_GROUNDITEM),this.clientStream.putShort(e+this.regionX),this.clientStream.putShort(i+this.regionY),this.clientStream.putShort(s),this.clientStream.putShort(r),this.clientStream.sendPacket(),this.selectedSpell=-1),210===o&&(this.walkToGroundItem(this.localRegionX,this.localRegionY,e,i,!0),this.clientStream.newPacket(It.USEWITH_GROUNDITEM),this.clientStream.putShort(e+this.regionX),this.clientStream.putShort(i+this.regionY),this.clientStream.putShort(s),this.clientStream.putShort(r),this.clientStream.sendPacket(),this.selectedItemInventoryIndex=-1),220===o&&(this.walkToGroundItem(this.localRegionX,this.localRegionY,e,i,!0),this.clientStream.newPacket(It.GROUNDITEM_TAKE),this.clientStream.putShort(e+this.regionX),this.clientStream.putShort(i+this.regionY),this.clientStream.putShort(s),this.clientStream.putShort(r),this.clientStream.sendPacket()),3200===o&&this.showMessage(Et.itemDescription[s],3),300===o&&(this.walkToWallObject(e,i,s),this.clientStream.newPacket(It.CAST_WALLOBJECT),this.clientStream.putShort(e+this.regionX),this.clientStream.putShort(i+this.regionY),this.clientStream.putByte(s),this.clientStream.putShort(r),this.clientStream.sendPacket(),this.selectedSpell=-1),310===o&&(this.walkToWallObject(e,i,s),this.clientStream.newPacket(It.USEWITH_WALLOBJECT),this.clientStream.putShort(e+this.regionX),this.clientStream.putShort(i+this.regionY),this.clientStream.putByte(s),this.clientStream.putShort(r),this.clientStream.sendPacket(),this.selectedItemInventoryIndex=-1),320===o&&(this.walkToWallObject(e,i,s),this.clientStream.newPacket(It.WALL_OBJECT_COMMAND1),this.clientStream.putShort(e+this.regionX),this.clientStream.putShort(i+this.regionY),this.clientStream.putByte(s),this.clientStream.sendPacket()),2300===o&&(this.walkToWallObject(e,i,s),this.clientStream.newPacket(It.WALL_OBJECT_COMMAND2),this.clientStream.putShort(e+this.regionX),this.clientStream.putShort(i+this.regionY),this.clientStream.putByte(s),this.clientStream.sendPacket()),3300===o&&this.showMessage(Et.wallObjectDescription[s],3),400===o&&(this.walkToObject(e,i,s,r),this.clientStream.newPacket(It.CAST_OBJECT),this.clientStream.putShort(e+this.regionX),this.clientStream.putShort(i+this.regionY),this.clientStream.putShort(n),this.clientStream.sendPacket(),this.selectedSpell=-1),410===o&&(this.walkToObject(e,i,s,r),this.clientStream.newPacket(It.USEWITH_OBJECT),this.clientStream.putShort(e+this.regionX),this.clientStream.putShort(i+this.regionY),this.clientStream.putShort(n),this.clientStream.sendPacket(),this.selectedItemInventoryIndex=-1),420===o&&(this.walkToObject(e,i,s,r),this.clientStream.newPacket(It.OBJECT_CMD1),this.clientStream.putShort(e+this.regionX),this.clientStream.putShort(i+this.regionY),this.clientStream.sendPacket()),2400===o&&(this.walkToObject(e,i,s,r),this.clientStream.newPacket(It.OBJECT_CMD2),this.clientStream.putShort(e+this.regionX),this.clientStream.putShort(i+this.regionY),this.clientStream.sendPacket()),3400===o&&this.showMessage(Et.objectDescription[s],3),600===o&&(this.clientStream.newPacket(It.CAST_INVITEM),this.clientStream.putShort(s),this.clientStream.putShort(r),this.clientStream.sendPacket(),this.selectedSpell=-1),610===o&&(this.clientStream.newPacket(It.USEWITH_INVITEM),this.clientStream.putShort(s),this.clientStream.putShort(r),this.clientStream.sendPacket(),this.selectedItemInventoryIndex=-1),620===o&&(this.clientStream.newPacket(It.INV_UNEQUIP),this.clientStream.putShort(s),this.clientStream.sendPacket()),630===o&&(this.clientStream.newPacket(It.INV_WEAR),this.clientStream.putShort(s),this.clientStream.sendPacket()),640===o&&(this.clientStream.newPacket(It.INV_CMD),this.clientStream.putShort(s),this.clientStream.sendPacket()),650===o&&(this.selectedItemInventoryIndex=s,this.showUiTab=0,this.selectedItemName=Et.itemName[this.inventoryItemId[this.selectedItemInventoryIndex]]),660===o&&(this.clientStream.newPacket(It.INV_DROP),this.clientStream.putShort(s),this.clientStream.sendPacket(),this.selectedItemInventoryIndex=-1,this.showUiTab=0,this.showMessage("Dropping "+Et.itemName[this.inventoryItemId[s]],4)),3600===o&&this.showMessage(Et.itemDescription[s],3),700===o){let t=(e-64)/this.tileSize|0,n=(i-64)/this.tileSize|0;this._walkToActionSource_from5(this.localRegionX,this.localRegionY,t,n,!0),this.clientStream.newPacket(It.CAST_NPC),this.clientStream.putShort(s),this.clientStream.putShort(r),this.clientStream.sendPacket(),this.selectedSpell=-1}if(710===o){let t=(e-64)/this.tileSize|0,n=(i-64)/this.tileSize|0;this._walkToActionSource_from5(this.localRegionX,this.localRegionY,t,n,!0),this.clientStream.newPacket(It.USEWITH_NPC),this.clientStream.putShort(s),this.clientStream.putShort(r),this.clientStream.sendPacket(),this.selectedItemInventoryIndex=-1}if(720===o){let t=(e-64)/this.tileSize|0,r=(i-64)/this.tileSize|0;this._walkToActionSource_from5(this.localRegionX,this.localRegionY,t,r,!0),this.clientStream.newPacket(It.NPC_TALK),this.clientStream.putShort(s),this.clientStream.sendPacket()}if(725===o){let t=(e-64)/this.tileSize|0,r=(i-64)/this.tileSize|0;this._walkToActionSource_from5(this.localRegionX,this.localRegionY,t,r,!0),this.clientStream.newPacket(It.NPC_CMD),this.clientStream.putShort(s),this.clientStream.sendPacket()}if(715===o||2715===o){let t=(e-64)/this.tileSize|0,r=(i-64)/this.tileSize|0;this._walkToActionSource_from5(this.localRegionX,this.localRegionY,t,r,!0),this.clientStream.newPacket(It.NPC_ATTACK),this.clientStream.putShort(s),this.clientStream.sendPacket()}if(3700===o&&this.showMessage(Et.npcDescription[s],3),800===o){let t=(e-64)/this.tileSize|0,n=(i-64)/this.tileSize|0;this._walkToActionSource_from5(this.localRegionX,this.localRegionY,t,n,!0),this.clientStream.newPacket(It.CAST_PLAYER),this.clientStream.putShort(s),this.clientStream.putShort(r),this.clientStream.sendPacket(),this.selectedSpell=-1}if(810===o){let t=(e-64)/this.tileSize|0,n=(i-64)/this.tileSize|0;this._walkToActionSource_from5(this.localRegionX,this.localRegionY,t,n,!0),this.clientStream.newPacket(It.USEWITH_PLAYER),this.clientStream.putShort(s),this.clientStream.putShort(r),this.clientStream.sendPacket(),this.selectedItemInventoryIndex=-1}if(805===o||2805===o){let t=(e-64)/this.tileSize|0,r=(i-64)/this.tileSize|0;this._walkToActionSource_from5(this.localRegionX,this.localRegionY,t,r,!0),this.clientStream.newPacket(It.PLAYER_ATTACK),this.clientStream.putShort(s),this.clientStream.sendPacket()}2806===o&&(this.clientStream.newPacket(It.PLAYER_DUEL),this.clientStream.putShort(s),this.clientStream.sendPacket()),2810===o&&(this.clientStream.newPacket(It.PLAYER_TRADE),this.clientStream.putShort(s),this.clientStream.sendPacket()),2820===o&&(this.clientStream.newPacket(It.PLAYER_FOLLOW),this.clientStream.putShort(s),this.clientStream.sendPacket()),900===o&&(this._walkToActionSource_from5(this.localRegionX,this.localRegionY,e,i,!0),this.clientStream.newPacket(It.CAST_GROUND),this.clientStream.putShort(e+this.regionX),this.clientStream.putShort(i+this.regionY),this.clientStream.putShort(s),this.clientStream.sendPacket(),this.selectedSpell=-1),920===o&&(this._walkToActionSource_from5(this.localRegionX,this.localRegionY,e,i,!1),-24===this.mouseClickXStep&&(this.mouseClickXStep=24)),1e3===o&&(this.clientStream.newPacket(It.CAST_SELF),this.clientStream.putShort(s),this.clientStream.sendPacket(),this.selectedSpell=-1),4e3===o&&(this.selectedItemInventoryIndex=-1,this.selectedSpell=-1)}updateWelcomeStatuses(t,e){switch(this.welcomeState){case k.NEW_USER:this.panelLogin[k.NEW_USER].setTextHandle(this.controlRegisterStatus,t+" "+e);break;case k.EXISTING_USER:this.panelLogin[k.EXISTING_USER].setTextHandle(this.controlLoginStatus,t+" "+e)}this.drawLoginScreens(),this.unsetFrameTimes()}async lostConnection(){0===this.logoutBoxFrames?await super.lostConnection():this.resetLoginVars()}isValidCameraAngle(t){let e=this.localPlayer.currentX>>7,i=this.localPlayer.currentY>>7;for(let s=2;s>0;s--){if(1===t&&(128==(128&this.world.objectAdjacency.get(e,i-s))||128==(128&this.world.objectAdjacency.get(e-s,i))||128==(128&this.world.objectAdjacency.get(e-s,i-s))))return!1;if(3===t&&(128==(128&this.world.objectAdjacency.get(e,i+s))||128==(128&this.world.objectAdjacency.get(e-s,i))||128==(128&this.world.objectAdjacency.get(e-s,i+s))))return!1;if(5===t&&(128==(128&this.world.objectAdjacency.get(e,i+s))||128==(128&this.world.objectAdjacency.get(e+s,i))||128==(128&this.world.objectAdjacency.get(e+s,i+s))))return!1;if(7===t&&(128==(128&this.world.objectAdjacency.get(e,i-s))||128==(128&this.world.objectAdjacency.get(e+s,i))||128==(128&this.world.objectAdjacency.get(e+s,i-s))))return!1;if(0===t&&128==(128&this.world.objectAdjacency.get(e,i-s)))return!1;if(2===t&&128==(128&this.world.objectAdjacency.get(e-s,i)))return!1;if(4===t&&128==(128&this.world.objectAdjacency.get(e,i+s)))return!1;if(6===t&&128==(128&this.world.objectAdjacency.get(e+s,i)))return!1}return!0}static getCookie(){return se(s)}resetGameState(){this.gameState=A.LOGIN,this.welcomeState=k.WELCOME,this.loginUser=se("username"),this.loginPass||(this.loginPass=""),this.playerCount=0,this.npcCount=0}handleIncomingPacket(t,e,i){try{let s=1;if(t===At.REGION_PLAYERS){this.knownPlayerCount=this.playerCount;for(let t=0;t<this.knownPlayerCount;t++)this.knownPlayers[t]=this.players[t];let t=8*s;this.localRegionX=S.getBitMask(i,t,11),t+=11,this.localRegionY=S.getBitMask(i,t,13),t+=13;let r=S.getBitMask(i,t,4);t+=4;let n=this.loadNextRegion(this.localRegionX,this.localRegionY);this.localRegionX-=this.regionX,this.localRegionY-=this.regionY;let o=this.localRegionX*this.tileSize+64,a=this.localRegionY*this.tileSize+64;n&&(this.localPlayer.waypointCurrent=0,this.localPlayer.targetWaypoint=0,this.localPlayer.currentX=this.localPlayer.waypointsX[0]=o,this.localPlayer.currentY=this.localPlayer.waypointsY[0]=a),this.playerCount=0,this.localPlayer=this.createPlayer(this.localPlayerServerIndex,o,a,r);let h=S.getBitMask(i,t,8);t+=8;for(let e=0;e<h;e++){let s=this.knownPlayers[e+1],r=0!==S.getBitMask(i,t,1);if(t+=1,r){let e=0===S.getBitMask(i,t,1);if(t+=1,e){let e=S.getBitMask(i,t,3);t+=3;let r=s.waypointCurrent,n=s.waypointsX[r],o=s.waypointsY[r];for(let t=0;t<4;t++){let i=t<2?this.tileSize:-this.tileSize;for(let s=0;s<3;s++)e===(2*t+(s+1))%8&&(t%2==0?n+=i:o+=i)}s.animationNext=e,s.waypointCurrent=r=(r+1)%10,s.waypointsX[r]=n,s.waypointsY[r]=o}else{let e=S.getBitMask(i,t,2);if(t+=2,3===e)continue;s.animationNext=e<<2|S.getBitMask(i,t,2),t+=2}}this.players[this.playerCount++]=s}let l=0;for(;t+24<8*e;){let e=S.getBitMask(i,t,11);t+=11;let s=S.getBitMask(i,t,5);t+=5,s>15&&(s-=32);let r=S.getBitMask(i,t,5);t+=5,r>15&&(r-=32);let n=S.getBitMask(i,t,4);t+=4;let o=(this.localRegionX+s)*this.tileSize+64,a=(this.localRegionY+r)*this.tileSize+64;this.createPlayer(e,o,a,n),0===S.getBitMask(i,t++,1)&&(this.playerServerIndexes[l++]=e)}if(l>0){this.clientStream.newPacket(It.KNOWN_PLAYERS),this.clientStream.putShort(l);for(let t=0;t<l;t++){let e=this.playerServer[this.playerServerIndexes[t]];this.clientStream.putShort(e.serverIndex),this.clientStream.putShort(e.appearanceTicket)}this.clientStream.sendPacket()}return}if(t===At.REGION_GROUND_ITEMS){for(;s<e;)if(255===S.getUnsignedByte(i[s])){s++;let t=this.localRegionX+i[s++]>>3,e=this.localRegionY+i[s++]>>3,r=0;for(let i=0;i<this.groundItemCount;i++){let s=(this.groundItemX[i]>>3)-t,n=(this.groundItemY[i]>>3)-e;0===s&&0===n||(r!==i&&(this.groundItemX[r]=this.groundItemX[i],this.groundItemY[r]=this.groundItemY[i],this.groundItemId[r]=this.groundItemId[i],this.groundItemZ[r]=this.groundItemZ[i]),r++)}this.groundItemCount=r}else{let t=S.getUnsignedShort(i,s);s+=2;let e=this.localRegionX+i[s++],r=this.localRegionY+i[s++];if(0==(32768&t)){this.groundItemX[this.groundItemCount]=e,this.groundItemY[this.groundItemCount]=r,this.groundItemId[this.groundItemCount]=t,this.groundItemZ[this.groundItemCount]=0;for(let t=0;t<this.objectCount;t++)if(this.objectX[t]===e&&this.objectY[t]===r){this.groundItemZ[this.groundItemCount]=Et.objectElevation[this.objectId[t]];break}this.groundItemCount++}else{t&=32767;let i=0;for(let s=0;s<this.groundItemCount;s++)this.groundItemX[s]!==e||this.groundItemY[s]!==r||this.groundItemId[s]!==t?(this.groundItemX[i]=this.groundItemX[s],this.groundItemY[i]=this.groundItemY[s],this.groundItemId[i]=this.groundItemId[s],this.groundItemZ[i++]=this.groundItemZ[s]):t=-123;this.groundItemCount=i}}return}if(t===At.REGION_OBJECTS){for(let t=1;t<e;)if(255===S.getUnsignedByte(i[t])){let e=this.localRegionX+i[t+1]>>3,s=this.localRegionY+i[t+2]>>3;t+=3;let r=0;for(let t=0;t<this.objectCount;t++){let i=(this.objectX[t]>>3)-e,n=(this.objectY[t]>>3)-s;0===i&&0===n?(this.scene.removeModel(this.objectModel[t]),this.world.removeObject(this.objectX[t],this.objectY[t],this.objectId[t])):(t!==r&&(this.objectModel[r]=this.objectModel[t],this.objectModel[r].key=r,this.objectX[r]=this.objectX[t],this.objectY[r]=this.objectY[t],this.objectId[r]=this.objectId[t],this.objectDirection[r]=this.objectDirection[t]),r++)}this.objectCount=r}else{let e=S.getUnsignedShort(i,t);t+=2;let s=this.localRegionX+i[t++],r=this.localRegionY+i[t++],n=0;for(let t=0;t<this.objectCount;t++)this.objectX[t]!==s||this.objectY[t]!==r?(t!==n&&(this.objectModel[n]=this.objectModel[t],this.objectModel[n].key=n,this.objectX[n]=this.objectX[t],this.objectY[n]=this.objectY[t],this.objectId[n]=this.objectId[t],this.objectDirection[n]=this.objectDirection[t]),n++):(this.scene.removeModel(this.objectModel[t]),this.world.removeObject(this.objectX[t],this.objectY[t],this.objectId[t]));if(this.objectCount=n,6e4!==e){let t=this.world.getTileDirection(s,r),i=0,n=0;0===t||4===t?(i=Et.objectWidth[e],n=Et.objectHeight[e]):(n=Et.objectWidth[e],i=Et.objectHeight[e]);let o=(s+s+i)*this.tileSize>>1,a=(r+r+n)*this.tileSize>>1,h=Et.objectModelIndex[e],l=this.gameModels[h].copy();this.scene.addModel(l),l.key=this.objectCount,l.rotate(0,32*t,0),l.translate(o,-this.world.getElevation(o,a),a),l.createGouraudLightSource(!0,48,48,-50,-10,-50),this.world.removeObject2(s,r,e),74===e&&l.translate(0,-480,0),this.objectX[this.objectCount]=s,this.objectY[this.objectCount]=r,this.objectId[this.objectCount]=e,this.objectDirection[this.objectCount]=t,this.objectModel[this.objectCount++]=l}}return}if(t===At.INVENTORY_ITEMS){let t=1;this.inventoryItemsCount=S.getUnsignedByte(i[t++]);for(let e=0;e<this.inventoryItemsCount;e++)this.inventoryItemId[e]=32767&S.getUnsignedShort(i,t),this.inventoryEquipped[e]=S.getUnsignedShort(i,t)>>15!=0,t+=2,0===Et.itemStackable[this.inventoryItemId[e]]?(this.inventoryItemStackCount[e]=S.getSmart08_32(i,t),this.inventoryItemStackCount[e]>=128?t+=4:t+=1):this.inventoryItemStackCount[e]=1;return}if(t===At.REGION_PLAYER_UPDATE){let t=S.getUnsignedShort(i,1),e=3;t:for(let s=0;s<t;s++){let t=this.playerServer[S.getUnsignedShort(i,e)];e+=2;let s=i[e++];if(0===s){let s=S.getUnsignedShort(i,e);e+=2,t&&(t.bubble=new Kt(s))}else if(1===s){let s=i[e++];if(t){let r=this.chatSystem.decode(i.slice(e,e+s));e+=s;for(let e=0;e<ignoreList.length;e++)if(ignoreList[e]===t.hash)continue t;t.messageTimeout=ne(3),t.message=r,this.showMessage(t.name+": "+t.message,2)}}else if(2===s){let s=S.getUnsignedByte(i[e++]),r=S.getUnsignedByte(i[e++]),n=S.getUnsignedByte(i[e++]);t&&(t.damageTaken=s,t.healthCurrent=r,t.healthMax=n,t.healthTimer.tickThreshold=ne(4),t===this.localPlayer&&(this.playerStatCurrent[3]=r,this.playerStatBase[3]=n,this.welcomeBoxVisible=!1,this.serverMessageVisible=!1))}else if(3===s||4===s)t&&(t.incomingProjectileSprite=S.getUnsignedShort(i,e),3===s?(t.attackingNpcServerIndex=S.getUnsignedShort(i,e+2),t.attackingPlayerServerIndex=-1):(t.attackingPlayerServerIndex=S.getUnsignedShort(i,e+2),t.attackingNpcServerIndex=-1),t.projectileRange=this.projectileFactor),e+=4;else if(5===s)if(t){t.appearanceTicket=S.getUnsignedShort(i,e),e+=2,t.hash=S.getUnsignedLong(i,e),e+=8;let s=S.getUnsignedByte(i[e++]);for(let r=0;r<12;r++)t.equippedItem[r]=r<s?S.getUnsignedByte(i[e++]):0;t.colourHair=S.getUnsignedByte(i[e++]),t.colourTop=S.getUnsignedByte(i[e++]),t.colourBottom=S.getUnsignedByte(i[e++]),t.colourSkin=S.getUnsignedByte(i[e++]),t.level=S.getUnsignedByte(i[e++]),t.skullVisible=S.getBoolean(i[e++])}else{e+=10,e+=S.getUnsignedByte(i[e])+1}else if(6===s){let s=255&i[e++],r=this.chatSystem.decode(i.slice(e,e+s));e+=s,t&&(t.messageTimeout=ne(3),t.message=r,t===this.localPlayer&&this.showMessage(t.name+": "+t.message,5))}}return}if(t===At.REGION_WALL_OBJECTS){for(let t=1;t<e;)if(255===S.getUnsignedByte(i[t])){let e=0,s=this.localRegionX+i[t+1]>>3,r=this.localRegionY+i[t+2]>>3;t+=3;for(let t=0;t<this.wallObjectCount;t++){let i=(this.wallObjectX[t]>>3)-s,n=(this.wallObjectY[t]>>3)-r;0!==i||0!==n?(t!==e&&(this.wallObjectModel[e]=this.wallObjectModel[t],this.wallObjectModel[e].key=e+1e4,this.wallObjectX[e]=this.wallObjectX[t],this.wallObjectY[e]=this.wallObjectY[t],this.wallObjectDirection[e]=this.wallObjectDirection[t],this.wallObjectId[e]=this.wallObjectId[t]),e++):(this.scene.removeModel(this.wallObjectModel[t]),this.world.removeWallObject(this.wallObjectX[t],this.wallObjectY[t],this.wallObjectDirection[t],this.wallObjectId[t]))}this.wallObjectCount=e}else{let e=S.getUnsignedShort(i,t);t+=2;let s=this.localRegionX+i[t++],r=this.localRegionY+i[t++],n=i[t++],o=0;for(let t=0;t<this.wallObjectCount;t++)this.wallObjectX[t]!==s||this.wallObjectY[t]!==r||this.wallObjectDirection[t]!==n?(t!==o&&(this.wallObjectModel[o]=this.wallObjectModel[t],this.wallObjectModel[o].key=o+1e4,this.wallObjectX[o]=this.wallObjectX[t],this.wallObjectY[o]=this.wallObjectY[t],this.wallObjectDirection[o]=this.wallObjectDirection[t],this.wallObjectId[o]=this.wallObjectId[t]),o++):(this.scene.removeModel(this.wallObjectModel[t]),this.world.removeWallObject(this.wallObjectX[t],this.wallObjectY[t],this.wallObjectDirection[t],this.wallObjectId[t]));this.wallObjectCount=o,65535!==e&&(this.world._setObjectAdjacency_from4(s,r,n,e),this.wallObjectModel[this.wallObjectCount]=this.createBoundaryModel(s,r,n,e,this.wallObjectCount),this.wallObjectX[this.wallObjectCount]=s,this.wallObjectY[this.wallObjectCount]=r,this.wallObjectId[this.wallObjectCount]=e,this.wallObjectDirection[this.wallObjectCount++]=n)}return}if(t===At.REGION_NPCS){this.npcCacheCount=this.npcCount;for(let t=0;t<this.npcCacheCount;t++)this.npcsCache[t]=this.npcs[t];let t=8*s,r=S.getBitMask(i,t,8);t+=8,this.npcCount=0;for(let e=0;e<r;e++){let s=this.npcsCache[e];if(s){if(0!==S.getBitMask(i,t++,1)){if(0===S.getBitMask(i,t++,1)){let e=S.getBitMask(i,t,3);t+=3;let r=s.waypointCurrent,n=s.waypointsX[r],o=s.waypointsY[r];for(let t=0;t<4;t++){let i=t<2?this.tileSize:-this.tileSize;for(let s=0;s<3;s++)e===(2*t+(s+1))%8&&(t%2==0?n+=i:o+=i)}s.animationNext=e,s.waypointCurrent=r=(r+1)%10,s.waypointsX[r]=n,s.waypointsY[r]=o}else{let e=S.getBitMask(i,t,2);if(t+=2,3===e)continue;s.animationNext=e<<2|S.getBitMask(i,t,2),t+=2}}this.npcs[this.npcCount++]=s}}for(;t+34<8*e;){let e=S.getBitMask(i,t,12);t+=12;let s=S.getBitMask(i,t,5);t+=5,s>15&&(s-=32);let r=S.getBitMask(i,t,5);t+=5,r>15&&(r-=32);let n=S.getBitMask(i,t,4);t+=4;let o=(this.localRegionX+s)*this.tileSize+64,a=(this.localRegionY+r)*this.tileSize+64,h=S.getBitMask(i,t,10);t+=10,h>=Et.npcCount&&(h=24),this.addNpc(e,o,a,n,h)}return}if(t===At.REGION_NPC_UPDATE){let t=s,e=S.getUnsignedShort(i,t);if(t+=2,e<=0)return;for(let s=0;s<e;s++){if(t+3>=i.length)return void console.debug("Error updating regional NPC informations:\n\t",t+"+3>="+i.length);let e=this.npcsServer[S.getUnsignedShort(i,t)];t+=2;let s=S.getUnsignedByte(i[t++]);if(e){if(1===s){if(t+3>=i.length)return;let s=S.getUnsignedShort(i,t);t+=2;let r=S.getUnsignedByte(i[t++]);if(t+r>=i.length)return;e.message=this.chatSystem.decode(S.getBytes(i,t,r)),t+=r,e.messageTimeout=ne(3),s===this.localPlayer.serverIndex&&this.showMessage("@yel@"+Et.npcName[e.typeID]+": "+e.message,5)}else if(2===s){if(t+3>=i.length)return;e.damageTaken=S.getUnsignedByte(i[t++]),e.healthCurrent=S.getUnsignedByte(i[t++]),e.healthMax=S.getUnsignedByte(i[t++]),e.healthTimer.tickThreshold=ne(4)}}else 1===s?(t+=2,t+=S.getUnsignedByte(i[t])+1):2===s&&(t+=3)}return}if(t===At.OPTION_LIST){let t=S.getUnsignedByte(i[s++]);this.optionMenuCount=t;for(let e=0;e<t;e++){let t=S.getUnsignedByte(i[s++]);this.optionMenuEntry[e]=this.chatSystem.decode(S.getBytes(i,s,t)),s+=t}return void(this.showOptionMenu=!0)}if(t===At.OPTION_LIST_CLOSE)return void(this.showOptionMenu=!1);if(t===At.WORLD_INFO)return this.loadingArea=!0,this.localPlayerServerIndex=S.getUnsignedShort(i,s),s+=2,this.planeWidth=S.getUnsignedShort(i,s),s+=2,this.planeHeight=S.getUnsignedShort(i,s),s+=2,this.planeIndex=S.getUnsignedShort(i,s),s+=2,this.planeMultiplier=S.getUnsignedShort(i,s),s+=2,void(this.planeHeight-=this.planeIndex*this.planeMultiplier);if(t===At.PLAYER_STAT_LIST){for(let t=0;t<this.playerStatCount;t++)this.playerStatCurrent[t]=S.getUnsignedByte(i[s++]);for(let t=0;t<this.playerStatCount;t++)this.playerStatBase[t]=S.getUnsignedByte(i[s++]);for(let t=0;t<this.playerStatCount;t++)this.playerExperience[t]=S.getUnsignedInt(i,s),s+=4;return void(this.playerQuestPoints=S.getUnsignedByte(i[s++]))}if(t===At.PLAYER_STAT_EQUIPMENT_BONUS){for(let t=1;t<=this.playerStatEquipmentCount;t++)this.playerStatEquipment[t-1]=S.getUnsignedByte(i[t]);return}if(t===At.PLAYER_DIED)return void(this.deathScreenTimeout=ne(5));if(t===At.REGION_ENTITY_UPDATE){let t=Math.floor((e-1)/4);for(let e=0;e<t;e++){let t=this.localRegionX+S.getSignedShort(i,s)>>3;s+=2;let e=this.localRegionY+S.getSignedShort(i,s)>>3;s+=2;let r=0;for(let i=0;i<this.groundItemCount;i++){let s=(this.groundItemX[i]>>3)-t,n=(this.groundItemY[i]>>3)-e;0===s&&0===n||(i!==r&&(this.groundItemX[r]=this.groundItemX[i],this.groundItemY[r]=this.groundItemY[i],this.groundItemId[r]=this.groundItemId[i],this.groundItemZ[r]=this.groundItemZ[i]),r++)}this.groundItemCount=r,r=0;for(let i=0;i<this.objectCount;i++){let s=(this.objectX[i]>>3)-t,n=(this.objectY[i]>>3)-e;0!==s||0!==n?(i!==r&&(this.objectModel[r]=this.objectModel[i],this.objectModel[r].key=r,this.objectX[r]=this.objectX[i],this.objectY[r]=this.objectY[i],this.objectId[r]=this.objectId[i],this.objectDirection[r]=this.objectDirection[i]),r++):(this.scene.removeModel(this.objectModel[i]),this.world.removeObject(this.objectX[i],this.objectY[i],this.objectId[i]))}this.objectCount=r,r=0;for(let i=0;i<this.wallObjectCount;i++){let s=(this.wallObjectX[i]>>3)-t,n=(this.wallObjectY[i]>>3)-e;0!==s||0!==n?(i!==r&&(this.wallObjectModel[r]=this.wallObjectModel[i],this.wallObjectModel[r].key=r+1e4,this.wallObjectX[r]=this.wallObjectX[i],this.wallObjectY[r]=this.wallObjectY[i],this.wallObjectDirection[r]=this.wallObjectDirection[i],this.wallObjectId[r]=this.wallObjectId[i]),r++):(this.scene.removeModel(this.wallObjectModel[i]),this.world.removeWallObject(this.wallObjectX[i],this.wallObjectY[i],this.wallObjectDirection[i],this.wallObjectId[i]))}this.wallObjectCount=r}return}if(t===At.APPEARANCE)return void(this.showAppearanceChange=!0);if(t===At.TRADE_OPEN){let t=S.getUnsignedShort(i,s);return s+=2,this.playerServer[t]&&(this.tradeRecipientName=this.playerServer[t].name),this.tradeConfigVisible=!0,this.tradeRecipientAccepted=!1,this.tradeAccepted=!1,this.tradeItemsCount=0,this.tradeRecipientItemList=[],this.tradeRecipientItems=[],void(this.tradeRecipientItemsCount=0)}if(t===At.TRADE_CLOSE)return this.tradeConfigVisible=!1,void(this.tradeConfirmVisible=!1);if(t===At.TRADE_ITEMS){this.tradeRecipientItemsCount=S.getUnsignedByte(i[1]);let t=2;for(let e=0;e<this.tradeRecipientItemsCount;e++)this.tradeRecipientItems[e]=S.getUnsignedShort(i,t),t+=2,this.tradeRecipientItemCount[e]=S.getUnsignedInt(i,t),t+=4;return this.tradeRecipientAccepted=!1,void(this.tradeAccepted=!1)}if(t===At.TRADE_RECIPIENT_STATUS)return void(this.tradeRecipientAccepted=S.getBoolean(i[1]));if(t===At.SHOP_OPEN){this.shopVisible=!0;let t=1,e=S.getUnsignedByte(i[t++]),s=S.getUnsignedByte(i[t++]);this.shopSellPriceMod=S.getUnsignedByte(i[t++]),this.shopBuyPriceMod=S.getUnsignedByte(i[t++]);for(let t=0;t<40;t++)this.shopItem[t]=-1;for(let s=0;s<e;s++)this.shopItem[s]=S.getUnsignedShort(i,t),t+=2,this.shopItemCount[s]=S.getUnsignedShort(i,t),t+=2,this.shopItemPrice[s]=i[t++];if(1===s){let t=39;for(let i=0;i<this.inventoryItemsCount&&!(t<e);i++){let e=!1;for(let t=0;t<40;t++)if(this.shopItem[t]===this.inventoryItemId[i]){e=!0;break}10===this.inventoryItemId[i]&&(e=!0),e||(this.shopItem[t]=32767&this.inventoryItemId[i],this.shopItemCount[t]=0,this.shopItemPrice[t]=0,t--)}}return void(this.shopSelectedItemIndex>=0&&this.shopSelectedItemIndex<40&&this.shopItem[this.shopSelectedItemIndex]!==this.shopSelectedItemType&&(this.shopSelectedItemIndex=-1,this.shopSelectedItemType=-2))}if(t===At.SHOP_CLOSE)return void(this.shopVisible=!1);if(t===At.TRADE_STATUS)return void(this.tradeAccepted=S.getBoolean(i[1]));if(t===At.GAME_SETTINGS)return this.optionCameraModeAuto=S.getBoolean(i[1]),this.optionMouseButtonOne=S.getBoolean(i[2]),void(this.optionSoundDisabled=S.getBoolean(i[3]));if(t===At.PRAYER_STATUS){for(let t=0;t<e-1;t++)this.prayers[t]-S.getUnsignedByte(i[s++])!=0&&(this.playSoundFile("ff"),this.prayers[t]=!this.prayers[t]);return}if(t===At.PLAYER_QUEST_LIST){for(let t=1;t<this.questCount+1;t++)this.questComplete[t-1]=S.getBoolean(i[t]);return}if(t===At.BANK_OPEN){this.bankVisible=!0,this.newBankItemCount=S.getUnsignedByte(i[s++]),this.bankItemsMax=S.getUnsignedByte(i[s++]);for(let t=0;t<this.newBankItemCount;t++)this.newBankItems[t]=S.getUnsignedShort(i,s),s+=2,this.newBankItemsCount[t]=S.getSmart08_32(i,s),this.newBankItemsCount[t]>=128?s+=4:s++;return void this.updateBankItems()}if(t===At.BANK_CLOSE)return void(this.bankVisible=!1);if(t===At.PLAYER_STAT_EXPERIENCE_UPDATE)return void(this.playerExperience[S.getUnsignedByte(i[1])]=S.getUnsignedInt(i,2));if(t===At.DUEL_OPEN){let t=S.getUnsignedShort(i,1);this.playerServer[t]&&(this.duelOpponentName=this.playerServer[t].name),this.duelConfigVisible=!0,this.duelOfferOpponentAccepted=!1;for(let t=0;t<this.duelOfferOpponentItemsCount;t++)this.duelOfferOpponentItemList=ae(this.duelOfferOpponentItemList,this.duelOfferOpponentItemList[t]);this.duelOfferOpponentItemCount=0;for(let t=0;t<this.duelOfferItemsCount;t++)this.duelOfferItemList=ae(this.duelOfferItemList,this.duelOfferItemList[t]);this.duelOfferItemCount=0;for(let t=0;t<this.duelItemsCount;t++)this.duelItemList=ae(this.duelItemList,this.duelItemList[t]);this.duelItemsCount=0;for(let t=0;t<this.duelOpponentItemsCount;t++)this.duelOpponentItemList=ae(this.duelOpponentItemList,this.duelOpponentItemList[t]);return this.duelOpponentItemsCount=0,this.duelOfferAccepted=!1,this.duelSettingsRetreat=!1,this.duelSettingsMagic=!1,this.duelSettingsPrayer=!1,void(this.duelSettingsWeapons=!1)}if(t===At.DUEL_CLOSE){this.duelConfigVisible=!1,this.duelConfirmVisible=!1;for(let t=0;t<this.duelOfferOpponentItemsCount;t++)this.duelOfferOpponentItemList=ae(this.duelOfferOpponentItemList,this.duelOfferOpponentItemList[t]);this.duelOfferOpponentItemCount=0;for(let t=0;t<this.duelOfferItemsCount;t++)this.duelOfferItemList=ae(this.duelOfferItemList,this.duelOfferItemList[t]);this.duelOfferItemCount=0;for(let t=0;t<this.duelItemsCount;t++)this.duelItemList=ae(this.duelItemList,this.duelItemList[t]);this.duelItemsCount=0;for(let t=0;t<this.duelOpponentItemsCount;t++)this.duelOpponentItemList=ae(this.duelOpponentItemList,this.duelOpponentItemList[t]);return void(this.duelOpponentItemsCount=0)}if(t===At.TRADE_CONFIRM_OPEN){this.tradeConfirmVisible=!0,this.tradeConfirmAccepted=!1,this.tradeConfigVisible=!1;let t=1;this.tradeRecipientConfirmHash=S.getUnsignedLong(i,t),t+=8,this.tradeRecipientConfirmItemsCount=S.getUnsignedByte(i[t++]);for(let e=0;e<this.tradeRecipientConfirmItemsCount;e++)this.tradeRecipientConfirmItems[e]=S.getUnsignedShort(i,t),t+=2,this.tradeRecipientConfirmItemCount[e]=S.getUnsignedInt(i,t),t+=4,kj;this.tradeConfirmItemsCount=S.getUnsignedByte(i[t++]);for(let e=0;e<this.tradeConfirmItemsCount;e++)this.tradeConfirmItems[e]=S.getUnsignedShort(i,t),t+=2,this.tradeConfirmItemCount[e]=S.getUnsignedInt(i,t),t+=4;return}if(t===At.DUEL_UPDATE){let t=1;this.duelOfferOpponentItemList=new Array(8),this.duelOfferOpponentItemCount=S.getUnsignedByte(i[t++]);for(let e=0;e<=this.duelOfferOpponentItemCount;e++)this.duelOfferOpponentItemList[e]={id:S.getUnsignedShort(i,t),amount:S.getUnsignedInt(i,t+2)},t+=6;return this.duelOfferOpponentAccepted=!1,void(this.duelOfferAccepted=!1)}if(t===At.DUEL_SETTINGS)return this.duelSettingsRetreat=S.getBoolean(i[s++]),this.duelSettingsMagic=S.getBoolean(i[s++]),this.duelSettingsPrayer=S.getBoolean(i[s++]),this.duelSettingsWeapons=S.getBoolean(i[s++]),this.duelOfferOpponentAccepted=!1,void(this.duelOfferAccepted=!1);if(t===At.BANK_UPDATE){let t=S.getUnsignedByte(i[s++]),e=S.getUnsignedShort(i,s);s+=2;let r=S.getSmart08_32(i,s);if(r>=128?s+=4:s++,r<=0){this.newBankItemCount--;for(let e=t;e<this.newBankItemCount;e++)this.newBankItems[e]=this.newBankItems[e+1],this.newBankItemsCount[e]=this.newBankItemsCount[e+1]}else this.newBankItems[t]=e,this.newBankItemsCount[t]=r,t>=this.newBankItemCount&&(this.newBankItemCount=t+1);return void this.updateBankItems()}if(t===At.INVENTORY_ITEM_UPDATE){let t=1,e=S.getUnsignedByte(i[t++]),s=S.getUnsignedShort(i,t);t+=2;let r=1;return 0===Et.itemStackable[32767&s]&&(r=S.getSmart08_32(i,t),r>=128?t+=4:t++),this.inventoryItemId[e]=32767&s,this.inventoryEquipped[e]=(32768&s)>>15!=0,this.inventoryItemStackCount[e]=r,void(e>=this.inventoryItemsCount&&(this.inventoryItemsCount=e+1))}if(t===At.INVENTORY_ITEM_REMOVE){for(let t=S.getUnsignedByte(i[s++]);t<this.inventoryItemsCount-1;t++)this.inventoryItemId[t]=this.inventoryItemId[t+1],this.inventoryItemStackCount[t]=this.inventoryItemStackCount[t+1],this.inventoryEquipped[t]=this.inventoryEquipped[t+1];return void this.inventoryItemsCount--}if(t===At.PLAYER_STAT_UPDATE){let t=S.getUnsignedByte(i[s++]);return this.playerStatCurrent[t]=S.getUnsignedByte(i[s++]),this.playerStatBase[t]=S.getUnsignedByte(i[s++]),this.playerExperience[t]=S.getUnsignedInt(i,s),void(s+=4)}if(t===At.DUEL_OPPONENT_ACCEPTED)return void(this.duelOfferOpponentAccepted=S.getBoolean(i[s++]));if(t===At.DUEL_ACCEPTED)return void(this.duelOfferAccepted=S.getBoolean(i[s++]));if(t===At.DUEL_CONFIRM_OPEN){this.duelConfirmVisible=!0,this.duelAccepted=!1,this.duelConfigVisible=!1,this.duelOpponentNameHash=S.getUnsignedLong(i,s),s+=8,this.duelOpponentItemsCount=S.getUnsignedByte(i[s++]);for(let t=0;t<=this.duelOpponentItemsCount;t++)this.duelOpponentItemList.push({id:S.getUnsignedShort(i,s),amount:S.getUnsignedInt(i,s+2)}),s+=6;this.duelItemsCount=S.getUnsignedByte(i[s++]);for(let t=0;t<=this.duelItemsCount;t++)this.duelItemList.push({id:S.getUnsignedShort(i,s),amount:S.getUnsignedInt(i,s+2)}),s+=6;return this.duelOptionRetreat=S.getBoolean(i[s++]),this.duelOptionMagic=S.getBoolean(i[s++]),this.duelOptionPrayer=S.getBoolean(i[s++]),void(this.duelOptionWeapons=S.getBoolean(i[s++]))}if(t===At.SOUND)return void this.playSoundFile(this.chatSystem.decode(i.slice(s)));if(t===At.TELEPORT_BUBBLE){for(let t=1;this.teleportBubbleCount++<50&&t+3<i.length;t+=3)this.teleportBubbleTime[this.teleportBubbleCount]=0,this.teleportBubbleType[this.teleportBubbleCount]=S.getUnsignedByte(i[t]),this.teleportBubbleX[this.teleportBubbleCount]=i[t+1]+this.localRegionX,this.teleportBubbleY[this.teleportBubbleCount++]=i[t+2]+this.localRegionY;return}return t===At.WELCOME?void(this.welcomed||(this.welcomed=!0,this.lastRemoteIP=S.getUnsignedInt(i,1),this.daysSinceLogin=S.getUnsignedShort(i,5),this.welcomeRecoverySetDays=S.getUnsignedByte(i[7]),this.unreadMessageCount=S.getUnsignedShort(i,8),this.lastRemoteHost=this.getHostnameIP(this.lastRemoteIP),this.welcomeBoxVisible=!0)):t===At.SERVER_MESSAGE_ONTOP||t===At.SERVER_MESSAGE?(this.serverMessage=this.chatSystem.decode(i.slice(s)),this.showDialogServermessage=!0,void(this.serverMessageBoxTop=t===At.SERVER_MESSAGE_ONTOP)):t===At.PLAYER_STAT_FATIGUE?(this.statFatigue=S.getUnsignedShort(i,s),void(s+=2)):t===At.PLAYER_STAT_FATIGUE_ASLEEP?(this.fatigueSleeping=S.getUnsignedShort(i,s),void(s+=2)):t===At.SLEEP_OPEN?(this.isSleeping||(this.fatigueSleeping=this.statFatigue),this.isSleeping=!0,this.inputTextCurrent="",this.inputTextFinal="",this.surface.readSleepWord(this.spriteTexture+1,i),void(this.sleepingStatusText=void 0)):t===At.SLEEP_CLOSE?void(this.isSleeping=!1):t===At.SLEEP_INCORRECT?void(this.sleepingStatusText="Incorrect - Please wait..."):t===At.SYSTEM_UPDATE?void(this.systemUpdate=32*S.getUnsignedShort(i,s)):t===At.COMBAT_POINTS?(this.combatPoints=S.getUnsignedInt(i,s),void(s+=4)):void console.log("unhandled packet: "+t,",\tsize:",e)}catch(s){if(console.error(s),this.packetErrorCount<3){let r=s.stack,n=r.length;this.clientStream.newPacket(It.PACKET_EXCEPTION),this.clientStream.putShort(n),this.clientStream.putString(r),this.clientStream.putShort(n=(r="p-type: "+t+", p-size:"+e).length),this.clientStream.putString(r),this.clientStream.putShort(n=(r="rx:"+this.localRegionX+" ry:"+this.localRegionY+" num3l:"+this.objectCount).length),this.clientStream.putString(r),r="";for(let t=0;t<80&&t<e;t++)r=r+i[t]+" ";this.clientStream.putShort(r.length),this.clientStream.putString(r),this.clientStream.sendPacket(),this.packetErrorCount++}this.clientStream.closeStream(),this.resetLoginVars()}}renderStatsTab(t){let e=this.surface.width2-199;this.surface.drawSpriteID(e-49,3,this.spriteMedia+3);let i=0,s=i=dt.rgbToLong(160,160,160);if(0===this.uiTabPlayerInfoSubTab?s=dt.rgbToLong(220,220,220):i=dt.rgbToLong(220,220,220),this.surface.drawBoxAlpha(e,36,Math.floor(98),24,s,128),this.surface.drawBoxAlpha(e+Math.floor(98),36,98,24,i,128),this.surface.drawBoxAlpha(e,60,196,251,dt.rgbToLong(220,220,220),128),this.surface.drawLineHoriz(e,60,196,0),this.surface.drawLineVert(e+Math.floor(98),36,24,0),this.surface.drawStringCenter("Stats",e+Math.floor(49),52,4,0),this.surface.drawStringCenter("Quests",e+Math.floor(49)+Math.floor(98),52,4,0),0===this.uiTabPlayerInfoSubTab){let t=72,i=-1;this.surface.drawString("Skills",e+5,t,3,16776960),t+=13;for(let s=0;s<9;s++){let r=16777215;this.mouseX>e+3&&this.mouseY>=t-11&&this.mouseY<t+2&&this.mouseX<e+90&&(r=16711680,i=s),this.surface.drawString(this.skillNameShort[s]+":@yel@"+this.playerStatCurrent[s]+"/"+this.playerStatBase[s],e+5,t,1,r),r=16777215,this.mouseX>=e+90&&this.mouseY>=t-13-11&&this.mouseY<t-13+2&&this.mouseX<e+196&&(r=16711680,i=s+9),this.surface.drawString(this.skillNameShort[s+9]+":@yel@"+this.playerStatCurrent[s+9]+"/"+this.playerStatBase[s+9],e+Math.floor(98)-5,t-13,1,r),t+=13}this.surface.drawString("Quest Points:@yel@"+this.playerQuestPoints,e+Math.floor(98)-5,t-13,1,16777215),t+=12,this.surface.drawString("Fatigue: @yel@"+Math.floor(100*this.statFatigue/750)+"%",e+5,t-13,1,16777215),t+=8,this.surface.drawString("Equipment Status",e+5,t,3,16776960),t+=12;for(let i=0;i<3;i++)this.surface.drawString(this.equipmentStatNames[i]+":@yel@"+this.playerStatEquipment[i],e+5,t,1,16777215),i<2&&this.surface.drawString(this.equipmentStatNames[i+3]+":@yel@"+this.playerStatEquipment[i+3],e+Math.floor(98)+25,t,1,16777215),t+=13;if(t+=6,this.surface.drawLineHoriz(e,t-15,196,0),-1!==i){this.surface.drawString(this.skillNamesLong[i]+" skill",e+5,t,1,16776960),t+=12;let s=he.experienceTable[0];for(let t=0;t<199;t++)this.playerExperience[i]>=he.experienceTable[t]/4&&(s=he.experienceTable[t+1]);this.surface.drawString("Total xp: "+Math.floor(this.playerExperience[i]),e+5,t,1,16777215),t+=12,this.surface.drawString("Next level at: "+s/4,e+5,t,1,16777215)}else{this.surface.drawString("Overall levels",e+5,t,1,16776960),t+=12;let i=0;for(let t=0;t<this.playerStatCount;t++)i+=this.playerStatBase[t];this.surface.drawString("Skill total: "+i,e+5,t,1,16777215),t+=12,this.surface.drawString("Combat level: "+this.localPlayer.level,e+5,t,1,16777215),t+=12}}else if(1===this.uiTabPlayerInfoSubTab){this.panelQuestList.clearList(this.controlListQuest),this.panelQuestList.addListEntry(this.controlListQuest,0,"@whi@Quest-list (green=completed)");for(let t=0;t<this.questCount;t++)this.panelQuestList.addListEntry(this.controlListQuest,t+1,(this.questComplete[t]?"@gre@":"@red@")+this.questName[t]);this.panelQuestList.render()}if(!t)return;let r=this.mouseX-(this.surface.width2-199),n=this.mouseY-36;if(r>=0&&n>=0&&r<196&&n<275&&(1===this.uiTabPlayerInfoSubTab&&this.panelQuestList.handleMouse(r+(this.surface.width2-199),n+36,this.lastMouseButtonDown,this.mouseButtonDown,this.mouseScrollDelta),n<=24&&1===this.mouseButtonClick)){if(r<98)return void(this.uiTabPlayerInfoSubTab=0);r>98&&(this.uiTabPlayerInfoSubTab=1)}}populateContextMenu(){let t=2203-(this.localRegionY+this.planeHeight+this.regionY);this.localRegionX+this.planeWidth+this.regionX>=2640&&(t=-50);let e=-1;for(let t=0;t<this.objectCount;t++)this.objectAlreadyInMenu[t]=!1;for(let t=0;t<this.wallObjectCount;t++)this.wallObjectAlreadyInMenu[t]=!1;let i=this.scene.getMousePickedCount(),s=this.scene.getMousePickedModels(),r=this.scene.getMousePickedFaces();for(let n=0;n<i&&!(this.menuItemsCount>200);n++){let i=r[n],o=s[n];if(o.faceTag[i]<=65535||o.faceTag[i]>=2e5&&o.faceTag[i]<=3e5)if(o===this.scene.view){let e=o.faceTag[i]%1e4,s=Math.floor(o.faceTag[i]/1e4);if(1===s){let i="",s=this.localPlayer.level-this.players[e].level;0===this.localPlayer.level||0===this.players[e].level?i="@whi@":s<0?i="@or1@":s<-3?i="@or2@":s<-6?i="@or3@":s<-9?i="@red@":s>0?i="@gr1@":s>3?i="@gr2@":s>6?i="@gr3@":s>9&&(i="@gre@");let r=` ${i}(level-${this.players[e].level})`;this.selectedSpell>=0?1!==Et.spellType[this.selectedSpell]&&2!==Et.spellType[this.selectedSpell]||(this.menuItemText1[this.menuItemsCount]="Cast "+Et.spellName[this.selectedSpell]+" on",this.menuItemText2[this.menuItemsCount]="@whi@"+this.players[e].name+r,this.menuItemID[this.menuItemsCount]=800,this.menuItemX[this.menuItemsCount]=this.players[e].currentX,this.menuItemY[this.menuItemsCount]=this.players[e].currentY,this.menuSourceType[this.menuItemsCount]=this.players[e].serverIndex,this.menuSourceIndex[this.menuItemsCount]=this.selectedSpell,this.menuItemsCount++):this.selectedItemInventoryIndex>=0?(this.menuItemText1[this.menuItemsCount]="Use "+this.selectedItemName+" with",this.menuItemText2[this.menuItemsCount]="@whi@"+this.players[e].name+r,this.menuItemID[this.menuItemsCount]=810,this.menuItemX[this.menuItemsCount]=this.players[e].currentX,this.menuItemY[this.menuItemsCount]=this.players[e].currentY,this.menuSourceType[this.menuItemsCount]=this.players[e].serverIndex,this.menuSourceIndex[this.menuItemsCount]=this.selectedItemInventoryIndex,this.menuItemsCount++):(t>0&&Math.floor((this.players[e].currentY-64)/this.tileSize+this.planeHeight+this.regionY)<2203?(this.menuItemText1[this.menuItemsCount]="Attack",this.menuItemText2[this.menuItemsCount]="@whi@"+this.players[e].name+r,this.menuItemID[this.menuItemsCount]=s>=0&&s<5?805:2805,this.menuItemX[this.menuItemsCount]=this.players[e].currentX,this.menuItemY[this.menuItemsCount]=this.players[e].currentY,this.menuSourceType[this.menuItemsCount]=this.players[e].serverIndex,this.menuItemsCount++):this.members&&(this.menuItemText1[this.menuItemsCount]="Duel with",this.menuItemText2[this.menuItemsCount]="@whi@"+this.players[e].name+r,this.menuItemX[this.menuItemsCount]=this.players[e].currentX,this.menuItemY[this.menuItemsCount]=this.players[e].currentY,this.menuItemID[this.menuItemsCount]=2806,this.menuSourceType[this.menuItemsCount]=this.players[e].serverIndex,this.menuItemsCount++),this.menuItemText1[this.menuItemsCount]="Trade with",this.menuItemText2[this.menuItemsCount]="@whi@"+this.players[e].name+r,this.menuItemID[this.menuItemsCount]=2810,this.menuSourceType[this.menuItemsCount]=this.players[e].serverIndex,this.menuItemsCount++,this.menuItemText1[this.menuItemsCount]="Follow",this.menuItemText2[this.menuItemsCount]="@whi@"+this.players[e].name+r,this.menuItemID[this.menuItemsCount]=2820,this.menuSourceType[this.menuItemsCount]=this.players[e].serverIndex,this.menuItemsCount++)}else if(2===s)this.selectedSpell>=0?3===Et.spellType[this.selectedSpell]&&(this.menuItemText1[this.menuItemsCount]="Cast "+Et.spellName[this.selectedSpell]+" on",this.menuItemText2[this.menuItemsCount]="@lre@"+Et.itemName[this.groundItemId[e]],this.menuItemID[this.menuItemsCount]=200,this.menuItemX[this.menuItemsCount]=this.groundItemX[e],this.menuItemY[this.menuItemsCount]=this.groundItemY[e],this.menuSourceType[this.menuItemsCount]=this.groundItemId[e],this.menuSourceIndex[this.menuItemsCount]=this.selectedSpell,this.menuItemsCount++):this.selectedItemInventoryIndex>=0?(this.menuItemText1[this.menuItemsCount]="Use "+this.selectedItemName+" with",this.menuItemText2[this.menuItemsCount]="@lre@"+Et.itemName[this.groundItemId[e]],this.menuItemID[this.menuItemsCount]=210,this.menuItemX[this.menuItemsCount]=this.groundItemX[e],this.menuItemY[this.menuItemsCount]=this.groundItemY[e],this.menuSourceType[this.menuItemsCount]=this.groundItemId[e],this.menuSourceIndex[this.menuItemsCount]=this.selectedItemInventoryIndex,this.menuItemsCount++):(this.menuItemText1[this.menuItemsCount]="Take",this.menuItemText2[this.menuItemsCount]="@lre@"+Et.itemName[this.groundItemId[e]],this.menuItemID[this.menuItemsCount]=220,this.menuItemX[this.menuItemsCount]=this.groundItemX[e],this.menuItemY[this.menuItemsCount]=this.groundItemY[e],this.menuSourceType[this.menuItemsCount]=this.groundItemId[e],this.menuItemsCount++,this.menuItemText1[this.menuItemsCount]="Examine",this.menuItemText2[this.menuItemsCount]="@lre@"+Et.itemName[this.groundItemId[e]],this.menuItemID[this.menuItemsCount]=3200,this.menuSourceType[this.menuItemsCount]=this.groundItemId[e],this.menuItemsCount++);else if(3===s){let t="",i=-1,s=this.npcs[e].typeID;if(Et.npcAttackable[s]>0){let e=Math.floor((Et.npcAttack[s]+Et.npcDefense[s]+Et.npcStrength[s]+Et.npcHits[s])/4);i=Math.floor((this.playerStatBase[0]+this.playerStatBase[1]+this.playerStatBase[2]+this.playerStatBase[3]+27)/4)-e,t="@yel@",i<0&&(t="@or1@"),i<-3&&(t="@or2@"),i<-6&&(t="@or3@"),i<-9&&(t="@red@"),i>0&&(t="@gr1@"),i>3&&(t="@gr2@"),i>6&&(t="@gr3@"),i>9&&(t="@gre@"),t=" "+t+"(level-"+e+")"}this.selectedSpell>=0?2===Et.spellType[this.selectedSpell]&&(this.menuItemText1[this.menuItemsCount]="Cast "+Et.spellName[this.selectedSpell]+" on",this.menuItemText2[this.menuItemsCount]="@yel@"+Et.npcName[this.npcs[e].typeID],this.menuItemID[this.menuItemsCount]=700,this.menuItemX[this.menuItemsCount]=this.npcs[e].currentX,this.menuItemY[this.menuItemsCount]=this.npcs[e].currentY,this.menuSourceType[this.menuItemsCount]=this.npcs[e].serverIndex,this.menuSourceIndex[this.menuItemsCount]=this.selectedSpell,this.menuItemsCount++):this.selectedItemInventoryIndex>=0?(this.menuItemText1[this.menuItemsCount]="Use "+this.selectedItemName+" with",this.menuItemText2[this.menuItemsCount]="@yel@"+Et.npcName[this.npcs[e].typeID],this.menuItemID[this.menuItemsCount]=710,this.menuItemX[this.menuItemsCount]=this.npcs[e].currentX,this.menuItemY[this.menuItemsCount]=this.npcs[e].currentY,this.menuSourceType[this.menuItemsCount]=this.npcs[e].serverIndex,this.menuSourceIndex[this.menuItemsCount]=this.selectedItemInventoryIndex,this.menuItemsCount++):(Et.npcAttackable[s]>0&&(this.menuItemText1[this.menuItemsCount]="Attack",this.menuItemText2[this.menuItemsCount]="@yel@"+Et.npcName[this.npcs[e].typeID]+t,this.menuItemID[this.menuItemsCount]=i>=0?715:2715,this.menuItemX[this.menuItemsCount]=this.npcs[e].currentX,this.menuItemY[this.menuItemsCount]=this.npcs[e].currentY,this.menuSourceType[this.menuItemsCount]=this.npcs[e].serverIndex,this.menuItemsCount++),this.menuItemText1[this.menuItemsCount]="Talk-to",this.menuItemText2[this.menuItemsCount]="@yel@"+Et.npcName[this.npcs[e].typeID],this.menuItemID[this.menuItemsCount]=720,this.menuItemX[this.menuItemsCount]=this.npcs[e].currentX,this.menuItemY[this.menuItemsCount]=this.npcs[e].currentY,this.menuSourceType[this.menuItemsCount]=this.npcs[e].serverIndex,this.menuItemsCount++,""!==Et.npcCommand[s]&&(this.menuItemText1[this.menuItemsCount]=Et.npcCommand[s],this.menuItemText2[this.menuItemsCount]="@yel@"+Et.npcName[this.npcs[e].typeID],this.menuItemID[this.menuItemsCount]=725,this.menuItemX[this.menuItemsCount]=this.npcs[e].currentX,this.menuItemY[this.menuItemsCount]=this.npcs[e].currentY,this.menuSourceType[this.menuItemsCount]=this.npcs[e].serverIndex,this.menuItemsCount++),this.menuItemText1[this.menuItemsCount]="Examine",this.menuItemText2[this.menuItemsCount]="@yel@"+Et.npcName[this.npcs[e].typeID],this.menuItemID[this.menuItemsCount]=3700,this.menuSourceType[this.menuItemsCount]=this.npcs[e].typeID,this.menuItemsCount++)}}else if(o&&o.key>=1e4){let t=o.key-1e4,e=this.wallObjectId[t];this.wallObjectAlreadyInMenu[t]||(this.selectedSpell>=0?4===Et.spellType[this.selectedSpell]&&(this.menuItemText1[this.menuItemsCount]="Cast "+Et.spellName[this.selectedSpell]+" on",this.menuItemText2[this.menuItemsCount]="@cya@"+Et.wallObjectName[e],this.menuItemID[this.menuItemsCount]=300,this.menuItemX[this.menuItemsCount]=this.wallObjectX[t],this.menuItemY[this.menuItemsCount]=this.wallObjectY[t],this.menuSourceType[this.menuItemsCount]=this.wallObjectDirection[t],this.menuSourceIndex[this.menuItemsCount]=this.selectedSpell,this.menuItemsCount++):this.selectedItemInventoryIndex>=0?(this.menuItemText1[this.menuItemsCount]="Use "+this.selectedItemName+" with",this.menuItemText2[this.menuItemsCount]="@cya@"+Et.wallObjectName[e],this.menuItemID[this.menuItemsCount]=310,this.menuItemX[this.menuItemsCount]=this.wallObjectX[t],this.menuItemY[this.menuItemsCount]=this.wallObjectY[t],this.menuSourceType[this.menuItemsCount]=this.wallObjectDirection[t],this.menuSourceIndex[this.menuItemsCount]=this.selectedItemInventoryIndex,this.menuItemsCount++):(/^WalkTo$/i.test(Et.wallObjectCommand1[e])||(this.menuItemText1[this.menuItemsCount]=Et.wallObjectCommand1[e],this.menuItemText2[this.menuItemsCount]="@cya@"+Et.wallObjectName[e],this.menuItemID[this.menuItemsCount]=320,this.menuItemX[this.menuItemsCount]=this.wallObjectX[t],this.menuItemY[this.menuItemsCount]=this.wallObjectY[t],this.menuSourceType[this.menuItemsCount]=this.wallObjectDirection[t],this.menuItemsCount++),/^Examine$/i.test(Et.wallObjectCommand2[e])||(this.menuItemText1[this.menuItemsCount]=Et.wallObjectCommand2[e],this.menuItemText2[this.menuItemsCount]="@cya@"+Et.wallObjectName[e],this.menuItemID[this.menuItemsCount]=2300,this.menuItemX[this.menuItemsCount]=this.wallObjectX[t],this.menuItemY[this.menuItemsCount]=this.wallObjectY[t],this.menuSourceType[this.menuItemsCount]=this.wallObjectDirection[t],this.menuItemsCount++),this.menuItemText1[this.menuItemsCount]="Examine",this.menuItemText2[this.menuItemsCount]="@cya@"+Et.wallObjectName[e],this.menuItemID[this.menuItemsCount]=3300,this.menuSourceType[this.menuItemsCount]=e,this.menuItemsCount++),this.wallObjectAlreadyInMenu[t]=!0)}else if(o&&o.key>=0){let t=o.key,e=this.objectId[t];this.objectAlreadyInMenu[t]||(this.selectedSpell>=0?5===Et.spellType[this.selectedSpell]&&(this.menuItemText1[this.menuItemsCount]="Cast "+Et.spellName[this.selectedSpell]+" on",this.menuItemText2[this.menuItemsCount]="@cya@"+Et.objectName[e],this.menuItemID[this.menuItemsCount]=400,this.menuItemX[this.menuItemsCount]=this.objectX[t],this.menuItemY[this.menuItemsCount]=this.objectY[t],this.menuSourceType[this.menuItemsCount]=this.objectDirection[t],this.menuSourceIndex[this.menuItemsCount]=this.objectId[t],this.menuTargetIndex[this.menuItemsCount]=this.selectedSpell,this.menuItemsCount++):this.selectedItemInventoryIndex>=0?(this.menuItemText1[this.menuItemsCount]="Use "+this.selectedItemName+" with",this.menuItemText2[this.menuItemsCount]="@cya@"+Et.objectName[e],this.menuItemID[this.menuItemsCount]=410,this.menuItemX[this.menuItemsCount]=this.objectX[t],this.menuItemY[this.menuItemsCount]=this.objectY[t],this.menuSourceType[this.menuItemsCount]=this.objectDirection[t],this.menuSourceIndex[this.menuItemsCount]=this.objectId[t],this.menuTargetIndex[this.menuItemsCount]=this.selectedItemInventoryIndex,this.menuItemsCount++):(/^WalkTo$/i.test(Et.objectCommand1[e])||(this.menuItemText1[this.menuItemsCount]=Et.objectCommand1[e],this.menuItemText2[this.menuItemsCount]="@cya@"+Et.objectName[e],this.menuItemID[this.menuItemsCount]=420,this.menuItemX[this.menuItemsCount]=this.objectX[t],this.menuItemY[this.menuItemsCount]=this.objectY[t],this.menuSourceType[this.menuItemsCount]=this.objectDirection[t],this.menuSourceIndex[this.menuItemsCount]=this.objectId[t],this.menuItemsCount++),/^Examine$/i.test(Et.objectCommand2[e])||(this.menuItemText1[this.menuItemsCount]=Et.objectCommand2[e],this.menuItemText2[this.menuItemsCount]="@cya@"+Et.objectName[e],this.menuItemID[this.menuItemsCount]=2400,this.menuItemX[this.menuItemsCount]=this.objectX[t],this.menuItemY[this.menuItemsCount]=this.objectY[t],this.menuSourceType[this.menuItemsCount]=this.objectDirection[t],this.menuSourceIndex[this.menuItemsCount]=this.objectId[t],this.menuItemsCount++),this.menuItemText1[this.menuItemsCount]="Examine",this.menuItemText2[this.menuItemsCount]="@cya@"+Et.objectName[e],this.menuItemID[this.menuItemsCount]=3400,this.menuSourceType[this.menuItemsCount]=e,this.menuItemsCount++),this.objectAlreadyInMenu[t]=!0)}else i>=0&&(i=o.faceTag[i]-2e5),i>=0&&(e=i)}this.selectedSpell>=0&&Et.spellType[this.selectedSpell]<=1&&(this.menuItemText1[this.menuItemsCount]="Cast "+Et.spellName[this.selectedSpell]+" on self",this.menuItemText2[this.menuItemsCount]="",this.menuItemID[this.menuItemsCount]=1e3,this.menuSourceType[this.menuItemsCount]=this.selectedSpell,this.menuItemsCount++),-1!==e&&(this.selectedSpell>=0?6===Et.spellType[this.selectedSpell]&&(this.menuItemText1[this.menuItemsCount]="Cast "+Et.spellName[this.selectedSpell]+" on ground",this.menuItemText2[this.menuItemsCount]="",this.menuItemID[this.menuItemsCount]=900,this.menuItemX[this.menuItemsCount]=this.world.localX[e],this.menuItemY[this.menuItemsCount]=this.world.localY[e],this.menuSourceType[this.menuItemsCount]=this.selectedSpell,this.menuItemsCount++):this.selectedItemInventoryIndex<0&&(this.menuItemText1[this.menuItemsCount]="Walk here",this.menuItemText2[this.menuItemsCount]="",this.menuItemID[this.menuItemsCount]=920,this.menuItemX[this.menuItemsCount]=this.world.localX[e],this.menuItemY[this.menuItemsCount++]=this.world.localY[e]))}async handleInputs(){if(!this.runtimeException&&this.surface){this.frameCounter++;try{this.gameState===A.LOGIN?await this.handleLoginScreenInput():this.gameState===A.WORLD&&await this.handleGameInput()}catch(t){console.error(t),this.runtimeException=new rt(t,!0),this.freeCacheMemory()}this.lastMouseButtonDown=0,this.middleButtonDown=!1,this.cameraRotationTime++,this.messageTabFlashAll>0&&this.messageTabFlashAll--,this.messageTabFlashHistory>0&&this.messageTabFlashHistory--,this.messageTabFlashQuest>0&&this.messageTabFlashQuest--,this.messageTabFlashPrivate>0&&this.messageTabFlashPrivate--}}async handleLoginScreenInput(){if(this.worldFullTimeout>0&&this.worldFullTimeout--,this.welcomeState===k.WELCOME&&this.panelLogin[k.WELCOME])this.panelLogin[k.WELCOME].handleMouse(this.mouseX,this.mouseY,this.lastMouseButtonDown,this.mouseButtonDown),this.panelLogin[k.WELCOME].isClicked(this.controlWelcomeNewuser)?(this.panelLogin[k.NEW_USER].setTextHandle(this.controlRegisterStatus,"To create an account please enter all the requested details"),this.panelLogin[k.NEW_USER].setTextHandle(this.controlRegisterUser,""),this.panelLogin[k.NEW_USER].setTextHandle(this.controlRegisterPassword,""),this.panelLogin[k.NEW_USER].setTextHandle(this.controlRegisterConfirmPassword,""),this.panelLogin[k.NEW_USER].toggleCheckbox(this.controlRegisterCheckbox,!1),this.panelLogin[k.NEW_USER].setFocus(this.controlRegisterUser),this.welcomeState=k.NEW_USER):this.panelLogin[k.WELCOME].isClicked(this.controlWelcomeExistinguser)&&(this.panelLogin[k.EXISTING_USER].setTextHandle(this.controlLoginStatus,"Please enter your username and password"),"true"!==se("savePass")?(this.panelLogin[k.EXISTING_USER].toggleCheckbox(this.controlLoginSavePass,!1),this.panelLogin[k.EXISTING_USER].setTextHandle(this.controlLoginUser,""),this.panelLogin[k.EXISTING_USER].setTextHandle(this.controlLoginPass,""),this.panelLogin[k.EXISTING_USER].setFocus(this.controlLoginUser)):(this.panelLogin[k.EXISTING_USER].toggleCheckbox(this.controlLoginSavePass,!0),this.panelLogin[k.EXISTING_USER].setTextHandle(this.controlLoginUser,this.loginUser||se("username")),this.panelLogin[k.EXISTING_USER].setFocus(this.controlLoginPass)),this.welcomeState=k.EXISTING_USER);else if(this.welcomeState===k.NEW_USER&&this.panelLogin[k.NEW_USER]){if(this.panelLogin[k.NEW_USER].handleMouse(this.mouseX,this.mouseY,this.lastMouseButtonDown,this.mouseButtonDown),this.panelLogin[k.NEW_USER].isClicked(this.controlRegisterCancel))return void(this.welcomeState=k.WELCOME);if(this.panelLogin[k.NEW_USER].isClicked(this.controlRegisterUser))return void this.panelLogin[k.NEW_USER].setFocus(this.controlRegisterPassword);if(this.panelLogin[k.NEW_USER].isClicked(this.controlRegisterPassword))return void this.panelLogin[k.NEW_USER].setFocus(this.controlRegisterConfirmPassword);if(this.panelLogin[k.NEW_USER].isClicked(this.controlRegisterConfirmPassword)||this.panelLogin[k.NEW_USER].isClicked(this.controlRegisterSubmit)){let t=this.panelLogin[k.NEW_USER].getText(this.controlRegisterUser),e=this.panelLogin[k.NEW_USER].getText(this.controlRegisterPassword),i=this.panelLogin[k.NEW_USER].getText(this.controlRegisterConfirmPassword);return t&&e&&i?this.panelLogin[k.NEW_USER].isActivated(this.controlRegisterCheckbox)?t.length<3||t.length>12?void this.panelLogin[k.NEW_USER].setTextHandle(this.controlRegisterStatus,"@yel@Your username must be between 3 and 12 characters long."):e.length<3||e.length>20?void this.panelLogin[k.NEW_USER].setTextHandle(this.controlRegisterStatus,"@yel@Your password must be between 3 and 20 characters long."):e!==i?void this.panelLogin[k.NEW_USER].setTextHandle(this.controlRegisterStatus,"@yel@The two passwords entered are not the same as each other!"):e===t?void this.panelLogin[k.NEW_USER].setTextHandle(this.controlRegisterStatus,"@yel@Your password can not be the same as your username!"):(this.panelLogin[k.NEW_USER].setTextHandle(this.controlRegisterStatus,"Please wait... attempting to create user"),void await super.registerAccount(t,e)):void this.panelLogin[k.NEW_USER].setTextHandle(this.controlRegisterStatus,"@yel@You must read and agree to the terms+conditions to continue."):void this.panelLogin[k.NEW_USER].setTextHandle(this.controlRegisterStatus,"@yel@You must provide a username and password to continue.")}}else if(this.welcomeState===k.EXISTING_USER){if(!this.panelLogin[k.EXISTING_USER])return;if(this.panelLogin[k.EXISTING_USER].handleMouse(this.mouseX,this.mouseY,this.lastMouseButtonDown,this.mouseButtonDown),this.panelLogin[k.EXISTING_USER].isClicked(this.controlLoginCancel))return void(this.welcomeState=k.WELCOME);if(this.panelLogin[k.EXISTING_USER].isClicked(this.controlLoginUser))return void this.panelLogin[k.EXISTING_USER].setFocus(this.controlLoginPass);if(this.panelLogin[k.EXISTING_USER].isClicked(this.controlLoginPass)||this.panelLogin[k.EXISTING_USER].isClicked(this.controlLoginOk))return this.loginUser=this.panelLogin[k.EXISTING_USER].getText(this.controlLoginUser),this.loginPass=this.panelLogin[k.EXISTING_USER].getText(this.controlLoginPass),re("username",this.panelLogin[k.EXISTING_USER].getText(this.controlLoginUser)),re("savePass",this.panelLogin[k.EXISTING_USER].isActivated(this.controlLoginSavePass)),void await super.login(this.panelLogin[k.EXISTING_USER].getText(this.controlLoginUser),this.panelLogin[k.EXISTING_USER].getText(this.controlLoginPass),!1,this.panelLogin[k.EXISTING_USER].isActivated(this.controlLoginSavePass))}}async loadMaps(){this.world.mapPack=await this.readDataFile("maps"+mt.MAPS+".jag","map",70),this.members&&(this.world.memberMapPack=await this.readDataFile("maps"+mt.MAPS+".mem","members map",75)),this.world.landscapePack=await this.readDataFile("land"+mt.MAPS+".jag","landscape",80),this.members&&(this.world.memberLandscapePack=await this.readDataFile("land"+mt.MAPS+".mem","members landscape",85))}createBoundaryModel(t,e,i,s,r){let n=t,o=e,a=t,h=e,l=Et.wallObjectTextureFront[s],u=Et.wallObjectTextureBack[s],c=Et.wallObjectHeight[s],d=Yt._from2(4,1);0===i&&(a=t+1),1===i&&(h=e+1),2===i&&(n=t+1,h=e+1),3===i&&(a=t+1,h=e+1),n*=this.tileSize,o*=this.tileSize,a*=this.tileSize,h*=this.tileSize;let m=d.vertexAt(n,-this.world.getElevation(n,o),o),p=d.vertexAt(n,-this.world.getElevation(n,o)-c,o),f=d.vertexAt(a,-this.world.getElevation(a,h)-c,h),g=d.vertexAt(a,-this.world.getElevation(a,h),h),S=new Int32Array([m,p,f,g]);return d.createFace(4,S,l,u),d.createGouraudLightSource(!1,60,24,-50,-10,-50),t>=0&&e>=0&&t<96&&e<96&&this.scene.addModel(d),d.key=r+1e4,d}destroy(){super.stop()}}Object.defineProperty(he,"experienceTable",{get:()=>{if(!he._experienceTable){he._experienceTable=new Uint32Array(200);let t=0;for(let e=1;e<200;e++){t+=e+300*Math.pow(2,e/7),he._experienceTable[e-1]=-4&t}}return he._experienceTable}}),S.wasmMod||(async()=>{S.wasmMod=await n.e(1).then(n.t.bind(null,15,7))})(),"undefined"==typeof window&&(console.error("Window doesn't exist!  Currently running this client outside a web-browser is not possible.  Eventually it may be, but for now the alternative is the client that is written in Java."),exit()),(async()=>{const t=new he(window.document.getElementById("gameCanvas")||createCanvas(512,346));t.options.middleClickCamera=!0,t.options.mouseWheel=!0,t.options.resetCompass=!0,t.options.zoomCamera=!0;const e=window.location.hash.slice(1).split(",");e.length>0&&(t.members="members"===e[0]),t.port=43594,await t.startApplication(512,346,"RSCTurmoil - Powered by RSCGo",!1)})()}]);