!function(){var t=function(t){var e;return function(i){return e||t(e={exports:{},parent:i},e.exports),e.exports}}(function(t,e){e.createCanvas=function(t,e){return Object.assign(document.createElement("canvas"),{width:t,height:e})}}),s={APPEARANCE:235,BANK_CLOSE:212,BANK_DEPOSIT:23,BANK_WITHDRAW:22,CAST_GROUND:158,CAST_GROUNDITEM:249,CAST_INVITEM:4,CAST_NPC:50,CAST_OBJECT:99,CAST_PLAYER:229,CAST_SELF:137,CAST_WALLOBJECT:180,CHAT:216,CHOOSE_OPTION:116,CLOSE_CONNECTION:31,COMBAT_STYLE:29,COMMAND:38,DUEL_ACCEPT:176,DUEL_CONFIRM_ACCEPT:77,DUEL_DECLINE:197,DUEL_ITEM_UPDATE:33,DUEL_SETTINGS:8,FRIEND_ADD:195,FRIEND_REMOVE:167,GROUNDITEM_TAKE:247,IGNORE_ADD:132,IGNORE_REMOVE:241,INV_CMD:90,INV_DROP:246,INV_UNEQUIP:170,INV_WEAR:169,KNOWN_PLAYERS:163,LOGIN:0,LOGOUT:102,NPC_ATTACK:190,NPC_CMD:202,NPC_TALK:153,OBJECT_CMD1:136,OBJECT_CMD2:79,PACKET_EXCEPTION:3,PING:67,PLAYER_ATTACK:171,PLAYER_DUEL:103,PLAYER_FOLLOW:165,PLAYER_TRADE:142,PM:218,PRAYER_OFF:254,PRAYER_ON:60,REPORT_ABUSE:206,SETTINGS_GAME:111,SETTINGS_PRIVACY:64,SHOP_BUY:236,SHOP_CLOSE:166,SHOP_SELL:221,SLEEP_WORD:45,TRADE_ACCEPT:55,TRADE_CONFIRM_ACCEPT:104,TRADE_DECLINE:230,TRADE_ITEM_UPDATE:46,USEWITH_GROUNDITEM:53,USEWITH_INVITEM:91,USEWITH_NPC:135,USEWITH_OBJECT:115,USEWITH_PLAYER:113,USEWITH_WALLOBJECT:161,WALK:187,WALK_ACTION:16,WALL_OBJECT_COMMAND1:14,WALL_OBJECT_COMMAND2:127,CHANGE_PASSWORD:25,REGISTER:2},r={};class n{constructor(t,e,i,s=255){this.r=t,this.g=e,this.b=i,this.a=s}toCanvasStyle(){return`rgba(${this.r},${this.g}, ${this.b}, ${this.a})`}}n.white=new n(255,255,255),n.WHITE=n.white,n.lightGray=new n(192,192,192),n.LIGHT_GRAY=n.lightGray,n.gray=new n(128,128,128),n.GRAY=n.gray,n.darkGray=new n(64,64,64),n.DARK_GRAY=n.darkGray,n.black=new n(0,0,0),n.BLACK=n.black,n.red=new n(255,0,0),n.RED=n.red,n.pink=new n(255,175,175),n.PINK=n.pink,n.orange=new n(255,200,0),n.ORANGE=n.orange,n.yellow=new n(255,255,0),n.YELLOW=n.yellow,n.green=new n(0,255,0),n.GREEN=n.green,n.magenta=new n(255,0,255),n.MAGENTA=n.magenta,n.cyan=new n(0,255,255),n.CYAN=n.cyan,n.blue=new n(0,0,255),n.BLUE=n.blue,r=n;let o=0;var a,h={Enum:class{constructor(t){this.name=t,this.ordinal=o++}toNumber(){return this.ordinal}toString(){return this.name}}};const{Enum:l}=h;class c extends l{}c.NORMAL=new c("normal"),c.BOLD=new c("bold"),c.ITALIC=new c("italic"),a={FontStyle:c};var u={};const{FontStyle:m}=a;class d{constructor(t,e=m.NORMAL,i=15){this.name=t,this.type=e,this.size=i}getType(){return String(this.type)}withStyle(t){return new d(this.name,t,this.size)}withSize(t){return new d(this.name,t,this.size)}withConfig(t,e=this.size){return new d(this.name,t,e)}toString(){return`${this.getType()} ${this.size}px ${this.name}`}}d.TIMES=new d("Times"),d.TIMES_ROMAN=new d("TimesRoman"),d.SANS=new d("Sans"),d.SERIF=new d("Serif"),d.SANSERIF=new d("Sans-Serif"),d.ARIAL=new d("Arial"),d.HELVETICA=new d("Helvetica"),u=d;const p=new TextEncoder("utf-8"),g=new TextDecoder("utf-8");var f={decodeString:t=>g.decode((t=>{let e=65504;for(let i=0;i<t.length;i++)64===t[i]?4===i&&64===t[i-4]?e=65504:0===i&&64===t[i+4]?e=0:t[i]=32:37===t[i]?t[i]=32:46===t[i]||33===t[i]?e=65504:t[i]>=97&&t[i]<=122&&(t[i]+=e,e=0);return t})(t)),encodeString:t=>(t.length>80&&(t=t.slice(0,80)),t=t.toLowerCase(),p.encode(t))},S=class{constructor(t){this.buffer=t,this.offset=0,this.decoder=new TextDecoder("utf8")}putByte(t){this.buffer[this.offset++]=t}putInt(t){this.putByte(t>>24),this.putByte(t>>16),this.putByte(t>>8),this.putByte(t)}putString(t){for(let e=0;e<t.length;e++)this.putByte(t.charCodeAt(e));this.buffer[this.offset++]="\n"}putBytes(t,e,i){for(let s=e;s<i;s++)this.putByte(t[s])}getUnsignedByte(){return 255&this.buffer[this.offset++]}getUnsignedShort(){return this.getUnsignedByte()<<8|this.getUnsignedByte()}getUnsignedInt(){return this.getUnsignedShort()<<16|this.getUnsignedShort()}getUnsignedLong(){let t=this.getUnsignedInt(),e=this.getUnsignedInt();return new Long(e,t,!0)}getString(t=0){return t<0?"":(this.offset+=t,this.offset>this.buffer.length&&(this.offset=this.buffer.length),this.decoder.decode(this.buffer.slice(this.offset-t,this.offset)))}},w=I,C=null;try{C=new WebAssembly.Instance(new WebAssembly.Module(new Uint8Array([0,97,115,109,1,0,0,0,1,13,2,96,0,1,127,96,4,127,127,127,127,1,127,3,7,6,0,1,1,1,1,1,6,6,1,127,1,65,0,11,7,50,6,3,109,117,108,0,1,5,100,105,118,95,115,0,2,5,100,105,118,95,117,0,3,5,114,101,109,95,115,0,4,5,114,101,109,95,117,0,5,8,103,101,116,95,104,105,103,104,0,0,10,191,1,6,4,0,35,0,11,36,1,1,126,32,0,173,32,1,173,66,32,134,132,32,2,173,32,3,173,66,32,134,132,126,34,4,66,32,135,167,36,0,32,4,167,11,36,1,1,126,32,0,173,32,1,173,66,32,134,132,32,2,173,32,3,173,66,32,134,132,127,34,4,66,32,135,167,36,0,32,4,167,11,36,1,1,126,32,0,173,32,1,173,66,32,134,132,32,2,173,32,3,173,66,32,134,132,128,34,4,66,32,135,167,36,0,32,4,167,11,36,1,1,126,32,0,173,32,1,173,66,32,134,132,32,2,173,32,3,173,66,32,134,132,129,34,4,66,32,135,167,36,0,32,4,167,11,36,1,1,126,32,0,173,32,1,173,66,32,134,132,32,2,173,32,3,173,66,32,134,132,130,34,4,66,32,135,167,36,0,32,4,167,11])),{}).exports}catch(e){}function I(t,e,i){this.low=0|t,this.high=0|e,this.unsigned=!!i}function y(t){return!0===(t&&t.__isLong__)}I.prototype.__isLong__,Object.defineProperty(I.prototype,"__isLong__",{value:!0}),I.isLong=y;var b={},T={};function A(t,e){var i,s,r;return e?(r=0<=(t>>>=0)&&t<256)&&(s=T[t])?s:(i=v(t,(0|t)<0?-1:0,!0),r&&(T[t]=i),i):(r=-128<=(t|=0)&&t<128)&&(s=b[t])?s:(i=v(t,t<0?-1:0,!1),r&&(b[t]=i),i)}function x(t,e){if(isNaN(t))return e?X:Y;if(e){if(t<0)return X;if(t>=B)return _}else{if(t<=-M)return U;if(t+1>=M)return N}return t<0?x(-t,e).neg():v(t%P|0,t/P|0,e)}function v(t,e,i){return new I(t,e,i)}I.fromInt=A,I.fromNumber=x,I.fromBits=v;var L=Math.pow;function E(t,e,i){if(0===t.length)throw Error("empty string");if("NaN"===t||"Infinity"===t||"+Infinity"===t||"-Infinity"===t)return Y;if("number"==typeof e?(i=e,e=!1):e=!!e,(i=i||10)<2||36<i)throw RangeError("radix");var s;if((s=t.indexOf("-"))>0)throw Error("interior hyphen");if(0===s)return E(t.substring(1),e,i).neg();for(var r=x(L(i,8)),n=Y,o=0;o<t.length;o+=8){var a=Math.min(8,t.length-o),h=parseInt(t.substring(o,o+a),i);if(a<8){var l=x(L(i,a));n=n.mul(l).add(x(h))}else n=(n=n.mul(r)).add(x(h))}return n.unsigned=e,n}function k(t,e){return"number"==typeof t?x(t,e):"string"==typeof t?E(t,e):v(t.low,t.high,"boolean"==typeof e?e:t.unsigned)}I.fromString=E,I.fromValue=k;var P=4294967296,B=P*P,M=B/2,D=A(1<<24),Y=A(0);I.ZERO=Y;var X=A(0,!0);I.UZERO=X;var O=A(1);I.ONE=O;var R=A(1,!0);I.UONE=R;var j=A(-1);I.NEG_ONE=j;var N=v(-1,2147483647,!1);I.MAX_VALUE=N;var _=v(-1,-1,!0);I.MAX_UNSIGNED_VALUE=_;var U=v(0,-2147483648,!1);I.MIN_VALUE=U;var H=I.prototype;H.toInt=function(){return this.unsigned?this.low>>>0:this.low},H.toNumber=function(){return this.unsigned?(this.high>>>0)*P+(this.low>>>0):this.high*P+(this.low>>>0)},H.toString=function(t){if((t=t||10)<2||36<t)throw RangeError("radix");if(this.isZero())return"0";if(this.isNegative()){if(this.eq(U)){var e=x(t),i=this.div(e),s=i.mul(e).sub(this);return i.toString(t)+s.toInt().toString(t)}return"-"+this.neg().toString(t)}for(var r=x(L(t,6),this.unsigned),n=this,o="";;){var a=n.div(r),h=(n.sub(a.mul(r)).toInt()>>>0).toString(t);if((n=a).isZero())return h+o;for(;h.length<6;)h="0"+h;o=""+h+o}},H.getHighBits=function(){return this.high},H.getHighBitsUnsigned=function(){return this.high>>>0},H.getLowBits=function(){return this.low},H.getLowBitsUnsigned=function(){return this.low>>>0},H.getNumBitsAbs=function(){if(this.isNegative())return this.eq(U)?64:this.neg().getNumBitsAbs();for(var t=0!=this.high?this.high:this.low,e=31;e>0&&0==(t&1<<e);e--);return 0!=this.high?e+33:e+1},H.isZero=function(){return 0===this.high&&0===this.low},H.eqz=H.isZero,H.isNegative=function(){return!this.unsigned&&this.high<0},H.isPositive=function(){return this.unsigned||this.high>=0},H.isOdd=function(){return 1==(1&this.low)},H.isEven=function(){return 0==(1&this.low)},H.equals=function(t){return y(t)||(t=k(t)),(this.unsigned===t.unsigned||this.high>>>31!=1||t.high>>>31!=1)&&this.high===t.high&&this.low===t.low},H.eq=H.equals,H.notEquals=function(t){return!this.eq(t)},H.neq=H.notEquals,H.ne=H.notEquals,H.lessThan=function(t){return this.comp(t)<0},H.lt=H.lessThan,H.lessThanOrEqual=function(t){return this.comp(t)<=0},H.lte=H.lessThanOrEqual,H.le=H.lessThanOrEqual,H.greaterThan=function(t){return this.comp(t)>0},H.gt=H.greaterThan,H.greaterThanOrEqual=function(t){return this.comp(t)>=0},H.gte=H.greaterThanOrEqual,H.ge=H.greaterThanOrEqual,H.compare=function(t){if(y(t)||(t=k(t)),this.eq(t))return 0;var e=this.isNegative(),i=t.isNegative();return e&&!i?-1:!e&&i?1:this.unsigned?t.high>>>0>this.high>>>0||t.high===this.high&&t.low>>>0>this.low>>>0?-1:1:this.sub(t).isNegative()?-1:1},H.comp=H.compare,H.negate=function(){return!this.unsigned&&this.eq(U)?U:this.not().add(O)},H.neg=H.negate,H.add=function(t){y(t)||(t=k(t));var e=this.high>>>16,i=65535&this.high,s=this.low>>>16,r=65535&this.low,n=t.high>>>16,o=65535&t.high,a=t.low>>>16,h=0,l=0,c=0,u=0;return c+=(u+=r+(65535&t.low))>>>16,l+=(c+=s+a)>>>16,h+=(l+=i+o)>>>16,h+=e+n,v((c&=65535)<<16|(u&=65535),(h&=65535)<<16|(l&=65535),this.unsigned)},H.subtract=function(t){return y(t)||(t=k(t)),this.add(t.neg())},H.sub=H.subtract,H.multiply=function(t){if(this.isZero())return Y;if(y(t)||(t=k(t)),C)return v(C.mul(this.low,this.high,t.low,t.high),C.get_high(),this.unsigned);if(t.isZero())return Y;if(this.eq(U))return t.isOdd()?U:Y;if(t.eq(U))return this.isOdd()?U:Y;if(this.isNegative())return t.isNegative()?this.neg().mul(t.neg()):this.neg().mul(t).neg();if(t.isNegative())return this.mul(t.neg()).neg();if(this.lt(D)&&t.lt(D))return x(this.toNumber()*t.toNumber(),this.unsigned);var e=this.high>>>16,i=65535&this.high,s=this.low>>>16,r=65535&this.low,n=t.high>>>16,o=65535&t.high,a=t.low>>>16,h=65535&t.low,l=0,c=0,u=0,m=0;return u+=(m+=r*h)>>>16,c+=(u+=s*h)>>>16,u&=65535,c+=(u+=r*a)>>>16,l+=(c+=i*h)>>>16,c&=65535,l+=(c+=s*a)>>>16,c&=65535,l+=(c+=r*o)>>>16,l+=e*h+i*a+s*o+r*n,v((u&=65535)<<16|(m&=65535),(l&=65535)<<16|(c&=65535),this.unsigned)},H.mul=H.multiply,H.divide=function(t){if(y(t)||(t=k(t)),t.isZero())throw Error("division by zero");var e,i,s;if(C)return this.unsigned||-2147483648!==this.high||-1!==t.low||-1!==t.high?v((this.unsigned?C.div_u:C.div_s)(this.low,this.high,t.low,t.high),C.get_high(),this.unsigned):this;if(this.isZero())return this.unsigned?X:Y;if(this.unsigned){if(t.unsigned||(t=t.toUnsigned()),t.gt(this))return X;if(t.gt(this.shru(1)))return R;s=X}else{if(this.eq(U))return t.eq(O)||t.eq(j)?U:t.eq(U)?O:(e=this.shr(1).div(t).shl(1)).eq(Y)?t.isNegative()?O:j:(i=this.sub(t.mul(e)),s=e.add(i.div(t)));if(t.eq(U))return this.unsigned?X:Y;if(this.isNegative())return t.isNegative()?this.neg().div(t.neg()):this.neg().div(t).neg();if(t.isNegative())return this.div(t.neg()).neg();s=Y}for(i=this;i.gte(t);){e=Math.max(1,Math.floor(i.toNumber()/t.toNumber()));for(var r=Math.ceil(Math.log(e)/Math.LN2),n=r<=48?1:L(2,r-48),o=x(e),a=o.mul(t);a.isNegative()||a.gt(i);)a=(o=x(e-=n,this.unsigned)).mul(t);o.isZero()&&(o=O),s=s.add(o),i=i.sub(a)}return s},H.div=H.divide,H.modulo=function(t){return y(t)||(t=k(t)),C?v((this.unsigned?C.rem_u:C.rem_s)(this.low,this.high,t.low,t.high),C.get_high(),this.unsigned):this.sub(this.div(t).mul(t))},H.mod=H.modulo,H.rem=H.modulo,H.not=function(){return v(~this.low,~this.high,this.unsigned)},H.and=function(t){return y(t)||(t=k(t)),v(this.low&t.low,this.high&t.high,this.unsigned)},H.or=function(t){return y(t)||(t=k(t)),v(this.low|t.low,this.high|t.high,this.unsigned)},H.xor=function(t){return y(t)||(t=k(t)),v(this.low^t.low,this.high^t.high,this.unsigned)},H.shiftLeft=function(t){return y(t)&&(t=t.toInt()),0==(t&=63)?this:t<32?v(this.low<<t,this.high<<t|this.low>>>32-t,this.unsigned):v(0,this.low<<t-32,this.unsigned)},H.shl=H.shiftLeft,H.shiftRight=function(t){return y(t)&&(t=t.toInt()),0==(t&=63)?this:t<32?v(this.low>>>t|this.high<<32-t,this.high>>t,this.unsigned):v(this.high>>t-32,this.high>=0?0:-1,this.unsigned)},H.shr=H.shiftRight,H.shiftRightUnsigned=function(t){if(y(t)&&(t=t.toInt()),0==(t&=63))return this;var e=this.high;return t<32?v(this.low>>>t|e<<32-t,e>>>t,this.unsigned):v(32===t?e:e>>>t-32,0,this.unsigned)},H.shru=H.shiftRightUnsigned,H.shr_u=H.shiftRightUnsigned,H.toSigned=function(){return this.unsigned?v(this.low,this.high,!1):this},H.toUnsigned=function(){return this.unsigned?this:v(this.low,this.high,!0)},H.toBytes=function(t){return t?this.toBytesLE():this.toBytesBE()},H.toBytesLE=function(){var t=this.high,e=this.low;return[255&e,e>>>8&255,e>>>16&255,e>>>24,255&t,t>>>8&255,t>>>16&255,t>>>24]},H.toBytesBE=function(){var t=this.high,e=this.low;return[t>>>24,t>>>16&255,t>>>8&255,255&t,e>>>24,e>>>16&255,e>>>8&255,255&e]},I.fromBytes=function(t,e,i){return i?I.fromBytesLE(t,e):I.fromBytesBE(t,e)},I.fromBytesLE=function(t,e){return new I(t[0]|t[1]<<8|t[2]<<16|t[3]<<24,t[4]|t[5]<<8|t[6]<<16|t[7]<<24,e)},I.fromBytesBE=function(t,e){return new I(t[4]<<24|t[5]<<16|t[6]<<8|t[7],t[0]<<24|t[1]<<16|t[2]<<8|t[3],e)};var W=class{constructor(){this.hash=new w,this.name=null,this.serverIndex=0,this.serverId=0,this.currentX=0,this.currentY=0,this.npcId=0,this.stepCount=0,this.animationCurrent=0,this.animationNext=0,this.movingStep=0,this.waypointCurrent=0,this.message=null,this.messageTimeout=0,this.bubbleItem=0,this.bubbleTimeout=0,this.damageTaken=0,this.healthCurrent=0,this.healthMax=0,this.combatTimer=0,this.level=0,this.colourHair=0,this.colourTop=0,this.colourBottom=0,this.colourSkin=0,this.incomingProjectileSprite=0,this.attackingPlayerServerIndex=0,this.attackingNpcServerIndex=0,this.projectileRange=0,this.skullVisible=0,this.waypointsX=new Int32Array(10),this.waypointsY=new Int32Array(10),this.equippedItem=new Int32Array(12),this.level=-1}isFighting(){return 8===this.animationCurrent||9===this.animationCurrent}},F={CLIENT:204,CONFIG:85,ENTITY:24,FILTER:2,FONTS:1,MAPS:63,MEDIA:58,MODELS:36,SOUNDS:1,TEXTURES:17},G=class extends class{constructor(){this.readTicksCount=0,this.readTicksMax=0,this.packetStart=0,this.packetData=null,this.bufferSize=0,this.writeTicksCount=0,this.writeTicksMax=0,this.packetEnd=3,this.packetMaxLength=24578,this.socketException=!1,this.socketExceptionMessage=""}async readBytes(t,e){await this.readStreamBytes(t,0,e)}async readPacket(t){try{if(this.readTicksCount++,this.readTicksMax>0&&this.readTicksCount>this.readTicksMax)return this.readTicksCount=0,this.socketException=!0,this.socketExceptionMessage="time-out",0;if(0===this.bufferSize&&this.availableStream()>=2&&(this.bufferSize=await this.readStream(),this.bufferSize>=160&&(this.bufferSize=this.bufferSize-160<<8|await this.readStream())),this.bufferSize>0&&this.availableStream()>=this.bufferSize){let e=this.bufferSize;return e>0&&(this.bufferSize<160&&(this.bufferSize-=1,t[this.bufferSize]=255&await this.readStream()),await this.readBytes(this.bufferSize,t)),this.bufferSize=this.readTicksCount=0,e}}catch(e){this.socketException=!0,this.socketExceptionMessage=e.message}return 0}hasPacket(){return this.packetStart>0}resetOutgoingBuffer(){this.packetEnd-=this.packetStart,this.packetStart=0}writePacket(t){if(this.socketException)throw this.socketException=!1,this.resetOutgoingBuffer(),Error(this.socketExceptionMessage);this.writeTicksMax=t,++this.writeTicksCount>=this.writeTicksMax&&this.packetStart>0&&(this.writeStreamBytes(this.packetData,0,this.packetStart),this.writeTicksCount=0,this.resetOutgoingBuffer())}sendPacket(){let t=this.packetEnd-this.packetStart-2,e=255&t,i=160+t>>8&255;t>=160?(this.packetData[this.packetStart]=i,this.packetData[this.packetStart+1]=e):(this.packetData[this.packetStart]=e,this.packetEnd--,this.packetData[this.packetStart+1]=this.packetData[this.packetEnd]),this.packetStart=this.packetEnd}newPacket(t){if(this.packetStart>(4*this.packetMaxLength/5|0))try{this.writePacket(0)}catch(e){this.socketExceptionMessage=e.message,this.socketException=!0}this.packetData||(this.packetData=new Int8Array(this.packetMaxLength)),this.packetData[this.packetStart+2]=255&t,this.packetEnd=this.packetStart+3,this.packetData[this.packetEnd]=0}async getByte(){return 255&await this.readStream()}async getShort(){return await this.getByte()<<8|await this.getByte()}async getInt(){return await this.getShort()<<16|await this.getShort()}async getLong(){let t=await this.getInt(),e=await this.getInt();return new w(e,t,!0)}putString(t){this.putBytes(function(t){let e=new Uint16Array(t.length);for(let i=0;i<t.length;i+=1)e[i]=t.charCodeAt(i);return e}(t)),this.putByte("\0")}putBool(t){this.putByte(t?1:0)}putByte(t){this.packetData[this.packetEnd++]=255&t}putShort(t){this.putByte(t>>8),this.putByte(t)}putInt(t){this.putShort(t>>16),this.putShort(t)}putLong(t){this.putInt(t.shiftRight(32).toInt()),this.putInt(t.toInt())}putBytes(t,e=0,i=t.length){for(let s of t.slice(e,e+i))this.putByte(s)}flushPacket(){this.sendPacket(),this.writePacket(0)}}{constructor(t){super(),this.closing=!1,this.closed=!1,this.socket=t}closeStream(){this.closing=!0,this.socket.close(),this.closed=!0}async readStream(){return this.closing?0:await this.socket.read()}availableStream(){return this.closing?0:this.socket.available()}async readStreamBytes(t,e,i){this.closing||await this.socket.readBytes(i,e,t)}writeStreamBytes(t,e,i){this.closing||this.socket.write(t,e,i)}};function V(t,e){const i=[];for(let s=0;s<t;s+=1)i.push(new Int32Array(e));return i}class z{constructor(){this.tt=null,this.input=null,this.nextIn=0,this.availIn=0,this.totalInLo32=0,this.totalInHi32=0,this.output=null,this.availOut=0,this.decompressedSize=0,this.totalOutLo32=0,this.totalOutHi32=0,this.stateOutCh=0,this.stateOutLen=0,this.blockRandomised=!1,this.bsBuff=0,this.bsLive=0,this.blocksize100k=0,this.blockNo=0,this.origPtr=0,this.tpos=0,this.k0=0,this.nblockUsed=0,this.nInUse=0,this.saveNblock=0,this.unzftab=new Int32Array(256),this.cftab=new Int32Array(257),this.inUse=new Int8Array(256),this.inUse_16=new Int8Array(16),this.setToUnseq=new Int8Array(256),this.mtfa=new Int8Array(4096),this.mtfbase=new Int32Array(16),this.selector=new Int8Array(18002),this.selectorMtf=new Int8Array(18002),this.len=function(t,e){const i=[];for(let s=0;s<6;s+=1)i.push(new Int8Array(258));return i}(),this.limit=V(6,258),this.base=V(6,258),this.perm=V(6,258),this.minLens=new Int32Array(6)}}class Z{static decompress(t,e,i,s,r){let n=new z;return n.input=i,n.nextIn=r,n.output=t,n.availOut=0,n.availIn=s,n.decompressedSize=e,n.bsLive=0,n.bsBuff=0,n.totalInLo32=0,n.totalInHi32=0,n.totalOutLo32=0,n.totalOutHi32=0,n.blockNo=0,Z.decompressState(n),e-n.decompressedSize}static nextHeader(t){let e=t.stateOutCh,i=t.stateOutLen,s=t.nblockUsed,r=t.k0,n=t.tt,o=t.tpos,a=t.output,h=t.availOut,l=t.decompressedSize,c=l,u=t.saveNblock+1;t:for(;;){if(i>0){for(;;){if(0===l)break t;if(1===i)break;a[h]=e,i--,h++,l--}if(0===l){i=1;break}a[h]=e,h++,l--}let t=!0;for(;t;){if(t=!1,s===u){i=0;break t}e=255&r;let c=255&(o=n[o]);if(o>>=8,s++,c!==r){if(r=c,0!==l){a[h]=e,h++,l--,t=!0;continue}i=1;break t}if(s===u){if(0===l){i=1;break t}a[h]=e,h++,l--,t=!0}}i=2;let c=255&(o=n[o]);if(o>>=8,++s!==u)if(c!==r)r=c;else{i=3;let t=255&(o=n[o]);o>>=8,++s!==u&&(t!==r?r=t:(s++,i=4+(255&(o=n[o])),r=255&(o=n[o>>=8]),o>>=8,s++))}}let m=t.totalOutLo32;t.totalOutLo32+=c-l,t.totalOutLo32<m&&t.totalOutHi32++,t.stateOutCh=e,t.stateOutLen=i,t.nblockUsed=s,t.k0=r,t.tt=n,t.tpos=o,t.output=a,t.availOut=h,t.decompressedSize=l}static decompressState(t){let e=0,i=null,s=null,r=null;t.blocksize100k=1,null===t.tt&&(t.tt=new Int32Array(1e5*t.blocksize100k));let n=!0;for(;n;){let o=Z.getUChar(t);if(23===o)return;o=Z.getUChar(t),o=Z.getUChar(t),o=Z.getUChar(t),o=Z.getUChar(t),o=Z.getUChar(t),t.blockNo++,o=Z.getUChar(t),o=Z.getUChar(t),o=Z.getUChar(t),o=Z.getUChar(t),o=Z.getBit(t),t.blockRandomised=0!==o,t.blockRandomised&&console.log("PANIC! RANDOMISED BLOCK!"),t.origPtr=0,o=Z.getUChar(t),t.origPtr=t.origPtr<<8|255&o,o=Z.getUChar(t),t.origPtr=t.origPtr<<8|255&o,o=Z.getUChar(t),t.origPtr=t.origPtr<<8|255&o;for(let e=0;e<16;e++)o=Z.getBit(t),t.inUse_16[e]=1===o;for(let e=0;e<256;e++)t.inUse[e]=!1;for(let e=0;e<16;e++)if(t.inUse_16[e])for(let i=0;i<16;i++)1===(o=Z.getBit(t))&&(t.inUse[16*e+i]=!0);Z.makeMaps(t);let a=t.nInUse+2,h=Z.getBits(3,t),l=Z.getBits(15,t);for(let e=0;e<l;e++){let i=0;for(;0!==(o=Z.getBit(t));)i++;t.selectorMtf[e]=255&i}let c=new Int8Array(6);for(let t=0;t<h;t++)c[t]=t;for(let e=0;e<l;e++){let i=t.selectorMtf[e],s=c[i];for(;i>0;i--)c[i]=c[i-1];c[0]=s,t.selector[e]=s}for(let e=0;e<h;e++){let i=Z.getBits(5,t);for(let s=0;s<a;s++){for(;0!==(o=Z.getBit(t));)0===(o=Z.getBit(t))?i++:i--;t.len[e][s]=255&i}}for(let e=0;e<h;e++){let i=32,s=0;for(let r=0;r<a;r++)t.len[e][r]>s&&(s=t.len[e][r]),t.len[e][r]<i&&(i=t.len[e][r]);Z.createDecodeTables(t.limit[e],t.base[e],t.perm[e],t.len[e],i,s,a),t.minLens[e]=i}let u=t.nInUse+1,m=(t.blocksize100k,-1),d=0;for(let e=0;e<=255;e++)t.unzftab[e]=0;let p=4095;for(let e=15;e>=0;e--){for(let i=15;i>=0;i--)t.mtfa[p]=16*e+i&255,p--;t.mtfbase[e]=p+1}let g=0;if(0===d){m++,d=50;let n=t.selector[m];e=t.minLens[n],i=t.limit[n],r=t.perm[n],s=t.base[n]}d--;let f=e,S=0,w=0;for(S=Z.getBits(f,t);S>i[f];S=S<<1|w)f++,w=Z.getBit(t);for(let n=r[S-s[f]];n!==u;)if(0===n||1===n){let a=-1,h=1;do{if(0===n?a+=h:1===n&&(a+=2*h),h*=2,0===d){m++,d=50;let n=t.selector[m];e=t.minLens[n],i=t.limit[n],r=t.perm[n],s=t.base[n]}d--;let o=e,l=0,c=0;for(l=Z.getBits(o,t);l>i[o];l=l<<1|c)o++,c=Z.getBit(t);n=r[l-s[o]]}while(0===n||1===n);for(a++,o=t.setToUnseq[255&t.mtfa[t.mtfbase[0]]],t.unzftab[255&o]+=a;a>0;a--)t.tt[g]=255&o,g++}else{let a=n-1;if(a<16){let e=t.mtfbase[0];for(o=t.mtfa[e+a];a>3;a-=4){let i=e+a;t.mtfa[i]=t.mtfa[i-1],t.mtfa[i-1]=t.mtfa[i-2],t.mtfa[i-2]=t.mtfa[i-3],t.mtfa[i-3]=t.mtfa[i-4]}for(;a>0;a--)t.mtfa[e+a]=t.mtfa[e+a-1];t.mtfa[e]=o}else{let e=a/16|0,i=a%16,s=t.mtfbase[e]+i;for(o=t.mtfa[s];s>t.mtfbase[e];s--)t.mtfa[s]=t.mtfa[s-1];for(t.mtfbase[e]++;e>0;e--)t.mtfbase[e]--,t.mtfa[t.mtfbase[e]]=t.mtfa[t.mtfbase[e-1]+16-1];if(t.mtfbase[0]--,t.mtfa[t.mtfbase[0]]=o,0===t.mtfbase[0]){p=4095;for(let e=15;e>=0;e--){for(let i=15;i>=0;i--)t.mtfa[p]=t.mtfa[t.mtfbase[e]+i],p--;t.mtfbase[e]=p+1}}}if(t.unzftab[255&t.setToUnseq[255&o]]++,t.tt[g]=255&t.setToUnseq[255&o],g++,0===d){m++,d=50;let n=t.selector[m];e=t.minLens[n],i=t.limit[n],r=t.perm[n],s=t.base[n]}d--;let h=e,l=0,c=0;for(l=Z.getBits(h,t);l>i[h];l=l<<1|c)h++,c=Z.getBit(t);n=r[l-s[h]]}t.stateOutLen=0,t.stateOutCh=0,t.cftab[0]=0;for(let e=1;e<=256;e++)t.cftab[e]=t.unzftab[e-1];for(let e=1;e<=256;e++)t.cftab[e]+=t.cftab[e-1];for(let e=0;e<g;e++)o=255&t.tt[e],t.tt[t.cftab[255&o]]|=e<<8,t.cftab[255&o]++;t.tpos=t.tt[t.origPtr]>>8,t.nblockUsed=0,t.tpos=t.tt[t.tpos],t.k0=255&t.tpos,t.tpos>>=8,t.nblockUsed++,t.saveNblock=g,Z.nextHeader(t),n=t.nblockUsed===t.saveNblock+1&&0===t.stateOutLen}}static getUChar(t){return 255&Z.getBits(8,t)}static getBit(t){return 255&Z.getBits(1,t)}static getBits(t,e){let i=0;for(;;){if(e.bsLive>=t){let s=e.bsBuff>>e.bsLive-t&(1<<t)-1;e.bsLive-=t,i=s;break}e.bsBuff=e.bsBuff<<8|255&e.input[e.nextIn],e.bsLive+=8,e.nextIn++,e.availIn--,e.totalInLo32++,0===e.totalInLo32&&e.totalInHi32++}return i}static makeMaps(t){t.nInUse=0;for(let e=0;e<256;e++)t.inUse[e]&&(t.setToUnseq[t.nInUse]=255&e,t.nInUse++)}static createDecodeTables(t,e,i,s,r,n,o){let a=0;for(let l=r;l<=n;l++)for(let t=0;t<o;t++)s[t]===l&&(i[a]=t,a++);for(let l=0;l<23;l++)e[l]=0;for(let l=0;l<o;l++)e[s[l]+1]++;for(let l=1;l<23;l++)e[l]+=e[l-1];for(let l=0;l<23;l++)t[l]=0;let h=0;for(let l=r;l<=n;l++)h+=e[l+1]-e[l],t[l]=h-1,h<<=1;for(let l=r+1;l<=n;l++)e[l]=(t[l-1]+1<<1)-e[l]}}var q=Z,K=class{constructor(t){this.canvas=t,this.ctx=t.getContext("2d")}setColor(t){this.ctx.fillStyle=t.toCanvasStyle(),this.ctx.strokeStyle=t.toCanvasStyle()}fillRect(t,e,i,s){this.ctx.fillRect(t,e,i,s)}drawRect(t,e,i,s){this.ctx.strokeRect(t,e,i,s)}setFont(t){this.ctx.font=String(t)}drawString(t,e,i){this.ctx.fillText(t,e,i)}measureTextWidth(t){return this.ctx.measureText(t).width}drawImage(t,e,i){this.ctx.putImageData(t,e,i)}getImage(t,e){return this.ctx.getImageData(0,0,t,e)}},Q=class{constructor(t,e,i=!0){this.host=t,this.port=e,this.protocol=i?"wss":"ws",this.client=null,this.connected=!1,this.bytesAvailable=0,this.buffers=[],this.currentBuffer=null,this.offset=0,this.bytesLeft=0}connect(){return new Promise((t,e)=>{this.client=new WebSocket(`${this.protocol}://${this.host}:${this.port}`,"binary"),this.client.binaryType="arraybuffer";const i=t=>{this.client.removeEventListener("error",i),e(t)};this.client.addEventListener("error",i),this.client.addEventListener("close",()=>{this.connected=!1,this.clear()}),this.client.addEventListener("message",t=>{this.buffers.push(new Int8Array(t.data)),this.bytesAvailable+=t.data.byteLength,this.refreshCurrentBuffer()}),this.client.addEventListener("open",()=>{this.connected=!0,this.client.removeEventListener("error",i),t()})})}write(t,e=0,i=-1){if(!this.connected)throw new Error("attempting to write to closed socket");i=-1===i?t.length:i,this.client.send(t.slice(e,e+i))}refreshCurrentBuffer(){if(0===this.bytesLeft&&this.bytesAvailable>0){if(this.currentBuffer=this.buffers.shift(),this.offset=0,this.currentBuffer&&this.currentBuffer.length)return void(this.bytesLeft=this.currentBuffer.length);this.bytesLeft=0}}async read(){return this.connected?this.bytesLeft>0?(this.bytesLeft--,this.bytesAvailable--,255&this.currentBuffer[this.offset++]):new Promise((t,e)=>{const i=()=>{this.client.removeEventListener("error",s),this.client.removeEventListener("message",r),this.client.removeEventListener("close",i),t(-1)},s=t=>{this.client.removeEventListener("close",i),this.client.removeEventListener("message",r),this.client.removeEventListener("error",s),e(t)},r=()=>{this.client.removeEventListener("error",s),this.client.removeEventListener("close",i),this.client.removeEventListener("message",r),Promise.resolve().then(async()=>{t(await this.read())})};this.client.addEventListener("error",s),this.client.addEventListener("close",i),this.client.addEventListener("message",r)}):-1}async readBytes(t,e=0,i=-1){if(!this.connected)return-1;if(i=-1===i?t.length:i,!(this.bytesAvailable>=i))return new Promise((s,r)=>{const n=()=>{this.client.removeEventListener("error",o),this.client.removeEventListener("message",a),this.client.removeEventListener("close",n),s(-1)},o=t=>{this.client.removeEventListener("close",n),this.client.removeEventListener("message",a),this.client.removeEventListener("error",o),r(t)},a=()=>{this.client.removeEventListener("error",o),this.client.removeEventListener("close",n),this.client.removeEventListener("message",a),Promise.resolve().then(async()=>{s(await this.readBytes(t,e,i))})};this.client.addEventListener("error",o),this.client.addEventListener("close",n),this.client.addEventListener("message",a)});for(;i>0;)t[e++]=255&this.currentBuffer[this.offset++],this.bytesLeft-=1,this.bytesAvailable-=1,i-=1,0===this.bytesLeft&&this.refreshCurrentBuffer()}close(){this.connected&&this.client.close()}available(){return this.bytesAvailable}clear(){this.connected&&this.client.close(),this.currentBuffer=null,this.buffers.length=0,this.bytesLeft=0}},$=class{constructor(t){this.url=t,this.xhr=new XMLHttpRequest,this.xhr.responseType="arraybuffer",this.xhr.open("GET",t,!0),this.buffer=null,this.pos=0}async _loadResBytes(){return new Promise((t,e)=>{this.xhr.onerror=(t=>e(t)),this.xhr.onload=(()=>{2===this.xhr.status?e(new Error(`unable to download ${this.url}. status code = ${this.xhr.status}`)):t(new Int8Array(this.xhr.response))}),this.xhr.send()})}async readFully(t,e=0,i){void 0===i&&(i=t.length),this.buffer||(this.buffer=await this._loadResBytes()),t.set(this.buffer.slice(this.pos,this.pos+i),e),this.pos+=i}};const{Enum:J}=h,tt="0".charCodeAt(0),et="9".charCodeAt(0),it="a".charCodeAt(0),st="A".charCodeAt(0),rt="Z".charCodeAt(0),nt="z".charCodeAt(0);class ot{static openFile(t){return new $(t)}static getUnsignedByte(t){return 255&t}static getUnsignedShort(t,e){return(255&t[e])<<8|255&t[e+1]}static getUnsignedInt(t,e){return(255&t[e])<<24|(255&t[e+1])<<16|(255&t[e+2])<<8|255&t[e+3]}static getUnsignedLong(t,e){return new w(ot.getUnsignedInt(t,e+4),ot.getUnsignedInt(t,e),!0)}static recoveryToHash(t){t=t.toLowerCase().trim();let e=w.fromInt(0),i=0;for(let s=0;s<t.length;s++){let r=t.charCodeAt(s);(r>=it&&r<=nt||r>=tt&&r<=et)&&(e=(e=e.mul(47).mul(e.sub(6*r).sub(7*i))).add(r-32+i*r),i++)}return e}static getSignedShort(t,e){let i=ot.getUnsignedByte(t[e])<<8|ot.getUnsignedByte(t[e+1])|0;return i>32767&&(i-=65536),i}static getSmart08_32(t,e){return(255&t[e])<128?t[e]:(255&t[e])-128<<24|(255&t[e+1])<<16|(255&t[e+2])<<8|255&t[e+3]}static getBitMask(t,e,i){let s=e>>3,r=8-(7&e),n=0;for(;i>r;r=8)n+=(t[s++]&at[r])<<i-r,i-=r;return n+(i===r?t[s]&at[r]:t[s]>>r-i&at[i])}static formatAndTruncate(t,e){let i="";for(let s=0;s<e&&s<t.length;s++){let e=t.charCodeAt(s);i+=e>=it&&e<=nt||e>=st&&e<=rt||e>=tt&&e<=et?String.fromCharCode(e):"_"}return i}static uint32ToIpAddress(t){return(t>>24&255)+"."+(t>>16&255)+"."+(t>>8&255)+"."+(255&t)}static encodeBase37(t){let e="";for(let s=0;s<t.length&&s<=12;s++){let i=t.charCodeAt(s);i>=st&&i<=rt&&(i=i+97-65),e+=i>=it&&i<=nt||i>=tt&&i<=et?String.fromCharCode(i):" "}e=e.trim();let i=w.fromInt(0);for(let s=0;s<e.length;s++){let t=e.charCodeAt(s);i=i.mul(37),t>=it&&t<=nt?i=i.add(1+t-97):t>=tt&&t<=et&&(i=i.add(27+t-48))}return i}static hashToUsername(t){if(t.lessThan(0))return"invalid_name";let e="";for(;!t.eq(0);){let i=t.mod(37).toInt();t=t.div(37),e=0===i?" "+e:i<27?t.modulo(37).equals(0)?String.fromCharCode(i+65-1)+e:String.fromCharCode(i+97-1)+e:String.fromCharCode(i+48-27)+e}return e}static getDataFileOffset(t,e){let i=ot.getUnsignedShort(e,0),s=0;t=t.toUpperCase();for(let n=0;n<t.length;n++)s=(61*s|0)+t.charCodeAt(n)-32;let r=2+10*i;for(let n=0;n<i;n++){let t=(255&e[10*n+2])<<24|(255&e[10*n+3])<<16|(255&e[10*n+4])<<8|255&e[10*n+5],i=(255&e[10*n+9])<<16|(255&e[10*n+10])<<8|255&e[10*n+11];if(t===s)return r;r+=i}return 0}static getDataFileLength(t,e){let i=ot.getUnsignedShort(e,0);t=t.toUpperCase();let s=0;for(let n=0;n<t.length;n++)s=(61*s|0)+t.charCodeAt(n)-32;let r=2+10*i;for(let n=0;n<i;n++){let t=(255&e[10*n+2])<<24|(255&e[10*n+3])<<16|(255&e[10*n+4])<<8|255&e[10*n+5],i=(255&e[10*n+6])<<16|(255&e[10*n+7])<<8|255&e[10*n+8],o=(255&e[10*n+9])<<16|(255&e[10*n+10])<<8|255&e[10*n+11];if(t===s)return i;r+=o}return 0}static loadData(t,e,i){return ot.unpackData(t,e,i,null)}static unpackData(t,e,i,s){let r=(255&i[0])<<8|255&i[1],n=0;t=t.toUpperCase();for(let a=0;a<t.length;a++)n=(61*n|0)+t.charCodeAt(a)-32;let o=2+10*r;for(let a=0;a<r;a++){let t=((255&i[10*a+2])<<24)+((255&i[10*a+3])<<16)+((255&i[10*a+4])<<8)+(255&i[10*a+5])|0,r=((255&i[10*a+6])<<16)+((255&i[10*a+7])<<8)+(255&i[10*a+8])|0,h=((255&i[10*a+9])<<16)+((255&i[10*a+10])<<8)+(255&i[10*a+11])|0;if(t===n){if(null===s&&(s=new Int8Array(r+e)),r!==h)return q.decompress(s,r,i,h,o),s;for(let t=0;t<r;t++)s[t]=i[o+t];return s}o+=h}return null}}ot.aBoolean546=!1;const at=new Int32Array([0,1,3,7,15,31,63,127,255,511,1023,2047,4095,8191,16383,32767,65535,131071,262143,524287,1048575,2097151,4194303,8388607,16777215,33554431,67108863,134217727,268435455,536870911,1073741823,2147483647,-1]);class ht extends J{}ht.WELCOME=new ht("Welcome view"),ht.NEW_USER=new ht("New User view"),ht.EXISTING_USER=new ht("Existing User view");class lt extends J{}lt.APPEARANCE=new lt("Avatar Maker"),lt.CHAT=new lt("Game Chat");var ct={Utility:ot,GameState:{LOGIN:0,WORLD:1},WelcomeState:ht,GamePanel:lt};const{Utility:ut}=ct,mt="0".charCodeAt(0),dt="9".charCodeAt(0);class pt{constructor(t,e,i,s){this.image=null,this.landscapeColours=null,this.anIntArray340=null,this.anIntArray341=null,this.anIntArray342=null,this.anIntArray343=null,this.anIntArray344=null,this.anIntArray345=null,this.boundsTopY=0,this.boundsTopX=0,this.interlace=!1,this.loggedIn=!1,this.boundsBottomY=e,this.boundsBottomX=t,this.width1=this.width2=t,this.height1=this.height2=e,this.area=t*e,this.pixels=new Int32Array(t*e),this.surfacePixels=[],this.surfacePixels.length=i,this.surfacePixels.fill(null),this.spriteColoursUsed=[],this.spriteColoursUsed.length=i,this.spriteColoursUsed.fill(null),this.spriteColourList=[],this.spriteColourList.length=i,this.spriteColourList.fill(null),this.spriteTranslate=new Int8Array(i),this.spriteWidth=new Int32Array(i),this.spriteHeight=new Int32Array(i),this.spriteWidthFull=new Int32Array(i),this.spriteHeightFull=new Int32Array(i),this.spriteTranslateX=new Int32Array(i),this.spriteTranslateY=new Int32Array(i),this.imageData=s._graphics.ctx.getImageData(0,0,t,e),this.bufferedPixels=new Int32Array(t*e),this.pixelBytes=new Uint8ClampedArray(this.bufferedPixels.buffer),this.setComplete()}static rgbToLong(t,e,i){return(t<<16)+(e<<8)+i}static createFont(t,e){pt.gameFonts[e]=t}setComplete(){for(let e=0;e<this.area;e+=1)this.bufferedPixels[e]=255<<24|(255&(t=this.pixels[e]))<<16|(t>>8&255)<<8|t>>16&255;var t;this.imageData.data.set(this.pixelBytes,0)}setBounds(t,e,i,s){t<0&&(t=0),e<0&&(e=0),i>this.width2&&(i=this.width2),s>this.height2&&(s=this.height2),this.boundsTopX=t,this.boundsTopY=e,this.boundsBottomX=i,this.boundsBottomY=s}resetBounds(){this.boundsTopX=0,this.boundsTopY=0,this.boundsBottomX=this.width2,this.boundsBottomY=this.height2}draw(t,e,i){this.setComplete(),t.drawImage(this.imageData,e,i)}blackScreen(){let t=0;if(!this.interlace)for(let e=0;e<this.height2*this.width2;e++)this.pixels[e]=0;for(let e=0;e<this.height2;e+=2){for(let e=0;e<this.width2;e++)this.pixels[t++]=0;t+=this.width2}}drawCircle(t,e,i,s,r){let n=256-r,o=(s>>16&255)*r,a=(s>>8&255)*r,h=(255&s)*r,l=e-i;l<0&&(l=0);let c=e+i;c>=this.height2&&(c=this.height2-1);let u=1;this.interlace&&(u=2,0!=(1&l)&&l++);for(let m=l;m<=c;m+=u){let s=m-e,r=0|Math.sqrt(i*i-s*s),l=t-r;l<0&&(l=0);let c=t+r;c>=this.width2&&(c=this.width2-1);let u=l+m*this.width2;for(let t=l;t<=c;t++){let t=(this.pixels[u]>>16&255)*n,e=(this.pixels[u]>>8&255)*n,i=(255&this.pixels[u])*n;this.pixels[u++]=o+t>>8<<16|a+e>>8<<8|h+i>>8}}}drawBoxAlpha(t,e,i,s,r,n){t<this.boundsTopX&&(i-=this.boundsTopX-t,t=this.boundsTopX),e<this.boundsTopY&&(s-=this.boundsTopY-e,e=this.boundsTopY),t+i>this.boundsBottomX&&(i=this.boundsBottomX-t),e+s>this.boundsBottomY&&(s=this.boundsBottomY-e);let o=256-n,a=(r>>16&255)*n,h=(r>>8&255)*n,l=(255&r)*n,c=this.width2-i,u=1;this.interlace&&(u=2,c+=this.width2,0!=(1&e)&&(e++,s--));for(let m=t;m<t+i;m++)for(let t=e;t<e+s;t+=u){let e=t*this.width2+m,i=(this.pixels[e]>>16&255)*o,s=(this.pixels[e]>>8&255)*o,r=(255&this.pixels[e])*o;this.pixels[e]=a+i>>8<<16|h+s>>8<<8|l+r>>8}}drawGradient(t,e,i,s,r,n){t<this.boundsTopX&&(i-=this.boundsTopX-t,t=this.boundsTopX),t+i>this.boundsBottomX&&(i=this.boundsBottomX-t);let o=n>>16&255,a=n>>8&255,h=255&n,l=r>>16&255,c=r>>8&255,u=255&r,m=this.width2-i,d=1;this.interlace&&(d=2,m+=this.width2,0!=(1&e)&&(e++,s--));let p=t+e*this.width2;for(let g=0;g<s;g+=d)if(g+e>=this.boundsTopY&&g+e<this.boundsBottomY){let t=(o*g+l*(s-g))/s<<16|(a*g+c*(s-g))/s<<8|(h*g+u*(s-g))/s|0;for(let e=-i;e<0;e++)this.pixels[p++]=t;p+=m}else p+=this.width2}drawBox(t,e,i,s,r){t<this.boundsTopX&&(i-=this.boundsTopX-t,t=this.boundsTopX),e<this.boundsTopY&&(s-=this.boundsTopY-e,e=this.boundsTopY),t+i>this.boundsBottomX&&(i=this.boundsBottomX-t),e+s>this.boundsBottomY&&(s=this.boundsBottomY-e);let n=this.width2-i,o=1;this.interlace&&(o=2,n+=this.width2,0!=(1&e)&&(e++,s--));let a=t+e*this.width2;for(let h=-s;h<0;h+=o){for(let t=-i;t<0;t++)this.pixels[a++]=r;a+=n}}drawBoxEdge(t,e,i,s,r){this.drawLineHoriz(t,e,i,r),this.drawLineHoriz(t,e+s-1,i,r),this.drawLineVert(t,e,s,r),this.drawLineVert(t+i-1,e,s,r)}drawLineHoriz(t,e,i,s){if(e<this.boundsTopY||e>=this.boundsBottomY)return;t<this.boundsTopX&&(i-=this.boundsTopX-t,t=this.boundsTopX),t+i>this.boundsBottomX&&(i=this.boundsBottomX-t);let r=t+e*this.width2;for(let n=0;n<i;n++)this.pixels[r+n]=s}drawLineVert(t,e,i,s){if(t<this.boundsTopX||t>=this.boundsBottomX)return;e<this.boundsTopY&&(i-=this.boundsTopY-e,e=this.boundsTopY),e+i>this.boundsBottomX&&(i=this.boundsBottomY-e);let r=t+e*this.width2;for(let n=0;n<i;n++)this.pixels[r+n*this.width2]=s}setPixel(t,e,i){t<this.boundsTopX||e<this.boundsTopY||t>=this.boundsBottomX||e>=this.boundsBottomY||(this.pixels[t+e*this.width2]=i)}fadeToBlack(){let t=this.width2*this.height2;for(let e=0;e<t;e++){let t=16777215&this.pixels[e];this.pixels[e]=(t>>>1&8355711)+(t>>>2&4144959)+(t>>>3&2039583)+(t>>>4&986895)}}drawLineAlpha(t,e,i,s,r,n){for(let o=i;o<i+r;o++)for(let i=s;i<s+n;i++){let s=0,r=0,n=0,a=0;for(let h=o-t;h<=o+t;h++)if(h>=0&&h<this.width2)for(let t=i-e;t<=i+e;t++)if(t>=0&&t<this.height2){let e=this.pixels[h+this.width2*t];s+=e>>16&255,r+=e>>8&255,n+=255&e,a++}this.pixels[o+this.width2*i]=(s/a<<16)+(r/a<<8)+(n/a|0)}}clear(){for(let t=0;t<this.surfacePixels.length;t++)this.surfacePixels[t]=null,this.spriteWidth[t]=0,this.spriteHeight[t]=0,this.spriteColoursUsed[t]=null,this.spriteColourList[t]=null}parseSprite(t,e,i,s){let r=ut.getUnsignedShort(e,0),n=ut.getUnsignedShort(i,r);r+=2;let o=ut.getUnsignedShort(i,r);r+=2;let a=255&i[r++],h=new Int32Array(a);h[0]=16711935;for(let c=0;c<a-1;c++)h[c+1]=(255&i[r])<<16|(255&i[r+1])<<8|255&i[r+2],r+=3;let l=2;for(let c=t;c<t+s;c++){this.spriteTranslateX[c]=255&i[r++],this.spriteTranslateY[c]=255&i[r++],this.spriteWidth[c]=ut.getUnsignedShort(i,r),r+=2,this.spriteHeight[c]=ut.getUnsignedShort(i,r),r+=2;let t=255&i[r++],s=this.spriteWidth[c]*this.spriteHeight[c];if(this.spriteColoursUsed[c]=new Int8Array(s),this.spriteColourList[c]=h,this.spriteWidthFull[c]=n,this.spriteHeightFull[c]=o,this.surfacePixels[c]=null,this.spriteTranslate[c]=!1,0===this.spriteTranslateX[c]&&0===this.spriteTranslateY[c]||(this.spriteTranslate[c]=!0),0===t)for(let i=0;i<s;i++)this.spriteColoursUsed[c][i]=e[l++],0===this.spriteColoursUsed[c][i]&&(this.spriteTranslate[c]=!0);else if(1===t)for(let i=0;i<this.spriteWidth[c];i++)for(let t=0;t<this.spriteHeight[c];t++)this.spriteColoursUsed[c][i+t*this.spriteWidth[c]]=e[l++],0===this.spriteColoursUsed[c][i+t*this.spriteWidth[c]]&&(this.spriteTranslate[c]=!0)}}readSleepWord(t,e){let i=this.surfacePixels[t]=new Int32Array(10200);this.spriteWidth[t]=255,this.spriteHeight[t]=40,this.spriteTranslateX[t]=0,this.spriteTranslateY[t]=0,this.spriteWidthFull[t]=255,this.spriteHeightFull[t]=40,this.spriteTranslate[t]=!1;let s=0,r=1,n=0;for(n=0;n<255;){let t=255&e[r++];for(let e=0;e<t;e++)i[n++]=s;s=16777215-s}for(let o=1;o<40;o++)for(let t=0;t<255;){let s=255&e[r++];for(let e=0;e<s;e++)i[n]=i[n-255],n++,t++;t<255&&(i[n]=16777215-i[n-255],n++,t++)}}drawWorld(t){let e=this.spriteWidth[t]*this.spriteHeight[t],i=this.surfacePixels[t],s=new Int32Array(32768);for(let a=0;a<e;a++){let t=i[a];s[((16252928&t)>>9)+((63488&t)>>6)+((248&t)>>3)]++}let r=new Int32Array(256);r[0]=16711935;let n=new Int32Array(256);for(let a=0;a<32768;a++){let t=s[a];if(t>n[255])for(let e=1;e<256;e++)if(!(t<=n[e])){for(let t=255;t>e;t--)r[t]=r[t-1],n[t]=n[t-1];r[e]=((31744&a)<<9)+((992&a)<<6)+((31&a)<<3)+263172,n[e]=t;break}s[a]=-1}let o=new Int8Array(e);for(let a=0;a<e;a++){let t=i[a],e=((16252928&t)>>9)+((63488&t)>>6)+((248&t)>>3),n=s[e];if(-1===n){let i=999999999,o=t>>16&255,a=t>>8&255,h=255&t;for(let t=0;t<256;t++){let e=r[t],s=e>>16&255,l=e>>8&255,c=255&e,u=(o-s)*(o-s)+(a-l)*(a-l)+(h-c)*(h-c);u<i&&(i=u,n=t)}s[e]=n}o[a]=255&n}this.spriteColoursUsed[t]=o,this.spriteColourList[t]=r,this.surfacePixels[t]=null}loadSprite(t){if(null===this.spriteColoursUsed[t])return;let e=this.spriteWidth[t]*this.spriteHeight[t],i=this.spriteColoursUsed[t],s=this.spriteColourList[t],r=new Int32Array(e);for(let n=0;n<e;n++){let t=s[255&i[n]];0===t?t=1:16711935===t&&(t=0),r[n]=t}this.surfacePixels[t]=r,this.spriteColoursUsed[t]=null,this.spriteColourList[t]=null}drawSpriteMinimap(t,e,i,s,r){this.spriteWidth[t]=s,this.spriteHeight[t]=r,this.spriteTranslate[t]=!1,this.spriteTranslateX[t]=0,this.spriteTranslateY[t]=0,this.spriteWidthFull[t]=s,this.spriteHeightFull[t]=r;let n=s*r,o=0;this.surfacePixels[t]=new Int32Array(n);for(let a=e;a<e+s;a++)for(let e=i;e<i+r;e++)this.surfacePixels[t][o++]=this.pixels[a+e*this.width2]}_drawSprite_from5(t,e,i,s,r){this.spriteWidth[t]=s,this.spriteHeight[t]=r,this.spriteTranslate[t]=!1,this.spriteTranslateX[t]=0,this.spriteTranslateY[t]=0,this.spriteWidthFull[t]=s,this.spriteHeightFull[t]=r;let n=s*r,o=0;this.surfacePixels[t]=new Int32Array(n);for(let a=i;a<i+r;a++)for(let i=e;i<e+s;i++)this.surfacePixels[t][o++]=this.pixels[i+a*this.width2]}drawSpriteID(t,e,i){this.spriteTranslate[i]&&(t+=this.spriteTranslateX[i],e+=this.spriteTranslateY[i]);let s=t+e*this.width2,r=0,n=this.spriteHeight[i],o=this.spriteWidth[i],a=this.width2-o,h=0;if(e<this.boundsTopY){let t=this.boundsTopY-e;n-=t,e=this.boundsTopY,r+=t*o,s+=t*this.width2}if(e+n>=this.boundsBottomY&&(n-=e+n-this.boundsBottomY+1),t<this.boundsTopX){let e=this.boundsTopX-t;o-=e,t=this.boundsTopX,r+=e,s+=e,h+=e,a+=e}if(t+o>=this.boundsBottomX){let e=t+o-this.boundsBottomX+1;o-=e,h+=e,a+=e}if(o<=0||n<=0)return;let l=1;return this.interlace&&(l=2,a+=this.width2,h+=this.spriteWidth[i],0!=(1&e)&&(s+=this.width2,n--)),null===this.surfacePixels[i]?void this._drawSprite_from10A(this.pixels,this.spriteColoursUsed[i],this.spriteColourList[i],r,s,o,n,a,h,l):void this._drawSprite_from10(this.pixels,this.surfacePixels[i],0,r,s,o,n,a,h,l)}_spriteClipping_from5(t,i,s,r,n){try{let o=this.spriteWidth[n],a=this.spriteHeight[n],h=0,l=0,c=(o<<16)/s|0,u=(a<<16)/r|0;if(this.spriteTranslate[n]){let e=this.spriteWidthFull[n],o=this.spriteHeightFull[n];c=(e<<16)/s|0,u=(o<<16)/r|0,t+=(this.spriteTranslateX[n]*s+e-1)/e|0,i+=(this.spriteTranslateY[n]*r+o-1)/o|0,this.spriteTranslateX[n]*s%e!=0&&(h=(e-this.spriteTranslateX[n]*s%e<<16)/s|0),this.spriteTranslateY[n]*r%o!=0&&(l=(o-this.spriteTranslateY[n]*r%o<<16)/r|0),s=s*(this.spriteWidth[n]-(h>>16))/e|0,r=r*(this.spriteHeight[n]-(l>>16))/o|0}let m=t+i*this.width2,d=this.width2-s;if(i<this.boundsTopY){let t=this.boundsTopY-i;r-=t,i=0,m+=t*this.width2,l+=u*t}if(i+r>=this.boundsBottomY&&(r-=i+r-this.boundsBottomY+1),t<this.boundsTopX){let e=this.boundsTopX-t;s-=e,t=0,m+=e,h+=c*e,d+=e}if(t+s>=this.boundsBottomX){let e=t+s-this.boundsBottomX+1;s-=e,d+=e}let p=1;this.interlace&&(p=2,d+=this.width2,u+=u,0!=(1&i)&&(m+=this.width2,r--)),this._plotScale_from13(this.pixels,this.surfacePixels[n],0,h,l,m,d,s,r,c,u,o,p)}catch(e){console.log("error in sprite clipping routine")}}fadeThenDrawSpriteID(t,e,i,s){this.spriteTranslate[i]&&(t+=this.spriteTranslateX[i],e+=this.spriteTranslateY[i]);let r=t+e*this.width2,n=0,o=this.spriteHeight[i],a=this.spriteWidth[i],h=this.width2-a,l=0;if(e<this.boundsTopY){let t=this.boundsTopY-e;o-=t,e=this.boundsTopY,n+=t*a,r+=t*this.width2}if(e+o>=this.boundsBottomY&&(o-=e+o-this.boundsBottomY+1),t<this.boundsTopX){let e=this.boundsTopX-t;a-=e,t=this.boundsTopX,n+=e,r+=e,l+=e,h+=e}if(t+a>=this.boundsBottomX){let e=t+a-this.boundsBottomX+1;a-=e,l+=e,h+=e}if(a<=0||o<=0)return;let c=1;return this.interlace&&(c=2,h+=this.width2,l+=this.spriteWidth[i],0!=(1&e)&&(r+=this.width2,o--)),null===this.surfacePixels[i]?void this._drawSpriteAlpha_from11A(this.pixels,this.spriteColoursUsed[i],this.spriteColourList[i],n,r,a,o,h,l,c,s):void this._drawSpriteAlpha_from11(this.pixels,this.surfacePixels[i],0,n,r,a,o,h,l,c,s)}drawActionBubble(t,i,s,r,n,o){try{let a=this.spriteWidth[n],h=this.spriteHeight[n],l=0,c=0,u=(a<<16)/s|0,m=(h<<16)/r|0;if(this.spriteTranslate[n]){let e=this.spriteWidthFull[n],o=this.spriteHeightFull[n];u=(e<<16)/s|0,m=(o<<16)/r|0,t+=(this.spriteTranslateX[n]*s+e-1)/e|0,i+=(this.spriteTranslateY[n]*r+o-1)/o|0,this.spriteTranslateX[n]*s%e!=0&&(l=(e-this.spriteTranslateX[n]*s%e<<16)/s|0),this.spriteTranslateY[n]*r%o!=0&&(c=(o-this.spriteTranslateY[n]*r%o<<16)/r|0),s=s*(this.spriteWidth[n]-(l>>16))/e|0,r=r*(this.spriteHeight[n]-(c>>16))/o|0}let d=t+i*this.width2,p=this.width2-s;if(i<this.boundsTopY){let t=this.boundsTopY-i;r-=t,i=0,d+=t*this.width2,c+=m*t}if(i+r>=this.boundsBottomY&&(r-=i+r-this.boundsBottomY+1),t<this.boundsTopX){let e=this.boundsTopX-t;s-=e,t=0,d+=e,l+=u*e,p+=e}if(t+s>=this.boundsBottomX){let e=t+s-this.boundsBottomX+1;s-=e,p+=e}let g=1;return this.interlace&&(g=2,p+=this.width2,m+=m,0!=(1&i)&&(d+=this.width2,r--)),void this.transparentScale(this.pixels,this.surfacePixels[n],0,l,c,d,p,s,r,u,m,a,g,o)}catch(e){console.log("error in sprite clipping routine")}}_spriteClipping_from6(t,i,s,r,n,o){try{let a=this.spriteWidth[n],h=this.spriteHeight[n],l=0,c=0,u=(a<<16)/s|0,m=(h<<16)/r|0;if(this.spriteTranslate[n]){let e=this.spriteWidthFull[n],o=this.spriteHeightFull[n];u=(e<<16)/s|0,m=(o<<16)/r|0,t+=(this.spriteTranslateX[n]*s+e-1)/e|0,i+=(this.spriteTranslateY[n]*r+o-1)/o|0,this.spriteTranslateX[n]*s%e!=0&&(l=(e-this.spriteTranslateX[n]*s%e<<16)/s|0),this.spriteTranslateY[n]*r%o!=0&&(c=(o-this.spriteTranslateY[n]*r%o<<16)/r|0),s=s*(this.spriteWidth[n]-(l>>16))/e|0,r=r*(this.spriteHeight[n]-(c>>16))/o|0}let d=t+i*this.width2,p=this.width2-s;if(i<this.boundsTopY){let t=this.boundsTopY-i;r-=t,i=0,d+=t*this.width2,c+=m*t}if(i+r>=this.boundsBottomY&&(r-=i+r-this.boundsBottomY+1),t<this.boundsTopX){let e=this.boundsTopX-t;s-=e,t=0,d+=e,l+=u*e,p+=e}if(t+s>=this.boundsBottomX){let e=t+s-this.boundsBottomX+1;s-=e,p+=e}let g=1;return this.interlace&&(g=2,p+=this.width2,m+=m,0!=(1&i)&&(d+=this.width2,r--)),void this._plotScale_from14(this.pixels,this.surfacePixels[n],0,l,c,d,p,s,r,u,m,a,g,o)}catch(e){console.log("error in sprite clipping routine"),console.error(e)}}_drawSprite_from10(t,e,i,s,r,n,o,a,h,l){let c=-(n>>2);n=-(3&n);for(let u=-o;u<0;u+=l){for(let n=c;n<0;n++)0!==(i=e[s++])?t[r++]=i:r++,0!==(i=e[s++])?t[r++]=i:r++,0!==(i=e[s++])?t[r++]=i:r++,0!==(i=e[s++])?t[r++]=i:r++;for(let o=n;o<0;o++)0!==(i=e[s++])?t[r++]=i:r++;r+=a,s+=h}}_drawSprite_from10A(t,e,i,s,r,n,o,a,h,l){let c=-(n>>2);n=-(3&n);for(let u=-o;u<0;u+=l){for(let n=c;n<0;n++){let n=e[s++];0!==n?t[r++]=i[255&n]:r++,0!==(n=e[s++])?t[r++]=i[255&n]:r++,0!==(n=e[s++])?t[r++]=i[255&n]:r++,0!==(n=e[s++])?t[r++]=i[255&n]:r++}for(let o=n;o<0;o++){let n=e[s++];0!==n?t[r++]=i[255&n]:r++}r+=a,s+=h}}_plotScale_from13(t,i,s,r,n,o,a,h,l,c,u,m,d){try{let p=r;for(let e=-l;e<0;e+=d){let e=(n>>16)*m;for(let n=-h;n<0;n++)0!==(s=i[(r>>16)+e])?t[o++]=s:o++,r+=c;n+=u,r=p,o+=a}return}catch(e){console.log("error in plotScale")}}_drawSpriteAlpha_from11(t,e,i,s,r,n,o,a,h,l,c){let u=256-c;for(let m=-o;m<0;m+=l){for(let o=-n;o<0;o++)if(0!==(i=e[s++])){let e=t[r];t[r++]=((16711935&i)*c+(16711935&e)*u&-16711936)+((65280&i)*c+(65280&e)*u&16711680)>>8}else r++;r+=a,s+=h}}_drawSpriteAlpha_from11A(t,e,i,s,r,n,o,a,h,l,c){let u=256-c;for(let m=-o;m<0;m+=l){for(let o=-n;o<0;o++){let n=e[s++];if(0!==n){n=i[255&n];let e=t[r];t[r++]=((16711935&n)*c+(16711935&e)*u&-16711936)+((65280&n)*c+(65280&e)*u&16711680)>>8}else r++}r+=a,s+=h}}transparentScale(t,i,s,r,n,o,a,h,l,c,u,m,d,p){let g=256-p;try{let f=r;for(let e=-l;e<0;e+=d){let e=(n>>16)*m;for(let n=-h;n<0;n++){if(0!==(s=i[(r>>16)+e])){let e=t[o];t[o++]=((16711935&s)*p+(16711935&e)*g&-16711936)+((65280&s)*p+(65280&e)*g&16711680)>>8}else o++;r+=c}n+=u,r=f,o+=a}return}catch(e){console.log("error in tranScale")}}_plotScale_from14(t,i,s,r,n,o,a,h,l,c,u,m,d,p){let g=p>>16&255,f=p>>8&255,S=255&p;try{let p=r;for(let e=-l;e<0;e+=d){let e=(n>>16)*m;for(let n=-h;n<0;n++){if(0!==(s=i[(r>>16)+e])){let e=s>>16&255,i=s>>8&255,r=255&s;t[o++]=e===i&&i===r?(e*g>>8<<16)+(i*f>>8<<8)+(r*S>>8):s}else o++;r+=c}n+=u,r=p,o+=a}return}catch(e){console.log("error in plotScale")}}drawMinimapSprite(t,e,i,s,r){let n=this.width2,o=this.height2;if(null===this.landscapeColours){this.landscapeColours=new Int32Array(512);for(let t=0;t<256;t++)this.landscapeColours[t]=32768*Math.sin(.02454369*t)|0,this.landscapeColours[t+256]=32768*Math.cos(.02454369*t)|0}let a=-(this.spriteWidthFull[i]/2|0),h=-(this.spriteHeightFull[i]/2|0);this.spriteTranslate[i]&&(a+=this.spriteTranslateX[i],h+=this.spriteTranslateY[i]);let l=a+this.spriteWidth[i],c=h+this.spriteHeight[i],u=l,m=h,d=a,p=c;s&=255;let g=this.landscapeColours[s]*r,f=this.landscapeColours[s+256]*r,S=t+(h*g+a*f>>22),w=e+(h*f-a*g>>22),C=t+(m*g+u*f>>22),I=e+(m*f-u*g>>22),y=t+(c*g+l*f>>22),b=e+(c*f-l*g>>22),T=t+(p*g+d*f>>22),A=e+(p*f-d*g>>22);192===r&&(63&s)==(63&pt.anInt348)?pt.anInt346++:128===r?pt.anInt348=s:pt.anInt347++;let x=w,v=w;I<x?x=I:I>v&&(v=I),b<x?x=b:b>v&&(v=b),A<x?x=A:A>v&&(v=A),x<this.boundsTopY&&(x=this.boundsTopY),v>this.boundsBottomY&&(v=this.boundsBottomY),null!==this.anIntArray340&&this.anIntArray340.length===o+1||(this.anIntArray340=new Int32Array(o+1),this.anIntArray341=new Int32Array(o+1),this.anIntArray342=new Int32Array(o+1),this.anIntArray343=new Int32Array(o+1),this.anIntArray344=new Int32Array(o+1),this.anIntArray345=new Int32Array(o+1));for(let N=x;N<=v;N++)this.anIntArray340[N]=99999999,this.anIntArray341[N]=-99999999;let L=0,E=0,k=0,P=this.spriteWidth[i],B=this.spriteHeight[i];a=0,h=0,u=P-1,m=0,l=P-1,c=B-1,d=0,p=B-1,A!==w&&(L=(T-S<<8)/(A-w)|0,k=(p-h<<8)/(A-w)|0);let M=0,D=0,Y=0,X=0;w>A?(Y=T<<8,X=p<<8,M=A,D=w):(Y=S<<8,X=h<<8,M=w,D=A),M<0&&(Y-=L*M,X-=k*M,M=0),D>o-1&&(D=o-1);for(let N=M;N<=D;N++)this.anIntArray340[N]=this.anIntArray341[N]=Y,Y+=L,this.anIntArray342[N]=this.anIntArray343[N]=0,this.anIntArray344[N]=this.anIntArray345[N]=X,X+=k;I!==w&&(L=(C-S<<8)/(I-w)|0,E=(u-a<<8)/(I-w)|0);let O=0;w>I?(Y=C<<8,O=u<<8,M=I,D=w):(Y=S<<8,O=a<<8,M=w,D=I),M<0&&(Y-=L*M,O-=E*M,M=0),D>o-1&&(D=o-1);for(let N=M;N<=D;N++)Y<this.anIntArray340[N]&&(this.anIntArray340[N]=Y,this.anIntArray342[N]=O,this.anIntArray344[N]=0),Y>this.anIntArray341[N]&&(this.anIntArray341[N]=Y,this.anIntArray343[N]=O,this.anIntArray345[N]=0),Y+=L,O+=E;b!==I&&(L=(y-C<<8)/(b-I)|0,k=(c-m<<8)/(b-I)|0),I>b?(Y=y<<8,O=l<<8,X=c<<8,M=b,D=I):(Y=C<<8,O=u<<8,X=m<<8,M=I,D=b),M<0&&(Y-=L*M,X-=k*M,M=0),D>o-1&&(D=o-1);for(let N=M;N<=D;N++)Y<this.anIntArray340[N]&&(this.anIntArray340[N]=Y,this.anIntArray342[N]=O,this.anIntArray344[N]=X),Y>this.anIntArray341[N]&&(this.anIntArray341[N]=Y,this.anIntArray343[N]=O,this.anIntArray345[N]=X),Y+=L,X+=k;A!==b&&(L=(T-y<<8)/(A-b)|0,E=(d-l<<8)/(A-b)|0),b>A?(Y=T<<8,O=d<<8,X=p<<8,M=A,D=b):(Y=y<<8,O=l<<8,X=c<<8,M=b,D=A),M<0&&(Y-=L*M,O-=E*M,M=0),D>o-1&&(D=o-1);for(let N=M;N<=D;N++)Y<this.anIntArray340[N]&&(this.anIntArray340[N]=Y,this.anIntArray342[N]=O,this.anIntArray344[N]=X),Y>this.anIntArray341[N]&&(this.anIntArray341[N]=Y,this.anIntArray343[N]=O,this.anIntArray345[N]=X),Y+=L,O+=E;let R=x*n,j=this.surfacePixels[i];for(let N=x;N<v;N++){let t=this.anIntArray340[N]>>8,e=this.anIntArray341[N]>>8;if(e-t<=0)R+=n;else{let s=this.anIntArray342[N]<<9,r=((this.anIntArray343[N]<<9)-s)/(e-t)|0,o=this.anIntArray344[N]<<9,a=((this.anIntArray345[N]<<9)-o)/(e-t)|0;t<this.boundsTopX&&(s+=(this.boundsTopX-t)*r,o+=(this.boundsTopX-t)*a,t=this.boundsTopX),e>this.boundsBottomX&&(e=this.boundsBottomX),this.interlace&&0!=(1&N)||(this.spriteTranslate[i]?this.drawMinimapTranslate(this.pixels,j,0,R+t,s,o,r,a,t-e,P):this.drawMinimap(this.pixels,j,0,R+t,s,o,r,a,t-e,P)),R+=n}}}drawMinimap(t,e,i,s,r,n,o,a,h,l){for(i=h;i<0;i++)this.pixels[s++]=e[(r>>17)+(n>>17)*l],r+=o,n+=a}drawMinimapTranslate(t,e,i,s,r,n,o,a,h,l){for(let c=h;c<0;c++)0!==(i=e[(r>>17)+(n>>17)*l])?this.pixels[s++]=i:s++,r+=o,n+=a}_spriteClipping_from7(t,e,i,s,r,n,o){this._spriteClipping_from5(t,e,i,s,r)}_spriteClipping_from9(t,i,s,r,n,o,a,h,l){try{0===o&&(o=16777215),0===a&&(a=16777215);let c=this.spriteWidth[n],u=this.spriteHeight[n],m=0,d=0,p=h<<16,g=(c<<16)/s|0,f=(u<<16)/r|0,S=-((h<<16)/r|0);if(this.spriteTranslate[n]){let e=this.spriteWidthFull[n],o=this.spriteHeightFull[n];g=(e<<16)/s|0,f=(o<<16)/r|0;let a=this.spriteTranslateX[n],h=this.spriteTranslateY[n];l&&(a=e-this.spriteWidth[n]-a),t+=(a*s+e-1)/e|0;let c=(h*r+o-1)/o|0;i+=c,p+=c*S,a*s%e!=0&&(m=(e-a*s%e<<16)/s|0),h*r%o!=0&&(d=(o-h*r%o<<16)/r|0),s=((this.spriteWidth[n]<<16)-m+g-1)/g|0,r=((this.spriteHeight[n]<<16)-d+f-1)/f|0}let w=i*this.width2;if(p+=t<<16,i<this.boundsTopY){let t=this.boundsTopY-i;r-=t,i=this.boundsTopY,w+=t*this.width2,d+=f*t,p+=S*t}i+r>=this.boundsBottomY&&(r-=i+r-this.boundsBottomY+1);let C=w/this.width2&1;return this.interlace||(C=2),16777215===a?null!==this.surfacePixels[n]?l?void this._transparentSpritePlot_from15(this.pixels,this.surfacePixels[n],0,(this.spriteWidth[n]<<16)-m-1,d,w,s,r,-g,f,c,o,p,S,C):void this._transparentSpritePlot_from15(this.pixels,this.surfacePixels[n],0,m,d,w,s,r,g,f,c,o,p,S,C):l?void this._transparentSpritePlot_from16A(this.pixels,this.spriteColoursUsed[n],this.spriteColourList[n],0,(this.spriteWidth[n]<<16)-m-1,d,w,s,r,-g,f,c,o,p,S,C):void this._transparentSpritePlot_from16A(this.pixels,this.spriteColoursUsed[n],this.spriteColourList[n],0,m,d,w,s,r,g,f,c,o,p,S,C):null!==this.surfacePixels[n]?l?void this._transparentSpritePlot_from16(this.pixels,this.surfacePixels[n],0,(this.spriteWidth[n]<<16)-m-1,d,w,s,r,-g,f,c,o,a,p,S,C):void this._transparentSpritePlot_from16(this.pixels,this.surfacePixels[n],0,m,d,w,s,r,g,f,c,o,a,p,S,C):l?void this._transparentSpritePlot_from17(this.pixels,this.spriteColoursUsed[n],this.spriteColourList[n],0,(this.spriteWidth[n]<<16)-m-1,d,w,s,r,-g,f,c,o,a,p,S,C):void this._transparentSpritePlot_from17(this.pixels,this.spriteColoursUsed[n],this.spriteColourList[n],0,m,d,w,s,r,g,f,c,o,a,p,S,C)}catch(e){console.log("error in sprite clipping routine"),console.error(e)}}_transparentSpritePlot_from15(t,i,s,r,n,o,a,h,l,c,u,m,d,p,g){let f=m>>16&255,S=m>>8&255,w=255&m;try{let m=r;for(let e=-h;e<0;e++){let e=(n>>16)*u,h=d>>16,C=a;if(h<this.boundsTopX){let t=this.boundsTopX-h;C-=t,h=this.boundsTopX,r+=l*t}if(h+C>=this.boundsBottomX&&(C-=h+C-this.boundsBottomX),0!=(g=1-g))for(let n=h;n<h+C;n++){if(0!==(s=i[(r>>16)+e])){let e=s>>16&255,i=s>>8&255,r=255&s;t[n+o]=e===i&&i===r?(e*f>>8<<16)+(i*S>>8<<8)+(r*w>>8):s}r+=l}n+=c,r=m,o+=this.width2,d+=p}return}catch(e){console.log("error in transparent sprite plot routine")}}_transparentSpritePlot_from16(t,i,s,r,n,o,a,h,l,c,u,m,d,p,g,f){let S=m>>16&255,w=m>>8&255,C=255&m,I=d>>16&255,y=d>>8&255,b=255&d;try{let m=r;for(let e=-h;e<0;e++){let e=(n>>16)*u,h=p>>16,d=a;if(h<this.boundsTopX){let t=this.boundsTopX-h;d-=t,h=this.boundsTopX,r+=l*t}if(h+d>=this.boundsBottomX&&(d-=h+d-this.boundsBottomX),0!=(f=1-f))for(let n=h;n<h+d;n++){if(0!==(s=i[(r>>16)+e])){let e=s>>16&255,i=s>>8&255,r=255&s;t[n+o]=e===i&&i===r?(e*S>>8<<16)+(i*w>>8<<8)+(r*C>>8):255===e&&i===r?(e*I>>8<<16)+(i*y>>8<<8)+(r*b>>8):s}r+=l}n+=c,r=m,o+=this.width2,p+=g}return}catch(e){console.log("error in transparent sprite plot routine")}}_transparentSpritePlot_from16A(t,i,s,r,n,o,a,h,l,c,u,m,d,p,g,f){let S=d>>16&255,w=d>>8&255,C=255&d;try{let d=n;for(let e=-l;e<0;e++){let e=(o>>16)*m,l=p>>16,I=h;if(l<this.boundsTopX){let t=this.boundsTopX-l;I-=t,l=this.boundsTopX,n+=c*t}if(l+I>=this.boundsBottomX&&(I-=l+I-this.boundsBottomX),0!=(f=1-f))for(let o=l;o<l+I;o++){if(0!=(r=255&i[(n>>16)+e])){let e=(r=s[r])>>16&255,i=r>>8&255,n=255&r;t[o+a]=e===i&&i===n?(e*S>>8<<16)+(i*w>>8<<8)+(n*C>>8):r}n+=c}o+=u,n=d,a+=this.width2,p+=g}return}catch(e){console.log("error in transparent sprite plot routine")}}_transparentSpritePlot_from17(t,i,s,r,n,o,a,h,l,c,u,m,d,p,g,f,S){let w=d>>16&255,C=d>>8&255,I=255&d,y=p>>16&255,b=p>>8&255,T=255&p;try{let d=n;for(let e=-l;e<0;e++){let e=(o>>16)*m,l=g>>16,p=h;if(l<this.boundsTopX){let t=this.boundsTopX-l;p-=t,l=this.boundsTopX,n+=c*t}if(l+p>=this.boundsBottomX&&(p-=l+p-this.boundsBottomX),0!=(S=1-S))for(let o=l;o<l+p;o++){if(0!=(r=255&i[(n>>16)+e])){let e=(r=s[r])>>16&255,i=r>>8&255,n=255&r;t[o+a]=e===i&&i===n?(e*w>>8<<16)+(i*C>>8<<8)+(n*I>>8):255===e&&i===n?(e*y>>8<<16)+(i*b>>8<<8)+(n*T>>8):r}n+=c}o+=u,n=d,a+=this.width2,g+=f}return}catch(e){console.log("error in transparent sprite plot routine")}}drawStringRight(t,e,i,s,r){this.drawString(t,e-this.textWidth(t,s),i,s,r)}drawStringCenter(t,e,i,s,r){this.drawString(t,e-(this.textWidth(t,s)/2|0),i,s,r)}centrepara(t,i,s,r,n,o){try{let a=0,h=pt.gameFonts[r],l=0,c=0;for(let e=0;e<t.length;e++)"@"===t[e]&&e+4<t.length&&"@"===t[e+4]?e+=4:"~"===t[e]&&e+4<t.length&&"~"===t[e+4]?e+=4:a+=h[pt.characterWidth[t.charCodeAt(e)]+7]," "===t[e]&&(c=e),"%"===t[e]&&(c=e,a=1e3),a>o&&(c<=l&&(c=e),this.drawStringCenter(t.slice(l,c),i,s,r,n),a=0,l=e=c+1,s+=this.textHeight(r));if(a>0)return void this.drawStringCenter(t.slice(l),i,s,r,n)}catch(e){console.error(e)}}drawString(t,i,s,r,n){try{let o=pt.gameFonts[r];for(let e=0;e<t.length;e++)if("@"===t[e]&&e+4<t.length&&"@"===t[e+4])"red"===t.slice(e+1,e+4).toLowerCase()?n=16711680:"lre"===t.slice(e+1,e+4).toLowerCase()?n=16748608:"yel"===t.slice(e+1,e+4).toLowerCase()?n=16776960:"gre"===t.slice(e+1,e+4).toLowerCase()?n=65280:"blu"===t.slice(e+1,e+4).toLowerCase()?n=255:"cya"===t.slice(e+1,e+4).toLowerCase()?n=65535:"mag"===t.slice(e+1,e+4).toLowerCase()?n=16711935:"whi"===t.slice(e+1,e+4).toLowerCase()?n=16777215:"bla"===t.slice(e+1,e+4).toLowerCase()?n=0:"dre"===t.slice(e+1,e+4).toLowerCase()?n=12582912:"ora"===t.slice(e+1,e+4).toLowerCase()?n=16748608:"ran"===t.slice(e+1,e+4).toLowerCase()?n=16777215*Math.random()|0:"or1"===t.slice(e+1,e+4).toLowerCase()?n=16756736:"or2"===t.slice(e+1,e+4).toLowerCase()?n=16740352:"or3"===t.slice(e+1,e+4).toLowerCase()?n=16723968:"gr1"===t.slice(e+1,e+4).toLowerCase()?n=12648192:"gr2"===t.slice(e+1,e+4).toLowerCase()?n=8453888:"gr3"===t.slice(e+1,e+4).toLowerCase()&&(n=4259584),e+=4;else if("~"===t[e]&&e+4<t.length&&"~"===t[e+4]){let s=t.charCodeAt(e+1),r=t.charCodeAt(e+2),n=t.charCodeAt(e+3);s>=mt&&s<=dt&&r>=mt&&r<=dt&&n>=mt&&n<=dt&&(i=0|Number(t.substring(e+1,e+4))),e+=4}else{let r=pt.characterWidth[t.charCodeAt(e)];this.loggedIn&&0!==n&&(this.drawCharacter(r,i+1,s,0,o),this.drawCharacter(r,i,s+1,0,o)),this.drawCharacter(r,i,s,n,o),i+=o[r+7]}return}catch(e){return void console.error(e)}}drawCharacter(t,e,i,s,r){let n=e+r[t+5],o=i-r[t+6],a=r[t+3],h=r[t+4],l=16384*r[t]+128*r[t+1]+r[t+2],c=n+o*this.width2,u=this.width2-a,m=0;if(o<this.boundsTopY){let t=this.boundsTopY-o;h-=t,o=this.boundsTopY,l+=t*a,c+=t*this.width2}if(o+h>=this.boundsBottomY&&(h-=o+h-this.boundsBottomY+1),n<this.boundsTopX){let t=this.boundsTopX-n;a-=t,n=this.boundsTopX,l+=t,c+=t,m+=t,u+=t}if(n+a>=this.boundsBottomX){let t=n+a-this.boundsBottomX+1;a-=t,m+=t,u+=t}a>0&&h>0&&this.plotLetter(this.pixels,r,s,l,c,a,h,u,m)}plotLetter(t,i,s,r,n,o,a,h,l){try{let c=-(o>>2);o=-(3&o);for(let e=-a;e<0;e++){for(let e=c;e<0;e++)0!==i[r++]?t[n++]=s:n++,0!==i[r++]?t[n++]=s:n++,0!==i[r++]?t[n++]=s:n++,0!==i[r++]?t[n++]=s:n++;for(let e=o;e<0;e++)0!==i[r++]?t[n++]=s:n++;n+=h,r+=l}return}catch(e){return void console.error(e)}}method259(t,e,i,s,r,n,o,a,h){for(let l=-o;l<0;l++){for(let o=-n;o<0;o++){let n=255&e[s++];if(n>30)if(n>=230)t[r++]=i;else{let e=t[r];t[r++]=((16711935&i)*n+(16711935&e)*(256-n)&4278255360)+((65280&i)*n+(65280&e)*(256-n)&16711680)>>8}else r++}r+=a,s+=h}}textHeight(t){return 0===t?12:1===t?14:2===t?14:3===t?15:4===t?15:5===t?19:6===t?24:7===t?29:this.textHeightFont(t)}textHeightFont(t){return 0===t?pt.gameFonts[t][8]-2:pt.gameFonts[t][8]-1}textWidth(t,e){let i=0,s=pt.gameFonts[e];for(let r=0;r<t.length;r++)"@"===t[r]&&r+4<t.length&&"@"===t[r+4]?r+=4:"~"===t[r]&&r+4<t.length&&"~"===t[r+4]?r+=4:i+=s[pt.characterWidth[t.charCodeAt(r)]+7];return i}}pt.anInt346=0,pt.anInt347=0,pt.anInt348=0,pt.gameFonts=[],pt.gameFonts.length=50,pt.gameFonts.fill(null),pt.characterWidth=new Int32Array(256);for(let e=0;e<256;e++){let t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!\"\xa3$%^&*()-_=+[{]};:'@#~,<.>/?\\| ".indexOf(String.fromCharCode(e));-1===t&&(t=74),pt.characterWidth[e]=9*t}var gt=pt,ft={};!function(t){"use strict";function e(){this.load(arguments[0])}function i(t,e,i,s,r,n,o,a,h,l){var c,u,m,d,p,g,f=this.header.colorMapDepth>>3;for(d=0,g=r;g!==o;g+=n)for(p=a;p!==l;p+=h,d++)m=4*(p+s*g),u=e[d]*f,4===f?(t[m]=i[u+2],t[m+1]=i[u+1],t[m+2]=i[u],t[m+3]=i[u+3]):3===f?(t[m]=i[u+2],t[m+1]=i[u+1],t[m+2]=i[u],t[m+3]=255):2===f&&(c=i[u]|i[u+1]<<8,t[m]=(31744&c)>>7,t[m+1]=(992&c)>>2,t[m+2]=(31&c)<<3,t[m+3]=32768&c?0:255);return t}function s(t,e,i,s,r,n,o,a,h,l){var c,u,m,d,p;for(m=0,p=r;p!==o;p+=n)for(d=a;d!==l;d+=h,m+=2)c=e[m]|e[m+1]<<8,t[u=4*(d+s*p)]=(31744&c)>>7,t[u+1]=(992&c)>>2,t[u+2]=(31&c)<<3,t[u+3]=32768&c?0:255;return t}function r(t,e,i,s,r,n,o,a,h,l){var c,u,m,d,p=this.header.pixelDepth>>3;for(u=0,d=r;d!==o;d+=n)for(m=a;m!==l;m+=h,u+=p)t[3+(c=4*(m+s*d))]=255,t[c+2]=e[u],t[c+1]=e[u+1],t[c]=e[u+2];return t}function n(t,e,i,s,r,n,o,a,h,l){var c,u,m,d;for(c=0,m=r;m!==o;m+=n)for(u=a;u!==l;u+=h,c+=4)t[2+(d=4*(u+s*m))]=e[c],t[d+1]=e[c+1],t[d]=e[c+2],t[d+3]=e[c+3];return t}function o(t,e,i,s,r,n,o,a,h,l){var c,u,m,d,p;for(c=0,m=r;m!==o;m+=n)for(u=a;u!==l;u+=h,c+=4)d=4*(u+s*m),p=255*e[c+3],t[d+2]=e[c]/p,t[d+1]=e[c+1]/p,t[d]=e[c+2]/p,t[d+3]=e[c+3];return t}function a(t,e,i,s,r,n,o,a,h,l){var c,u,m,d,p;for(m=0,p=r;p!==o;p+=n)for(d=a;d!==l;d+=h,m++)c=e[m],t[u=4*(d+s*p)]=c,t[u+1]=c,t[u+2]=c,t[u+3]=255;return t}function h(t,e,i,s,r,n,o,a,h,l){var c,u,m,d,p;for(m=0,p=r;p!==o;p+=n)for(d=a;d!==l;d+=h,m+=2)c=e[m],t[u=4*(d+s*p)]=c,t[u+1]=c,t[u+2]=c,t[u+3]=e[m+1];return t}e.Type={NO_DATA:0,INDEXED:1,RGB:2,GREY:3,RLE_INDEXED:9,RLE_RGB:10,RLE_GREY:11},e.Origin={BOTTOM_LEFT:0,BOTTOM_RIGHT:1,TOP_LEFT:2,TOP_RIGHT:3,SHIFT:4,MASK:48,ALPHA:8},e.HEADER_SIZE=18,e.FOOTER_SIZE=26,e.LITTLE_ENDIAN=!0,e.RLE_BIT=128,e.RLE_MASK=127,e.RLE_PACKET=1,e.RAW_PACKET=2,e.SIGNATURE="TRUEVISION-XFILE.\0",e.prototype.open=function(t,e){var i,s=this;(i=new XMLHttpRequest).open("GET",t,!0),i.responseType="arraybuffer",i.onload=function(){200===this.status&&(s.arrayBuffer=i.response,s.load(s.arrayBuffer),e&&e.call(s))},i.send(null)},e.prototype.load=function(t){var i,s=new DataView(t);this.headerData=new Uint8Array(t,0,e.HEADER_SIZE),this.header=function(t){var i=e.LITTLE_ENDIAN;if(t.byteLength<18)throw new Error("Targa::load() - Not enough data to contain header");var s={};return s.idLength=t.getUint8(0),s.colorMapType=t.getUint8(1),s.imageType=t.getUint8(2),s.colorMapIndex=t.getUint16(3,i),s.colorMapLength=t.getUint16(5,i),s.colorMapDepth=t.getUint8(7),s.offsetX=t.getUint16(8,i),s.offsetY=t.getUint16(10,i),s.width=t.getUint16(12,i),s.height=t.getUint16(14,i),s.pixelDepth=t.getUint8(16),s.flags=t.getUint8(17),s}(s),(i=this.header).hasEncoding=i.imageType===e.Type.RLE_INDEXED||i.imageType===e.Type.RLE_RGB||i.imageType===e.Type.RLE_GREY,i.hasColorMap=i.imageType===e.Type.RLE_INDEXED||i.imageType===e.Type.INDEXED,i.isGreyColor=i.imageType===e.Type.RLE_GREY||i.imageType===e.Type.GREY,i.bytePerPixel=i.pixelDepth>>3,i.origin=(i.flags&e.Origin.MASK)>>e.Origin.SHIFT,i.alphaBits=i.flags&e.Origin.ALPHA,function(t){if(t.imageType===e.Type.NO_DATA)throw new Error("Targa::checkHeader() - No data");if(t.hasColorMap){if(t.colorMapLength>256||1!==t.colorMapType)throw new Error("Targa::checkHeader() - Unsupported colormap for indexed type");if(16!==t.colorMapDepth&&24!==t.colorMapDepth&&32!==t.colorMapDepth)throw new Error("Targa::checkHeader() - Unsupported colormap depth")}else if(t.colorMapType)throw new Error("Targa::checkHeader() - Why does the image contain a palette ?");if(t.width<=0||t.height<=0)throw new Error("Targa::checkHeader() - Invalid image size");if(8!==t.pixelDepth&&16!==t.pixelDepth&&24!==t.pixelDepth&&32!==t.pixelDepth)throw new Error('Targa::checkHeader() - Invalid pixel size "'+t.pixelDepth+'"');if(0!==t.alphaBits&&1!==t.alphaBits&&8!==t.alphaBits)throw new Error("Targa::checkHeader() - Unsuppported alpha size")}(this.header);var r=e.HEADER_SIZE;if((r+=this.header.idLength)>=t.byteLength)throw new Error("Targa::load() - No data");if(this.header.hasColorMap){var n=this.header.colorMapLength*(this.header.colorMapDepth>>3);this.palette=new Uint8Array(t,r,n),r+=n}var o=this.header.pixelDepth>>3,a=this.header.width*this.header.height,h=a*o;if(this.header.hasEncoding){var l=t.byteLength-r-e.FOOTER_SIZE,c=new Uint8Array(t,r,l);this.imageData=function(t,i,s){var r,n,o,a,h,l,c;for(c=new Uint8Array(s),l=new Uint8Array(i),h=0,r=0;r<s;)if(o=1+((n=t[h++])&e.RLE_MASK),n&e.RLE_BIT){for(a=0;a<i;++a)l[a]=t[h++];for(a=0;a<o;++a)c.set(l,r),r+=i}else for(o*=i,a=0;a<o;++a)c[r++]=t[h++];if(r>s)throw new Error("Targa::decodeRLE() - Read bytes: "+r+" Expected bytes: "+s);return c}(c,o,h)}else this.imageData=new Uint8Array(t,r,this.header.hasColorMap?a:h);this.footer=function(t){var i=t.byteLength-e.FOOTER_SIZE,s=e.SIGNATURE,r={},n=new Uint8Array(t.buffer,i+8,s.length);return function(t){for(var i=e.SIGNATURE,s=0;s<i.length;s++)if(t.charCodeAt(s)!==i.charCodeAt(s))return!1;return!0}(String.fromCharCode.apply(null,n))?(r.hasFooter=!0,r.extensionOffset=t.getUint32(i,e.LITTLE_ENDIAN),r.developerOffset=t.getUint32(i+4,e.LITTLE_ENDIAN),r.hasExtensionArea=0!==r.extensionOffset,r.hasDeveloperArea=0!==r.developerOffset,r.extensionOffset&&(r.attributeType=t.getUint8(r.extensionOffset+494)),r):(r.hasFooter=!1,r)}(s),(0!==this.header.alphaBits||this.footer.hasExtensionArea&&(3===this.footer.attributeType||4===this.footer.attributeType))&&(this.footer.usesAlpha=!0)},e.prototype.getImageData=function(t){var l,c,u,m,d,p,g,f=this.header.width,S=this.header.height,w=(this.header.flags&e.Origin.MASK)>>e.Origin.SHIFT;switch(t||(t=document?document.createElement("canvas").getContext("2d",{alpha:!0,desynchronized:!0,depth:!0,antialias:!0}).createImageData(f,S):{width:f,height:S,data:new Uint8ClampedArray(f*S*4)}),w===e.Origin.TOP_LEFT||w===e.Origin.TOP_RIGHT?(m=0,d=1,p=S):(m=S-1,d=-1,p=-1),w===e.Origin.TOP_LEFT||w===e.Origin.BOTTOM_LEFT?(l=0,c=1,u=f):(l=f-1,c=-1,u=-1),this.header.pixelDepth){case 8:g=this.header.isGreyColor?a:i;break;case 16:g=this.header.isGreyColor?h:s;break;case 24:g=r;break;case 32:g=this.footer.hasExtensionArea?3===this.footer.attributeType?n:4===this.footer.attributeType?o:r:0!==this.header.alphaBits?n:r}return g.call(this,t.data,this.imageData,this.palette,f,m,d,p,l,c,u),t},e.prototype.setImageData=function(t){if(!t)throw new Error("Targa::setImageData() - imageData argument missing");var i,s,r,o,a,h,l=this.header.width,c=this.header.height,u=l*c*(this.header.pixelDepth>>3),m=(this.header.flags&e.Origin.MASK)>>e.Origin.SHIFT;m===e.Origin.TOP_LEFT||m===e.Origin.TOP_RIGHT?(o=0,a=1,h=c):(o=c-1,a=-1,h=-1),m===e.Origin.TOP_LEFT||m===e.Origin.BOTTOM_LEFT?(i=0,s=1,r=l):(i=l-1,s=-1,r=-1),this.imageData||(this.imageData=new Uint8Array(u)),n(this.imageData,t.data,this.palette,l,o,a,h,i,s,r);var d=this.imageData;this.header.hasEncoding&&(d=function(t,i){for(var s,r,n,o,a=i,h=[],l=0,c=t.pixelDepth>>3,u=0,m=t.width*t.height*c,d=function(t,e){for(var i=0;i<c;i++)if(a[t*c+i]!==a[e*c+i])return!1;return!0},p=function(t){return d(t,t+1)?e.RLE_PACKET:e.RAW_PACKET};l*c<a.length&&l*c<m;){if(n=0,(r=p(l))===e.RLE_PACKET)for(;l+n<a.length&&n<128&&d(l,l+n);)n++;else for(;l+n<a.length&&n<128&&p(l+n)===e.RAW_PACKET;)n++;if(o=n-1,r===e.RLE_PACKET&&(o|=e.RLE_BIT),h[u++]=o,r===e.RLE_PACKET){for(s=0;s<c;s++)h[s+u]=a[s+l*c];u+=c}else{for(s=0;s<c*n;s++)h[s+u]=a[s+l*c];u+=c*n}l+=n}return new Uint8Array(h)}(this.header,d));var p=e.HEADER_SIZE+d.length+e.FOOTER_SIZE,g=new ArrayBuffer(p);this.arrayBuffer=g,this.headerData=new Uint8Array(g,0,e.HEADER_SIZE),this.RLEData=new Uint8Array(g,e.HEADER_SIZE,d.length),this.footerData=new Uint8Array(g,e.HEADER_SIZE+d.length,e.FOOTER_SIZE);var f,S,w,C=new DataView(this.headerData.buffer);f=this.header,S=C,w=e.LITTLE_ENDIAN,S.setUint8(0,f.idLength),S.setUint8(1,f.colorMapType),S.setUint8(2,f.imageType),S.setUint16(3,f.colorMapIndex,w),S.setUint16(5,f.colorMapLength,w),S.setUint8(7,f.colorMapDepth),S.setUint16(8,f.offsetX,w),S.setUint16(10,f.offsetY,w),S.setUint16(12,f.width,w),S.setUint16(14,f.height,w),S.setUint8(16,f.pixelDepth),S.setUint8(17,f.flags),this.RLEData.set(d),function(t){for(var i=e.SIGNATURE,s=t.byteLength-i.length,r=0;r<i.length;r++)t[s+r]=i.charCodeAt(r)}(this.footerData)},e.prototype.getCanvas=function(){var t,e,i;return i=(e=(t=document.createElement("canvas")).getContext("2d")).createImageData(this.header.width,this.header.height),t.width=this.header.width,t.height=this.header.height,e.putImageData(this.getImageData(i),0,0),t},e.prototype.getDataURL=function(t){return this.getCanvas().toDataURL(t||"image/png")},e.prototype.getBlobURL=function(){if(!this.arrayBuffer)throw new Error("Targa::getBlobURL() - No data available for blob");var t=new Blob([this.arrayBuffer],{type:"image/x-tga"});return URL.createObjectURL(t)};var l={};void 0===ft?"function"==typeof define&&"object"==typeof define.amd&&define.amd?define(function(){return e}):l.exports="undefined"!=typeof window?window:t:l.exports=ft,l.exports&&(l.exports.TGA=e)}(this);var St=setTimeout,wt=function(t){function e(t){return i.then(function(){return t})}var i=function(t,e){var i=e.useCachedSetTimeout?St:setTimeout;return new Promise(function(e){i(e,t)})}(t,{useCachedSetTimeout:(1<arguments.length&&void 0!==arguments[1]?arguments[1]:{}).useCachedSetTimeout});return e.then=function(){return i.then.apply(i,arguments)},e.catch=Promise.resolve().catch,e},Ct={};const{Utility:It,WelcomeState:yt,GameState:bt,GamePanel:Tt}=ct,{TGA:At}=ft,{FontStyle:xt}=a,{Enum:vt}=h;class Lt extends vt{}Lt.LAUNCH=new Lt("Launching game engine"),Lt.INITIALIZE_DATA=new Lt("Downloading and setting up all the game assets"),Lt.RUNNING=new Lt("Engine clock is ticking"),Lt.SHUTDOWN=new Lt("Engine is shutting down");class Et{constructor(t){this._canvas=t,this._graphics=new K(this._canvas),this.options={middleClickCamera:!1,mouseWheel:!1,resetCompass:!1,zoomCamera:!1,showRoofs:!1},this.loopData={frameIndex:0,updateFactor:256,lastUpdateFactor:256,sleepDuration:1,lastSleepDuration:1,updateCounter:0,intex:0},this.middleButtonDown=!1,this.mouseScrollDelta=0,this.mouseActionTimeout=0,this.panelLogin={},this.panelGame={},this.engineState=Lt.IDLE,this.gameState=bt.LOGIN,this.welcomeState=yt.WELCOME,this.controlTextListAll=0,this.mouseX=0,this.mouseY=0,this.mouseButtonDown=0,this.lastMouseButtonDown=0,this.timings=[],this.shutdownCounter=0,this.loadingProgressPercent=0,this.imageLogo=null,this.appletWidth=512,this.appletHeight=346,this.targetFrameTime=20,this.hasRefererLogoNotUsed=!1,this.loadingProgessText="Loading",this.showFps=!1,this.keyLeft=!1,this.keyRight=!1,this.keyUp=!1,this.keyDown=!1,this.keySpace=!1,this.keyHome=!1,this.keyPgUp=!1,this.keyPgDown=!1,this.maxTickTimeout=1,this.interlace=!1,this.inputTextCurrent="",this.inputTextFinal="",this.inputPmCurrent="",this.inputPmFinal="",this.lastLog=[],this.lastLogIdx=0,this.threadSleep2=1}async startApplication(t,e){this.engineState=Lt.IDLE,this._canvas.width=t,this._canvas.height=e,this.appletWidth=t,this.appletHeight=e,Et.gameFrame=this._canvas.getContext("2d",{alpha:!1,desynchronized:!0}),console.log("Starting engine..."),this._canvas.addEventListener("touchstart",this.mousePressed.bind(this)),this._canvas.addEventListener("touchmove",this.mouseMoved.bind(this)),this._canvas.addEventListener("touchend",this.mouseReleased.bind(this)),this._canvas.addEventListener("mouseout",this.mouseOut.bind(this)),this._canvas.addEventListener("mousedown",this.mousePressed.bind(this)),this._canvas.addEventListener("contextmenu",this.eventBlocker.bind(this)),this._canvas.addEventListener("mousemove",this.mouseMoved.bind(this)),this._canvas.addEventListener("mouseup",this.mouseReleased.bind(this)),this._canvas.addEventListener("wheel",this.mouseWheel.bind(this)),window.addEventListener("keydown",this.keyPressed.bind(this)),window.addEventListener("keyup",this.keyReleased.bind(this)),this.graphics=this.getGraphics(),this.engineState=Lt.INITIALIZE_DATA,this.drawLoadingScreen(0,"Loading..."),await this.loadFonts(),this.imageLogo=await this.fetchLogo(),await this.run()}eventBlocker(t){t.preventDefault()}setTargetFps(t){this.targetFrameTime=1e3/t}unsetFrameTimes(){for(let t=0;t<10;t++)this.timings[t]=0}setFrameTimes(){for(let t=0;t<10;t++)this.timings[t]=Date.now()}keyPressed(t){if("Control"!==t.key){if(this.gameState===bt.LOGIN&&null!==this.panelLogin&&null!==this.panelLogin[this.welcomeState])return this.panelLogin[this.welcomeState].keyPress(t.which,t.key),void t.preventDefault();if("Escape"===t.key)return this.abuseReportWindow=0,this.contactsInputFormIndex=0,void t.preventDefault();if(this.gameState===bt.WORLD){if(this.showAppearanceChange&&null!==this.panelGame[Tt.APPEARANCE])return this.panelGame[Tt.APPEARANCE].keyPress(t.which,t.key),void t.preventDefault();if(0===this.showDialogSocialInput&&0===this.showDialogReportAbuseStep&&!this.isSleeping&&this.panelGame[Tt.CHAT]){if("ArrowUp"===t.key)return t.preventDefault(),this.lastLogIdx>=this.lastLog.length-1?void this.showMessage("End of chat history buffer; press down to navigate forward.",3):(this.lastLogIdx+=1,void this.panelGame[Tt.CHAT].updateText(this.controlTextListAll,this.lastLog[this.lastLog.length-1-this.lastLogIdx]));if("ArrowDown"===t.key)return t.preventDefault(),void(this.lastLogIdx>0?(this.lastLogIdx-=1,this.panelGame[Tt.CHAT].updateText(this.controlTextListAll,this.lastLog[this.lastLog.length-1-this.lastLogIdx])):(this.lastLogIdx=-1,this.panelGame[Tt.CHAT].updateText(this.controlTextListAll,"")));this.panelGame[Tt.CHAT].keyPress(t.which,t.key),t.preventDefault()}}switch(t.which){case 37:this.keyLeft=!0,t.preventDefault();break;case 39:this.keyRight=!0,t.preventDefault();break;case 32:this.keySpace=!0,t.preventDefault();break;case 36:this.keyHome=!0,t.preventDefault();break;case 33:this.keyUp=!0,t.preventDefault();break;case 34:this.keyDown=!0,t.preventDefault();break;case 112:this.interlace=!this.interlace,t.preventDefault();break;case 113:this.options.showRoofs=!this.options.showRoofs,t.preventDefault();break;case 114:this.showFps=!this.showFps;break;case 115:this.dumpRequested=!0;break;case 13:this.inputTextCurrent.length>0&&(this.inputTextFinal=this.inputTextCurrent),this.inputPmCurrent.length>0&&(this.inputPmFinal=this.inputPmCurrent),t.preventDefault();break;case 8:this.inputTextCurrent.length>0&&(this.inputTextCurrent=this.inputTextCurrent.substring(0,this.inputTextCurrent.length-1)),this.inputPmCurrent.length>0&&(this.inputPmCurrent=this.inputPmCurrent.substring(0,this.inputPmCurrent.length-1)),t.preventDefault();break;default:this.inputTextCurrent.length<20&&(this.inputTextCurrent+=t.key),this.inputPmCurrent.length<80&&(this.inputPmCurrent+=t.key),t.preventDefault()}return!1}}keyReleased(t){switch(t.preventDefault(),t.which){case 37:this.keyLeft=!1;break;case 39:this.keyRight=!1;break;case 32:this.keySpace=!1;break;case 36:this.keyHome=!1;break;case 33:this.keyUp=!1;break;case 34:this.keyDown=!1}return!1}mouseMoved(t){t.preventDefault(),this.mouseX=t.offsetX,this.mouseY=t.offsetY,this.mouseActionTimeout=0}mouseReleased(t){t.preventDefault(),this.mouseX=t.offsetX,this.mouseY=t.offsetY,this.mouseButtonDown=0,1===t.button&&(this.middleButtonDown=!1)}mouseOut(t){t.preventDefault(),this.mouseX=t.offsetX,this.mouseY=t.offsetY,this.mouseButtonDown=0,this.middleButtonDown=!1}mousePressed(t){t.preventDefault();let e=t.offsetX,i=t.offsetY;if(this.mouseX=e,this.mouseY=i,this.options.middleClickCamera&&1===t.button)return this.middleButtonDown=!0,this.originRotation=this.cameraRotation,this.originMouseX=this.mouseX,!1;if(0===t.button)this.mouseButtonDown=1;else{if(2!==t.button)return!1;this.mouseButtonDown=2}return this.lastMouseButtonDown=this.mouseButtonDown,this.mouseActionTimeout=0,this.handleMouseDown(this.mouseButtonDown,e,i),!1}mouseWheel(t){if(t.preventDefault(),this.options.mouseWheel)return 0===t.deltaMode?this.mouseScrollDelta=Math.floor(t.deltaY/14):1===t.deltaMode&&(this.mouseScrollDelta=Math.floor(t.deltaY)),!1}start(){this.shutdownCounter>=0&&(this.shutdownCounter=0)}stop(){this.shutdownCounter>=0&&(this.shutdownCounter=4e3/this.targetFrameTime)}async handleInputs(){}async draw(){}async sleep(t){return new Promise(e=>setTimeout(e,t))}async run(){await this.startGame(),this.engineState=Lt.RUNNING;let t=0,e=256,i=1,s=0;for(let r=0;r<10;r++)this.timings[r]=Date.now();for(;this.shutdownCounter>=0;){if(this.shutdownCounter>0&&0==--this.shutdownCounter)return void this.clearResources();let r=e,n=i;e=300,i=1;let o=Date.now();if(0===this.timings[t]?(e=r,i=n):o>this.timings[t]&&(e=2560*this.targetFrameTime/(o-this.timings[t])|0),e<25&&(e=25),e>256&&(e=256,i=this.targetFrameTime-(o-this.timings[t])/10|0),i<this.threadSleep2&&(i=this.threadSleep2),await this.sleep(i),this.timings[t]=o,t=(t+1)%10,i>1)for(let t=0;t<10;t++)0!==this.timings[t]&&(this.timings[t]+=i);for(;s<256;)await this.handleInputs(),s+=e;if(this.interlaceTimer--,(this.dumpRequested||this.showFps&&this.targetFrameTime>0)&&(this.fps=1e3*e/(this.targetFrameTime<<8)|0),s&=255,this.draw(),this.mouseScrollDelta=0,this.dumpRequested){console.info("ntime:"+o);for(let e=0;e<10;e++){let i=(t-e-1+20)%10;console.info("otim"+i+":"+this.timings[i])}console.info("fps:"+this.fps+" ratio:"+e+" count:"+s),console.info("del:"+i+" targetFrameTime:"+this.targetFrameTime+" mindel:"+this.threadSleep),console.info("opos:"+t),this.dumpRequested=!1}}}update(t){this.paint(t)}paint(t){this.engineState.toNumber()<Lt.RUNNING.toNumber()&&null!==this.imageLogo&&this.drawLoadingScreen(this.loadingProgressPercent,this.loadingProgessText)}async fetchLogo(){let t=await this.readDataFile("jagex.jag","ZlackCode library",0);return null===t?null:this.createImage(It.loadData("logo.tga",0,t))}async loadFonts(){let t=await this.readDataFile(`fonts${F.FONTS}.jag`,"Game fonts",5);null!==t&&(gt.createFont(It.loadData("h11p.jf",0,t),0),gt.createFont(It.loadData("h12b.jf",0,t),1),gt.createFont(It.loadData("h12p.jf",0,t),2),gt.createFont(It.loadData("h13b.jf",0,t),3),gt.createFont(It.loadData("h14b.jf",0,t),4),gt.createFont(It.loadData("h16b.jf",0,t),5),gt.createFont(It.loadData("h20b.jf",0,t),6),gt.createFont(It.loadData("h24b.jf",0,t),7))}drawLoadingScreen(t,e){let i=(this.appletWidth-281)/2|0,s=(this.appletHeight-148)/2|0;this.graphics.setColor(r.black),this.graphics.fillRect(0,0,this.appletWidth,this.appletHeight),this.hasRefererLogoNotUsed?this.graphics.setColor(new r(220,0,0)):(null!==this.imageLogo&&this.graphics.drawImage(this.imageLogo,i,s),this.graphics.setColor(new r(132,132,132))),i+=2,s+=90,this.loadingProgessText=e,this.loadingProgressPercent=t,this.graphics.drawRect(i-2,s-2,280,23),this.graphics.fillRect(i,s,277*t/100|0,20),this.hasRefererLogoNotUsed?this.graphics.setColor(new r(255,255,255)):this.graphics.setColor(new r(198,198,198)),this.drawString(this.graphics,this.loadingProgessText,u.HELVETICA.withConfig(xt.NORMAL,12),i+138,s+12),this.hasRefererLogoNotUsed?(this.graphics.setColor(new r(132,132,152)),this.drawString(this.graphics,"\xa92019-2020 Zach Knight, and the 2003scape team",u.HELVETICA.withConfig(xt.BOLD,13),i+138,s-20)):(this.drawString(this.graphics,"Powered by RSCGo, a free and open source software project",u.HELVETICA.withConfig(xt.BOLD,13),i+138,s+35),this.drawString(this.graphics,"\xa92019-2020 Zach Knight, and the 2003scape team",u.HELVETICA.withConfig(xt.BOLD,13),i+138,s+49))}updateLoadingStatus(t,e){this.loadingProgressPercent=t,this.loadingProgessText=e;let i=(this.appletWidth-281)/2|0,s=(this.appletHeight-148)/2|0;i+=2,s+=90,this.graphics.setColor(new r(132,132,132)),this.hasRefererLogoNotUsed&&this.graphics.setColor(new r(220,0,0));let n=277*t/100|0;this.graphics.fillRect(i,s,n,20),this.graphics.setColor(r.black),this.graphics.fillRect(i+n,s,277-n,20),this.graphics.setColor(new r(198,198,198)),this.hasRefererLogoNotUsed&&this.graphics.setColor(new r(255,255,255)),this.drawString(this.graphics,e,u.TIMES.withConfig(xt.BOLD,15),i+138,s+12)}drawString(t,e,i,s,r){t.setFont(i);const{width:n,height:o}=t.ctx.measureText(e);t.drawString(e,s-(n/2|0),r+(o/4|0))}createImage(t){const e=new At(t.buffer).getCanvas();return e.getContext("2d").getImageData(0,0,e.width,e.height)}async readDataFile(t,e,i){t="./static/cache/"+t,this.updateLoadingStatus(i,"Loading "+e+" - 0%");let s=It.openFile(t),r=new Int8Array(6);await s.readFully(r,0,6);let n=((255&r[0])<<16)+((255&r[1])<<8)+(255&r[2]),o=((255&r[3])<<16)+((255&r[4])<<8)+(255&r[5]);this.updateLoadingStatus(i,"Loading "+e+" - 5%");let a=0,h=new Int8Array(o);for(;a<o;){let t=Math.min(o-a,8192);await s.readFully(h,a,t),a+=t,this.updateLoadingStatus(i,"Loading "+e+" - "+(5+95*a/o|0)+"%")}if(this.updateLoadingStatus(i,"Unpacking "+e),o!==n){let t=new Int8Array(n);return q.decompress(t,n,h,o,0),t}return h}getGraphics(){return this._graphics}async createSocket(t,e){let i=new Q(t,e);return await i.connect(),i}}Et.gameFrame=null,Ct=Et;var kt={APPEARANCE:59,BANK_CLOSE:203,BANK_OPEN:42,BANK_UPDATE:249,CLOSE_CONNECTION:4,DUEL_ACCEPTED:210,DUEL_CLOSE:225,DUEL_CONFIRM_OPEN:172,DUEL_OPEN:176,DUEL_OPPONENT_ACCEPTED:253,DUEL_SETTINGS:30,DUEL_UPDATE:6,FRIEND_LIST:71,FRIEND_MESSAGE:120,FRIEND_STATUS_CHANGE:149,GAME_SETTINGS:240,IGNORE_LIST:109,INVENTORY_ITEMS:53,INVENTORY_ITEM_REMOVE:123,INVENTORY_ITEM_UPDATE:90,LOGOUT_DENY:183,MESSAGE:131,OPTION_LIST:245,OPTION_LIST_CLOSE:252,PLAYER_DIED:83,PLAYER_QUEST_LIST:5,PLAYER_STAT_EQUIPMENT_BONUS:153,PLAYER_STAT_EXPERIENCE_UPDATE:33,PLAYER_STAT_FATIGUE:114,PLAYER_STAT_FATIGUE_ASLEEP:244,PLAYER_STAT_LIST:156,PLAYER_STAT_UPDATE:159,PRAYER_STATUS:206,PRIVACY_SETTINGS:51,REGION_ENTITY_UPDATE:211,REGION_GROUND_ITEMS:99,REGION_NPCS:79,REGION_NPC_UPDATE:104,REGION_OBJECTS:48,REGION_PLAYERS:191,REGION_PLAYER_UPDATE:234,REGION_WALL_OBJECTS:91,SERVER_MESSAGE:89,SERVER_MESSAGE_ONTOP:222,SHOP_CLOSE:137,SHOP_OPEN:101,SLEEP_CLOSE:84,SLEEP_INCORRECT:194,SLEEP_OPEN:117,SOUND:204,SYSTEM_UPDATE:52,TELEPORT_BUBBLE:36,TRADE_CLOSE:128,TRADE_CONFIRM_OPEN:20,TRADE_ITEMS:97,TRADE_OPEN:92,TRADE_RECIPIENT_STATUS:162,TRADE_STATUS:15,WELCOME:182,WORLD_INFO:25};const Pt="0".charCodeAt(0),Bt="9".charCodeAt(0),Mt="a".charCodeAt(0),Dt="*".charCodeAt(0),Yt="\\".charCodeAt(0),Xt="A".charCodeAt(0),Ot="Z".charCodeAt(0),Rt=",".charCodeAt(0),jt=".".charCodeAt(0),Nt="j".charCodeAt(0),_t="q".charCodeAt(0),Ut="'".charCodeAt(0),Ht="/".charCodeAt(0),Wt=" ".charCodeAt(0),Ft="v".charCodeAt(0),Gt="x".charCodeAt(0),Vt="z".charCodeAt(0),zt=t=>(new TextEncoder).encode(t),Zt=t=>(new TextDecoder).decode(t);function qt(t,e,i,s,r){if(!(s.length>t.length))for(let n=0;n<=t.length-s.length;n++){let o=n,a=0;for(;o<t.length;){let e=0,i=t[o],r=0;if(o+1<t.length&&(r=t[o+1]),a<s.length&&(e=te(s[a],i,r))>0)o+=e,a++;else{if(0===a)break;if((e=te(s[a-1],i,r))>0)o+=e;else{if(a>=s.length||!ne(i))break;o++}}}if(a>=s.length){let a=!1,h=Kt(t,e,n),l=Qt(t,i,o-1);if(DEBUGTLD&&console.log(`Potential tld: ${s} at char ${n} (type="${r}, startmatch="${h}, endmatch=${l})`),1===r&&h>0&&l>0&&(a=!0),2===r&&(h>2&&l>0||h>0&&l>2)&&(a=!0),3===r&&h>0&&l>2&&(a=!0),a){DEBUGTLD&&console.log(`Filtered tld: ${s} at char ${n}`);let r=n,a=o-1;if(h>2){if(4===h){let t=!1;for(let i=r-1;i>=0;i--)if(t){if(e[i]!==Dt)break;r=i}else e[i]===Dt&&(r=i,t=!0)}let i=!1;for(let e=r-1;e>=0;e--)if(i){if(ne(t[e]))break;r=e}else ne(t[e])||(i=!0,r=e)}if(l>2){if(4===l){let e=!1;for(let s=a+1;s<t.length;s++)if(e){if(i[s]!==Dt)break;a=s}else i[s]===Dt&&(a=s,e=!0)}let e=!1;for(let i=a+1;i<t.length;i++)if(e){if(ne(t[i]))break;a=i}else ne(t[i])||(e=!0,a=i)}for(let e=r;e<=a;e++)t[e]=Dt}}}}function Kt(t,e,i){if(0===i)return 2;for(let r=i-1;r>=0&&ne(t[r]);r--)if(t[r]===Rt||t[r]===jt)return 3;let s=0;for(let r=i-1;r>=0&&ne(e[r]);r--)e[r]===Dt&&s++;return s>=3?4:ne(t[i-1])?1:0}function Qt(t,e,i){if(i+1===t.length)return 2;for(let r=i+1;r<t.length&&ne(t[r]);r++)if(t[r]===Yt||t[r]===Ht)return 3;let s=0;for(let r=i+1;r<t.length&&ne(e[r]);r++)e[r]===Dt&&s++;return s>=5?4:ne(t[i+1])?1:0}function $t(t,e,i){if(!(e.length>t.length))for(let s=0;s<=t.length-e.length;s++){let r=s,n=0,o=!1;for(;r<t.length;){let i=0,s=t[r],a=0;if(r+1<t.length&&(a=t[r+1]),n<e.length&&(i=ee(e[n],s,a))>0)r+=i,n++;else{if(0===n)break;if((i=ee(e[n-1],s,a))>0)r+=i;else{if(n>=e.length||!oe(s))break;ne(s)&&s!==Ut&&(o=!0),r++}}}if(n>=e.length){let n=!0;if(DEBUGTLD&&console.log(`Potential word: ${e} at char ${s}`),o){let e=!1,i=!1;if((s-1<0||ne(t[s-1])&&t[s-1]!==Ut)&&(e=!0),(r>=t.length||ne(t[r])&&t[r]!==Ut)&&(i=!0),!e||!i){let i=!1,o=s-2;for(e&&(o=s);!i&&o<r;o++)if(o>=0&&(!ne(t[o])||t[o]===Ut)){let e,s=new Uint16Array(3);for(e=0;e<3&&!(o+e>=t.length||ne(t[o+e])&&t[o+e]!==Ut);e++)s[e]=t[o+e];let r=!0;0===e&&(r=!1),e<3&&o-1>=0&&(!ne(t[o-1])||t[o-1]===Ut)&&(r=!1),r&&!ce(s)&&(i=!0)}i||(n=!1)}}else{let e=Wt;s-1>=0&&(e=t[s-1]);let o=Wt;r<t.length&&(o=t[r]);let a=ie(e),h=ie(o);i&&Jt(i,a,h)&&(n=!1)}if(n){DEBUGWORD&&console.log(`Filtered word: ${e} at char ${s}`);for(let e=s;e<r;e++)t[e]=Dt}}}}function Jt(t,e,i){let s=0;if(t[s][0]===e&&t[s][1]===i)return!0;let r=t.length-1;if(t[r][0]===e&&t[r][1]===i)return!0;for(;s!==r&&s+1!==r;){let n=(s+r)/2|0;if(t[n][0]===e&&t[n][1]===i)return!0;e<t[n][0]||e===t[n][0]&&i<t[n][1]?r=n:s=n}return!1}function te(t,e,i){return t=String.fromCharCode(t),e=String.fromCharCode(e),i=String.fromCharCode(i),t===e?1:"e"===t&&"3"===e?1:("t"!==t||"7"!==e&&"+"!==e)&&("a"!==t||"4"!==e&&"@"!==e)?"o"===t&&"0"===e?1:"i"===t&&"1"===e?1:"s"===t&&"5"===e?1:"f"===t&&"p"===e&&"h"===i?2:"g"===t&&"9"===e?1:0:1}function ee(t,e,i){if(t=String.fromCharCode(t),e=String.fromCharCode(e),i=String.fromCharCode(i),"*"===t)return 0;if(t===e)return 1;if(t>="a"&&t<="z"){if("e"===t)return"3"===e?1:0;if("t"===t)return"7"===e?1:0;if("a"===t)return"4"===e||"@"===e?1:0;if("o"===t)return"0"===e||"*"===e?1:"("===e&&")"===i?2:0;if("i"===t)return"y"===e||"l"===e||"j"===e||"l"===e||"!"===e||":"===e||";"===e?1:0;if("n"===t)return 0;if("s"===t)return"5"===e||"z"===e||"$"===e?1:0;if("r"===t)return 0;if("h"===t)return 0;if("l"===t)return"1"===e?1:0;if("d"===t)return 0;if("c"===t)return"("===e?1:0;if("u"===t)return"v"===e?1:0;if("m"===t)return 0;if("f"===t)return"p"===e&&"h"===i?2:0;if("p"===t)return 0;if("g"===t)return"9"===e||"6"===e?1:0;if("w"===t)return"v"===e&&"v"===i?2:0;if("y"===t)return 0;if("b"===t)return"1"===e&&"3"===i?2:0;if("v"===t)return 0;if("k"===t)return 0;if("x"===t)return")"===e&&"("===i?2:0;if("j"===t)return 0;if("q"===t)return 0;if("z"===t)return 0}if(t>="0"&&t<="9"){if("0"===t)return"o"===e||"O"===e?1:"("===e&&")"===i?2:0;if("1"===t)return"l"!==e?0:1;if("2"===t)return 0;if("3"===t)return 0;if("4"===t)return 0;if("5"===t)return 0;if("6"===t)return 0;if("7"===t)return 0;if("8"===t)return 0;if("9"===t)return 0}return"-"===t?0:","===t?"."===e?1:0:"."===t?","===e?1:0:"("===t?0:")"===t?0:"!"===t?"i"===e?1:0:"'"===t?0:(DEBUGWORD&&console.log(`Letter=${t} not matched`),0)}function ie(t){return t>=Mt&&t<=Vt?t-97+1:t===Ut?28:t>=Pt&&t<=Bt?t-48+29:27}function se(t,e){for(let i=e;i<t.length&&i>=0;i++)if(t[i]>=Pt&&t[i]<=Bt)return i;return-1}function re(t,e){for(let i=e;i<t.length&&i>=0;i++)if(t[i]<Pt||t[i]>Bt)return i;return t.length}function ne(t){return!ae(t)&&!he(t)}function oe(t){return t<Mt||t>Vt||t===Ft||t===Gt||t===Nt||t===_t||t===Vt}function ae(t){return t>=Mt&&t<=Vt||t>=Xt&&t<=Ot}function he(t){return t>=Pt&&t<=Bt}function le(t){return t>=Xt&&t<=Ot}function ce(t){let e=!0;for(let n=0;n<t.length;n++)he(t[n])||0===t[n]||(e=!1);if(e)return!0;let i=function(t){if(t.length>6)return 0;let e=0;for(let i=0;i<t.length;i++){let s=t[t.length-i-1];if(s>=Mt&&s<=Vt)e=38*e+s-97+1|0;else if(s===Ut)e=38*e+27|0;else if(s>=Pt&&s<=Bt)e=38*e+s-48+28|0;else if(0!==s)return DEBUGWORD&&console.log(`wordToHash failed on ${Zt(t)}`),0}return e}(t),s=0,r=de.length-1;if(i===de[s]||i===de[r])return!0;for(;s!==r&&s+1!=r;){let t=(s+r)/2|0;if(i===de[t])return!0;i<de[t]?r=t:s=t}return!1}DEBUGTLD=!0,DEBUGWORD=!0,forceLowerCase=!0,ignoreList=["cook","cook's","cooks","seeks","sheet"],tldList=[];let ue=[],me=[],de=new Uint16Array;var pe={filter:function(t){let e=zt(t.toLowerCase());!function(t){let e=t.slice();$t(e,zt("dot"),null);let i=t.slice();$t(i,zt("slash"),null);for(let s of tldList)qt(t,e,i,s.value,s.score)}(e),function(t){for(let e=0;e<2;e++)for(let i=badList.length-1;i>=0;i--)$t(t,badList[i],badCharIds[i])}(e),function(t){for(let e=ue.length-1;e>=0;e--)$t(t,ue[e],me[e])}(e),function(t){let e=0,i=0,s=0,r=0;for(;-1!=(e=se(t,i));){let n=!1;for(let s=i;s>=0&&s<e&&!n;s++)ne(t[s])||oe(t[s])||(n=!0);n&&(s=0),0===s&&(r=e),i=re(t,e);let o=0;for(let s=e;s<i;s++)o=10*o+t[s]-48;if(o>255||i-e>8?s=0:s++,4===s){for(let e=r;e<i;e++)t[e]=Dt;s=0}}}(e);for(let i=0;i<ignoreList.length;i++)for(let s=-1;-1!==(s=t.indexOf(ignoreList[i],s+1));){let t=zt(ignoreList[i]);for(let i=0;i<t.length;i++)e[i+s]=t[i]}return forceLowerCase&&(function(t,e){for(let i=0;i<t.length;i++)e[i]!==Dt&&le(t[i])&&(e[i]=t[i])}(zt(t),e),function(t){let e=!0;for(let s=0;s<t.length;s++){let r=t[s];ae(r)?e?(i=r)>=Mt&&i<=Vt&&(e=!1):le(r)&&(t[s]=r+97-65):e=!0}var i}(e)),Zt(e)},readFilteredTLDs:t=>{for(let e=0;e<t.getUnsignedInt();e++){const e=t.getUnsignedByte();let i=t.getString(t.getUnsignedByte());if(i.length>0){let t={score:e,value:i};tldList.push(t)}}},readFilteredHosts:t=>{let e=t.getUnsignedInt();ue.length=e,ue.fill(null),me.length=e,me.fill(null),function(t,e,i){for(let s=0;s<e.length;s++){let r=new Uint16Array(t.getUnsignedByte());for(let e=0;e<r.length;e++)r[e]=t.getUnsignedByte();e[s]=r;let n=[];n.length=t.getUnsignedInt();for(let e=0;e<n.length;e++)n[e]=[255&t.getUnsignedByte(),255&t.getUnsignedByte()];n.length>0&&(i[s]=n)}}(t,ue,me)},readFilteredWords:t=>{badList=[],badCharIds=[]},readFilteredHashFragments:t=>{for(let e=0;e<t.getUnsignedInt();e++)de[e]=t.getUnsignedShort()}},ge={};const{decodeString:fe}=f,{FontStyle:Se}=a,{Utility:we}=ct,{WordFilter:Ce,filter:Ie}=pe;class ye extends Ct{constructor(t){super(t),this.clientStream=null,this.friendListCount=0,this.ignoreListCount=0,this.settingsBlockChat=0,this.settingsBlockPrivate=0,this.settingsBlockTrade=0,this.settingsBlockDuel=0,this.worldFullTimeout=0,this.moderatorLevel=0,this.packetLastRead=0,this.nextPrivateMessage=0,this.server="127.0.0.1",this.port=43595,this.username="",this.password="",this.incomingPacket=new Int8Array(5e3),this.friendListHashes=[];for(let e=0;e<200;e+=1)this.friendListHashes.push(new w(0));this.friendListOnline=new Int32Array(200),this.ignoreList=[];for(let e=0;e<ye.maxSocialListSize;e+=1)this.ignoreList.push(new w(0));this.privateMessageIds=new Int32Array(ye.maxSocialListSize)}async registerAccount(t,i){try{t=we.formatAndTruncate(t,12),i=we.formatAndTruncate(i,20),null!==this.clientStream&&this.clientStream.closeStream(),this.showLoginScreenStatus("Please wait...","creating new account..."),this.clientStream=new G(await this.createSocket(this.server,this.port,this.transportLayerSecurity),this),this.clientStream.readTicksMax=1e3,this.clientStream.newPacket(s.REGISTER),this.clientStream.putShort(F.CLIENT),this.clientStream.putLong(we.encodeBase37(t)),this.clientStream.putString(i),this.clientStream.flushPacket();let r=await this.clientStream.readStream();switch(console.log("newplayer response: "+r),this.clientStream.closeStream(),r){case 2:return this.resetLoginVars(),void await this.login(t,i,!1);case 13:case 3:return void this.showLoginScreenStatus("Username already taken.","Please choose another username");case 4:return void this.showLoginScreenStatus("That username is already in use.","Wait 60 seconds then retry");case 5:return void this.showLoginScreenStatus("The client has been updated.","Please reload this page");case 6:return void this.showLoginScreenStatus("You may only use 1 character at once.","Your ip-address is already in use");case 7:return void this.showLoginScreenStatus("Login attempts exceeded!","Please try again in 5 minutes");case 11:return void this.showLoginScreenStatus("Account has been temporarily disabled","for cheating or abuse");case 12:return void this.showLoginScreenStatus("Account has been permanently disabled","for cheating or abuse");case 14:return this.showLoginScreenStatus("Sorry! The server is currently full.","Please try again later"),void(this.worldFullTimeout=1500);case 15:return void this.showLoginScreenStatus("You need a members account","to login to this server");case 16:return void this.showLoginScreenStatus("Please login to a members server","to access member-only features");case 19:return void this.showLoginScreenStatus("Bad username/password","Please check your input and try again")}this.showLoginScreenStatus("Error unable to create user.","Unrecognised response code")}catch(e){console.error(e),this.showLoginScreenStatus("Error unable to create user.","Unrecognised response code")}}changePassword(t,e){t=we.formatAndTruncate(t,20),e=we.formatAndTruncate(e,20),this.clientStream.newPacket(s.CHANGE_PASSWORD),this.clientStream.putString(t),this.clientStream.putString(e),this.clientStream.sendPacket()}async login(t,i,r,n){if(this.worldFullTimeout>0)return this.showLoginScreenStatus("Please wait...","Connecting to server"),await wt(2e3),void this.showLoginScreenStatus("Sorry! The server is currently full.","Please try again later");try{if(this.username=t,t=we.formatAndTruncate(t,12),this.password=i,i=we.formatAndTruncate(i,20),0===t.trim().length)return void this.showLoginScreenStatus("You must enter both a username","and a password - Please try again");r?this.drawTextBox("Connection lost! Please wait...","Attempting to re-establish"):this.showLoginScreenStatus("Please wait...","Connecting to server"),null!==this.clientStream&&this.clientStream.closeStream(),this.clientStream=new G(await this.createSocket(this.server,this.port,this.transportLayerSecurity),this),this.clientStream.readTicksMax=1e3,this.clientStream.newPacket(s.LOGIN),this.clientStream.putBool(r),this.clientStream.putShort(F.CLIENT),this.clientStream.putLong(we.encodeBase37(t)),this.clientStream.putString(i),this.clientStream.flushPacket();let n=await this.clientStream.readStream();switch(console.log("login response:"+n),-65&n){case 25:case 24:return this.autoLoginTimeout=0,this.moderatorLevel=1,void this.resetGame();case 0:return this.autoLoginTimeout=0,this.moderatorLevel=0,void this.resetGame();case 1:return void(this.autoLoginTimeout=0);case-1:this.showLoginScreenStatus("Error unable to login.","Server timed out");break;case 3:this.showLoginScreenStatus("Invalid username or password.","Try again, or create a new account");break;case 4:this.showLoginScreenStatus("That username is already logged in.","Wait 60 seconds then retry");break;case 5:this.showLoginScreenStatus("The client has been updated.","Please reload this page");break;case 6:this.showLoginScreenStatus("You may only use 1 character at once.","Your ip-address is already in use");break;case 7:this.showLoginScreenStatus("Login attempts exceeded!","Please try again in 5 minutes");break;case 8:this.showLoginScreenStatus("Error unable to login.","Server rejected session");break;case 9:this.showLoginScreenStatus("Error unable to login.","Loginserver rejected session");break;case 10:this.showLoginScreenStatus("That username is already in use.","Wait 60 seconds then retry");break;case 11:this.showLoginScreenStatus("Account temporarily disabled.","Check your message inbox for details");break;case 12:this.showLoginScreenStatus("Account permanently disabled.","Check your message inbox for details");break;case 14:this.showLoginScreenStatus("Sorry! This world is currently full.","Please try a different world"),this.worldFullTimeout=1500;break;case 15:this.showLoginScreenStatus("You need a members account","to login to this world");break;case 16:this.showLoginScreenStatus("Error - no reply from loginserver.","Please try again");break;case 17:this.showLoginScreenStatus("Error - failed to decode profile.","Contact customer support");break;case 18:this.showLoginScreenStatus("Account suspected stolen.","Press 'recover a locked account' on front page.");break;case 20:this.showLoginScreenStatus("Error - loginserver mismatch","Please try a different world");break;case 21:this.showLoginScreenStatus("Unable to login.","That is not an RS-Classic account");break;case 22:this.showLoginScreenStatus("Password suspected stolen.","Press 'change your password' on front page.");break;default:this.showLoginScreenStatus("Error unable to login.","Unrecognised response code")}return void(!1&n&&this.clientStream.closeStream())}catch(e){console.error(e)}this.autoLoginTimeout>0&&(await wt(5e3),this.autoLoginTimeout--,await this.login(this.username,this.password,r)),r?this.resetLoginVars():this.showLoginScreenStatus("Sorry! Unable to connect.","Check internet settings or try another world")}closeConnection(){if(null!==this.clientStream){try{this.clientStream.newPacket(s.CLOSE_CONNECTION),this.clientStream.flushPacket()}catch(e){console.error(e)}this.clientStream.closeStream()}this.resetLoginVars()}async lostConnection(){try{throw new Error("Lost connection - forcing reconnect")}catch(e){console.log("Lost connection"),console.error(e)}this.autoLoginTimeout=10,await this.login(this.username,this.password,!0)}drawTextBox(t,e){let i=this.getGraphics(),s=u.HELVETICA.withConfig(Se.BOLD,15),n=(this.width,this.height);i.setColor(r.black),i.fillRect((this.width>>1|0)-140,(this.height>>1|0)-25,280,50),i.setColor(r.white),i.drawRect((this.width>>1|0)-140,(this.height>>1|0)-25,280,50),this.drawString(i,t,s,this.width>>1|0,(n/2|0)-10),this.drawString(i,e,s,this.width>>1|0,10+(n/2|0))}async checkConnection(){let t=Date.now();this.clientStream.hasPacket()&&(this.packetLastRead=t),t-this.packetLastRead>5e3&&(this.packetLastRead=t,this.clientStream.newPacket(s.PING),this.clientStream.sendPacket());try{this.clientStream.writePacket(20)}catch(e){return void await this.lostConnection()}let i=await this.clientStream.readPacket(this.incomingPacket);if(i>0){let t=255&this.incomingPacket[0];this.handlePacket(t,i)}}handlePacket(t,e){if(t!==kt.MESSAGE){var i;if(t!==kt.CLOSE_CONNECTION)if(t!==kt.LOGOUT_DENY)if(t!==kt.FRIEND_LIST){if(t===kt.FRIEND_STATUS_CHANGE){let t=we.getUnsignedLong(this.incomingPacket,1),e=255&this.incomingPacket[9];for(let i=0;i<this.friendListCount;i++)if(this.friendListHashes[i].equals(t))return 0===this.friendListOnline[i]&&0!==e&&this.showServerMessage("@pri@"+we.hashToUsername(t)+" has logged in"),0!==this.friendListOnline[i]&&0===e&&this.showServerMessage("@pri@"+we.hashToUsername(t)+" has logged out"),this.friendListOnline[i]=e,void this.sortFriendsList();return this.friendListHashes[this.friendListCount]=t,this.friendListOnline[this.friendListCount]=e,this.friendListCount++,void this.sortFriendsList()}if(t!==kt.IGNORE_LIST){if(t===kt.PRIVACY_SETTINGS)return this.settingsBlockChat=this.incomingPacket[1],this.settingsBlockPrivate=this.incomingPacket[2],this.settingsBlockTrade=this.incomingPacket[3],void(this.settingsBlockDuel=this.incomingPacket[4]);if(t!==kt.FRIEND_MESSAGE)this.handleIncomingPacket(t,e,this.incomingPacket);else{let t=we.getUnsignedLong(this.incomingPacket,1),i=we.getUnsignedInt(this.incomingPacket,9);for(let e=0;e<ye.maxSocialListSize;e++)if(this.privateMessageIds[e]===i)return;this.privateMessageIds[this.nextPrivateMessage]=i,this.nextPrivateMessage=(this.nextPrivateMessage+1)%ye.maxSocialListSize;let s=Ie(fe(this.incomingPacket.slice(13,e)));this.showServerMessage("@pri@"+we.hashToUsername(t)+": tells you "+s)}}else{this.ignoreListCount=we.getUnsignedByte(this.incomingPacket[1]);for(let t=0;t<this.ignoreListCount;t++)this.ignoreList[t]=we.getUnsignedLong(this.incomingPacket,2+8*t)}}else{this.friendListCount=we.getUnsignedByte(this.incomingPacket[1]);for(let t=0;t<this.friendListCount;t++)this.friendListHashes[t]=we.getUnsignedLong(this.incomingPacket,2+9*t),this.friendListOnline[t]=we.getUnsignedByte(this.incomingPacket[10+9*t]);this.sortFriendsList()}else this.cantLogout();else this.closeConnection()}else{let t=(i=this.incomingPacket.slice(1,e),Array.from(i).map(t=>String.fromCharCode(t)).join(""));this.showServerMessage(t)}}sortFriendsList(){let t=!0;for(;t;){t=!1;for(let e=0;e<this.friendListCount-1;e++)if(255!==this.friendListOnline[e]&&255===this.friendListOnline[e+1]||0===this.friendListOnline[e]&&0!==this.friendListOnline[e+1]){let i=this.friendListOnline[e];this.friendListOnline[e]=this.friendListOnline[e+1],this.friendListOnline[e+1]=i;let s=this.friendListHashes[e];this.friendListHashes[e]=this.friendListHashes[e+1],this.friendListHashes[e+1]=s,t=!0}}}sendPrivacySettings(t,e,i,r){this.clientStream.newPacket(s.SETTINGS_PRIVACY),this.clientStream.putByte(t),this.clientStream.putByte(e),this.clientStream.putByte(i),this.clientStream.putByte(r),this.clientStream.sendPacket()}ignoreAdd(t){let e=we.encodeBase37(t);for(let i=0;i<this.ignoreListCount;i++)if(this.ignoreList[i].equals(e))return;this.clientStream.newPacket(s.IGNORE_ADD),this.clientStream.putLong(e),this.clientStream.sendPacket(),this.ignoreListCount<ye.maxSocialListSize&&(this.ignoreList[this.ignoreListCount++]=e)}ignoreRemove(t){this.clientStream.newPacket(s.IGNORE_REMOVE),this.clientStream.putLong(t),this.clientStream.sendPacket();for(let e=0;e<this.ignoreListCount;e++)if(this.ignoreList[e].equals(t)){this.ignoreListCount--;for(let t=e;t<this.ignoreListCount;t++)this.ignoreList[t]=this.ignoreList[t+1];return}}friendAdd(t){this.clientStream.newPacket(s.FRIEND_ADD),this.clientStream.putLong(we.encodeBase37(t)),this.clientStream.sendPacket();let e=we.encodeBase37(t);for(let i=0;i<this.friendListCount;i++)if(this.friendListHashes[i].equals(e))return;return this.friendListCount>=ye.maxSocialListSize?void 0:(this.friendListHashes[this.friendListCount]=e,this.friendListOnline[this.friendListCount]=0,void this.friendListCount++)}friendRemove(t){this.clientStream.newPacket(s.FRIEND_REMOVE),this.clientStream.putLong(t),this.clientStream.sendPacket();for(let e=0;e<this.friendListCount;e++)if(this.friendListHashes[e].equals(t)){this.friendListCount--;for(let t=e;t<this.friendListCount;t++)this.friendListHashes[t]=this.friendListHashes[t+1],this.friendListOnline[t]=this.friendListOnline[t+1];break}this.showServerMessage("@pri@"+we.hashToUsername(t)+" has been removed from your friends list")}sendPrivateMessage(t,e,i){this.clientStream.newPacket(s.PM),this.clientStream.putLong(t),this.clientStream.putBytes(e,0,i),this.clientStream.sendPacket()}sendChatMessage(t,e){this.clientStream.newPacket(s.CHAT),this.clientStream.putBytes(t,0,e),this.clientStream.sendPacket()}sendCommandString(t){this.clientStream.newPacket(s.COMMAND),this.clientStream.putString(t),this.clientStream.sendPacket()}method43(){return!0}}ye.maxReadTries=0,ye.maxSocialListSize=100,ge=ye;var be={};be.GameException=class extends Error{constructor(t,e=!1){super(t),console.error(t)}};var Te=function(t){for(var e=new Array(t),i=0;i<t;++i)e[i]=i;return e};function Ae(t){return!!t.constructor&&"function"==typeof t.constructor.isBuffer&&t.constructor.isBuffer(t)}var xe="undefined"!=typeof Float64Array;function ve(t,e){return t[0]-e[0]}function Le(){var t,e=this.stride,i=new Array(e.length);for(t=0;t<i.length;++t)i[t]=[Math.abs(e[t]),t];i.sort(ve);var s=new Array(i.length);for(t=0;t<s.length;++t)s[t]=i[t][1];return s}function Ee(t,e){var i=["View",e,"d",t].join("");e<0&&(i="View_Nil"+t);var s="generic"===t;if(-1===e){var r="function "+i+"(a){this.data=a;};var proto="+i+".prototype;proto.dtype='"+t+"';proto.index=function(){return -1};proto.size=0;proto.dimension=-1;proto.shape=proto.stride=proto.order=[];proto.lo=proto.hi=proto.transpose=proto.step=function(){return new "+i+"(this.data);};proto.get=proto.set=function(){};proto.pick=function(){return null};return function construct_"+i+"(a){return new "+i+"(a);}";return new Function(r)()}if(0===e)return r="function "+i+"(a,d) {this.data = a;this.offset = d};var proto="+i+".prototype;proto.dtype='"+t+"';proto.index=function(){return this.offset};proto.dimension=0;proto.size=1;proto.shape=proto.stride=proto.order=[];proto.lo=proto.hi=proto.transpose=proto.step=function "+i+"_copy() {return new "+i+"(this.data,this.offset)};proto.pick=function "+i+"_pick(){return TrivialArray(this.data);};proto.valueOf=proto.get=function "+i+"_get(){return "+(s?"this.data.get(this.offset)":"this.data[this.offset]")+"};proto.set=function "+i+"_set(v){return "+(s?"this.data.set(this.offset,v)":"this.data[this.offset]=v")+"};return function construct_"+i+"(a,b,c,d){return new "+i+"(a,d)}",new Function("TrivialArray",r)(ke[t][0]);r=["'use strict'"];var n=Te(e),o=n.map(function(t){return"i"+t}),a="this.offset+"+n.map(function(t){return"this.stride["+t+"]*i"+t}).join("+"),h=n.map(function(t){return"b"+t}).join(","),l=n.map(function(t){return"c"+t}).join(",");r.push("function "+i+"(a,"+h+","+l+",d){this.data=a","this.shape=["+h+"]","this.stride=["+l+"]","this.offset=d|0}","var proto="+i+".prototype","proto.dtype='"+t+"'","proto.dimension="+e),r.push("Object.defineProperty(proto,'size',{get:function "+i+"_size(){return "+n.map(function(t){return"this.shape["+t+"]"}).join("*"),"}})"),1===e?r.push("proto.order=[0]"):(r.push("Object.defineProperty(proto,'order',{get:"),e<4?(r.push("function "+i+"_order(){"),2===e?r.push("return (Math.abs(this.stride[0])>Math.abs(this.stride[1]))?[1,0]:[0,1]}})"):3===e&&r.push("var s0=Math.abs(this.stride[0]),s1=Math.abs(this.stride[1]),s2=Math.abs(this.stride[2]);if(s0>s1){if(s1>s2){return [2,1,0];}else if(s0>s2){return [1,2,0];}else{return [1,0,2];}}else if(s0>s2){return [2,0,1];}else if(s2>s1){return [0,1,2];}else{return [0,2,1];}}})")):r.push("ORDER})")),r.push("proto.set=function "+i+"_set("+o.join(",")+",v){"),s?r.push("return this.data.set("+a+",v)}"):r.push("return this.data["+a+"]=v}"),r.push("proto.get=function "+i+"_get("+o.join(",")+"){"),s?r.push("return this.data.get("+a+")}"):r.push("return this.data["+a+"]}"),r.push("proto.index=function "+i+"_index(",o.join(),"){return "+a+"}"),r.push("proto.hi=function "+i+"_hi("+o.join(",")+"){return new "+i+"(this.data,"+n.map(function(t){return["(typeof i",t,"!=='number'||i",t,"<0)?this.shape[",t,"]:i",t,"|0"].join("")}).join(",")+","+n.map(function(t){return"this.stride["+t+"]"}).join(",")+",this.offset)}");var c=n.map(function(t){return"a"+t+"=this.shape["+t+"]"}),u=n.map(function(t){return"c"+t+"=this.stride["+t+"]"});r.push("proto.lo=function "+i+"_lo("+o.join(",")+"){var b=this.offset,d=0,"+c.join(",")+","+u.join(","));for(var m=0;m<e;++m)r.push("if(typeof i"+m+"==='number'&&i"+m+">=0){d=i"+m+"|0;b+=c"+m+"*d;a"+m+"-=d}");for(r.push("return new "+i+"(this.data,"+n.map(function(t){return"a"+t}).join(",")+","+n.map(function(t){return"c"+t}).join(",")+",b)}"),r.push("proto.step=function "+i+"_step("+o.join(",")+"){var "+n.map(function(t){return"a"+t+"=this.shape["+t+"]"}).join(",")+","+n.map(function(t){return"b"+t+"=this.stride["+t+"]"}).join(",")+",c=this.offset,d=0,ceil=Math.ceil"),m=0;m<e;++m)r.push("if(typeof i"+m+"==='number'){d=i"+m+"|0;if(d<0){c+=b"+m+"*(a"+m+"-1);a"+m+"=ceil(-a"+m+"/d)}else{a"+m+"=ceil(a"+m+"/d)}b"+m+"*=d}");r.push("return new "+i+"(this.data,"+n.map(function(t){return"a"+t}).join(",")+","+n.map(function(t){return"b"+t}).join(",")+",c)}");var d=new Array(e),p=new Array(e);for(m=0;m<e;++m)d[m]="a[i"+m+"]",p[m]="b[i"+m+"]";for(r.push("proto.transpose=function "+i+"_transpose("+o+"){"+o.map(function(t,e){return t+"=("+t+"===undefined?"+e+":"+t+"|0)"}).join(";"),"var a=this.shape,b=this.stride;return new "+i+"(this.data,"+d.join(",")+","+p.join(",")+",this.offset)}"),r.push("proto.pick=function "+i+"_pick("+o+"){var a=[],b=[],c=this.offset"),m=0;m<e;++m)r.push("if(typeof i"+m+"==='number'&&i"+m+">=0){c=(c+this.stride["+m+"]*i"+m+")|0}else{a.push(this.shape["+m+"]);b.push(this.stride["+m+"])}");return r.push("var ctor=CTOR_LIST[a.length+1];return ctor(this.data,a,b,c)}"),r.push("return function construct_"+i+"(data,shape,stride,offset){return new "+i+"(data,"+n.map(function(t){return"shape["+t+"]"}).join(",")+","+n.map(function(t){return"stride["+t+"]"}).join(",")+",offset)}"),new Function("CTOR_LIST","ORDER",r.join("\n"))(ke[t],Le)}var ke={float32:[],float64:[],int8:[],int16:[],int32:[],uint8:[],uint16:[],uint32:[],array:[],uint8_clamped:[],bigint64:[],biguint64:[],buffer:[],generic:[]},Pe=function(t,e,i,s){if(void 0===t)return(0,ke.array[0])([]);"number"==typeof t&&(t=[t]),void 0===e&&(e=[t.length]);var r=e.length;if(void 0===i){i=new Array(r);for(var n=r-1,o=1;n>=0;--n)i[n]=o,o*=e[n]}if(void 0===s)for(s=0,n=0;n<r;++n)i[n]<0&&(s-=(e[n]-1)*i[n]);for(var a=function(t){if(null!=(e=t)&&(Ae(e)||function(t){return"function"==typeof t.readFloatLE&&"function"==typeof t.slice&&Ae(t.slice(0,0))}(e)||e._isBuffer))return"buffer";var e;if(xe)switch(Object.prototype.toString.call(t)){case"[object Float64Array]":return"float64";case"[object Float32Array]":return"float32";case"[object Int8Array]":return"int8";case"[object Int16Array]":return"int16";case"[object Int32Array]":return"int32";case"[object Uint8Array]":return"uint8";case"[object Uint16Array]":return"uint16";case"[object Uint32Array]":return"uint32";case"[object Uint8ClampedArray]":return"uint8_clamped";case"[object BigInt64Array]":return"bigint64";case"[object BigUint64Array]":return"biguint64"}return Array.isArray(t)?"array":"generic"}(t),h=ke[a];h.length<=r+1;)h.push(Ee(a,h.length-1));return(0,h[r+1])(t,e,i,s)},Be={};const{Utility:Me}=ct;class De{static getModelIndex(t){if("na"===(t=t.toLowerCase()))return 0;for(let e=0;e<De.modelCount;e++)if(De.modelName[e].toLowerCase()===t)return e;return De.modelName[De.modelCount++]=t,De.modelCount-1}static getUnsignedByte(){return 255&De.dataInteger[De.offset++]}static getUnsignedShort(){let t=Me.getUnsignedShort(De.dataInteger,De.offset);return De.offset+=2,t}static getUnsignedInt(){let t=Me.getUnsignedInt(De.dataInteger,De.offset);return De.offset+=4,t>99999999&&(t=99999999-t),t}static getString(){let t="";for(;0!==De.dataString[De.stringOffset];)t+=String.fromCharCode(De.dataString[De.stringOffset++]);return De.stringOffset++,t}static loadDefinitions(t,e){De.dataString=Me.loadData("string.dat",0,t),De.stringOffset=0,De.dataInteger=Me.loadData("integer.dat",0,t),De.offset=0;let i=0;for(De.itemCount=De.getUnsignedShort(),De.itemName=[],De.itemDescription=[],De.itemCommand=[],De.itemPicture=new Int32Array(De.itemCount),De.itemBasePrice=new Int32Array(De.itemCount),De.itemStackable=new Int32Array(De.itemCount),De.itemUnused=new Int32Array(De.itemCount),De.itemWearable=new Int32Array(De.itemCount),De.itemMask=new Int32Array(De.itemCount),De.itemSpecial=new Int32Array(De.itemCount),De.itemMembers=new Int32Array(De.itemCount),i=0;i<De.itemCount;i++)De.itemName.push(De.getString());for(i=0;i<De.itemCount;i++)De.itemDescription.push(De.getString());for(i=0;i<De.itemCount;i++)De.itemCommand.push(De.getString());for(i=0;i<De.itemCount;i++)De.itemPicture[i]=De.getUnsignedShort(),De.itemPicture[i]+1>De.itemSpriteCount&&(De.itemSpriteCount=De.itemPicture[i]+1);for(i=0;i<De.itemCount;i++)De.itemBasePrice[i]=De.getUnsignedInt();for(i=0;i<De.itemCount;i++)De.itemStackable[i]=De.getUnsignedByte();for(i=0;i<De.itemCount;i++)De.itemUnused[i]=De.getUnsignedByte();for(i=0;i<De.itemCount;i++)De.itemWearable[i]=De.getUnsignedShort();for(i=0;i<De.itemCount;i++)De.itemMask[i]=De.getUnsignedInt();for(i=0;i<De.itemCount;i++)De.itemSpecial[i]=De.getUnsignedByte();for(i=0;i<De.itemCount;i++)De.itemMembers[i]=De.getUnsignedByte();for(i=0;i<De.itemCount;i++)e||1!==De.itemMembers[i]||(De.itemName[i]="Members object",De.itemDescription[i]="You need to be a member to use this object",De.itemBasePrice[i]=0,De.itemCommand[i]="",De.itemUnused[0]=0,De.itemWearable[i]=0,De.itemSpecial[i]=1);for(De.npcCount=De.getUnsignedShort(),De.npcName=[],De.npcDescription=[],De.npcCommand=[],De.npcAttack=new Int32Array(De.npcCount),De.npcStrength=new Int32Array(De.npcCount),De.npcHits=new Int32Array(De.npcCount),De.npcDefense=new Int32Array(De.npcCount),De.npcAttackable=new Int32Array(De.npcCount),De.npcSprite=Pe(new Int32Array(12*De.npcCount),[De.npcCount,12]),De.npcColourHair=new Int32Array(De.npcCount),De.npcColourTop=new Int32Array(De.npcCount),De.npcColorBottom=new Int32Array(De.npcCount),De.npcColourSkin=new Int32Array(De.npcCount),De.npcWidth=new Int32Array(De.npcCount),De.npcHeight=new Int32Array(De.npcCount),De.npcWalkModel=new Int32Array(De.npcCount),De.npcCombatModel=new Int32Array(De.npcCount),De.npcCombatAnimation=new Int32Array(De.npcCount),i=0;i<De.npcCount;i++)De.npcName.push(De.getString());for(i=0;i<De.npcCount;i++)De.npcDescription.push(De.getString());for(i=0;i<De.npcCount;i++)De.npcAttack[i]=De.getUnsignedByte();for(i=0;i<De.npcCount;i++)De.npcStrength[i]=De.getUnsignedByte();for(i=0;i<De.npcCount;i++)De.npcHits[i]=De.getUnsignedByte();for(i=0;i<De.npcCount;i++)De.npcDefense[i]=De.getUnsignedByte();for(i=0;i<De.npcCount;i++)De.npcAttackable[i]=De.getUnsignedByte();for(i=0;i<De.npcCount;i++)for(let t=0;t<12;t++){let e=De.getUnsignedByte();De.npcSprite.set(i,t,255===e?-1:e)}for(i=0;i<De.npcCount;i++)De.npcColourHair[i]=De.getUnsignedInt();for(i=0;i<De.npcCount;i++)De.npcColourTop[i]=De.getUnsignedInt();for(i=0;i<De.npcCount;i++)De.npcColorBottom[i]=De.getUnsignedInt();for(i=0;i<De.npcCount;i++)De.npcColourSkin[i]=De.getUnsignedInt();for(i=0;i<De.npcCount;i++)De.npcWidth[i]=De.getUnsignedShort();for(i=0;i<De.npcCount;i++)De.npcHeight[i]=De.getUnsignedShort();for(i=0;i<De.npcCount;i++)De.npcWalkModel[i]=De.getUnsignedByte();for(i=0;i<De.npcCount;i++)De.npcCombatModel[i]=De.getUnsignedByte();for(i=0;i<De.npcCount;i++)De.npcCombatAnimation[i]=De.getUnsignedByte();for(i=0;i<De.npcCount;i++)De.npcCommand[i]=De.getString();for(De.textureCount=De.getUnsignedShort(),De.textureName=[],De.textureSubtypeName=[],i=0;i<De.textureCount;i++)De.textureName.push(De.getString());for(i=0;i<De.textureCount;i++)De.textureSubtypeName.push(De.getString());for(De.animationCount=De.getUnsignedShort(),De.animationName=[],De.animationCharacterColour=new Int32Array(De.animationCount),De.animationSomething=new Int32Array(De.animationCount),De.animationHasA=new Int32Array(De.animationCount),De.animationHasF=new Int32Array(De.animationCount),De.animationNumber=new Int32Array(De.animationCount),i=0;i<De.animationCount;i++)De.animationName.push(De.getString());for(i=0;i<De.animationCount;i++)De.animationCharacterColour[i]=De.getUnsignedInt();for(i=0;i<De.animationCount;i++)De.animationSomething[i]=De.getUnsignedByte();for(i=0;i<De.animationCount;i++)De.animationHasA[i]=De.getUnsignedByte();for(i=0;i<De.animationCount;i++)De.animationHasF[i]=De.getUnsignedByte();for(i=0;i<De.animationCount;i++)De.animationNumber[i]=De.getUnsignedByte();for(De.objectCount=De.getUnsignedShort(),De.objectName=[],De.objectDescription=[],De.objectCommand1=[],De.objectCommand2=[],De.objectModelIndex=new Int32Array(De.objectCount),De.objectWidth=new Int32Array(De.objectCount),De.objectHeight=new Int32Array(De.objectCount),De.objectType=new Int32Array(De.objectCount),De.objectElevation=new Int32Array(De.objectCount),i=0;i<De.objectCount;i++)De.objectName.push(De.getString());for(i=0;i<De.objectCount;i++)De.objectDescription.push(De.getString());for(i=0;i<De.objectCount;i++)De.objectCommand1.push(De.getString());for(i=0;i<De.objectCount;i++)De.objectCommand2.push(De.getString());for(i=0;i<De.objectCount;i++)De.objectModelIndex[i]=De.getModelIndex(De.getString());for(i=0;i<De.objectCount;i++)De.objectWidth[i]=De.getUnsignedByte();for(i=0;i<De.objectCount;i++)De.objectHeight[i]=De.getUnsignedByte();for(i=0;i<De.objectCount;i++)De.objectType[i]=De.getUnsignedByte();for(i=0;i<De.objectCount;i++)De.objectElevation[i]=De.getUnsignedByte();for(De.wallObjectCount=De.getUnsignedShort(),De.wallObjectName=[],De.wallObjectDescription=[],De.wallObjectCommand1=[],De.wallObjectCommand2=[],De.wallObjectHeight=new Int32Array(De.wallObjectCount),De.wallObjectTextureFront=new Int32Array(De.wallObjectCount),De.wallObjectTextureBack=new Int32Array(De.wallObjectCount),De.wallObjectAdjacent=new Int32Array(De.wallObjectCount),De.wallObjectInvisible=new Int32Array(De.wallObjectCount),i=0;i<De.wallObjectCount;i++)De.wallObjectName.push(De.getString());for(i=0;i<De.wallObjectCount;i++)De.wallObjectDescription.push(De.getString());for(i=0;i<De.wallObjectCount;i++)De.wallObjectCommand1.push(De.getString());for(i=0;i<De.wallObjectCount;i++)De.wallObjectCommand2.push(De.getString());for(i=0;i<De.wallObjectCount;i++)De.wallObjectHeight[i]=De.getUnsignedShort();for(i=0;i<De.wallObjectCount;i++)De.wallObjectTextureFront[i]=De.getUnsignedInt();for(i=0;i<De.wallObjectCount;i++)De.wallObjectTextureBack[i]=De.getUnsignedInt();for(i=0;i<De.wallObjectCount;i++)De.wallObjectAdjacent[i]=De.getUnsignedByte();for(i=0;i<De.wallObjectCount;i++)De.wallObjectInvisible[i]=De.getUnsignedByte();for(De.roofCount=De.getUnsignedShort(),De.roofHeight=new Int32Array(De.roofCount),De.roofNumVertices=new Int32Array(De.roofCount),i=0;i<De.roofCount;i++)De.roofHeight[i]=De.getUnsignedByte();for(i=0;i<De.roofCount;i++)De.roofNumVertices[i]=De.getUnsignedByte();for(De.tileCount=De.getUnsignedShort(),De.tileDecoration=new Int32Array(De.tileCount),De.overlays=new Int32Array(De.tileCount),De.tileAdjacent=new Int32Array(De.tileCount),i=0;i<De.tileCount;i++)De.tileDecoration[i]=De.getUnsignedInt();for(i=0;i<De.tileCount;i++)De.overlays[i]=De.getUnsignedByte();for(i=0;i<De.tileCount;i++)De.tileAdjacent[i]=De.getUnsignedByte();for(De.projectileSprite=De.getUnsignedShort(),De.spellCount=De.getUnsignedShort(),De.spellName=[],De.spellDescription=[],De.spellLevel=new Int32Array(De.spellCount),De.spellRunesRequired=new Int32Array(De.spellCount),De.spellType=new Int32Array(De.spellCount),De.spellRunesId=[],De.spellRunesCount=[],i=0;i<De.spellCount;i++)De.spellName.push(De.getString());for(i=0;i<De.spellCount;i++)De.spellDescription.push(De.getString());for(i=0;i<De.spellCount;i++)De.spellLevel[i]=De.getUnsignedByte();for(i=0;i<De.spellCount;i++)De.spellRunesRequired[i]=De.getUnsignedByte();for(i=0;i<De.spellCount;i++)De.spellType[i]=De.getUnsignedByte();for(i=0;i<De.spellCount;i++){let t=De.getUnsignedByte();De.spellRunesId.push(new Int32Array(t));for(let e=0;e<t;e++)De.spellRunesId[i][e]=De.getUnsignedShort()}for(i=0;i<De.spellCount;i++){let t=De.getUnsignedByte();De.spellRunesCount.push(new Int32Array(t));for(let e=0;e<t;e++)De.spellRunesCount[i][e]=De.getUnsignedByte()}for(De.prayerCount=De.getUnsignedShort(),De.prayerName=[],De.prayerDescription=[],De.prayerLevel=new Int32Array(De.prayerCount),De.prayerDrain=new Int32Array(De.prayerCount),i=0;i<De.prayerCount;i++)De.prayerName.push(De.getString());for(i=0;i<De.prayerCount;i++)De.prayerDescription.push(De.getString());for(i=0;i<De.prayerCount;i++)De.prayerLevel[i]=De.getUnsignedByte();for(i=0;i<De.prayerCount;i++)De.prayerDrain[i]=De.getUnsignedByte();De.dataString=null,De.dataInteger=null}}De.modelName=[],De.modelName.length=5e3,De.modelName.fill(null),De.textureName=null,De.textureSubtypeName=null,De.objectModelIndex=null,De.objectWidth=null,De.objectHeight=null,De.objectType=null,De.objectElevation=null,De.spellCount=0,De.npcWidth=null,De.npcHeight=null,De.npcSprite=null,De.npcAttack=null,De.npcStrength=null,De.npcHits=null,De.npcDefense=null,De.npcAttackable=null,De.spellLevel=null,De.spellRunesRequired=null,De.spellType=null,De.spellRunesId=null,De.spellRunesCount=null,De.itemCount=0,De.itemSpriteCount=0,De.npcColourHair=null,De.npcColourTop=null,De.npcColorBottom=null,De.npcColourSkin=null,De.wallObjectHeight=null,De.wallObjectTextureFront=null,De.wallObjectTextureBack=null,De.wallObjectAdjacent=null,De.wallObjectInvisible=null,De.tileCount=0,De.animationCharacterColour=null,De.animationSomething=null,De.animationHasA=null,De.animationHasF=null,De.animationNumber=null,De.wallObjectCount=0,De.prayerLevel=null,De.prayerDrain=null,De.tileDecoration=null,De.overlays=null,De.tileAdjacent=null,De.modelCount=0,De.roofHeight=null,De.roofNumVertices=null,De.prayerCount=0,De.itemName=null,De.itemDescription=null,De.itemCommand=null,De.projectileSprite=0,De.npcCount=0,De.spellName=null,De.spellDescription=null,De.textureCount=0,De.wallObjectName=null,De.wallObjectDescription=null,De.wallObjectCommand1=null,De.wallObjectCommand2=null,De.roofCount=0,De.objectCount=0,De.npcName=null,De.npcDescription=null,De.npcCommand=null,De.animationName=null,De.itemPicture=null,De.itemBasePrice=null,De.itemUnused=null,De.itemWearable=null,De.itemMask=null,De.itemSpecial=null,De.itemMembers=null,De.animationCount=0,De.prayerName=null,De.prayerDescription=null,De.objectName=null,De.objectDescription=null,De.objectCommand1=null,De.objectCommand2=null,De.npcWalkModel=null,De.npcCombatModel=null,De.npcCombatAnimation=null,De.dataString=null,De.dataInteger=null,De.stringOffset=0,De.offset=0,Be=De;var Ye=class{constructor(){this.minPlaneX=0,this.minPlaneY=0,this.maxPlaneX=0,this.maxPlaneY=0,this.minZ=0,this.maxZ=0,this.model=null,this.face=0,this.depth=0,this.normalX=0,this.normalY=0,this.normalZ=0,this.visibility=0,this.facefill=0,this.skipSomething=!1,this.index=0,this.index2=0}},Xe=class{constructor(){this.startX=0,this.endX=0,this.startS=0,this.endS=0}},Oe={};const Re=12345678;class je{constructor(t,e,i,s){this.lastVisiblePolygonsCount=0,this.anIntArray377=null,this.textureCount=0,this.textureColoursUsed=null,this.textureColourList=null,this.textureDimension=null,this.textureLoadedNumber=null,this.texturePixels=null,this.textureBackTransparent=null,this.textureColours64=null,this.textureColours128=null,this.scanlines=null,this.minY=0,this.maxY=0,this.interlace=!1,this.mouseX=0,this.mouseY=0,this.mousePickedCount=0,this.newStart=0,this.newEnd=0,this.cameraX=0,this.cameraY=0,this.cameraZ=0,this.cameraYaw=0,this.cameraPitch=0,this.cameraRoll=0,this.rampCount=50,this.gradientBase=new Int32Array(this.rampCount),this.gradientRamps=[];for(let r=0;r<this.rampCount;r+=1)this.gradientRamps.push(new Int32Array(256));this.clipNear=5,this.clipFar3d=1e3,this.clipFar2d=1e3,this.fogZFalloff=20,this.fogZDistance=10,this.wideBand=!1,this.aDouble387=1.1,this.anInt388=1,this.mousePickingActive=!1,this.mousePickedMax=100,this.mousePickedModels=[],this.mousePickedModels.length=this.mousePickedMax,this.mousePickedModels.fill(null),this.mousePickedFaces=new Int32Array(this.mousePickedMax),this.width=512,this.clipX=256,this.clipY=192,this.baseX=256,this.baseY=256,this.viewDistance=8,this.normalMagnitude=4,this.planeX=new Int32Array(40),this.planeY=new Int32Array(40),this.vertexShade=new Int32Array(40),this.vertexX=new Int32Array(40),this.vertexY=new Int32Array(40),this.vertexZ=new Int32Array(40),this.interlace=!1,this.surface=t,this.clipX=t.width2/2|0,this.clipY=t.height2/2|0,this.raster=t.pixels,this.modelCount=0,this.maxModelCount=e,this.models=[],this.models.length=this.maxModelCount,this.models.fill(null),this.visiblePolygonsCount=0,this.visiblePolygons=[];for(let r=0;r<i;r++)this.visiblePolygons.push(new Ye);this.spriteCount=0,this.view={},this.spriteId=new Int32Array(s),this.spriteWidth=new Int32Array(s),this.spriteHeight=new Int32Array(s),this.spriteX=new Int32Array(s),this.spriteZ=new Int32Array(s),this.spriteY=new Int32Array(s),this.spriteTranslateX=new Int32Array(s),null===this.aByteArray434&&(this.aByteArray434=new Int8Array(17691)),this.cameraX=0,this.cameraY=0,this.cameraZ=0,this.cameraYaw=0,this.cameraPitch=0,this.cameraRoll=0;for(let r=0;r<256;r++)je.sin512Cache[r]=32768*Math.sin(.02454369*r)|0,je.sin512Cache[r+256]=32768*Math.cos(.02454369*r)|0;for(let r=0;r<1024;r++)je.sin2048Cache[r]=32768*Math.sin(.00613592315*r)|0,je.sin2048Cache[r+1024]=32768*Math.cos(.00613592315*r)|0}static textureScanline(t,e,i,s,r,n,o,a,h,l,c,u,m,d){if(c<=0)return;let p=0,g=0,f=0;0!==o&&(i=r/o<<7,s=n/o<<7),i<0?i=0:i>16256&&(i=16256),r+=a,n+=h,0!==(o+=l)&&(p=r/o<<7,g=n/o<<7),p<0?p=0:p>16256&&(p=16256);let S=p-i>>4,w=g-s>>4;for(let C=c>>4;C>0;C--)i+=6291456&m,f=m>>23,m+=d,t[u++]=e[(16256&s)+(i>>7)]>>>f,i+=S,s+=w,t[u++]=e[(16256&s)+(i>>7)]>>>f,i+=S,s+=w,t[u++]=e[(16256&s)+(i>>7)]>>>f,i+=S,s+=w,t[u++]=e[(16256&s)+(i>>7)]>>>f,s+=w,i=(16383&(i+=S))+(6291456&m),f=m>>23,m+=d,t[u++]=e[(16256&s)+(i>>7)]>>>f,i+=S,s+=w,t[u++]=e[(16256&s)+(i>>7)]>>>f,i+=S,s+=w,t[u++]=e[(16256&s)+(i>>7)]>>>f,i+=S,s+=w,t[u++]=e[(16256&s)+(i>>7)]>>>f,s+=w,i=(16383&(i+=S))+(6291456&m),f=m>>23,m+=d,t[u++]=e[(16256&s)+(i>>7)]>>>f,i+=S,s+=w,t[u++]=e[(16256&s)+(i>>7)]>>>f,i+=S,s+=w,t[u++]=e[(16256&s)+(i>>7)]>>>f,i+=S,s+=w,t[u++]=e[(16256&s)+(i>>7)]>>>f,s+=w,i=(16383&(i+=S))+(6291456&m),f=m>>23,m+=d,t[u++]=e[(16256&s)+(i>>7)]>>>f,i+=S,s+=w,t[u++]=e[(16256&s)+(i>>7)]>>>f,i+=S,s+=w,t[u++]=e[(16256&s)+(i>>7)]>>>f,i+=S,s+=w,t[u++]=e[(16256&s)+(i>>7)]>>>f,i=p,s=g,r+=a,n+=h,0!==(o+=l)&&(p=r/o<<7,g=n/o<<7),p<0?p=0:p>16256&&(p=16256),S=p-i>>4,w=g-s>>4;for(let C=0;C<(15&c);C++)0==(3&C)&&(i=(16383&i)+(6291456&m),f=m>>23,m+=d),t[u++]=e[(16256&s)+(i>>7)]>>>f,i+=S,s+=w}static textureTranslucentScanline(t,e,i,s,r,n,o,a,h,l,c,u,m,d){if(c<=0)return;let p=0,g=0,f=0;0!==o&&(i=r/o<<7,s=n/o<<7),i<0?i=0:i>16256&&(i=16256),r+=a,n+=h,0!==(o+=l)&&(p=r/o<<7,g=n/o<<7),p<0?p=0:p>16256&&(p=16256);let S=p-i>>4,w=g-s>>4;for(let C=c>>4;C>0;C--)i+=6291456&m,f=m>>23,m+=d,t[u++]=(e[(16256&s)+(i>>7)]>>>f)+(t[u]>>1&8355711),i+=S,s+=w,t[u++]=(e[(16256&s)+(i>>7)]>>>f)+(t[u]>>1&8355711),i+=S,s+=w,t[u++]=(e[(16256&s)+(i>>7)]>>>f)+(t[u]>>1&8355711),i+=S,s+=w,t[u++]=(e[(16256&s)+(i>>7)]>>>f)+(t[u]>>1&8355711),s+=w,i=(16383&(i+=S))+(6291456&m),f=m>>23,m+=d,t[u++]=(e[(16256&s)+(i>>7)]>>>f)+(t[u]>>1&8355711),i+=S,s+=w,t[u++]=(e[(16256&s)+(i>>7)]>>>f)+(t[u]>>1&8355711),i+=S,s+=w,t[u++]=(e[(16256&s)+(i>>7)]>>>f)+(t[u]>>1&8355711),i+=S,s+=w,t[u++]=(e[(16256&s)+(i>>7)]>>>f)+(t[u]>>1&8355711),s+=w,i=(16383&(i+=S))+(6291456&m),f=m>>23,m+=d,t[u++]=(e[(16256&s)+(i>>7)]>>>f)+(t[u]>>1&8355711),i+=S,s+=w,t[u++]=(e[(16256&s)+(i>>7)]>>>f)+(t[u]>>1&8355711),i+=S,s+=w,t[u++]=(e[(16256&s)+(i>>7)]>>>f)+(t[u]>>1&8355711),i+=S,s+=w,t[u++]=(e[(16256&s)+(i>>7)]>>>f)+(t[u]>>1&8355711),s+=w,i=(16383&(i+=S))+(6291456&m),f=m>>23,m+=d,t[u++]=(e[(16256&s)+(i>>7)]>>>f)+(t[u]>>1&8355711),i+=S,s+=w,t[u++]=(e[(16256&s)+(i>>7)]>>>f)+(t[u]>>1&8355711),i+=S,s+=w,t[u++]=(e[(16256&s)+(i>>7)]>>>f)+(t[u]>>1&8355711),i+=S,s+=w,t[u++]=(e[(16256&s)+(i>>7)]>>>f)+(t[u]>>1&8355711),i=p,s=g,r+=a,n+=h,0!==(o+=l)&&(p=r/o<<7,g=n/o<<7),p<0?p=0:p>16256&&(p=16256),S=p-i>>4,w=g-s>>4;for(let C=0;C<(15&c);C++)0==(3&C)&&(i=(16383&i)+(6291456&m),f=m>>23,m+=d),t[u++]=(e[(16256&s)+(i>>7)]>>>f)+(t[u]>>1&8355711),i+=S,s+=w}static textureBackTranslucentScanline(t,e,i,s,r,n,o,a,h,l,c,u,m,d,p){if(u<=0)return;let g=0,f=0;p<<=2,0!==a&&(g=n/a<<7,f=o/a<<7),g<0?g=0:g>16256&&(g=16256);for(let S=u;S>0;S-=16){n+=h,o+=l,i=g,s=f,0!==(a+=c)&&(g=n/a<<7,f=o/a<<7),g<0?g=0:g>16256&&(g=16256);let u=g-i>>4,w=f-s>>4,C=d>>23;if(i+=6291456&d,d+=p,S<16)for(let n=0;n<S;n++)0!=(e=r[(16256&s)+(i>>7)]>>>C)&&(t[m]=e),m++,i+=u,s+=w,3==(3&n)&&(i=(16383&i)+(6291456&d),C=d>>23,d+=p);else 0!=(e=r[(16256&s)+(i>>7)]>>>C)&&(t[m]=e),m++,0!=(e=r[(16256&(s+=w))+((i+=u)>>7)]>>>C)&&(t[m]=e),m++,0!=(e=r[(16256&(s+=w))+((i+=u)>>7)]>>>C)&&(t[m]=e),m++,0!=(e=r[(16256&(s+=w))+((i+=u)>>7)]>>>C)&&(t[m]=e),m++,i=(16383&(i+=u))+(6291456&d),C=d>>23,d+=p,0!=(e=r[(16256&(s+=w))+(i>>7)]>>>C)&&(t[m]=e),m++,0!=(e=r[(16256&(s+=w))+((i+=u)>>7)]>>>C)&&(t[m]=e),m++,0!=(e=r[(16256&(s+=w))+((i+=u)>>7)]>>>C)&&(t[m]=e),m++,0!=(e=r[(16256&(s+=w))+((i+=u)>>7)]>>>C)&&(t[m]=e),m++,i=(16383&(i+=u))+(6291456&d),C=d>>23,d+=p,0!=(e=r[(16256&(s+=w))+(i>>7)]>>>C)&&(t[m]=e),m++,0!=(e=r[(16256&(s+=w))+((i+=u)>>7)]>>>C)&&(t[m]=e),m++,0!=(e=r[(16256&(s+=w))+((i+=u)>>7)]>>>C)&&(t[m]=e),m++,0!=(e=r[(16256&(s+=w))+((i+=u)>>7)]>>>C)&&(t[m]=e),m++,i=(16383&(i+=u))+(6291456&d),C=d>>23,d+=p,0!=(e=r[(16256&(s+=w))+(i>>7)]>>>C)&&(t[m]=e),m++,0!=(e=r[(16256&(s+=w))+((i+=u)>>7)]>>>C)&&(t[m]=e),m++,0!=(e=r[(16256&(s+=w))+((i+=u)>>7)]>>>C)&&(t[m]=e),m++,0!=(e=r[(16256&(s+=w))+((i+=u)>>7)]>>>C)&&(t[m]=e),m++}}static textureScanline2(t,e,i,s,r,n,o,a,h,l,c,u,m,d){if(c<=0)return;let p=0,g=0;d<<=2,0!==o&&(p=r/o<<6,g=n/o<<6),p<0?p=0:p>4032&&(p=4032);for(let f=c;f>0;f-=16){r+=a,n+=h,i=p,s=g,0!==(o+=l)&&(p=r/o<<6,g=n/o<<6),p<0?p=0:p>4032&&(p=4032);let c=p-i>>4,S=g-s>>4,w=m>>20;if(i+=786432&m,m+=d,f<16)for(let r=0;r<f;r++)t[u++]=e[(4032&s)+(i>>6)]>>>w,i+=c,s+=S,3==(3&r)&&(i=(4095&i)+(786432&m),w=m>>20,m+=d);else t[u++]=e[(4032&s)+(i>>6)]>>>w,i+=c,s+=S,t[u++]=e[(4032&s)+(i>>6)]>>>w,i+=c,s+=S,t[u++]=e[(4032&s)+(i>>6)]>>>w,i+=c,s+=S,t[u++]=e[(4032&s)+(i>>6)]>>>w,s+=S,i=(4095&(i+=c))+(786432&m),w=m>>20,m+=d,t[u++]=e[(4032&s)+(i>>6)]>>>w,i+=c,s+=S,t[u++]=e[(4032&s)+(i>>6)]>>>w,i+=c,s+=S,t[u++]=e[(4032&s)+(i>>6)]>>>w,i+=c,s+=S,t[u++]=e[(4032&s)+(i>>6)]>>>w,s+=S,i=(4095&(i+=c))+(786432&m),w=m>>20,m+=d,t[u++]=e[(4032&s)+(i>>6)]>>>w,i+=c,s+=S,t[u++]=e[(4032&s)+(i>>6)]>>>w,i+=c,s+=S,t[u++]=e[(4032&s)+(i>>6)]>>>w,i+=c,s+=S,t[u++]=e[(4032&s)+(i>>6)]>>>w,s+=S,i=(4095&(i+=c))+(786432&m),w=m>>20,m+=d,t[u++]=e[(4032&s)+(i>>6)]>>>w,i+=c,s+=S,t[u++]=e[(4032&s)+(i>>6)]>>>w,i+=c,s+=S,t[u++]=e[(4032&s)+(i>>6)]>>>w,i+=c,s+=S,t[u++]=e[(4032&s)+(i>>6)]>>>w}}static textureTranslucentScanline2(t,e,i,s,r,n,o,a,h,l,c,u,m,d){if(c<=0)return;let p=0,g=0;d<<=2,0!==o&&(p=r/o<<6,g=n/o<<6),p<0?p=0:p>4032&&(p=4032);for(let f=c;f>0;f-=16){r+=a,n+=h,i=p,s=g,0!==(o+=l)&&(p=r/o<<6,g=n/o<<6),p<0?p=0:p>4032&&(p=4032);let c=p-i>>4,S=g-s>>4,w=m>>20;if(i+=786432&m,m+=d,f<16)for(let r=0;r<f;r++)t[u++]=(e[(4032&s)+(i>>6)]>>>w)+(t[u]>>1&8355711),i+=c,s+=S,3==(3&r)&&(i=(4095&i)+(786432&m),w=m>>20,m+=d);else t[u++]=(e[(4032&s)+(i>>6)]>>>w)+(t[u]>>1&8355711),i+=c,s+=S,t[u++]=(e[(4032&s)+(i>>6)]>>>w)+(t[u]>>1&8355711),i+=c,s+=S,t[u++]=(e[(4032&s)+(i>>6)]>>>w)+(t[u]>>1&8355711),i+=c,s+=S,t[u++]=(e[(4032&s)+(i>>6)]>>>w)+(t[u]>>1&8355711),s+=S,i=(4095&(i+=c))+(786432&m),w=m>>20,m+=d,t[u++]=(e[(4032&s)+(i>>6)]>>>w)+(t[u]>>1&8355711),i+=c,s+=S,t[u++]=(e[(4032&s)+(i>>6)]>>>w)+(t[u]>>1&8355711),i+=c,s+=S,t[u++]=(e[(4032&s)+(i>>6)]>>>w)+(t[u]>>1&8355711),i+=c,s+=S,t[u++]=(e[(4032&s)+(i>>6)]>>>w)+(t[u]>>1&8355711),s+=S,i=(4095&(i+=c))+(786432&m),w=m>>20,m+=d,t[u++]=(e[(4032&s)+(i>>6)]>>>w)+(t[u]>>1&8355711),i+=c,s+=S,t[u++]=(e[(4032&s)+(i>>6)]>>>w)+(t[u]>>1&8355711),i+=c,s+=S,t[u++]=(e[(4032&s)+(i>>6)]>>>w)+(t[u]>>1&8355711),i+=c,s+=S,t[u++]=(e[(4032&s)+(i>>6)]>>>w)+(t[u]>>1&8355711),s+=S,i=(4095&(i+=c))+(786432&m),w=m>>20,m+=d,t[u++]=(e[(4032&s)+(i>>6)]>>>w)+(t[u]>>1&8355711),i+=c,s+=S,t[u++]=(e[(4032&s)+(i>>6)]>>>w)+(t[u]>>1&8355711),i+=c,s+=S,t[u++]=(e[(4032&s)+(i>>6)]>>>w)+(t[u]>>1&8355711),i+=c,s+=S,t[u++]=(e[(4032&s)+(i>>6)]>>>w)+(t[u]>>1&8355711)}}static textureBackTranslucentScanline2(t,e,i,s,r,n,o,a,h,l,c,u,m,d,p){if(u<=0)return;let g=0,f=0;p<<=2,0!==a&&(g=n/a<<6,f=o/a<<6),g<0?g=0:g>4032&&(g=4032);for(let S=u;S>0;S-=16){n+=h,o+=l,i=g,s=f,0!==(a+=c)&&(g=n/a<<6,f=o/a<<6),g<0?g=0:g>4032&&(g=4032);let u=g-i>>4,w=f-s>>4,C=d>>20;if(i+=786432&d,d+=p,S<16)for(let n=0;n<S;n++)0!=(e=r[(4032&s)+(i>>6)]>>>C)&&(t[m]=e),m++,i+=u,s+=w,3==(3&n)&&(i=(4095&i)+(786432&d),C=d>>20,d+=p);else 0!=(e=r[(4032&s)+(i>>6)]>>>C)&&(t[m]=e),m++,0!=(e=r[(4032&(s+=w))+((i+=u)>>6)]>>>C)&&(t[m]=e),m++,0!=(e=r[(4032&(s+=w))+((i+=u)>>6)]>>>C)&&(t[m]=e),m++,0!=(e=r[(4032&(s+=w))+((i+=u)>>6)]>>>C)&&(t[m]=e),m++,i=(4095&(i+=u))+(786432&d),C=d>>20,d+=p,0!=(e=r[(4032&(s+=w))+(i>>6)]>>>C)&&(t[m]=e),m++,0!=(e=r[(4032&(s+=w))+((i+=u)>>6)]>>>C)&&(t[m]=e),m++,0!=(e=r[(4032&(s+=w))+((i+=u)>>6)]>>>C)&&(t[m]=e),m++,0!=(e=r[(4032&(s+=w))+((i+=u)>>6)]>>>C)&&(t[m]=e),m++,i=(4095&(i+=u))+(786432&d),C=d>>20,d+=p,0!=(e=r[(4032&(s+=w))+(i>>6)]>>>C)&&(t[m]=e),m++,0!=(e=r[(4032&(s+=w))+((i+=u)>>6)]>>>C)&&(t[m]=e),m++,0!=(e=r[(4032&(s+=w))+((i+=u)>>6)]>>>C)&&(t[m]=e),m++,0!=(e=r[(4032&(s+=w))+((i+=u)>>6)]>>>C)&&(t[m]=e),m++,i=(4095&(i+=u))+(786432&d),C=d>>20,d+=p,0!=(e=r[(4032&(s+=w))+(i>>6)]>>>C)&&(t[m]=e),m++,0!=(e=r[(4032&(s+=w))+((i+=u)>>6)]>>>C)&&(t[m]=e),m++,0!=(e=r[(4032&(s+=w))+((i+=u)>>6)]>>>C)&&(t[m]=e),m++,0!=(e=r[(4032&(s+=w))+((i+=u)>>6)]>>>C)&&(t[m]=e),m++}}static gradientScanline(t,e,i,s,r,n,o){if(e>=0)return;o<<=1,s=r[n>>8&255],n+=o;let a=e/8|0;for(let h=a;h<0;h++)t[i++]=s,t[i++]=s,s=r[n>>8&255],n+=o,t[i++]=s,t[i++]=s,s=r[n>>8&255],n+=o,t[i++]=s,t[i++]=s,s=r[n>>8&255],n+=o,t[i++]=s,t[i++]=s,s=r[n>>8&255],n+=o;a=-e%8;for(let h=0;h<a;h++)t[i++]=s,1==(1&h)&&(s=r[n>>8&255],n+=o)}static textureGradientScanline(t,e,i,s,r,n,o){if(e>=0)return;o<<=2,s=r[n>>8&255],n+=o;let a=e/16|0;for(let h=a;h<0;h++)t[i++]=s+(t[i]>>1&8355711),t[i++]=s+(t[i]>>1&8355711),t[i++]=s+(t[i]>>1&8355711),t[i++]=s+(t[i]>>1&8355711),s=r[n>>8&255],n+=o,t[i++]=s+(t[i]>>1&8355711),t[i++]=s+(t[i]>>1&8355711),t[i++]=s+(t[i]>>1&8355711),t[i++]=s+(t[i]>>1&8355711),s=r[n>>8&255],n+=o,t[i++]=s+(t[i]>>1&8355711),t[i++]=s+(t[i]>>1&8355711),t[i++]=s+(t[i]>>1&8355711),t[i++]=s+(t[i]>>1&8355711),s=r[n>>8&255],n+=o,t[i++]=s+(t[i]>>1&8355711),t[i++]=s+(t[i]>>1&8355711),t[i++]=s+(t[i]>>1&8355711),t[i++]=s+(t[i]>>1&8355711),s=r[n>>8&255],n+=o;a=-e%16;for(let h=0;h<a;h++)t[i++]=s+(t[i]>>1&8355711),3==(3&h)&&(s=r[n>>8&255],n+=o,n+=o)}static gradientScanline2(t,e,i,s,r,n,o){if(e>=0)return;o<<=2,s=r[n>>8&255],n+=o;let a=e/16|0;for(let h=a;h<0;h++)t[i++]=s,t[i++]=s,t[i++]=s,t[i++]=s,s=r[n>>8&255],n+=o,t[i++]=s,t[i++]=s,t[i++]=s,t[i++]=s,s=r[n>>8&255],n+=o,t[i++]=s,t[i++]=s,t[i++]=s,t[i++]=s,s=r[n>>8&255],n+=o,t[i++]=s,t[i++]=s,t[i++]=s,t[i++]=s,s=r[n>>8&255],n+=o;a=-e%16;for(let h=0;h<a;h++)t[i++]=s,3==(3&h)&&(s=r[n>>8&255],n+=o)}static rgb(t,e,i){return-1-1024*(t/8|0)-32*(e/8|0)-(i/8|0)}addModel(t){null===t&&console.log("Warning tried to add null object!"),this.modelCount<this.maxModelCount&&(this.models[this.modelCount++]=t)}removeModel(t){for(let e=0;e<this.modelCount;e++)if(this.models[e]===t){this.modelCount--;for(let t=e;t<this.modelCount;t++)this.models[t]=this.models[t+1]}}dispose(){this.clear();for(let t=0;t<this.modelCount;t++)this.models[t]=null;this.modelCount=0}clear(){this.spriteCount=0,this.view.clear()}reduceSprites(t){this.spriteCount-=t,this.view.reduce(t,2*t),this.spriteCount<0&&(this.spriteCount=0)}addSprite(t,e,i,s,r,n,o){this.spriteId[this.spriteCount]=t,this.spriteX[this.spriteCount]=e,this.spriteZ[this.spriteCount]=i,this.spriteY[this.spriteCount]=s,this.spriteWidth[this.spriteCount]=r,this.spriteHeight[this.spriteCount]=n,this.spriteTranslateX[this.spriteCount]=0;let a=this.view.createVertex(e,i,s),h=this.view.createVertex(e,i-n,s),l=new Int32Array([a,h]);return this.view.createFace(2,l,0,0),this.view.faceTag[this.spriteCount]=o,this.view.isLocalPlayer[this.spriteCount++]=0,this.spriteCount-1}setLocalPlayer(t){this.view.isLocalPlayer[t]=1}setSpriteTranslateX(t,e){this.spriteTranslateX[t]=e}setMouseLoc(t,e){this.mouseX=t-this.baseX,this.mouseY=e,this.mousePickedCount=0,this.mousePickingActive=!0}getMousePickedCount(){return this.mousePickedCount}getMousePickedFaces(){return this.mousePickedFaces}getMousePickedModels(){return this.mousePickedModels}setBounds(t,e,i,s,r,n){this.clipX=i,this.clipY=s,this.baseX=t,this.baseY=e,this.width=r,this.viewDistance=n,this.scanlines=[];for(let o=0;o<s+e;o++)this.scanlines.push(new Xe)}polygonsQSort(t,e,i){if(e<i){let s=e-1,r=i+1,n=(e+i)/2|0,o=t[n];t[n]=t[e],t[e]=o;let a=o.depth;for(;s<r;){do{r--}while(t[r].depth<a);do{s++}while(t[s].depth>a);if(s<r){let e=t[s];t[s]=t[r],t[r]=e}}this.polygonsQSort(t,e,r),this.polygonsQSort(t,r+1,i)}}polygonsIntersectSort(t,e,i){for(let r=0;r<=i;r++)e[r].skipSomething=!1,e[r].index=r,e[r].index2=-1;let s=0;for(;;){for(;e[s].skipSomething;)s++;if(s===i)return;let r=e[s];r.skipSomething=!0;let n=s,o=s+t;o>=i&&(o=i-1);for(let t=o;t>=n+1;t--){let i=e[t];r.minPlaneX<i.maxPlaneX&&i.minPlaneX<r.maxPlaneX&&r.minPlaneY<i.maxPlaneY&&i.minPlaneY<r.maxPlaneY&&r.index!==i.index2&&!this.separatePolygon(r,i)&&this.heuristicPolygon(i,r)&&(this.polygonsOrder(e,n,t),e[t]!==i&&t++,n=this.newStart,i.index2=r.index)}}}polygonsOrder(t,e,i){for(;;){let s=t[e];for(let n=e+1;n<=i;n++){let r=t[n];if(!this.separatePolygon(r,s))break;if(t[e]=r,t[n]=s,(e=n)===i)return this.newStart=e,this.newEnd=e-1,!0}let r=t[i];for(let n=i-1;n>=e;n--){let s=t[n];if(!this.separatePolygon(r,s))break;if(t[i]=s,t[n]=r,e===(i=n))return this.newStart=i+1,this.newEnd=i,!0}if(e+1>=i)return this.newStart=e,this.newEnd=i,!1;if(!this.polygonsOrder(t,e+1,i))return this.newStart=e,!1;i=this.newEnd}}setFrustum(t,e,i){let s=1024-this.cameraYaw&1023,r=1024-this.cameraPitch&1023,n=1024-this.cameraRoll&1023;if(0!==n){let i=je.sin2048Cache[n],s=je.sin2048Cache[n+1024],r=e*i+t*s>>15;e=e*s-t*i>>15,t=r}if(0!==s){let t=je.sin2048Cache[s],r=je.sin2048Cache[s+1024],n=e*r-i*t>>15;i=e*t+i*r>>15,e=n}if(0!==r){let e=je.sin2048Cache[r],s=je.sin2048Cache[r+1024],n=i*e+t*s>>15;i=i*s-t*e>>15,t=n}t<je.frustumMaxX&&(je.frustumMaxX=t),t>je.frustumMinX&&(je.frustumMinX=t),e<je.frustumMaxY&&(je.frustumMaxY=e),e>je.frustumMinY&&(je.frustumMinY=e),i<je.frustumFarZ&&(je.frustumFarZ=i),i>je.frustumNearZ&&(je.frustumNearZ=i)}render(){this.interlace=this.surface.interlace;let t=this.clipX*this.clipFar3d>>this.viewDistance,e=this.clipY*this.clipFar3d>>this.viewDistance;je.frustumMaxX=0,je.frustumMinX=0,je.frustumMaxY=0,je.frustumMinY=0,je.frustumFarZ=0,je.frustumNearZ=0,this.setFrustum(-t,-e,this.clipFar3d),this.setFrustum(-t,e,this.clipFar3d),this.setFrustum(t,-e,this.clipFar3d),this.setFrustum(t,e,this.clipFar3d),this.setFrustum(-this.clipX,-this.clipY,0),this.setFrustum(-this.clipX,this.clipY,0),this.setFrustum(this.clipX,-this.clipY,0),this.setFrustum(this.clipX,this.clipY,0),je.frustumMaxX+=this.cameraX,je.frustumMinX+=this.cameraX,je.frustumMaxY+=this.cameraY,je.frustumMinY+=this.cameraY,je.frustumFarZ+=this.cameraZ,je.frustumNearZ+=this.cameraZ,this.models[this.modelCount]=this.view,this.view.transformState=2;for(let s=0;s<this.modelCount;s++)this.models[s].project(this.cameraX,this.cameraY,this.cameraZ,this.cameraYaw,this.cameraPitch,this.cameraRoll,this.viewDistance,this.clipNear);this.models[this.modelCount].project(this.cameraX,this.cameraY,this.cameraZ,this.cameraYaw,this.cameraPitch,this.cameraRoll,this.viewDistance,this.clipNear),this.visiblePolygonsCount=0;for(let s=0;s<this.modelCount;s++){let t=this.models[s];if(t.visible)for(let e=0;e<t.numFaces;e++){let i=t.faceNumVertices[e],s=t.faceVertices[e],r=!1;for(let e=0;e<i;e++){let i=t.projectVertexZ[s[e]];if(!(i<=this.clipNear||i>=this.clipFar3d)){r=!0;break}}if(r){let r=0;for(let e=0;e<i;e++){let i=t.vertexViewX[s[e]];if(i>-this.clipX&&(r|=1),i<this.clipX&&(r|=2),3===r)break}if(3===r){let r=0;for(let e=0;e<i;e++){let i=t.vertexViewY[s[e]];if(i>-this.clipY&&(r|=1),i<this.clipY&&(r|=2),3===r)break}if(3===r){let r=this.visiblePolygons[this.visiblePolygonsCount];r.model=t,r.face=e,this.initialisePolygon3D(this.visiblePolygonsCount);let n=0;if((n=r.visibility<0?t.faceFillFront[e]:t.faceFillBack[e])!==Re){let e=0;for(let r=0;r<i;r++)e+=t.projectVertexZ[s[r]];r.depth=(e/i|0)+t.depth,r.facefill=n,this.visiblePolygonsCount++}}}}}}let i=this.view;if(i.visible)for(let s=0;s<i.numFaces;s++){let t=i.faceVertices[s],e=t[0],r=i.vertexViewX[e],n=i.vertexViewY[e],o=i.projectVertexZ[e];if(o>this.clipNear&&o<this.clipFar2d){let e=(this.spriteWidth[s]<<this.viewDistance)/o|0,a=(this.spriteHeight[s]<<this.viewDistance)/o|0;if(r-(e/2|0)<=this.clipX&&r+(e/2|0)>=-this.clipX&&n-a<=this.clipY&&n>=-this.clipY){let e=this.visiblePolygons[this.visiblePolygonsCount];e.model=i,e.face=s,this.initialisePolygon2D(this.visiblePolygonsCount),e.depth=(o+i.projectVertexZ[t[1]])/2|0,this.visiblePolygonsCount++}}}if(0!==this.visiblePolygonsCount){this.lastVisiblePolygonsCount=this.visiblePolygonsCount,this.polygonsQSort(this.visiblePolygons,0,this.visiblePolygonsCount-1),this.polygonsIntersectSort(100,this.visiblePolygons,this.visiblePolygonsCount);for(let t=0;t<this.visiblePolygonsCount;t++){let e=this.visiblePolygons[t],i=e.model,s=e.face;if(i===this.view){let t=i.faceVertices[s],e=t[0],r=i.vertexViewX[e],n=i.vertexViewY[e],o=i.projectVertexZ[e],a=(this.spriteWidth[s]<<this.viewDistance)/o|0,h=(this.spriteHeight[s]<<this.viewDistance)/o|0,l=i.vertexViewX[t[1]]-r,c=r-(a/2|0),u=this.baseY+n-h;this.surface._spriteClipping_from7(c+this.baseX,u,a,h,this.spriteId[s],l,(256<<this.viewDistance)/o|0),this.mousePickingActive&&this.mousePickedCount<this.mousePickedMax&&(c+=(this.spriteTranslateX[s]<<this.viewDistance)/o|0,this.mouseY>=u&&this.mouseY<=u+h&&this.mouseX>=c&&this.mouseX<=c+a&&!i.unpickable&&0===i.isLocalPlayer[s]&&(this.mousePickedModels[this.mousePickedCount]=i,this.mousePickedFaces[this.mousePickedCount]=s,this.mousePickedCount++))}else{let t=0,r=0,n=i.faceNumVertices[s],o=i.faceVertices[s];i.faceIntensity[s]!==Re&&(r=e.visibility<0?i.lightAmbience-i.faceIntensity[s]:i.lightAmbience+i.faceIntensity[s]);for(let a=0;a<n;a++){let h=o[a];if(this.vertexX[a]=i.projectVertexX[h],this.vertexY[a]=i.projectVertexY[h],this.vertexZ[a]=i.projectVertexZ[h],i.faceIntensity[s]===Re&&(r=e.visibility<0?i.lightAmbience-i.vertexIntensity[h]+i.vertexAmbience[h]:i.lightAmbience+i.vertexIntensity[h]+i.vertexAmbience[h]),i.projectVertexZ[h]>=this.clipNear)this.planeX[t]=i.vertexViewX[h],this.planeY[t]=i.vertexViewY[h],this.vertexShade[t]=r,i.projectVertexZ[h]>this.fogZDistance&&(this.vertexShade[t]+=(i.projectVertexZ[h]-this.fogZDistance)/this.fogZFalloff|0),t++;else{let e=0;if(e=0===a?o[n-1]:o[a-1],i.projectVertexZ[e]>=this.clipNear){let s=i.projectVertexZ[h]-i.projectVertexZ[e],n=i.projectVertexX[h]-((i.projectVertexX[h]-i.projectVertexX[e])*(i.projectVertexZ[h]-this.clipNear)/s|0),o=i.projectVertexY[h]-((i.projectVertexY[h]-i.projectVertexY[e])*(i.projectVertexZ[h]-this.clipNear)/s|0);this.planeX[t]=(n<<this.viewDistance)/this.clipNear|0,this.planeY[t]=(o<<this.viewDistance)/this.clipNear|0,this.vertexShade[t]=r,t++}if(e=a===n-1?o[0]:o[a+1],i.projectVertexZ[e]>=this.clipNear){let s=i.projectVertexZ[h]-i.projectVertexZ[e],n=i.projectVertexX[h]-((i.projectVertexX[h]-i.projectVertexX[e])*(i.projectVertexZ[h]-this.clipNear)/s|0),o=i.projectVertexY[h]-((i.projectVertexY[h]-i.projectVertexY[e])*(i.projectVertexZ[h]-this.clipNear)/s|0);this.planeX[t]=(n<<this.viewDistance)/this.clipNear|0,this.planeY[t]=(o<<this.viewDistance)/this.clipNear|0,this.vertexShade[t]=r,t++}}}for(let i=0;i<n;i++)this.vertexShade[i]<0?this.vertexShade[i]=0:this.vertexShade[i]>255&&(this.vertexShade[i]=255),e.facefill>=0&&(1===this.textureDimension[e.facefill]?this.vertexShade[i]<<=9:this.vertexShade[i]<<=6);this.generateScanlines(0,0,0,0,t,this.planeX,this.planeY,this.vertexShade,i,s),this.maxY>this.minY&&this.rasterize(0,0,n,this.vertexX,this.vertexY,this.vertexZ,e.facefill,i)}}this.mousePickingActive=!1}}generateScanlines(t,e,i,s,r,n,o,a,h,l){if(3===r){let r=o[0]+this.baseY,h=o[1]+this.baseY,l=o[2]+this.baseY,c=n[0],u=n[1],m=n[2],d=a[0],p=a[1],g=a[2],f=this.baseY+this.clipY-1,S=0,w=0,C=0,I=0,y=Re,b=-Re;l!==r&&(w=(m-c<<8)/(l-r)|0,I=(g-d<<8)/(l-r)|0,r<l?(S=c<<8,C=d<<8,y=r,b=l):(S=m<<8,C=g<<8,y=l,b=r),y<0&&(S-=w*y,C-=I*y,y=0),b>f&&(b=f));let T=0,A=0,x=0,v=0,L=Re,E=-Re;h!==r&&(A=(u-c<<8)/(h-r)|0,v=(p-d<<8)/(h-r)|0,r<h?(T=c<<8,x=d<<8,L=r,E=h):(T=u<<8,x=p<<8,L=h,E=r),L<0&&(T-=A*L|0,x-=v*L|0,L=0),E>f&&(E=f));let k=0,P=0,B=0,M=0,D=Re,Y=-Re;l!==h&&(P=(m-u<<8)/(l-h)|0,M=(g-p<<8)/(l-h)|0,h<l?(k=u<<8,B=p<<8,D=h,Y=l):(k=m<<8,B=g<<8,D=l,Y=h),D<0&&(k-=P*D|0,B-=M*D|0,D=0),Y>f&&(Y=f)),this.minY=y,L<this.minY&&(this.minY=L),D<this.minY&&(this.minY=D),this.maxY=b,E>this.maxY&&(this.maxY=E),Y>this.maxY&&(this.maxY=Y);let X=0;for(i=this.minY;i<this.maxY;i++){i>=y&&i<b?(t=e=S,s=X=C,S+=w,C+=I):(t=655360,e=-655360),i>=L&&i<E&&(T<t&&(t=T,s=x),T>e&&(e=T,X=x),T+=A,x+=v),i>=D&&i<Y&&(k<t&&(t=k,s=B),k>e&&(e=k,X=B),k+=P,B+=M);let r=this.scanlines[i];r.startX=t,r.endX=e,r.startS=s,r.endS=X}this.minY<this.baseY-this.clipY&&(this.minY=this.baseY-this.clipY)}else if(4===r){let r=o[0]+this.baseY,h=o[1]+this.baseY,l=o[2]+this.baseY,c=o[3]+this.baseY,u=n[0],m=n[1],d=n[2],p=n[3],g=a[0],f=a[1],S=a[2],w=a[3],C=this.baseY+this.clipY-1,I=0,y=0,b=0,T=0,A=Re,x=-Re;c!==r&&(y=(p-u<<8)/(c-r)|0,T=(w-g<<8)/(c-r)|0,r<c?(I=u<<8,b=g<<8,A=r,x=c):(I=p<<8,b=w<<8,A=c,x=r),A<0&&(I-=y*A,b-=T*A,A=0),x>C&&(x=C));let v=0,L=0,E=0,k=0,P=Re,B=-Re;h!==r&&(L=(m-u<<8)/(h-r)|0,k=(f-g<<8)/(h-r)|0,r<h?(v=u<<8,E=g<<8,P=r,B=h):(v=m<<8,E=f<<8,P=h,B=r),P<0&&(v-=L*P,E-=k*P,P=0),B>C&&(B=C));let M=0,D=0,Y=0,X=0,O=Re,R=-Re;l!==h&&(D=(d-m<<8)/(l-h)|0,X=(S-f<<8)/(l-h)|0,h<l?(M=m<<8,Y=f<<8,O=h,R=l):(M=d<<8,Y=S<<8,O=l,R=h),O<0&&(M-=D*O,Y-=X*O,O=0),R>C&&(R=C));let j=0,N=0,_=0,U=0,H=Re,W=-Re;c!==l&&(N=(p-d<<8)/(c-l)|0,U=(w-S<<8)/(c-l)|0,l<c?(j=d<<8,_=S<<8,H=l,W=c):(j=p<<8,_=w<<8,H=c,W=l),H<0&&(j-=N*H,_-=U*H,H=0),W>C&&(W=C)),this.minY=A,P<this.minY&&(this.minY=P),O<this.minY&&(this.minY=O),H<this.minY&&(this.minY=H),this.maxY=x,B>this.maxY&&(this.maxY=B),R>this.maxY&&(this.maxY=R),W>this.maxY&&(this.maxY=W);let F=0;for(i=this.minY;i<this.maxY;i++){i>=A&&i<x?(t=e=I,s=F=b,I+=y,b+=T):(t=655360,e=-655360),i>=P&&i<B&&(v<t&&(t=v,s=E),v>e&&(e=v,F=E),v+=L,E+=k),i>=O&&i<R&&(M<t&&(t=M,s=Y),M>e&&(e=M,F=Y),M+=D,Y+=X),i>=H&&i<W&&(j<t&&(t=j,s=_),j>e&&(e=j,F=_),j+=N,_+=U);let r=this.scanlines[i];r.startX=t,r.endX=e,r.startS=s,r.endS=F}this.minY<this.baseY-this.clipY&&(this.minY=this.baseY-this.clipY)}else{for(this.maxY=this.minY=o[0]+=this.baseY,i=1;i<r;i++){let t=0;(t=o[i]+=this.baseY)<this.minY?this.minY=t:t>this.maxY&&(this.maxY=t)}if(this.minY<this.baseY-this.clipY&&(this.minY=this.baseY-this.clipY),this.maxY>=this.baseY+this.clipY&&(this.maxY=this.baseY+this.clipY-1),this.minY>=this.maxY)return;for(i=this.minY;i<this.maxY;i++){let t=this.scanlines[i];t.startX=655360,t.endX=-655360}let t=r-1,e=o[0],s=o[t];if(e<s){let r=n[0]<<8,o=(n[t]-n[0]<<8)/(s-e)|0,h=a[0]<<8,l=(a[t]-a[0]<<8)/(s-e)|0;for(e<0&&(r-=o*e,h-=l*e,e=0),s>this.maxY&&(s=this.maxY),i=e;i<=s;i++){let t=this.scanlines[i];t.startX=t.endX=r,t.startS=t.endS=h,r+=o,h+=l}}else if(e>s){let r=n[t]<<8,o=(n[0]-n[t]<<8)/(e-s)|0,h=a[t]<<8,l=(a[0]-a[t]<<8)/(e-s)|0;for(s<0&&(r-=o*s,h-=l*s,s=0),e>this.maxY&&(e=this.maxY),i=s;i<=e;i++){let t=this.scanlines[i];t.startX=t.endX=r,t.startS=t.endS=h,r+=o,h+=l}}for(i=0;i<t;i++){let t=i+1,e=o[i],s=o[t];if(e<s){let r=n[i]<<8,o=(n[t]-n[i]<<8)/(s-e)|0,h=a[i]<<8,l=(a[t]-a[i]<<8)/(s-e)|0;e<0&&(r-=o*e,h-=l*e,e=0),s>this.maxY&&(s=this.maxY);for(let t=e;t<=s;t++){let e=this.scanlines[t];r<e.startX&&(e.startX=r,e.startS=h),r>e.endX&&(e.endX=r,e.endS=h),r+=o,h+=l}}else if(e>s){let r=n[t]<<8,o=(n[i]-n[t]<<8)/(e-s)|0,h=a[t]<<8,l=(a[i]-a[t]<<8)/(e-s)|0;s<0&&(r-=o*s,h-=l*s,s=0),e>this.maxY&&(e=this.maxY);for(let t=s;t<=e;t++){let e=this.scanlines[t];r<e.startX&&(e.startX=r,e.startS=h),r>e.endX&&(e.endX=r,e.endS=h),r+=o,h+=l}}}this.minY<this.baseY-this.clipY&&(this.minY=this.baseY-this.clipY)}if(this.mousePickingActive&&this.mousePickedCount<this.mousePickedMax&&this.mouseY>=this.minY&&this.mouseY<this.maxY){let t=this.scanlines[this.mouseY];this.mouseX>=t.startX>>8&&this.mouseX<=t.endX>>8&&t.startX<=t.endX&&!h.unpickable&&0===h.isLocalPlayer[l]&&(this.mousePickedModels[this.mousePickedCount]=h,this.mousePickedFaces[this.mousePickedCount]=l,this.mousePickedCount++)}}rasterize(t,e,i,s,r,n,o,a){if(-2===o)return;if(o>=0){o>=this.textureCount&&(o=0),this.prepareTexture(o);let h=s[0],l=r[0],c=n[0],u=h-s[1],m=l-r[1],d=c-n[1],p=s[--i]-h,g=r[i]-l,f=n[i]-c;if(1===this.textureDimension[o]){let i=p*l-g*h<<12,s=g*c-f*l<<5-this.viewDistance+7+4,r=f*h-p*c<<5-this.viewDistance+7,n=u*l-m*h<<12,S=m*c-d*l<<5-this.viewDistance+7+4,w=d*h-u*c<<5-this.viewDistance+7,C=m*p-u*g<<5,I=d*g-m*f<<5-this.viewDistance+4,y=u*f-d*p>>this.viewDistance-5,b=s>>4,T=S>>4,A=I>>4,x=this.minY-this.baseY,v=this.width,L=this.baseX+this.minY*v,E=1;if(i+=r*x,n+=w*x,C+=y*x,this.interlace&&(1==(1&this.minY)&&(this.minY++,i+=r,n+=w,C+=y,L+=v),r<<=1,w<<=1,y<<=1,v<<=1,E=2),a.textureTranslucent){for(t=this.minY;t<this.maxY;t+=E){let a=this.scanlines[t];e=a.startX>>8;let h=a.endX>>8,l=h-e;if(l<=0)i+=r,n+=w,C+=y,L+=v;else{let t=a.startS,c=(a.endS-t)/l|0;e<-this.clipX&&(t+=(-this.clipX-e)*c,l=h-(e=-this.clipX)),h>this.clipX&&(l=this.clipX-e),je.textureTranslucentScanline(this.raster,this.texturePixels[o],0,0,i+b*e,n+T*e,C+A*e,s,S,I,l,L+e,t,c<<2),i+=r,n+=w,C+=y,L+=v}}return}if(!this.textureBackTransparent[o]){for(t=this.minY;t<this.maxY;t+=E){let a=this.scanlines[t];e=a.startX>>8;let h=a.endX>>8,l=h-e;if(l<=0)i+=r,n+=w,C+=y,L+=v;else{let t=a.startS,c=(a.endS-t)/l|0;e<-this.clipX&&(t+=(-this.clipX-e)*c,l=h-(e=-this.clipX)),h>this.clipX&&(l=this.clipX-e),je.textureScanline(this.raster,this.texturePixels[o],0,0,i+b*e,n+T*e,C+A*e,s,S,I,l,L+e,t,c<<2),i+=r,n+=w,C+=y,L+=v}}return}for(t=this.minY;t<this.maxY;t+=E){let a=this.scanlines[t];e=a.startX>>8;let h=a.endX>>8,l=h-e;if(l<=0)i+=r,n+=w,C+=y,L+=v;else{let t=a.startS,c=(a.endS-t)/l|0;e<-this.clipX&&(t+=(-this.clipX-e)*c,l=h-(e=-this.clipX)),h>this.clipX&&(l=this.clipX-e),je.textureBackTranslucentScanline(this.raster,0,0,0,this.texturePixels[o],i+b*e,n+T*e,C+A*e,s,S,I,l,L+e,t,c),i+=r,n+=w,C+=y,L+=v}}return}let S=p*l-g*h<<11,w=g*c-f*l<<5-this.viewDistance+6+4,C=f*h-p*c<<5-this.viewDistance+6,I=u*l-m*h<<11,y=m*c-d*l<<5-this.viewDistance+6+4,b=d*h-u*c<<5-this.viewDistance+6,T=m*p-u*g<<5,A=d*g-m*f<<5-this.viewDistance+4,x=u*f-d*p>>this.viewDistance-5,v=w>>4,L=y>>4,E=A>>4,k=this.minY-this.baseY,P=this.width,B=this.baseX+this.minY*P,M=1;if(S+=C*k,I+=b*k,T+=x*k,this.interlace&&(1==(1&this.minY)&&(this.minY++,S+=C,I+=b,T+=x,B+=P),C<<=1,b<<=1,x<<=1,P<<=1,M=2),a.textureTranslucent){for(t=this.minY;t<this.maxY;t+=M){let i=this.scanlines[t];e=i.startX>>8;let s=i.endX>>8,r=s-e;if(r<=0)S+=C,I+=b,T+=x,B+=P;else{let t=i.startS,n=(i.endS-t)/r|0;e<-this.clipX&&(t+=(-this.clipX-e)*n,r=s-(e=-this.clipX)),s>this.clipX&&(r=this.clipX-e),je.textureTranslucentScanline2(this.raster,this.texturePixels[o],0,0,S+v*e,I+L*e,T+E*e,w,y,A,r,B+e,t,n),S+=C,I+=b,T+=x,B+=P}}return}if(!this.textureBackTransparent[o]){for(t=this.minY;t<this.maxY;t+=M){let i=this.scanlines[t];e=i.startX>>8;let s=i.endX>>8,r=s-e;if(r<=0)S+=C,I+=b,T+=x,B+=P;else{let t=i.startS,n=(i.endS-t)/r|0;e<-this.clipX&&(t+=(-this.clipX-e)*n,r=s-(e=-this.clipX)),s>this.clipX&&(r=this.clipX-e),je.textureScanline2(this.raster,this.texturePixels[o],0,0,S+v*e,I+L*e,T+E*e,w,y,A,r,B+e,t,n),S+=C,I+=b,T+=x,B+=P}}return}for(t=this.minY;t<this.maxY;t+=M){let i=this.scanlines[t];e=i.startX>>8;let s=i.endX>>8,r=s-e;if(r<=0)S+=C,I+=b,T+=x,B+=P;else{let t=i.startS,n=(i.endS-t)/r|0;e<-this.clipX&&(t+=(-this.clipX-e)*n,r=s-(e=-this.clipX)),s>this.clipX&&(r=this.clipX-e),je.textureBackTranslucentScanline2(this.raster,0,0,0,this.texturePixels[o],S+v*e,I+L*e,T+E*e,w,y,A,r,B+e,t,n),S+=C,I+=b,T+=x,B+=P}}return}for(let u=0;u<this.rampCount;u++){if(this.gradientBase[u]===o){this.anIntArray377=this.gradientRamps[u];break}if(u===this.rampCount-1){let t=Math.random()*this.rampCount|0;this.gradientBase[t]=o;let e=8*((o=-1-o)>>10&31),i=8*(o>>5&31),s=8*(31&o);for(let r=0;r<256;r++){let n=r*r,o=e*n>>16,a=i*n>>16,h=s*n>>16;this.gradientRamps[t][255-r]=(o<<16)+(a<<8)+h}this.anIntArray377=this.gradientRamps[t]}}let h=this.width,l=this.baseX+this.minY*h,c=1;if(this.interlace&&(1==(1&this.minY)&&(this.minY++,l+=h),h<<=1,c=2),a.transparent)for(t=this.minY;t<this.maxY;t+=c){let i=this.scanlines[t];e=i.startX>>8;let s=i.endX>>8,r=s-e;if(r<=0)l+=h;else{let t=i.startS,n=(i.endS-t)/r|0;e<-this.clipX&&(t+=(-this.clipX-e)*n,r=s-(e=-this.clipX)),s>this.clipX&&(r=this.clipX-e),je.textureGradientScanline(this.raster,-r,l+e,0,this.anIntArray377,t,n),l+=h}}else if(this.wideBand)for(t=this.minY;t<this.maxY;t+=c){let i=this.scanlines[t];e=i.startX>>8;let s=i.endX>>8,r=s-e;if(r<=0)l+=h;else{let t=i.startS,n=(i.endS-t)/r|0;e<-this.clipX&&(t+=(-this.clipX-e)*n,r=s-(e=-this.clipX)),s>this.clipX&&(r=this.clipX-e),je.gradientScanline(this.raster,-r,l+e,0,this.anIntArray377,t,n),l+=h}}else for(t=this.minY;t<this.maxY;t+=c){let i=this.scanlines[t];e=i.startX>>8;let s=i.endX>>8,r=s-e;if(r<=0)l+=h;else{let t=i.startS,n=(i.endS-t)/r|0;e<-this.clipX&&(t+=(-this.clipX-e)*n,r=s-(e=-this.clipX)),s>this.clipX&&(r=this.clipX-e),je.gradientScanline2(this.raster,-r,l+e,0,this.anIntArray377,t,n),l+=h}}}setCamera(t,e,i,s,r,n,o){s&=1023,r&=1023,n&=1023,this.cameraYaw=1024-s&1023,this.cameraPitch=1024-r&1023,this.cameraRoll=1024-n&1023;let a=0,h=0,l=o;if(0!==s){let t=je.sin2048Cache[s],e=je.sin2048Cache[s+1024],i=h*e-l*t>>15;l=h*t+l*e>>15,h=i}if(0!==r){let t=je.sin2048Cache[r],e=je.sin2048Cache[r+1024],i=l*t+a*e>>15;l=l*e-a*t>>15,a=i}if(0!==n){let t=je.sin2048Cache[n],e=je.sin2048Cache[n+1024],i=h*t+a*e>>15;h=h*e-a*t>>15,a=i}this.cameraX=t-a,this.cameraY=e-h,this.cameraZ=i-l}initialisePolygon3D(t){let e=this.visiblePolygons[t],i=e.model,s=e.face,r=i.faceVertices[s],n=i.faceNumVertices[s],o=i.normalScale[s],a=i.projectVertexX[r[0]],h=i.projectVertexY[r[0]],l=i.projectVertexZ[r[0]],c=i.projectVertexX[r[1]]-a,u=i.projectVertexY[r[1]]-h,m=i.projectVertexZ[r[1]]-l,d=i.projectVertexX[r[2]]-a,p=i.projectVertexY[r[2]]-h,g=i.projectVertexZ[r[2]]-l,f=u*g-p*m,S=m*d-g*c,w=c*p-d*u;if(-1===o){for(o=0;f>25e3||S>25e3||w>25e3||f<-25e3||S<-25e3||w<-25e3;w>>=1)o++,f>>=1,S>>=1;i.normalScale[s]=o,i.normalMagnitude[s]=this.normalMagnitude*Math.sqrt(f*f+S*S+w*w)|0}else f>>=o,S>>=o,w>>=o;e.visibility=a*f+h*S+l*w,e.normalX=f,e.normalY=S,e.normalZ=w;let C=i.projectVertexZ[r[0]],I=C,y=i.vertexViewX[r[0]],b=y,T=i.vertexViewY[r[0]],A=T;for(let x=1;x<n;x++){let t=i.projectVertexZ[r[x]];t>I?I=t:t<C&&(C=t),(t=i.vertexViewX[r[x]])>b?b=t:t<y&&(y=t),(t=i.vertexViewY[r[x]])>A?A=t:t<T&&(T=t)}e.minZ=C,e.maxZ=I,e.minPlaneX=y,e.maxPlaneX=b,e.minPlaneY=T,e.maxPlaneY=A}initialisePolygon2D(t){let e=this.visiblePolygons[t],i=e.model,s=e.face,r=i.faceVertices[s],n=i.projectVertexX[r[0]],o=i.projectVertexY[r[0]],a=i.projectVertexZ[r[0]];i.normalMagnitude[s]=1,i.normalScale[s]=0,e.visibility=0*n+0*o+1*a,e.normalX=0,e.normalY=0,e.normalZ=1;let h=i.projectVertexZ[r[0]],l=h,c=i.vertexViewX[r[0]],u=c;i.vertexViewX[r[1]]<c?c=i.vertexViewX[r[1]]:u=i.vertexViewX[r[1]];let m=i.vertexViewY[r[1]],d=i.vertexViewY[r[0]],p=i.projectVertexZ[r[1]];p>l?l=p:p<h&&(h=p),(p=i.vertexViewX[r[1]])>u?u=p:p<c&&(c=p),(p=i.vertexViewY[r[1]])>d?d=p:p<m&&(m=p),e.minZ=h,e.maxZ=l,e.minPlaneX=c-20,e.maxPlaneX=u+20,e.minPlaneY=m,e.maxPlaneY=d}separatePolygon(t,e){if(t.minPlaneX>=e.maxPlaneX)return!0;if(e.minPlaneX>=t.maxPlaneX)return!0;if(t.minPlaneY>=e.maxPlaneY)return!0;if(e.minPlaneY>=t.maxPlaneY)return!0;if(t.minZ>=e.maxZ)return!0;if(e.minZ>t.maxZ)return!1;let i,s,r,n,o=t.model,a=e.model,h=t.face,l=e.face,c=o.faceVertices[h],u=a.faceVertices[l],m=o.faceNumVertices[h],d=a.faceNumVertices[l],p=a.projectVertexX[u[0]],g=a.projectVertexY[u[0]],f=a.projectVertexZ[u[0]],S=e.normalX,w=e.normalY,C=e.normalZ,I=a.normalMagnitude[l],y=e.visibility,b=!1;for(let T=0;T<m;T++){let t=c[T],e=(p-o.projectVertexX[t])*S+(g-o.projectVertexY[t])*w+(f-o.projectVertexZ[t])*C;if(!(e>=-I||y>=0)||!(e<=I||y<=0)){b=!0;break}}if(!b)return!0;p=o.projectVertexX[c[0]],g=o.projectVertexY[c[0]],f=o.projectVertexZ[c[0]],S=t.normalX,w=t.normalY,C=t.normalZ,I=o.normalMagnitude[h],y=t.visibility,b=!1;for(let T=0;T<d;T++){let t=u[T],e=(p-a.projectVertexX[t])*S+(g-a.projectVertexY[t])*w+(f-a.projectVertexZ[t])*C;if(!(e>=-I||y<=0)||!(e<=I||y>=0)){b=!0;break}}if(!b)return!0;if(2===m){i=new Int32Array(4),s=new Int32Array(4);let t=c[0],e=c[1];i[0]=o.vertexViewX[t]-20,i[1]=o.vertexViewX[e]-20,i[2]=o.vertexViewX[e]+20,i[3]=o.vertexViewX[t]+20,s[0]=s[3]=o.vertexViewY[t],s[1]=s[2]=o.vertexViewY[e]}else{i=new Int32Array(m),s=new Int32Array(m);for(let t=0;t<m;t++){let e=c[t];i[t]=o.vertexViewX[e],s[t]=o.vertexViewY[e]}}if(2===d){r=new Int32Array(4),n=new Int32Array(4);let t=u[0],e=u[1];r[0]=a.vertexViewX[t]-20,r[1]=a.vertexViewX[e]-20,r[2]=a.vertexViewX[e]+20,r[3]=a.vertexViewX[t]+20,n[0]=n[3]=a.vertexViewY[t],n[1]=n[2]=a.vertexViewY[e]}else{r=new Int32Array(d),n=new Int32Array(d);for(let t=0;t<d;t++){let e=u[t];r[t]=a.vertexViewX[e],n[t]=a.vertexViewY[e]}}return!this.intersect(i,s,r,n)}heuristicPolygon(t,e){let i=t.model,s=e.model,r=t.face,n=e.face,o=i.faceVertices[r],a=s.faceVertices[n],h=i.faceNumVertices[r],l=s.faceNumVertices[n],c=s.projectVertexX[a[0]],u=s.projectVertexY[a[0]],m=s.projectVertexZ[a[0]],d=e.normalX,p=e.normalY,g=e.normalZ,f=s.normalMagnitude[n],S=e.visibility,w=!1;for(let C=0;C<h;C++){let t=o[C],e=(c-i.projectVertexX[t])*d+(u-i.projectVertexY[t])*p+(m-i.projectVertexZ[t])*g;if(!(e>=-f||S>=0)||!(e<=f||S<=0)){w=!0;break}}if(!w)return!0;c=i.projectVertexX[o[0]],u=i.projectVertexY[o[0]],m=i.projectVertexZ[o[0]],d=t.normalX,p=t.normalY,g=t.normalZ,f=i.normalMagnitude[r],S=t.visibility,w=!1;for(let C=0;C<l;C++){let t=a[C],e=(c-s.projectVertexX[t])*d+(u-s.projectVertexY[t])*p+(m-s.projectVertexZ[t])*g;if(!(e>=-f||S<=0)||!(e<=f||S>=0)){w=!0;break}}return!w}allocateTextures(t,e,i){this.textureCount=t,this.textureColoursUsed=[],this.textureColoursUsed.length=t,this.textureColoursUsed.fill(null),this.textureColourList=[],this.textureColourList.length=t,this.textureColourList.fill(null),this.textureDimension=new Int32Array(t),this.textureLoadedNumber=[],this.textureLoadedNumber.length=t,this.textureLoadedNumber.fill(null),this.textureBackTransparent=new Int8Array(t),this.texturePixels=[],this.texturePixels.length=t,this.texturePixels.fill(null),je.textureCountLoaded=w.fromInt(0);for(let s=0;s<t;s+=1)this.textureLoadedNumber.push(w.fromInt(0));this.textureColours64=[],this.textureColours64.length=e,this.textureColours64.fill(null),this.textureColours128=[],this.textureColours128.length=i,this.textureColours128.fill(null)}defineTexture(t,e,i,s){this.textureColoursUsed[t]=e,this.textureColourList[t]=i,this.textureDimension[t]=s,this.textureLoadedNumber[t]=w.fromInt(0),this.textureBackTransparent[t]=!1,this.texturePixels[t]=null,this.prepareTexture(t)}prepareTexture(t){if(t<0)return;if(je.textureCountLoaded=je.textureCountLoaded.add(1),this.textureLoadedNumber[t]=w.fromInt(je.textureCountLoaded),null!==this.texturePixels[t])return;if(0===this.textureDimension[t]){for(let s=0;s<this.textureColours64.length;s++)if(null===this.textureColours64[s])return this.textureColours64[s]=new Int32Array(16384),this.texturePixels[t]=this.textureColours64[s],void this.setTexturePixels(t);let e=w.fromInt(1).shiftLeft(30),i=0;for(let s=0;s<this.textureCount;s++)s!==t&&0===this.textureDimension[s]&&null!==this.texturePixels[s]&&this.textureLoadedNumber[s].lessThan(e)&&(e=this.textureLoadedNumber[s],i=s);return this.texturePixels[t]=this.texturePixels[i],this.texturePixels[i]=null,void this.setTexturePixels(t)}for(let s=0;s<this.textureColours128.length;s++)if(null===this.textureColours128[s])return this.textureColours128[s]=new Int32Array(65536),this.texturePixels[t]=this.textureColours128[s],void this.setTexturePixels(t);let e=w.fromInt(1).shiftLeft(30),i=0;for(let s=0;s<this.textureCount;s++)s!==t&&1===this.textureDimension[s]&&null!==this.texturePixels[s]&&this.textureLoadedNumber[s].lessThan(e)&&(e=this.textureLoadedNumber[s],i=s);this.texturePixels[t]=this.texturePixels[i],this.texturePixels[i]=null,this.setTexturePixels(t)}setTexturePixels(t){let e;e=0===this.textureDimension[t]?64:128;let i=this.texturePixels[t],s=0;for(let r=0;r<e;r++)for(let n=0;n<e;n++){let o=this.textureColourList[t][255&this.textureColoursUsed[t][n+r*e]];0==(o&=16316671)?o=1:16253183===o&&(o=0,this.textureBackTransparent[t]=!0),i[s++]=o}for(let r=0;r<s;r++){let t=i[r];i[s+r]=t-(t>>>3)&16316671,i[2*s+r]=t-(t>>>2)&16316671,i[3*s+r]=t-(t>>>2)-(t>>>3)&16316671}}doSOemthingWithTheFuckinFountainFuck(t){if(null===this.texturePixels[t])return;let e=this.texturePixels[t];for(let s=0;s<64;s++){let i=s+4032,r=e[i];for(let t=0;t<63;t++)e[i]=e[i-64],i-=64;this.texturePixels[t][i]=r}let i=4096;for(let s=0;s<i;s++){let t=e[s];e[i+s]=t-(t>>>3)&16316671,e[2*i+s]=t-(t>>>2)&16316671,e[3*i+s]=t-(t>>>2)-(t>>>3)&16316671}}method302(t){return t===Re?0:(this.prepareTexture(t),t>=0?this.texturePixels[t][0]:t<0?(((t=-(t+1))>>10&31)<<19)+((t>>5&31)<<11)+((31&t)<<3):0)}setLightSourceCoords(t,e,i){0===t&&0===e&&0===i&&(t=32);for(let s=0;s<this.modelCount;s++)this.models[s].setLightCoords(t,e,i)}createLightSource(t,e,i,s,r){0===i&&0===s&&0===r&&(i=32);for(let n=0;n<this.modelCount;n++)this.models[n].offsetLightSourceCoords(t,e,i,s,r)}setLight(...t){switch(t.length){case 3:return this.setLightSourceCoords(...t);case 5:return this.createLightSource(...t)}}method306(t,e,i,s,r){return s===e?t:t+((i-t)*(r-e)/(s-e)|0)}method307(t,e,i,s,r){return r&&t<=i||t<i?t>s||e>i||e>s||!r:t<s||e<i||e<s||r}method308(t,e,i,s){return s&&t<=i||t<i?e>i||!s:e<i||s}intersect(t,e,i,s){let r,n,o=t.length,a=i.length,h=0,l=r=e[0],c=0,u=n=s[0],m=0;for(let C=1;C<o;C++)e[C]<r?(r=e[C],c=C):e[C]>l&&(l=e[C]);for(let C=1;C<a;C++)s[C]<n?(n=s[C],m=C):s[C]>u&&(u=s[C]);if(n>=l)return!1;if(r>=u)return!1;let d,p=0,g=0;if(e[c]<s[m]){for(p=c;e[p]<s[m];)p=(p+1)%o;for(;e[c]<s[m];)c=(c-1+o)%o;let r=this.method306(t[(c+1)%o],e[(c+1)%o],t[c],e[c],s[m]),n=this.method306(t[(p-1+o)%o],e[(p-1+o)%o],t[p],e[p],s[m]),l=i[m];if(d=r<l|n<l,this.method308(r,n,l,d))return!0;g=(m+1)%a,m=(m-1+a)%a,c===p&&(h=1)}else{for(g=m;s[g]<e[c];)g=(g+1)%a;for(;s[m]<e[c];)m=(m-1+a)%a;let r=t[c],n=this.method306(i[(m+1)%a],s[(m+1)%a],i[m],s[m],e[c]),l=this.method306(i[(g-1+a)%a],s[(g-1+a)%a],i[g],s[g],e[c]);if(d=r<n|r<l,this.method308(n,l,r,!d))return!0;p=(c+1)%o,c=(c-1+o)%o,m===g&&(h=2)}for(;0===h;)if(e[c]<e[p])if(e[c]<s[m])if(e[c]<s[g]){let r=t[c],n=this.method306(t[(p-1+o)%o],e[(p-1+o)%o],t[p],e[p],e[c]),l=this.method306(i[(m+1)%a],s[(m+1)%a],i[m],s[m],e[c]),u=this.method306(i[(g-1+a)%a],s[(g-1+a)%a],i[g],s[g],e[c]);if(this.method307(r,n,l,u,d))return!0;(c=(c-1+o)%o)===p&&(h=1)}else{let r=this.method306(t[(c+1)%o],e[(c+1)%o],t[c],e[c],s[g]),n=this.method306(t[(p-1+o)%o],e[(p-1+o)%o],t[p],e[p],s[g]),l=this.method306(i[(m+1)%a],s[(m+1)%a],i[m],s[m],s[g]),u=i[g];if(this.method307(r,n,l,u,d))return!0;m===(g=(g+1)%a)&&(h=2)}else if(s[m]<s[g]){let r=this.method306(t[(c+1)%o],e[(c+1)%o],t[c],e[c],s[m]),n=this.method306(t[(p-1+o)%o],e[(p-1+o)%o],t[p],e[p],s[m]),l=i[m],u=this.method306(i[(g-1+a)%a],s[(g-1+a)%a],i[g],s[g],s[m]);if(this.method307(r,n,l,u,d))return!0;(m=(m-1+a)%a)===g&&(h=2)}else{let r=this.method306(t[(c+1)%o],e[(c+1)%o],t[c],e[c],s[g]),n=this.method306(t[(p-1+o)%o],e[(p-1+o)%o],t[p],e[p],s[g]),l=this.method306(i[(m+1)%a],s[(m+1)%a],i[m],s[m],s[g]),u=i[g];if(this.method307(r,n,l,u,d))return!0;m===(g=(g+1)%a)&&(h=2)}else if(e[p]<s[m])if(e[p]<s[g]){let r=this.method306(t[(c+1)%o],e[(c+1)%o],t[c],e[c],e[p]),n=t[p],l=this.method306(i[(m+1)%a],s[(m+1)%a],i[m],s[m],e[p]),u=this.method306(i[(g-1+a)%a],s[(g-1+a)%a],i[g],s[g],e[p]);if(this.method307(r,n,l,u,d))return!0;c===(p=(p+1)%o)&&(h=1)}else{let r=this.method306(t[(c+1)%o],e[(c+1)%o],t[c],e[c],s[g]),n=this.method306(t[(p-1+o)%o],e[(p-1+o)%o],t[p],e[p],s[g]),l=this.method306(i[(m+1)%a],s[(m+1)%a],i[m],s[m],s[g]),u=i[g];if(this.method307(r,n,l,u,d))return!0;m===(g=(g+1)%a)&&(h=2)}else if(s[m]<s[g]){let r=this.method306(t[(c+1)%o],e[(c+1)%o],t[c],e[c],s[m]),n=this.method306(t[(p-1+o)%o],e[(p-1+o)%o],t[p],e[p],s[m]),l=i[m],u=this.method306(i[(g-1+a)%a],s[(g-1+a)%a],i[g],s[g],s[m]);if(this.method307(r,n,l,u,d))return!0;(m=(m-1+a)%a)===g&&(h=2)}else{let r=this.method306(t[(c+1)%o],e[(c+1)%o],t[c],e[c],s[g]),n=this.method306(t[(p-1+o)%o],e[(p-1+o)%o],t[p],e[p],s[g]),l=this.method306(i[(m+1)%a],s[(m+1)%a],i[m],s[m],s[g]),u=i[g];if(this.method307(r,n,l,u,d))return!0;m===(g=(g+1)%a)&&(h=2)}for(;1===h;)if(e[c]<s[m]){if(e[c]<s[g]){let r=t[c],n=this.method306(i[(m+1)%a],s[(m+1)%a],i[m],s[m],e[c]),o=this.method306(i[(g-1+a)%a],s[(g-1+a)%a],i[g],s[g],e[c]);return this.method308(n,o,r,!d)}let r=this.method306(t[(c+1)%o],e[(c+1)%o],t[c],e[c],s[g]),n=this.method306(t[(p-1+o)%o],e[(p-1+o)%o],t[p],e[p],s[g]),l=this.method306(i[(m+1)%a],s[(m+1)%a],i[m],s[m],s[g]),u=i[g];if(this.method307(r,n,l,u,d))return!0;m===(g=(g+1)%a)&&(h=0)}else if(s[m]<s[g]){let r=this.method306(t[(c+1)%o],e[(c+1)%o],t[c],e[c],s[m]),n=this.method306(t[(p-1+o)%o],e[(p-1+o)%o],t[p],e[p],s[m]),l=i[m],u=this.method306(i[(g-1+a)%a],s[(g-1+a)%a],i[g],s[g],s[m]);if(this.method307(r,n,l,u,d))return!0;(m=(m-1+a)%a)===g&&(h=0)}else{let r=this.method306(t[(c+1)%o],e[(c+1)%o],t[c],e[c],s[g]),n=this.method306(t[(p-1+o)%o],e[(p-1+o)%o],t[p],e[p],s[g]),l=this.method306(i[(m+1)%a],s[(m+1)%a],i[m],s[m],s[g]),u=i[g];if(this.method307(r,n,l,u,d))return!0;m===(g=(g+1)%a)&&(h=0)}for(;2===h;)if(s[m]<e[c]){if(s[m]<e[p]){let r=this.method306(t[(c+1)%o],e[(c+1)%o],t[c],e[c],s[m]),n=this.method306(t[(p-1+o)%o],e[(p-1+o)%o],t[p],e[p],s[m]),a=i[m];return this.method308(r,n,a,d)}let r=this.method306(t[(c+1)%o],e[(c+1)%o],t[c],e[c],e[p]),n=t[p],l=this.method306(i[(m+1)%a],s[(m+1)%a],i[m],s[m],e[p]),u=this.method306(i[(g-1+a)%a],s[(g-1+a)%a],i[g],s[g],e[p]);if(this.method307(r,n,l,u,d))return!0;c===(p=(p+1)%o)&&(h=0)}else if(e[c]<e[p]){let r=t[c],n=this.method306(t[(p-1+o)%o],e[(p-1+o)%o],t[p],e[p],e[c]),l=this.method306(i[(m+1)%a],s[(m+1)%a],i[m],s[m],e[c]),u=this.method306(i[(g-1+a)%a],s[(g-1+a)%a],i[g],s[g],e[c]);if(this.method307(r,n,l,u,d))return!0;(c=(c-1+o)%o)===p&&(h=0)}else{let r=this.method306(t[(c+1)%o],e[(c+1)%o],t[c],e[c],e[p]),n=t[p],l=this.method306(i[(m+1)%a],s[(m+1)%a],i[m],s[m],e[p]),u=this.method306(i[(g-1+a)%a],s[(g-1+a)%a],i[g],s[g],e[p]);if(this.method307(r,n,l,u,d))return!0;c===(p=(p+1)%o)&&(h=0)}if(e[c]<s[m]){let r=t[c],n=this.method306(i[(m+1)%a],s[(m+1)%a],i[m],s[m],e[c]),o=this.method306(i[(g-1+a)%a],s[(g-1+a)%a],i[g],s[g],e[c]);return this.method308(n,o,r,!d)}let f=this.method306(t[(c+1)%o],e[(c+1)%o],t[c],e[c],s[m]),S=this.method306(t[(p-1+o)%o],e[(p-1+o)%o],t[p],e[p],s[m]),w=i[m];return this.method308(f,S,w,d)}}je.sin2048Cache=new Int32Array(2048),je.frustumMaxX=0,je.frustumMinX=0,je.frustumMaxY=0,je.frustumMinY=0,je.frustumFarZ=0,je.frustumNearZ=0,je.sin512Cache=new Int32Array(512),je.textureCountLoaded=w.fromInt(0),je.aByteArray434=null,Oe=je;var Ne={};const{Utility:_e}=ct,Ue=12345678;class He{constructor(){this.numVertices=0,this.numFaces=0,this.transformState=0,this.visible=!1,this.textureTranslucent=!1,this.transparent=!1,this.isolated=!1,this.unlit=!1,this.unpickable=!1,this.projected=!1,this.autocommit=!1,this.depth=0,this.x1=0,this.x2=0,this.y1=0,this.y2=0,this.z1=0,this.z2=0,this.key=0,this.maxVerts=0,this.lightDiffuse=0,this.lightAmbience=0,this.magic=0,this.maxFaces=0,this.baseX=0,this.baseY=0,this.baseZ=0,this.scaleFx=0,this.scaleFy=0,this.scaleFz=0,this.shearXy=0,this.shearXz=0,this.shearYx=0,this.shearYz=0,this.shearZx=0,this.shearZy=0,this.transformKind=0,this.diameter=0,this.lightDirectionX=0,this.lightDirectionY=0,this.lightDirectionZ=0,this.lightDirectionMagnitude=0,this.dataPtr=0,this.orientationYaw=0,this.orientationPitch=0,this.orientationRoll=0,this.projectVertexX=null,this.projectVertexY=null,this.projectVertexZ=null,this.vertexViewX=null,this.vertexViewY=null,this.vertexIntensity=null,this.vertexAmbience=null,this.faceNumVertices=null,this.faceVertices=null,this.faceFillFront=null,this.faceFillBack=null,this.normalMagnitude=null,this.normalScale=null,this.faceIntensity=null,this.faceNormalX=null,this.faceNormalY=null,this.faceNormalZ=null,this.faceTag=null,this.isLocalPlayer=null,this.vertexX=null,this.vertexY=null,this.vertexZ=null,this.vertexTransformedX=null,this.vertexTransformedY=null,this.vertexTransformedZ=null,this.faceTransStateThing=null,this.faceBoundLeft=null,this.faceBoundRight=null,this.faceBoundBottom=null,this.faceBoundTop=null,this.faceBoundNear=null,this.faceBoundFar=null}static _from2(t,e){let i=new He;i.transformState=1,i.visible=!0,i.textureTranslucent=!1,i.transparent=!1,i.key=-1,i.autocommit=!1,i.isolated=!1,i.unlit=!1,i.unpickable=!1,i.projected=!1,i.magic=Ue,i.diameter=Ue,i.lightDirectionX=180,i.lightDirectionY=155,i.lightDirectionZ=95,i.lightDirectionMagnitude=256,i.lightDiffuse=32,i.lightAmbience=8,i.allocate(t,e),i.faceTransStateThing=[];for(let s=0;s<i.numFaces;s++)i.faceTransStateThing.push(new Int32Array([0]));return i}static _from2A(t,e){let i=new He;return i.transformState=1,i.visible=!0,i.textureTranslucent=!1,i.transparent=!1,i.key=-1,i.autocommit=!1,i.isolated=!1,i.unlit=!1,i.unpickable=!1,i.projected=!1,i.magic=Ue,i.diameter=Ue,i.lightDirectionX=180,i.lightDirectionY=155,i.lightDirectionZ=95,i.lightDirectionMagnitude=256,i.lightDiffuse=32,i.lightAmbience=32,i.merge(t,e,!0),i}static _from3(t,e,i){let s=new He;s.transformState=1,s.visible=!0,s.textureTranslucent=!1,s.transparent=!1,s.key=-1,s.autocommit=!1,s.isolated=!1,s.unlit=!1,s.unpickable=!1,s.projected=!1,s.magic=Ue,s.diameter=Ue,s.lightDirectionX=180,s.lightDirectionY=155,s.lightDirectionZ=95,s.lightDirectionMagnitude=256,s.lightDiffuse=32,s.lightAmbience=32;let r=_e.getUnsignedShort(t,e);e+=2;let n=_e.getUnsignedShort(t,e);e+=2,s.allocate(r,n),s.faceTransStateThing=[],s.faceTransStateThing.length=n;for(let o=0;o<n;o+=1)s.faceTransStateThing[o]=[0];for(let o=0;o<r;o++)s.vertexX[o]=_e.getSignedShort(t,e),e+=2;for(let o=0;o<r;o++)s.vertexY[o]=_e.getSignedShort(t,e),e+=2;for(let o=0;o<r;o++)s.vertexZ[o]=_e.getSignedShort(t,e),e+=2;s.numVertices=r;for(let o=0;o<n;o++)s.faceNumVertices[o]=255&t[e++];for(let o=0;o<n;o++)s.faceFillFront[o]=_e.getSignedShort(t,e),e+=2,32767===s.faceFillFront[o]&&(s.faceFillFront[o]=s.magic);for(let o=0;o<n;o++)s.faceFillBack[o]=_e.getSignedShort(t,e),e+=2,32767===s.faceFillBack[o]&&(s.faceFillBack[o]=s.magic);for(let o=0;o<n;o++){let i=255&t[e++];s.faceIntensity[o]=0===i?0:s.magic}for(let o=0;o<n;o++){s.faceVertices[o]=new Int32Array(s.faceNumVertices[o]);for(let i=0;i<s.faceNumVertices[o];i++)r<256?s.faceVertices[o][i]=255&t[e++]:(s.faceVertices[o][i]=_e.getUnsignedShort(t,e),e+=2)}return s.numFaces=n,s.transformState=1,s}static _from6(t,e,i,s,r,n){let o=new He;return o.transformState=1,o.visible=!0,o.textureTranslucent=!1,o.transparent=!1,o.key=-1,o.projected=!1,o.magic=Ue,o.diameter=Ue,o.lightDirectionX=180,o.lightDirectionY=155,o.lightDirectionZ=95,o.lightDirectionMagnitude=256,o.lightDiffuse=32,o.lightAmbience=32,o.autocommit=i,o.isolated=s,o.unlit=r,o.unpickable=n,o.merge(t,e,!1),o}static _from7(t,e,i,s,r,n,o){let a=new He;return a.transformState=1,a.visible=!0,a.textureTranslucent=!1,a.transparent=!1,a.key=-1,a.magic=Ue,a.diameter=Ue,a.lightDirectionX=180,a.lightDirectionY=155,a.lightDirectionZ=95,a.lightDirectionMagnitude=256,a.lightDiffuse=32,a.lightAmbience=32,a.autocommit=i,a.isolated=s,a.unlit=r,a.unpickable=n,a.projected=o,a.allocate(t,e),a}allocate(t,e){this.vertexX=new Int32Array(t),this.vertexY=new Int32Array(t),this.vertexZ=new Int32Array(t),this.vertexIntensity=new Int32Array(t),this.vertexAmbience=new Int8Array(t),this.faceNumVertices=new Int32Array(e),this.faceVertices=[],this.faceVertices.length=e,this.faceVertices.fill(null),this.faceFillFront=new Int32Array(e),this.faceFillBack=new Int32Array(e),this.faceIntensity=new Int32Array(e),this.normalScale=new Int32Array(e),this.normalMagnitude=new Int32Array(e),this.projected||(this.projectVertexX=new Int32Array(t),this.projectVertexY=new Int32Array(t),this.projectVertexZ=new Int32Array(t),this.vertexViewX=new Int32Array(t),this.vertexViewY=new Int32Array(t)),this.unpickable||(this.isLocalPlayer=new Int8Array(e),this.faceTag=new Int32Array(e)),this.autocommit?(this.vertexTransformedX=this.vertexX,this.vertexTransformedY=this.vertexY,this.vertexTransformedZ=this.vertexZ):(this.vertexTransformedX=new Int32Array(t),this.vertexTransformedY=new Int32Array(t),this.vertexTransformedZ=new Int32Array(t)),this.unlit&&this.isolated||(this.faceNormalX=new Int32Array(e),this.faceNormalY=new Int32Array(e),this.faceNormalZ=new Int32Array(e)),this.isolated||(this.faceBoundLeft=new Int32Array(e),this.faceBoundRight=new Int32Array(e),this.faceBoundBottom=new Int32Array(e),this.faceBoundTop=new Int32Array(e),this.faceBoundNear=new Int32Array(e),this.faceBoundFar=new Int32Array(e)),this.numFaces=0,this.numVertices=0,this.maxVerts=t,this.maxFaces=e,this.baseX=this.baseY=this.baseZ=0,this.orientationYaw=this.orientationPitch=this.orientationRoll=0,this.scaleFx=this.scaleFy=this.scaleFz=256,this.shearXy=this.shearXz=this.shearYx=this.shearYz=this.shearZx=this.shearZy=256,this.transformKind=0}projectionPrepare(){this.projectVertexX=new Int32Array(this.numVertices),this.projectVertexY=new Int32Array(this.numVertices),this.projectVertexZ=new Int32Array(this.numVertices),this.vertexViewX=new Int32Array(this.numVertices),this.vertexViewY=new Int32Array(this.numVertices)}clear(){this.numFaces=0,this.numVertices=0}reduce(t,e){this.numFaces-=t,this.numFaces<0&&(this.numFaces=0),this.numVertices-=e,this.numVertices<0&&(this.numVertices=0)}merge(t,e,i){let s=0,r=0;for(let n=0;n<e;n++)s+=t[n].numFaces,r+=t[n].numVertices;this.allocate(r,s),i&&(this.faceTransStateThing=[],this.faceTransStateThing.length=s);for(let n=0;n<e;n++){let s=t[n];s.commit(),this.lightAmbience=s.lightAmbience,this.lightDiffuse=s.lightDiffuse,this.lightDirectionX=s.lightDirectionX,this.lightDirectionY=s.lightDirectionY,this.lightDirectionZ=s.lightDirectionZ,this.lightDirectionMagnitude=s.lightDirectionMagnitude;for(let t=0;t<s.numFaces;t++){let r=new Int32Array(s.faceNumVertices[t]),o=s.faceVertices[t];for(let e=0;e<s.faceNumVertices[t];e++)r[e]=this.vertexAt(s.vertexX[o[e]],s.vertexY[o[e]],s.vertexZ[o[e]]);let a=this.createFace(s.faceNumVertices[t],r,s.faceFillFront[t],s.faceFillBack[t]);if(this.faceIntensity[a]=s.faceIntensity[t],this.normalScale[a]=s.normalScale[t],this.normalMagnitude[a]=s.normalMagnitude[t],i)if(e>1){this.faceTransStateThing[a]=new Int32Array(s.faceTransStateThing[t].length+1),this.faceTransStateThing[a][0]=n;for(let e=0;e<s.faceTransStateThing[t].length;e++)this.faceTransStateThing[a][e+1]=s.faceTransStateThing[t][e]}else{this.faceTransStateThing[a]=new Int32Array(s.faceTransStateThing[t].length);for(let e=0;e<s.faceTransStateThing[t].length;e++)this.faceTransStateThing[a][e]=s.faceTransStateThing[t][e]}}}this.transformState=1}vertexAt(t,e,i){for(let s=0;s<this.numVertices;s++)if(this.vertexX[s]===t&&this.vertexY[s]===e&&this.vertexZ[s]===i)return s;return this.numVertices>=this.maxVerts?-1:(this.vertexX[this.numVertices]=t,this.vertexY[this.numVertices]=e,this.vertexZ[this.numVertices]=i,this.numVertices++)}createVertex(t,e,i){return this.numVertices>=this.maxVerts?-1:(this.vertexX[this.numVertices]=t,this.vertexY[this.numVertices]=e,this.vertexZ[this.numVertices]=i,this.numVertices++)}createFace(t,e,i,s){return this.numFaces>=this.maxFaces?-1:(this.faceNumVertices[this.numFaces]=t,this.faceVertices[this.numFaces]=e,this.faceFillFront[this.numFaces]=i,this.faceFillBack[this.numFaces]=s,this.transformState=1,this.numFaces++)}split(t,e,i,s,r,n,o,a){this.commit();let h=new Int32Array(n),l=new Int32Array(n);for(let u=0;u<n;u++)h[u]=0,l[u]=0;for(let u=0;u<this.numFaces;u++){let t=0,e=0,n=this.faceNumVertices[u],o=this.faceVertices[u];for(let i=0;i<n;i++)t+=this.vertexX[o[i]],e+=this.vertexZ[o[i]];let a=(t/(n*i)|0)+(e/(n*s)|0)*r;h[a]+=n,l[a]++}let c=[];for(let u=0;u<n;u++)h[u]>o&&(h[u]=o),c.push(He._from7(h[u],l[u],!0,!0,!0,a,!0)),c[u].lightDiffuse=this.lightDiffuse,c[u].lightAmbience=this.lightAmbience;for(let u=0;u<this.numFaces;u++){let t=0,e=0,n=this.faceNumVertices[u],o=this.faceVertices[u];for(let i=0;i<n;i++)t+=this.vertexX[o[i]],e+=this.vertexZ[o[i]];let a=(t/(n*i)|0)+(e/(n*s)|0)*r;this.copyLighting(c[a],o,n,u)}for(let u=0;u<n;u++)c[u].projectionPrepare();return c}copyLighting(t,e,i,s){let r=new Int32Array(i);for(let o=0;o<i;o++){let i=r[o]=t.vertexAt(this.vertexX[e[o]],this.vertexY[e[o]],this.vertexZ[e[o]]);t.vertexIntensity[i]=this.vertexIntensity[e[o]],t.vertexAmbience[i]=this.vertexAmbience[e[o]]}let n=t.createFace(i,r,this.faceFillFront[s],this.faceFillBack[s]);t.unpickable||this.unpickable||(t.faceTag[n]=this.faceTag[s]),t.faceIntensity[n]=this.faceIntensity[s],t.normalScale[n]=this.normalScale[s],t.normalMagnitude[n]=this.normalMagnitude[s]}offsetLightSourceCoords(t,e,i,s,r){this.lightAmbience=256-4*t,this.lightDiffuse=16*(64-e)+128,this.unlit||(this.lightDirectionX=i,this.lightDirectionY=s,this.lightDirectionZ=r,this.lightDirectionMagnitude=0|Math.sqrt(i*i+s*s+r*r),this.light())}createGouraudLightSource(t,e,i,s,r,n){if(this.lightAmbience=256-4*e,this.lightDiffuse=16*(64-i)+128,!this.unlit){for(let e=0;e<this.numFaces;e++)this.faceIntensity[e]=t?this.magic:0;this.lightDirectionX=s,this.lightDirectionY=r,this.lightDirectionZ=n,this.lightDirectionMagnitude=0|Math.sqrt(s*s+r*r+n*n),this.light()}}setLightCoords(t,e,i){this.unlit||(this.lightDirectionX=t,this.lightDirectionY=e,this.lightDirectionZ=i,this.lightDirectionMagnitude=0|Math.sqrt(t*t+e*e+i*i),this.light())}setLight(...t){switch(t.length){case 6:return this.createGouraudLightSource(...t);case 5:return this.offsetLightSourceCoords(...t);case 3:return this.setLightCoords(...t)}}setVertexAmbience(t,e){this.vertexAmbience[t]=255&e}rotate(t,e,i){this.orientationYaw=this.orientationYaw+t&255,this.orientationPitch=this.orientationPitch+e&255,this.orientationRoll=this.orientationRoll+i&255,this.determineTransformKind(),this.transformState=1}orient(t,e,i){this.orientationYaw=255&t,this.orientationPitch=255&e,this.orientationRoll=255&i,this.determineTransformKind(),this.transformState=1}translate(t,e,i){this.baseX+=t,this.baseY+=e,this.baseZ+=i,this.determineTransformKind(),this.transformState=1}place(t,e,i){this.baseX=t,this.baseY=e,this.baseZ=i,this.determineTransformKind(),this.transformState=1}determineTransformKind(){256!==this.shearXy||256!==this.shearXz||256!==this.shearYx||256!==this.shearYz||256!==this.shearZx||256!==this.shearZy?this.transformKind=4:256!==this.scaleFx||256!==this.scaleFy||256!==this.scaleFz?this.transformKind=3:0!==this.orientationYaw||0!==this.orientationPitch||0!==this.orientationRoll?this.transformKind=2:0!==this.baseX||0!==this.baseY||0!==this.baseZ?this.transformKind=1:this.transformKind=0}applyTranslate(t,e,i){for(let s=0;s<this.numVertices;s++)this.vertexTransformedX[s]+=t,this.vertexTransformedY[s]+=e,this.vertexTransformedZ[s]+=i}applyRotation(t,e,i){for(let s=0;s<this.numVertices;s++){if(0!==i){let t=He.sine9[i],e=He.sine9[i+256],r=this.vertexTransformedY[s]*t+this.vertexTransformedX[s]*e>>15;this.vertexTransformedY[s]=this.vertexTransformedY[s]*e-this.vertexTransformedX[s]*t>>15,this.vertexTransformedX[s]=r}if(0!==t){let e=He.sine9[t],i=He.sine9[t+256],r=this.vertexTransformedY[s]*i-this.vertexTransformedZ[s]*e>>15;this.vertexTransformedZ[s]=this.vertexTransformedY[s]*e+this.vertexTransformedZ[s]*i>>15,this.vertexTransformedY[s]=r}if(0!==e){let t=He.sine9[e],i=He.sine9[e+256],r=this.vertexTransformedZ[s]*t+this.vertexTransformedX[s]*i>>15;this.vertexTransformedZ[s]=this.vertexTransformedZ[s]*i-this.vertexTransformedX[s]*t>>15,this.vertexTransformedX[s]=r}}}applyShear(t,e,i,s,r,n){for(let o=0;o<this.numVertices;o++)0!==t&&(this.vertexTransformedX[o]+=this.vertexTransformedY[o]*t>>8),0!==e&&(this.vertexTransformedZ[o]+=this.vertexTransformedY[o]*e>>8),0!==i&&(this.vertexTransformedX[o]+=this.vertexTransformedZ[o]*i>>8),0!==s&&(this.vertexTransformedY[o]+=this.vertexTransformedZ[o]*s>>8),0!==r&&(this.vertexTransformedZ[o]+=this.vertexTransformedX[o]*r>>8),0!==n&&(this.vertexTransformedY[o]+=this.vertexTransformedX[o]*n>>8)}applyScale(t,e,i){for(let s=0;s<this.numVertices;s++)this.vertexTransformedX[s]=this.vertexTransformedX[s]*t>>8,this.vertexTransformedY[s]=this.vertexTransformedY[s]*e>>8,this.vertexTransformedZ[s]=this.vertexTransformedZ[s]*i>>8}computeBounds(){this.x1=this.y1=this.z1=999999,this.diameter=this.x2=this.y2=this.z2=-999999;for(let t=0;t<this.numFaces;t++){let e=this.faceVertices[t],i=e[0],s=this.faceNumVertices[t],r=0,n=r=this.vertexTransformedX[i],o=0,a=o=this.vertexTransformedY[i],h=0,l=h=this.vertexTransformedZ[i];for(let t=0;t<s;t++)i=e[t],this.vertexTransformedX[i]<r?r=this.vertexTransformedX[i]:this.vertexTransformedX[i]>n&&(n=this.vertexTransformedX[i]),this.vertexTransformedY[i]<o?o=this.vertexTransformedY[i]:this.vertexTransformedY[i]>a&&(a=this.vertexTransformedY[i]),this.vertexTransformedZ[i]<h?h=this.vertexTransformedZ[i]:this.vertexTransformedZ[i]>l&&(l=this.vertexTransformedZ[i]);this.isolated||(this.faceBoundLeft[t]=r,this.faceBoundRight[t]=n,this.faceBoundBottom[t]=o,this.faceBoundTop[t]=a,this.faceBoundNear[t]=h,this.faceBoundFar[t]=l),n-r>this.diameter&&(this.diameter=n-r),a-o>this.diameter&&(this.diameter=a-o),l-h>this.diameter&&(this.diameter=l-h),r<this.x1&&(this.x1=r),n>this.x2&&(this.x2=n),o<this.y1&&(this.y1=o),a>this.y2&&(this.y2=a),h<this.z1&&(this.z1=h),l>this.z2&&(this.z2=l)}}light(){if(this.unlit)return;let t=this.lightDiffuse*this.lightDirectionMagnitude>>8;for(let n=0;n<this.numFaces;n++)this.faceIntensity[this.face]!==this.magic&&(this.faceIntensity[this.face]=(this.faceNormalX[n]*this.lightDirectionX+this.faceNormalY[n]*this.lightDirectionY+this.faceNormalZ[n]*this.lightDirectionZ)/t|0);let e=new Int32Array(this.numVertices),i=new Int32Array(this.numVertices),s=new Int32Array(this.numVertices),r=new Int32Array(this.numVertices);for(let n=0;n<this.numVertices;n++)e[n]=0,i[n]=0,s[n]=0,r[n]=0;for(let n=0;n<this.numFaces;n++)if(this.faceIntensity[n]===this.magic)for(let t=0;t<this.faceNumVertices[n];t++){let o=this.faceVertices[n][t];e[o]+=this.faceNormalX[n],i[o]+=this.faceNormalY[n],s[o]+=this.faceNormalZ[n],r[o]++}for(let n=0;n<this.numVertices;n++)r[n]>0&&(this.vertexIntensity[n]=(e[n]*this.lightDirectionX+i[n]*this.lightDirectionY+s[n]*this.lightDirectionZ)/(t*r[n])|0)}relight(){if(!this.unlit||!this.isolated){for(let t=0;t<this.numFaces;t++){let e,i=this.faceVertices[t],s=this.vertexTransformedX[i[0]],r=this.vertexTransformedY[i[0]],n=this.vertexTransformedZ[i[0]],o=this.vertexTransformedX[i[1]]-s,a=this.vertexTransformedY[i[1]]-r,h=this.vertexTransformedZ[i[1]]-n,l=this.vertexTransformedX[i[2]]-s,c=this.vertexTransformedY[i[2]]-r,u=this.vertexTransformedZ[i[2]]-n,m=a*u-c*h,d=h*l-u*o;for(e=o*c-l*a;m>8192||d>8192||e>8192||m<-8192||d<-8192||e<-8192;e>>=1)m>>=1,d>>=1;let p=256*Math.sqrt(m*m+d*d+e*e)|0;p<=0&&(p=1),this.faceNormalX[t]=65536*m/p|0,this.faceNormalY[t]=65536*d/p|0,this.faceNormalZ[t]=65535*e/p|0,this.normalScale[t]=-1}this.light()}}apply(){if(2===this.transformState){this.transformState=0;for(let t=0;t<this.numVertices;t++)this.vertexTransformedX[t]=this.vertexX[t],this.vertexTransformedY[t]=this.vertexY[t],this.vertexTransformedZ[t]=this.vertexZ[t];return this.x1=this.y1=this.z1=-9999999,void(this.diameter=this.x2=this.y2=this.z2=9999999)}if(1===this.transformState){this.transformState=0;for(let t=0;t<this.numVertices;t++)this.vertexTransformedX[t]=this.vertexX[t],this.vertexTransformedY[t]=this.vertexY[t],this.vertexTransformedZ[t]=this.vertexZ[t];this.transformKind>=2&&this.applyRotation(this.orientationYaw,this.orientationPitch,this.orientationRoll),this.transformKind>=3&&this.applyScale(this.scaleFx,this.scaleFy,this.scaleFz),this.transformKind>=4&&this.applyShear(this.shearXy,this.shearXz,this.shearYx,this.shearYz,this.shearZx,this.shearZy),this.transformKind>=1&&this.applyTranslate(this.baseX,this.baseY,this.baseZ),this.computeBounds(),this.relight()}}project(t,e,i,s,r,n,o,a){if(this.apply(),this.z1>Oe.frustumNearZ||this.z2<Oe.frustumFarZ||this.x1>Oe.frustumMinX||this.x2<Oe.frustumMaxX||this.y1>Oe.frustumMinY||this.y2<Oe.frustumMaxY)return void(this.visible=!1);this.visible=!0;let h=0,l=0,c=0,u=0,m=0,d=0;0!==n&&(h=He.sine11[n],l=He.sine11[n+1024]),0!==r&&(m=He.sine11[r],d=He.sine11[r+1024]),0!==s&&(c=He.sine11[s],u=He.sine11[s+1024]);for(let p=0;p<this.numVertices;p++){let g=this.vertexTransformedX[p]-t,f=this.vertexTransformedY[p]-e,S=this.vertexTransformedZ[p]-i;if(0!==n){let t=f*h+g*l>>15;f=f*l-g*h>>15,g=t}if(0!==r){let t=S*m+g*d>>15;S=S*d-g*m>>15,g=t}if(0!==s){let t=f*u-S*c>>15;S=f*c+S*u>>15,f=t}this.vertexViewX[p]=S>=a?(g<<o)/S|0:g<<o,this.vertexViewY[p]=S>=a?(f<<o)/S|0:f<<o,this.projectVertexX[p]=g,this.projectVertexY[p]=f,this.projectVertexZ[p]=S}}commit(){this.apply();for(let t=0;t<this.numVertices;t++)this.vertexX[t]=this.vertexTransformedX[t],this.vertexY[t]=this.vertexTransformedY[t],this.vertexZ[t]=this.vertexTransformedZ[t];this.baseX=this.baseY=this.baseZ=0,this.orientationYaw=this.orientationPitch=this.orientationRoll=0,this.scaleFx=this.scaleFy=this.scaleFz=256,this.shearXy=this.shearXz=this.shearYx=this.shearYz=this.shearZx=this.shearZy=256,this.transformKind=0}copy(...t){if(!t||!t.length){let t=[this],e=He._from2A(t,1);return e.depth=this.depth,e.transparent=this.transparent,e}const[e,i,s,r]=t;let n=[this],o=He._from6(n,1,e,i,s,r);return o.depth=this.depth,o}copyPosition(t){this.orientationYaw=t.orientationYaw,this.orientationPitch=t.orientationPitch,this.orientationRoll=t.orientationRoll,this.baseX=t.baseX,this.baseY=t.baseY,this.baseZ=t.baseZ,this.determineTransformKind(),this.transformState=1}readBase64(t){for(;10===t[this.dataPtr]||13===t[this.dataPtr];this.dataPtr++);let e=4096*He.base64Alphabet[255&t[this.dataPtr++]]+64*He.base64Alphabet[255&t[this.dataPtr++]]+He.base64Alphabet[255&t[this.dataPtr++]]-131072|0;return 123456===e&&(e=this.magic),e}}He.sine9=new Int32Array(512),He.sine11=new Int32Array(2048),He.base64Alphabet=new Int32Array(256);for(let e=0;e<256;e++)He.sine9[e]=32768*Math.sin(.02454369*e)|0,He.sine9[e+256]=32768*Math.cos(.02454369*e)|0;for(let e=0;e<1024;e++)He.sine11[e]=32768*Math.sin(.00613592315*e)|0,He.sine11[e+1024]=32768*Math.cos(.00613592315*e)|0;for(let e=0;e<10;e++)He.base64Alphabet[48+e]=e;for(let e=0;e<26;e++)He.base64Alphabet[65+e]=e+10;for(let e=0;e<26;e++)He.base64Alphabet[97+e]=e+36;He.base64Alphabet[163]=62,He.base64Alphabet[36]=63,Ne=He;var We={};const Fe={TEXT:0,CENTRE_TEXT:1,GRADIENT_BG:2,HORIZ_LINE:3,TEXT_LIST:4,LIST_INPUT:5,TEXT_INPUT:6,HORIZ_OPTION:7,VERT_OPTION:8,I_TEXT_LIST:9,BUTTON:10,ROUND_BOX:11,IMAGE:12,CHECKBOX:14};class Ge{constructor(t,e){this.controlCount=0,this.mouseX=0,this.mouseY=0,this.mouseLastButtonDown=0,this.mouseButtonDown=0,this.mouseMetaButtonHeld=0,this.mouseScrollDelta=0,this.focusControlIndex=-1,this.aBoolean219=!0,this.surface=t,this.maxControls=e,this.controlShown=new Int8Array(e),this.controlListScrollbarHandleDragged=new Int8Array(e),this.controlMaskText=new Int8Array(e),this.controlClicked=new Int8Array(e),this.controlUseAlternativeColour=new Int8Array(e),this.controlFlashText=new Int32Array(e),this.controlListEntryCount=new Int32Array(e),this.controlListEntryMouseButtonDown=new Int32Array(e),this.controlListEntryMouseOver=new Int32Array(e),this.controlX=new Int32Array(e),this.controlY=new Int32Array(e),this.controlType=new Int32Array(e),this.controlWidth=new Int32Array(e),this.controlHeight=new Int32Array(e),this.controlInputMaxLen=new Int32Array(e),this.controlTextSize=new Int32Array(e),this.controlText=[],this.controlText.length=e,this.controlListEntries=[];for(let i=0;i<e;i+=1)this.controlListEntries.push([]);this.colourScrollbarTop=this.rgbToLongMod(114,114,176),this.colourScrollbarBottom=this.rgbToLongMod(14,14,62),this.colourScrollbarHandleLeft=this.rgbToLongMod(200,208,232),this.colourScrollbarHandleMid=this.rgbToLongMod(96,129,184),this.colourScrollbarHandleRight=this.rgbToLongMod(53,95,115),this.colourRoundedBoxOut=this.rgbToLongMod(117,142,171),this.colourRoundedBoxMid=this.rgbToLongMod(98,122,158),this.colourRoundedBoxIn=this.rgbToLongMod(86,100,136),this.colourBoxTopNBottom=this.rgbToLongMod(135,146,179),this.colourBoxTopNBottom2=this.rgbToLongMod(97,112,151),this.colourBoxLeftNRight2=this.rgbToLongMod(88,102,136),this.colourBoxLeftNRight=this.rgbToLongMod(84,93,120)}rgbToLongMod(t,e,i){return gt.rgbToLong(Ge.redMod*t/114|0,Ge.greenMod*e/114|0,Ge.blueMod*i/176|0)}handleMouse(t,e,i,s,r=0){if(this.mouseX=t,this.mouseY=e,this.mouseButtonDown=s,this.mouseScrollDelta=r,0!==i&&(this.mouseLastButtonDown=i),1===i)for(let n=0;n<this.controlCount;n++)this.controlShown[n]&&this.controlType[n]===Fe.BUTTON&&this.mouseX>=this.controlX[n]&&this.mouseY>=this.controlY[n]&&this.mouseX<=this.controlX[n]+this.controlWidth[n]&&this.mouseY<=this.controlY[n]+this.controlHeight[n]&&(this.controlClicked[n]=!0),this.controlShown[n]&&this.controlType[n]===Fe.CHECKBOX&&this.mouseX>=this.controlX[n]&&this.mouseY>=this.controlY[n]&&this.mouseX<=this.controlX[n]+this.controlWidth[n]&&this.mouseY<=this.controlY[n]+this.controlHeight[n]&&(this.controlListEntryMouseButtonDown[n]=1-this.controlListEntryMouseButtonDown[n]);if(1===s?this.mouseMetaButtonHeld++:this.mouseMetaButtonHeld=0,1===i||this.mouseMetaButtonHeld>20){for(let t=0;t<this.controlCount;t++)this.controlShown[t]&&15===this.controlType[t]&&this.mouseX>=this.controlX[t]&&this.mouseY>=this.controlY[t]&&this.mouseX<=this.controlX[t]+this.controlWidth[t]&&this.mouseY<=this.controlY[t]+this.controlHeight[t]&&(this.controlClicked[t]=!0);this.mouseMetaButtonHeld-=5}}isClicked(t){return!(!this.controlShown[t]||!this.controlClicked[t]||(this.controlClicked[t]=!1,0))}keyPress(t,e){if(-1!==this.focusControlIndex&&null!==this.controlText[this.focusControlIndex]&&this.controlShown[this.focusControlIndex]){let i=this.controlText[this.focusControlIndex].length;if(8===t)return void(this.controlText[this.focusControlIndex]=this.controlText[this.focusControlIndex].slice(0,i-1));if(13===t||10===t)return void(this.controlClicked[this.focusControlIndex]=!0);if(9===t){do{this.focusControlIndex=(this.focusControlIndex+1)%this.controlCount}while(5!==this.controlType[this.focusControlIndex]&&6!==this.controlType[this.focusControlIndex]);return}if(i<this.controlInputMaxLen[this.focusControlIndex]){if(e.length>1)return void console.log(e+" ignored in panel!");this.controlText[this.focusControlIndex]+=e}}}render(){for(let t=0;t<this.controlCount;t++)this.controlShown[t]&&(this.controlType[t]===Fe.TEXT?this.drawText(t,this.controlX[t],this.controlY[t],this.controlText[t],this.controlTextSize[t]):this.controlType[t]===Fe.CENTRE_TEXT?this.drawText(t,this.controlX[t]-(this.surface.textWidth(this.controlText[t],this.controlTextSize[t])/2|0),this.controlY[t],this.controlText[t],this.controlTextSize[t]):this.controlType[t]===Fe.GRADIENT_BG?this.drawBox(this.controlX[t],this.controlY[t],this.controlWidth[t],this.controlHeight[t]):this.controlType[t]===Fe.HORIZ_LINE?this.drawLineHoriz(this.controlX[t],this.controlY[t],this.controlWidth[t]):this.controlType[t]===Fe.TEXT_LIST?this.drawTextList(t,this.controlX[t],this.controlY[t],this.controlWidth[t],this.controlHeight[t],this.controlTextSize[t],this.controlListEntries[t],this.controlListEntryCount[t],this.controlFlashText[t]):this.controlType[t]===Fe.LIST_INPUT||this.controlType[t]===Fe.TEXT_INPUT?this.drawTextInput(t,this.controlX[t],this.controlY[t],this.controlWidth[t],this.controlHeight[t],this.controlText[t],this.controlTextSize[t]):this.controlType[t]===Fe.HORIZ_OPTION?this.drawOptionListHoriz(t,this.controlX[t],this.controlY[t],this.controlTextSize[t],this.controlListEntries[t]):this.controlType[t]===Fe.VERT_OPTION?this.drawOptionListVert(t,this.controlX[t],this.controlY[t],this.controlTextSize[t],this.controlListEntries[t]):this.controlType[t]===Fe.I_TEXT_LIST?this.drawTextListInteractive(t,this.controlX[t],this.controlY[t],this.controlWidth[t],this.controlHeight[t],this.controlTextSize[t],this.controlListEntries[t],this.controlListEntryCount[t],this.controlFlashText[t]):this.controlType[t]===Fe.ROUND_BOX?this.drawRoundedBox(this.controlX[t],this.controlY[t],this.controlWidth[t],this.controlHeight[t]):this.controlType[t]===Fe.IMAGE?this.drawPicture(this.controlX[t],this.controlY[t],this.controlTextSize[t]):this.controlType[t]===Fe.CHECKBOX&&this.drawCheckbox(t,this.controlX[t],this.controlY[t],this.controlWidth[t],this.controlHeight[t]));this.mouseLastButtonDown=0}drawCheckbox(t,e,i,s,r){if(this.surface.drawBox(e,i,s,r,16777215),this.surface.drawLineHoriz(e,i,s,this.colourBoxTopNBottom),this.surface.drawLineVert(e,i,r,this.colourBoxTopNBottom),this.surface.drawLineHoriz(e,i+r-1,s,this.colourBoxLeftNRight),this.surface.drawLineVert(e+s-1,i,r,this.colourBoxLeftNRight),1===this.controlListEntryMouseButtonDown[t])for(let n=0;n<r;n++)this.surface.drawLineHoriz(e+n,i+n,1,0),this.surface.drawLineHoriz(e+s-1-n,i+n,1,0)}drawText(t,e,i,s,r){let n=i+(this.surface.textHeight(r)/3|0);this.drawString(t,e,n,s,r)}drawString(t,e,i,s,r){let n;n=this.controlUseAlternativeColour[t]?16777215:0,this.surface.drawString(s,e,i,r,n)}drawTextInput(t,e,i,s,r,n,o){if(this.controlMaskText[t]){let t=n.length;n="";for(let e=0;e<t;e++)n+="X"}this.controlType[t]===Fe.LIST_INPUT?1===this.mouseLastButtonDown&&this.mouseX>=e&&this.mouseY>=i-(r/2|0)&&this.mouseX<=e+s&&this.mouseY<=i+(r/2|0)&&(this.focusControlIndex=t):this.controlType[t]===Fe.TEXT_INPUT&&(1===this.mouseLastButtonDown&&this.mouseX>=e-(s/2|0)&&this.mouseY>=i-(r/2|0)&&this.mouseX<=e+s/2&&this.mouseY<=i+(r/2|0)&&(this.focusControlIndex=t),e-=this.surface.textWidth(n,o)/2|0),this.focusControlIndex===t&&(n+="*");let a=i+(this.surface.textHeight(o)/3|0);this.drawString(t,e,a,n,o)}drawBox(t,e,i,s){if(this.surface.setBounds(t,e,t+i,e+s),this.surface.drawGradient(t,e,i,s,this.colourBoxLeftNRight,this.colourBoxTopNBottom),Ge.drawBackgroundArrow)for(let r=t-(63&e);r<t+i;r+=128)for(let t=e-(31&e);t<e+s;t+=128)this.surface.drawSpriteAlpha(r,t,6+Ge.baseSpriteStart,128);this.surface.drawLineHoriz(t,e,i,this.colourBoxTopNBottom),this.surface.drawLineHoriz(t+1,e+1,i-2,this.colourBoxTopNBottom),this.surface.drawLineHoriz(t+2,e+2,i-4,this.colourBoxTopNBottom2),this.surface.drawLineVert(t,e,s,this.colourBoxTopNBottom),this.surface.drawLineVert(t+1,e+1,s-2,this.colourBoxTopNBottom),this.surface.drawLineVert(t+2,e+2,s-4,this.colourBoxTopNBottom2),this.surface.drawLineHoriz(t,e+s-1,i,this.colourBoxLeftNRight),this.surface.drawLineHoriz(t+1,e+s-2,i-2,this.colourBoxLeftNRight),this.surface.drawLineHoriz(t+2,e+s-3,i-4,this.colourBoxLeftNRight2),this.surface.drawLineVert(t+i-1,e,s,this.colourBoxLeftNRight),this.surface.drawLineVert(t+i-2,e+1,s-2,this.colourBoxLeftNRight),this.surface.drawLineVert(t+i-3,e+2,s-4,this.colourBoxLeftNRight2),this.surface.resetBounds()}drawRoundedBox(t,e,i,s){this.surface.drawBox(t,e,i,s,0),this.surface.drawBoxEdge(t,e,i,s,this.colourRoundedBoxOut),this.surface.drawBoxEdge(t+1,e+1,i-2,s-2,this.colourRoundedBoxMid),this.surface.drawBoxEdge(t+2,e+2,i-4,s-4,this.colourRoundedBoxIn),this.surface.drawSpriteID(t,e,2+Ge.baseSpriteStart),this.surface.drawSpriteID(t+i-7,e,3+Ge.baseSpriteStart),this.surface.drawSpriteID(t,e+s-7,4+Ge.baseSpriteStart),this.surface.drawSpriteID(t+i-7,e+s-7,5+Ge.baseSpriteStart)}drawPicture(t,e,i){this.surface.drawSpriteID(t,e,i)}drawLineHoriz(t,e,i){this.surface.drawLineHoriz(t,e,i,16777215)}drawTextList(t,e,i,s,r,n,o,a,h){let l=r/this.surface.textHeight(n)|0,c=a-l;if(h>c&&(h=c),h<0&&(h=0),this.controlFlashText[t]=h,l<a){let n=e+s-12,o=(r-27)*l/a|0;o<6&&(o=6);let u=(r-27-o)*h/c|0;0!==this.mouseScrollDelta&&this.mouseX>e&&this.mouseX<e+s&&this.mouseY>i&&this.mouseY<i+r&&((h+=this.mouseScrollDelta)<0?h=0:h>c&&(h=c),this.controlFlashText[t]=h),1===this.mouseButtonDown&&this.mouseX>=n&&this.mouseX<=n+12&&(this.mouseY>i&&this.mouseY<i+12&&h>0&&h--,this.mouseY>i+r-12&&this.mouseY<i+r&&h<a-l&&h++,this.controlFlashText[t]=h),1===this.mouseButtonDown&&(this.mouseX>=n&&this.mouseX<=n+12||this.mouseX>=n-12&&this.mouseX<=n+24&&this.controlListScrollbarHandleDragged[t])?this.mouseY>i+12&&this.mouseY<i+r-12&&(this.controlListScrollbarHandleDragged[t]=!0,(h=(this.mouseY-i-12-(o/2|0))*a/(r-24)|0)>c&&(h=c),h<0&&(h=0),this.controlFlashText[t]=h):this.controlListScrollbarHandleDragged[t]=!1,u=(r-27-o)*h/(a-l)|0,this.drawListContainer(e,i,s,r,u,o)}let u=r-l*this.surface.textHeight(n),m=i+(5*this.surface.textHeight(n)/6+u/2)|0;for(let d=h;d<a;d++)if(this.drawString(t,e+2,m,o[d],n),(m+=this.surface.textHeight(n)-Ge.textListEntryHeightMod)>=i+r)return}drawListContainer(t,e,i,s,r,n){let o=t+i-12;this.surface.drawBoxEdge(o,e,12,s,0),this.surface.drawSpriteID(o+1,e+1,Ge.baseSpriteStart),this.surface.drawSpriteID(o+1,e+s-12,1+Ge.baseSpriteStart),this.surface.drawLineHoriz(o,e+13,12,0),this.surface.drawLineHoriz(o,e+s-13,12,0),this.surface.drawGradient(o+1,e+14,11,s-27,this.colourScrollbarTop,this.colourScrollbarBottom),this.surface.drawBox(o+3,r+e+14,7,n,this.colourScrollbarHandleMid),this.surface.drawLineVert(o+2,r+e+14,n,this.colourScrollbarHandleLeft),this.surface.drawLineVert(o+2+8,r+e+14,n,this.colourScrollbarHandleRight)}drawOptionListHoriz(t,e,i,s,r){let n=0,o=r.length;for(let l=0;l<o;l++)n+=this.surface.textWidth(r[l],s),l<o-1&&(n+=this.surface.textWidth("  ",s));let a=e-(n/2|0),h=i+(this.surface.textHeight(s)/3|0);for(let l=0;l<o;l++){let e;e=this.controlUseAlternativeColour[t]?16777215:0,this.mouseX>=a&&this.mouseX<=a+this.surface.textWidth(r[l],s)&&this.mouseY<=h&&this.mouseY>h-this.surface.textHeight(s)&&(e=this.controlUseAlternativeColour[t]?8421504:16777215,1===this.mouseLastButtonDown&&(this.controlListEntryMouseButtonDown[t]=l,this.controlClicked[t]=!0)),this.controlListEntryMouseButtonDown[t]===l&&(e=this.controlUseAlternativeColour[t]?16711680:12582912),this.surface.drawString(r[l],a,h,s,e),a+=this.surface.textWidth(r[l]+"  ",s)}}drawOptionListVert(t,e,i,s,r){let n=r.length,o=i-(this.surface.textHeight(s)*(n-1)/2|0);for(let a=0;a<n;a++){let i;i=this.controlUseAlternativeColour[t]?16777215:0;let n=this.surface.textWidth(r[a],s);this.mouseX>=e-(n/2|0)&&this.mouseX<=e+(n/2|0)&&this.mouseY-2<=o&&this.mouseY-2>o-this.surface.textHeight(s)&&(i=this.controlUseAlternativeColour[t]?8421504:16777215,1===this.mouseLastButtonDown&&(this.controlListEntryMouseButtonDown[t]=a,this.controlClicked[t]=!0)),this.controlListEntryMouseButtonDown[t]===a&&(i=this.controlUseAlternativeColour[t]?16711680:12582912),this.surface.drawString(r[a],e-(n/2|0),o,s,i),o+=this.surface.textHeight(s)}}drawTextListInteractive(t,e,i,s,r,n,o,a,h){let l=r/this.surface.textHeight(n)|0,c=a-l;if(l<a){let n=e+s-12,o=(r-27)*l/a|0;o<6&&(o=6);let u=(r-27-o)*h/c|0;0!==this.mouseScrollDelta&&this.mouseX>e&&this.mouseX<e+s&&this.mouseY>i&&this.mouseY<i+r&&((h+=this.mouseScrollDelta)<0?h=0:h>c&&(h=c),this.controlFlashText[t]=h),1===this.mouseButtonDown&&this.mouseX>=n&&this.mouseX<=n+12&&(this.mouseY>i&&this.mouseY<i+12&&h>0&&h--,this.mouseY>i+r-12&&this.mouseY<i+r&&h<c&&h++,this.controlFlashText[t]=h),1===this.mouseButtonDown&&(this.mouseX>=n&&this.mouseX<=n+12||this.mouseX>=n-12&&this.mouseX<=n+24&&this.controlListScrollbarHandleDragged[t])?this.mouseY>i+12&&this.mouseY<i+r-12&&(this.controlListScrollbarHandleDragged[t]=!0,(h=(this.mouseY-i-12-(o/2|0))*a/(r-24)|0)<0&&(h=0),h>c&&(h=c),this.controlFlashText[t]=h):this.controlListScrollbarHandleDragged[t]=!1,u=(r-27-o)*h/c|0,this.drawListContainer(e,i,s,r,u,o)}else h=0,this.controlFlashText[t]=0;this.controlListEntryMouseOver[t]=-1;let u=r-l*this.surface.textHeight(n),m=i+((5*this.surface.textHeight(n)/6|0)+u/2|0);for(let d=h;d<a;d++){let s;if(s=this.controlUseAlternativeColour[t]?16777215:0,this.mouseX>=e+2&&this.mouseX<=e+2+this.surface.textWidth(o[d],n)&&this.mouseY-2<=m&&this.mouseY-2>m-this.surface.textHeight(n)&&(s=this.controlUseAlternativeColour[t]?8421504:16777215,this.controlListEntryMouseOver[t]=d,1===this.mouseLastButtonDown&&(this.controlListEntryMouseButtonDown[t]=d,this.controlClicked[t]=!0)),this.controlListEntryMouseButtonDown[t]===d&&this.aBoolean219&&(s=16711680),this.surface.drawString(o[d],e+2,m,n,s),(m+=this.surface.textHeight(n))>=i+r)return}}toggleCheckbox(t,e){this.controlListEntryMouseButtonDown[t]=e?1:0}isActivated(t){return 0!==this.controlListEntryMouseButtonDown[t]}addString(t,e,i,s,r){return this.controlType[this.controlCount]=Fe.TEXT,this.controlShown[this.controlCount]=!0,this.controlClicked[this.controlCount]=!1,this.controlTextSize[this.controlCount]=s,this.controlUseAlternativeColour[this.controlCount]=r,this.controlX[this.controlCount]=t,this.controlY[this.controlCount]=e,this.controlText[this.controlCount]=i,this.controlCount++}addText(t,e,i,s,r){return this.controlType[this.controlCount]=1,this.controlShown[this.controlCount]=!0,this.controlClicked[this.controlCount]=!1,this.controlTextSize[this.controlCount]=s,this.controlUseAlternativeColour[this.controlCount]=r,this.controlX[this.controlCount]=t,this.controlY[this.controlCount]=e,this.controlText[this.controlCount]=i,this.controlCount++}addButtonBackground(t,e,i,s){return this.controlType[this.controlCount]=2,this.controlShown[this.controlCount]=!0,this.controlClicked[this.controlCount]=!1,this.controlX[this.controlCount]=t-(i/2|0),this.controlY[this.controlCount]=e-(s/2|0),this.controlWidth[this.controlCount]=i,this.controlHeight[this.controlCount]=s,this.controlCount++}addBoxRounded(t,e,i,s){return this.controlType[this.controlCount]=11,this.controlShown[this.controlCount]=!0,this.controlClicked[this.controlCount]=!1,this.controlX[this.controlCount]=t-(i/2|0),this.controlY[this.controlCount]=e-(s/2|0),this.controlWidth[this.controlCount]=i,this.controlHeight[this.controlCount]=s,this.controlCount++}addSprite(t,e,i){let s=this.surface.spriteWidth[i],r=this.surface.spriteHeight[i];return this.controlType[this.controlCount]=Fe.IMAGE,this.controlShown[this.controlCount]=!0,this.controlClicked[this.controlCount]=!1,this.controlX[this.controlCount]=t-(s/2|0),this.controlY[this.controlCount]=e-(r/2|0),this.controlWidth[this.controlCount]=s,this.controlHeight[this.controlCount]=r,this.controlTextSize[this.controlCount]=i,this.controlCount++}addTextList(t,e,i,s,r,n,o){return this.controlType[this.controlCount]=Fe.TEXT_LIST,this.controlShown[this.controlCount]=!0,this.controlClicked[this.controlCount]=!1,this.controlX[this.controlCount]=t,this.controlY[this.controlCount]=e,this.controlWidth[this.controlCount]=i,this.controlHeight[this.controlCount]=s,this.controlUseAlternativeColour[this.controlCount]=o,this.controlTextSize[this.controlCount]=r,this.controlInputMaxLen[this.controlCount]=n,this.controlListEntryCount[this.controlCount]=0,this.controlFlashText[this.controlCount]=0,this.controlListEntries[this.controlCount]=[],this.controlListEntries[this.controlCount].length=n,this.controlListEntries[this.controlCount].fill(null),this.controlCount++}addTextListInput(t,e,i,s,r,n,o,a){return this.controlType[this.controlCount]=Fe.LIST_INPUT,this.controlShown[this.controlCount]=!0,this.controlMaskText[this.controlCount]=o,this.controlClicked[this.controlCount]=!1,this.controlTextSize[this.controlCount]=r,this.controlUseAlternativeColour[this.controlCount]=a,this.controlX[this.controlCount]=t,this.controlY[this.controlCount]=e,this.controlWidth[this.controlCount]=i,this.controlHeight[this.controlCount]=s,this.controlInputMaxLen[this.controlCount]=n,this.controlText[this.controlCount]="",this.controlCount++}addTextInput(t,e,i,s,r,n,o,a){return this.controlType[this.controlCount]=Fe.TEXT_INPUT,this.controlShown[this.controlCount]=!0,this.controlMaskText[this.controlCount]=o,this.controlClicked[this.controlCount]=!1,this.controlTextSize[this.controlCount]=r,this.controlUseAlternativeColour[this.controlCount]=a,this.controlX[this.controlCount]=t,this.controlY[this.controlCount]=e,this.controlWidth[this.controlCount]=i,this.controlHeight[this.controlCount]=s,this.controlInputMaxLen[this.controlCount]=n,this.controlText[this.controlCount]="",this.controlCount++}addTextListInteractive(t,e,i,s,r,n,o){return this.controlType[this.controlCount]=Fe.I_TEXT_LIST,this.controlShown[this.controlCount]=!0,this.controlClicked[this.controlCount]=!1,this.controlTextSize[this.controlCount]=r,this.controlUseAlternativeColour[this.controlCount]=o,this.controlX[this.controlCount]=t,this.controlY[this.controlCount]=e,this.controlWidth[this.controlCount]=i,this.controlHeight[this.controlCount]=s,this.controlInputMaxLen[this.controlCount]=n,this.controlListEntries[this.controlCount]=[],this.controlListEntries[this.controlCount].length=n,this.controlListEntries[this.controlCount].fill(null),this.controlListEntryCount[this.controlCount]=0,this.controlFlashText[this.controlCount]=0,this.controlListEntryMouseButtonDown[this.controlCount]=-1,this.controlListEntryMouseOver[this.controlCount]=-1,this.controlCount++}addButton(t,e,i,s){return this.controlType[this.controlCount]=Fe.BUTTON,this.controlShown[this.controlCount]=!0,this.controlClicked[this.controlCount]=!1,this.controlX[this.controlCount]=t-(i/2|0),this.controlY[this.controlCount]=e-(s/2|0),this.controlWidth[this.controlCount]=i,this.controlHeight[this.controlCount]=s,this.controlCount++}addLineHoriz(t,e,i){return this.controlType[this.controlCount]=Fe.HORIZ_LINE,this.controlShown[this.controlCount]=!0,this.controlX[this.controlCount]=t,this.controlY[this.controlCount]=e,this.controlWidth[this.controlCount]=i,this.controlCount++}addOptionListHoriz(t,e,i,s,r){return this.controlType[this.controlCount]=Fe.HORIZ_OPTION,this.controlShown[this.controlCount]=!0,this.controlX[this.controlCount]=t,this.controlY[this.controlCount]=e,this.controlTextSize[this.controlCount]=i,this.controlListEntries[this.controlCount]=[],this.controlListEntries[this.controlCount].length=s,this.controlListEntries[this.controlCount].fill(null),this.controlListEntryCount[this.controlCount]=0,this.controlUseAlternativeColour[this.controlCount]=r,this.controlClicked[this.controlCount]=!1,this.controlCount++}addOptionListVert(t,e,i,s,r){return this.controlType[this.controlCount]=Fe.VERT_OPTION,this.controlShown[this.controlCount]=!0,this.controlX[this.controlCount]=t,this.controlY[this.controlCount]=e,this.controlTextSize[this.controlCount]=i,this.controlListEntries[this.controlCount]=[],this.controlListEntries[this.controlCount].length=s,this.controlListEntries[this.controlCount].fill(null),this.controlListEntryCount[this.controlCount]=0,this.controlUseAlternativeColour[this.controlCount]=r,this.controlClicked[this.controlCount]=!1,this.controlCount++}addCheckbox(t,e,i,s){return this.controlType[this.controlCount]=Fe.CHECKBOX,this.controlShown[this.controlCount]=!0,this.controlX[this.controlCount]=t,this.controlY[this.controlCount]=e,this.controlWidth[this.controlCount]=i,this.controlHeight[this.controlCount]=s,this.controlListEntryMouseButtonDown[this.controlCount]=0,this.controlCount++}clearList(t){this.controlListEntryCount[t]=0}resetListProps(t){this.controlFlashText[t]=0,this.controlListEntryMouseOver[t]=-1}addListEntry(t,e,i){this.controlListEntries[t][e]=i,e+1>this.controlListEntryCount[t]&&(this.controlListEntryCount[t]=e+1)}removeListEntry(t,e,i){let s=this.controlListEntryCount[t]++;if(s>=this.controlInputMaxLen[t]){s--,this.controlListEntryCount[t]--;for(let e=0;e<s;e++)this.controlListEntries[t][e]=this.controlListEntries[t][e+1]}this.controlListEntries[t][s]=e,i&&(this.controlFlashText[t]=999999)}updateText(t,e){this.controlText[t]=e}getText(t){return null===this.controlText[t]?"null":this.controlText[t]}show(t){this.controlShown[t]=!0}hide(t){this.controlShown[t]=!1}setFocus(t){this.focusControlIndex=t}getListEntryIndex(t){return this.controlListEntryMouseOver[t]}}Ge.drawBackgroundArrow=!0,Ge.baseSpriteStart=0,Ge.redMod=114,Ge.greenMod=114,Ge.blueMod=176,Ge.textListEntryHeightMod=0,We=Ge;var Ve={};function ze(t){this.init(t)}ze.prototype.init=function(t){this.option=Object.assign({},{encoding:"16bitInt",channels:1,sampleRate:8e3,flushingTime:1e3},t),this.samples=new Float32Array,this.flush=this.flush.bind(this),this.interval=setInterval(this.flush,this.option.flushingTime),this.maxValue=this.getMaxValue(),this.typedArray=this.getTypedArray(),this.createContext()},ze.prototype.getMaxValue=function(){var t={"8bitInt":128,"16bitInt":32768,"32bitInt":2147483648,"32bitFloat":1};return t[this.option.encoding]?t[this.option.encoding]:t["16bitInt"]},ze.prototype.getTypedArray=function(){var t={"8bitInt":Int8Array,"16bitInt":Int16Array,"32bitInt":Int32Array,"32bitFloat":Float32Array};return t[this.option.encoding]?t[this.option.encoding]:t["16bitInt"]},ze.prototype.createContext=function(){this.audioCtx=new(window.AudioContext||window.webkitAudioContext),this.gainNode=this.audioCtx.createGain(),this.gainNode.gain.value=1,this.gainNode.connect(this.audioCtx.destination),this.startTime=this.audioCtx.currentTime},ze.prototype.isTypedArray=function(t){return t.byteLength&&t.buffer&&t.buffer.constructor==ArrayBuffer},ze.prototype.feed=function(t){if(this.isTypedArray(t)){t=this.getFormatedValue(t);var e=new Float32Array(this.samples.length+t.length);e.set(this.samples,0),e.set(t,this.samples.length),this.samples=e}},ze.prototype.getFormatedValue=function(t){t=new this.typedArray(t.buffer);var e,i=new Float32Array(t.length);for(e=0;e<t.length;e++)i[e]=t[e]/this.maxValue;return i},ze.prototype.volume=function(t){this.gainNode.gain.value=t},ze.prototype.destroy=function(){this.interval&&clearInterval(this.interval),this.samples=null,this.audioCtx.close(),this.audioCtx=null},ze.prototype.flush=function(){if(this.samples.length){var t,e,i,s,r,n=this.audioCtx.createBufferSource(),o=this.samples.length/this.option.channels,a=this.audioCtx.createBuffer(this.option.channels,o,this.option.sampleRate);for(e=0;e<this.option.channels;e++)for(t=a.getChannelData(e),i=e,r=50,s=0;s<o;s++)t[s]=this.samples[i],s<50&&(t[s]=t[s]*s/50),o-51<=s&&(t[s]=t[s]*r--/50),i+=this.option.channels;this.startTime<this.audioCtx.currentTime&&(this.startTime=this.audioCtx.currentTime),console.log("start vs current "+this.startTime+" vs "+this.audioCtx.currentTime+" duration: "+a.duration),n.buffer=a,n.connect(this.gainNode),n.start(this.startTime),this.startTime+=a.duration,this.samples=new Float32Array}},Ve=ze;var Ze,qe={exports:{}};Ze=function(t){Object.defineProperty(t,"__esModule",{value:!0});var e=function(t){var e=[1,1,2,2,3,3,3,3,4,4,4,4,4,4,4,4,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7];function i(t){var i,s=~(t=-32768==t?-32767:t)>>8&128;if(s||(t*=-1),t>32635&&(t=32635),t>=256){var r=e[t>>8&127];i=r<<4|t>>r+3&15}else i=t>>4;return 85^i^s}function s(t){var e=0;128&(t^=85)&&(t&=-129,e=-1);var i=4+((240&t)>>4),s=0;return s=4!=i?1<<i|(15&t)<<i-4|1<<i-5:t<<1|1,8*(s=0===e?s:-s)*-1}Object.freeze({encodeSample:i,decodeSample:s,encode:function(t){for(var e=new Uint8Array(t.length),s=0;s<t.length;s++)e[s]=i(t[s]);return e},decode:function(t){for(var e=new Int16Array(t.length),i=0;i<t.length;i++)e[i]=s(t[i]);return e}});var r=132,n=32635,o=[0,0,1,1,2,2,2,2,3,3,3,3,3,3,3,3,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7],a=[0,132,396,924,1980,4092,8316,16764];function h(t){var e,i;return 0!=(e=t>>8&128)&&(t=-t),t>n&&(t=n),~(e|(i=o[(t+=r)>>7&255])<<4|t>>i+3&15)}function l(t){var e,i,s,r;return e=128&(t=~t),s=15&t,r=a[i=t>>4&7]+(s<<i+3),0!=e&&(r=-r),r}var c=Object.freeze({encodeSample:h,decodeSample:l,encode:function(t){for(var e=new Uint8Array(t.length),i=0;i<t.length;i++)e[i]=h(t[i]);return e},decode:function(t){for(var e=new Int16Array(t.length),i=0;i<t.length;i++)e[i]=l(t[i]);return e}});return t.mulaw=c,t}({});e.alaw,t.mulaw=e.mulaw},"object"==typeof qe.exports?Ze(qe.exports):"function"==typeof define&&define.amd?define(["exports"],Ze):Ze(this.alawmulaw={}),qe=qe.exports;const{mulaw:Ke}=qe;var Qe=class{constructor(){this.player=new Ve({encoding:"16bitInt",channels:1,sampleRate:8e3})}stopPlayer(){this.player.destroy()}writeStream(t,e,i){const s=Ke.decode(new Uint8Array(t.slice(e,e+i)));this.player.feed(s)}},$e=class extends gt{constructor(t,e,i,s){super(t,e,i,s),this.mudclientref=null}_spriteClipping_from7(t,e,i,s,r,n,o){if(r>=5e4)this.mudclientref.drawTeleportBubble(t,e,i,s,r-5e4,n,o);else if(r>=4e4)this.mudclientref.drawItem(t,e,i,s,r-4e4,n,o);else{if(!(r>=2e4))return r>=5e3?void this.mudclientref.drawPlayer(t,e,i,s,r-5e3,n,o):void super._spriteClipping_from5(t,e,i,s,r);this.mudclientref.drawNpc(t,e,i,s,r-2e4,n,o)}}},Je={};const{Utility:ti}=ct,ei=48e3;class ii{constructor(t,e){this.regionWidth=96,this.regionHeight=96,this.tileSize=128,this.parentModel=null,this.landscapePack=null,this.mapPack=null,this.memberLandscapePack=null,this.memberMapPack=null,this.worldInitialised=!0,this.objectAdjacency=Pe(new Int32Array(this.regionWidth*this.regionHeight),[this.regionWidth,this.regionHeight]),this.tileDirection=Pe(new Int8Array(9216),[4,2304]),this.wallModels=[],this.roofModels=[];for(let i=0;i<4;i+=1){this.wallModels.push([]),this.roofModels.push([]);for(let t=0;t<64;t+=1)this.wallModels[i].push(null),this.roofModels[i].push(null)}this.terrainColours=new Int32Array(256),this.wallsNorthSouth=Pe(new Int8Array(9216),[4,2304]),this.wallsRoof=Pe(new Int8Array(9216),[4,2304]),this.terrainHeight=Pe(new Int8Array(9216),[4,2304]),this.terrainColour=Pe(new Int8Array(9216),[4,2304]),this.localY=new Int32Array(18432),this.tileDecoration=Pe(new Int8Array(9216),[4,2304]),this.routeVia=Pe(new Int32Array(this.regionWidth*this.regionHeight),[this.regionWidth,this.regionHeight]),this.wallsDiagonal=Pe(new Int32Array(9216),[4,2304]),this.wallsEastWest=Pe(new Int8Array(9216),[4,2304]),this.aBoolean592=!1,this.playerAlive=!1,this.terrainHeightLocal=Pe(new Int32Array(this.regionWidth*this.regionHeight),[this.regionWidth,this.regionHeight]),this.terrainModels=[],this.terrainModels.length=64,this.terrainModels.fill(null),this.localX=new Int32Array(18432),this.baseMediaSprite=750,this.scene=t,this.surface=e;for(let i=0;i<64;i++)this.terrainColours[i]=Oe.rgb(255-4*i,255-(1.75*i|0),255-4*i);for(let i=0;i<64;i++)this.terrainColours[i+64]=Oe.rgb(3*i,144,0);for(let i=0;i<64;i++)this.terrainColours[i+128]=Oe.rgb(192-(1.5*i|0),144-(1.5*i|0),0);for(let i=0;i<64;i++)this.terrainColours[i+192]=Oe.rgb(96-(1.5*i|0),48+(1.5*i|0),0)}getWallEastWest(t,e){if(t<0||t>=this.regionWidth||e<0||e>=this.regionHeight)return 0;let i=0;return t>=48&&e<48?(i=1,t-=48):t<48&&e>=48?(i=2,e-=48):t>=48&&e>=48&&(i=3,t-=48,e-=48),255&this.wallsEastWest.get(i,48*t+e)}setTerrainAmbience(t,e,i,s,r){let n=this.terrainModels[t+8*e];for(let o=0;o<n.numVertices;o++)if(n.vertexX[o]===i*this.tileSize&&n.vertexZ[o]===s*this.tileSize)return void n.setVertexAmbience(o,r)}getWallRoof(t,e){if(t<0||t>=this.regionWidth||e<0||e>=this.regionHeight)return 0;let i=0;return t>=48&&e<48?(i=1,t-=48):t<48&&e>=48?(i=2,e-=48):t>=48&&e>=48&&(i=3,t-=48,e-=48),this.wallsRoof.get(i,48*t+e)}getElevation(t,e){let i=t>>7,s=e>>7,r=127&t,n=127&e;if(i<0||s<0||i>=95||s>=95)return 0;let o=0,a=0,h=0;return r<=this.tileSize-n?(o=this.getTerrainHeight(i,s),a=this.getTerrainHeight(i+1,s)-o,h=this.getTerrainHeight(i,s+1)-o):(o=this.getTerrainHeight(i+1,s+1),a=this.getTerrainHeight(i,s+1)-o,h=this.getTerrainHeight(i+1,s)-o,r=this.tileSize-r,n=this.tileSize-n),o+(a*r/this.tileSize|0)+(h*n/this.tileSize|0)}getWallDiagonal(t,e){if(t<0||t>=this.regionWidth||e<0||e>=this.regionHeight)return 0;let i=0;return t>=48&&e<48?(i=1,t-=48):t<48&&e>=48?(i=2,e-=48):t>=48&&e>=48&&(i=3,t-=48,e-=48),this.wallsDiagonal.get(i,48*t+e)}removeObject2(t,e,i){if(!(t<0||e<0||t>=95||e>=95||1!==Be.objectType[i]&&2!==Be.objectType[i])){let s=this.getTileDirection(t,e),r=0,n=0;0===s||4===s?(r=Be.objectWidth[i],n=Be.objectHeight[i]):(n=Be.objectWidth[i],r=Be.objectHeight[i]);for(let o=t;o<t+r;o++)for(let t=e;t<e+n;t++){const e=this.objectAdjacency.get(o,t);1===Be.objectType[i]?this.objectAdjacency.set(o,t,64|e):0===s?(this.objectAdjacency.set(o,t,2|e),o>0&&this._setObjectAdjacency_from3(o-1,t,8)):2===s?(this.objectAdjacency.set(o,t,4|e),t<95&&this._setObjectAdjacency_from3(o,t+1,1)):4===s?(this.objectAdjacency.set(o,t,8|e),o<95&&this._setObjectAdjacency_from3(o+1,t,2)):6===s&&(this.objectAdjacency.set(o,t,1|e),t>0&&this._setObjectAdjacency_from3(o,t-1,4))}this.method404(t,e,r,n)}}removeWallObject(t,e,i,s){if(!(t<0||e<0||t>=95||e>=95)&&1===Be.wallObjectAdjacent[s]){const s=this.objectAdjacency.get(t,e);0===i?(this.objectAdjacency.set(t,e,65534&s),e>0&&this.method407(t,e-1,4)):1===i?(this.objectAdjacency.set(t,e,65533&s),t>0&&this.method407(t-1,e,8)):2===i?this.objectAdjacency.set(t,e,65519&s):3===i&&this.objectAdjacency.set(t,e,65503&s),this.method404(t,e,1,1)}}method402(t,e,i,s,r){let n=3*t,o=3*e,a=this.scene.method302(s),h=this.scene.method302(r);if(a=a>>1&8355711,h=h>>1&8355711,0===i)return this.surface.drawLineHoriz(n,o,3,a),this.surface.drawLineHoriz(n,o+1,2,a),this.surface.drawLineHoriz(n,o+2,1,a),this.surface.drawLineHoriz(n+2,o+1,1,h),void this.surface.drawLineHoriz(n+1,o+2,2,h);1===i&&(this.surface.drawLineHoriz(n,o,3,h),this.surface.drawLineHoriz(n+1,o+1,2,h),this.surface.drawLineHoriz(n+2,o+2,1,h),this.surface.drawLineHoriz(n,o+1,1,a),this.surface.drawLineHoriz(n,o+2,2,a))}decodeSector(t,e,i,s){let r="m"+i+(t/10|0)+t%10+(e/10|0)+e%10;if(null!==this.landscapePack){let t=ti.loadData(r+".hei",0,this.landscapePack);if(null===t&&null!==this.memberLandscapePack&&(t=ti.loadData(r+".hei",0,this.memberLandscapePack)),null!==t&&t.length>0){let e=0,i=0;for(let r=0;r<2304;){let n=255&t[e++];if(n<128&&(this.terrainHeight.set(s,r++,255&n),i=n),n>=128)for(let t=0;t<n-128;t++)this.terrainHeight.set(s,r++,255&i)}i=64;for(let t=0;t<48;t++)for(let e=0;e<48;e++)i=this.terrainHeight.get(s,48*e+t)+i&127,this.terrainHeight.set(s,48*e+t,2*i&255);i=0;for(let r=0;r<2304;){let n=255&t[e++];if(n<128&&(this.terrainColour.set(s,r++,255&n),i=n),n>=128)for(let t=0;t<n-128;t++)this.terrainColour.set(s,r++,255&i)}i=35;for(let t=0;t<48;t++)for(let e=0;e<48;e++)i=this.terrainColour.get(s,48*e+t)+i&127,this.terrainColour.set(s,48*e+t,2*i&255)}else for(let i=0;i<2304;i++)this.terrainHeight.set(s,i,0),this.terrainColour.set(s,i,0);if(null===(t=ti.loadData(r+".dat",0,this.mapPack))&&null!==this.memberMapPack&&(t=ti.loadData(r+".dat",0,this.memberMapPack)),null===t||0===t.length){for(let t=0;t<2304;t++)this.terrainHeight.set(s,t,0),this.terrainColour.set(s,t,0),this.wallsNorthSouth.set(s,t,0),this.wallsEastWest.set(s,t,0),this.wallsDiagonal.set(s,t,0),this.wallsRoof.set(s,t,0),this.tileDecoration.set(s,t,0),0===i&&this.tileDecoration.set(s,t,-6),3===i&&this.tileDecoration.set(s,t,8),this.tileDirection.set(s,t,0);return}let e=0;for(let i=0;i<2304;i++)this.wallsNorthSouth.set(s,i,t[e++]);for(let i=0;i<2304;i++)this.wallsEastWest.set(s,i,t[e++]);for(let i=0;i<2304;i++)this.wallsDiagonal.set(s,i,255&t[e++]);for(let i=0;i<2304;i++){let r=255&t[e++];r>0&&this.wallsDiagonal.set(s,i,r+12e3)}for(let i=0;i<2304;){let r=255&t[e++];if(r<128)this.wallsRoof.set(s,i++,255&r);else for(let t=0;t<r-128;t++)this.wallsRoof.set(s,i++,0)}let n=0;for(let i=0;i<2304;){let r=255&t[e++];if(r<128)this.tileDecoration.set(s,i++,255&r),n=r;else for(let t=0;t<r-128;t++)this.tileDecoration.set(s,i++,n)}for(let i=0;i<2304;){let r=255&t[e++];if(r<128)this.tileDirection.set(s,i++,255&r);else for(let t=0;t<r-128;t++)this.tileDirection.set(s,i++,0)}if(null!==(t=ti.loadData(r+".loc",0,this.mapPack))&&t.length>0){e=0;for(let i=0;i<2304;){let r=255&t[e++];r<128?this.wallsDiagonal.set(s,i++,r+48e3):i+=r-128}}}}loadSection(...t){switch(t.length){case 3:return this._loadSection_from3(...t);case 4:return"number"==typeof t[3]?this.decodeSector(...t):this.loadRegionThenMakeModel(...t)}}method404(t,e,i,s){if(!(t<1||e<1||t+i>=this.regionWidth||e+s>=this.regionHeight))for(let r=t;r<=t+i;r++)for(let t=e;t<=e+s;t++)0!=(99&this.getObjectAdjacency(r,t))||0!=(89&this.getObjectAdjacency(r-1,t))||0!=(86&this.getObjectAdjacency(r,t-1))||0!=(108&this.getObjectAdjacency(r-1,t-1))?this.method425(r,t,35):this.method425(r,t,0)}getObjectAdjacency(t,e){return t<0||e<0||t>=this.regionWidth||e>=this.regionHeight?0:this.objectAdjacency.get(t,e)}hasRoof(t,e){return this.getWallRoof(t,e)>0&&this.getWallRoof(t-1,e)>0&&this.getWallRoof(t-1,e-1)>0&&this.getWallRoof(t,e-1)>0}method407(t,e,i){const s=this.objectAdjacency.get(t,e);this.objectAdjacency.set(t,e,s&65535-i)}getTerrainColour(t,e){if(t<0||t>=this.regionWidth||e<0||e>=this.regionHeight)return 0;let i=0;return t>=48&&e<48?(i=1,t-=48):t<48&&e>=48?(i=2,e-=48):t>=48&&e>=48&&(i=3,t-=48,e-=48),255&this.terrainColour.get(i,48*t+e)}reset(){this.worldInitialised&&this.scene.dispose();for(let t=0;t<64;t++){this.terrainModels[t]=null;for(let e=0;e<4;e++)this.wallModels[e][t]=null;for(let e=0;e<4;e++)this.roofModels[e][t]=null}}fillEmptySectorsAndBorder(){for(let t=0;t<this.regionWidth;t++)for(let e=0;e<this.regionHeight;e++)250===this.getOverlayID(t,e,0)&&(47===t&&250!==this.getOverlayID(t+1,e,0)&&2!==this.getOverlayID(t+1,e,0)?this.setTileDecoration(t,e,9):47===e&&250!==this.getOverlayID(t,e+1,0)&&2!==this.getOverlayID(t,e+1,0)?this.setTileDecoration(t,e,9):this.setTileDecoration(t,e,2))}getWallNorthSouth(t,e){if(t<0||t>=this.regionWidth||e<0||e>=this.regionHeight)return 0;let i=0;return t>=48&&e<48?(i=1,t-=48):t<48&&e>=48?(i=2,e-=48):t>=48&&e>=48&&(i=3,t-=48,e-=48),255&this.wallsNorthSouth.get(i,48*t+e)}getTileDirection(t,e){if(t<0||t>=this.regionWidth||e<0||e>=this.regionHeight)return 0;let i=0;return t>=48&&e<48?(i=1,t-=48):t<48&&e>=48?(i=2,e-=48):t>=48&&e>=48&&(i=3,t-=48,e-=48),this.tileDirection.get(i,48*t+e)}_getTileDecoration_from4(t,e,i,s){let r=this._getTileDecoration_from3(t,e,i);return 0===r?s:Be.tileDecoration[r-1]}_getTileDecoration_from3(t,e,i){if(t<0||t>=this.regionWidth||e<0||e>=this.regionHeight)return 0;let s=0;return t>=48&&e<48?(s=1,t-=48):t<48&&e>=48?(s=2,e-=48):t>=48&&e>=48&&(s=3,t-=48,e-=48),255&this.tileDecoration.get(s,48*t+e)}getOverlayID(...t){switch(t.length){case 3:return this._getTileDecoration_from3(...t);case 4:return this._getTileDecoration_from4(...t)}}setTileDecoration(t,e,i){if(t<0||t>=this.regionWidth||e<0||e>=this.regionHeight)return;let s=0;t>=48&&e<48?(s=1,t-=48):t<48&&e>=48?(s=2,e-=48):t>=48&&e>=48&&(s=3,t-=48,e-=48),this.tileDecoration.set(s,48*t+e,255&i)}route(t,e,i,s,r,n,o,a,h){for(let f=0;f<this.regionWidth;f++)for(let t=0;t<this.regionHeight;t++)this.routeVia.set(f,t,0);let l=0,c=0,u=t,m=e;this.routeVia.set(t,e,99),o[l]=t,a[l++]=e;let d,p=o.length,g=!1;for(;c!==l;){if(u=o[c],m=a[c],c=(c+1)%p,u>=i&&u<=r&&m>=s&&m<=n){g=!0;break}if(h){if(u>0&&u-1>=i&&u-1<=r&&m>=s&&m<=n&&0==(8&this.objectAdjacency.get(u-1,m))){g=!0;break}if(u<95&&u+1>=i&&u+1<=r&&m>=s&&m<=n&&0==(2&this.objectAdjacency.get(u+1,m))){g=!0;break}if(m>0&&u>=i&&u<=r&&m-1>=s&&m-1<=n&&0==(4&this.objectAdjacency.get(u,m-1))){g=!0;break}if(m<95&&u>=i&&u<=r&&m+1>=s&&m+1<=n&&0==(1&this.objectAdjacency.get(u,m+1))){g=!0;break}}u>0&&0===this.routeVia.get(u-1,m)&&0==(120&this.objectAdjacency.get(u-1,m))&&(o[l]=u-1,a[l]=m,l=(l+1)%p,this.routeVia.set(u-1,m,2)),u<95&&0===this.routeVia.get(u+1,m)&&0==(114&this.objectAdjacency.get(u+1,m))&&(o[l]=u+1,a[l]=m,l=(l+1)%p,this.routeVia.set(u+1,m,8)),m>0&&0===this.routeVia.get(u,m-1)&&0==(116&this.objectAdjacency.get(u,m-1))&&(o[l]=u,a[l]=m-1,l=(l+1)%p,this.routeVia.set(u,m-1,1)),m<95&&0===this.routeVia.get(u,m+1)&&0==(113&this.objectAdjacency.get(u,m+1))&&(o[l]=u,a[l]=m+1,l=(l+1)%p,this.routeVia.set(u,m+1,4)),u>0&&m>0&&0==(116&this.objectAdjacency.get(u,m-1))&&0==(120&this.objectAdjacency.get(u-1,m))&&0==(124&this.objectAdjacency.get(u-1,m-1))&&0===this.routeVia.get(u-1,m-1)&&(o[l]=u-1,a[l]=m-1,l=(l+1)%p,this.routeVia.set(u-1,m-1,3)),u<95&&m>0&&0==(116&this.objectAdjacency.get(u,m-1))&&0==(114&this.objectAdjacency.get(u+1,m))&&0==(118&this.objectAdjacency.get(u+1,m-1))&&0===this.routeVia.get(u+1,m-1)&&(o[l]=u+1,a[l]=m-1,l=(l+1)%p,this.routeVia.set(u+1,m-1,9)),u>0&&m<95&&0==(113&this.objectAdjacency.get(u,m+1))&&0==(120&this.objectAdjacency.get(u-1,m))&&0==(121&this.objectAdjacency.get(u-1,m+1))&&0===this.routeVia.get(u-1,m+1)&&(o[l]=u-1,a[l]=m+1,l=(l+1)%p,this.routeVia.set(u-1,m+1,6)),u<95&&m<95&&0==(113&this.objectAdjacency.get(u,m+1))&&0==(114&this.objectAdjacency.get(u+1,m))&&0==(115&this.objectAdjacency.get(u+1,m+1))&&0===this.routeVia.get(u+1,m+1)&&(o[l]=u+1,a[l]=m+1,l=(l+1)%p,this.routeVia.set(u+1,m+1,12))}if(!g)return-1;o[c=0]=u,a[c++]=m;for(let f=d=this.routeVia.get(u,m);u!==t||m!==e;f=this.routeVia.get(u,m))f!==d&&(d=f,o[c]=u,a[c++]=m),0!=(2&f)?u++:0!=(8&f)&&u--,0!=(1&f)?m++:0!=(4&f)&&m--;return c}_setObjectAdjacency_from4(t,e,i,s){if(!(t<0||e<0||t>=95||e>=95)&&1===Be.wallObjectAdjacent[s]){const s=this.objectAdjacency.get(t,e);0===i?(this.objectAdjacency.set(t,e,1|s),e>0&&this._setObjectAdjacency_from3(t,e-1,4)):1===i?(this.objectAdjacency.set(t,e,2|s),t>0&&this._setObjectAdjacency_from3(t-1,e,8)):2===i?this.objectAdjacency.set(t,e,16|s):3===i&&this.objectAdjacency.set(t,e,32|s),this.method404(t,e,1,1)}}setObjectAdjacency(...t){switch(t.length){case 4:return this._setObjectAdjacency_from4(...t);case 3:return this._setObjectAdjacency_from3(...t)}}loadRegionThenMakeModel(t,e,i,s){let r=(t+24)/48|0,n=(e+24)/48|0;if(this.decodeSector(r-1,n-1,i,0),this.decodeSector(r,n-1,i,1),this.decodeSector(r-1,n,i,2),this.decodeSector(r,n,i,3),this.fillEmptySectorsAndBorder(),null===this.parentModel&&(this.parentModel=Ne._from7(18688,18688,!0,!0,!1,!1,!0)),s){this.surface.blackScreen();for(let e=0;e<this.regionWidth;e++)for(let t=0;t<this.regionHeight;t++)this.objectAdjacency.set(e,t,0);let t=this.parentModel;t.clear();for(let e=0;e<this.regionWidth;e++)for(let s=0;s<this.regionHeight;s++){let r=-this.getTerrainHeight(e,s);for(let t=-1;t<1;t++)for(let n=-1;n<1;n++){let o=this.getOverlayID(e+t,s+n,i);if(o>0&&4===Be.overlays[o-1]){r=0;break}}let n=t.vertexAt(e*this.tileSize,r,s*this.tileSize),o=(10*Math.random()|0)-5;t.setVertexAmbience(n,o)}for(let e=0;e<95;e++)for(let s=0;s<95;s++){let r=this.getTerrainColour(e,s),n=this.terrainColours[r],o=n,a=n,h=0;1!==i&&2!==i||(n=ii.colourTransparent,o=ii.colourTransparent,a=ii.colourTransparent);let l=this.getOverlayID(e,s,i);if(l>0){let t=Be.overlays[l-1],r=this.getTileType(e,s,i);if(n=o=Be.tileDecoration[l-1],4===t&&(n=1,o=1,12===l&&(n=31,o=31)),5===t?this.getWallDiagonal(e,s)>0&&this.getWallDiagonal(e,s)<24e3&&(this.getOverlayID(e-1,s,i,a)!==ii.colourTransparent&&this.getOverlayID(e,s-1,i,a)!==ii.colourTransparent?(n=this.getOverlayID(e-1,s,i,a),h=0):this.getOverlayID(e+1,s,i,a)!==ii.colourTransparent&&this.getOverlayID(e,s+1,i,a)!==ii.colourTransparent?(o=this.getOverlayID(e+1,s,i,a),h=0):this.getOverlayID(e+1,s,i,a)!==ii.colourTransparent&&this.getOverlayID(e,s-1,i,a)!==ii.colourTransparent?(o=this.getOverlayID(e+1,s,i,a),h=1):this.getOverlayID(e-1,s,i,a)!==ii.colourTransparent&&this.getOverlayID(e,s+1,i,a)!==ii.colourTransparent&&(n=this.getOverlayID(e-1,s,i,a),h=1)):(2!==t||this.getWallDiagonal(e,s)>0&&this.getWallDiagonal(e,s)<24e3)&&(this.getTileType(e-1,s,i)!==r&&this.getTileType(e,s-1,i)!==r?(n=a,h=0):this.getTileType(e+1,s,i)!==r&&this.getTileType(e,s+1,i)!==r?(o=a,h=0):this.getTileType(e+1,s,i)!==r&&this.getTileType(e,s-1,i)!==r?(o=a,h=1):this.getTileType(e-1,s,i)!==r&&this.getTileType(e,s+1,i)!==r&&(n=a,h=1)),0!==Be.tileAdjacent[l-1]){const t=this.objectAdjacency.get(e,s);this.objectAdjacency.set(e,s,64|t)}if(2===Be.overlays[l-1]){const t=this.objectAdjacency.get(e,s);this.objectAdjacency.set(e,s,128|t)}}this.method402(e,s,h,n,o);let c=this.getTerrainHeight(e+1,s+1)-this.getTerrainHeight(e+1,s)+this.getTerrainHeight(e,s+1)-this.getTerrainHeight(e,s);if(n!==o||0!==c){let i=new Int32Array(3),r=new Int32Array(3);if(0===h){if(n!==ii.colourTransparent){i[0]=s+96*e+96,i[1]=s+96*e,i[2]=s+96*e+1;let r=t.createFace(3,i,ii.colourTransparent,n);this.localX[r]=e,this.localY[r]=s,t.faceTag[r]=2e5+r}if(o!==ii.colourTransparent){r[0]=s+96*e+1,r[1]=s+96*e+96+1,r[2]=s+96*e+96;let i=t.createFace(3,r,ii.colourTransparent,o);this.localX[i]=e,this.localY[i]=s,t.faceTag[i]=2e5+i}}else{if(n!==ii.colourTransparent){i[0]=s+96*e+1,i[1]=s+96*e+96+1,i[2]=s+96*e;let r=t.createFace(3,i,ii.colourTransparent,n);this.localX[r]=e,this.localY[r]=s,t.faceTag[r]=2e5+r}if(o!==ii.colourTransparent){r[0]=s+96*e+96,r[1]=s+96*e,r[2]=s+96*e+96+1;let i=t.createFace(3,r,ii.colourTransparent,o);this.localX[i]=e,this.localY[i]=s,t.faceTag[i]=2e5+i}}}else if(n!==ii.colourTransparent){let i=new Int32Array(4);i[0]=s+96*e+96,i[1]=s+96*e,i[2]=s+96*e+1,i[3]=s+96*e+96+1;let r=t.createFace(4,i,ii.colourTransparent,n);this.localX[r]=e,this.localY[r]=s,t.faceTag[r]=2e5+r}}for(let e=1;e<95;e++)for(let s=1;s<95;s++)if(this.getOverlayID(e,s,i)>0&&4===Be.overlays[this.getOverlayID(e,s,i)-1]){let r=Be.tileDecoration[this.getOverlayID(e,s,i)-1],n=t.vertexAt(e*this.tileSize,-this.getTerrainHeight(e,s),s*this.tileSize),o=t.vertexAt((e+1)*this.tileSize,-this.getTerrainHeight(e+1,s),s*this.tileSize),a=t.vertexAt((e+1)*this.tileSize,-this.getTerrainHeight(e+1,s+1),(s+1)*this.tileSize),h=t.vertexAt(e*this.tileSize,-this.getTerrainHeight(e,s+1),(s+1)*this.tileSize),l=new Int32Array([n,o,a,h]),c=t.createFace(4,l,r,ii.colourTransparent);this.localX[c]=e,this.localY[c]=s,t.faceTag[c]=2e5+c,this.method402(e,s,0,r,r)}else if(0===this.getOverlayID(e,s,i)||3!==Be.overlays[this.getOverlayID(e,s,i)-1]){if(this.getOverlayID(e,s+1,i)>0&&4===Be.overlays[this.getOverlayID(e,s+1,i)-1]){let r=Be.tileDecoration[this.getOverlayID(e,s+1,i)-1],n=t.vertexAt(e*this.tileSize,-this.getTerrainHeight(e,s),s*this.tileSize),o=t.vertexAt((e+1)*this.tileSize,-this.getTerrainHeight(e+1,s),s*this.tileSize),a=t.vertexAt((e+1)*this.tileSize,-this.getTerrainHeight(e+1,s+1),(s+1)*this.tileSize),h=t.vertexAt(e*this.tileSize,-this.getTerrainHeight(e,s+1),(s+1)*this.tileSize),l=new Int32Array([n,o,a,h]),c=t.createFace(4,l,r,ii.colourTransparent);this.localX[c]=e,this.localY[c]=s,t.faceTag[c]=2e5+c,this.method402(e,s,0,r,r)}if(this.getOverlayID(e,s-1,i)>0&&4===Be.overlays[this.getOverlayID(e,s-1,i)-1]){let r=Be.tileDecoration[this.getOverlayID(e,s-1,i)-1],n=t.vertexAt(e*this.tileSize,-this.getTerrainHeight(e,s),s*this.tileSize),o=t.vertexAt((e+1)*this.tileSize,-this.getTerrainHeight(e+1,s),s*this.tileSize),a=t.vertexAt((e+1)*this.tileSize,-this.getTerrainHeight(e+1,s+1),(s+1)*this.tileSize),h=t.vertexAt(e*this.tileSize,-this.getTerrainHeight(e,s+1),(s+1)*this.tileSize),l=new Int32Array([n,o,a,h]),c=t.createFace(4,l,r,ii.colourTransparent);this.localX[c]=e,this.localY[c]=s,t.faceTag[c]=2e5+c,this.method402(e,s,0,r,r)}if(this.getOverlayID(e+1,s,i)>0&&4===Be.overlays[this.getOverlayID(e+1,s,i)-1]){let r=Be.tileDecoration[this.getOverlayID(e+1,s,i)-1],n=t.vertexAt(e*this.tileSize,-this.getTerrainHeight(e,s),s*this.tileSize),o=t.vertexAt((e+1)*this.tileSize,-this.getTerrainHeight(e+1,s),s*this.tileSize),a=t.vertexAt((e+1)*this.tileSize,-this.getTerrainHeight(e+1,s+1),(s+1)*this.tileSize),h=t.vertexAt(e*this.tileSize,-this.getTerrainHeight(e,s+1),(s+1)*this.tileSize),l=new Int32Array([n,o,a,h]),c=t.createFace(4,l,r,ii.colourTransparent);this.localX[c]=e,this.localY[c]=s,t.faceTag[c]=2e5+c,this.method402(e,s,0,r,r)}if(this.getOverlayID(e-1,s,i)>0&&4===Be.overlays[this.getOverlayID(e-1,s,i)-1]){let r=Be.tileDecoration[this.getOverlayID(e-1,s,i)-1],n=t.vertexAt(e*this.tileSize,-this.getTerrainHeight(e,s),s*this.tileSize),o=t.vertexAt((e+1)*this.tileSize,-this.getTerrainHeight(e+1,s),s*this.tileSize),a=t.vertexAt((e+1)*this.tileSize,-this.getTerrainHeight(e+1,s+1),(s+1)*this.tileSize),h=t.vertexAt(e*this.tileSize,-this.getTerrainHeight(e,s+1),(s+1)*this.tileSize),l=new Int32Array([n,o,a,h]),c=t.createFace(4,l,r,ii.colourTransparent);this.localX[c]=e,this.localY[c]=s,t.faceTag[c]=2e5+c,this.method402(e,s,0,r,r)}}t.createGouraudLightSource(!0,40,48,-50,-10,-50),this.terrainModels=this.parentModel.split(0,0,1536,1536,8,64,233,!1);for(let e=0;e<64;e++)this.scene.addModel(this.terrainModels[e]);for(let e=0;e<this.regionWidth;e++)for(let t=0;t<this.regionHeight;t++)this.terrainHeightLocal.set(e,t,this.getTerrainHeight(e,t))}this.parentModel.clear();let o=6316128;for(let a=0;a<95;a++)for(let t=0;t<95;t++){let e=this.getWallEastWest(a,t);if(e>0&&(0===Be.wallObjectInvisible[e-1]||this.aBoolean592)){if(this.method422(this.parentModel,e-1,a,t,a+1,t),s&&0!==Be.wallObjectAdjacent[e-1]){const e=this.objectAdjacency.get(a,t);this.objectAdjacency.set(a,t,1|e),t>0&&this._setObjectAdjacency_from3(a,t-1,4)}s&&this.surface.drawLineHoriz(3*a,3*t,3,o)}if((e=this.getWallNorthSouth(a,t))>0&&(0===Be.wallObjectInvisible[e-1]||this.aBoolean592)){if(this.method422(this.parentModel,e-1,a,t,a,t+1),s&&0!==Be.wallObjectAdjacent[e-1]){const e=this.objectAdjacency.get(a,t);this.objectAdjacency.set(a,t,2|e),a>0&&this._setObjectAdjacency_from3(a-1,t,8)}s&&this.surface.drawLineVert(3*a,3*t,3,o)}if((e=this.getWallDiagonal(a,t))>0&&e<12e3&&(0===Be.wallObjectInvisible[e-1]||this.aBoolean592)){if(this.method422(this.parentModel,e-1,a,t,a+1,t+1),s&&0!==Be.wallObjectAdjacent[e-1]){const e=this.objectAdjacency.get(a,t);this.objectAdjacency.set(a,t,32|e)}s&&(this.surface.setPixel(3*a,3*t,o),this.surface.setPixel(3*a+1,3*t+1,o),this.surface.setPixel(3*a+2,3*t+2,o))}if(e>12e3&&e<24e3&&(0===Be.wallObjectInvisible[e-12001]||this.aBoolean592)){if(this.method422(this.parentModel,e-12001,a+1,t,a,t+1),s&&0!==Be.wallObjectAdjacent[e-12001]){const e=this.objectAdjacency.get(a,t);this.objectAdjacency.set(a,t,16|e)}s&&(this.surface.setPixel(3*a+2,3*t,o),this.surface.setPixel(3*a+1,3*t+1,o),this.surface.setPixel(3*a,3*t+2,o))}}s&&this.surface.drawSpriteMinimap(this.baseMediaSprite-1,0,0,285,285),this.parentModel.createGouraudLightSource(!1,60,24,-50,-10,-50),this.wallModels[i]=this.parentModel.split(0,0,1536,1536,8,64,338,!0);for(let a=0;a<64;a++)this.scene.addModel(this.wallModels[i][a]);for(let a=0;a<95;a++)for(let t=0;t<95;t++){let e=this.getWallEastWest(a,t);e>0&&this.method428(e-1,a,t,a+1,t),(e=this.getWallNorthSouth(a,t))>0&&this.method428(e-1,a,t,a,t+1),(e=this.getWallDiagonal(a,t))>0&&e<12e3&&this.method428(e-1,a,t,a+1,t+1),e>12e3&&e<24e3&&this.method428(e-12001,a+1,t,a,t+1)}for(let a=1;a<95;a++)for(let t=1;t<95;t++)if(this.getWallRoof(a,t)>0){let e=a,i=t,s=a+1,r=t,n=a+1,o=t+1,h=a,l=t+1,c=0,u=this.terrainHeightLocal.get(e,i),m=this.terrainHeightLocal.get(s,r),d=this.terrainHeightLocal.get(n,o),p=this.terrainHeightLocal.get(h,l);if(u>8e4&&(u-=8e4),m>8e4&&(m-=8e4),d>8e4&&(d-=8e4),p>8e4&&(p-=8e4),u>c&&(c=u),m>c&&(c=m),d>c&&(c=d),p>c&&(c=p),c>=8e4&&(c-=8e4),u<8e4)this.terrainHeightLocal.set(e,i,c);else{const t=this.terrainHeightLocal.get(e,i);this.terrainHeightLocal.set(e,i,t-8e4)}if(m<8e4)this.terrainHeightLocal.set(s,r,c);else{const t=this.terrainHeightLocal.get(s,r);this.terrainHeightLocal.set(s,r,t-8e4)}if(d<8e4)this.terrainHeightLocal.set(n,o,c);else{const t=this.terrainHeightLocal.get(n,o);this.terrainHeightLocal.set(n,o,t-8e4)}if(p<8e4)this.terrainHeightLocal.set(h,l,c);else{const t=this.terrainHeightLocal.get(h,l);this.terrainHeightLocal.set(h,l,t-8e4)}}this.parentModel.clear();for(let a=1;a<95;a++)for(let t=1;t<95;t++){let e=this.getWallRoof(a,t);if(e>0){let i=a,s=t,r=a+1,n=t,o=a+1,h=t+1,l=a,c=t+1,u=a*this.tileSize,m=t*this.tileSize,d=u+this.tileSize,p=m+this.tileSize,g=u,f=m,S=d,w=p,C=this.terrainHeightLocal.get(i,s),I=this.terrainHeightLocal.get(r,n),y=this.terrainHeightLocal.get(o,h),b=this.terrainHeightLocal.get(l,c),T=Be.roofHeight[e-1];this.hasRoof(i,s)&&C<8e4&&(C+=T+8e4,this.terrainHeightLocal.set(i,s,C)),this.hasRoof(r,n)&&I<8e4&&(I+=T+8e4,this.terrainHeightLocal.set(r,n,I)),this.hasRoof(o,h)&&y<8e4&&(y+=T+8e4,this.terrainHeightLocal.set(o,h,y)),this.hasRoof(l,c)&&b<8e4&&(b+=T+8e4,this.terrainHeightLocal.set(l,c,b)),C>=8e4&&(C-=8e4),I>=8e4&&(I-=8e4),y>=8e4&&(y-=8e4),b>=8e4&&(b-=8e4);let A=16;if(this.roofsLeadTo(i-1,s)||(u-=A),this.roofsLeadTo(i+1,s)||(u+=A),this.roofsLeadTo(i,s-1)||(m-=A),this.roofsLeadTo(i,s+1)||(m+=A),this.roofsLeadTo(r-1,n)||(d-=A),this.roofsLeadTo(r+1,n)||(d+=A),this.roofsLeadTo(r,n-1)||(f-=A),this.roofsLeadTo(r,n+1)||(f+=A),this.roofsLeadTo(o-1,h)||(S-=A),this.roofsLeadTo(o+1,h)||(S+=A),this.roofsLeadTo(o,h-1)||(p-=A),this.roofsLeadTo(o,h+1)||(p+=A),this.roofsLeadTo(l-1,c)||(g-=A),this.roofsLeadTo(l+1,c)||(g+=A),this.roofsLeadTo(l,c-1)||(w-=A),this.roofsLeadTo(l,c+1)||(w+=A),e=Be.roofNumVertices[e-1],C=-C,I=-I,y=-y,b=-b,this.getWallDiagonal(a,t)>12e3&&this.getWallDiagonal(a,t)<24e3&&0===this.getWallRoof(a-1,t-1)){let t=new Int32Array(3);t[0]=this.parentModel.vertexAt(S,y,p),t[1]=this.parentModel.vertexAt(g,b,w),t[2]=this.parentModel.vertexAt(d,I,f),this.parentModel.createFace(3,t,e,ii.colourTransparent)}else if(this.getWallDiagonal(a,t)>12e3&&this.getWallDiagonal(a,t)<24e3&&0===this.getWallRoof(a+1,t+1)){let t=new Int32Array(3);t[0]=this.parentModel.vertexAt(u,C,m),t[1]=this.parentModel.vertexAt(d,I,f),t[2]=this.parentModel.vertexAt(g,b,w),this.parentModel.createFace(3,t,e,ii.colourTransparent)}else if(this.getWallDiagonal(a,t)>0&&this.getWallDiagonal(a,t)<12e3&&0===this.getWallRoof(a+1,t-1)){let t=new Int32Array(3);t[0]=this.parentModel.vertexAt(g,b,w),t[1]=this.parentModel.vertexAt(u,C,m),t[2]=this.parentModel.vertexAt(S,y,p),this.parentModel.createFace(3,t,e,ii.colourTransparent)}else if(this.getWallDiagonal(a,t)>0&&this.getWallDiagonal(a,t)<12e3&&0===this.getWallRoof(a-1,t+1)){let t=new Int32Array(3);t[0]=this.parentModel.vertexAt(d,I,f),t[1]=this.parentModel.vertexAt(S,y,p),t[2]=this.parentModel.vertexAt(u,C,m),this.parentModel.createFace(3,t,e,ii.colourTransparent)}else if(C===I&&y===b){let t=new Int32Array(4);t[0]=this.parentModel.vertexAt(u,C,m),t[1]=this.parentModel.vertexAt(d,I,f),t[2]=this.parentModel.vertexAt(S,y,p),t[3]=this.parentModel.vertexAt(g,b,w),this.parentModel.createFace(4,t,e,ii.colourTransparent)}else if(C===b&&I===y){let t=new Int32Array(4);t[0]=this.parentModel.vertexAt(g,b,w),t[1]=this.parentModel.vertexAt(u,C,m),t[2]=this.parentModel.vertexAt(d,I,f),t[3]=this.parentModel.vertexAt(S,y,p),this.parentModel.createFace(4,t,e,ii.colourTransparent)}else{let i=!0;if(this.getWallRoof(a-1,t-1)>0&&(i=!1),this.getWallRoof(a+1,t+1)>0&&(i=!1),i){let t=new Int32Array(3);t[0]=this.parentModel.vertexAt(u,C,m),t[1]=this.parentModel.vertexAt(d,I,f),t[2]=this.parentModel.vertexAt(g,b,w),this.parentModel.createFace(3,t,e,ii.colourTransparent);let i=new Int32Array(3);i[0]=this.parentModel.vertexAt(S,y,p),i[1]=this.parentModel.vertexAt(g,b,w),i[2]=this.parentModel.vertexAt(d,I,f),this.parentModel.createFace(3,i,e,ii.colourTransparent)}else{let t=new Int32Array(3);t[0]=this.parentModel.vertexAt(d,I,f),t[1]=this.parentModel.vertexAt(S,y,p),t[2]=this.parentModel.vertexAt(u,C,m),this.parentModel.createFace(3,t,e,ii.colourTransparent);let i=new Int32Array(3);i[0]=this.parentModel.vertexAt(g,b,w),i[1]=this.parentModel.vertexAt(u,C,m),i[2]=this.parentModel.vertexAt(S,y,p),this.parentModel.createFace(3,i,e,ii.colourTransparent)}}}}this.parentModel.createGouraudLightSource(!0,50,50,-50,-10,-50),this.roofModels[i]=this.parentModel.split(0,0,1536,1536,8,64,169,!0);for(let a=0;a<64;a++)this.scene.addModel(this.roofModels[i][a]);if(null===this.roofModels[i][0])throw new EvalError("null roof!");for(let a=0;a<this.regionWidth;a++)for(let t=0;t<this.regionHeight;t++)if(this.terrainHeightLocal.get(a,t)>=8e4){const e=this.terrainHeightLocal.get(a,t);this.terrainHeightLocal.set(a,t,e-8e4)}}_setObjectAdjacency_from3(t,e,i){const s=this.objectAdjacency.get(t,e);this.objectAdjacency.set(t,e,s|i)}getTileType(t,e,i){let s=this.getOverlayID(t,e,i);return 0===s?-1:2!==Be.overlays[s-1]?0:1}addModels(t){for(let e=0;e<94;e++)for(let i=0;i<94;i++){let s=this.getWallDiagonal(e,i);if(s>ei&&s<ei+12e3){let r=s-ei-1,n=Be.objectWidth[r],o=Be.objectHeight[r],a=this.getTileDirection(e,i);0!==a&&4!==a||(n=Be.objectWidth[r],o=Be.objectHeight[r]),this.removeObject2(e,i,r);let h=t[Be.objectModelIndex[r]].copy(!1,!0,!1,!1),l=(e+e+n)*this.tileSize/2|0,c=(i+i+o)*this.tileSize/2|0;if(h.translate(l,-this.getElevation(l,c),c),h.orient(0,32*this.getTileDirection(e,i),0),this.scene.addModel(h),h.offsetLightSourceCoords(48,48,-50,-10,-50),n>1||o>1)for(let t=e;t<e+n;t++)for(let s=i;s<i+o;s++)if((t>e||s>i)&&this.getWallDiagonal(t,s)-(ei+1)===r){let e=t,i=s,r=0;e>=48&&i<48?(r=1,e-=48):e<48&&i>=48?(r=2,i-=48):e>=48&&i>=48&&(r=3,e-=48,i-=48),this.wallsDiagonal.set(r,48*e+i,0)}}}}method422(t,e,i,s,r,n){this.method425(i,s,40),this.method425(r,n,40);let o=Be.wallObjectHeight[e],a=Be.wallObjectTextureFront[e],h=Be.wallObjectTextureBack[e],l=i*this.tileSize,c=s*this.tileSize,u=r*this.tileSize,m=n*this.tileSize,d=t.vertexAt(l,-this.terrainHeightLocal.get(i,s),c),p=t.vertexAt(l,-this.terrainHeightLocal.get(i,s)-o,c),g=t.vertexAt(u,-this.terrainHeightLocal.get(r,n)-o,m),f=t.vertexAt(u,-this.terrainHeightLocal.get(r,n),m),S=new Int32Array([d,p,g,f]),w=t.createFace(4,S,a,h);5!==Be.wallObjectInvisible[e]?t.faceTag[w]=0:t.faceTag[w]=3e4+e}getTerrainHeight(t,e){if(t<0||t>=this.regionWidth||e<0||e>=this.regionHeight)return 0;let i=0;return t>=48&&e<48?(i=1,t-=48):t<48&&e>=48?(i=2,e-=48):t>=48&&e>=48&&(i=3,t-=48,e-=48),3*(255&this.terrainHeight.get(i,48*t+e))}_loadSection_from3(t,e,i){this.reset();let s=(t+24)/48|0,r=(e+24)/48|0;this.loadRegionThenMakeModel(t,e,i,!0),0===i&&(this.loadRegionThenMakeModel(t,e,1,!1),this.loadRegionThenMakeModel(t,e,2,!1),this.decodeSector(s-1,r-1,i,0),this.decodeSector(s,r-1,i,1),this.decodeSector(s-1,r,i,2),this.decodeSector(s,r,i,3),this.fillEmptySectorsAndBorder())}method425(t,e,i){let s=t/12|0,r=e/12|0,n=(t-1)/12|0,o=(e-1)/12|0;this.setTerrainAmbience(s,r,t,e,i),s!==n&&this.setTerrainAmbience(n,r,t,e,i),r!==o&&this.setTerrainAmbience(s,o,t,e,i),s!==n&&r!==o&&this.setTerrainAmbience(n,o,t,e,i)}removeObject(t,e,i){if(!(t<0||e<0||t>=95||e>=95||1!==Be.objectType[i]&&2!==Be.objectType[i])){let s=this.getTileDirection(t,e),r=Be.objectHeight[i],n=Be.objectWidth[i];0!==s&&4!==s||(r=Be.objectWidth[i],n=Be.objectHeight[i]);for(let o=t;o<t+r;o++)for(let t=e;t<e+n;t++){const e=this.objectAdjacency.get(o,t);1===Be.objectType[i]?this.objectAdjacency.set(o,t,65471&e):0===s?(this.objectAdjacency.set(o,t,65533&e),o>0&&this.method407(o-1,t,8)):2===s?(this.objectAdjacency.set(o,t,65531&e),t<95&&this.method407(o,t+1,1)):4===s?(this.objectAdjacency.set(o,t,65527&e),o<95&&this.method407(o+1,t,2)):6===s&&(this.objectAdjacency.set(o,t,65534&e),t>0&&this.method407(o,t-1,4))}this.method404(t,e,r,n)}}roofsLeadTo(t,e){return this.getWallRoof(t,e)>0||this.getWallRoof(t-1,e)>0||this.getWallRoof(t-1,e-1)>0||this.getWallRoof(t,e-1)>0}method428(t,e,i,s,r){let n=Be.wallObjectHeight[t];const o=this.terrainHeightLocal.get(e,i);o<8e4&&this.terrainHeightLocal.set(e,i,o+8e4+n);const a=this.terrainHeightLocal.get(s,r);a<8e4&&this.terrainHeightLocal.set(s,r,a+8e4+n)}}ii.colourTransparent=12345678,Je=ii;const{decodeString:si,encodeString:ri}=f,{Utility:ni,GameState:oi,GamePanel:ai,WelcomeState:hi}=ct,{filter:li,readFilteredTLDs:ci,readFilteredHosts:ui,readFilteredWords:mi,readFilteredHashFragments:di}=pe,pi=450,gi=1250,fi=550,Si=750;function wi(t,e){let i=new Date;i.setTime(i.getTime()+2592e6),document.cookie=t+"="+e+";expires = "+i.toUTCString()+";path=/"}const Ci=t=>{const e=t+"=",i=decodeURIComponent(document.cookie).split(";");for(let s=0;s<i.length;s++){let t=i[s];for(;" "===t.charAt(0);)t=t.substring(1);if(0===t.indexOf(e))return t.substring(e.length,t.length)}return""};function Ii(t){return Array.from(t).map(t=>String.fromCharCode(t)).join("")}class yi extends ge{constructor(t){super(t),this.menuMaxSize=250,this.pathStepsMax=8e3,this.playersMax=500,this.npcsMax=500,this.wallObjectsMax=500,this.playersServerMax=4e3,this.groundItemsMax=5e3,this.npcsServerMax=5e3,this.objectsMax=1500,this.playerStatCount=18,this.questCount=50,this.playerStatEquipmentCount=5,this.savePass="true"===Ci("savePass"),this.lastLog=[],this.lastLogIdx=-1,this.localRegionX=0,this.localRegionY=0,this.controlTextListChat=0,this.controlTextListAll=0,this.controlTextListQuest=0,this.controlTextListPrivate=0,this.messageTabSelected=0,this.mouseClickXX=0,this.mouseClickXY=0,this.controlListSocialPlayers=0,this.uiTabSocialSubTab=0,this.privateMessageTarget=new w(0),this.controlListQuest=0,this.uiTabPlayerInfoSubTab=0,this.controlListMagic=0,this.tabMagicPrayer=0,this.packetErrorCount=0,this.mouseButtonDownTime=0,this.mouseButtonItemCountIncrement=0,this.anInt659=0,this.anInt660=0,this.cameraRotationX=0,this.scene=null,this.showDialogReportAbuseStep=0,this.tradeConfirmAccepted=!1,this.audioPlayer=null,this.appearanceHeadType=0,this.appearanceSkinColour=0,this.showDialogSocialInput=0,this.anInt707=0,this.deathScreenTimeout=0,this.cameraRotationY=0,this.combatStyle=0,this.welcomeUnreadMessages=0,this.controlButtonAppearanceHead1=0,this.controlButtonAppearanceHead2=0,this.controlButtonAppearanceHair1=0,this.controlButtonAppearanceHair2=0,this.controlButtonAppearanceGender1=0,this.controlButtonAppearanceGender2=0,this.controlButtonAppearanceTop1=0,this.controlButtonAppearanceTop2=0,this.controlButtonAppearanceSkin1=0,this.controlButtonAppearanceSkin2=0,this.controlButtonAppearanceBottom1=0,this.controlButtonAppearanceBottom2=0,this.controlButtonAppearanceAccept=0,this.logoutBoxFrames=0,this.tradeRecipientConfirmHash=new w(0),this.frameCounter=0,this.npcCombatModelArray2=new Int32Array([0,0,0,0,0,1,2,1]),this.systemUpdate=0,this.graphics=null,this.regionX=0,this.regionY=0,this.welcomScreenAlreadyShown=!1,this.mouseButtonClick=0,this.questName=["Black knight's fortress","Cook's assistant","Demon slayer","Doric's quest","The restless ghost","Goblin diplomacy","Ernest the chicken","Imp catcher","Pirate's treasure","Prince Ali rescue","Romeo & Juliet","Sheep shearer","Shield of Arrav","The knight's sword","Vampire slayer","Witch's potion","Dragon slayer","Witch's house (members)","Lost city (members)","Hero's quest (members)","Druidic ritual (members)","Merlin's crystal (members)","Scorpion catcher (members)","Family crest (members)","Tribal totem (members)","Fishing contest (members)","Monk's friend (members)","Temple of Ikov (members)","Clock tower (members)","The Holy Grail (members)","Fight Arena (members)","Tree Gnome Village (members)","The Hazeel Cult (members)","Sheep Herder (members)","Plague City (members)","Sea Slug (members)","Waterfall quest (members)","Biohazard (members)","Jungle potion (members)","Grand tree (members)","Shilo village (members)","Underground pass (members)","Observatory quest (members)","Tourist trap (members)","Watchtower (members)","Dwarf Cannon (members)","Murder Mystery (members)","Digsite (members)","Gertrude's Cat (members)","Legend's Quest (members)"],this.healthBarCount=0,this.spriteMedia=0,this.spriteUtil=0,this.spriteItem=0,this.spriteProjectile=0,this.spriteTexture=0,this.spriteTextureWorld=0,this.spriteLogo=0,this.controlLoginStatus=0,this.controlLoginUser=0,this.controlLoginPass=0,this.controlLoginOk=0,this.controlLoginCancel=0,this.teleportBubbleCount=0,this.mouseClickCount=0,this.shopSellPriceMod=0,this.shopBuyPriceMod=0,this.duelOptionRetreat=0,this.duelOptionMagic=0,this.duelOptionPrayer=0,this.duelOptionWeapons=0,this.groundItemCount=0,this.receivedMessagesCount=0,this.messageTabFlashAll=0,this.messageTabFlashHistory=0,this.messageTabFlashQuest=0,this.messageTabFlashPrivate=0,this.bankItemCount=0,this.objectAnimationNumberFireLightningSpell=0,this.objectAnimationNumberTorch=0,this.objectAnimationNumberClaw=0,this.npcCount=0,this.npcCacheCount=0,this.objectAnimationCount=0,this.tradeConfirmItemsCount=0,this.mouseClickXStep=0,this.newBankItemCount=0,this.npcAnimationArray=[new Int32Array([11,2,9,7,1,6,10,0,5,8,3,4]),new Int32Array([11,2,9,7,1,6,10,0,5,8,3,4]),new Int32Array([11,3,2,9,7,1,6,10,0,5,8,4]),new Int32Array([3,4,2,9,7,1,6,10,8,11,0,5]),new Int32Array([3,4,2,9,7,1,6,10,8,11,0,5]),new Int32Array([4,3,2,9,7,1,6,10,8,11,0,5]),new Int32Array([11,4,2,9,7,1,6,10,0,5,8,3]),new Int32Array([11,2,9,7,1,6,10,0,5,8,4,3])],this.controlWelcomeNewuser=0,this.controlWelcomeExistinguser=0,this.npcWalkModel=new Int32Array([0,1,2,1]),this.referid=0,this.controlRegisterUser=0,this.controlRegisterPassword=0,this.controlRegisterConfirmPassword=0,this.controlRegisterSubmit=0,this.controlRegisterCancel=0,this.controlRegisterCheckbox=0,this.controlLoginSavePass=0,this.controlRegisterStatus=0,this.combatTimeout=0,this.optionMenuCount=0,this.errorLoadingCodebase=!1,this.reportAbuseOffence=0,this.cameraRotationTime=0,this.duelOpponentItemsCount=0,this.duelItemsCount=0,this.characterSkinColours=new Int32Array([15523536,13415270,11766848,10056486,9461792]),this.duelOfferOpponentItemCount=0,this.characterTopBottomColours=new Int32Array([16711680,16744448,16769024,10543104,57344,32768,41088,45311,33023,12528,14680288,3158064,6307840,8409088,16777215]),this.itemsAboveHeadCount=0,this.showUiWildWarn=0,this.selectedItemInventoryIndex=0,this.soundData=null,this.statFatigue=0,this.fatigueSleeping=0,this.tradeRecipientConfirmItemsCount=0,this.tradeRecipientItemsCount=0,this.showDialogServermessage=!1,this.menuX=0,this.menuY=0,this.menuWidth=0,this.menuHeight=0,this.menuItemsCount=0,this.showUiTab=0,this.tradeItemsCount=0,this.planeWidth=0,this.planeHeight=0,this.planeMultiplier=0,this.playerQuestPoints=0,this.characterHairColours=new Int32Array([16760880,16752704,8409136,6307872,3158064,16736288,16728064,16777215,65280,65535]),this.bankActivePage=0,this.welcomeLastLoggedInDays=0,this.equipmentStatNames=["Armour","WeaponAim","WeaponPower","Magic","Prayer"],this.inventoryItemsCount=0,this.skillNameShort=["Attack","Defense","Strength","Hits","Ranged","Prayer","Magic","Cooking","Woodcut","Fletching","Fishing","Firemaking","Crafting","Smithing","Mining","Herblaw","Agility","Thieving"],this.duelOpponentNameHash=new w(0),this.minimapRandom_1=0,this.minimapRandom_2=0,this.objectCount=0,this.duelOfferItemCount=0,this.objectCount=0,this.skillNamesLong=["Attack","Defense","Strength","Hits","Ranged","Prayer","Magic","Cooking","Woodcutting","Fletching","Fishing","Firemaking","Crafting","Smithing","Mining","Herblaw","Agility","Thieving"],this.duelOfferItemCount=0,this.cameraAutoRotatePlayerX=0,this.cameraAutoRotatePlayerY=0,this.npcCombatModelArray1=new Int32Array([0,1,2,1,0,0,0,0]),this.playerCount=0,this.knownPlayerCount=0,this.spriteCount=0,this.wallObjectCount=0,this.welcomeRecoverySetDays=0,this.localLowerX=0,this.localLowerY=0,this.localUpperX=0,this.localUpperY=0,this.world=null,this.welcomeLastLoggedInIP=0,this.sleepWordDelayTimer=0,this.menuIndices=new Int32Array(this.menuMaxSize),this.cameraAutoAngleDebug=!1,this.wallObjectDirection=new Int32Array(this.wallObjectsMax),this.wallObjectId=new Int32Array(this.wallObjectsMax),this.cameraRotationXIncrement=2,this.inventoryMaxItemCount=30,this.bankItemsMax=48,this.optionMenuEntry=[],this.optionMenuEntry.length=5,this.optionMenuEntry.fill(null),this.newBankItems=new Int32Array(256),this.newBankItemsCount=new Int32Array(256),this.teleportBubbleTime=new Int32Array(50),this.showDialogTradeConfirm=!1,this.tradeConfirmAccepted=!1,this.receivedMessageX=new Int32Array(50),this.receivedMessageY=new Int32Array(50),this.receivedMessageMidPoint=new Int32Array(50),this.receivedMessageHeight=new Int32Array(50),this.localPlayer=new W,this.localPlayerServerIndex=-1,this.menuItemX=new Int32Array(this.menuMaxSize),this.menuItemY=new Int32Array(this.menuMaxSize),this.showDialogTrade=!1,this.bankItems=new Int32Array(256),this.bankItemsCount=new Int32Array(256),this.appearanceBodyGender=1,this.appearance2Colour=2,this.appearanceHairColour=2,this.appearanceTopColour=8,this.appearanceBottomColour=14,this.appearanceHeadGender=1,this.loginUser=Ci("username"),this.loginPass="",this.registerUser="",this.registerPassword="",this.cameraAngle=1,this.members=!1,this.optionSoundDisabled=!1,this.showRightClickMenu=!1,this.cameraRotationYIncrement=2,this.objectAlreadyInMenu=new Int8Array(this.objectsMax),this.menuItemText1=[],this.menuItemText1.length=this.menuMaxSize,this.menuItemText1.fill(null),this.duelOpponentName="",this.lastObjectAnimationNumberFireLightningSpell=-1,this.lastObjectAnimationNumberTorch=-1,this.lastObjectAnimationNumberClaw=-1,this.planeIndex=-1,this.welcomScreenAlreadyShown=!1,this.isSleeping=!1,this.cameraRotation=128,this.teleportBubbleX=new Int32Array(50),this.errorLoadingData=!1,this.playerExperience=new Int32Array(this.playerStatCount),this.tradeRecipientAccepted=!1,this.tradeAccepted=!1,this.mouseClickXHistory=new Int32Array(8192),this.mouseClickYHistory=new Int32Array(8192),this.showDialogWelcome=!1,this.playerServerIndexes=new Int32Array(this.playersMax),this.teleportBubbleY=new Int32Array(50),this.receivedMessages=[],this.receivedMessages.length=50,this.receivedMessages.fill(null),this.showDialogDuelConfirm=!1,this.duelAccepted=!1,this.players=[],this.players.length=this.playersMax,this.players.fill(null),this.prayerOn=[],this.menuSourceType=new Int32Array(this.menuMaxSize),this.menuSourceIndex=new Int32Array(this.menuMaxSize),this.menuTargetIndex=new Int32Array(this.menuMaxSize),this.wallObjectAlreadyInMenu=new Int8Array(this.wallObjectsMax),this.tileSize=128,this.runtimeException=!1,this.fogOfWar=!1,this.gameWidth=512,this.gameHeight=334,this.const_9=9,this.tradeConfirmItems=new Int32Array(14),this.tradeConfirmItemCount=new Int32Array(14),this.tradeRecipientName="",this.selectedSpell=-1,this.showOptionMenu=!1,this.playerStatCurrent=new Int32Array(this.playerStatCount),this.teleportBubbleType=new Int32Array(50),this.errorLoadingCodebase=!1,this.showDialogShop=!1,this.shopItem=new Int32Array(256),this.shopItemCount=new Int32Array(256),this.shopItemPrice=new Int32Array(256),this.duelOfferOpponentAccepted=!1,this.duelOfferAccepted=!1,this.gameModels=[],this.gameModels.length=1e3,this.gameModels.fill(null),this.showDialogDuel=!1,this.serverMessage="",this.serverMessageBoxTop=!1,this.duelOpponentItems=new Int32Array(8),this.duelOpponentItemCount=new Int32Array(8),this.duelItems=new Int32Array(8),this.duelItemCount=new Int32Array(8),this.playerStatBase=new Int32Array(this.playerStatCount),this.npcsCache=[],this.npcsCache.length=this.npcsMax,this.npcsCache.fill(null),this.groundItemX=new Int32Array(this.groundItemsMax),this.groundItemY=new Int32Array(this.groundItemsMax),this.groundItemId=new Int32Array(this.groundItemsMax),this.groundItemZ=new Int32Array(this.groundItemsMax),this.bankSelectedItemSlot=-1,this.bankSelectedItem=-2,this.duelOfferOpponentItemId=new Int32Array(8),this.duelOfferOpponentItemStack=new Int32Array(8),this.messageHistoryTimeout=new Int32Array(5),this.optionCameraModeAuto=!0,this.objectX=new Int32Array(this.objectsMax),this.objectY=new Int32Array(this.objectsMax),this.objectId=new Int32Array(this.objectsMax),this.objectDirection=new Int32Array(this.objectsMax),this.selectedItemInventoryIndex=-1,this.selectedItemName="",this.loadingArea=!1,this.tradeRecipientConfirmItems=new Int32Array(14),this.tradeRecipientConfirmItemCount=new Int32Array(14),this.tradeRecipientItems=new Int32Array(14),this.tradeRecipientItemCount=new Int32Array(14),this.showDialogServermessage=!1,this.menuItemID=new Int32Array(this.menuMaxSize),this.questComplete=[],this.wallObjectModel=[],this.wallObjectModel.length=this.wallObjectsMax,this.wallObjectModel.fill(null),this.actionBubbleX=new Int32Array(50),this.actionBubbleY=new Int32Array(50),this.cameraZoom=fi,this.tradeItems=new Int32Array(14),this.tradeItemCount=new Int32Array(14),this.lastHeightOffset=-1,this.duelSettingsRetreat=!1,this.duelSettingsMagic=!1,this.duelSettingsPrayer=!1,this.duelSettingsWeapons=!1,this.showDialogBank=!1,this.optionMouseButtonOne=!1,this.inventoryItemId=new Int32Array(35),this.inventoryItemStackCount=new Int32Array(35),this.inventoryEquipped=new Int32Array(35),this.knownPlayers=[],this.knownPlayers.length=this.playersMax,this.knownPlayers.fill(null),this.messageHistory=[],this.messageHistory.length=5,this.messageHistory.fill(null),this.reportAbuseMute=!1,this.duelOfferItemId=new Int32Array(8),this.duelOfferItemStack=new Int32Array(8),this.actionBubbleScale=new Int32Array(50),this.actionBubbleItem=new Int32Array(50),this.sleepWordDelay=!0,this.showAppearanceChange=!1,this.shopSelectedItemIndex=-1,this.shopSelectedItemType=-2,this.projectileFactor=40,this.npcs=[],this.npcs.length=this.npcsMax,this.npcs.fill(null),this.experienceArray=new Int32Array(99),this.healthBarX=new Int32Array(50),this.healthBarY=new Int32Array(50),this.healthBarMissing=new Int32Array(50),this.playerServer=[],this.playerServer.length=this.playersServerMax,this.playerServer.fill(null),this.walkPathX=new Int32Array(this.pathStepsMax),this.walkPathY=new Int32Array(this.pathStepsMax),this.wallObjectX=new Int32Array(this.wallObjectsMax),this.wallObjectY=new Int32Array(this.wallObjectsMax),this.menuItemText2=[],this.menuItemText2.length=this.menuMaxSize,this.menuItemText2.fill(null),this.npcsServer=[],this.npcsServer.length=this.npcsServerMax,this.npcsServer.fill(null),this.playerStatEquipment=new Int32Array(this.playerStatEquipmentCount),this.objectModel=[],this.objectModel.length=this.objectsMax,this.objectModel.fill(null)}static formatNumber(t){let e=t.toString();for(let i=e.length-3;i>0;i-=3)e=e.substring(0,i)+","+e.substring(i);return e.length>8?e="@gre@"+e.substring(0,e.length-8)+" million @whi@("+e+")":e.length>4&&(e="@cya@"+e.substring(0,e.length-4)+"K @whi@("+e+")"),e}playSoundFile(t){null!==this.audioPlayer&&(this.optionSoundDisabled||this.audioPlayer.writeStream(this.soundData,ni.getDataFileOffset(t+".pcm",this.soundData),ni.getDataFileLength(t+".pcm",this.soundData)))}drawDialogReportAbuse(){this.reportAbuseOffence=0;let t=135;for(let i=0;i<12;i++)this.mouseX>66&&this.mouseX<446&&this.mouseY>=t-12&&this.mouseY<t+3&&(this.reportAbuseOffence=i+1),t+=14;if(0!==this.mouseButtonClick&&0!==this.reportAbuseOffence)return this.mouseButtonClick=0,this.showDialogReportAbuseStep=2,this.inputTextCurrent="",void(this.inputTextFinal="");if(t+=15,0!==this.mouseButtonClick){if(this.mouseButtonClick=0,this.mouseX<56||this.mouseY<35||this.mouseX>456||this.mouseY>325)return void(this.showDialogReportAbuseStep=0);if(this.mouseX>66&&this.mouseX<446&&this.mouseY>=t-15&&this.mouseY<t+5)return void(this.showDialogReportAbuseStep=0)}this.surface.drawBox(56,35,400,290,0),this.surface.drawBoxEdge(56,35,400,290,16777215),t=50,this.surface.drawStringCenter("This form is for reporting players who are breaking our rules",256,t,1,16777215),t+=15,this.surface.drawStringCenter("Using it sends a snapshot of the last 60 secs of activity to us",256,t,1,16777215),t+=15,this.surface.drawStringCenter("If you misuse this form, you will be banned.",256,t,1,16744448),t+=15,t+=10,this.surface.drawStringCenter("First indicate which of our 12 rules is being broken. For a detailed",256,t,1,16776960),t+=15,this.surface.drawStringCenter("explanation of each rule please read the manual on our website.",256,t,1,16776960),t+=15;let e=0;1===this.reportAbuseOffence?(this.surface.drawBoxEdge(66,t-12,380,15,16777215),e=16744448):e=16777215,this.surface.drawStringCenter("1: Offensive language",256,t,1,e),t+=14,2===this.reportAbuseOffence?(this.surface.drawBoxEdge(66,t-12,380,15,16777215),e=16744448):e=16777215,this.surface.drawStringCenter("2: Item scamming",256,t,1,e),t+=14,3===this.reportAbuseOffence?(this.surface.drawBoxEdge(66,t-12,380,15,16777215),e=16744448):e=16777215,this.surface.drawStringCenter("3: Password scamming",256,t,1,e),t+=14,4===this.reportAbuseOffence?(this.surface.drawBoxEdge(66,t-12,380,15,16777215),e=16744448):e=16777215,this.surface.drawStringCenter("4: Bug abuse",256,t,1,e),t+=14,5===this.reportAbuseOffence?(this.surface.drawBoxEdge(66,t-12,380,15,16777215),e=16744448):e=16777215,this.surface.drawStringCenter("5: Jagex Staff impersonation",256,t,1,e),t+=14,6===this.reportAbuseOffence?(this.surface.drawBoxEdge(66,t-12,380,15,16777215),e=16744448):e=16777215,this.surface.drawStringCenter("6: Account sharing/trading",256,t,1,e),t+=14,7===this.reportAbuseOffence?(this.surface.drawBoxEdge(66,t-12,380,15,16777215),e=16744448):e=16777215,this.surface.drawStringCenter("7: Macroing",256,t,1,e),t+=14,8===this.reportAbuseOffence?(this.surface.drawBoxEdge(66,t-12,380,15,16777215),e=16744448):e=16777215,this.surface.drawStringCenter("8: Mutiple logging in",256,t,1,e),t+=14,9===this.reportAbuseOffence?(this.surface.drawBoxEdge(66,t-12,380,15,16777215),e=16744448):e=16777215,this.surface.drawStringCenter("9: Encouraging others to break rules",256,t,1,e),t+=14,10===this.reportAbuseOffence?(this.surface.drawBoxEdge(66,t-12,380,15,16777215),e=16744448):e=16777215,this.surface.drawStringCenter("10: Misuse of customer support",256,t,1,e),t+=14,11===this.reportAbuseOffence?(this.surface.drawBoxEdge(66,t-12,380,15,16777215),e=16744448):e=16777215,this.surface.drawStringCenter("11: Advertising / website",256,t,1,e),t+=14,12===this.reportAbuseOffence?(this.surface.drawBoxEdge(66,t-12,380,15,16777215),e=16744448):e=16777215,this.surface.drawStringCenter("12: Real world item trading",256,t,1,e),t+=14,t+=15,e=16777215,this.mouseX>196&&this.mouseX<316&&this.mouseY>t-15&&this.mouseY<t+5&&(e=16776960),this.surface.drawStringCenter("Click here to cancel",256,t,1,e)}_walkToActionSource_from8(t,e,i,r,n,o,a,h){let l=this.world.route(t,e,i,r,n,o,this.walkPathX,this.walkPathY,a);if(-1===l){if(!h)return!1;l=1,this.walkPathX[0]=i,this.walkPathY[0]=r}l--,t=this.walkPathX[l],e=this.walkPathY[l],l--,h?this.clientStream.newPacket(s.WALK_ACTION):this.clientStream.newPacket(s.WALK),this.clientStream.putShort(t+this.regionX),this.clientStream.putShort(e+this.regionY),h&&-1===l&&(t+this.regionX)%5==0&&(l=0);for(let s=l;s>=0&&s>l-25;s--)this.clientStream.putByte(this.walkPathX[s]-t),this.clientStream.putByte(this.walkPathY[s]-e);return this.clientStream.sendPacket(),this.mouseClickXStep=-24,this.mouseClickXX=this.mouseX,this.mouseClickXY=this.mouseY,!0}walkTo(t,e,i,r,n,o,a,h){let l=this.world.route(t,e,i,r,n,o,this.walkPathX,this.walkPathY,a);if(-1===l)return!1;l--,t=this.walkPathX[l],e=this.walkPathY[l],l--,h?this.clientStream.newPacket(s.WALK_ACTION):this.clientStream.newPacket(s.WALK),this.clientStream.putShort(t+this.regionX),this.clientStream.putShort(e+this.regionY),h&&-1===l&&(t+this.regionX)%5==0&&(l=0);for(let s=l;s>=0&&s>l-25;s--)this.clientStream.putByte(this.walkPathX[s]-t),this.clientStream.putByte(this.walkPathY[s]-e);return this.clientStream.sendPacket(),this.mouseClickXStep=-24,this.mouseClickXX=this.mouseX,this.mouseClickXY=this.mouseY,!0}drawMinimapEntity(t,e,i){this.surface.setPixel(t,e,i),this.surface.setPixel(t-1,e,i),this.surface.setPixel(t+1,e,i),this.surface.setPixel(t,e-1,i),this.surface.setPixel(t,e+1,i)}updateBankItems(){this.bankItemCount=this.newBankItemCount;for(let t=0;t<this.newBankItemCount;t++)this.bankItems[t]=this.newBankItems[t],this.bankItemsCount[t]=this.newBankItemsCount[t];for(let t=0;t<this.inventoryItemsCount&&!(this.bankItemCount>=this.bankItemsMax);t++){let e=this.inventoryItemId[t],i=!1;for(let t=0;t<this.bankItemCount;t++)if(this.bankItems[t]===e){i=!0;break}i||(this.bankItems[this.bankItemCount]=e,this.bankItemsCount[this.bankItemCount]=0,this.bankItemCount++)}}drawDialogWildWarn(){let t=97;this.surface.drawBox(86,77,340,180,0),this.surface.drawBoxEdge(86,77,340,180,16777215),this.surface.drawStringCenter("Warning! Proceed with caution",256,t,4,16711680),t+=26,this.surface.drawStringCenter("If you go much further north you will enter the",256,t,1,16777215),t+=13,this.surface.drawStringCenter("wilderness. This a very dangerous area where",256,t,1,16777215),t+=13,this.surface.drawStringCenter("other players can attack you!",256,t,1,16777215),t+=22,this.surface.drawStringCenter("The further north you go the more dangerous it",256,t,1,16777215),t+=13,this.surface.drawStringCenter("becomes, but the more treasure you will find.",256,t,1,16777215),t+=22,this.surface.drawStringCenter("In the wilderness an indicator at the bottom-right",256,t,1,16777215),t+=13,this.surface.drawStringCenter("of the screen will show the current level of danger",256,t,1,16777215),t+=22;let e=16777215;this.mouseY>t-12&&this.mouseY<=t&&this.mouseX>181&&this.mouseX<331&&(e=16711680),this.surface.drawStringCenter("Click here to close window",256,t,1,e),0!==this.mouseButtonClick&&(this.mouseY>t-12&&this.mouseY<=t&&this.mouseX>181&&this.mouseX<331&&(this.showUiWildWarn=2),(this.mouseX<86||this.mouseX>426||this.mouseY<77||this.mouseY>257)&&(this.showUiWildWarn=2),this.mouseButtonClick=0)}drawAboveHeadStuff(){for(let t=0;t<this.receivedMessagesCount;t++){let e=this.surface.textHeight(1),i=this.receivedMessageX[t],s=this.receivedMessageY[t],r=this.receivedMessageMidPoint[t],n=this.receivedMessageHeight[t],o=!0;for(;o;){o=!1;for(let a=0;a<t;a++)s+n>this.receivedMessageY[a]-e&&s-e<this.receivedMessageY[a]+this.receivedMessageHeight[a]&&i-r<this.receivedMessageX[a]+this.receivedMessageMidPoint[a]&&i+r>this.receivedMessageX[a]-this.receivedMessageMidPoint[a]&&this.receivedMessageY[a]-e-n<s&&(s=this.receivedMessageY[a]-e-n,o=!0)}this.receivedMessageY[t]=s,this.surface.centrepara(this.receivedMessages[t],i,s,1,16776960,300)}for(let t=0;t<this.itemsAboveHeadCount;t++){let e=this.actionBubbleX[t],i=this.actionBubbleY[t],s=this.actionBubbleScale[t],r=this.actionBubbleItem[t],n=39*s/100|0,o=27*s/100|0;this.surface.drawActionBubble(e-(n/2|0),i-o,n,o,this.spriteMedia+9,85);let a=36*s/100|0,h=24*s/100|0;this.surface._spriteClipping_from9(e-(a/2|0),i-o+(o/2|0)-(h/2|0),a,h,Be.itemPicture[r]+this.spriteItem,Be.itemMask[r],0,0,!1)}for(let t=0;t<this.healthBarCount;t++){let e=this.healthBarX[t],i=this.healthBarY[t],s=this.healthBarMissing[t];this.surface.drawBoxAlpha(e-15,i-3,s,5,65280,192),this.surface.drawBoxAlpha(e-15+s,i-3,30-s,5,16711680,192)}}_walkToActionSource_from5(t,e,i,s,r){this._walkToActionSource_from8(t,e,i,s,i,s,!1,r)}createMessageTabPanel(){this.panelGame[ai.CHAT]=new We(this.surface,10),this.controlTextListAll=this.panelGame[ai.CHAT].addTextListInput(7,324,498,14,1,80,!1,!0),this.controlTextListChat=this.panelGame[ai.CHAT].addTextList(5,269,502,56,1,20,!0),this.controlTextListQuest=this.panelGame[ai.CHAT].addTextList(5,269,502,56,1,20,!0),this.controlTextListPrivate=this.panelGame[ai.CHAT].addTextList(5,269,502,56,1,20,!0),this.panelGame[ai.CHAT].setFocus(this.controlTextListAll)}freeCacheMemory(){null!==this.surface&&(this.surface.clear(),this.surface.pixels=null,this.surface=null),null!==this.scene&&(this.scene.dispose(),this.scene=null),this.gameModels=null,this.objectModel=null,this.wallObjectModel=null,this.playerServer=null,this.players=null,this.npcsServer=null,this.npcs=null,this.localPlayer=new W,null!==this.world&&(this.world.terrainModels=null,this.world.wallModels=null,this.world.roofModels=null,this.world.parentModel=null,this.world=null)}drawUi(){if(0!==this.logoutBoxFrames)this.drawDialogLogout();else if(this.showDialogWelcome)this.drawDialogWelcome();else if(this.showDialogServermessage)this.drawDialogServermessage();else if(1===this.showUiWildWarn)this.drawDialogWildWarn();else if(this.showDialogBank&&0===this.combatTimeout)this.drawDialogBank();else if(this.showDialogShop&&0===this.combatTimeout)this.drawDialogShop();else if(this.showDialogTradeConfirm)this.drawDialogTradeConfirm();else if(this.showDialogTrade)this.drawDialogTrade();else if(this.showDialogDuelConfirm)this.drawDialogDuelConfirm();else if(this.showDialogDuel)this.drawDialogDuel();else if(1===this.showDialogReportAbuseStep)this.drawDialogReportAbuse();else if(2===this.showDialogReportAbuseStep)this.drawDialogReportAbuseInput();else if(0!==this.showDialogSocialInput)this.drawDialogSocialInput();else{this.showOptionMenu&&this.drawOptionMenu(),this.localPlayer.isFighting()&&this.drawDialogCombatStyle(),this.updateActiveTab();let t=!this.showOptionMenu&&!this.showRightClickMenu;t&&(this.menuItemsCount=0,0===this.showUiTab&&this.createRightClickMenu()),1===this.showUiTab&&this.drawUiTabInventory(t),2===this.showUiTab&&this.drawUiTabMinimap(t),3===this.showUiTab&&this.drawUiTabPlayerInfo(t),4===this.showUiTab&&this.drawUiTabMagic(t),5===this.showUiTab&&this.drawUiTabSocial(t),6===this.showUiTab&&this.drawUiTabOptions(t),this.showOptionMenu||(this.showRightClickMenu?this.drawRightClickMenu():this.refreshRightClickMenu())}this.mouseButtonClick=0}drawDialogTrade(){if(0!==this.mouseButtonClick&&0===this.mouseButtonItemCountIncrement&&(this.mouseButtonItemCountIncrement=1),this.mouseButtonItemCountIncrement>0){let t=this.mouseX-22,e=this.mouseY-36;if(t>=0&&e>=0&&t<468&&e<262){if(t>216&&e>30&&t<462&&e<235){let i=((t-217)/49|0)+5*((e-31)/34|0);if(i>=0&&i<this.inventoryItemsCount){let t=!1,e=0,r=this.inventoryItemId[i];for(let s=0;s<this.tradeItemsCount;s++)if(this.tradeItems[s]===r)if(0===Be.itemStackable[r])for(let e=0;e<this.mouseButtonItemCountIncrement;e++)this.tradeItemCount[s]<this.inventoryItemStackCount[i]&&this.tradeItemCount[s]++,t=!0;else e++;if(this.getInventoryCount(r)<=e&&(t=!0),1===Be.itemSpecial[r]&&(this.showMessage("This object cannot be traded with other players",3),t=!0),!t&&this.tradeItemsCount<12&&(this.tradeItems[this.tradeItemsCount]=r,this.tradeItemCount[this.tradeItemsCount]=1,this.tradeItemsCount++,t=!0),t){this.clientStream.newPacket(s.TRADE_ITEM_UPDATE),this.clientStream.putByte(this.tradeItemsCount);for(let t=0;t<this.tradeItemsCount;t++)this.clientStream.putShort(this.tradeItems[t]),this.clientStream.putInt(this.tradeItemCount[t]);this.clientStream.sendPacket(),this.tradeRecipientAccepted=!1,this.tradeAccepted=!1}}}if(t>8&&e>30&&t<205&&e<133){let i=((t-9)/49|0)+4*((e-31)/34|0);if(i>=0&&i<this.tradeItemsCount){let t=this.tradeItems[i];for(let e=0;e<this.mouseButtonItemCountIncrement;e++){if(!(0===Be.itemStackable[t]&&this.tradeItemCount[i]>1)){this.tradeItemsCount--,this.mouseButtonDownTime=0;for(let t=i;t<this.tradeItemsCount;t++)this.tradeItems[t]=this.tradeItems[t+1],this.tradeItemCount[t]=this.tradeItemCount[t+1];break}this.tradeItemCount[i]--}this.clientStream.newPacket(s.TRADE_ITEM_UPDATE),this.clientStream.putByte(this.tradeItemsCount);for(let e=0;e<this.tradeItemsCount;e++)this.clientStream.putShort(this.tradeItems[e]),this.clientStream.putInt(this.tradeItemCount[e]);this.clientStream.sendPacket(),this.tradeRecipientAccepted=!1,this.tradeAccepted=!1}}t>=217&&e>=238&&t<=286&&e<=259&&(this.tradeAccepted=!0,this.clientStream.newPacket(s.TRADE_ACCEPT),this.clientStream.sendPacket()),t>=394&&e>=238&&t<463&&e<259&&(this.showDialogTrade=!1,this.clientStream.newPacket(s.TRADE_DECLINE),this.clientStream.sendPacket())}else 0!==this.mouseButtonClick&&(this.showDialogTrade=!1,this.clientStream.newPacket(s.TRADE_DECLINE),this.clientStream.sendPacket());this.mouseButtonClick=0,this.mouseButtonItemCountIncrement=0}if(this.showDialogTrade){this.surface.drawBox(22,36,468,12,192),this.surface.drawBoxAlpha(22,48,468,18,10000536,160),this.surface.drawBoxAlpha(22,66,8,248,10000536,160),this.surface.drawBoxAlpha(227,66,11,248,10000536,160),this.surface.drawBoxAlpha(484,66,6,248,10000536,160),this.surface.drawBoxAlpha(30,169,197,22,10000536,160),this.surface.drawBoxAlpha(30,294,197,20,10000536,160),this.surface.drawBoxAlpha(238,271,246,43,10000536,160),this.surface.drawBoxAlpha(30,66,197,103,13684944,160),this.surface.drawBoxAlpha(30,191,197,103,13684944,160),this.surface.drawBoxAlpha(238,66,246,205,13684944,160);for(let t=0;t<4;t++)this.surface.drawLineHoriz(30,66+34*t,197,0);for(let t=0;t<4;t++)this.surface.drawLineHoriz(30,191+34*t,197,0);for(let t=0;t<7;t++)this.surface.drawLineHoriz(238,66+34*t,246,0);for(let t=0;t<6;t++)t<5&&this.surface.drawLineVert(30+49*t,66,103,0),t<5&&this.surface.drawLineVert(30+49*t,191,103,0),this.surface.drawLineVert(238+49*t,66,205,0);this.surface.drawString("Trading with: "+this.tradeRecipientName,23,46,1,16777215),this.surface.drawString("Your Offer",31,63,4,16777215),this.surface.drawString("Opponent's Offer",31,188,4,16777215),this.surface.drawString("Your Inventory",238,63,4,16777215),this.tradeAccepted||this.surface.drawSpriteID(239,274,this.spriteMedia+25),this.surface.drawSpriteID(416,274,this.spriteMedia+26),this.tradeRecipientAccepted&&(this.surface.drawStringCenter("Other player",363,282,1,16777215),this.surface.drawStringCenter("has accepted",363,292,1,16777215)),this.tradeAccepted&&(this.surface.drawStringCenter("Waiting for",274,282,1,16777215),this.surface.drawStringCenter("other player",274,292,1,16777215));for(let t=0;t<this.inventoryItemsCount;t++){let e=239+t%5*49,i=67+34*(t/5|0);this.surface._spriteClipping_from9(e,i,48,32,this.spriteItem+Be.itemPicture[this.inventoryItemId[t]],Be.itemMask[this.inventoryItemId[t]],0,0,!1),0===Be.itemStackable[this.inventoryItemId[t]]&&this.surface.drawString(this.inventoryItemStackCount[t].toString(),e+1,i+10,1,16776960)}for(let t=0;t<this.tradeItemsCount;t++){let e=31+t%4*49,i=67+34*(t/4|0);this.surface._spriteClipping_from9(e,i,48,32,this.spriteItem+Be.itemPicture[this.tradeItems[t]],Be.itemMask[this.tradeItems[t]],0,0,!1),0===Be.itemStackable[this.tradeItems[t]]&&this.surface.drawString(this.tradeItemCount[t].toString(),e+1,i+10,1,16776960),this.mouseX>e&&this.mouseX<e+48&&this.mouseY>i&&this.mouseY<i+32&&this.surface.drawString(Be.itemName[this.tradeItems[t]]+": @whi@"+Be.itemDescription[this.tradeItems[t]],30,309,1,16776960)}for(let t=0;t<this.tradeRecipientItemsCount;t++){let e=31+t%4*49,i=192+34*(t/4|0);this.surface._spriteClipping_from9(e,i,48,32,this.spriteItem+Be.itemPicture[this.tradeRecipientItems[t]],Be.itemMask[this.tradeRecipientItems[t]],0,0,!1),0===Be.itemStackable[this.tradeRecipientItems[t]]&&this.surface.drawString(this.tradeRecipientItemCount[t].toString(),e+1,i+10,1,16776960),this.mouseX>e&&this.mouseX<e+48&&this.mouseY>i&&this.mouseY<i+32&&this.surface.drawString(Be.itemName[this.tradeRecipientItems[t]]+": @whi@"+Be.itemDescription[this.tradeRecipientItems[t]],30,309,1,16776960)}}}resetGame(){this.resetLoginVars(),this.gameState=oi.WORLD,this.combatStyle=0,this.resetPMText(),this.surface.blackScreen(),this.surface.draw(this.graphics,0,0);for(let t=0;t<this.objectCount;t++)this.scene.removeModel(this.objectModel[t]),this.world.removeObject(this.objectX[t],this.objectY[t],this.objectId[t]);for(let t=0;t<this.wallObjectCount;t++)this.scene.removeModel(this.wallObjectModel[t]),this.world.removeWallObject(this.wallObjectX[t],this.wallObjectY[t],this.wallObjectDirection[t],this.wallObjectId[t]);this.objectCount=0,this.wallObjectCount=0,this.groundItemCount=0,this.playerCount=0;for(let t=0;t<this.playersServerMax;t++)this.playerServer[t]=null;for(let t=0;t<this.playersMax;t++)this.players[t]=null;this.npcCount=0;for(let t=0;t<this.npcsServerMax;t++)this.npcsServer[t]=null;for(let t=0;t<this.npcsMax;t++)this.npcs[t]=null;for(let t=0;t<14;t++)this.prayerOn[t]=!1;this.mouseButtonClick=0,this.lastMouseButtonDown=0,this.mouseButtonDown=0,this.showDialogShop=!1,this.showDialogBank=!1,this.isSleeping=!1,this.friendListCount=0}drawUiTabSocial(t){let e=this.surface.width2-199,i=36;this.surface.drawSpriteID(e-49,3,this.spriteMedia+5);let s=0,r=s=gt.rgbToLong(160,160,160);if(0===this.uiTabSocialSubTab?r=gt.rgbToLong(220,220,220):s=gt.rgbToLong(220,220,220),this.surface.drawBoxAlpha(e,i,98,24,r,128),this.surface.drawBoxAlpha(e+98,i,98,24,s,128),this.surface.drawBoxAlpha(e,i+24,196,158,gt.rgbToLong(220,220,220),128),this.surface.drawLineHoriz(e,i+24,196,0),this.surface.drawLineVert(e+98,i,24,0),this.surface.drawLineHoriz(e,i+182-16,196,0),this.surface.drawStringCenter("Friends",e+49,i+16,4,0),this.surface.drawStringCenter("Ignore",e+49+98,i+16,4,0),this.panelSocialList.clearList(this.controlListSocialPlayers),0===this.uiTabSocialSubTab)for(let n=0;n<this.friendListCount;n++){let t=null;t=255===this.friendListOnline[n]?"@gre@":this.friendListOnline[n]>0?"@yel@":"@red@",this.panelSocialList.addListEntry(this.controlListSocialPlayers,n,t+ni.hashToUsername(this.friendListHashes[n])+"~439~@whi@Remove         WWWWWWWWWW")}if(1===this.uiTabSocialSubTab)for(let n=0;n<this.ignoreListCount;n++)this.panelSocialList.addListEntry(this.controlListSocialPlayers,n,"@yel@"+ni.hashToUsername(this.ignoreList[n])+"~439~@whi@Remove         WWWWWWWWWW");if(this.panelSocialList.render(),0===this.uiTabSocialSubTab){let t=this.panelSocialList.getListEntryIndex(this.controlListSocialPlayers);t>=0&&this.mouseX<489?this.mouseX>429?this.surface.drawStringCenter("Click to remove "+ni.hashToUsername(this.friendListHashes[t]),e+98,i+35,1,16777215):255===this.friendListOnline[t]?this.surface.drawStringCenter("Click to message "+ni.hashToUsername(this.friendListHashes[t]),e+98,i+35,1,16777215):this.friendListOnline[t]>0?this.friendListOnline[t]<200?this.surface.drawStringCenter(ni.hashToUsername(this.friendListHashes[t])+" is on world "+(this.friendListOnline[t]-9),e+98,i+35,1,16777215):this.surface.drawStringCenter(ni.hashToUsername(this.friendListHashes[t])+" is on classic "+(this.friendListOnline[t]-219),e+98,i+35,1,16777215):this.surface.drawStringCenter(ni.hashToUsername(this.friendListHashes[t])+" is offline",e+98,i+35,1,16777215):this.surface.drawStringCenter("Click a name to send a message",e+98,i+35,1,16777215);let s=0;s=this.mouseX>e&&this.mouseX<e+196&&this.mouseY>i+182-16&&this.mouseY<i+182?16776960:16777215,this.surface.drawStringCenter("Click here to add a friend",e+98,i+182-3,1,s)}if(1===this.uiTabSocialSubTab){let t=this.panelSocialList.getListEntryIndex(this.controlListSocialPlayers);t>=0&&this.mouseX<489&&this.mouseX>429?this.mouseX>429&&this.surface.drawStringCenter("Click to remove "+ni.hashToUsername(this.ignoreList[t]),e+98,i+35,1,16777215):this.surface.drawStringCenter("Blocking messages from:",e+98,i+35,1,16777215);let s=0;s=this.mouseX>e&&this.mouseX<e+196&&this.mouseY>i+182-16&&this.mouseY<i+182?16776960:16777215,this.surface.drawStringCenter("Click here to add a name",e+98,i+182-3,1,s)}if(t&&(e=this.mouseX-(this.surface.width2-199),i=this.mouseY-36,e>=0&&i>=0&&e<196&&i<182)){if(this.panelSocialList.handleMouse(e+(this.surface.width2-199),i+36,this.lastMouseButtonDown,this.mouseButtonDown,this.mouseScrollDelta),i<=24&&1===this.mouseButtonClick&&(e<98&&1===this.uiTabSocialSubTab?(this.uiTabSocialSubTab=0,this.panelSocialList.resetListProps(this.controlListSocialPlayers)):e>98&&0===this.uiTabSocialSubTab&&(this.uiTabSocialSubTab=1,this.panelSocialList.resetListProps(this.controlListSocialPlayers))),1===this.mouseButtonClick&&0===this.uiTabSocialSubTab){let t=this.panelSocialList.getListEntryIndex(this.controlListSocialPlayers);t>=0&&this.mouseX<489&&(this.mouseX>429?this.friendRemove(this.friendListHashes[t]):0!==this.friendListOnline[t]&&(this.showDialogSocialInput=2,this.privateMessageTarget=this.friendListHashes[t],this.inputPmCurrent="",this.inputPmFinal=""))}if(1===this.mouseButtonClick&&1===this.uiTabSocialSubTab){let t=this.panelSocialList.getListEntryIndex(this.controlListSocialPlayers);t>=0&&this.mouseX<489&&this.mouseX>429&&this.ignoreRemove(this.ignoreList[t])}i>166&&1===this.mouseButtonClick&&0===this.uiTabSocialSubTab&&(this.showDialogSocialInput=1,this.inputTextCurrent="",this.inputTextFinal=""),i>166&&1===this.mouseButtonClick&&1===this.uiTabSocialSubTab&&(this.showDialogSocialInput=3,this.inputTextCurrent="",this.inputTextFinal=""),this.mouseButtonClick=0}}sendLogout(){if(this.gameState===oi.WORLD){if(this.combatTimeout>0)return this.combatTimeout>450?void this.showMessage("@cya@You can't logout during combat!",3):void this.showMessage("@cya@You can't logout for 10 seconds after combat",3);this.clientStream.newPacket(s.LOGOUT),this.clientStream.sendPacket(),this.logoutBoxFrames=1e3}}createPlayer(t,e,i,s){null===this.playerServer[t]&&(this.playerServer[t]=new W,this.playerServer[t].serverIndex=t,this.playerServer[t].serverId=0);let r=this.playerServer[t],n=!1;for(let o=0;o<this.knownPlayerCount;o++)if(this.knownPlayers[o].serverIndex===t){n=!0;break}if(n){r.animationNext=s;let t=r.waypointCurrent;e===r.waypointsX[t]&&i===r.waypointsY[t]||(r.waypointCurrent=t=(t+1)%10,r.waypointsX[t]=e,r.waypointsY[t]=i)}else r.serverIndex=t,r.movingStep=0,r.waypointCurrent=0,r.waypointsX[0]=r.currentX=e,r.waypointsY[0]=r.currentY=i,r.animationNext=r.animationCurrent=s,r.stepCount=0;return this.players[this.playerCount++]=r,r}drawDialogSocialInput(){if(0!==this.mouseButtonClick){if(this.mouseButtonClick=0,1===this.showDialogSocialInput&&(this.mouseX<106||this.mouseY<145||this.mouseX>406||this.mouseY>215))return void(this.showDialogSocialInput=0);if(2===this.showDialogSocialInput&&(this.mouseX<6||this.mouseY<145||this.mouseX>506||this.mouseY>215))return void(this.showDialogSocialInput=0);if(3===this.showDialogSocialInput&&(this.mouseX<106||this.mouseY<145||this.mouseX>406||this.mouseY>215))return void(this.showDialogSocialInput=0);if(this.mouseX>236&&this.mouseX<276&&this.mouseY>193&&this.mouseY<213)return void(this.showDialogSocialInput=0)}let t=145;if(1===this.showDialogSocialInput&&(this.surface.drawBox(106,t,300,70,0),this.surface.drawBoxEdge(106,t,300,70,16777215),t+=20,this.surface.drawStringCenter("Enter name to add to friends list",256,t,4,16777215),t+=20,this.surface.drawStringCenter(this.inputTextCurrent+"*",256,t,4,16777215),this.inputTextFinal.length>0)){let t=this.inputTextFinal.trim();this.inputTextCurrent="",this.inputTextFinal="",this.showDialogSocialInput=0,t.length>0&&!ni.encodeBase37(t).equals(this.localPlayer.hash)&&this.friendAdd(t)}if(2===this.showDialogSocialInput&&(this.surface.drawBox(6,t,500,70,0),this.surface.drawBoxEdge(6,t,500,70,16777215),t+=20,this.surface.drawStringCenter("Enter message to send to "+ni.hashToUsername(this.privateMessageTarget),256,t,4,16777215),t+=20,this.surface.drawStringCenter(this.inputPmCurrent+"*",256,t,4,16777215),this.inputPmFinal.length>0)){let t=this.inputPmFinal;this.inputPmCurrent="",this.inputPmFinal="",this.showDialogSocialInput=0;let e=ri(t);this.sendPrivateMessage(this.privateMessageTarget,e,e.length),t=si(e),t=li(t),this.showServerMessage("@pri@You tell "+ni.hashToUsername(this.privateMessageTarget)+": "+t)}if(3===this.showDialogSocialInput&&(this.surface.drawBox(106,t,300,70,0),this.surface.drawBoxEdge(106,t,300,70,16777215),t+=20,this.surface.drawStringCenter("Enter name to add to ignore list",256,t,4,16777215),t+=20,this.surface.drawStringCenter(this.inputTextCurrent+"*",256,t,4,16777215),this.inputTextFinal.length>0)){let t=this.inputTextFinal.trim();this.inputTextCurrent="",this.inputTextFinal="",this.showDialogSocialInput=0,t.length>0&&!ni.encodeBase37(t).equals(this.localPlayer.hash)&&this.ignoreAdd(t)}let e=16777215;this.mouseX>236&&this.mouseX<276&&this.mouseY>193&&this.mouseY<213&&(e=16776960),this.surface.drawStringCenter("Cancel",256,208,1,e)}createAppearancePanel(){this.panelGame[ai.APPEARANCE]=new We(this.surface,100),this.panelGame[ai.APPEARANCE].addText(256,10,"Please design Your Character",4,!0);let t=140,e=34;t+=116,e-=10,this.panelGame[ai.APPEARANCE].addText(201,e+110,"Front",3,!0),this.panelGame[ai.APPEARANCE].addText(t,e+110,"Side",3,!0),this.panelGame[ai.APPEARANCE].addText(311,e+110,"Back",3,!0),e+=145,this.panelGame[ai.APPEARANCE].addBoxRounded(202,e,53,41),this.panelGame[ai.APPEARANCE].addText(202,e-8,"Head",1,!0),this.panelGame[ai.APPEARANCE].addText(202,e+8,"Type",1,!0),this.panelGame[ai.APPEARANCE].addSprite(162,e,We.baseSpriteStart+7),this.controlButtonAppearanceHead1=this.panelGame[ai.APPEARANCE].addButton(162,e,20,20),this.panelGame[ai.APPEARANCE].addSprite(242,e,We.baseSpriteStart+6),this.controlButtonAppearanceHead2=this.panelGame[ai.APPEARANCE].addButton(242,e,20,20),this.panelGame[ai.APPEARANCE].addBoxRounded(310,e,53,41),this.panelGame[ai.APPEARANCE].addText(310,e-8,"Hair",1,!0),this.panelGame[ai.APPEARANCE].addText(310,e+8,"Color",1,!0),this.panelGame[ai.APPEARANCE].addSprite(270,e,We.baseSpriteStart+7),this.controlButtonAppearanceHair1=this.panelGame[ai.APPEARANCE].addButton(270,e,20,20),this.panelGame[ai.APPEARANCE].addSprite(350,e,We.baseSpriteStart+6),this.controlButtonAppearanceHair2=this.panelGame[ai.APPEARANCE].addButton(350,e,20,20),e+=50,this.panelGame[ai.APPEARANCE].addBoxRounded(202,e,53,41),this.panelGame[ai.APPEARANCE].addText(202,e,"Gender",1,!0),this.panelGame[ai.APPEARANCE].addSprite(162,e,We.baseSpriteStart+7),this.controlButtonAppearanceGender1=this.panelGame[ai.APPEARANCE].addButton(162,e,20,20),this.panelGame[ai.APPEARANCE].addSprite(242,e,We.baseSpriteStart+6),this.controlButtonAppearanceGender2=this.panelGame[ai.APPEARANCE].addButton(242,e,20,20),this.panelGame[ai.APPEARANCE].addBoxRounded(310,e,53,41),this.panelGame[ai.APPEARANCE].addText(310,e-8,"Top",1,!0),this.panelGame[ai.APPEARANCE].addText(310,e+8,"Color",1,!0),this.panelGame[ai.APPEARANCE].addSprite(270,e,We.baseSpriteStart+7),this.controlButtonAppearanceTop1=this.panelGame[ai.APPEARANCE].addButton(270,e,20,20),this.panelGame[ai.APPEARANCE].addSprite(350,e,We.baseSpriteStart+6),this.controlButtonAppearanceTop2=this.panelGame[ai.APPEARANCE].addButton(350,e,20,20),e+=50,this.panelGame[ai.APPEARANCE].addBoxRounded(202,e,53,41),this.panelGame[ai.APPEARANCE].addText(202,e-8,"Skin",1,!0),this.panelGame[ai.APPEARANCE].addText(202,e+8,"Color",1,!0),this.panelGame[ai.APPEARANCE].addSprite(162,e,We.baseSpriteStart+7),this.controlButtonAppearanceSkin1=this.panelGame[ai.APPEARANCE].addButton(162,e,20,20),this.panelGame[ai.APPEARANCE].addSprite(242,e,We.baseSpriteStart+6),this.controlButtonAppearanceSkin2=this.panelGame[ai.APPEARANCE].addButton(242,e,20,20),this.panelGame[ai.APPEARANCE].addBoxRounded(310,e,53,41),this.panelGame[ai.APPEARANCE].addText(310,e-8,"Bottom",1,!0),this.panelGame[ai.APPEARANCE].addText(310,e+8,"Color",1,!0),this.panelGame[ai.APPEARANCE].addSprite(270,e,We.baseSpriteStart+7),this.controlButtonAppearanceBottom1=this.panelGame[ai.APPEARANCE].addButton(270,e,20,20),this.panelGame[ai.APPEARANCE].addSprite(350,e,We.baseSpriteStart+6),this.controlButtonAppearanceBottom2=this.panelGame[ai.APPEARANCE].addButton(350,e,20,20),e+=82,e-=35,this.panelGame[ai.APPEARANCE].addButtonBackground(t,e,200,30),this.panelGame[ai.APPEARANCE].addText(t,e,"Accept",4,!1),this.controlButtonAppearanceAccept=this.panelGame[ai.APPEARANCE].addButton(t,e,200,30)}resetPMText(){this.inputPmCurrent="",this.inputPmFinal=""}drawDialogWelcome(){let t=65;201!==this.welcomeRecoverySetDays&&(t+=60),this.welcomeUnreadMessages>0&&(t+=60),0!==this.welcomeLastLoggedInIP&&(t+=45);let e=167-(t/2|0);this.surface.drawBox(56,167-(t/2|0),400,t,0),this.surface.drawBoxEdge(56,167-(t/2|0),400,t,16777215),e+=20,this.surface.drawStringCenter("Welcome to RuneScape "+this.loginUser,256,e,4,16776960),e+=30;let i=null;if(i=0===this.welcomeLastLoggedInDays?"earlier today":1===this.welcomeLastLoggedInDays?"yesterday":this.welcomeLastLoggedInDays+" days ago",0!==this.welcomeLastLoggedInIP&&(this.surface.drawStringCenter("You last logged in "+i,256,e,1,16777215),e+=15,null===this.welcomeLastLoggedInHost&&(this.welcomeLastLoggedInHost=this.getHostnameIP(this.welcomeLastLoggedInIP)),this.surface.drawStringCenter("from: "+this.welcomeLastLoggedInHost,256,e,1,16777215),e+=15,e+=15),this.welcomeUnreadMessages>0){let t=16777215;this.surface.drawStringCenter("Jagex staff will NEVER email you. We use the",256,e,1,t),e+=15,this.surface.drawStringCenter("message-centre on this website instead.",256,e,1,t),e+=15,1===this.welcomeUnreadMessages?this.surface.drawStringCenter("You have @yel@0@whi@ unread messages in your message-centre",256,e,1,16777215):this.surface.drawStringCenter("You have @gre@"+(this.welcomeUnreadMessages-1)+" unread messages @whi@in your message-centre",256,e,1,16777215),e+=15,e+=15}if(0===this.welcomeRecoverySetDays)this.surface.drawStringCenter("You have not yet set any password recovery questions.",256,e,1,16744448),e+=15,this.surface.drawStringCenter("We strongly recommend you do so now to secure your account.",256,e,1,16744448),e+=15,this.surface.drawStringCenter("Do this from the 'account management' area on our front webpage",256,e,1,16744448),e+=15;else if(201!==this.welcomeRecoverySetDays){this.welcomeRecoverySetDays--;let t=this.welcomeRecoverySetDays+" days ago";0===this.welcomeRecoverySetDays?t="Earlier today":1===this.welcomeRecoverySetDays&&(t="Yesterday"),this.surface.drawStringCenter(t+" you changed your recovery questions",255,e,1,16744448),e+=15,this.surface.drawStringCenter("If you do not remember making this change then cancel it immediately",255,e,1,16744448),e+=15,this.surface.drawStringCenter("Do this from the 'account management' area on our front webpage",255,e,1,16744448),e+=15,e+=15}let s=16777215;this.mouseY>e-12&&this.mouseY<=e&&this.mouseX>106&&this.mouseX<406&&(s=16711680),this.surface.drawStringCenter("Click here to close window",256,e,1,s),1===this.mouseButtonClick&&(16711680===s&&(this.showDialogWelcome=!1),(this.mouseX<86||this.mouseX>426)&&(this.mouseY<167-(t/2|0)||this.mouseY>167+(t/2|0))&&(this.showDialogWelcome=!1)),this.mouseButtonClick=0}drawAppearancePanelCharacterSprites(){this.surface.interlace=!1,this.surface.blackScreen(),this.panelGame[ai.APPEARANCE].render();let t=140,e=50;t+=116,e-=25,this.surface._spriteClipping_from6(169,e,64,102,Be.animationNumber[this.appearance2Colour],this.characterTopBottomColours[this.appearanceBottomColour]),this.surface._spriteClipping_from9(169,e,64,102,Be.animationNumber[this.appearanceBodyGender],this.characterTopBottomColours[this.appearanceTopColour],this.characterSkinColours[this.appearanceSkinColour],0,!1),this.surface._spriteClipping_from9(169,e,64,102,Be.animationNumber[this.appearanceHeadType],this.characterHairColours[this.appearanceHairColour],this.characterSkinColours[this.appearanceSkinColour],0,!1),this.surface._spriteClipping_from6(224,e,64,102,Be.animationNumber[this.appearance2Colour]+6,this.characterTopBottomColours[this.appearanceBottomColour]),this.surface._spriteClipping_from9(224,e,64,102,Be.animationNumber[this.appearanceBodyGender]+6,this.characterTopBottomColours[this.appearanceTopColour],this.characterSkinColours[this.appearanceSkinColour],0,!1),this.surface._spriteClipping_from9(224,e,64,102,Be.animationNumber[this.appearanceHeadType]+6,this.characterHairColours[this.appearanceHairColour],this.characterSkinColours[this.appearanceSkinColour],0,!1),this.surface._spriteClipping_from6(279,e,64,102,Be.animationNumber[this.appearance2Colour]+12,this.characterTopBottomColours[this.appearanceBottomColour]),this.surface._spriteClipping_from9(279,e,64,102,Be.animationNumber[this.appearanceBodyGender]+12,this.characterTopBottomColours[this.appearanceTopColour],this.characterSkinColours[this.appearanceSkinColour],0,!1),this.surface._spriteClipping_from9(279,e,64,102,Be.animationNumber[this.appearanceHeadType]+12,this.characterHairColours[this.appearanceHairColour],this.characterSkinColours[this.appearanceSkinColour],0,!1),this.surface.drawSpriteID(0,this.gameHeight,this.spriteMedia+22),this.surface.draw(this.graphics,0,0)}drawItem(t,e,i,s,r,n,o){let a=Be.itemPicture[r]+this.spriteItem,h=Be.itemMask[r];this.surface._spriteClipping_from9(t,e,i,s,a,h,0,0,!1)}async handleGameInput(){if(await this.checkConnection(),this.systemUpdate>1&&this.systemUpdate--,this.logoutBoxFrames>0&&this.logoutBoxFrames--,this.combatTimeout>0&&this.combatTimeout--,this.deathScreenTimeout>0&&(this.deathScreenTimeout--,0===this.deathScreenTimeout&&(this.showMessage("You have been granted another life. Be more careful this time!",3),this.showMessage("You retain your skills. Your objects land where you died",3))),this.localPlayer.isFighting()&&(this.combatTimeout=500),this.showAppearanceChange)this.handleAppearancePanelControls();else{for(let t=0;t<this.playerCount;t++){let e=this.players[t];if(!e)return void console.log("null character at ",t,this.playerCount);e.messageTimeout>0&&e.messageTimeout--,e.bubbleTimeout>0&&e.bubbleTimeout--,e.combatTimer>0&&e.combatTimer--,e.projectileRange>0&&e.projectileRange--;let i=(e.waypointCurrent+1)%10;if(e.movingStep!==i){let t=e.movingStep,s=i-t;s<1&&(s+=10);let r=4*Math.max(1,s-1),n=-1;if(Math.abs(e.waypointsX[t]-e.currentX)>3*this.tileSize||Math.abs(e.waypointsY[t]-e.currentY)>3*this.tileSize||s>8)e.currentX=e.waypointsX[t],e.currentY=e.waypointsY[t];else{let i=e.currentX-e.waypointsX[t],s=e.currentY-e.waypointsY[t];0!==i&&(e.stepCount++,i>0?(n=6,e.currentX-=r):(n=2,e.currentX+=r),Math.abs(e.currentX-e.waypointsX[t])<r&&(e.currentX=e.waypointsX[t])),0!==s&&(e.stepCount++,s<0?(e.currentY+=r,n=-1===n?4:2===n?3:5):(e.currentY-=r,n=-1===n?0:2===n?1:7),Math.abs(e.currentY-e.waypointsY[t])<r&&(e.currentY=e.waypointsY[t]))}-1!==n&&(e.animationCurrent=n),e.currentX===e.waypointsX[t]&&e.currentY===e.waypointsY[t]&&(e.movingStep=(t+1)%10)}else e.animationCurrent=e.animationNext}for(let t=0;t<this.npcCount;t++){let e=this.npcs[t];if(!e)return void console.log("null character at ",i,this.playerCount);e.messageTimeout>0&&e.messageTimeout--,e.bubbleTimeout>0&&e.bubbleTimeout--,e.combatTimer>0&&e.combatTimer--;let s=(e.waypointCurrent+1)%10;if(e.movingStep!==s){let t,i=-1,r=e.movingStep,n=4;(t=r<s?s-r:10+s-r)>2&&(n=4*(t-1)),e.waypointsX[r]-e.currentX>3*this.tileSize||e.waypointsY[r]-e.currentY>3*this.tileSize||e.waypointsX[r]-e.currentX<3*-this.tileSize||e.waypointsY[r]-e.currentY<3*-this.tileSize||t>8?(e.currentX=e.waypointsX[r],e.currentY=e.waypointsY[r]):(e.currentX<e.waypointsX[r]?(e.currentX+=n,e.stepCount++,i=2):e.currentX>e.waypointsX[r]&&(e.currentX-=n,e.stepCount++,i=6),e.currentX-e.waypointsX[r]<n&&e.currentX-e.waypointsX[r]>-n&&(e.currentX=e.waypointsX[r]),e.currentY<e.waypointsY[r]?(e.currentY+=n,e.stepCount++,i=-1===i?4:2===i?3:5):e.currentY>e.waypointsY[r]&&(e.currentY-=n,e.stepCount++,i=-1===i?0:2===i?1:7),e.currentY-e.waypointsY[r]<n&&e.currentY-e.waypointsY[r]>-n&&(e.currentY=e.waypointsY[r])),-1!==i&&(e.animationCurrent=i),e.currentX===e.waypointsX[r]&&e.currentY===e.waypointsY[r]&&(e.movingStep=(r+1)%10)}else e.animationCurrent=e.animationNext,43===e.npcId&&e.stepCount++}if(2!==this.showUiTab&&(gt.anInt346>0&&this.sleepWordDelayTimer++,gt.anInt347>0&&(this.sleepWordDelayTimer=0),gt.anInt346=0,gt.anInt347=0),(this.cameraAutoRotatePlayerX-this.localPlayer.currentX<-500||this.cameraAutoRotatePlayerX-this.localPlayer.currentX>500||this.cameraAutoRotatePlayerY-this.localPlayer.currentY<-500||this.cameraAutoRotatePlayerY-this.localPlayer.currentY>500)&&(this.cameraAutoRotatePlayerX=this.localPlayer.currentX,this.cameraAutoRotatePlayerY=this.localPlayer.currentY),!this.cameraAutoAngleDebug&&(this.cameraAutoRotatePlayerX!==this.localPlayer.currentX&&(this.cameraAutoRotatePlayerX+=(this.localPlayer.currentX-this.cameraAutoRotatePlayerX)/(16+((this.cameraZoom-500)/15|0))|0),this.cameraAutoRotatePlayerY!==this.localPlayer.currentY&&(this.cameraAutoRotatePlayerY+=(this.localPlayer.currentY-this.cameraAutoRotatePlayerY)/(16+((this.cameraZoom-500)/15|0))|0),this.optionCameraModeAuto)){let t=32*this.cameraAngle;if(t===this.cameraRotation)this.anInt707=0;else{let e=Math.abs(t-this.cameraRotation);e>128&&(e=256-e);let i=++this.anInt707*e+255>>8;this.cameraRotation+=t<this.cameraRotation?-i:i,this.cameraRotation&=255}}if(this.sleepWordDelayTimer>20&&(this.sleepWordDelay=!1,this.sleepWordDelayTimer=0),this.isSleeping)return this.inputTextFinal.length>0&&(/^::lostcon$/i.test(this.inputTextFinal)?this.clientStream.closeStream():/^::closecon$/.test(this.inputTextFinal)?this.closeConnection():this.doGuessCaptcha(this.inputTextFinal)),1===this.lastMouseButtonDown&&this.mouseY>275&&this.mouseY<310&&this.mouseX>56&&this.mouseX<456&&this.doGuessCaptcha("-null-"),void(this.lastMouseButtonDown=0);if(this.mouseY>this.gameHeight-4&&(this.mouseX>15&&this.mouseX<96&&1===this.lastMouseButtonDown&&(this.messageTabSelected=0),this.mouseX>110&&this.mouseX<194&&1===this.lastMouseButtonDown&&(this.messageTabSelected=1,this.panelGame[ai.CHAT].controlFlashText[this.controlTextListChat]=999999),this.mouseX>215&&this.mouseX<295&&1===this.lastMouseButtonDown&&(this.messageTabSelected=2,this.panelGame[ai.CHAT].controlFlashText[this.controlTextListQuest]=999999),this.mouseX>315&&this.mouseX<395&&1===this.lastMouseButtonDown&&(this.messageTabSelected=3,this.panelGame[ai.CHAT].controlFlashText[this.controlTextListPrivate]=999999),this.mouseX>417&&this.mouseX<497&&1===this.lastMouseButtonDown&&(this.showDialogReportAbuseStep=1,this.reportAbuseOffence=0,this.inputTextCurrent="",this.inputTextFinal=""),this.lastMouseButtonDown=0,this.mouseButtonDown=0),this.panelGame[ai.CHAT].handleMouse(this.mouseX,this.mouseY,this.lastMouseButtonDown,this.mouseButtonDown,this.mouseScrollDelta),this.messageTabSelected>0&&this.mouseX>=494&&this.mouseY>=this.gameHeight-66&&(this.lastMouseButtonDown=0),this.panelGame[ai.CHAT].isClicked(this.controlTextListAll)){let t=this.panelGame[ai.CHAT].getText(this.controlTextListAll);if(t.length>0)if(this.panelGame[ai.CHAT].updateText(this.controlTextListAll,""),this.lastLog.push(t),this.lastLogIdx=-1,/^::/.test(t))/^::closecon$/i.test(t)?this.clientStream.closeStream():/^::logout/i.test(t)?this.closeConnection():/^::lostcon$/i.test(t)?await this.lostConnection():this.sendCommandString(t.substring(2));else{let e=ri(t);this.sendChatMessage(e,e.length),t=si(e),this.localPlayer.messageTimeout=150,this.localPlayer.message=t,this.showMessage(this.localPlayer.name+": "+t,2)}}if(0===this.messageTabSelected)for(let t=0;t<5;t++)this.messageHistoryTimeout[t]>0&&this.messageHistoryTimeout[t]--;if(this.deathScreenTimeout>0&&(this.lastMouseButtonDown=0),this.showDialogTrade||this.showDialogDuel?(0!==this.mouseButtonDown?this.mouseButtonDownTime++:this.mouseButtonDownTime=0,this.mouseButtonDownTime>600?this.mouseButtonItemCountIncrement+=5e3:this.mouseButtonDownTime>450?this.mouseButtonItemCountIncrement+=500:this.mouseButtonDownTime>300?this.mouseButtonItemCountIncrement+=50:this.mouseButtonDownTime>150?this.mouseButtonItemCountIncrement+=5:this.mouseButtonDownTime>50?this.mouseButtonItemCountIncrement++:this.mouseButtonDownTime>20&&0==(5&this.mouseButtonDownTime)&&this.mouseButtonItemCountIncrement++):(this.mouseButtonDownTime=0,this.mouseButtonItemCountIncrement=0),1===this.lastMouseButtonDown?this.mouseButtonClick=1:2===this.lastMouseButtonDown&&(this.mouseButtonClick=2),this.scene.setMouseLoc(this.mouseX,this.mouseY),this.lastMouseButtonDown=0,this.optionCameraModeAuto){if(0===this.anInt707||this.cameraAutoAngleDebug){if(this.keyLeft&&(this.cameraAngle=this.cameraAngle+1&7,this.keyLeft=!1,!this.fogOfWar)){0==(1&this.cameraAngle)&&(this.cameraAngle=this.cameraAngle+1&7);for(let t=0;t<8&&!this.isValidCameraAngle(this.cameraAngle);t++)this.cameraAngle=this.cameraAngle+1&7}if(this.keyRight&&(this.cameraAngle=this.cameraAngle+7&7,this.keyRight=!1,!this.fogOfWar)){0==(1&this.cameraAngle)&&(this.cameraAngle=this.cameraAngle+7&7);for(let t=0;t<8&&!this.isValidCameraAngle(this.cameraAngle);t++)this.cameraAngle=this.cameraAngle+7&7}}}else this.keyLeft?this.cameraRotation=this.cameraRotation+2&255:this.keyRight&&(this.cameraRotation=this.cameraRotation-2&255);!this.optionCameraModeAuto&&this.options.middleClickCamera&&this.middleButtonDown&&(this.cameraRotation=this.originRotation+(this.mouseX-this.originMouseX)/2&255),this.options.zoomCamera?this.handleCameraZoom():this.fogOfWar&&this.cameraZoom>fi?this.cameraZoom-=4:!this.fogOfWar&&this.cameraZoom<Si&&(this.cameraZoom+=4),0!==this.mouseClickXStep&&(this.mouseClickXStep+=-Math.sign(this.mouseClickXStep)),this.scene.doSOemthingWithTheFuckinFountainFuck(17),this.objectAnimationCount++,this.objectAnimationCount>5&&(this.objectAnimationCount=0,this.objectAnimationNumberFireLightningSpell=(this.objectAnimationNumberFireLightningSpell+1)%3,this.objectAnimationNumberTorch=(this.objectAnimationNumberTorch+1)%4,this.objectAnimationNumberClaw=(this.objectAnimationNumberClaw+1)%5);for(let t=0;t<this.objectCount;t++){let e=this.objectX[t],i=this.objectY[t];e>=0&&i>=0&&e<96&&i<96&&74===this.objectId[t]&&this.objectModel[t].rotate(1,0,0)}for(let t=0;t<this.teleportBubbleCount;t++)if(this.teleportBubbleTime[t]++,this.teleportBubbleTime[t]>50){this.teleportBubbleCount--;for(let e=t;e<this.teleportBubbleCount;e++)this.teleportBubbleX[e]=this.teleportBubbleX[e+1],this.teleportBubbleY[e]=this.teleportBubbleY[e+1],this.teleportBubbleTime[e]=this.teleportBubbleTime[e+1],this.teleportBubbleType[e]=this.teleportBubbleType[e+1]}}}doGuessCaptcha(t){this.clientStream.newPacket(s.SLEEP_WORD),this.clientStream.putString(t),this.sleepWordDelay||(this.clientStream.putByte(0),this.sleepWordDelay=!0),this.clientStream.sendPacket(),this.inputTextCurrent="",this.inputTextFinal="",this.sleepingStatusText="Please wait..."}handleCameraZoom(){if(this.keyUp?this.cameraZoom-=16:this.keyDown?this.cameraZoom+=16:this.keyHome?this.cameraZoom=Si:this.keyPgUp?this.cameraZoom=pi:this.keyPgDown&&(this.cameraZoom=gi),0!==this.mouseScrollDelta&&(2===this.showUiTab||0===this.showUiTab)){if(0!==this.messageTabSelected&&this.mouseY>this.gameHeight-64)return;this.cameraZoom+=24*this.mouseScrollDelta}this.cameraZoom>=gi?this.cameraZoom=gi:this.cameraZoom<=pi&&(this.cameraZoom=pi)}renderLoginScreenViewports(){this.world._loadSection_from3(2423,2423,0),this.world.addModels(this.gameModels);let t=9728,e=6400,i=1100,s=888;this.scene.clipFar3d=4100,this.scene.clipFar2d=4100,this.scene.fogZFalloff=1,this.scene.fogZDistance=4e3,this.surface.blackScreen(),this.scene.setCamera(t,-this.world.getElevation(t,e),e,912,s,0,2*i),this.scene.render(),this.surface.fadeToBlack(),this.surface.drawBox(0,0,this.gameWidth,6,0);for(let r=6;r>=1;r--)this.surface.drawLineAlpha(0,r,0,r,this.gameWidth,8);this.surface.drawBox(0,194,512,20,0);for(let r=6;r>=1;r--)this.surface.drawLineAlpha(0,r,0,194-r,this.gameWidth,8);this.surface.drawSpriteID((this.gameWidth/2|0)-(this.surface.spriteWidth[this.spriteMedia+10]/2|0),15,this.spriteMedia+10),this.surface._drawSprite_from5(this.spriteLogo,0,0,this.gameWidth,200),this.surface.drawWorld(this.spriteLogo),t=9216,e=9216,i=1100,s=888,this.scene.clipFar3d=4100,this.scene.clipFar2d=4100,this.scene.fogZFalloff=1,this.scene.fogZDistance=4e3,this.surface.blackScreen(),this.scene.setCamera(t,-this.world.getElevation(t,e),e,912,s,0,2*i),this.scene.render(),this.surface.fadeToBlack(),this.surface.drawBox(0,0,this.gameWidth,6,0);for(let r=6;r>=1;r--)this.surface.drawLineAlpha(0,r,0,r,this.gameWidth,8);this.surface.drawBox(0,194,this.gameWidth,20,0);for(let r=6;r>=1;r--)this.surface.drawLineAlpha(0,r,0,194-r,this.gameWidth,8);this.surface.drawSpriteID((this.gameWidth/2|0)-(this.surface.spriteWidth[this.spriteMedia+10]/2|0),15,this.spriteMedia+10),this.surface._drawSprite_from5(this.spriteLogo+1,0,0,this.gameWidth,200),this.surface.drawWorld(this.spriteLogo+1);for(let r=0;r<64;r++)this.scene.removeModel(this.world.roofModels[0][r]),this.scene.removeModel(this.world.wallModels[1][r]),this.scene.removeModel(this.world.roofModels[1][r]),this.scene.removeModel(this.world.wallModels[2][r]),this.scene.removeModel(this.world.roofModels[2][r]);t=11136,e=10368,i=500,s=376,this.scene.clipFar3d=4100,this.scene.clipFar2d=4100,this.scene.fogZFalloff=1,this.scene.fogZDistance=4e3,this.surface.blackScreen(),this.scene.setCamera(t,-this.world.getElevation(t,e),e,912,s,0,2*i),this.scene.render(),this.surface.fadeToBlack(),this.surface.fadeToBlack(),this.surface.drawBox(0,0,this.gameWidth,6,0);for(let r=6;r>=1;r--)this.surface.drawLineAlpha(0,r,0,r,this.gameWidth,8);this.surface.drawBox(0,194,this.gameWidth,20,0);for(let r=6;r>=1;r--)this.surface.drawLineAlpha(0,r,0,194,this.gameWidth,8);this.surface.drawSpriteID((this.gameWidth/2|0)-(this.surface.spriteWidth[this.spriteMedia+10]/2|0),15,this.spriteMedia+10),this.surface._drawSprite_from5(this.spriteMedia+10,0,0,this.gameWidth,200),this.surface.drawWorld(this.spriteMedia+10)}createLoginPanels(){this.panelLogin[hi.WELCOME]=new We(this.surface,50),this.panelLogin[hi.NEW_USER]=new We(this.surface,50),this.panelLogin[hi.EXISTING_USER]=new We(this.surface,50);let t=40,e=this.gameWidth/2|0;this.panelLogin[hi.WELCOME].addText(e,200+t,"Click on an option",5,!0),this.panelLogin[hi.WELCOME].addButtonBackground(e-100,240+t,120,35),this.panelLogin[hi.WELCOME].addButtonBackground(e+100,240+t,120,35),this.panelLogin[hi.WELCOME].addText(e-100,240+t,"New User",5,!1),this.panelLogin[hi.WELCOME].addText(e+100,240+t,"Existing User",5,!1),this.controlWelcomeNewuser=this.panelLogin[hi.WELCOME].addButton(e-100,240+t,120,35),this.controlWelcomeExistinguser=this.panelLogin[hi.WELCOME].addButton(e+100,240+t,120,35),t=70,this.controlRegisterStatus=this.panelLogin[hi.NEW_USER].addText(e,t+8,"To create an account please enter all the requested details",4,!0);let i=t+25;this.panelLogin[hi.NEW_USER].addButtonBackground(e,i+17,250,34),this.panelLogin[hi.NEW_USER].addText(e,i+8,"Choose a Username",4,!1),this.controlRegisterUser=this.panelLogin[hi.NEW_USER].addTextInput(e,i+25,200,40,4,12,!1,!1),this.panelLogin[hi.NEW_USER].setFocus(this.controlRegisterUser),i+=40,this.panelLogin[hi.NEW_USER].addButtonBackground(e-115,i+17,220,34),this.panelLogin[hi.NEW_USER].addText(e-115,i+8,"Choose a Password",4,!1),this.controlRegisterPassword=this.panelLogin[hi.NEW_USER].addTextInput(e-115,i+25,220,40,4,20,!0,!1),this.panelLogin[hi.NEW_USER].addButtonBackground(e+115,i+17,220,34),this.panelLogin[hi.NEW_USER].addText(e+115,i+8,"Confirm Password",4,!1),this.controlRegisterConfirmPassword=this.panelLogin[hi.NEW_USER].addTextInput(e+115,i+25,220,40,4,20,!0,!1),i+=60,this.controlRegisterCheckbox=this.panelLogin[hi.NEW_USER].addCheckbox(e-196-7,i-7,14,14),this.panelLogin[hi.NEW_USER].addString(e-181,i,"I have read and agree to the terms and conditions",4,!0),i+=15,this.panelLogin[hi.NEW_USER].addText(e,i,"(to view these click the relevant link below this game window)",4,!0),i+=20,this.panelLogin[hi.NEW_USER].addButtonBackground(e-100,i+17,150,34),this.panelLogin[hi.NEW_USER].addText(e-100,i+17,"Submit",5,!1),this.controlRegisterSubmit=this.panelLogin[hi.NEW_USER].addButton(e-100,i+17,150,34),this.panelLogin[hi.NEW_USER].addButtonBackground(e+100,i+17,150,34),this.panelLogin[hi.NEW_USER].addText(e+100,i+17,"Cancel",5,!1),this.controlRegisterCancel=this.panelLogin[hi.NEW_USER].addButton(e+100,i+17,150,34),t=230,this.controlLoginStatus=this.panelLogin[hi.EXISTING_USER].addText(e,t-10,"Please enter your username and password",4,!0),t+=28,this.panelLogin[hi.EXISTING_USER].addButtonBackground(e-116,t,200,40),this.panelLogin[hi.EXISTING_USER].addText(e-116,t-10,"Username:",4,!1),this.panelLogin[hi.EXISTING_USER].addText(e-55,t-5,"Save?",2,!1),this.controlLoginSavePass=this.panelLogin[hi.EXISTING_USER].addCheckbox(e-60,t+5,10,10),this.controlLoginUser=this.panelLogin[hi.EXISTING_USER].addTextInput(e-116,t+10,200,40,4,12,!1,!1),t+=47,this.panelLogin[hi.EXISTING_USER].addButtonBackground(e-66,t,200,40),this.panelLogin[hi.EXISTING_USER].addText(e-66,t-10,"Password:",4,!1),this.controlLoginPass=this.panelLogin[hi.EXISTING_USER].addTextInput(e-66,t+10,200,40,4,20,!0,!1),t-=55,this.panelLogin[hi.EXISTING_USER].addButtonBackground(e+154,t,120,25),this.panelLogin[hi.EXISTING_USER].addText(e+154,t,"Ok",4,!1),this.controlLoginOk=this.panelLogin[hi.EXISTING_USER].addButton(e+154,t,120,25),t+=30,this.panelLogin[hi.EXISTING_USER].addButtonBackground(e+154,t,120,25),this.panelLogin[hi.EXISTING_USER].addText(e+154,t,"Cancel",4,!1),this.controlLoginCancel=this.panelLogin[hi.EXISTING_USER].addButton(e+154,t,120,25),t+=30,this.panelLogin[hi.EXISTING_USER].setFocus(this.controlLoginUser)}drawUiTabInventory(t){let e=this.surface.width2-248;this.surface.drawSpriteID(e,3,this.spriteMedia+1);for(let r=0;r<this.inventoryMaxItemCount;r++){let t=e+r%5*49,i=36+34*(r/5|0);r<this.inventoryItemsCount&&1===this.inventoryEquipped[r]?this.surface.drawBoxAlpha(t,i,49,34,16711680,128):this.surface.drawBoxAlpha(t,i,49,34,gt.rgbToLong(181,181,181),128),r<this.inventoryItemsCount&&(this.surface._spriteClipping_from9(t,i,48,32,this.spriteItem+Be.itemPicture[this.inventoryItemId[r]],Be.itemMask[this.inventoryItemId[r]],0,0,!1),0===Be.itemStackable[this.inventoryItemId[r]]&&this.surface.drawString(this.inventoryItemStackCount[r].toString(),t+1,i+10,1,16776960))}for(let r=1;r<=4;r++)this.surface.drawLineVert(e+49*r,36,34*(this.inventoryMaxItemCount/5|0),0);for(let r=1;r<=(this.inventoryMaxItemCount/5|0)-1;r++)this.surface.drawLineHoriz(e,36+34*r,245,0);if(!t)return;let i=this.mouseX-(this.surface.width2-248),s=this.mouseY-36;if(i>=0&&s>=0&&i<248&&s<34*(this.inventoryMaxItemCount/5|0)){let t=(i/49|0)+5*(s/34|0);if(t<this.inventoryItemsCount){let e=this.inventoryItemId[t];if(this.selectedSpell>=0)3===Be.spellType[this.selectedSpell]&&(this.menuItemText1[this.menuItemsCount]="Cast "+Be.spellName[this.selectedSpell]+" on",this.menuItemText2[this.menuItemsCount]="@lre@"+Be.itemName[e],this.menuItemID[this.menuItemsCount]=600,this.menuSourceType[this.menuItemsCount]=t,this.menuSourceIndex[this.menuItemsCount]=this.selectedSpell,this.menuItemsCount++);else{if(this.selectedItemInventoryIndex>=0)return this.menuItemText1[this.menuItemsCount]="Use "+this.selectedItemName+" with",this.menuItemText2[this.menuItemsCount]="@lre@"+Be.itemName[e],this.menuItemID[this.menuItemsCount]=610,this.menuSourceType[this.menuItemsCount]=t,this.menuSourceIndex[this.menuItemsCount]=this.selectedItemInventoryIndex,void this.menuItemsCount++;1===this.inventoryEquipped[t]?(this.menuItemText1[this.menuItemsCount]="Remove",this.menuItemText2[this.menuItemsCount]="@lre@"+Be.itemName[e],this.menuItemID[this.menuItemsCount]=620,this.menuSourceType[this.menuItemsCount]=t,this.menuItemsCount++):0!==Be.itemWearable[e]&&(0!=(24&Be.itemWearable[e])?this.menuItemText1[this.menuItemsCount]="Wield":this.menuItemText1[this.menuItemsCount]="Wear",this.menuItemText2[this.menuItemsCount]="@lre@"+Be.itemName[e],this.menuItemID[this.menuItemsCount]=630,this.menuSourceType[this.menuItemsCount]=t,this.menuItemsCount++),""!==Be.itemCommand[e]&&(this.menuItemText1[this.menuItemsCount]=Be.itemCommand[e],this.menuItemText2[this.menuItemsCount]="@lre@"+Be.itemName[e],this.menuItemID[this.menuItemsCount]=640,this.menuSourceType[this.menuItemsCount]=t,this.menuItemsCount++),this.menuItemText1[this.menuItemsCount]="Use",this.menuItemText2[this.menuItemsCount]="@lre@"+Be.itemName[e],this.menuItemID[this.menuItemsCount]=650,this.menuSourceType[this.menuItemsCount]=t,this.menuItemsCount++,this.menuItemText1[this.menuItemsCount]="Drop",this.menuItemText2[this.menuItemsCount]="@lre@"+Be.itemName[e],this.menuItemID[this.menuItemsCount]=660,this.menuSourceType[this.menuItemsCount]=t,this.menuItemsCount++,this.menuItemText1[this.menuItemsCount]="Examine",this.menuItemText2[this.menuItemsCount]="@lre@"+Be.itemName[e],this.menuItemID[this.menuItemsCount]=3600,this.menuSourceType[this.menuItemsCount]=e,this.menuItemsCount++}}}}autorotateCamera(){if(1==(1&this.cameraAngle)&&this.isValidCameraAngle(this.cameraAngle))return;if(0==(1&this.cameraAngle)&&this.isValidCameraAngle(this.cameraAngle))return this.isValidCameraAngle(this.cameraAngle+1&7)?void(this.cameraAngle=this.cameraAngle+1&7):void(this.isValidCameraAngle(this.cameraAngle+7&7)&&(this.cameraAngle=this.cameraAngle+7&7));let t=new Int32Array([1,-1,2,-2,3,-3,4]);for(let e=0;e<7;e++)if(this.isValidCameraAngle(this.cameraAngle+t[e]+8&7)){this.cameraAngle=this.cameraAngle+t[e]+8&7;break}if(0==(1&this.cameraAngle)&&this.isValidCameraAngle(this.cameraAngle)){if(this.isValidCameraAngle(this.cameraAngle+1&7))return void(this.cameraAngle=this.cameraAngle+1&7);this.isValidCameraAngle(this.cameraAngle+7&7)&&(this.cameraAngle=this.cameraAngle+7&7)}}drawRightClickMenu(){if(0!==this.mouseButtonClick){for(let t=0;t<this.menuItemsCount;t++){let e=this.menuX+2,i=this.menuY+27+15*t;if(this.mouseX>e+7&&this.mouseY>i-15&&this.mouseY<=i&&this.mouseX<=e+this.menuWidth+7){this.menuItemClick(this.menuIndices[t]);break}}return this.mouseButtonClick=0,void(this.showRightClickMenu=!1)}if(this.mouseX<this.menuX-10||this.mouseY<this.menuY-10||this.mouseX>this.menuX+this.menuWidth+10||this.mouseY>this.menuY+this.menuHeight+10)this.showRightClickMenu=!1;else{this.surface.drawBoxAlpha(this.menuX,this.menuY,this.menuWidth,this.menuHeight,13684944,160),this.surface.drawString("Choose option",this.menuX+2,this.menuY+12,1,65535);for(let t=0;t<this.menuItemsCount;t++){let e=this.menuX+2,i=this.menuY+27+15*t,s=16777215;this.mouseX>e-2&&this.mouseY>i-15&&this.mouseY<i&&this.mouseX<e-2+this.menuWidth&&(s=16776960),this.surface.drawString(this.menuItemText1[this.menuIndices[t]]+" "+this.menuItemText2[this.menuIndices[t]],e,i,1,s)}}}drawUiTabMinimap(t){let e=this.surface.width2-199,i=3;this.surface.drawSpriteID(e-49,i,this.spriteMedia+2),e+=40,i+=33,this.surface.drawBox(e,i,156,152,0),this.surface.setBounds(e,i,e+156,i+152);let s=192+this.minimapRandom_2,r=this.cameraRotation+this.minimapRandom_1&255,n=3*(this.localPlayer.currentX-6040)*s/2048|0,o=3*(this.localPlayer.currentY-6040)*s/2048|0,a=Oe.sin2048Cache[1024-4*r&1023],h=Oe.sin2048Cache[1024+(1024-4*r&1023)],l=o*a+n*h>>18;o=o*h-n*a>>18,n=l,this.surface.drawMinimapSprite(e+78-n,112+o,this.spriteMedia-1,r+64&255,s);for(let m=0;m<this.objectCount;m++){let t=3*(this.objectX[m]*this.tileSize+64-this.localPlayer.currentX)*s/2048|0,i=3*(this.objectY[m]*this.tileSize+64-this.localPlayer.currentY)*s/2048|0,r=i*a+t*h>>18;i=i*h-t*a>>18,t=r,this.drawMinimapEntity(e+78+t,112-i,65535)}for(let m=0;m<this.groundItemCount;m++){let t=3*(this.groundItemX[m]*this.tileSize+64-this.localPlayer.currentX)*s/2048|0,i=3*(this.groundItemY[m]*this.tileSize+64-this.localPlayer.currentY)*s/2048|0,r=i*a+t*h>>18;i=i*h-t*a>>18,t=r,this.drawMinimapEntity(e+78+t,112-i,16711680)}for(let m=0;m<this.npcCount;m++){let t=this.npcs[m],i=3*(t.currentX-this.localPlayer.currentX)*s/2048|0,r=3*(t.currentY-this.localPlayer.currentY)*s/2048|0,n=r*a+i*h>>18;r=r*h-i*a>>18,i=n,this.drawMinimapEntity(e+78+i,112-r,16776960)}for(let m=0;m<this.playerCount;m++){let t=this.players[m],i=3*(t.currentX-this.localPlayer.currentX)*s/2048|0,r=3*(t.currentY-this.localPlayer.currentY)*s/2048|0,n=r*a+i*h>>18;r=r*h-i*a>>18,i=n;let o=16777215;for(let e=0;e<this.friendListCount;e++)t.hash.equals(this.friendListHashes[e])&&255===this.friendListOnline[e]&&(o=65280);this.drawMinimapEntity(e+78+i,112-r,o)}if(this.surface.drawCircle(e+78,112,2,16777215,255),this.surface.drawMinimapSprite(e+19,55,this.spriteMedia+24,this.cameraRotation+128&255,128),this.surface.setBounds(0,0,this.gameWidth,this.gameHeight+12),!t)return;let c=this.mouseX-(this.surface.width2-199),u=this.mouseY-36;if(this.options.resetCompass&&1===this.mouseButtonClick&&c>42&&c<75&&u>3&&u<36)return this.cameraRotation=128,void(this.mouseButtonClick=0);if(c>=40&&u>=0&&c<196&&u<152){let t=156,e=152,i=192+this.minimapRandom_2,s=this.cameraRotation+this.minimapRandom_1&255,r=this.surface.width2-199;r+=40;let n=16384*(this.mouseX-(r+(t/2|0)))/(3*i)|0,o=16384*(this.mouseY-(36+(e/2|0)))/(3*i)|0,a=Oe.sin2048Cache[1024-4*s&1023],h=Oe.sin2048Cache[1024+(1024-4*s&1023)],l=o*a+n*h>>15;o=o*h-n*a>>15,n=l,n+=this.localPlayer.currentX,o=this.localPlayer.currentY-o,1===this.mouseButtonClick&&this._walkToActionSource_from5(this.localRegionX,this.localRegionY,n/128|0,o/128|0,!1),this.mouseButtonClick=0}}drawDialogTradeConfirm(){this.surface.drawBox(22,36,468,16,192),this.surface.drawBoxAlpha(22,52,468,246,10000536,160),this.surface.drawStringCenter("Please confirm your trade with @yel@"+ni.hashToUsername(this.tradeRecipientConfirmHash),256,48,1,16777215),this.surface.drawStringCenter("You are about to give:",139,66,1,16776960);for(let t=0;t<this.tradeConfirmItemsCount;t++){let e=Be.itemName[this.tradeConfirmItems[t]];0===Be.itemStackable[this.tradeConfirmItems[t]]&&(e=e+" x "+yi.formatNumber(this.tradeConfirmItemCount[t])),this.surface.drawStringCenter(e,139,78+12*t,1,16777215)}0===this.tradeConfirmItemsCount&&this.surface.drawStringCenter("Nothing!",139,78,1,16777215),this.surface.drawStringCenter("In return you will receive:",373,66,1,16776960);for(let t=0;t<this.tradeRecipientConfirmItemsCount;t++){let e=Be.itemName[this.tradeRecipientConfirmItems[t]];0===Be.itemStackable[this.tradeRecipientConfirmItems[t]]&&(e=e+" x "+yi.formatNumber(this.tradeRecipientConfirmItemCount[t])),this.surface.drawStringCenter(e,373,78+12*t,1,16777215)}0===this.tradeRecipientConfirmItemsCount&&this.surface.drawStringCenter("Nothing!",373,78,1,16777215),this.surface.drawStringCenter("Are you sure you want to do this?",256,236,4,65535),this.surface.drawStringCenter("There is NO WAY to reverse a trade if you change your mind.",256,251,1,16777215),this.surface.drawStringCenter("Remember that not all players are trustworthy",256,266,1,16777215),this.tradeConfirmAccepted?this.surface.drawStringCenter("Waiting for other player...",256,286,1,16776960):(this.surface.drawSpriteID(105,274,this.spriteMedia+25),this.surface.drawSpriteID(339,274,this.spriteMedia+26)),1===this.mouseButtonClick&&((this.mouseX<22||this.mouseY<36||this.mouseX>490||this.mouseY>298)&&(this.showDialogTradeConfirm=!1,this.clientStream.newPacket(s.TRADE_DECLINE),this.clientStream.sendPacket()),this.mouseX>=105&&this.mouseX<=210&&this.mouseY>=274&&this.mouseY<=295&&(this.tradeConfirmAccepted=!0,this.clientStream.newPacket(s.TRADE_CONFIRM_ACCEPT),this.clientStream.sendPacket()),this.mouseX>=339&&this.mouseX<=445&&this.mouseY>=274&&this.mouseY<=295&&(this.showDialogTradeConfirm=!1,this.clientStream.newPacket(s.TRADE_DECLINE),this.clientStream.sendPacket()),this.mouseButtonClick=0)}updateActiveTab(){let t=this.showUiTab,e=32;0!==this.showUiTab&&(e-=9);let i=this.surface.width2-3;if(this.mouseY>=3&&this.mouseY<3+e)for(let n=1;n<=6;n++)if(i-=33,this.mouseX>=i&&this.mouseX<i+32){this.showUiTab=n;break}let s=this.surface.width2-199,r=this.showUiTab%3==0?316:240;1===this.showUiTab&&(s-=50,r=36+(this.inventoryMaxItemCount/5*34|0)),(0!==this.showUiTab&&this.mouseX<s||this.mouseY>r)&&(this.showUiTab=0),2===this.showUiTab&&this.showUiTab!==t&&(this.minimapRandom_1=(13*Math.random()|0)-6,this.minimapRandom_2=(23*Math.random()|0)-11)}drawOptionMenu(){if(0!==this.mouseButtonClick){for(let t=0;t<this.optionMenuCount;t++)if(!(this.mouseX>=this.surface.textWidth(this.optionMenuEntry[t],1)||this.mouseY<=12*t||this.mouseY>=12+12*t)){this.clientStream.newPacket(s.CHOOSE_OPTION),this.clientStream.putByte(t),this.clientStream.sendPacket();break}return this.mouseButtonClick=0,void(this.showOptionMenu=!1)}for(let t=0;t<this.optionMenuCount;t++){let e=65535;this.mouseX<this.surface.textWidth(this.optionMenuEntry[t],1)&&this.mouseY>12*t&&this.mouseY<12+12*t&&(e=16711680),this.surface.drawString(this.optionMenuEntry[t],6,12+12*t,1,e)}}drawNpc(t,e,i,s,r,n,o){let a=this.npcs[r],h=a.animationCurrent+(this.cameraRotation+16)/32&7,l=!1,c=h;5===c?(c=3,l=!0):6===c?(c=2,l=!0):7===c&&(c=1,l=!0);let u=3*c+this.npcWalkModel[(a.stepCount/Be.npcWalkModel[a.npcId]|0)%4];8===a.animationCurrent?(c=5,h=2,l=!1,t-=Be.npcCombatAnimation[a.npcId]*o/100|0,u=3*c+this.npcCombatModelArray1[((this.frameCounter/Be.npcCombatModel[a.npcId]|0)-1)%8]):9===a.animationCurrent&&(c=5,h=2,l=!0,t+=Be.npcCombatAnimation[a.npcId]*o/100|0,u=3*c+this.npcCombatModelArray2[(this.frameCounter/Be.npcCombatModel[a.npcId]|0)%8]);for(let m=0;m<12;m++){let r=this.npcAnimationArray[h][m],o=Be.npcSprite.get(a.npcId,r);if(o>=0){let r=0,h=0,m=u;if(l&&c>=1&&c<=3&&1===Be.animationHasF[o]&&(m+=15),5!==c||1===Be.animationHasA[o]){let c=m+Be.animationNumber[o];r=r*i/this.surface.spriteWidthFull[c]|0,h=h*s/this.surface.spriteHeightFull[c]|0;let u=i*this.surface.spriteWidthFull[c]/this.surface.spriteWidthFull[Be.animationNumber[o]]|0;r-=(u-i)/2|0;let d=Be.animationCharacterColour[o],p=0;1===d?(d=Be.npcColourHair[a.npcId],p=Be.npcColourSkin[a.npcId]):2===d?(d=Be.npcColourTop[a.npcId],p=Be.npcColourSkin[a.npcId]):3===d&&(d=Be.npcColorBottom[a.npcId],p=Be.npcColourSkin[a.npcId]),this.surface._spriteClipping_from9(t+r,e+h,u,s,c,d,p,n,l)}}}if(a.messageTimeout>0&&(this.receivedMessageMidPoint[this.receivedMessagesCount]=this.surface.textWidth(a.message,1)/2|0,this.receivedMessageMidPoint[this.receivedMessagesCount]>150&&(this.receivedMessageMidPoint[this.receivedMessagesCount]=150),this.receivedMessageHeight[this.receivedMessagesCount]=(this.surface.textWidth(a.message,1)/300|0)*this.surface.textHeight(1),this.receivedMessageX[this.receivedMessagesCount]=t+(i/2|0),this.receivedMessageY[this.receivedMessagesCount]=e,this.receivedMessages[this.receivedMessagesCount++]=a.message),(a.isFighting()||0!==a.combatTimer)&&a.combatTimer>0){let r=t;if(8===a.animationCurrent?r-=20*o/100|0:9===a.animationCurrent&&(r+=20*o/100|0),this.healthBarX[this.healthBarCount]=r+(i/2|0),this.healthBarY[this.healthBarCount]=e,this.healthBarMissing[this.healthBarCount++]=30*a.healthCurrent/a.healthMax|0,a.combatTimer>150){let r=t;8===a.animationCurrent?r-=10*o/100|0:9===a.animationCurrent&&(r+=10*o/100|0),this.surface.drawSpriteID(r+(i/2|0)-12,e+(s/2|0)-12,this.spriteMedia+12),this.surface.drawStringCenter(a.damageTaken.toString(),r+(i/2|0)-1,e+(s/2|0)+5,3,16777215)}}}walkToWallObject(t,e,i){0!==i?1!==i?this._walkToActionSource_from8(this.localRegionX,this.localRegionY,t,e,t,e,!0,!0):this._walkToActionSource_from8(this.localRegionX,this.localRegionY,t-1,e,t,e,!1,!0):this._walkToActionSource_from8(this.localRegionX,this.localRegionY,t,e-1,t,e,!1,!0)}async fetchDefinitions(){let t=await this.readDataFile("config"+F.CONFIG+".jag","Entity Information",10);null!==t?Be.loadDefinitions(t,this.members):this.exception=new be("Fatal issue occurred in a subroutine during asset fetch (game data):\n"+e.toString(),!0)}async fetchChatFilters(){let t=await this.readDataFile("filter"+F.FILTER+".jag","Chat filters",15);null!==t?(mi(new S(ni.loadData("badenc.txt",0,t))),ui(new S(ni.loadData("hostenc.txt",0,t))),di(new S(ni.loadData("fragmentsenc.txt",0,t))),ci(new S(ni.loadData("tldlist.txt",0,t)))):this.exception=new be("Fatal issue occurred in a subroutine during asset fetch (chat filters):\n"+e.toString(),!0)}addNpc(t,e,i,s,r){null===this.npcsServer[t]&&(this.npcsServer[t]=new W,this.npcsServer[t].serverIndex=t);let n=this.npcsServer[t],o=!1;for(let a=0;a<this.npcCacheCount;a++)if(this.npcsCache[a].serverIndex===t){o=!0;break}if(o){n.npcId=r,n.animationNext=s;let t=n.waypointCurrent;e===n.waypointsX[t]&&i===n.waypointsY[t]||(n.waypointCurrent=t=(t+1)%10,n.waypointsX[t]=e,n.waypointsY[t]=i)}else n.serverIndex=t,n.movingStep=0,n.waypointCurrent=0,n.waypointsX[0]=n.currentX=e,n.waypointsY[0]=n.currentY=i,n.npcId=r,n.animationNext=n.animationCurrent=s,n.stepCount=0;return this.npcs[this.npcCount++]=n,n}resetLoginVars(){this.welcomeState=hi.WELCOME,this.gameState=oi.LOGIN,this.logoutBoxFrames=0,this.systemUpdate=0}drawDialogBank(){if(this.bankActivePage>0&&this.bankItemCount<=48&&(this.bankActivePage=0),this.bankActivePage>1&&this.bankItemCount<=96&&(this.bankActivePage=1),this.bankActivePage>2&&this.bankItemCount<=144&&(this.bankActivePage=2),(this.bankSelectedItemSlot>=this.bankItemCount||this.bankSelectedItemSlot<0)&&(this.bankSelectedItemSlot=-1),-1!==this.bankSelectedItemSlot&&this.bankItems[this.bankSelectedItemSlot]!==this.bankSelectedItem&&(this.bankSelectedItemSlot=-1,this.bankSelectedItem=-2),0!==this.mouseButtonClick){this.mouseButtonClick=0;let t=this.mouseX-((this.gameWidth/2|0)-204),e=this.mouseY-((this.gameHeight/2|0)-167);if(t>=0&&e>=12&&t<408&&e<280){let i=48*this.bankActivePage;for(let s=0;s<6;s++)for(let r=0;r<8;r++){let n=7+49*r,o=28+34*s;t>n&&t<n+49&&e>o&&e<o+34&&i<this.bankItemCount&&-1!==this.bankItems[i]&&(this.bankSelectedItem=this.bankItems[i],this.bankSelectedItemSlot=i),i++}t=52,e=3;let r=0;if(-1!==(r=this.bankSelectedItemSlot<0?-1:this.bankItems[this.bankSelectedItemSlot])){let i=this.bankItemsCount[this.bankSelectedItemSlot];1===Be.itemStackable[r]&&i>1&&(i=1),i>=1&&this.mouseX>=t+220&&this.mouseY>=e+238&&this.mouseX<t+250&&this.mouseY<=e+249&&(this.clientStream.newPacket(s.BANK_WITHDRAW),this.clientStream.putShort(r),this.clientStream.putShort(1),this.clientStream.putInt(305419896),this.clientStream.sendPacket()),i>=5&&this.mouseX>=t+250&&this.mouseY>=e+238&&this.mouseX<t+280&&this.mouseY<=e+249&&(this.clientStream.newPacket(s.BANK_WITHDRAW),this.clientStream.putShort(r),this.clientStream.putShort(5),this.clientStream.putInt(305419896),this.clientStream.sendPacket()),i>=25&&this.mouseX>=t+280&&this.mouseY>=e+238&&this.mouseX<t+305&&this.mouseY<=e+249&&(this.clientStream.newPacket(s.BANK_WITHDRAW),this.clientStream.putShort(r),this.clientStream.putShort(25),this.clientStream.putInt(305419896),this.clientStream.sendPacket()),i>=100&&this.mouseX>=t+305&&this.mouseY>=e+238&&this.mouseX<t+335&&this.mouseY<=e+249&&(this.clientStream.newPacket(s.BANK_WITHDRAW),this.clientStream.putShort(r),this.clientStream.putShort(100),this.clientStream.putInt(305419896),this.clientStream.sendPacket()),i>=500&&this.mouseX>=t+335&&this.mouseY>=e+238&&this.mouseX<t+368&&this.mouseY<=e+249&&(this.clientStream.newPacket(s.BANK_WITHDRAW),this.clientStream.putShort(r),this.clientStream.putShort(500),this.clientStream.putInt(305419896),this.clientStream.sendPacket()),i>=2500&&this.mouseX>=t+370&&this.mouseY>=e+238&&this.mouseX<t+400&&this.mouseY<=e+249&&(this.clientStream.newPacket(s.BANK_WITHDRAW),this.clientStream.putShort(r),this.clientStream.putShort(2500),this.clientStream.putInt(305419896),this.clientStream.sendPacket()),this.getInventoryCount(r)>=1&&this.mouseX>=t+220&&this.mouseY>=e+263&&this.mouseX<t+250&&this.mouseY<=e+274&&(this.clientStream.newPacket(s.BANK_DEPOSIT),this.clientStream.putShort(r),this.clientStream.putShort(1),this.clientStream.putInt(2271560481),this.clientStream.sendPacket()),this.getInventoryCount(r)>=5&&this.mouseX>=t+250&&this.mouseY>=e+263&&this.mouseX<t+280&&this.mouseY<=e+274&&(this.clientStream.newPacket(s.BANK_DEPOSIT),this.clientStream.putShort(r),this.clientStream.putShort(5),this.clientStream.putInt(2271560481),this.clientStream.sendPacket()),this.getInventoryCount(r)>=25&&this.mouseX>=t+280&&this.mouseY>=e+263&&this.mouseX<t+305&&this.mouseY<=e+274&&(this.clientStream.newPacket(s.BANK_DEPOSIT),this.clientStream.putShort(r),this.clientStream.putShort(25),this.clientStream.putInt(2271560481),this.clientStream.sendPacket()),this.getInventoryCount(r)>=100&&this.mouseX>=t+305&&this.mouseY>=e+263&&this.mouseX<t+335&&this.mouseY<=e+274&&(this.clientStream.newPacket(s.BANK_DEPOSIT),this.clientStream.putShort(r),this.clientStream.putShort(100),this.clientStream.putInt(2271560481),this.clientStream.sendPacket()),this.getInventoryCount(r)>=500&&this.mouseX>=t+335&&this.mouseY>=e+263&&this.mouseX<t+368&&this.mouseY<=e+274&&(this.clientStream.newPacket(s.BANK_DEPOSIT),this.clientStream.putShort(r),this.clientStream.putShort(500),this.clientStream.putInt(2271560481),this.clientStream.sendPacket()),this.getInventoryCount(r)>=2500&&this.mouseX>=t+370&&this.mouseY>=e+263&&this.mouseX<t+400&&this.mouseY<=e+274&&(this.clientStream.newPacket(s.BANK_DEPOSIT),this.clientStream.putShort(r),this.clientStream.putShort(2500),this.clientStream.putInt(2271560481),this.clientStream.sendPacket())}}else if(this.bankItemCount>48&&t>=50&&t<=115&&e<=12)this.bankActivePage=0;else if(this.bankItemCount>48&&t>=115&&t<=180&&e<=12)this.bankActivePage=1;else if(this.bankItemCount>96&&t>=180&&t<=245&&e<=12)this.bankActivePage=2;else{if(!(this.bankItemCount>144&&t>=245&&t<=310&&e<=12))return this.clientStream.newPacket(s.BANK_CLOSE),this.clientStream.sendPacket(),void(this.showDialogBank=!1);this.bankActivePage=3}}let t=(this.gameWidth/2|0)-204,e=(this.gameHeight/2|0)-167;this.surface.drawBox(t,e,408,12,192),this.surface.drawBoxAlpha(t,e+12,408,17,10000536,160),this.surface.drawBoxAlpha(t,e+29,8,204,10000536,160),this.surface.drawBoxAlpha(t+399,e+29,9,204,10000536,160),this.surface.drawBoxAlpha(t,e+233,408,47,10000536,160),this.surface.drawString("Bank",t+1,e+10,1,16777215);let i=50;if(this.bankItemCount>48){let s=16777215;0===this.bankActivePage?s=16711680:this.mouseX>t+i&&this.mouseY>=e&&this.mouseX<t+i+65&&this.mouseY<e+12&&(s=16776960),this.surface.drawString("<page 1>",t+i,e+10,1,s),i+=65,s=16777215,1===this.bankActivePage?s=16711680:this.mouseX>t+i&&this.mouseY>=e&&this.mouseX<t+i+65&&this.mouseY<e+12&&(s=16776960),this.surface.drawString("<page 2>",t+i,e+10,1,s),i+=65}if(this.bankItemCount>96){let s=16777215;2===this.bankActivePage?s=16711680:this.mouseX>t+i&&this.mouseY>=e&&this.mouseX<t+i+65&&this.mouseY<e+12&&(s=16776960),this.surface.drawString("<page 3>",t+i,e+10,1,s),i+=65}if(this.bankItemCount>144){let s=16777215;3===this.bankActivePage?s=16711680:this.mouseX>t+i&&this.mouseY>=e&&this.mouseX<t+i+65&&this.mouseY<e+12&&(s=16776960),this.surface.drawString("<page 4>",t+i,e+10,1,s),i+=65}let r=16777215;this.mouseX>t+320&&this.mouseY>=e&&this.mouseX<t+408&&this.mouseY<e+12&&(r=16711680),this.surface.drawStringRight("Close window",t+406,e+10,1,r),this.surface.drawString("Number in bank in green",t+7,e+24,1,65280),this.surface.drawString("Number held in blue",t+289,e+24,1,65535);let n=48*this.bankActivePage;for(let s=0;s<6;s++)for(let i=0;i<8;i++){let r=t+7+49*i,o=e+28+34*s;this.bankSelectedItemSlot===n?this.surface.drawBoxAlpha(r,o,49,34,16711680,160):this.surface.drawBoxAlpha(r,o,49,34,13684944,160),this.surface.drawBoxEdge(r,o,50,35,0),n<this.bankItemCount&&-1!==this.bankItems[n]&&(this.surface._spriteClipping_from9(r,o,48,32,this.spriteItem+Be.itemPicture[this.bankItems[n]],Be.itemMask[this.bankItems[n]],0,0,!1),this.surface.drawString(this.bankItemsCount[n].toString(),r+1,o+10,1,65280),this.surface.drawStringRight(this.getInventoryCount(this.bankItems[n]).toString(),r+47,o+29,1,65535)),n++}if(this.surface.drawLineHoriz(t+5,e+256,398,0),-1===this.bankSelectedItemSlot)return void this.surface.drawStringCenter("Select an object to withdraw or deposit",t+204,e+248,3,16776960);let o=0;if(-1!==(o=this.bankSelectedItemSlot<0?-1:this.bankItems[this.bankSelectedItemSlot])){let i=this.bankItemsCount[this.bankSelectedItemSlot];1===Be.itemStackable[o]&&i>1&&(i=1),i>0&&(this.surface.drawString("Withdraw "+Be.itemName[o],t+2,e+248,1,16777215),r=16777215,this.mouseX>=t+220&&this.mouseY>=e+238&&this.mouseX<t+250&&this.mouseY<=e+249&&(r=16711680),this.surface.drawString("One",t+222,e+248,1,r),i>=5&&(r=16777215,this.mouseX>=t+250&&this.mouseY>=e+238&&this.mouseX<t+280&&this.mouseY<=e+249&&(r=16711680),this.surface.drawString("Five",t+252,e+248,1,r)),i>=25&&(r=16777215,this.mouseX>=t+280&&this.mouseY>=e+238&&this.mouseX<t+305&&this.mouseY<=e+249&&(r=16711680),this.surface.drawString("25",t+282,e+248,1,r)),i>=100&&(r=16777215,this.mouseX>=t+305&&this.mouseY>=e+238&&this.mouseX<t+335&&this.mouseY<=e+249&&(r=16711680),this.surface.drawString("100",t+307,e+248,1,r)),i>=500&&(r=16777215,this.mouseX>=t+335&&this.mouseY>=e+238&&this.mouseX<t+368&&this.mouseY<=e+249&&(r=16711680),this.surface.drawString("500",t+337,e+248,1,r)),i>=2500&&(r=16777215,this.mouseX>=t+370&&this.mouseY>=e+238&&this.mouseX<t+400&&this.mouseY<=e+249&&(r=16711680),this.surface.drawString("2500",t+370,e+248,1,r))),this.getInventoryCount(o)>0&&(this.surface.drawString("Deposit "+Be.itemName[o],t+2,e+273,1,16777215),r=16777215,this.mouseX>=t+220&&this.mouseY>=e+263&&this.mouseX<t+250&&this.mouseY<=e+274&&(r=16711680),this.surface.drawString("One",t+222,e+273,1,r),this.getInventoryCount(o)>=5&&(r=16777215,this.mouseX>=t+250&&this.mouseY>=e+263&&this.mouseX<t+280&&this.mouseY<=e+274&&(r=16711680),this.surface.drawString("Five",t+252,e+273,1,r)),this.getInventoryCount(o)>=25&&(r=16777215,this.mouseX>=t+280&&this.mouseY>=e+263&&this.mouseX<t+305&&this.mouseY<=e+274&&(r=16711680),this.surface.drawString("25",t+282,e+273,1,r)),this.getInventoryCount(o)>=100&&(r=16777215,this.mouseX>=t+305&&this.mouseY>=e+263&&this.mouseX<t+335&&this.mouseY<=e+274&&(r=16711680),this.surface.drawString("100",t+307,e+273,1,r)),this.getInventoryCount(o)>=500&&(r=16777215,this.mouseX>=t+335&&this.mouseY>=e+263&&this.mouseX<t+368&&this.mouseY<=e+274&&(r=16711680),this.surface.drawString("500",t+337,e+273,1,r)),this.getInventoryCount(o)>=2500&&(r=16777215,this.mouseX>=t+370&&this.mouseY>=e+263&&this.mouseX<t+400&&this.mouseY<=e+274&&(r=16711680),this.surface.drawString("2500",t+370,e+273,1,r)))}}drawDialogDuel(){if(0!==this.mouseButtonClick&&0===this.mouseButtonItemCountIncrement&&(this.mouseButtonItemCountIncrement=1),this.mouseButtonItemCountIncrement>0){let t=this.mouseX-22,e=this.mouseY-36;if(t>=0&&e>=0&&t<468&&e<262){if(t>216&&e>30&&t<462&&e<235){let i=((t-217|0)/49|0)+5*((e-31)/34|0);if(i>=0&&i<this.inventoryItemsCount){let t=!1,e=0,r=this.inventoryItemId[i];for(let s=0;s<this.duelOfferItemCount;s++)if(this.duelOfferItemId[s]===r)if(0===Be.itemStackable[r])for(let e=0;e<this.mouseButtonItemCountIncrement;e++)this.duelOfferItemStack[s]<this.inventoryItemStackCount[i]&&this.duelOfferItemStack[s]++,t=!0;else e++;if(this.getInventoryCount(r)<=e&&(t=!0),1===Be.itemSpecial[r]&&(this.showMessage("This object cannot be added to a duel offer",3),t=!0),!t&&this.duelOfferItemCount<8&&(this.duelOfferItemId[this.duelOfferItemCount]=r,this.duelOfferItemStack[this.duelOfferItemCount]=1,this.duelOfferItemCount++,t=!0),t){this.clientStream.newPacket(s.DUEL_ITEM_UPDATE),this.clientStream.putByte(this.duelOfferItemCount);for(let t=0;t<this.duelOfferItemCount;t++)this.clientStream.putShort(this.duelOfferItemId[t]),this.clientStream.putInt(this.duelOfferItemStack[t]);this.clientStream.sendPacket(),this.duelOfferOpponentAccepted=!1,this.duelOfferAccepted=!1}}}if(t>8&&e>30&&t<205&&e<129){let i=((t-9)/49|0)+4*((e-31)/34|0);if(i>=0&&i<this.duelOfferItemCount){let t=this.duelOfferItemId[i];for(let e=0;e<this.mouseButtonItemCountIncrement;e++){if(!(0===Be.itemStackable[t]&&this.duelOfferItemStack[i]>1)){this.duelOfferItemCount--,this.mouseButtonDownTime=0;for(let t=i;t<this.duelOfferItemCount;t++)this.duelOfferItemId[t]=this.duelOfferItemId[t+1],this.duelOfferItemStack[t]=this.duelOfferItemStack[t+1];break}this.duelOfferItemStack[i]--}this.clientStream.newPacket(s.DUEL_ITEM_UPDATE),this.clientStream.putByte(this.duelOfferItemCount);for(let e=0;e<this.duelOfferItemCount;e++)this.clientStream.putShort(this.duelOfferItemId[e]),this.clientStream.putInt(this.duelOfferItemStack[e]);this.clientStream.sendPacket(),this.duelOfferOpponentAccepted=!1,this.duelOfferAccepted=!1}}let i=!1;t>=93&&e>=221&&t<=104&&e<=232&&(this.duelSettingsRetreat=!this.duelSettingsRetreat,i=!0),t>=93&&e>=240&&t<=104&&e<=251&&(this.duelSettingsMagic=!this.duelSettingsMagic,i=!0),t>=191&&e>=221&&t<=202&&e<=232&&(this.duelSettingsPrayer=!this.duelSettingsPrayer,i=!0),t>=191&&e>=240&&t<=202&&e<=251&&(this.duelSettingsWeapons=!this.duelSettingsWeapons,i=!0),i&&(this.clientStream.newPacket(s.DUEL_SETTINGS),this.clientStream.putByte(this.duelSettingsRetreat?1:0),this.clientStream.putByte(this.duelSettingsMagic?1:0),this.clientStream.putByte(this.duelSettingsPrayer?1:0),this.clientStream.putByte(this.duelSettingsWeapons?1:0),this.clientStream.sendPacket(),this.duelOfferOpponentAccepted=!1,this.duelOfferAccepted=!1),t>=217&&e>=238&&t<=286&&e<=259&&(this.duelOfferAccepted=!0,this.clientStream.newPacket(s.DUEL_ACCEPT),this.clientStream.sendPacket()),t>=394&&e>=238&&t<463&&e<259&&(this.showDialogDuel=!1,this.clientStream.newPacket(s.DUEL_DECLINE),this.clientStream.sendPacket())}else 0!==this.mouseButtonClick&&(this.showDialogDuel=!1,this.clientStream.newPacket(s.DUEL_DECLINE),this.clientStream.sendPacket());this.mouseButtonClick=0,this.mouseButtonItemCountIncrement=0}if(this.showDialogDuel){this.surface.drawBox(22,36,468,12,13175581),this.surface.drawBoxAlpha(22,48,468,18,10000536,160),this.surface.drawBoxAlpha(22,66,8,248,10000536,160),this.surface.drawBoxAlpha(227,66,11,248,10000536,160),this.surface.drawBoxAlpha(484,66,6,248,10000536,160),this.surface.drawBoxAlpha(30,135,197,24,10000536,160),this.surface.drawBoxAlpha(30,228,197,23,10000536,160),this.surface.drawBoxAlpha(30,294,197,20,10000536,160),this.surface.drawBoxAlpha(238,271,246,43,10000536,160),this.surface.drawBoxAlpha(30,66,197,69,13684944,160),this.surface.drawBoxAlpha(30,159,197,69,13684944,160),this.surface.drawBoxAlpha(30,251,197,43,13684944,160),this.surface.drawBoxAlpha(238,66,246,205,13684944,160);for(let t=0;t<3;t++)this.surface.drawLineHoriz(30,66+34*t,197,0);for(let t=0;t<3;t++)this.surface.drawLineHoriz(30,159+34*t,197,0);for(let t=0;t<7;t++)this.surface.drawLineHoriz(238,66+34*t,246,0);for(let t=0;t<6;t++)t<5&&this.surface.drawLineVert(30+49*t,66,69,0),t<5&&this.surface.drawLineVert(30+49*t,159,69,0),this.surface.drawLineVert(238+49*t,66,205,0);this.surface.drawLineHoriz(30,251,197,0),this.surface.drawLineHoriz(30,293,197,0),this.surface.drawLineVert(30,251,43,0),this.surface.drawLineVert(226,251,43,0),this.surface.drawString("Preparing to duel with: "+this.duelOpponentName,23,46,1,16777215),this.surface.drawString("Your Stake",31,63,4,16777215),this.surface.drawString("Opponent's Stake",31,156,4,16777215),this.surface.drawString("Duel Options",31,248,4,16777215),this.surface.drawString("Your Inventory",238,63,4,16777215),this.surface.drawString("No retreating",31,267,3,16776960),this.surface.drawString("No magic",31,286,3,16776960),this.surface.drawString("No prayer",132,267,3,16776960),this.surface.drawString("No weapons",132,286,3,16776960),this.surface.drawBoxEdge(115,257,11,11,16776960),this.duelSettingsRetreat&&this.surface.drawBox(117,259,7,7,16776960),this.surface.drawBoxEdge(115,276,11,11,16776960),this.duelSettingsMagic&&this.surface.drawBox(117,278,7,7,16776960),this.surface.drawBoxEdge(213,257,11,11,16776960),this.duelSettingsPrayer&&this.surface.drawBox(215,259,7,7,16776960),this.surface.drawBoxEdge(213,276,11,11,16776960),this.duelSettingsWeapons&&this.surface.drawBox(215,278,7,7,16776960),this.duelOfferAccepted||this.surface.drawSpriteID(239,274,this.spriteMedia+25),this.surface.drawSpriteID(416,274,this.spriteMedia+26),this.duelOfferOpponentAccepted&&(this.surface.drawStringCenter("Other player",363,282,1,16777215),this.surface.drawStringCenter("has accepted",363,292,1,16777215)),this.duelOfferAccepted&&(this.surface.drawStringCenter("Waiting for",274,282,1,16777215),this.surface.drawStringCenter("other player",274,292,1,16777215));for(let t=0;t<this.inventoryItemsCount;t++){let e=239+t%5*49,i=67+34*(t/5|0);this.surface._spriteClipping_from9(e,i,48,32,this.spriteItem+Be.itemPicture[this.inventoryItemId[t]],Be.itemMask[this.inventoryItemId[t]],0,0,!1),0===Be.itemStackable[this.inventoryItemId[t]]&&this.surface.drawString(this.inventoryItemStackCount[t].toString(),e+1,i+10,1,16776960)}for(let t=0;t<this.duelOfferItemCount;t++){let e=31+t%4*49,i=67+34*(t/4|0);this.surface._spriteClipping_from9(e,i,48,32,this.spriteItem+Be.itemPicture[this.duelOfferItemId[t]],Be.itemMask[this.duelOfferItemId[t]],0,0,!1),0===Be.itemStackable[this.duelOfferItemId[t]]&&this.surface.drawString(this.duelOfferItemStack[t].toString(),e+1,i+10,1,16776960),this.mouseX>e&&this.mouseX<e+48&&this.mouseY>i&&this.mouseY<i+32&&this.surface.drawString(Be.itemName[this.duelOfferItemId[t]]+": @whi@"+Be.itemDescription[this.duelOfferItemId[t]],30,309,1,16776960)}for(let t=0;t<this.duelOfferOpponentItemCount;t++){let e=31+t%4*49,i=160+34*(t/4|0);this.surface._spriteClipping_from9(e,i,48,32,this.spriteItem+Be.itemPicture[this.duelOfferOpponentItemId[t]],Be.itemMask[this.duelOfferOpponentItemId[t]],0,0,!1),0===Be.itemStackable[this.duelOfferOpponentItemId[t]]&&this.surface.drawString(this.duelOfferOpponentItemStack[t].toString(),e+1,i+10,1,16776960),this.mouseX>e&&this.mouseX<e+48&&this.mouseY>i&&this.mouseY<i+32&&this.surface.drawString(Be.itemName[this.duelOfferOpponentItemId[t]]+": @whi@"+Be.itemDescription[this.duelOfferOpponentItemId[t]],30,309,1,16776960)}}}loadNextRegion(t,i){if(0!==this.deathScreenTimeout)return this.world.playerAlive=!1,!1;if(this.loadingArea=!1,t+=this.planeWidth,i+=this.planeHeight,this.lastHeightOffset===this.planeIndex&&t>this.localLowerX&&t<this.localUpperX&&i>this.localLowerY&&i<this.localUpperY)return this.world.playerAlive=!0,!1;this.surface.drawStringCenter("Loading... Please wait",256,192,1,16777215),this.drawChatMessageTabs(),this.surface.draw(this.graphics,0,0);let s=this.regionX,r=this.regionY,n=(t+24)/48|0,o=(i+24)/48|0;this.lastHeightOffset=this.planeIndex,this.regionX=48*n-48,this.regionY=48*o-48,this.localLowerX=48*n-32,this.localLowerY=48*o-32,this.localUpperX=48*n+32,this.localUpperY=48*o+32,this.world._loadSection_from3(t,i,this.lastHeightOffset),this.regionX-=this.planeWidth,this.regionY-=this.planeHeight;let a=this.regionX-s,h=this.regionY-r;for(let l=0;l<this.objectCount;l++){this.objectX[l]-=a,this.objectY[l]-=h;let t=this.objectX[l],i=this.objectY[l],s=this.objectId[l],r=this.objectModel[l];try{let n=this.objectDirection[l],o=0,a=0;0===n||4===n?(o=Be.objectWidth[s],a=Be.objectHeight[s]):(a=Be.objectWidth[s],o=Be.objectHeight[s]);let h=(t+t+o)*this.tileSize/2|0,c=(i+i+a)*this.tileSize/2|0;t>=0&&i>=0&&t<96&&i<96&&(this.scene.addModel(r),r.place(h,-this.world.getElevation(h,c),c),this.world.removeObject2(t,i,s),74===s&&r.translate(0,-480,0))}catch(e){console.log("Loc Error: "+e.message),console.error(e)}}for(let l=0;l<this.wallObjectCount;l++){this.wallObjectX[l]-=a,this.wallObjectY[l]-=h;let t=this.wallObjectX[l],i=this.wallObjectY[l],s=this.wallObjectId[l],r=this.wallObjectDirection[l];try{this.world._setObjectAdjacency_from4(t,i,r,s);let n=this.createBoundaryModel(t,i,r,s,l);this.wallObjectModel[l]=n}catch(e){console.log("Bound Error: "+e.message),console.error(e)}}for(let e=0;e<this.groundItemCount;e++)this.groundItemX[e]-=a,this.groundItemY[e]-=h;for(let e=0;e<this.playerCount;e++){let t=this.players[e];t.currentX-=a*this.tileSize,t.currentY-=h*this.tileSize;for(let e=0;e<=t.waypointCurrent;e++)t.waypointsX[e]-=a*this.tileSize,t.waypointsY[e]-=h*this.tileSize}for(let e=0;e<this.npcCount;e++){let t=this.npcs[e];t.currentX-=a*this.tileSize,t.currentY-=h*this.tileSize;for(let e=0;e<=t.waypointCurrent;e++)t.waypointsX[e]-=a*this.tileSize,t.waypointsY[e]-=h*this.tileSize}return this.world.playerAlive=!0,!0}drawPlayer(t,e,i,s,r,n,o){let a=this.players[r];if(255===a.colourBottom)return;let h=a.animationCurrent+(this.cameraRotation+16)/32&7,l=!1,c=h;5===c?(c=3,l=!0):6===c?(c=2,l=!0):7===c&&(c=1,l=!0);let u=3*c+this.npcWalkModel[(a.stepCount/6|0)%4];8===a.animationCurrent?(h=2,l=!1,t-=5*o/100|0,u=3*(c=5)+this.npcCombatModelArray1[(this.frameCounter/5|0)%8]):9===a.animationCurrent&&(h=2,l=!0,t+=5*o/100|0,u=3*(c=5)+this.npcCombatModelArray2[(this.frameCounter/6|0)%8]);for(let m=0;m<12;m++){let r=this.npcAnimationArray[h][m],o=a.equippedItem[r]-1;if(o>=0){let h=0,m=0,d=u;if(l&&c>=1&&c<=3&&(1===Be.animationHasF[o]?d+=15:4===r&&1===c?(h=-22,m=-3,d=3*c+this.npcWalkModel[(2+(a.stepCount/6|0))%4]):4===r&&2===c?(h=0,m=-8,d=3*c+this.npcWalkModel[(2+(a.stepCount/6|0))%4]):4===r&&3===c?(h=26,m=-5,d=3*c+this.npcWalkModel[(2+(a.stepCount/6|0))%4]):3===r&&1===c?(h=22,m=3,d=3*c+this.npcWalkModel[(2+(a.stepCount/6|0))%4]):3===r&&2===c?(h=0,m=8,d=3*c+this.npcWalkModel[(2+(a.stepCount/6|0))%4]):3===r&&3===c&&(h=-26,m=5,d=3*c+this.npcWalkModel[(2+(a.stepCount/6|0))%4])),5!==c||1===Be.animationHasA[o]){let r=d+Be.animationNumber[o];h=h*i/this.surface.spriteWidthFull[r]|0,m=m*s/this.surface.spriteHeightFull[r]|0;let c=i*this.surface.spriteWidthFull[r]/this.surface.spriteWidthFull[Be.animationNumber[o]]|0;h-=(c-i)/2|0;let u=Be.animationCharacterColour[o],p=this.characterSkinColours[a.colourSkin];1===u?u=this.characterHairColours[a.colourHair]:2===u?u=this.characterTopBottomColours[a.colourTop]:3===u&&(u=this.characterTopBottomColours[a.colourBottom]),this.surface._spriteClipping_from9(t+h,e+m,c,s,r,u,p,n,l)}}}if(a.messageTimeout>0&&(this.receivedMessageMidPoint[this.receivedMessagesCount]=this.surface.textWidth(a.message,1)/2|0,this.receivedMessageMidPoint[this.receivedMessagesCount]>150&&(this.receivedMessageMidPoint[this.receivedMessagesCount]=150),this.receivedMessageHeight[this.receivedMessagesCount]=(this.surface.textWidth(a.message,1)/300|0)*this.surface.textHeight(1),this.receivedMessageX[this.receivedMessagesCount]=t+(i/2|0),this.receivedMessageY[this.receivedMessagesCount]=e,this.receivedMessages[this.receivedMessagesCount++]=a.message),a.bubbleTimeout>0&&(this.actionBubbleX[this.itemsAboveHeadCount]=t+(i/2|0),this.actionBubbleY[this.itemsAboveHeadCount]=e,this.actionBubbleScale[this.itemsAboveHeadCount]=o,this.actionBubbleItem[this.itemsAboveHeadCount++]=a.bubbleItem),(a.isFighting()||0!==a.combatTimer)&&a.combatTimer>0){let r=t;if(8===a.animationCurrent?r-=20*o/100|0:9===a.animationCurrent&&(r+=20*o/100|0),this.healthBarX[this.healthBarCount]=r+(i>>1),this.healthBarY[this.healthBarCount]=e,this.healthBarMissing[this.healthBarCount++]=30*a.healthCurrent/a.healthMax|0,a.combatTimer>150){let r=t;8===a.animationCurrent?r-=10*o/100|0:9===a.animationCurrent&&(r+=10*o/100|0),this.surface.drawSpriteID(r+(i>>1)-12,e+(s>>1)-12,this.spriteMedia+11),this.surface.drawStringCenter(a.damageTaken.toString(),r+(i>>1)-1,e+(s>>1)+5,3,16777215)}}if(1===a.skullVisible&&0===a.bubbleTimeout){let s=n+t+(i/2|0);8===a.animationCurrent?s-=20*o/100|0:9===a.animationCurrent&&(s+=20*o/100|0);let r=16*o/100|0,h=r>>1;this.surface._spriteClipping_from5(s-h,e-h-(r/2.5|0),r,r,this.spriteMedia+13)}}async loadMedia(){let t=await this.readDataFile("media"+F.MEDIA+".jag","2d graphics",20);if(null===t)return void(this.errorLoadingData=!0);let e=ni.loadData("index.dat",0,t);this.surface.parseSprite(this.spriteMedia,ni.loadData("inv1.dat",0,t),e,1),this.surface.parseSprite(this.spriteMedia+1,ni.loadData("inv2.dat",0,t),e,6),this.surface.parseSprite(this.spriteMedia+9,ni.loadData("bubble.dat",0,t),e,1),this.surface.parseSprite(this.spriteMedia+10,ni.loadData("runescape.dat",0,t),e,1),this.surface.parseSprite(this.spriteMedia+11,ni.loadData("splat.dat",0,t),e,3),this.surface.parseSprite(this.spriteMedia+14,ni.loadData("icon.dat",0,t),e,8),this.surface.parseSprite(this.spriteMedia+22,ni.loadData("hbar.dat",0,t),e,1),this.surface.parseSprite(this.spriteMedia+23,ni.loadData("hbar2.dat",0,t),e,1),this.surface.parseSprite(this.spriteMedia+24,ni.loadData("compass.dat",0,t),e,1),this.surface.parseSprite(this.spriteMedia+25,ni.loadData("buttons.dat",0,t),e,2),this.surface.parseSprite(this.spriteUtil,ni.loadData("scrollbar.dat",0,t),e,2),this.surface.parseSprite(this.spriteUtil+2,ni.loadData("corners.dat",0,t),e,4),this.surface.parseSprite(this.spriteUtil+6,ni.loadData("arrows.dat",0,t),e,2),this.surface.parseSprite(this.spriteProjectile,ni.loadData("projectile.dat",0,t),e,Be.projectileSprite);let i=Be.itemSpriteCount;for(let s=1;i>0;s++){let r=i;i-=30,r>30&&(r=30),this.surface.parseSprite(this.spriteItem+30*(s-1),ni.loadData("objects"+s+".dat",0,t),e,r)}this.surface.loadSprite(this.spriteMedia),this.surface.loadSprite(this.spriteMedia+9);for(let s=11;s<=26;s++)this.surface.loadSprite(this.spriteMedia+s);for(let s=0;s<Be.projectileSprite;s++)this.surface.loadSprite(this.spriteProjectile+s);for(let s=0;s<Be.itemSpriteCount;s++)this.surface.loadSprite(this.spriteItem+s)}drawChatMessageTabs(){this.surface.drawSpriteID(0,this.gameHeight-4,this.spriteMedia+23),this.surface.drawStringCenter("All messages",54,this.gameHeight+6,0,this.messageTabFlashAll%30>15?16724530:0===this.messageTabSelected?16762930:13158655),this.surface.drawStringCenter("Chat history",155,this.gameHeight+6,0,this.messageTabFlashHistory%30>15?16724530:1===this.messageTabSelected?16762930:13158655),this.surface.drawStringCenter("Quest history",255,this.gameHeight+6,0,this.messageTabFlashQuest%30>15?16724530:2===this.messageTabSelected?16762930:13158655),this.surface.drawStringCenter("Private history",355,this.gameHeight+6,0,this.messageTabFlashPrivate%30>15?16724530:3===this.messageTabSelected?16762930:13158655),this.surface.drawStringCenter("Report abuse",457,this.gameHeight+6,0,16777215)}async startGame(){let t=0;for(let i=0;i<99;i++){let e=i+1;t+=e+300*Math.pow(2,e/7)|0,this.experienceArray[i]=268435452&t}if(this.port=this.port||43595,await this.fetchDefinitions(),await this.fetchChatFilters(),this.errorLoadingData)return;this.spriteMedia=2e3,this.spriteUtil=this.spriteMedia+100,this.spriteItem=this.spriteUtil+50,this.spriteLogo=this.spriteItem+1e3,this.spriteProjectile=this.spriteLogo+10,this.spriteTexture=this.spriteProjectile+50,this.spriteTextureWorld=this.spriteTexture+10,this.graphics=this.getGraphics(),this.setTargetFps(50),this.surface=new $e(this.gameWidth,this.gameHeight+12,4e3,this),this.surface.mudclientref=this,this.surface.setBounds(0,0,this.gameWidth,this.gameHeight+12),We.drawBackgroundArrow=!1,We.baseSpriteStart=this.spriteUtil,this.panelMagic=new We(this.surface,5);let e=this.surface.width2-199;this.controlListMagic=this.panelMagic.addTextListInteractive(e,60,196,90,1,500,!0),this.panelSocialList=new We(this.surface,5),this.controlListSocialPlayers=this.panelSocialList.addTextListInteractive(e,76,196,126,1,500,!0),this.panelQuestList=new We(this.surface,5),this.controlListQuest=this.panelQuestList.addTextListInteractive(e,60,196,251,1,500,!0),await this.loadMedia(),this.errorLoadingData||(await this.loadEntities(),this.errorLoadingData||(this.scene=new Oe(this.surface,15e3,15e3,1e3),this.scene.view=Ne._from2(1e6,1e4),this.scene.setBounds(this.gameWidth/2|0,this.gameHeight/2|0,this.gameWidth/2|0,this.gameHeight/2|0,this.gameWidth,this.const_9),this.scene.clipFar3d=2400,this.scene.clipFar2d=2400,this.scene.fogZFalloff=1,this.scene.fogZDistance=2300,this.scene.setLightSourceCoords(-50,-10,-50),this.world=new Je(this.scene,this.surface),this.world.baseMediaSprite=this.spriteMedia,await this.loadTextures(),this.errorLoadingData||(await this.loadModels(),this.errorLoadingData||(await this.loadMaps(),this.errorLoadingData||(this.members&&await this.loadSounds(),this.errorLoadingData||(this.updateLoadingStatus(100,"Starting game..."),this.createMessageTabPanel(),this.createLoginPanels(),this.createAppearancePanel(),this.resetGameState(),this.renderLoginScreenViewports()))))))}drawUiTabMagic(t){let e=this.surface.width2-199;this.surface.drawSpriteID(e-49,3,this.spriteMedia+4);let i=0,r=i=gt.rgbToLong(160,160,160);if(0===this.tabMagicPrayer?r=gt.rgbToLong(220,220,220):i=gt.rgbToLong(220,220,220),this.surface.drawBoxAlpha(e,36,98,24,r,128),this.surface.drawBoxAlpha(e+98,36,98,24,i,128),this.surface.drawBoxAlpha(e,60,196,90,gt.rgbToLong(220,220,220),128),this.surface.drawBoxAlpha(e,150,196,68,gt.rgbToLong(160,160,160),128),this.surface.drawLineHoriz(e,60,196,0),this.surface.drawLineVert(e+98,36,24,0),this.surface.drawLineHoriz(e,149,196,0),this.surface.drawStringCenter("Magic",e+49,52,4,0),this.surface.drawStringCenter("Prayers",e+49+98,52,4,0),0===this.tabMagicPrayer){this.panelMagic.clearList(this.controlListMagic);let t=0;for(let e=0;e<Be.spellCount;e++){let i="@yel@";for(let t=0;t<Be.spellRunesRequired[e];t++){let s=Be.spellRunesId[e][t];if(!this.hasInventoryItems(s,Be.spellRunesCount[e][t])){i="@whi@";break}}let s=this.playerStatCurrent[6];Be.spellLevel[e]>s&&(i="@bla@"),this.panelMagic.addListEntry(this.controlListMagic,t++,i+"Level "+Be.spellLevel[e]+": "+Be.spellName[e])}this.panelMagic.render();let i=this.panelMagic.getListEntryIndex(this.controlListMagic);if(-1!==i){this.surface.drawString("Level "+Be.spellLevel[i]+": "+Be.spellName[i],e+2,160,1,16776960),this.surface.drawString(Be.spellDescription[i],e+2,172,0,16777215);for(let t=0;t<Be.spellRunesRequired[i];t++){let s=Be.spellRunesId[i][t];this.surface.drawSpriteID(e+2+44*t,186,this.spriteItem+Be.itemPicture[s]);let r=this.getInventoryCount(s),n=Be.spellRunesCount[i][t],o="@red@";this.hasInventoryItems(s,n)&&(o="@gre@"),this.surface.drawString(o+r+"/"+n,e+2+44*t,186,1,16777215)}}else this.surface.drawString("Point at a spell for a description",e+2,160,1,0)}if(1===this.tabMagicPrayer){this.panelMagic.clearList(this.controlListMagic);let t=0;for(let e=0;e<Be.prayerCount;e++){let i="@whi@";Be.prayerLevel[e]>this.playerStatBase[5]&&(i="@bla@"),this.prayerOn[e]&&(i="@gre@"),this.panelMagic.addListEntry(this.controlListMagic,t++,i+"Level "+Be.prayerLevel[e]+": "+Be.prayerName[e])}this.panelMagic.render();let i=this.panelMagic.getListEntryIndex(this.controlListMagic);-1!==i?(this.surface.drawStringCenter("Level "+Be.prayerLevel[i]+": "+Be.prayerName[i],e+98,166,1,16776960),this.surface.drawStringCenter(Be.prayerDescription[i],e+98,181,0,16777215),this.surface.drawStringCenter("Drain rate: "+Be.prayerDrain[i],e+98,196,1,0)):this.surface.drawString("Point at a prayer for a description",e+2,160,1,0)}if(!t)return;let n=this.mouseX-(this.surface.width2-199),o=this.mouseY-36;if(n>=0&&o>=0&&n<196&&o<182){if(this.panelMagic.handleMouse(n+(this.surface.width2-199),o+36,this.lastMouseButtonDown,this.mouseButtonDown,this.mouseScrollDelta),o<=24&&1===this.mouseButtonClick&&(n<98&&1===this.tabMagicPrayer?(this.tabMagicPrayer=0,this.panelMagic.resetListProps(this.controlListMagic)):n>98&&0===this.tabMagicPrayer&&(this.tabMagicPrayer=1,this.panelMagic.resetListProps(this.controlListMagic))),1===this.mouseButtonClick&&0===this.tabMagicPrayer){let t=this.panelMagic.getListEntryIndex(this.controlListMagic);if(-1!==t){let e=this.playerStatCurrent[6];if(Be.spellLevel[t]>e)this.showMessage("Your magic ability is not high enough for this spell",3);else{let e=0;for(e=0;e<Be.spellRunesRequired[t];e++){let i=Be.spellRunesId[t][e];if(!this.hasInventoryItems(i,Be.spellRunesCount[t][e])){this.showMessage("You don't have all the reagents you need for this spell",3),e=-1;break}}e===Be.spellRunesRequired[t]&&(this.selectedSpell=t,this.selectedItemInventoryIndex=-1)}}}if(1===this.mouseButtonClick&&1===this.tabMagicPrayer){let t=this.panelMagic.getListEntryIndex(this.controlListMagic);if(-1!==t){let e=this.playerStatBase[5];Be.prayerLevel[t]>e?this.showMessage("Your prayer ability is not high enough for this prayer",3):0===this.playerStatCurrent[5]?this.showMessage("You have run out of prayer points. Return to a church to recharge",3):this.prayerOn[t]?(this.clientStream.newPacket(s.PRAYER_OFF),this.clientStream.putByte(t),this.clientStream.sendPacket(),this.prayerOn[t]=!1,this.playSoundFile("prayeroff")):(this.clientStream.newPacket(s.PRAYER_ON),this.clientStream.putByte(t),this.clientStream.sendPacket(),this.prayerOn[t]=!0,this.playSoundFile("prayeron"))}}this.mouseButtonClick=0}}drawDialogShop(){if(0!==this.mouseButtonClick){this.mouseButtonClick=0;let t=this.mouseX-52,e=this.mouseY-44;if(!(t>=0&&e>=12&&t<408&&e<246))return this.clientStream.newPacket(s.SHOP_CLOSE),this.clientStream.sendPacket(),void(this.showDialogShop=!1);{let i=0;for(let s=0;s<5;s++)for(let r=0;r<8;r++){let n=7+49*r,o=28+34*s;t>n&&t<n+49&&e>o&&e<o+34&&-1!==this.shopItem[i]&&(this.shopSelectedItemIndex=i,this.shopSelectedItemType=this.shopItem[i]),i++}if(this.shopSelectedItemIndex>=0){let i=this.shopItem[this.shopSelectedItemIndex];if(-1!==i){if(this.shopItemCount[this.shopSelectedItemIndex]>0&&t>298&&e>=204&&t<408&&e<=215){let t=this.shopBuyPriceMod+this.shopItemPrice[this.shopSelectedItemIndex];t<10&&(t=10);let e=t*Be.itemBasePrice[i]/100|0;this.clientStream.newPacket(s.SHOP_BUY),this.clientStream.putShort(this.shopItem[this.shopSelectedItemIndex]),this.clientStream.putInt(e),this.clientStream.sendPacket()}if(this.getInventoryCount(i)>0&&t>2&&e>=229&&t<112&&e<=240){let t=this.shopSellPriceMod+this.shopItemPrice[this.shopSelectedItemIndex];t<10&&(t=10);let e=t*Be.itemBasePrice[i]/100|0;this.clientStream.newPacket(s.SHOP_SELL),this.clientStream.putShort(this.shopItem[this.shopSelectedItemIndex]),this.clientStream.putInt(e),this.clientStream.sendPacket()}}}}}this.surface.drawBox(52,44,408,12,192),this.surface.drawBoxAlpha(52,56,408,17,10000536,160),this.surface.drawBoxAlpha(52,73,8,170,10000536,160),this.surface.drawBoxAlpha(451,73,9,170,10000536,160),this.surface.drawBoxAlpha(52,243,408,47,10000536,160),this.surface.drawString("Buying and selling items",53,54,1,16777215);let t=16777215;this.mouseX>372&&this.mouseY>=44&&this.mouseX<460&&this.mouseY<56&&(t=16711680),this.surface.drawStringRight("Close window",458,54,1,t),this.surface.drawString("Shops stock in green",54,68,1,65280),this.surface.drawString("Number you own in blue",187,68,1,65535),this.surface.drawString("Your money: "+this.getInventoryCount(10)+"gp",332,68,1,16776960);let e=0;for(let s=0;s<5;s++)for(let t=0;t<8;t++){let i=59+49*t,r=72+34*s;this.shopSelectedItemIndex===e?this.surface.drawBoxAlpha(i,r,49,34,16711680,160):this.surface.drawBoxAlpha(i,r,49,34,13684944,160),this.surface.drawBoxEdge(i,r,50,35,0),-1!==this.shopItem[e]&&(this.surface._spriteClipping_from9(i,r,48,32,this.spriteItem+Be.itemPicture[this.shopItem[e]],Be.itemMask[this.shopItem[e]],0,0,!1),this.surface.drawString(this.shopItemCount[e].toString(),i+1,r+10,1,65280),this.surface.drawStringRight(this.getInventoryCount(this.shopItem[e]).toString(),i+47,r+10,1,65535)),e++}if(this.surface.drawLineHoriz(57,266,398,0),-1===this.shopSelectedItemIndex)return void this.surface.drawStringCenter("Select an object to buy or sell",256,258,3,16776960);let i=this.shopItem[this.shopSelectedItemIndex];if(-1!==i){if(this.shopItemCount[this.shopSelectedItemIndex]>0){let e=this.shopBuyPriceMod+this.shopItemPrice[this.shopSelectedItemIndex];e<10&&(e=10);let s=e*Be.itemBasePrice[i]/100|0;this.surface.drawString("Buy a new "+Be.itemName[i]+" for "+s+"gp",54,258,1,16776960),t=16777215,this.mouseX>350&&this.mouseY>=248&&this.mouseX<460&&this.mouseY<=259&&(t=16711680),this.surface.drawStringRight("Click here to buy",457,258,3,t)}else this.surface.drawStringCenter("This item is not currently available to buy",256,258,3,16776960);if(this.getInventoryCount(i)>0){let e=this.shopSellPriceMod+this.shopItemPrice[this.shopSelectedItemIndex];e<10&&(e=10);let s=e*Be.itemBasePrice[i]/100|0;return this.surface.drawStringRight("Sell your "+Be.itemName[i]+" for "+s+"gp",457,283,1,16776960),t=16777215,this.mouseX>54&&this.mouseY>=273&&this.mouseX<164&&this.mouseY<=284&&(t=16711680),void this.surface.drawString("Click here to sell",54,283,3,t)}this.surface.drawStringCenter("You do not have any of this item to sell",256,283,3,16776960)}}hasInventoryItems(t,e){return!(31!==t||!(this.isItemEquipped(197)||this.isItemEquipped(615)||this.isItemEquipped(682)))||!(32!==t||!(this.isItemEquipped(102)||this.isItemEquipped(616)||this.isItemEquipped(683)))||!(33!==t||!(this.isItemEquipped(101)||this.isItemEquipped(617)||this.isItemEquipped(684)))||!(34!==t||!(this.isItemEquipped(103)||this.isItemEquipped(618)||this.isItemEquipped(685)))||this.getInventoryCount(t)>=e}getHostnameIP(t){return ni.uint32ToIpAddress(t)}cantLogout(){this.logoutBoxFrames=0,this.showMessage("@cya@Sorry, you can't logout at the moment",3)}drawGame(){if(0!==this.deathScreenTimeout)return this.surface.fadeToBlack(),this.surface.drawStringCenter("Oh dear! You are dead...",this.gameWidth/2|0,this.gameHeight/2|0,7,16711680),this.drawChatMessageTabs(),void this.surface.draw(this.graphics,0,0);if(this.showAppearanceChange)return void this.drawAppearancePanelCharacterSprites();if(this.isSleeping)return this.surface.fadeToBlack(),Math.random()<=.15&&this.surface.drawStringCenter("ZZZ",80*Math.random()|0,334*Math.random()|0,5,16777215*Math.random()|0),Math.random()<=.15&&this.surface.drawStringCenter("ZZZ",512-(80*Math.random()|0),334*Math.random()|0,5,16777215*Math.random()|0),this.surface.drawBox((this.gameWidth>>1)-100,160,200,40,0),this.surface.drawStringCenter("You are sleeping",this.gameWidth/2|0,50,7,16776960),this.surface.drawStringCenter("Fatigue: "+(100*this.fatigueSleeping/750|0)+"%",this.gameWidth/2|0,90,7,16776960),this.surface.drawStringCenter("When you want to wake up just use your",this.gameWidth/2|0,140,5,16777215),this.surface.drawStringCenter("keyboard to type the word in the box below",this.gameWidth/2|0,160,5,16777215),this.surface.drawStringCenter(this.inputTextCurrent+"*",this.gameWidth/2|0,180,5,65535),null===this.sleepingStatusText?this.surface.drawSpriteID((this.gameWidth/2|0)-127,230,this.spriteTexture+1):this.surface.drawStringCenter(this.sleepingStatusText,this.gameWidth/2|0,260,5,16711680),this.surface.drawBoxEdge((this.gameWidth/2|0)-128,229,257,42,16777215),this.drawChatMessageTabs(),this.surface.drawStringCenter("If you can't read the word",this.gameWidth/2|0,290,1,16777215),this.surface.drawStringCenter("@yel@click here@whi@ to get a different one",this.gameWidth/2|0,305,1,16777215),void this.surface.draw(this.graphics,0,0);if(!this.world.playerAlive)return;for(let e=0;e<64;e++)this.scene.removeModel(this.world.roofModels[this.lastHeightOffset][e]),0===this.lastHeightOffset&&(this.scene.removeModel(this.world.wallModels[1][e]),this.scene.removeModel(this.world.roofModels[1][e]),this.scene.removeModel(this.world.wallModels[2][e]),this.scene.removeModel(this.world.roofModels[2][e])),this.options.showRoofs&&(this.fogOfWar=!0,0===this.lastHeightOffset&&0==(128&this.world.objectAdjacency.get(this.localPlayer.currentX/128|0,this.localPlayer.currentY/128|0))&&(this.scene.addModel(this.world.roofModels[this.lastHeightOffset][e]),0===this.lastHeightOffset&&(this.scene.addModel(this.world.wallModels[1][e]),this.scene.addModel(this.world.roofModels[1][e]),this.scene.addModel(this.world.wallModels[2][e]),this.scene.addModel(this.world.roofModels[2][e])),this.fogOfWar=!1));if(this.objectAnimationNumberFireLightningSpell!==this.lastObjectAnimationNumberFireLightningSpell){this.lastObjectAnimationNumberFireLightningSpell=this.objectAnimationNumberFireLightningSpell;for(let t=0;t<this.objectCount;t++)97===this.objectId[t]&&this.updateObjectAnimation(t,"firea"+(this.objectAnimationNumberFireLightningSpell+1)),274===this.objectId[t]&&this.updateObjectAnimation(t,"fireplacea"+(this.objectAnimationNumberFireLightningSpell+1)),1031===this.objectId[t]&&this.updateObjectAnimation(t,"lightning"+(this.objectAnimationNumberFireLightningSpell+1)),1036===this.objectId[t]&&this.updateObjectAnimation(t,"firespell"+(this.objectAnimationNumberFireLightningSpell+1)),1147===this.objectId[t]&&this.updateObjectAnimation(t,"spellcharge"+(this.objectAnimationNumberFireLightningSpell+1))}if(this.objectAnimationNumberTorch!==this.lastObjectAnimationNumberTorch){this.lastObjectAnimationNumberTorch=this.objectAnimationNumberTorch;for(let t=0;t<this.objectCount;t++)51===this.objectId[t]&&this.updateObjectAnimation(t,"torcha"+(this.objectAnimationNumberTorch+1)),143===this.objectId[t]&&this.updateObjectAnimation(t,"skulltorcha"+(this.objectAnimationNumberTorch+1))}if(this.objectAnimationNumberClaw!==this.lastObjectAnimationNumberClaw){this.lastObjectAnimationNumberClaw=this.objectAnimationNumberClaw;for(let t=0;t<this.objectCount;t++)1142===this.objectId[t]&&this.updateObjectAnimation(t,"clawspell"+(this.objectAnimationNumberClaw+1))}this.scene.reduceSprites(this.spriteCount),this.spriteCount=0;for(let e=0;e<this.playerCount;e++){let t=this.players[e];if(255!==t.colourBottom){let i=-this.world.getElevation(t.currentX,t.currentY),s=this.scene.addSprite(5e3+e,t.currentX,i,t.currentY,145,220,e+1e4);this.spriteCount++,t===this.localPlayer&&this.scene.setLocalPlayer(s),8===t.animationCurrent&&this.scene.setSpriteTranslateX(s,-30),9===t.animationCurrent&&this.scene.setSpriteTranslateX(s,30)}if(t.projectileRange>0){let e=null;if(-1!==t.attackingNpcServerIndex?e=this.npcsServer[t.attackingNpcServerIndex]:-1!==t.attackingPlayerServerIndex&&(e=this.playerServer[t.attackingPlayerServerIndex]),null!==e){let i=t.currentX,s=t.currentY,r=-this.world.getElevation(i,s)-110,n=e.currentX,o=e.currentY,a=-this.world.getElevation(n,o)-(Be.npcHeight[e.npcId]>>1)|0,h=(i*t.projectileRange+n*(this.projectileFactor-t.projectileRange))/this.projectileFactor|0,l=(r*t.projectileRange+a*(this.projectileFactor-t.projectileRange))/this.projectileFactor|0,c=(s*t.projectileRange+o*(this.projectileFactor-t.projectileRange))/this.projectileFactor|0;this.scene.addSprite(this.spriteProjectile+t.incomingProjectileSprite,h,l,c,32,32,0),this.spriteCount++}}}for(let e=0;e<this.npcCount;e++){let t=this.npcs[e],i=t.currentX,s=t.currentY,r=-this.world.getElevation(i,s),n=this.scene.addSprite(2e4+e,i,r,s,Be.npcWidth[t.npcId],Be.npcHeight[t.npcId],e+3e4);this.spriteCount++,8===t.animationCurrent&&this.scene.setSpriteTranslateX(n,-30),9===t.animationCurrent&&this.scene.setSpriteTranslateX(n,30)}for(let e=0;e<this.groundItemCount;e++){let t=this.groundItemX[e]*this.tileSize+64,i=this.groundItemY[e]*this.tileSize+64;this.scene.addSprite(4e4+this.groundItemId[e],t,-this.world.getElevation(t,i)-this.groundItemZ[e],i,96,64,e+2e4),this.spriteCount++}for(let e=0;e<this.teleportBubbleCount;e++){let t=this.teleportBubbleX[e]*this.tileSize+64,i=this.teleportBubbleY[e]*this.tileSize+64,s=this.teleportBubbleType[e];0===s&&(this.scene.addSprite(5e4+e,t,-this.world.getElevation(t,i),i,128,256,e+5e4),this.spriteCount++),1===s&&(this.scene.addSprite(5e4+e,t,-this.world.getElevation(t,i),i,128,64,e+5e4),this.spriteCount++)}if(this.surface.interlace=!1,this.surface.blackScreen(),this.surface.interlace=this.interlace,3===this.lastHeightOffset){let t=40+(3*Math.random()|0),e=40+(7*Math.random()|0);this.scene.createLightSource(t,e,-50,-10,-50)}if(this.itemsAboveHeadCount=0,this.receivedMessagesCount=0,this.healthBarCount=0,this.cameraAutoAngleDebug){if(this.optionCameraModeAuto&&!this.fogOfWar){let t=this.cameraAngle;this.autorotateCamera(),this.cameraAngle!==t&&(this.cameraAutoRotatePlayerX=this.localPlayer.currentX,this.cameraAutoRotatePlayerY=this.localPlayer.currentY)}this.scene.clipFar3d=3e3,this.scene.clipFar2d=3e3,this.scene.fogZFalloff=1,this.scene.fogZDistance=2800,this.cameraRotation=32*this.cameraAngle;let t=this.cameraAutoRotatePlayerX+this.cameraRotationX,e=this.cameraAutoRotatePlayerY+this.cameraRotationY;this.scene.setCamera(t,-this.world.getElevation(t,e),e,912,4*this.cameraRotation,0,2e3)}else{this.optionCameraModeAuto&&!this.fogOfWar&&this.autorotateCamera(),this.interlace?(this.scene.clipFar3d=2200,this.scene.clipFar2d=2200,this.scene.fogZFalloff=1,this.scene.fogZDistance=2100):(this.scene.clipFar3d=2400,this.scene.clipFar2d=2400,this.scene.fogZFalloff=1,this.scene.fogZDistance=2300),this.cameraZoom>Si&&(this.scene.clipFar3d+=1400,this.scene.clipFar2d+=1400,this.scene.fogZDistance+=1400);let t=this.cameraAutoRotatePlayerX+this.cameraRotationX,e=this.cameraAutoRotatePlayerY+this.cameraRotationY;this.scene.setCamera(t,-this.world.getElevation(t,e),e,912,4*this.cameraRotation,0,2*this.cameraZoom)}if(this.scene.render(),this.drawAboveHeadStuff(),this.mouseClickXStep>0?this.surface.drawSpriteID(this.mouseClickXX-8,this.mouseClickXY-8,this.spriteMedia+14+((24-this.mouseClickXStep)/6|0)):this.mouseClickXStep<0&&this.surface.drawSpriteID(this.mouseClickXX-8,this.mouseClickXY-8,this.spriteMedia+18+((24+this.mouseClickXStep)/6|0)),0!==this.systemUpdate){let t=this.systemUpdate/50|0,e=t/60|0;(t%=60)<10?this.surface.drawStringCenter("System update in: "+e+":0"+t,256,this.gameHeight-7,1,16776960):this.surface.drawStringCenter("System update in: "+e+":"+t,256,this.gameHeight-7,1,16776960)}let t=8;if(this.showFps&&this.fps>0&&(this.surface.drawStringCenter("Fps:"+this.fps,465,this.gameHeight-t,1,16776960),t+=20),!this.loadingArea){let e=2203-(this.localRegionY+this.planeHeight+this.regionY);if(this.localRegionX+this.planeWidth+this.regionX>=2640&&(e=-50),e>0){let i=1+(e/6|0);this.surface.drawSpriteID(453,this.gameHeight-(t+56),this.spriteMedia+13),this.surface.drawStringCenter("Wilderness",465,this.gameHeight-(t+20),1,16776960),this.surface.drawStringCenter("Level: "+i,465,this.gameHeight-(t+7),1,16776960),0===this.showUiWildWarn&&(this.showUiWildWarn=2)}0===this.showUiWildWarn&&e>-10&&e<=0&&(this.showUiWildWarn=1)}if(0===this.messageTabSelected)for(let e=0;e<5;e++)if(this.messageHistoryTimeout[e]>0){let t=this.messageHistory[e];this.surface.drawString(t,7,this.gameHeight-18-12*e,1,16776960)}this.panelGame[ai.CHAT].hide(this.controlTextListChat),this.panelGame[ai.CHAT].hide(this.controlTextListQuest),this.panelGame[ai.CHAT].hide(this.controlTextListPrivate),1===this.messageTabSelected?this.panelGame[ai.CHAT].show(this.controlTextListChat):2===this.messageTabSelected?this.panelGame[ai.CHAT].show(this.controlTextListQuest):3===this.messageTabSelected&&this.panelGame[ai.CHAT].show(this.controlTextListPrivate),We.textListEntryHeightMod=2,this.panelGame[ai.CHAT].render(),We.textListEntryHeightMod=0,this.surface.fadeThenDrawSpriteID(this.surface.width2-3-197,3,this.spriteMedia,128),this.drawUi(),this.surface.loggedIn=!1,this.drawChatMessageTabs(),this.surface.draw(this.graphics,0,0)}async loadSounds(){try{this.soundData=await this.readDataFile("sounds"+F.SOUNDS+".mem","Sound effects",90),this.audioPlayer=new Qe}catch(e){console.log("Unable to init sounds:"+e.message),console.error(e)}}isItemEquipped(t){for(let e=0;e<this.inventoryItemsCount;e++)if(this.inventoryItemId[e]===t&&1===this.inventoryEquipped[e])return!0;return!1}async loadEntities(){let t=null,e=null;if(null===(t=await this.readDataFile("entity"+F.ENTITY+".jag","people and monsters",30)))return void(this.errorLoadingData=!0);e=ni.loadData("index.dat",0,t);let i=null,s=null;if(this.members){if(null===(i=await this.readDataFile("entity"+F.ENTITY+".mem","member graphics",45)))return void(this.errorLoadingData=!0);s=ni.loadData("index.dat",0,i)}let r=0;this.anInt659=0,this.anInt660=this.anInt659;t:for(let n=0;n<Be.animationCount;n++){let o=Be.animationName[n];for(let t=0;t<n;t++)if(Be.animationName[t].toLowerCase()===o.toLowerCase()){Be.animationNumber[n]=Be.animationNumber[t];continue t}let a=ni.loadData(o+".dat",0,t),h=e;if(null===a&&this.members&&(a=ni.loadData(o+".dat",0,i),h=s),null!==a){if(this.surface.parseSprite(this.anInt660,a,h,15),r+=15,1===Be.animationHasA[n]){let n=ni.loadData(o+"a.dat",0,t),a=e;null===n&&this.members&&(n=ni.loadData(o+"a.dat",0,i),a=s),this.surface.parseSprite(this.anInt660+15,n,a,3),r+=3}if(1===Be.animationHasF[n]){let n=ni.loadData(o+"f.dat",0,t),a=e;null===n&&this.members&&(n=ni.loadData(o+"f.dat",0,i),a=s),this.surface.parseSprite(this.anInt660+18,n,a,9),r+=9}if(0!==Be.animationSomething[n])for(let t=this.anInt660;t<this.anInt660+27;t++)this.surface.loadSprite(t)}Be.animationNumber[n]=this.anInt660,this.anInt660+=27}console.log("Loaded: "+r+" frames of animation")}handleAppearancePanelControls(){if(this.panelGame[ai.APPEARANCE].handleMouse(this.mouseX,this.mouseY,this.lastMouseButtonDown,this.mouseButtonDown),this.panelGame[ai.APPEARANCE].isClicked(this.controlButtonAppearanceHead1))do{this.appearanceHeadType=(this.appearanceHeadType-1+Be.animationCount)%Be.animationCount}while(1!=(3&Be.animationSomething[this.appearanceHeadType])||0==(Be.animationSomething[this.appearanceHeadType]&4*this.appearanceHeadGender));if(this.panelGame[ai.APPEARANCE].isClicked(this.controlButtonAppearanceHead2))do{this.appearanceHeadType=(this.appearanceHeadType+1)%Be.animationCount}while(1!=(3&Be.animationSomething[this.appearanceHeadType])||0==(Be.animationSomething[this.appearanceHeadType]&4*this.appearanceHeadGender));if(this.panelGame[ai.APPEARANCE].isClicked(this.controlButtonAppearanceHair1)&&(this.appearanceHairColour=(this.appearanceHairColour-1+this.characterHairColours.length)%this.characterHairColours.length),this.panelGame[ai.APPEARANCE].isClicked(this.controlButtonAppearanceHair2)&&(this.appearanceHairColour=(this.appearanceHairColour+1)%this.characterHairColours.length),this.panelGame[ai.APPEARANCE].isClicked(this.controlButtonAppearanceGender1)||this.panelGame[ai.APPEARANCE].isClicked(this.controlButtonAppearanceGender2)){for(this.appearanceHeadGender=3-this.appearanceHeadGender;1!=(3&Be.animationSomething[this.appearanceHeadType])||0==(Be.animationSomething[this.appearanceHeadType]&4*this.appearanceHeadGender);this.appearanceHeadType=(this.appearanceHeadType+1)%Be.animationCount);for(;2!=(3&Be.animationSomething[this.appearanceBodyGender])||0==(Be.animationSomething[this.appearanceBodyGender]&4*this.appearanceHeadGender);this.appearanceBodyGender=(this.appearanceBodyGender+1)%Be.animationCount);}this.panelGame[ai.APPEARANCE].isClicked(this.controlButtonAppearanceTop1)&&(this.appearanceTopColour=(this.appearanceTopColour-1+this.characterTopBottomColours.length)%this.characterTopBottomColours.length),this.panelGame[ai.APPEARANCE].isClicked(this.controlButtonAppearanceTop2)&&(this.appearanceTopColour=(this.appearanceTopColour+1)%this.characterTopBottomColours.length),this.panelGame[ai.APPEARANCE].isClicked(this.controlButtonAppearanceSkin1)&&(this.appearanceSkinColour=(this.appearanceSkinColour-1+this.characterSkinColours.length)%this.characterSkinColours.length),this.panelGame[ai.APPEARANCE].isClicked(this.controlButtonAppearanceSkin2)&&(this.appearanceSkinColour=(this.appearanceSkinColour+1)%this.characterSkinColours.length),this.panelGame[ai.APPEARANCE].isClicked(this.controlButtonAppearanceBottom1)&&(this.appearanceBottomColour=(this.appearanceBottomColour-1+this.characterTopBottomColours.length)%this.characterTopBottomColours.length),this.panelGame[ai.APPEARANCE].isClicked(this.controlButtonAppearanceBottom2)&&(this.appearanceBottomColour=(this.appearanceBottomColour+1)%this.characterTopBottomColours.length),this.panelGame[ai.APPEARANCE].isClicked(this.controlButtonAppearanceAccept)&&(this.clientStream.newPacket(s.APPEARANCE),this.clientStream.putByte(this.appearanceHeadGender),this.clientStream.putByte(this.appearanceHeadType),this.clientStream.putByte(this.appearanceBodyGender),this.clientStream.putByte(this.appearance2Colour),this.clientStream.putByte(this.appearanceHairColour),this.clientStream.putByte(this.appearanceTopColour),this.clientStream.putByte(this.appearanceBottomColour),this.clientStream.putByte(this.appearanceSkinColour),this.clientStream.sendPacket(),this.surface.blackScreen(),this.showAppearanceChange=!1)}draw(){if(this.surface){if(this.errorLoadingData){let t=this.getGraphics();return t.setColor(r.black),t.fillRect(0,0,this.gameWidth,this.gameHeight),t.setFont(u.HELVETICA.withConfig(FontStyle.BOLD,16)),t.setColor(r.yellow),t.drawString("Sorry, an error has occurred whilst loading RSCGo",30,35),t.setColor(r.white),t.drawString("To fix this try the following (in order):",30,85),t.setFont(u.HELVETICA.withConfig(FontStyle.BOLD,12)),t.drawString("1: Try closing ALL open web-browser windows, and reloading",30,135),t.drawString("2: Try clearing your web-browsers cache from tools->internet options",30,165),t.drawString("3: Try using a different game-world",30,195),t.drawString("4: Try rebooting your computer",30,225),t.drawString("5: Try selecting a different version of Java from the play-game menu",30,255),void this.setTargetFps(1)}if(this.errorLoadingCodebase){let t=this.getGraphics();return t.setColor(r.black),t.fillRect(0,0,this.gameWidth,this.gameHeight),t.setFont(u.HELVETICA.withConfig(FontStyle.BOLD,20)),t.setColor(r.white),t.drawString("Error - unable to load game!",50,50),t.drawString("To play RuneScape make sure you play from",50,100),t.drawString("http://rscgo.com",50,150),void this.setTargetFps(1)}if(this.runtimeException){let t=this.getGraphics();return t.setColor(r.black),t.fillRect(0,0,this.gameWidth,this.gameHeight),t.setFont(u.HELVETICA.withConfig(FontStyle.BOLD,20)),t.setColor(r.white),t.drawString("Error - out of memory!",50,50),t.drawString("Close ALL unnecessary programs",50,100),t.drawString("and windows before loading the game",50,150),t.drawString("RuneScape needs about 48meg of spare RAM",50,200),void this.setTargetFps(1)}try{this.gameState===oi.LOGIN&&(this.surface.loggedIn=!1,this.drawLoginScreens()),this.gameState===oi.WORLD&&(this.surface.loggedIn=!0,this.drawGame())}catch(e){console.error(e),this.clearResources(),this.runtimeException=!0}}}clearResources(){this.closeConnection(),this.freeCacheMemory(),null!==this.audioPlayer&&this.audioPlayer.stopPlayer()}drawDialogDuelConfirm(){this.surface.drawBox(22,36,468,16,192),this.surface.drawBoxAlpha(22,52,468,246,10000536,160),this.surface.drawStringCenter("Please confirm your duel with @yel@"+ni.hashToUsername(this.duelOpponentNameHash),256,48,1,16777215),this.surface.drawStringCenter("Your stake:",139,66,1,16776960);for(let t=0;t<this.duelItemsCount;t++){let e=Be.itemName[this.duelItems[t]];0===Be.itemStackable[this.duelItems[t]]&&(e=e+" x "+yi.formatNumber(this.duelItemCount[t])),this.surface.drawStringCenter(e,139,78+12*t,1,16777215)}0===this.duelItemsCount&&this.surface.drawStringCenter("Nothing!",139,78,1,16777215),this.surface.drawStringCenter("Your opponent's stake:",373,66,1,16776960);for(let t=0;t<this.duelOpponentItemsCount;t++){let e=Be.itemName[this.duelOpponentItems[t]];0===Be.itemStackable[this.duelOpponentItems[t]]&&(e=e+" x "+yi.formatNumber(this.duelOpponentItemCount[t])),this.surface.drawStringCenter(e,373,78+12*t,1,16777215)}0===this.duelOpponentItemsCount&&this.surface.drawStringCenter("Nothing!",373,78,1,16777215),0===this.duelOptionRetreat?this.surface.drawStringCenter("You can retreat from this duel",256,216,1,65280):this.surface.drawStringCenter("No retreat is possible!",256,216,1,16711680),0===this.duelOptionMagic?this.surface.drawStringCenter("Magic may be used",256,228,1,65280):this.surface.drawStringCenter("Magic cannot be used",256,228,1,16711680),0===this.duelOptionPrayer?this.surface.drawStringCenter("Prayer may be used",256,240,1,65280):this.surface.drawStringCenter("Prayer cannot be used",256,240,1,16711680),0===this.duelOptionWeapons?this.surface.drawStringCenter("Weapons may be used",256,252,1,65280):this.surface.drawStringCenter("Weapons cannot be used",256,252,1,16711680),this.surface.drawStringCenter("If you are sure click 'Accept' to begin the duel",256,266,1,16777215),this.duelAccepted?this.surface.drawStringCenter("Waiting for other player...",256,286,1,16776960):(this.surface.drawSpriteID(105,274,this.spriteMedia+25),this.surface.drawSpriteID(339,274,this.spriteMedia+26)),1===this.mouseButtonClick&&((this.mouseX<22||this.mouseY<36||this.mouseX>490||this.mouseY>298)&&(this.showDialogDuelConfirm=!1,this.clientStream.newPacket(s.TRADE_DECLINE),this.clientStream.sendPacket()),this.mouseX>=105&&this.mouseX<=210&&this.mouseY>=274&&this.mouseY<=295&&(this.duelAccepted=!0,this.clientStream.newPacket(s.DUEL_CONFIRM_ACCEPT),this.clientStream.sendPacket()),this.mouseX>=339&&this.mouseX<=445&&this.mouseY>=274&&this.mouseY<=295&&(this.showDialogDuelConfirm=!1,this.clientStream.newPacket(s.DUEL_DECLINE),this.clientStream.sendPacket()),this.mouseButtonClick=0)}walkToGroundItem(t,e,i,s,r){this.walkTo(t,e,i,s,i,s,!1,r)||this._walkToActionSource_from8(t,e,i,s,i,s,!0,r)}async loadModels(){Be.getModelIndex("torcha2"),Be.getModelIndex("torcha3"),Be.getModelIndex("torcha4"),Be.getModelIndex("skulltorcha2"),Be.getModelIndex("skulltorcha3"),Be.getModelIndex("skulltorcha4"),Be.getModelIndex("firea2"),Be.getModelIndex("firea3"),Be.getModelIndex("fireplacea2"),Be.getModelIndex("fireplacea3"),Be.getModelIndex("firespell2"),Be.getModelIndex("firespell3"),Be.getModelIndex("lightning2"),Be.getModelIndex("lightning3"),Be.getModelIndex("clawspell2"),Be.getModelIndex("clawspell3"),Be.getModelIndex("clawspell4"),Be.getModelIndex("clawspell5"),Be.getModelIndex("spellcharge2"),Be.getModelIndex("spellcharge3");let t=await this.readDataFile("models"+F.MODELS+".jag","3d models",60);if(null!==t)for(let e=0;e<Be.modelCount;e++){let i=ni.getDataFileOffset(Be.modelName[e]+".ob3",t);this.gameModels[e]=0!==i?Ne._from3(t,i,!0):Ne._from2(1,1),"giantcrystal"===Be.modelName[e].toLowerCase()&&(this.gameModels[e].transparent=!0)}else this.errorLoadingData=!0}drawDialogServermessage(){let t=100;this.serverMessageBoxTop&&(t=450,t=300),this.surface.drawBox(56,167-(t/2|0),400,t,0),this.surface.drawBoxEdge(56,167-(t/2|0),400,t,16777215),this.surface.centrepara(this.serverMessage,256,167-(t/2|0)+20,1,16777215,360);let e=157+(t/2|0),i=16777215;this.mouseY>e-12&&this.mouseY<=e&&this.mouseX>106&&this.mouseX<406&&(i=16711680),this.surface.drawStringCenter("Click here to close window",256,e,1,i),1===this.mouseButtonClick&&(16711680===i&&(this.showDialogServermessage=!1),(this.mouseX<56||this.mouseX>456)&&(this.mouseY<167-(t/2|0)||this.mouseY>167+(t/2|0))&&(this.showDialogServermessage=!1)),this.mouseButtonClick=0}drawDialogReportAbuseInput(){if(this.inputTextFinal.length>0){let t=this.inputTextFinal.trim();if(this.inputTextCurrent="",this.inputTextFinal="",t.length>0){let e=ni.encodeBase37(t);this.clientStream.newPacket(s.REPORT_ABUSE),this.clientStream.putLong(e),this.clientStream.putByte(this.reportAbuseOffence),this.clientStream.putByte(this.reportAbuseMute?1:0),this.clientStream.sendPacket()}return void(this.showDialogReportAbuseStep=0)}this.surface.drawBox(56,130,400,100,0),this.surface.drawBoxEdge(56,130,400,100,16777215);let t=160;this.surface.drawStringCenter("Now type the name of the offending player, and press enter",256,t,1,16776960),t+=18,this.surface.drawStringCenter("Name: "+this.inputTextCurrent+"*",256,t,4,16777215),this.moderatorLevel>0&&(t=207,this.reportAbuseMute?this.surface.drawStringCenter("Moderator option: Mute player for 48 hours: <ON>",256,t,1,16744448):this.surface.drawStringCenter("Moderator option: Mute player for 48 hours: <OFF>",256,t,1,16777215),this.mouseX>106&&this.mouseX<406&&this.mouseY>t-13&&this.mouseY<t+2&&1===this.mouseButtonClick&&(this.mouseButtonClick=0,this.reportAbuseMute=!this.reportAbuseMute)),t=222;let e=16777215;this.mouseX>196&&this.mouseX<316&&this.mouseY>t-13&&this.mouseY<t+2&&(e=16776960,1===this.mouseButtonClick&&(this.mouseButtonClick=0,this.showDialogReportAbuseStep=0)),this.surface.drawStringCenter("Click here to cancel",256,t,1,e),1===this.mouseButtonClick&&(this.mouseX<56||this.mouseX>456||this.mouseY<130||this.mouseY>230)&&(this.mouseButtonClick=0,this.showDialogReportAbuseStep=0)}showMessage(t,e){if(2===e||4===e||6===e){for(;t.length>5&&"@"===t[0]&&"@"===t[4];t=t.substring(5));let e=t.indexOf(":");if(-1!==e){let i=t.substring(0,e),s=ni.encodeBase37(i);for(let t=0;t<this.ignoreListCount;t++)if(this.ignoreList[t].equals(s))return}}2===e&&(t="@yel@"+t),3!==e&&4!==e||(t="@whi@"+t),6===e&&(t="@cya@"+t),0!==this.messageTabSelected&&(4!==e&&3!==e||(this.messageTabFlashAll=200),2===e&&1!==this.messageTabSelected&&(this.messageTabFlashHistory=200),5===e&&2!==this.messageTabSelected&&(this.messageTabFlashQuest=200),6===e&&3!==this.messageTabSelected&&(this.messageTabFlashPrivate=200),3===e&&0!==this.messageTabSelected&&(this.messageTabSelected=0),6===e&&3!==this.messageTabSelected&&0!==this.messageTabSelected&&(this.messageTabSelected=0));for(let i=4;i>0;i--)this.messageHistory[i]=this.messageHistory[i-1],this.messageHistoryTimeout[i]=this.messageHistoryTimeout[i-1];if(this.messageHistory[0]=t,this.messageHistoryTimeout[0]=300,2===e&&(this.panelGame[ai.CHAT].controlFlashText[this.controlTextListChat]===this.panelGame[ai.CHAT].controlListEntryCount[this.controlTextListChat]-4?this.panelGame[ai.CHAT].removeListEntry(this.controlTextListChat,t,!0):this.panelGame[ai.CHAT].removeListEntry(this.controlTextListChat,t,!1)),5===e&&(this.panelGame[ai.CHAT].controlFlashText[this.controlTextListQuest]===this.panelGame[ai.CHAT].controlListEntryCount[this.controlTextListQuest]-4?this.panelGame[ai.CHAT].removeListEntry(this.controlTextListQuest,t,!0):this.panelGame[ai.CHAT].removeListEntry(this.controlTextListQuest,t,!1)),6===e){if(this.panelGame[ai.CHAT].controlFlashText[this.controlTextListPrivate]===this.panelGame[ai.CHAT].controlListEntryCount[this.controlTextListPrivate]-4)return void this.panelGame[ai.CHAT].removeListEntry(this.controlTextListPrivate,t,!0);this.panelGame[ai.CHAT].removeListEntry(this.controlTextListPrivate,t,!1)}}walkToObject(t,e,i,s){let r=0,n=0;0===i||4===i?(r=Be.objectWidth[s],n=Be.objectHeight[s]):(n=Be.objectWidth[s],r=Be.objectHeight[s]),2===Be.objectType[s]||3===Be.objectType[s]?(0===i&&(t--,r++),2===i&&n++,4===i&&r++,6===i&&(e--,n++),this._walkToActionSource_from8(this.localRegionX,this.localRegionY,t,e,t+r-1,e+n-1,!1,!0)):this._walkToActionSource_from8(this.localRegionX,this.localRegionY,t,e,t+r-1,e+n-1,!0,!0)}getInventoryCount(t){let e=0;for(let i=0;i<this.inventoryItemsCount;i++)this.inventoryItemId[i]===t&&(1===Be.itemStackable[t]?e++:e+=this.inventoryItemStackCount[i]);return e}drawLoginScreens(){if(this.welcomScreenAlreadyShown=!1,this.surface.interlace=!1,this.surface.blackScreen(),this.welcomeState!==hi.NEW_USER){let t=2*this.frameCounter%3072;t<1024?(this.surface.drawSpriteID(0,10,this.spriteLogo),t>768&&this.surface.fadeThenDrawSpriteID(0,10,this.spriteLogo+1,t-768)):t<2048?(this.surface.drawSpriteID(0,10,this.spriteLogo+1),t>1792&&this.surface.fadeThenDrawSpriteID(0,10,this.spriteMedia+10,t-1792)):(this.surface.drawSpriteID(0,10,this.spriteMedia+10),t>2816&&this.surface.fadeThenDrawSpriteID(0,10,this.spriteLogo,t-2816))}this.welcomeState===hi.WELCOME&&this.panelLogin[hi.WELCOME].render(),this.welcomeState===hi.NEW_USER&&this.panelLogin[hi.NEW_USER].render(),this.welcomeState===hi.EXISTING_USER&&this.panelLogin[hi.EXISTING_USER].render(),this.surface.drawSpriteID(0,this.gameHeight-4,this.spriteMedia+22),this.surface.draw(this.graphics,0,0)}drawUiTabOptions(t){let e=this.surface.width2-199;this.surface.drawSpriteID(e-49,3,this.spriteMedia+6),this.surface.drawBoxAlpha(e,36,196,65,gt.rgbToLong(181,181,181),160),this.surface.drawBoxAlpha(e,101,196,65,gt.rgbToLong(201,201,201),160),this.surface.drawBoxAlpha(e,166,196,95,gt.rgbToLong(181,181,181),160),this.surface.drawBoxAlpha(e,261,196,40,gt.rgbToLong(201,201,201),160);let i=e+3,r=51;this.surface.drawString("Game options - click to toggle",i,r,1,0),r+=15,this.optionCameraModeAuto?this.surface.drawString("Camera angle mode - @gre@Auto",i,r,1,16777215):this.surface.drawString("Camera angle mode - @red@Manual",i,r,1,16777215),r+=15,this.optionMouseButtonOne?this.surface.drawString("Mouse buttons - @red@One",i,r,1,16777215):this.surface.drawString("Mouse buttons - @gre@Two",i,r,1,16777215),r+=15,this.optionSoundDisabled?this.surface.drawString("Sound effects - @red@off",i,r,1,16777215):this.surface.drawString("Sound effects - @gre@on",i,r,1,16777215),r+=15,r+=5,this.surface.drawString("Account Settings",i,r,1,0);let n=16777215;r+=15,this.mouseX>i&&this.mouseX<i+196&&this.mouseY>r-12&&this.mouseY<r+4&&(n=16776960),this.surface.drawString("Change password",i,r,1,n),n=16777215,r+=15,this.mouseX>i&&this.mouseX<i+196&&this.mouseY>r-12&&this.mouseY<r+4&&(n=16776960),this.surface.drawString("Set recovery questions",i,r,1,n),r+=15,r+=5,this.surface.drawString("Privacy settings. Will be applied to",e+3,r,1,0),r+=15,this.surface.drawString("all people not on your friends list",e+3,r,1,0),r+=15,0===this.settingsBlockChat?this.surface.drawString("Block chat messages: @red@<off>",e+3,r,1,16777215):this.surface.drawString("Block chat messages: @gre@<on>",e+3,r,1,16777215),r+=15,0===this.settingsBlockPrivate?this.surface.drawString("Block private messages: @red@<off>",e+3,r,1,16777215):this.surface.drawString("Block private messages: @gre@<on>",e+3,r,1,16777215),r+=15,0===this.settingsBlockTrade?this.surface.drawString("Block trade requests: @red@<off>",e+3,r,1,16777215):this.surface.drawString("Block trade requests: @gre@<on>",e+3,r,1,16777215),r+=15,0===this.settingsBlockDuel?this.surface.drawString("Block duel requests: @red@<off>",e+3,r,1,16777215):this.surface.drawString("Block duel requests: @gre@<on>",e+3,r,1,16777215),r+=15,r+=5,this.surface.drawString("Always logout when you finish",i,r,1,0),r+=15;let o=16777215;if(this.mouseX>i&&this.mouseX<i+196&&this.mouseY>r-12&&this.mouseY<r+4&&(o=16776960),this.surface.drawString("Click here to logout",e+3,r,1,o),!t)return;let a=this.mouseX-(this.surface.width2-199),h=this.mouseY-36;if(a>=0&&h>=0&&a<196&&h<265){let t=196,e=this.surface.width2-199+3,i=66;1===this.mouseButtonClick&&(this.mouseX>e&&this.mouseX<e+t&&this.mouseY>i-12&&this.mouseY<i+4&&(this.optionCameraModeAuto=!this.optionCameraModeAuto,this.clientStream.newPacket(s.SETTINGS_GAME),this.clientStream.putByte(0),this.clientStream.putByte(this.optionCameraModeAuto?1:0),this.clientStream.sendPacket()),this.mouseX>e&&this.mouseX<e+t&&this.mouseY>i+15-12&&this.mouseY<i+15+4&&(this.optionMouseButtonOne=!this.optionMouseButtonOne,this.clientStream.newPacket(s.SETTINGS_GAME),this.clientStream.putByte(2),this.clientStream.putByte(this.optionMouseButtonOne?1:0),this.clientStream.sendPacket()),this.mouseX>e&&this.mouseX<e+t&&this.mouseY>i+30-12&&this.mouseY<i+30+4&&(this.optionSoundDisabled=!this.optionSoundDisabled,this.clientStream.newPacket(s.SETTINGS_GAME),this.clientStream.putByte(3),this.clientStream.putByte(this.optionSoundDisabled?1:0),this.clientStream.sendPacket())),i+=45,i+=5,i+=15,i+=15,i+=15,i+=5,i+=15,i+=15,1===this.mouseButtonClick&&(this.mouseX>e&&this.mouseX<e+t&&this.mouseY>i-12&&this.mouseY<i+4&&(this.settingsBlockChat=1-this.settingsBlockChat,this.sendPrivacySettings(this.settingsBlockChat,this.settingsBlockPrivate,this.settingsBlockTrade,this.settingsBlockDuel)),this.mouseX>e&&this.mouseX<e+t&&this.mouseY>i+15-12&&this.mouseY<i+15+4&&(this.settingsBlockPrivate=1-this.settingsBlockPrivate,this.sendPrivacySettings(this.settingsBlockChat,this.settingsBlockPrivate,this.settingsBlockTrade,this.settingsBlockDuel)),this.mouseX>e&&this.mouseX<e+t&&this.mouseY>i+30-12&&this.mouseY<i+30+4&&(this.settingsBlockTrade=1-this.settingsBlockTrade,this.sendPrivacySettings(this.settingsBlockChat,this.settingsBlockPrivate,this.settingsBlockTrade,this.settingsBlockDuel)),this.mouseX>e&&this.mouseX<e+t&&this.mouseY>i+45-12&&this.mouseY<i+45+4&&(this.settingsBlockDuel=1-this.settingsBlockDuel,this.sendPrivacySettings(this.settingsBlockChat,this.settingsBlockPrivate,this.settingsBlockTrade,this.settingsBlockDuel))),i+=60,i+=15,i+=5,this.mouseX>e&&this.mouseX<e+t&&this.mouseY>i-12&&this.mouseY<i+4&&1===this.mouseButtonClick&&this.sendLogout(),this.mouseButtonClick=0}}async loadTextures(){let t=await this.readDataFile("textures"+F.TEXTURES+".jag","Textures",50);if(null===t)return void(this.errorLoadingData=!0);let e=ni.loadData("index.dat",0,t);this.scene.allocateTextures(Be.textureCount,7,11);for(let i=0;i<Be.textureCount;i++){let s=Be.textureName[i],r=ni.loadData(s+".dat",0,t);this.surface.parseSprite(this.spriteTexture,r,e,1),this.surface.drawBox(0,0,128,128,16711935),this.surface.drawSpriteID(0,0,this.spriteTexture);let n=this.surface.spriteWidthFull[this.spriteTexture],o=Be.textureSubtypeName[i];if(null!==o&&o.length>0){let i=ni.loadData(o+".dat",0,t);this.surface.parseSprite(this.spriteTexture,i,e,1),this.surface.drawSpriteID(0,0,this.spriteTexture)}this.surface._drawSprite_from5(this.spriteTextureWorld+i,0,0,n,n);let a=n*n;for(let t=0;t<a;t++)65280===this.surface.surfacePixels[this.spriteTextureWorld+i][t]&&(this.surface.surfacePixels[this.spriteTextureWorld+i][t]=16711935);this.surface.drawWorld(this.spriteTextureWorld+i),this.scene.defineTexture(i,this.surface.spriteColoursUsed[this.spriteTextureWorld+i],this.surface.spriteColourList[this.spriteTextureWorld+i],(n/64|0)-1)}}handleMouseDown(t,e,i){this.mouseClickXHistory[this.mouseClickCount]=e,this.mouseClickYHistory[this.mouseClickCount]=i,this.mouseClickCount=this.mouseClickCount+1&8191;for(let s=10;s<4e3;s++){let t=this.mouseClickCount-s&8191;if(this.mouseClickXHistory[t]===e&&this.mouseClickYHistory[t]===i){let r=!1;for(let n=1;n<s;n++){let o=this.mouseClickCount-n&8191,a=t-n&8191;if(this.mouseClickXHistory[a]===e&&this.mouseClickYHistory[a]===i||(r=!0),this.mouseClickXHistory[o]!==this.mouseClickXHistory[a]||this.mouseClickYHistory[o]!==this.mouseClickYHistory[a])break;if(n===s-1&&r&&0===this.combatTimeout&&0===this.logoutBoxFrames)return void this.sendLogout()}}}}drawTeleportBubble(t,e,i,s,r,n,o){let a=this.teleportBubbleType[r],h=this.teleportBubbleTime[r];if(0===a){let r=255+5*h*256;this.surface.drawCircle(t+(i/2|0),e+(s/2|0),20+2*h,r,255-5*h)}if(1===a){let r=16711680+5*h*256;this.surface.drawCircle(t+(i/2|0),e+(s/2|0),10+h,r,255-5*h)}}showServerMessage(t){/^@bor@/.test(t)?this.showMessage(t,4):/^@que@/.test(t)?this.showMessage("@whi@"+t,5):/^@pri@/.test(t)?this.showMessage(t,6):this.showMessage(t,3)}updateObjectAnimation(t,e){let i=this.objectX[t],s=this.objectY[t],r=i-(this.localPlayer.currentX/128|0),n=s-(this.localPlayer.currentY/128|0);if(i>=0&&s>=0&&i<96&&s<96&&r>-7&&r<7&&n>-7&&n<7){this.scene.removeModel(this.objectModel[t]);let i=Be.getModelIndex(e),s=this.gameModels[i].copy();this.scene.addModel(s),s.createGouraudLightSource(!0,48,48,-50,-10,-50),s.copyPosition(this.objectModel[t]),s.key=t,this.objectModel[t]=s}}refreshRightClickMenu(){(this.selectedSpell>=0||this.selectedItemInventoryIndex>=0)&&(this.menuItemText1[this.menuItemsCount]="Cancel",this.menuItemText2[this.menuItemsCount]="",this.menuItemID[this.menuItemsCount]=4e3,this.menuItemsCount++);for(let t=0;t<this.menuItemsCount;t++)this.menuIndices[t]=t;for(let t=!1;!t;){t=!0;for(let e=0;e<this.menuItemsCount-1;e++){let i=this.menuIndices[e],s=this.menuIndices[e+1];this.menuItemID[i]>this.menuItemID[s]&&(this.menuIndices[e]=s,this.menuIndices[e+1]=i,t=!1)}}if(this.menuItemsCount>20&&(this.menuItemsCount=20),this.menuItemsCount>0){let t=-1;for(let i=0;i<this.menuItemsCount;i++)if(!(null===this.menuItemText2[this.menuIndices[i]]||this.menuItemText2[this.menuIndices[i]].length<=0)){t=i;break}let e="";if((this.selectedItemInventoryIndex>=0||this.selectedSpell>=0)&&1===this.menuItemsCount?e="Choose a target":(this.selectedItemInventoryIndex>=0||this.selectedSpell>=0)&&this.menuItemsCount>1?e="@whi@"+this.menuItemText1[this.menuIndices[0]]+" "+this.menuItemText2[this.menuIndices[0]]:-1!==t&&(e=this.menuItemText2[this.menuIndices[t]]+": @whi@"+this.menuItemText1[this.menuIndices[0]]),2===this.menuItemsCount&&e.length>0&&(e+="@whi@ / 1 more option"),this.menuItemsCount>2&&e.length>0&&(e=e+"@whi@ / "+(this.menuItemsCount-1)+" more options"),0!==e.length&&this.surface.drawString(e,6,14,1,16776960),!this.optionMouseButtonOne&&1===this.mouseButtonClick||this.optionMouseButtonOne&&1===this.mouseButtonClick&&1===this.menuItemsCount)return this.menuItemClick(this.menuIndices[0]),void(this.mouseButtonClick=0);if(!this.optionMouseButtonOne&&2===this.mouseButtonClick||this.optionMouseButtonOne&&1===this.mouseButtonClick){this.menuHeight=15*(this.menuItemsCount+1),this.menuWidth=this.surface.textWidth("Choose option",1)+5;for(let t=0;t<this.menuItemsCount;t++){let e=this.surface.textWidth(this.menuItemText2[t]+" "+this.menuItemText1[t],1)+5;e>this.menuWidth&&(this.menuWidth=e)}this.menuX=this.mouseX-this.menuWidth/2|0,this.menuY=this.mouseY-15,this.showRightClickMenu=!0,this.menuX<0&&(this.menuX=5),this.menuY<0&&(this.menuY=5),this.menuX+this.menuWidth>512&&(this.menuX=512-this.menuWidth-2),this.menuY+this.menuHeight>334&&(this.menuY=334-this.menuHeight-17),this.mouseButtonClick=0}}}drawDialogLogout(){this.surface.drawBox(126,137,260,60,0),this.surface.drawBoxEdge(126,137,260,60,16777215),this.surface.drawStringCenter("Logging out...",256,173,5,16777215)}drawDialogCombatStyle(){if(0!==this.mouseButtonClick)for(let t=0;t<5;t++)if(!(t<=0||this.mouseX<=7||this.mouseX>=182||this.mouseY<=15+20*t||this.mouseY>=15+20*t+20)){this.combatStyle=t-1,this.mouseButtonClick=0,this.clientStream.newPacket(s.COMBAT_STYLE),this.clientStream.putByte(this.combatStyle),this.clientStream.sendPacket();break}for(let t=0;t<5;t++)t===this.combatStyle+1?this.surface.drawBoxAlpha(7,15+20*t,175,20,gt.rgbToLong(255,0,0),128):this.surface.drawBoxAlpha(7,15+20*t,175,20,gt.rgbToLong(190,190,190),128),this.surface.drawLineHoriz(7,15+20*t,175,0),this.surface.drawLineHoriz(7,15+20*t+20,175,0);this.surface.drawStringCenter("Select combat style",94,31,3,16777215),this.surface.drawStringCenter("Controlled (+1 of each)",94,51,3,0),this.surface.drawStringCenter("Aggressive (+3 strength)",94,71,3,0),this.surface.drawStringCenter("Accurate   (+3 attack)",94,91,3,0),this.surface.drawStringCenter("Defensive  (+3 defense)",94,111,3,0)}menuItemClick(t){let e=this.menuItemX[t],i=this.menuItemY[t],r=this.menuSourceType[t],n=this.menuSourceIndex[t],o=this.menuTargetIndex[t],a=this.menuItemID[t];if(200===a&&(this.walkToGroundItem(this.localRegionX,this.localRegionY,e,i,!0),this.clientStream.newPacket(s.CAST_GROUNDITEM),this.clientStream.putShort(e+this.regionX),this.clientStream.putShort(i+this.regionY),this.clientStream.putShort(r),this.clientStream.putShort(n),this.clientStream.sendPacket(),this.selectedSpell=-1),210===a&&(this.walkToGroundItem(this.localRegionX,this.localRegionY,e,i,!0),this.clientStream.newPacket(s.USEWITH_GROUNDITEM),this.clientStream.putShort(e+this.regionX),this.clientStream.putShort(i+this.regionY),this.clientStream.putShort(r),this.clientStream.putShort(n),this.clientStream.sendPacket(),this.selectedItemInventoryIndex=-1),220===a&&(this.walkToGroundItem(this.localRegionX,this.localRegionY,e,i,!0),this.clientStream.newPacket(s.GROUNDITEM_TAKE),this.clientStream.putShort(e+this.regionX),this.clientStream.putShort(i+this.regionY),this.clientStream.putShort(r),this.clientStream.putShort(n),this.clientStream.sendPacket()),3200===a&&this.showMessage(Be.itemDescription[r],3),300===a&&(this.walkToWallObject(e,i,r),this.clientStream.newPacket(s.CAST_WALLOBJECT),this.clientStream.putShort(e+this.regionX),this.clientStream.putShort(i+this.regionY),this.clientStream.putByte(r),this.clientStream.putShort(n),this.clientStream.sendPacket(),this.selectedSpell=-1),310===a&&(this.walkToWallObject(e,i,r),this.clientStream.newPacket(s.USEWITH_WALLOBJECT),this.clientStream.putShort(e+this.regionX),this.clientStream.putShort(i+this.regionY),this.clientStream.putByte(r),this.clientStream.putShort(n),this.clientStream.sendPacket(),this.selectedItemInventoryIndex=-1),320===a&&(this.walkToWallObject(e,i,r),this.clientStream.newPacket(s.WALL_OBJECT_COMMAND1),this.clientStream.putShort(e+this.regionX),this.clientStream.putShort(i+this.regionY),this.clientStream.putByte(r),this.clientStream.sendPacket()),2300===a&&(this.walkToWallObject(e,i,r),this.clientStream.newPacket(s.WALL_OBJECT_COMMAND2),this.clientStream.putShort(e+this.regionX),this.clientStream.putShort(i+this.regionY),this.clientStream.putByte(r),this.clientStream.sendPacket()),3300===a&&this.showMessage(Be.wallObjectDescription[r],3),400===a&&(this.walkToObject(e,i,r,n),this.clientStream.newPacket(s.CAST_OBJECT),this.clientStream.putShort(e+this.regionX),this.clientStream.putShort(i+this.regionY),this.clientStream.putShort(o),this.clientStream.sendPacket(),this.selectedSpell=-1),410===a&&(this.walkToObject(e,i,r,n),this.clientStream.newPacket(s.USEWITH_OBJECT),this.clientStream.putShort(e+this.regionX),this.clientStream.putShort(i+this.regionY),this.clientStream.putShort(o),this.clientStream.sendPacket(),this.selectedItemInventoryIndex=-1),420===a&&(this.walkToObject(e,i,r,n),this.clientStream.newPacket(s.OBJECT_CMD1),this.clientStream.putShort(e+this.regionX),this.clientStream.putShort(i+this.regionY),this.clientStream.sendPacket()),2400===a&&(this.walkToObject(e,i,r,n),this.clientStream.newPacket(s.OBJECT_CMD2),this.clientStream.putShort(e+this.regionX),this.clientStream.putShort(i+this.regionY),this.clientStream.sendPacket()),3400===a&&this.showMessage(Be.objectDescription[r],3),600===a&&(this.clientStream.newPacket(s.CAST_INVITEM),this.clientStream.putShort(r),this.clientStream.putShort(n),this.clientStream.sendPacket(),this.selectedSpell=-1),610===a&&(this.clientStream.newPacket(s.USEWITH_INVITEM),this.clientStream.putShort(r),this.clientStream.putShort(n),this.clientStream.sendPacket(),this.selectedItemInventoryIndex=-1),620===a&&(this.clientStream.newPacket(s.INV_UNEQUIP),this.clientStream.putShort(r),this.clientStream.sendPacket()),630===a&&(this.clientStream.newPacket(s.INV_WEAR),this.clientStream.putShort(r),this.clientStream.sendPacket()),640===a&&(this.clientStream.newPacket(s.INV_CMD),this.clientStream.putShort(r),this.clientStream.sendPacket()),650===a&&(this.selectedItemInventoryIndex=r,this.showUiTab=0,this.selectedItemName=Be.itemName[this.inventoryItemId[this.selectedItemInventoryIndex]]),660===a&&(this.clientStream.newPacket(s.INV_DROP),this.clientStream.putShort(r),this.clientStream.sendPacket(),this.selectedItemInventoryIndex=-1,this.showUiTab=0,this.showMessage("Dropping "+Be.itemName[this.inventoryItemId[r]],4)),3600===a&&this.showMessage(Be.itemDescription[r],3),700===a){let t=(e-64)/this.tileSize|0,o=(i-64)/this.tileSize|0;this._walkToActionSource_from5(this.localRegionX,this.localRegionY,t,o,!0),this.clientStream.newPacket(s.CAST_NPC),this.clientStream.putShort(r),this.clientStream.putShort(n),this.clientStream.sendPacket(),this.selectedSpell=-1}if(710===a){let t=(e-64)/this.tileSize|0,o=(i-64)/this.tileSize|0;this._walkToActionSource_from5(this.localRegionX,this.localRegionY,t,o,!0),this.clientStream.newPacket(s.USEWITH_NPC),this.clientStream.putShort(r),this.clientStream.putShort(n),this.clientStream.sendPacket(),this.selectedItemInventoryIndex=-1}if(720===a){let t=(e-64)/this.tileSize|0,n=(i-64)/this.tileSize|0;this._walkToActionSource_from5(this.localRegionX,this.localRegionY,t,n,!0),this.clientStream.newPacket(s.NPC_TALK),this.clientStream.putShort(r),this.clientStream.sendPacket()}if(725===a){let t=(e-64)/this.tileSize|0,n=(i-64)/this.tileSize|0;this._walkToActionSource_from5(this.localRegionX,this.localRegionY,t,n,!0),this.clientStream.newPacket(s.NPC_CMD),this.clientStream.putShort(r),this.clientStream.sendPacket()}if(715===a||2715===a){let t=(e-64)/this.tileSize|0,n=(i-64)/this.tileSize|0;this._walkToActionSource_from5(this.localRegionX,this.localRegionY,t,n,!0),this.clientStream.newPacket(s.NPC_ATTACK),this.clientStream.putShort(r),this.clientStream.sendPacket()}if(3700===a&&this.showMessage(Be.npcDescription[r],3),800===a){let t=(e-64)/this.tileSize|0,o=(i-64)/this.tileSize|0;this._walkToActionSource_from5(this.localRegionX,this.localRegionY,t,o,!0),this.clientStream.newPacket(s.CAST_PLAYER),this.clientStream.putShort(r),this.clientStream.putShort(n),this.clientStream.sendPacket(),this.selectedSpell=-1}if(810===a){let t=(e-64)/this.tileSize|0,o=(i-64)/this.tileSize|0;this._walkToActionSource_from5(this.localRegionX,this.localRegionY,t,o,!0),this.clientStream.newPacket(s.USEWITH_PLAYER),this.clientStream.putShort(r),this.clientStream.putShort(n),this.clientStream.sendPacket(),this.selectedItemInventoryIndex=-1}if(805===a||2805===a){let t=(e-64)/this.tileSize|0,n=(i-64)/this.tileSize|0;this._walkToActionSource_from5(this.localRegionX,this.localRegionY,t,n,!0),this.clientStream.newPacket(s.PLAYER_ATTACK),this.clientStream.putShort(r),this.clientStream.sendPacket()}2806===a&&(this.clientStream.newPacket(s.PLAYER_DUEL),this.clientStream.putShort(r),this.clientStream.sendPacket()),2810===a&&(this.clientStream.newPacket(s.PLAYER_TRADE),this.clientStream.putShort(r),this.clientStream.sendPacket()),2820===a&&(this.clientStream.newPacket(s.PLAYER_FOLLOW),this.clientStream.putShort(r),this.clientStream.sendPacket()),900===a&&(this._walkToActionSource_from5(this.localRegionX,this.localRegionY,e,i,!0),this.clientStream.newPacket(s.CAST_GROUND),this.clientStream.putShort(e+this.regionX),this.clientStream.putShort(i+this.regionY),this.clientStream.putShort(r),this.clientStream.sendPacket(),this.selectedSpell=-1),920===a&&(this._walkToActionSource_from5(this.localRegionX,this.localRegionY,e,i,!1),-24===this.mouseClickXStep&&(this.mouseClickXStep=24)),1e3===a&&(this.clientStream.newPacket(s.CAST_SELF),this.clientStream.putShort(r),this.clientStream.sendPacket(),this.selectedSpell=-1),4e3===a&&(this.selectedItemInventoryIndex=-1,this.selectedSpell=-1)}showLoginScreenStatus(t,e){this.welcomeState===hi.NEW_USER&&this.panelLogin[hi.NEW_USER].updateText(this.controlRegisterStatus,t+" "+e),this.welcomeState===hi.EXISTING_USER&&this.panelLogin[hi.EXISTING_USER].updateText(this.controlLoginStatus,t+" "+e),this.drawLoginScreens(),this.unsetFrameTimes()}async lostConnection(){this.systemUpdate=0,0===this.logoutBoxFrames?await super.lostConnection():this.resetLoginVars()}isValidCameraAngle(t){let e=this.localPlayer.currentX>>7,i=this.localPlayer.currentY>>7;for(let s=2;s>0;s--){if(1===t&&(128==(128&this.world.objectAdjacency.get(e,i-s))||128==(128&this.world.objectAdjacency.get(e-s,i))||128==(128&this.world.objectAdjacency.get(e-s,i-s))))return!1;if(3===t&&(128==(128&this.world.objectAdjacency.get(e,i+s))||128==(128&this.world.objectAdjacency.get(e-s,i))||128==(128&this.world.objectAdjacency.get(e-s,i+s))))return!1;if(5===t&&(128==(128&this.world.objectAdjacency.get(e,i+s))||128==(128&this.world.objectAdjacency.get(e+s,i))||128==(128&this.world.objectAdjacency.get(e+s,i+s))))return!1;if(7===t&&(128==(128&this.world.objectAdjacency.get(e,i-s))||128==(128&this.world.objectAdjacency.get(e+s,i))||128==(128&this.world.objectAdjacency.get(e+s,i-s))))return!1;if(0===t&&128==(128&this.world.objectAdjacency.get(e,i-s)))return!1;if(2===t&&128==(128&this.world.objectAdjacency.get(e-s,i)))return!1;if(4===t&&128==(128&this.world.objectAdjacency.get(e,i+s)))return!1;if(6===t&&128==(128&this.world.objectAdjacency.get(e+s,i)))return!1}return!0}resetGameState(){this.gameState=oi.LOGIN,this.welcomeState=hi.WELCOME,this.loginUser=Ci("username"),this.loginPass||(this.loginPass=""),this.playerCount=0,this.npcCount=0}handleIncomingPacket(t,i,r){try{if(t===kt.REGION_PLAYERS){this.knownPlayerCount=this.playerCount,this.playerCount=0;for(let i=0;i<this.knownPlayerCount;i++)this.knownPlayers[i]=this.players[i];let t=8;this.localRegionX=ni.getBitMask(r,t,11),t+=11,this.localRegionY=ni.getBitMask(r,t,13),t+=13;let e=ni.getBitMask(r,t,4);t+=4;let n=this.loadNextRegion(this.localRegionX,this.localRegionY);this.localRegionX-=this.regionX,this.localRegionY-=this.regionY;let o=this.localRegionX*this.tileSize+this.tileSize/2,a=this.localRegionY*this.tileSize+this.tileSize/2;n&&(this.localPlayer.waypointCurrent=0,this.localPlayer.movingStep=0,this.localPlayer.currentX=this.localPlayer.waypointsX[0]=o,this.localPlayer.currentY=this.localPlayer.waypointsY[0]=a),this.localPlayer=this.createPlayer(this.localPlayerServerIndex,o,a,e);let h=ni.getBitMask(r,t,8);t+=8;for(let i=0;i<h;i++){let e=this.knownPlayers[i+1],s=0!==ni.getBitMask(r,t,1);if(t+=1,s){let i=0===ni.getBitMask(r,t,1);if(t+=1,i){let i=ni.getBitMask(r,t,3);t+=3;let s=e.waypointCurrent,n=e.waypointsX[s],o=e.waypointsY[s];for(let t=0;t<4;t++){let e=t<2?this.tileSize:-this.tileSize;for(let s=0;s<3;s++)i===(2*t+(s+1))%8&&(t%2==0?n+=e:o+=e)}e.animationNext=i,e.waypointCurrent=s=(s+1)%10,e.waypointsX[s]=n,e.waypointsY[s]=o}else{let i=ni.getBitMask(r,t,2);if(t+=2,3===i)continue;e.animationNext=i<<2|ni.getBitMask(r,t,2),t+=2}}this.players[this.playerCount++]=e}let l=0;for(;t+24<8*i;){let e=ni.getBitMask(r,t,11);t+=11;let i=ni.getBitMask(r,t,5);t+=5;let s=ni.getBitMask(r,t,5);t+=5,i>15&&(i-=32),s>15&&(s-=32);let n=ni.getBitMask(r,t,4);t+=4;let o=(this.localRegionX+i)*this.tileSize+64,a=(this.localRegionY+s)*this.tileSize+64;this.createPlayer(e,o,a,n);let h=0===ni.getBitMask(r,t,1);t++,h&&(this.playerServerIndexes[l++]=e)}if(l>0){this.clientStream.newPacket(s.KNOWN_PLAYERS),this.clientStream.putShort(l);for(let t=0;t<l;t++){let e=this.playerServer[this.playerServerIndexes[t]];this.clientStream.putShort(e.serverIndex),this.clientStream.putShort(e.serverId)}this.clientStream.sendPacket()}return}if(t===kt.REGION_GROUND_ITEMS){for(let t=1;t<i;)if(255===ni.getUnsignedByte(r[t])){let e=this.localRegionX+r[t+1]>>3,i=this.localRegionY+r[t+2]>>3;t+=3;let s=0;for(let t=0;t<this.groundItemCount;t++){let r=(this.groundItemX[t]>>3)-e,n=(this.groundItemY[t]>>3)-i;0===r&&0===n||(s!==t&&(this.groundItemX[s]=this.groundItemX[t],this.groundItemY[s]=this.groundItemY[t],this.groundItemId[s]=this.groundItemId[t],this.groundItemZ[s]=this.groundItemZ[t]),s++)}this.groundItemCount=s}else{let e=ni.getUnsignedShort(r,t);t+=2;let i=this.localRegionX+r[t++],s=this.localRegionY+r[t++];if(0==(32768&e)){this.groundItemX[this.groundItemCount]=i,this.groundItemY[this.groundItemCount]=s,this.groundItemId[this.groundItemCount]=e,this.groundItemZ[this.groundItemCount]=0;for(let t=0;t<this.objectCount;t++)if(this.objectX[t]===i&&this.objectY[t]===s){this.groundItemZ[this.groundItemCount]=Be.objectElevation[this.objectId[t]];break}this.groundItemCount++}else{e&=32767;let t=0;for(let r=0;r<this.groundItemCount;r++)this.groundItemX[r]!==i||this.groundItemY[r]!==s||this.groundItemId[r]!==e?(this.groundItemX[t]=this.groundItemX[r],this.groundItemY[t]=this.groundItemY[r],this.groundItemId[t]=this.groundItemId[r],this.groundItemZ[t]=this.groundItemZ[r],t++):e=-123;this.groundItemCount=t}}return}if(t===kt.REGION_OBJECTS){for(let t=1;t<i;)if(255===ni.getUnsignedByte(r[t])){let e=this.localRegionX+r[t+1]>>3,i=this.localRegionY+r[t+2]>>3;t+=3;let s=0;for(let t=0;t<this.objectCount;t++){let r=(this.objectX[t]>>3)-e,n=(this.objectY[t]>>3)-i;0===r&&0===n?(this.scene.removeModel(this.objectModel[t]),this.world.removeObject(this.objectX[t],this.objectY[t],this.objectId[t])):(t!==s&&(this.objectModel[s]=this.objectModel[t],this.objectModel[s].key=s,this.objectX[s]=this.objectX[t],this.objectY[s]=this.objectY[t],this.objectId[s]=this.objectId[t],this.objectDirection[s]=this.objectDirection[t]),s++)}this.objectCount=s}else{let e=ni.getUnsignedShort(r,t);t+=2;let i=this.localRegionX+r[t++],s=this.localRegionY+r[t++],n=0;for(let t=0;t<this.objectCount;t++)this.objectX[t]!==i||this.objectY[t]!==s?(t!==n&&(this.objectModel[n]=this.objectModel[t],this.objectModel[n].key=n,this.objectX[n]=this.objectX[t],this.objectY[n]=this.objectY[t],this.objectId[n]=this.objectId[t],this.objectDirection[n]=this.objectDirection[t]),n++):(this.scene.removeModel(this.objectModel[t]),this.world.removeObject(this.objectX[t],this.objectY[t],this.objectId[t]));if(this.objectCount=n,6e4!==e){let t=this.world.getTileDirection(i,s),r=0,n=0;0===t||4===t?(r=Be.objectWidth[e],n=Be.objectHeight[e]):(n=Be.objectWidth[e],r=Be.objectHeight[e]);let o=(i+i+r)*this.tileSize>>1,a=(s+s+n)*this.tileSize>>1,h=Be.objectModelIndex[e],l=this.gameModels[h].copy();this.scene.addModel(l),l.key=this.objectCount,l.rotate(0,32*t,0),l.translate(o,-this.world.getElevation(o,a),a),l.createGouraudLightSource(!0,48,48,-50,-10,-50),this.world.removeObject2(i,s,e),74===e&&l.translate(0,-480,0),this.objectX[this.objectCount]=i,this.objectY[this.objectCount]=s,this.objectId[this.objectCount]=e,this.objectDirection[this.objectCount]=t,this.objectModel[this.objectCount++]=l}}return}if(t===kt.INVENTORY_ITEMS){let t=1;this.inventoryItemsCount=255&r[t++];for(let e=0;e<this.inventoryItemsCount;e++){let i=ni.getUnsignedShort(r,t);t+=2,this.inventoryItemId[e]=32767&i,this.inventoryEquipped[e]=i>>15,0===Be.itemStackable[this.inventoryItemId[e]]?(this.inventoryItemStackCount[e]=ni.getSmart08_32(r,t),this.inventoryItemStackCount[e]>=128?t+=4:t++):this.inventoryItemStackCount[e]=1}return}if(t===kt.REGION_PLAYER_UPDATE){let t=ni.getUnsignedShort(r,1),e=3;for(let i=0;i<t;i++){let t=ni.getUnsignedShort(r,e);e+=2;let i=this.playerServer[t],s=r[e];if(e++,0===s){let t=ni.getUnsignedShort(r,e);e+=2,null!==i&&(i.bubbleTimeout=150,i.bubbleItem=t)}else if(1===s){let t=r[e];if(e++,null!==i){let s=li(si(r.slice(e,e+t))),n=!1;for(let t=0;t<this.ignoreListCount;t++)if(this.ignoreList[t]===i.hash){n=!0;break}n||(i.messageTimeout=150,i.message=s,this.showMessage(i.name+": "+i.message,2))}e+=t}else if(2===s){let t=ni.getUnsignedByte(r[e]);e++;let s=ni.getUnsignedByte(r[e]);e++;let n=ni.getUnsignedByte(r[e]);e++,null!==i&&(i.damageTaken=t,i.healthCurrent=s,i.healthMax=n,i.combatTimer=200,i===this.localPlayer&&(this.playerStatCurrent[3]=s,this.playerStatBase[3]=n,this.showDialogWelcome=!1,this.showDialogServermessage=!1))}else if(3===s){let t=ni.getUnsignedShort(r,e);e+=2;let s=ni.getUnsignedShort(r,e);e+=2,null!==i&&(i.incomingProjectileSprite=t,i.attackingNpcServerIndex=s,i.attackingPlayerServerIndex=-1,i.projectileRange=this.projectileFactor)}else if(4===s){let t=ni.getUnsignedShort(r,e);e+=2;let s=ni.getUnsignedShort(r,e);e+=2,null!==i&&(i.incomingProjectileSprite=t,i.attackingPlayerServerIndex=s,i.attackingNpcServerIndex=-1,i.projectileRange=this.projectileFactor)}else if(5===s)if(null!==i){i.serverId=ni.getUnsignedShort(r,e),e+=2,i.hash=ni.getUnsignedLong(r,e),e+=8,i.name=ni.hashToUsername(i.hash);let t=ni.getUnsignedByte(r[e]);e++;for(let s=0;s<12;s++)i.equippedItem[s]=s<t?ni.getUnsignedByte(r[e]):0,e++;i.colourHair=255&r[e++],i.colourTop=255&r[e++],i.colourBottom=255&r[e++],i.colourSkin=255&r[e++],i.level=255&r[e++],i.skullVisible=255&r[e++]}else e+=10,e+=ni.getUnsignedByte(r[e])+1;else if(6===s){let t=255&r[e++],s=si(r.slice(e,e+t));e+=t,null!==i&&(i.messageTimeout=150,i.message=s,i===this.localPlayer&&this.showMessage(i.name+": "+i.message,5))}}return}if(t===kt.REGION_WALL_OBJECTS){for(let t=1;t<i;)if(255===ni.getUnsignedByte(r[t])){let e=0,i=this.localRegionX+r[t+1]>>3,s=this.localRegionY+r[t+2]>>3;t+=3;for(let t=0;t<this.wallObjectCount;t++){let r=(this.wallObjectX[t]>>3)-i,n=(this.wallObjectY[t]>>3)-s;0!==r||0!==n?(t!==e&&(this.wallObjectModel[e]=this.wallObjectModel[t],this.wallObjectModel[e].key=e+1e4,this.wallObjectX[e]=this.wallObjectX[t],this.wallObjectY[e]=this.wallObjectY[t],this.wallObjectDirection[e]=this.wallObjectDirection[t],this.wallObjectId[e]=this.wallObjectId[t]),e++):(this.scene.removeModel(this.wallObjectModel[t]),this.world.removeWallObject(this.wallObjectX[t],this.wallObjectY[t],this.wallObjectDirection[t],this.wallObjectId[t]))}this.wallObjectCount=e}else{let e=ni.getUnsignedShort(r,t);t+=2;let i=this.localRegionX+r[t++],s=this.localRegionY+r[t++],n=r[t++],o=0;for(let t=0;t<this.wallObjectCount;t++)this.wallObjectX[t]!==i||this.wallObjectY[t]!==s||this.wallObjectDirection[t]!==n?(t!==o&&(this.wallObjectModel[o]=this.wallObjectModel[t],this.wallObjectModel[o].key=o+1e4,this.wallObjectX[o]=this.wallObjectX[t],this.wallObjectY[o]=this.wallObjectY[t],this.wallObjectDirection[o]=this.wallObjectDirection[t],this.wallObjectId[o]=this.wallObjectId[t]),o++):(this.scene.removeModel(this.wallObjectModel[t]),this.world.removeWallObject(this.wallObjectX[t],this.wallObjectY[t],this.wallObjectDirection[t],this.wallObjectId[t]));this.wallObjectCount=o,65535!==e&&(this.world._setObjectAdjacency_from4(i,s,n,e),this.wallObjectModel[this.wallObjectCount]=this.createBoundaryModel(i,s,n,e,this.wallObjectCount),this.wallObjectX[this.wallObjectCount]=i,this.wallObjectY[this.wallObjectCount]=s,this.wallObjectId[this.wallObjectCount]=e,this.wallObjectDirection[this.wallObjectCount++]=n)}return}if(t===kt.REGION_NPCS){this.npcCacheCount=this.npcCount,this.npcCount=0;for(let i=0;i<this.npcCacheCount;i++)this.npcsCache[i]=this.npcs[i];let t=8,e=ni.getBitMask(r,t,8);t+=8;for(let i=0;i<e;i++){let e=this.npcsCache[i],s=ni.getBitMask(r,t,1);if(t++,0!==s){let i=ni.getBitMask(r,t,1);if(t++,0===i){let i=ni.getBitMask(r,t,3);t+=3;let s=e.waypointCurrent,n=e.waypointsX[s],o=e.waypointsY[s];2!==i&&1!==i&&3!==i||(n+=this.tileSize),6!==i&&5!==i&&7!==i||(n-=this.tileSize),4!==i&&3!==i&&5!==i||(o+=this.tileSize),0!==i&&1!==i&&7!==i||(o-=this.tileSize),e.animationNext=i,e.waypointCurrent=s=(s+1)%10,e.waypointsX[s]=n,e.waypointsY[s]=o}else{if(12==(12&ni.getBitMask(r,t,4))){t+=2;continue}e.animationNext=ni.getBitMask(r,t,4),t+=4}}this.npcs[this.npcCount++]=e}for(;t+34<8*i;){let e=ni.getBitMask(r,t,12);t+=12;let i=ni.getBitMask(r,t,5);t+=5,i>15&&(i-=32);let s=ni.getBitMask(r,t,5);t+=5,s>15&&(s-=32);let n=ni.getBitMask(r,t,4);t+=4;let o=(this.localRegionX+i)*this.tileSize+64,a=(this.localRegionY+s)*this.tileSize+64,h=ni.getBitMask(r,t,10);t+=10,h>=Be.npcCount&&(h=24),this.addNpc(e,o,a,n,h)}return}if(t===kt.REGION_NPC_UPDATE){let t=3;for(let e=0;e<ni.getUnsignedShort(r,1);e++){let e=ni.getUnsignedShort(r,t);t+=2;let i=this.npcsServer[e],s=ni.getUnsignedByte(r[t]);if(t++,1===s){let e=ni.getUnsignedShort(r,t),s=r[t+=2];t++;let n=si(r.slice(t,t+s));t+=s,null!==i&&(i.message=n,i.messageTimeout=150,e===this.localPlayer.serverIndex&&this.showMessage("@yel@"+Be.npcName[i.npcId]+": "+i.message,5))}else if(2===s){let e=ni.getUnsignedByte(r[t]);t++;let s=ni.getUnsignedByte(r[t]);t++;let n=ni.getUnsignedByte(r[t]);t++,null!==i&&(i.damageTaken=e,i.healthCurrent=s,i.healthMax=n,i.combatTimer=200)}}return}if(t===kt.OPTION_LIST){this.showOptionMenu=!0;let t=ni.getUnsignedByte(r[1]);this.optionMenuCount=t;let e=2;for(let i=0;i<t;i++){let t=ni.getUnsignedByte(r[e]);e++,this.optionMenuEntry[i]=Ii(r.slice(e,e+t)),e+=t}return}if(t===kt.OPTION_LIST_CLOSE)return void(this.showOptionMenu=!1);if(t===kt.WORLD_INFO)return this.loadingArea=!0,this.localPlayerServerIndex=ni.getUnsignedShort(r,1),this.planeWidth=ni.getUnsignedShort(r,3),this.planeHeight=ni.getUnsignedShort(r,5),this.planeIndex=ni.getUnsignedShort(r,7),this.planeMultiplier=ni.getUnsignedShort(r,9),void(this.planeHeight-=this.planeIndex*this.planeMultiplier);if(t===kt.PLAYER_STAT_LIST){let t=1;for(let e=0;e<this.playerStatCount;e++)this.playerStatCurrent[e]=ni.getUnsignedByte(r[t++]);for(let e=0;e<this.playerStatCount;e++)this.playerStatBase[e]=ni.getUnsignedByte(r[t++]);for(let e=0;e<this.playerStatCount;e++)this.playerExperience[e]=ni.getUnsignedInt(r,t),t+=4;return void(this.playerQuestPoints=ni.getUnsignedByte(r[t++]))}if(t===kt.PLAYER_STAT_EQUIPMENT_BONUS){for(let t=0;t<this.playerStatEquipmentCount;t++)this.playerStatEquipment[t]=ni.getUnsignedByte(r[1+t]);return}if(t===kt.PLAYER_DIED)return void(this.deathScreenTimeout=250);if(t===kt.REGION_ENTITY_UPDATE){let t=(i-1)/4|0;for(let e=0;e<t;e++){let t=this.localRegionX+ni.getSignedShort(r,1+4*e)>>3,i=this.localRegionY+ni.getSignedShort(r,3+4*e)>>3,s=0;for(let e=0;e<this.groundItemCount;e++){let r=(this.groundItemX[e]>>3)-t,n=(this.groundItemY[e]>>3)-i;0===r&&0===n||(e!==s&&(this.groundItemX[s]=this.groundItemX[e],this.groundItemY[s]=this.groundItemY[e],this.groundItemId[s]=this.groundItemId[e],this.groundItemZ[s]=this.groundItemZ[e]),s++)}this.groundItemCount=s,s=0;for(let e=0;e<this.objectCount;e++){let r=(this.objectX[e]>>3)-t,n=(this.objectY[e]>>3)-i;0!==r||0!==n?(e!==s&&(this.objectModel[s]=this.objectModel[e],this.objectModel[s].key=s,this.objectX[s]=this.objectX[e],this.objectY[s]=this.objectY[e],this.objectId[s]=this.objectId[e],this.objectDirection[s]=this.objectDirection[e]),s++):(this.scene.removeModel(this.objectModel[e]),this.world.removeObject(this.objectX[e],this.objectY[e],this.objectId[e]))}this.objectCount=s,s=0;for(let e=0;e<this.wallObjectCount;e++){let r=(this.wallObjectX[e]>>3)-t,n=(this.wallObjectY[e]>>3)-i;0!==r||0!==n?(e!==s&&(this.wallObjectModel[s]=this.wallObjectModel[e],this.wallObjectModel[s].key=s+1e4,this.wallObjectX[s]=this.wallObjectX[e],this.wallObjectY[s]=this.wallObjectY[e],this.wallObjectDirection[s]=this.wallObjectDirection[e],this.wallObjectId[s]=this.wallObjectId[e]),s++):(this.scene.removeModel(this.wallObjectModel[e]),this.world.removeWallObject(this.wallObjectX[e],this.wallObjectY[e],this.wallObjectDirection[e],this.wallObjectId[e]))}this.wallObjectCount=s}return}if(t===kt.APPEARANCE)return void(this.showAppearanceChange=!0);if(t===kt.TRADE_OPEN){let t=ni.getUnsignedShort(r,1);return null!==this.playerServer[t]&&(this.tradeRecipientName=this.playerServer[t].name),this.showDialogTrade=!0,this.tradeRecipientAccepted=!1,this.tradeAccepted=!1,this.tradeItemsCount=0,void(this.tradeRecipientItemsCount=0)}if(t===kt.TRADE_CLOSE)return this.showDialogTrade=!1,void(this.showDialogTradeConfirm=!1);if(t===kt.TRADE_ITEMS){this.tradeRecipientItemsCount=255&r[1];let t=2;for(let e=0;e<this.tradeRecipientItemsCount;e++)this.tradeRecipientItems[e]=ni.getUnsignedShort(r,t),t+=2,this.tradeRecipientItemCount[e]=ni.getUnsignedInt(r,t),t+=4;return this.tradeRecipientAccepted=!1,void(this.tradeAccepted=!1)}if(t===kt.TRADE_RECIPIENT_STATUS)return void(this.tradeRecipientAccepted=1===r[1]);if(t===kt.SHOP_OPEN){this.showDialogShop=!0;let t=1,e=255&r[t++],i=r[t++];this.shopSellPriceMod=255&r[t++],this.shopBuyPriceMod=255&r[t++];for(let s=0;s<40;s++)this.shopItem[s]=-1;for(let s=0;s<e;s++)this.shopItem[s]=ni.getUnsignedShort(r,t),t+=2,this.shopItemCount[s]=ni.getUnsignedShort(r,t),t+=2,this.shopItemPrice[s]=r[t++];if(1===i){let t=39;for(let i=0;i<this.inventoryItemsCount&&!(t<e);i++){let e=!1;for(let t=0;t<40;t++)if(this.shopItem[t]===this.inventoryItemId[i]){e=!0;break}10===this.inventoryItemId[i]&&(e=!0),e||(this.shopItem[t]=32767&this.inventoryItemId[i],this.shopItemCount[t]=0,this.shopItemPrice[t]=0,t--)}}return void(this.shopSelectedItemIndex>=0&&this.shopSelectedItemIndex<40&&this.shopItem[this.shopSelectedItemIndex]!==this.shopSelectedItemType&&(this.shopSelectedItemIndex=-1,this.shopSelectedItemType=-2))}if(t===kt.SHOP_CLOSE)return void(this.showDialogShop=!1);if(t===kt.TRADE_STATUS)return 1===r[1]?void(this.tradeAccepted=!0):void(this.tradeAccepted=!1);if(t===kt.GAME_SETTINGS)return this.optionCameraModeAuto=1===ni.getUnsignedByte(r[1]),this.optionMouseButtonOne=1===ni.getUnsignedByte(r[2]),void(this.optionSoundDisabled=1===ni.getUnsignedByte(r[3]));if(t===kt.PRAYER_STATUS){for(let t=0;t<i-1;t++)this.prayerOn[t]-ni.getUnsignedByte(r[t+1])!=0&&(this.playSoundFile((this.prayerOn[t],"ff")),this.prayerOn[t]=!this.prayerOn[t]);return}if(t===kt.PLAYER_QUEST_LIST)for(let t=0;t<this.questCount;t++)this.questComplete[t]=1===r[t+1];if(t===kt.BANK_OPEN){this.showDialogBank=!0;let t=1;this.newBankItemCount=255&r[t++],this.bankItemsMax=255&r[t++];for(let e=0;e<this.newBankItemCount;e++)this.newBankItems[e]=ni.getUnsignedShort(r,t),t+=2,this.newBankItemsCount[e]=ni.getSmart08_32(r,t),this.newBankItemsCount[e]>=128?t+=4:t++;return void this.updateBankItems()}if(t===kt.BANK_CLOSE)return void(this.showDialogBank=!1);if(t===kt.PLAYER_STAT_EXPERIENCE_UPDATE){let t=ni.getUnsignedByte(r[1]);return void(this.playerExperience[t]=ni.getUnsignedInt(r,2))}if(t===kt.DUEL_OPEN){let t=ni.getUnsignedShort(r,1);return null!==this.playerServer[t]&&(this.duelOpponentName=this.playerServer[t].name),this.showDialogDuel=!0,this.duelOfferItemCount=0,this.duelOfferOpponentItemCount=0,this.duelOfferOpponentAccepted=!1,this.duelOfferAccepted=!1,this.duelSettingsRetreat=!1,this.duelSettingsMagic=!1,this.duelSettingsPrayer=!1,void(this.duelSettingsWeapons=!1)}if(t===kt.DUEL_CLOSE)return this.showDialogDuel=!1,void(this.showDialogDuelConfirm=!1);if(t===kt.TRADE_CONFIRM_OPEN){this.showDialogTradeConfirm=!0,this.tradeConfirmAccepted=!1,this.showDialogTrade=!1;let t=1;this.tradeRecipientConfirmHash=ni.getUnsignedLong(r,t),t+=8,this.tradeRecipientConfirmItemsCount=ni.getUnsignedByte(r[t++]);for(let e=0;e<this.tradeRecipientConfirmItemsCount;e++)this.tradeRecipientConfirmItems[e]=ni.getUnsignedShort(r,t),t+=2,this.tradeRecipientConfirmItemCount[e]=ni.getUnsignedInt(r,t),t+=4;this.tradeConfirmItemsCount=ni.getUnsignedByte(r[t++]);for(let e=0;e<this.tradeConfirmItemsCount;e++)this.tradeConfirmItems[e]=ni.getUnsignedShort(r,t),t+=2,this.tradeConfirmItemCount[e]=ni.getUnsignedInt(r,t),t+=4;return}if(t===kt.DUEL_UPDATE){this.duelOfferOpponentItemCount=ni.getUnsignedByte(r[1]);let t=2;for(let e=0;e<this.duelOfferOpponentItemCount;e++)this.duelOfferOpponentItemId[e]=ni.getUnsignedShort(r,t),t+=2,this.duelOfferOpponentItemStack[e]=ni.getUnsignedInt(r,t),t+=4;return this.duelOfferOpponentAccepted=!1,void(this.duelOfferAccepted=!1)}if(t===kt.DUEL_SETTINGS)return 1===r[1]?this.duelSettingsRetreat=!0:this.duelSettingsRetreat=!1,1===r[2]?this.duelSettingsMagic=!0:this.duelSettingsMagic=!1,1===r[3]?this.duelSettingsPrayer=!0:this.duelSettingsPrayer=!1,1===r[4]?this.duelSettingsWeapons=!0:this.duelSettingsWeapons=!1,this.duelOfferOpponentAccepted=!1,void(this.duelOfferAccepted=!1);if(t===kt.BANK_UPDATE){let t=1,e=255&r[t++],i=ni.getUnsignedShort(r,t);t+=2;let s=ni.getSmart08_32(r,t);if(s>=128?t+=4:t++,0===s){this.newBankItemCount--;for(let t=e;t<this.newBankItemCount;t++)this.newBankItems[t]=this.newBankItems[t+1],this.newBankItemsCount[t]=this.newBankItemsCount[t+1]}else this.newBankItems[e]=i,this.newBankItemsCount[e]=s,e>=this.newBankItemCount&&(this.newBankItemCount=e+1);return void this.updateBankItems()}if(t===kt.INVENTORY_ITEM_UPDATE){let t=1,e=1,i=ni.getUnsignedByte(r[t++]),s=ni.getUnsignedShort(r,t);return t+=2,0===Be.itemStackable[32767&s]&&((e=ni.getSmart08_32(r,t))>=128?t+=4:t++),this.inventoryItemId[i]=32767&s,this.inventoryEquipped[i]=s/32768|0,this.inventoryItemStackCount[i]=e,void(i>=this.inventoryItemsCount&&(this.inventoryItemsCount=i+1))}if(t===kt.INVENTORY_ITEM_REMOVE){let t=255&r[1];this.inventoryItemsCount--;for(let e=t;e<this.inventoryItemsCount;e++)this.inventoryItemId[e]=this.inventoryItemId[e+1],this.inventoryItemStackCount[e]=this.inventoryItemStackCount[e+1],this.inventoryEquipped[e]=this.inventoryEquipped[e+1];return}if(t===kt.PLAYER_STAT_UPDATE){let t=1,e=255&r[t++];return this.playerStatCurrent[e]=ni.getUnsignedByte(r[t++]),this.playerStatBase[e]=ni.getUnsignedByte(r[t++]),this.playerExperience[e]=ni.getUnsignedInt(r,t),void(t+=4)}if(t===kt.DUEL_OPPONENT_ACCEPTED)return 1===r[1]?void(this.duelOfferOpponentAccepted=!0):void(this.duelOfferOpponentAccepted=!1);if(t===kt.DUEL_ACCEPTED)return 1===r[1]?void(this.duelOfferAccepted=!0):void(this.duelOfferAccepted=!1);if(t===kt.DUEL_CONFIRM_OPEN){this.showDialogDuelConfirm=!0,this.duelAccepted=!1,this.showDialogDuel=!1;let t=1;this.duelOpponentNameHash=ni.getUnsignedLong(r,t),t+=8,this.duelOpponentItemsCount=255&r[t++];for(let e=0;e<this.duelOpponentItemsCount;e++)this.duelOpponentItems[e]=ni.getUnsignedShort(r,t),t+=2,this.duelOpponentItemCount[e]=ni.getUnsignedInt(r,t),t+=4;this.duelItemsCount=255&r[t++];for(let e=0;e<this.duelItemsCount;e++)this.duelItems[e]=ni.getUnsignedShort(r,t),t+=2,this.duelItemCount[e]=ni.getUnsignedInt(r,t),t+=4;return this.duelOptionRetreat=255&r[t++],this.duelOptionMagic=255&r[t++],this.duelOptionPrayer=255&r[t++],void(this.duelOptionWeapons=255&r[t++])}if(t===kt.SOUND){let t=Ii(r.slice(1,i));return void this.playSoundFile(t)}if(t===kt.TELEPORT_BUBBLE){if(this.teleportBubbleCount<50){let t=255&r[1],e=r[2]+this.localRegionX,i=r[3]+this.localRegionY;this.teleportBubbleType[this.teleportBubbleCount]=t,this.teleportBubbleTime[this.teleportBubbleCount]=0,this.teleportBubbleX[this.teleportBubbleCount]=e,this.teleportBubbleY[this.teleportBubbleCount]=i,this.teleportBubbleCount++}return}if(t===kt.WELCOME)return void(this.welcomScreenAlreadyShown||(this.welcomeLastLoggedInIP=ni.getUnsignedInt(r,1),this.welcomeLastLoggedInDays=ni.getUnsignedShort(r,5),this.welcomeRecoverySetDays=ni.getUnsignedByte(r[7]),this.welcomeUnreadMessages=ni.getUnsignedShort(r,8),this.showDialogWelcome=!0,this.welcomScreenAlreadyShown=!0,this.welcomeLastLoggedInHost=null));if(t===kt.SERVER_MESSAGE)return this.serverMessage=Ii(r.slice(1,i)),this.showDialogServermessage=!0,void(this.serverMessageBoxTop=!1);if(t===kt.SERVER_MESSAGE_ONTOP)return this.serverMessage=Ii(r.slice(1,i)),this.showDialogServermessage=!0,void(this.serverMessageBoxTop=!0);if(t===kt.PLAYER_STAT_FATIGUE)return void(this.statFatigue=ni.getUnsignedShort(r,1));if(t===kt.SLEEP_OPEN)return this.isSleeping||(this.fatigueSleeping=this.statFatigue),this.isSleeping=!0,this.inputTextCurrent="",this.inputTextFinal="",this.surface.readSleepWord(this.spriteTexture+1,r),void(this.sleepingStatusText=null);if(t===kt.PLAYER_STAT_FATIGUE_ASLEEP)return void(this.fatigueSleeping=ni.getUnsignedShort(r,1));if(t===kt.SLEEP_CLOSE)return void(this.isSleeping=!1);if(t===kt.SLEEP_INCORRECT)return void(this.sleepingStatusText="Incorrect - Please wait...");if(t===kt.SYSTEM_UPDATE)return void(this.systemUpdate=32*ni.getUnsignedShort(r,1));console.log("unhandled packet: "+t,",\tsize:",i)}catch(e){if(console.error(e),this.packetErrorCount<3){let o=e.stack,a=o.length;this.clientStream.newPacket(s.PACKET_EXCEPTION),this.clientStream.putShort(a),this.clientStream.putString(o),this.clientStream.putShort(a=(o="p-type: "+t+", p-size:"+i).length),this.clientStream.putString(o),this.clientStream.putShort(a=(o="rx:"+this.localRegionX+" ry:"+this.localRegionY+" num3l:"+this.objectCount).length),this.clientStream.putString(o),o="";for(let t=0;t<80&&t<i;t++)o=o+r[t]+" ";this.clientStream.putShort(o.length),this.clientStream.putString(o),this.clientStream.sendPacket(),this.packetErrorCount++}this.clientStream.closeStream(),this.resetLoginVars()}}drawUiTabPlayerInfo(t){let e=this.surface.width2-199;this.surface.drawSpriteID(e-49,3,this.spriteMedia+3);let i=0,s=i=gt.rgbToLong(160,160,160);if(0===this.uiTabPlayerInfoSubTab?s=gt.rgbToLong(220,220,220):i=gt.rgbToLong(220,220,220),this.surface.drawBoxAlpha(e,36,98,24,s,128),this.surface.drawBoxAlpha(e+98,36,98,24,i,128),this.surface.drawBoxAlpha(e,60,196,251,gt.rgbToLong(220,220,220),128),this.surface.drawLineHoriz(e,60,196,0),this.surface.drawLineVert(e+98,36,24,0),this.surface.drawStringCenter("Stats",e+49,52,4,0),this.surface.drawStringCenter("Quests",e+49+98,52,4,0),0===this.uiTabPlayerInfoSubTab){let t=72,i=-1;this.surface.drawString("Skills",e+5,t,3,16776960),t+=13;for(let s=0;s<9;s++){let r=16777215;this.mouseX>e+3&&this.mouseY>=t-11&&this.mouseY<t+2&&this.mouseX<e+90&&(r=16711680,i=s),this.surface.drawString(this.skillNameShort[s]+":@yel@"+this.playerStatCurrent[s]+"/"+this.playerStatBase[s],e+5,t,1,r),r=16777215,this.mouseX>=e+90&&this.mouseY>=t-13-11&&this.mouseY<t-13+2&&this.mouseX<e+196&&(r=16711680,i=s+9),this.surface.drawString(this.skillNameShort[s+9]+":@yel@"+this.playerStatCurrent[s+9]+"/"+this.playerStatBase[s+9],e+98-5,t-13,1,r),t+=13}this.surface.drawString("Quest Points:@yel@"+this.playerQuestPoints,e+98-5,t-13,1,16777215),t+=12,this.surface.drawString("Fatigue: @yel@"+(100*this.statFatigue/750|0)+"%",e+5,t-13,1,16777215),t+=8,this.surface.drawString("Equipment Status",e+5,t,3,16776960),t+=12;for(let s=0;s<3;s++)this.surface.drawString(this.equipmentStatNames[s]+":@yel@"+this.playerStatEquipment[s],e+5,t,1,16777215),s<2&&this.surface.drawString(this.equipmentStatNames[s+3]+":@yel@"+this.playerStatEquipment[s+3],e+98+25,t,1,16777215),t+=13;if(t+=6,this.surface.drawLineHoriz(e,t-15,196,0),-1!==i){this.surface.drawString(this.skillNamesLong[i]+" skill",e+5,t,1,16776960),t+=12;let s=this.experienceArray[0];for(let t=0;t<98;t++)this.playerExperience[i]>=this.experienceArray[t]&&(s=this.experienceArray[t+1]);this.surface.drawString("Total xp: "+(this.playerExperience[i]/4|0),e+5,t,1,16777215),t+=12,this.surface.drawString("Next level at: "+(s/4|0),e+5,t,1,16777215)}else{this.surface.drawString("Overall levels",e+5,t,1,16776960),t+=12;let i=0;for(let t=0;t<this.playerStatCount;t++)i+=this.playerStatBase[t];this.surface.drawString("Skill total: "+i,e+5,t,1,16777215),t+=12,this.surface.drawString("Combat level: "+this.localPlayer.level,e+5,t,1,16777215),t+=12}}else if(1===this.uiTabPlayerInfoSubTab){this.panelQuestList.clearList(this.controlListQuest),this.panelQuestList.addListEntry(this.controlListQuest,0,"@whi@Quest-list (green=completed)");for(let t=0;t<this.questCount;t++)this.panelQuestList.addListEntry(this.controlListQuest,t+1,(this.questComplete[t]?"@gre@":"@red@")+this.questName[t]);this.panelQuestList.render()}if(!t)return;let r=this.mouseX-(this.surface.width2-199),n=this.mouseY-36;if(r>=0&&n>=0&&r<196&&n<275&&(1===this.uiTabPlayerInfoSubTab&&this.panelQuestList.handleMouse(r+(this.surface.width2-199),n+36,this.lastMouseButtonDown,this.mouseButtonDown,this.mouseScrollDelta),n<=24&&1===this.mouseButtonClick)){if(r<98)return void(this.uiTabPlayerInfoSubTab=0);r>98&&(this.uiTabPlayerInfoSubTab=1)}}createRightClickMenu(){let t=2203-(this.localRegionY+this.planeHeight+this.regionY);this.localRegionX+this.planeWidth+this.regionX>=2640&&(t=-50);let e=-1;for(let n=0;n<this.objectCount;n++)this.objectAlreadyInMenu[n]=!1;for(let n=0;n<this.wallObjectCount;n++)this.wallObjectAlreadyInMenu[n]=!1;let i=this.scene.getMousePickedCount(),s=this.scene.getMousePickedModels(),r=this.scene.getMousePickedFaces();for(let n=0;n<i&&!(this.menuItemsCount>200);n++){let i=r[n],o=s[n];if(o.faceTag[i]<=65535||o.faceTag[i]>=2e5&&o.faceTag[i]<=3e5)if(o===this.scene.view){let e=o.faceTag[i]%1e4,s=o.faceTag[i]/1e4|0;if(1===s){let i="",s=0;this.localPlayer.level>0&&this.players[e].level>0&&(s=this.localPlayer.level-this.players[e].level),s<0&&(i="@or1@"),s<-3&&(i="@or2@"),s<-6&&(i="@or3@"),s<-9&&(i="@red@"),s>0&&(i="@gr1@"),s>3&&(i="@gr2@"),s>6&&(i="@gr3@"),s>9&&(i="@gre@"),i=" "+i+"(level-"+this.players[e].level+")",this.selectedSpell>=0?1!==Be.spellType[this.selectedSpell]&&2!==Be.spellType[this.selectedSpell]||(this.menuItemText1[this.menuItemsCount]="Cast "+Be.spellName[this.selectedSpell]+" on",this.menuItemText2[this.menuItemsCount]="@whi@"+this.players[e].name+i,this.menuItemID[this.menuItemsCount]=800,this.menuItemX[this.menuItemsCount]=this.players[e].currentX,this.menuItemY[this.menuItemsCount]=this.players[e].currentY,this.menuSourceType[this.menuItemsCount]=this.players[e].serverIndex,this.menuSourceIndex[this.menuItemsCount]=this.selectedSpell,this.menuItemsCount++):this.selectedItemInventoryIndex>=0?(this.menuItemText1[this.menuItemsCount]="Use "+this.selectedItemName+" with",this.menuItemText2[this.menuItemsCount]="@whi@"+this.players[e].name+i,this.menuItemID[this.menuItemsCount]=810,this.menuItemX[this.menuItemsCount]=this.players[e].currentX,this.menuItemY[this.menuItemsCount]=this.players[e].currentY,this.menuSourceType[this.menuItemsCount]=this.players[e].serverIndex,this.menuSourceIndex[this.menuItemsCount]=this.selectedItemInventoryIndex,this.menuItemsCount++):(t>0&&((this.players[e].currentY-64)/this.tileSize+this.planeHeight+this.regionY|0)<2203?(this.menuItemText1[this.menuItemsCount]="Attack",this.menuItemText2[this.menuItemsCount]="@whi@"+this.players[e].name+i,this.menuItemID[this.menuItemsCount]=s>=0&&s<5?805:2805,this.menuItemX[this.menuItemsCount]=this.players[e].currentX,this.menuItemY[this.menuItemsCount]=this.players[e].currentY,this.menuSourceType[this.menuItemsCount]=this.players[e].serverIndex,this.menuItemsCount++):this.members&&(this.menuItemText1[this.menuItemsCount]="Duel with",this.menuItemText2[this.menuItemsCount]="@whi@"+this.players[e].name+i,this.menuItemX[this.menuItemsCount]=this.players[e].currentX,this.menuItemY[this.menuItemsCount]=this.players[e].currentY,this.menuItemID[this.menuItemsCount]=2806,this.menuSourceType[this.menuItemsCount]=this.players[e].serverIndex,this.menuItemsCount++),this.menuItemText1[this.menuItemsCount]="Trade with",this.menuItemText2[this.menuItemsCount]="@whi@"+this.players[e].name+i,this.menuItemID[this.menuItemsCount]=2810,this.menuSourceType[this.menuItemsCount]=this.players[e].serverIndex,this.menuItemsCount++,this.menuItemText1[this.menuItemsCount]="Follow",this.menuItemText2[this.menuItemsCount]="@whi@"+this.players[e].name+i,this.menuItemID[this.menuItemsCount]=2820,this.menuSourceType[this.menuItemsCount]=this.players[e].serverIndex,this.menuItemsCount++)}else if(2===s)this.selectedSpell>=0?3===Be.spellType[this.selectedSpell]&&(this.menuItemText1[this.menuItemsCount]="Cast "+Be.spellName[this.selectedSpell]+" on",this.menuItemText2[this.menuItemsCount]="@lre@"+Be.itemName[this.groundItemId[e]],this.menuItemID[this.menuItemsCount]=200,this.menuItemX[this.menuItemsCount]=this.groundItemX[e],this.menuItemY[this.menuItemsCount]=this.groundItemY[e],this.menuSourceType[this.menuItemsCount]=this.groundItemId[e],this.menuSourceIndex[this.menuItemsCount]=this.selectedSpell,this.menuItemsCount++):this.selectedItemInventoryIndex>=0?(this.menuItemText1[this.menuItemsCount]="Use "+this.selectedItemName+" with",this.menuItemText2[this.menuItemsCount]="@lre@"+Be.itemName[this.groundItemId[e]],this.menuItemID[this.menuItemsCount]=210,this.menuItemX[this.menuItemsCount]=this.groundItemX[e],this.menuItemY[this.menuItemsCount]=this.groundItemY[e],this.menuSourceType[this.menuItemsCount]=this.groundItemId[e],this.menuSourceIndex[this.menuItemsCount]=this.selectedItemInventoryIndex,this.menuItemsCount++):(this.menuItemText1[this.menuItemsCount]="Take",this.menuItemText2[this.menuItemsCount]="@lre@"+Be.itemName[this.groundItemId[e]],this.menuItemID[this.menuItemsCount]=220,this.menuItemX[this.menuItemsCount]=this.groundItemX[e],this.menuItemY[this.menuItemsCount]=this.groundItemY[e],this.menuSourceType[this.menuItemsCount]=this.groundItemId[e],this.menuItemsCount++,this.menuItemText1[this.menuItemsCount]="Examine",this.menuItemText2[this.menuItemsCount]="@lre@"+Be.itemName[this.groundItemId[e]],this.menuItemID[this.menuItemsCount]=3200,this.menuSourceType[this.menuItemsCount]=this.groundItemId[e],this.menuItemsCount++);else if(3===s){let t="",i=-1,s=this.npcs[e].npcId;if(Be.npcAttackable[s]>0){let e=(Be.npcAttack[s]+Be.npcDefense[s]+Be.npcStrength[s]+Be.npcHits[s])/4|0,r=(this.playerStatBase[0]+this.playerStatBase[1]+this.playerStatBase[2]+this.playerStatBase[3]+27)/4|0;t="@yel@",(i=r-e)<0&&(t="@or1@"),i<-3&&(t="@or2@"),i<-6&&(t="@or3@"),i<-9&&(t="@red@"),i>0&&(t="@gr1@"),i>3&&(t="@gr2@"),i>6&&(t="@gr3@"),i>9&&(t="@gre@"),t=" "+t+"(level-"+e+")"}this.selectedSpell>=0?2===Be.spellType[this.selectedSpell]&&(this.menuItemText1[this.menuItemsCount]="Cast "+Be.spellName[this.selectedSpell]+" on",this.menuItemText2[this.menuItemsCount]="@yel@"+Be.npcName[this.npcs[e].npcId],this.menuItemID[this.menuItemsCount]=700,this.menuItemX[this.menuItemsCount]=this.npcs[e].currentX,this.menuItemY[this.menuItemsCount]=this.npcs[e].currentY,this.menuSourceType[this.menuItemsCount]=this.npcs[e].serverIndex,this.menuSourceIndex[this.menuItemsCount]=this.selectedSpell,this.menuItemsCount++):this.selectedItemInventoryIndex>=0?(this.menuItemText1[this.menuItemsCount]="Use "+this.selectedItemName+" with",this.menuItemText2[this.menuItemsCount]="@yel@"+Be.npcName[this.npcs[e].npcId],this.menuItemID[this.menuItemsCount]=710,this.menuItemX[this.menuItemsCount]=this.npcs[e].currentX,this.menuItemY[this.menuItemsCount]=this.npcs[e].currentY,this.menuSourceType[this.menuItemsCount]=this.npcs[e].serverIndex,this.menuSourceIndex[this.menuItemsCount]=this.selectedItemInventoryIndex,this.menuItemsCount++):(Be.npcAttackable[s]>0&&(this.menuItemText1[this.menuItemsCount]="Attack",this.menuItemText2[this.menuItemsCount]="@yel@"+Be.npcName[this.npcs[e].npcId]+t,this.menuItemID[this.menuItemsCount]=i>=0?715:2715,this.menuItemX[this.menuItemsCount]=this.npcs[e].currentX,this.menuItemY[this.menuItemsCount]=this.npcs[e].currentY,this.menuSourceType[this.menuItemsCount]=this.npcs[e].serverIndex,this.menuItemsCount++),this.menuItemText1[this.menuItemsCount]="Talk-to",this.menuItemText2[this.menuItemsCount]="@yel@"+Be.npcName[this.npcs[e].npcId],this.menuItemID[this.menuItemsCount]=720,this.menuItemX[this.menuItemsCount]=this.npcs[e].currentX,this.menuItemY[this.menuItemsCount]=this.npcs[e].currentY,this.menuSourceType[this.menuItemsCount]=this.npcs[e].serverIndex,this.menuItemsCount++,""!==Be.npcCommand[s]&&(this.menuItemText1[this.menuItemsCount]=Be.npcCommand[s],this.menuItemText2[this.menuItemsCount]="@yel@"+Be.npcName[this.npcs[e].npcId],this.menuItemID[this.menuItemsCount]=725,this.menuItemX[this.menuItemsCount]=this.npcs[e].currentX,this.menuItemY[this.menuItemsCount]=this.npcs[e].currentY,this.menuSourceType[this.menuItemsCount]=this.npcs[e].serverIndex,this.menuItemsCount++),this.menuItemText1[this.menuItemsCount]="Examine",this.menuItemText2[this.menuItemsCount]="@yel@"+Be.npcName[this.npcs[e].npcId],this.menuItemID[this.menuItemsCount]=3700,this.menuSourceType[this.menuItemsCount]=this.npcs[e].npcId,this.menuItemsCount++)}}else if(null!==o&&o.key>=1e4){let t=o.key-1e4,e=this.wallObjectId[t];this.wallObjectAlreadyInMenu[t]||(this.selectedSpell>=0?4===Be.spellType[this.selectedSpell]&&(this.menuItemText1[this.menuItemsCount]="Cast "+Be.spellName[this.selectedSpell]+" on",this.menuItemText2[this.menuItemsCount]="@cya@"+Be.wallObjectName[e],this.menuItemID[this.menuItemsCount]=300,this.menuItemX[this.menuItemsCount]=this.wallObjectX[t],this.menuItemY[this.menuItemsCount]=this.wallObjectY[t],this.menuSourceType[this.menuItemsCount]=this.wallObjectDirection[t],this.menuSourceIndex[this.menuItemsCount]=this.selectedSpell,this.menuItemsCount++):this.selectedItemInventoryIndex>=0?(this.menuItemText1[this.menuItemsCount]="Use "+this.selectedItemName+" with",this.menuItemText2[this.menuItemsCount]="@cya@"+Be.wallObjectName[e],this.menuItemID[this.menuItemsCount]=310,this.menuItemX[this.menuItemsCount]=this.wallObjectX[t],this.menuItemY[this.menuItemsCount]=this.wallObjectY[t],this.menuSourceType[this.menuItemsCount]=this.wallObjectDirection[t],this.menuSourceIndex[this.menuItemsCount]=this.selectedItemInventoryIndex,this.menuItemsCount++):(/^WalkTo$/i.test(Be.wallObjectCommand1[e])||(this.menuItemText1[this.menuItemsCount]=Be.wallObjectCommand1[e],this.menuItemText2[this.menuItemsCount]="@cya@"+Be.wallObjectName[e],this.menuItemID[this.menuItemsCount]=320,this.menuItemX[this.menuItemsCount]=this.wallObjectX[t],this.menuItemY[this.menuItemsCount]=this.wallObjectY[t],this.menuSourceType[this.menuItemsCount]=this.wallObjectDirection[t],this.menuItemsCount++),/^Examine$/i.test(Be.wallObjectCommand2[e])||(this.menuItemText1[this.menuItemsCount]=Be.wallObjectCommand2[e],this.menuItemText2[this.menuItemsCount]="@cya@"+Be.wallObjectName[e],this.menuItemID[this.menuItemsCount]=2300,this.menuItemX[this.menuItemsCount]=this.wallObjectX[t],this.menuItemY[this.menuItemsCount]=this.wallObjectY[t],this.menuSourceType[this.menuItemsCount]=this.wallObjectDirection[t],this.menuItemsCount++),this.menuItemText1[this.menuItemsCount]="Examine",this.menuItemText2[this.menuItemsCount]="@cya@"+Be.wallObjectName[e],this.menuItemID[this.menuItemsCount]=3300,this.menuSourceType[this.menuItemsCount]=e,this.menuItemsCount++),this.wallObjectAlreadyInMenu[t]=!0)}else if(null!==o&&o.key>=0){let t=o.key,e=this.objectId[t];this.objectAlreadyInMenu[t]||(this.selectedSpell>=0?5===Be.spellType[this.selectedSpell]&&(this.menuItemText1[this.menuItemsCount]="Cast "+Be.spellName[this.selectedSpell]+" on",this.menuItemText2[this.menuItemsCount]="@cya@"+Be.objectName[e],this.menuItemID[this.menuItemsCount]=400,this.menuItemX[this.menuItemsCount]=this.objectX[t],this.menuItemY[this.menuItemsCount]=this.objectY[t],this.menuSourceType[this.menuItemsCount]=this.objectDirection[t],this.menuSourceIndex[this.menuItemsCount]=this.objectId[t],this.menuTargetIndex[this.menuItemsCount]=this.selectedSpell,this.menuItemsCount++):this.selectedItemInventoryIndex>=0?(this.menuItemText1[this.menuItemsCount]="Use "+this.selectedItemName+" with",this.menuItemText2[this.menuItemsCount]="@cya@"+Be.objectName[e],this.menuItemID[this.menuItemsCount]=410,this.menuItemX[this.menuItemsCount]=this.objectX[t],this.menuItemY[this.menuItemsCount]=this.objectY[t],this.menuSourceType[this.menuItemsCount]=this.objectDirection[t],this.menuSourceIndex[this.menuItemsCount]=this.objectId[t],this.menuTargetIndex[this.menuItemsCount]=this.selectedItemInventoryIndex,this.menuItemsCount++):(/^WalkTo$/i.test(Be.objectCommand1[e])||(this.menuItemText1[this.menuItemsCount]=Be.objectCommand1[e],this.menuItemText2[this.menuItemsCount]="@cya@"+Be.objectName[e],this.menuItemID[this.menuItemsCount]=420,this.menuItemX[this.menuItemsCount]=this.objectX[t],this.menuItemY[this.menuItemsCount]=this.objectY[t],this.menuSourceType[this.menuItemsCount]=this.objectDirection[t],this.menuSourceIndex[this.menuItemsCount]=this.objectId[t],this.menuItemsCount++),/^Examine$/i.test(Be.objectCommand2[e])||(this.menuItemText1[this.menuItemsCount]=Be.objectCommand2[e],this.menuItemText2[this.menuItemsCount]="@cya@"+Be.objectName[e],this.menuItemID[this.menuItemsCount]=2400,this.menuItemX[this.menuItemsCount]=this.objectX[t],this.menuItemY[this.menuItemsCount]=this.objectY[t],this.menuSourceType[this.menuItemsCount]=this.objectDirection[t],this.menuSourceIndex[this.menuItemsCount]=this.objectId[t],this.menuItemsCount++),this.menuItemText1[this.menuItemsCount]="Examine",this.menuItemText2[this.menuItemsCount]="@cya@"+Be.objectName[e],this.menuItemID[this.menuItemsCount]=3400,this.menuSourceType[this.menuItemsCount]=e,this.menuItemsCount++),this.objectAlreadyInMenu[t]=!0)}else i>=0&&(i=o.faceTag[i]-2e5),i>=0&&(e=i)}this.selectedSpell>=0&&Be.spellType[this.selectedSpell]<=1&&(this.menuItemText1[this.menuItemsCount]="Cast "+Be.spellName[this.selectedSpell]+" on self",this.menuItemText2[this.menuItemsCount]="",this.menuItemID[this.menuItemsCount]=1e3,this.menuSourceType[this.menuItemsCount]=this.selectedSpell,this.menuItemsCount++),-1!==e&&(this.selectedSpell>=0?6===Be.spellType[this.selectedSpell]&&(this.menuItemText1[this.menuItemsCount]="Cast "+Be.spellName[this.selectedSpell]+" on ground",this.menuItemText2[this.menuItemsCount]="",this.menuItemID[this.menuItemsCount]=900,this.menuItemX[this.menuItemsCount]=this.world.localX[e],this.menuItemY[this.menuItemsCount]=this.world.localY[e],this.menuSourceType[this.menuItemsCount]=this.selectedSpell,this.menuItemsCount++):this.selectedItemInventoryIndex<0&&(this.menuItemText1[this.menuItemsCount]="Walk here",this.menuItemText2[this.menuItemsCount]="",this.menuItemID[this.menuItemsCount]=920,this.menuItemX[this.menuItemsCount]=this.world.localX[e],this.menuItemY[this.menuItemsCount]=this.world.localY[e],this.menuItemsCount++))}async handleInputs(){if(!(this.errorLoadingData||this.runtimeException||this.errorLoadingCodebase)&&this.surface)try{this.frameCounter++,this.gameState===oi.LOGIN&&await this.handleLoginScreenInput(),this.gameState===oi.WORLD&&await this.handleGameInput(),this.lastMouseButtonDown=0,this.cameraRotationTime++,this.messageTabFlashAll>0&&this.messageTabFlashAll--,this.messageTabFlashHistory>0&&this.messageTabFlashHistory--,this.messageTabFlashQuest>0&&this.messageTabFlashQuest--,this.messageTabFlashPrivate>0&&this.messageTabFlashPrivate--}catch(e){console.error(e),this.freeCacheMemory()}}async handleLoginScreenInput(){if(this.worldFullTimeout>0&&this.worldFullTimeout--,this.welcomeState===hi.WELCOME){if(!this.panelLogin[hi.WELCOME])return;this.panelLogin[hi.WELCOME].handleMouse(this.mouseX,this.mouseY,this.lastMouseButtonDown,this.mouseButtonDown),this.panelLogin[hi.WELCOME].isClicked(this.controlWelcomeNewuser)?(this.panelLogin[hi.NEW_USER].updateText(this.controlRegisterStatus,"To create an account please enter all the requested details"),this.panelLogin[hi.NEW_USER].updateText(this.controlRegisterUser,""),this.panelLogin[hi.NEW_USER].updateText(this.controlRegisterPassword,""),this.panelLogin[hi.NEW_USER].updateText(this.controlRegisterConfirmPassword,""),this.panelLogin[hi.NEW_USER].toggleCheckbox(this.controlRegisterCheckbox,!1),this.panelLogin[hi.NEW_USER].setFocus(this.controlRegisterUser),this.welcomeState=hi.NEW_USER):this.panelLogin[hi.WELCOME].isClicked(this.controlWelcomeExistinguser)&&(this.panelLogin[hi.EXISTING_USER].updateText(this.controlLoginStatus,"Please enter your username and password"),"true"!==Ci("savePass")?(this.panelLogin[hi.EXISTING_USER].toggleCheckbox(this.controlLoginSavePass,!1),this.panelLogin[hi.EXISTING_USER].updateText(this.controlLoginUser,""),this.panelLogin[hi.EXISTING_USER].updateText(this.controlLoginPass,""),this.panelLogin[hi.EXISTING_USER].setFocus(this.controlLoginUser)):(this.panelLogin[hi.EXISTING_USER].toggleCheckbox(this.controlLoginSavePass,!0),this.panelLogin[hi.EXISTING_USER].updateText(this.controlLoginUser,this.loginUser),this.panelLogin[hi.EXISTING_USER].setFocus(this.controlLoginPass)),this.welcomeState=hi.EXISTING_USER)}else if(this.welcomeState===hi.NEW_USER){if(!this.panelLogin[hi.NEW_USER])return;if(this.panelLogin[hi.NEW_USER].handleMouse(this.mouseX,this.mouseY,this.lastMouseButtonDown,this.mouseButtonDown),this.panelLogin[hi.NEW_USER].isClicked(this.controlRegisterCancel))return void(this.welcomeState=hi.WELCOME);if(this.panelLogin[hi.NEW_USER].isClicked(this.controlRegisterUser))return void this.panelLogin[hi.NEW_USER].setFocus(this.controlRegisterPassword);if(this.panelLogin[hi.NEW_USER].isClicked(this.controlRegisterPassword))return void this.panelLogin[hi.NEW_USER].setFocus(this.controlRegisterConfirmPassword);if(this.panelLogin[hi.NEW_USER].isClicked(this.controlRegisterConfirmPassword)||this.panelLogin[hi.NEW_USER].isClicked(this.controlRegisterSubmit)){let t=this.panelLogin[hi.NEW_USER].getText(this.controlRegisterUser),e=this.panelLogin[hi.NEW_USER].getText(this.controlRegisterPassword),i=this.panelLogin[hi.NEW_USER].getText(this.controlRegisterConfirmPassword);return t&&e&&i?this.panelLogin[hi.NEW_USER].isActivated(this.controlRegisterCheckbox)?t.length<3||t.length>12?void this.panelLogin[hi.NEW_USER].updateText(this.controlRegisterStatus,"@yel@Your username must be between 3 and 12 characters long."):e.length<3||e.length>20?void this.panelLogin[hi.NEW_USER].updateText(this.controlRegisterStatus,"@yel@Your password must be between 3 and 20 characters long."):e!==i?void this.panelLogin[hi.NEW_USER].updateText(this.controlRegisterStatus,"@yel@The two passwords entered are not the same as each other!"):e===t?void this.panelLogin[hi.NEW_USER].updateText(this.controlRegisterStatus,"@yel@Your password can not be the same as your username!"):(this.panelLogin[hi.NEW_USER].updateText(this.controlRegisterStatus,"Please wait... attempting to create user"),void await this.registerAccount(t,e)):void this.panelLogin[hi.NEW_USER].updateText(this.controlRegisterStatus,"@yel@You must read and agree to the terms+conditions to continue."):void this.panelLogin[hi.NEW_USER].updateText(this.controlRegisterStatus,"@yel@You must provide a username and password to continue.")}}else if(this.welcomeState===hi.EXISTING_USER){if(!this.panelLogin[hi.EXISTING_USER])return;if(this.panelLogin[hi.EXISTING_USER].handleMouse(this.mouseX,this.mouseY,this.lastMouseButtonDown,this.mouseButtonDown),this.panelLogin[hi.EXISTING_USER].isClicked(this.controlLoginCancel))return void(this.welcomeState=hi.WELCOME);if(this.panelLogin[hi.EXISTING_USER].isClicked(this.controlLoginUser))return void this.panelLogin[hi.EXISTING_USER].setFocus(this.controlLoginPass);if(this.panelLogin[hi.EXISTING_USER].isClicked(this.controlLoginPass)||this.panelLogin[hi.EXISTING_USER].isClicked(this.controlLoginOk))return this.loginUser=this.panelLogin[hi.EXISTING_USER].getText(this.controlLoginUser),this.loginPass=this.panelLogin[hi.EXISTING_USER].getText(this.controlLoginPass),wi("savePass",this.panelLogin[hi.EXISTING_USER].isActivated(this.controlLoginSavePass)),wi("username",this.panelLogin[hi.EXISTING_USER].getText(this.controlLoginUser)),void await this.login(this.panelLogin[hi.EXISTING_USER].getText(this.controlLoginUser),this.panelLogin[hi.EXISTING_USER].getText(this.controlLoginPass),!1,this.panelLogin[hi.EXISTING_USER].isActivated(this.controlLoginSavePass))}}async loadMaps(){this.world.mapPack=await this.readDataFile("maps"+F.MAPS+".jag","map",70),this.members&&(this.world.memberMapPack=await this.readDataFile("maps"+F.MAPS+".mem","members map",75)),this.world.landscapePack=await this.readDataFile("land"+F.MAPS+".jag","landscape",80),this.members&&(this.world.memberLandscapePack=await this.readDataFile("land"+F.MAPS+".mem","members landscape",85))}createBoundaryModel(t,e,i,s,r){let n=t,o=e,a=t,h=e,l=Be.wallObjectTextureFront[s],c=Be.wallObjectTextureBack[s],u=Be.wallObjectHeight[s],m=Ne._from2(4,1);0===i&&(a=t+1),1===i&&(h=e+1),2===i&&(n=t+1,h=e+1),3===i&&(a=t+1,h=e+1),n*=this.tileSize,o*=this.tileSize,a*=this.tileSize,h*=this.tileSize;let d=m.vertexAt(n,-this.world.getElevation(n,o),o),p=m.vertexAt(n,-this.world.getElevation(n,o)-u,o),g=m.vertexAt(a,-this.world.getElevation(a,h)-u,h),f=m.vertexAt(a,-this.world.getElevation(a,h),h),S=new Int32Array([d,p,g,f]);return m.createFace(4,S,l,c),m.createGouraudLightSource(!1,60,24,-50,-10,-50),t>=0&&e>=0&&t<96&&e<96&&this.scene.addModel(m),m.key=r+1e4,m}}var bi=yi;const Ti="'([^']+)'|\"([^\"]+)\"|[\\w\\s-]+";new RegExp("(bold|bolder|lighter|[1-9]00) +","i"),new RegExp("(italic|oblique) +","i"),new RegExp("(small-caps) +","i"),new RegExp("(ultra-condensed|extra-condensed|condensed|semi-condensed|semi-expanded|expanded|extra-expanded|ultra-expanded) +","i"),new RegExp("([\\d\\.]+)(px|pt|pc|in|cm|mm|%|em|ex|ch|rem|q) *((?:"+Ti+")( *, *(?:"+Ti+"))*)");if("undefined"==typeof window){const{createCanvas:e}=t({}),i=e(512,346),s=new bi(i);s.options.middleClickCamera=!0,s.options.mouseWheel=!0,s.options.resetCompass=!0,s.options.zoomCamera=!0,s.members=!1}(async()=>{const t=document.getElementById("gameCanvas"),e=window.location.hash.slice(1).split(","),i=new bi(t);i.options.middleClickCamera=!0,i.options.mouseWheel=!0,i.options.resetCompass=!0,i.options.zoomCamera=!0,i.members="members"===e[0],window.mcOptions=i.options,i.server="rscturmoil.com",i.port=43595,i.transportLayerSecurity=!0,i.threadSleep=1,await i.startApplication(512,346,"RSCTurmoil - RSCGo by ZlackCode LLC",!1)})()}();